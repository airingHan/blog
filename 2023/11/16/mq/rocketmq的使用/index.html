

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="韩启川">
  <meta name="keywords" content="">
  
    <meta name="description" content="使用https:&#x2F;&#x2F;rocketmq.apache.org&#x2F;zh&#x2F;docs&#x2F;quickStart&#x2F;01quickstart 安装条件 64位操作系统，推荐 Linux&#x2F;Unix&#x2F;macOS 64位 JDK 1.8+ 如果源码编译安装需要安装maven  下载源码并编译12345wget https:&#x2F;&#x2F;dist.apache.org&#x2F;repos&#x2F;dist&#x2F;release&#x2F;roc">
<meta property="og:type" content="article">
<meta property="og:title" content="rocketmq的使用">
<meta property="og:url" content="http://hanqichuan.com/2023/11/16/mq/rocketmq%E7%9A%84%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="这是一个很酷的事">
<meta property="og:description" content="使用https:&#x2F;&#x2F;rocketmq.apache.org&#x2F;zh&#x2F;docs&#x2F;quickStart&#x2F;01quickstart 安装条件 64位操作系统，推荐 Linux&#x2F;Unix&#x2F;macOS 64位 JDK 1.8+ 如果源码编译安装需要安装maven  下载源码并编译12345wget https:&#x2F;&#x2F;dist.apache.org&#x2F;repos&#x2F;dist&#x2F;release&#x2F;roc">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://hanqichuan.com/.com//RocketMQ%E5%9F%BA%E6%9C%AC%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B.png">
<meta property="og:image" content="http://hanqichuan.com/.com//RocketMQ%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84.png">
<meta property="og:image" content="http://hanqichuan.com/.com//rocketmq%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%9E%8B.png">
<meta property="og:image" content="http://hanqichuan.com/.com//rocketmq%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E6%B5%81%E7%A8%8B%E5%9B%BE.png">
<meta property="og:image" content="http://hanqichuan.com/.com//rocketmq%E6%B6%88%E8%B4%B9%E8%80%85%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.png">
<meta property="article:published_time" content="2023-11-16T07:31:00.000Z">
<meta property="article:modified_time" content="2023-11-20T11:58:13.482Z">
<meta property="article:author" content="韩启川">
<meta property="article:tag" content="mq">
<meta property="article:tag" content="rocketmq">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://hanqichuan.com/.com//RocketMQ%E5%9F%BA%E6%9C%AC%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B.png">
  
  
  <title>rocketmq的使用 - 这是一个很酷的事</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"hanqichuan.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>这是一件很酷的事</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="rocketmq的使用">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-11-16 15:31" pubdate>
        2023年11月16日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      30k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      247 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">rocketmq的使用</h1>
            
            <div class="markdown-body">
              <h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/zh/docs/quickStart/01quickstart">https://rocketmq.apache.org/zh/docs/quickStart/01quickstart</a></p>
<h3 id="安装条件"><a href="#安装条件" class="headerlink" title="安装条件"></a>安装条件</h3><ol>
<li>64位操作系统，推荐 Linux&#x2F;Unix&#x2F;macOS</li>
<li>64位 JDK 1.8+</li>
<li>如果源码编译安装需要安装maven</li>
</ol>
<h3 id="下载源码并编译"><a href="#下载源码并编译" class="headerlink" title="下载源码并编译"></a>下载源码并编译</h3><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">wget https://dist.apache.org/repos/dist/release/rocketmq/5.1.4/rocketmq-all-5.1.4-source-release.zip<br>unzip rocketmq-all-5.1.4-source-release.zip<br><span class="hljs-built_in">cd</span> rocketmq-all-5.1.4-source-release/<br>mvn -Prelease-all -DskipTests -Dspotbugs.skip=<span class="hljs-literal">true</span> clean install -U<br><span class="hljs-built_in">cd</span> distribution/target/rocketmq-5.1.4/rocketmq-5.1.4<br></code></pre></td></tr></table></figure>

<p>如果下载编译好的包直接进入下面一步。</p>
<h3 id="启动NameServer"><a href="#启动NameServer" class="headerlink" title="启动NameServer"></a>启动NameServer</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /usr/local/rocketmq-all-5.1.4-bin-release<br><span class="hljs-comment">### 启动namesrv</span><br><span class="hljs-built_in">nohup</span> sh bin/mqnamesrv &amp;<br><span class="hljs-comment">### 验证namesrv是否启动成功</span><br><span class="hljs-built_in">tail</span> -f ~/logs/rocketmqlogs/namesrv.log<br><span class="hljs-comment">### 结果：The Name Server boot success. serializeType=JSON</span><br></code></pre></td></tr></table></figure>

<p>nameserver相当于注册中心， 端口为9876</p>
<h3 id="启动Broker-Proxy"><a href="#启动Broker-Proxy" class="headerlink" title="启动Broker+Proxy"></a>启动Broker+Proxy</h3><p>5.x 版本下即 Broker 和 Proxy 同进程部署。</p>
<p>脚本里使用G1收集器：sh</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">在runbroker.sh文件中 -XX:+UseG1GC之前加上-XX:+UnlockExperimentalVMOptions<br></code></pre></td></tr></table></figure>

<p>把堆内存改小，原来8g改为2g。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">### 先启动broker</span><br><span class="hljs-built_in">nohup</span> sh bin/mqbroker -n localhost:9876 --enable-proxy &amp;<br><br><span class="hljs-built_in">tail</span> -f ~/logs/rocketmqlogs/proxy.log <br></code></pre></td></tr></table></figure>

<p>broker是具体存储消息的服务，默认端口10911.</p>
<p>这种属于Local模式， 则是通过BrokerController对象调用Broker的方法实现发送、消费等业务；</p>
<p>如果Proxy启动Cluster模式，则是通过RemotingClient访问Broker实现发送、消费等业务。代码的时候以前使用nameAddr&#x3D;localhost:9876。 有proxy后使用localhost:10911。</p>
<h3 id="使用命令行测试消息收发"><a href="#使用命令行测试消息收发" class="headerlink" title="使用命令行测试消息收发"></a>使用命令行测试消息收发</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> NAMESRV_ADDR=localhost:9876<br><span class="hljs-comment">### 生产消息</span><br>sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer<br><br><span class="hljs-comment">### 消费消息</span><br>sh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer<br></code></pre></td></tr></table></figure>

<h3 id="关闭服务器"><a href="#关闭服务器" class="headerlink" title="关闭服务器"></a>关闭服务器</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 关闭broker</span><br>sh bin/mqshutdown broker<br><span class="hljs-comment"># 关闭nameServer</span><br>sh bin/mqshutdown namesrv<br></code></pre></td></tr></table></figure>

<h3 id="console控制台"><a href="#console控制台" class="headerlink" title="console控制台"></a>console控制台</h3><p>需要安装maven</p>
<p><a target="_blank" rel="noopener" href="https://codeload.github.com/apache/rocketmq-externals/zip/refs/tags/rocketmq-console-1.0.0">https://codeload.github.com/apache/rocketmq-externals/zip/refs/tags/rocketmq-console-1.0.0</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">unzip rocketmq-externals-rocketmq-console-1.0.0.zip<br><span class="hljs-built_in">cd</span> /usr/local/rocketmq-externals-rocketmq-console-1.0.0/rocketmq-console<br></code></pre></td></tr></table></figure>

<p>修改配置文件application.properties:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">rocketmq.config.namesrvAddr=localhost:9876</span><br></code></pre></td></tr></table></figure>

<p>运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mvn spring-boot:run<br></code></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">mvn clean package -Dmaven.test.skip=<span class="hljs-literal">true</span><br>java -jar target/rocketmq-console-ng-1.0.0.jar<br></code></pre></td></tr></table></figure>

<p>访问localhost:8080</p>
<h3 id="Dashboard控制台"><a href="#Dashboard控制台" class="headerlink" title="Dashboard控制台"></a>Dashboard控制台</h3><p><a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq-dashboard">https://github.com/apache/rocketmq-dashboard</a></p>
<p>应该是console拆分出去重命名为Dashboard了。</p>
<p>RocketMQ &gt;&#x3D; 5.0使用新版本控制台，RocketMQ&lt; 5.0时，使用旧版本。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq-dashboard/blob/master/docs/1_0_0/UserGuide_CN.md">https://github.com/apache/rocketmq-dashboard/blob/master/docs/1_0_0/UserGuide_CN.md</a></p>
<p><a target="_blank" rel="noopener" href="https://codeload.github.com/apache/rocketmq-dashboard/zip/refs/tags/rocketmq-dashboard-1.0.0">https://codeload.github.com/apache/rocketmq-dashboard/zip/refs/tags/rocketmq-dashboard-1.0.0</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">unzip rocketmq-dashboard-rocketmq-dashboard-1.0.0.zip<br>mvn clean package -Dmaven.test.skip=<span class="hljs-literal">true</span><br>java -jar target/rocketmq-dashboard-1.0.1-SNAPSHOT.jar<br></code></pre></td></tr></table></figure>

<h2 id="普通maven应用使用"><a href="#普通maven应用使用" class="headerlink" title="普通maven应用使用"></a>普通maven应用使用</h2><h3 id="创建主题"><a href="#创建主题" class="headerlink" title="创建主题"></a>创建主题</h3><p>通过mqadmin创建 Topic。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sh bin/mqadmin updatetopic -n localhost:9876 -t TestTopic -c DefaultCluster<br></code></pre></td></tr></table></figure>

<h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.rocketmq/rocketmq-client --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.rocketmq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rocketmq-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> org.apache.rocketmq.client.apis.ClientConfiguration;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.client.apis.ClientConfigurationBuilder;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.client.apis.ClientException;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.client.apis.ClientServiceProvider;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.client.apis.message.Message;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.client.apis.producer.Producer;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.client.apis.producer.SendReceipt;<br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProducerExample</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(ProducerExample.class);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClientException &#123;<br>        <span class="hljs-comment">// 接入点地址，需要设置成Proxy的地址和端口列表，一般是xxx:8081;xxx:8081。</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">endpoint</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;192.168.158.135:8081&quot;</span>;<br>        <span class="hljs-comment">// 消息发送的目标Topic名称，需要提前创建。</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">topic</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TestTopic&quot;</span>;<br>        <span class="hljs-type">ClientServiceProvider</span> <span class="hljs-variable">provider</span> <span class="hljs-operator">=</span> ClientServiceProvider.loadService();<br>        <span class="hljs-type">ClientConfigurationBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> ClientConfiguration.newBuilder().setEndpoints(endpoint);<br>        <span class="hljs-type">ClientConfiguration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> builder.build();<br>        <span class="hljs-comment">// 初始化Producer时需要设置通信配置以及预绑定的Topic。</span><br>        <span class="hljs-type">Producer</span> <span class="hljs-variable">producer</span> <span class="hljs-operator">=</span> provider.newProducerBuilder()<br>            .setTopics(topic)<br>            .setClientConfiguration(configuration)<br>            .build();<br>        <span class="hljs-comment">// 普通消息发送。</span><br>        <span class="hljs-type">Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> provider.newMessageBuilder()<br>            .setTopic(topic)<br>            <span class="hljs-comment">// 设置消息索引键，可根据关键字精确查找某条消息。</span><br>            .setKeys(<span class="hljs-string">&quot;messageKey&quot;</span>)<br>            <span class="hljs-comment">// 设置消息Tag，用于消费端根据指定Tag过滤消息。</span><br>            .setTag(<span class="hljs-string">&quot;messageTag&quot;</span>)<br>            <span class="hljs-comment">// 消息体。</span><br>            .setBody(<span class="hljs-string">&quot;messageBody&quot;</span>.getBytes())<br>            .build();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 发送消息，需要关注发送结果，并捕获失败等异常。</span><br>            <span class="hljs-type">SendReceipt</span> <span class="hljs-variable">sendReceipt</span> <span class="hljs-operator">=</span> producer.send(message);<br>            logger.info(<span class="hljs-string">&quot;Send message successfully, messageId=&#123;&#125;&quot;</span>, sendReceipt.getMessageId());<br>        &#125; <span class="hljs-keyword">catch</span> (ClientException e) &#123;<br>            logger.error(<span class="hljs-string">&quot;Failed to send message&quot;</span>, e);<br>        &#125;<br>        <span class="hljs-comment">// producer.close();</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h3><p>Apache RocketMQ 支持SimpleConsumer和PushConsumer两种消费者类型，您可以选择以下任意一种方式订阅消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Collections;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.client.apis.ClientConfiguration;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.client.apis.ClientException;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.client.apis.ClientServiceProvider;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.client.apis.consumer.ConsumeResult;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.client.apis.consumer.FilterExpression;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.client.apis.consumer.FilterExpressionType;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.client.apis.consumer.PushConsumer;<br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PushConsumerExample</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(PushConsumerExample.class);<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">PushConsumerExample</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClientException, IOException, InterruptedException &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">ClientServiceProvider</span> <span class="hljs-variable">provider</span> <span class="hljs-operator">=</span> ClientServiceProvider.loadService();<br>        <span class="hljs-comment">// 接入点地址，需要设置成Proxy的地址和端口列表，一般是xxx:8081;xxx:8081。</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">endpoints</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;192.168.158.135:8081&quot;</span>;<br>        <span class="hljs-type">ClientConfiguration</span> <span class="hljs-variable">clientConfiguration</span> <span class="hljs-operator">=</span> ClientConfiguration.newBuilder()<br>            .setEndpoints(endpoints)<br>            .build();<br>        <span class="hljs-comment">// 订阅消息的过滤规则，表示订阅所有Tag的消息。</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">tag</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;*&quot;</span>;<br>        <span class="hljs-type">FilterExpression</span> <span class="hljs-variable">filterExpression</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterExpression</span>(tag, FilterExpressionType.TAG);<br>        <span class="hljs-comment">// 为消费者指定所属的消费者分组，Group需要提前创建。</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">consumerGroup</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;YourConsumerGroup&quot;</span>;<br>        <span class="hljs-comment">// 指定需要订阅哪个目标Topic，Topic需要提前创建。</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">topic</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TestTopic&quot;</span>;<br>        <span class="hljs-comment">// 初始化PushConsumer，需要绑定消费者分组ConsumerGroup、通信参数以及订阅关系。</span><br>        <span class="hljs-type">PushConsumer</span> <span class="hljs-variable">pushConsumer</span> <span class="hljs-operator">=</span> provider.newPushConsumerBuilder()<br>            .setClientConfiguration(clientConfiguration)<br>            <span class="hljs-comment">// 设置消费者分组。</span><br>            .setConsumerGroup(consumerGroup)<br>            <span class="hljs-comment">// 设置预绑定的订阅关系。</span><br>            .setSubscriptionExpressions(Collections.singletonMap(topic, filterExpression))<br>            <span class="hljs-comment">// 设置消费监听器。</span><br>            .setMessageListener(messageView -&gt; &#123;<br>                <span class="hljs-comment">// 处理消息并返回消费结果。</span><br>                logger.info(<span class="hljs-string">&quot;Consume message successfully, messageId=&#123;&#125;&quot;</span>, messageView.getMessageId());<br>                <span class="hljs-keyword">return</span> ConsumeResult.SUCCESS;<br>            &#125;)<br>            .build();<br>        Thread.sleep(Long.MAX_VALUE);<br>        <span class="hljs-comment">// 如果不需要再使用 PushConsumer，可关闭该实例。</span><br>        <span class="hljs-comment">// pushConsumer.close();</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="spring-boot项目使用"><a href="#spring-boot项目使用" class="headerlink" title="spring boot项目使用"></a>spring boot项目使用</h2><p><a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq-spring">https://github.com/apache/rocketmq-spring</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq-spring/tree/master/rocketmq-spring-boot-samples">https://github.com/apache/rocketmq-spring/tree/master/rocketmq-spring-boot-samples</a></p>
<h3 id="引入依赖-1"><a href="#引入依赖-1" class="headerlink" title="引入依赖"></a>引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.rocketmq/rocketmq-spring-boot-starter --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.rocketmq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rocketmq-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>application.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">rocketmq.name-server</span>=<span class="hljs-string">192.168.158.136:9876</span><br><span class="hljs-attr">rocketmq.producer.group</span>=<span class="hljs-string">my-group1</span><br><span class="hljs-attr">rocketmq.producer.sendMessageTimeout</span>=<span class="hljs-string">300000</span><br><span class="hljs-comment"># default producer tls config</span><br><span class="hljs-attr">rocketmq.producer.tls-enable</span>=<span class="hljs-string">false</span><br></code></pre></td></tr></table></figure>

<h3 id="生产者-1"><a href="#生产者-1" class="headerlink" title="生产者"></a>生产者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.rocketmq.spring.core.RocketMQTemplate;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProducerController</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/sendMsg&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMsg</span><span class="hljs-params">()</span> &#123;<br>        rocketMQTemplate.syncSend(<span class="hljs-string">&quot;TestTopic&quot;</span>, <span class="hljs-string">&quot;消息内容&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>请求<a target="_blank" rel="noopener" href="http://localhost:8080/sendMsg">http://localhost:8080/sendMsg</a></p>
<h3 id="消费者-1"><a href="#消费者-1" class="headerlink" title="消费者"></a>消费者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> org.apache.rocketmq.spring.annotation.RocketMQMessageListener;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.spring.core.RocketMQListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@RocketMQMessageListener(topic = &quot;TestTopic&quot;, consumerGroup = &quot;string_consumer&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;String&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String message)</span> &#123;<br>        System.out.printf(<span class="hljs-string">&quot;------- StringConsumer received: %s \n&quot;</span>, message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="读文档"><a href="#读文档" class="headerlink" title="读文档"></a>读文档</h2><p>需要把官方文档大概读一遍。</p>
<p>5.0的文档与4.0的文档相比：4.0的文档中初识RocketMq中也比较重要，但5.0中没有。</p>
<h3 id="初识rocketmq"><a href="#初识rocketmq" class="headerlink" title="初识rocketmq"></a>初识rocketmq</h3><p>RocketMQ的基础消息模型就是一个简单的Pub&#x2F;Sub模型。发布订阅模型。</p>
<p>rocketmq是基于主题(topic)的消息队列系统。</p>
<p>rocketmq为了支持高并发和水平扩展，中间的消息主题需要进行分区，同一个Topic会有多个生产者，同一个信息会有多个消费者，消费者之间要进行负载均衡等。</p>
<h4 id="rocketmq的消息模型"><a href="#rocketmq的消息模型" class="headerlink" title="rocketmq的消息模型"></a>rocketmq的消息模型</h4><p><img src="/.com//RocketMQ%E5%9F%BA%E6%9C%AC%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B.png" srcset="/img/loading.gif" lazyload></p>
<p>上图包括<strong>两个生产者</strong>，<strong>两个消息Topic</strong>，以及<strong>两组消费者 Comsumer</strong>。</p>
<p>存储消息Topic的 <strong>代理服务器</strong>( <strong>Broker</strong> )，是实际部署过程对应的代理服务器。</p>
<p>为了消息写入能力的<strong>水平扩展</strong>，RocketMQ 对 Topic进行了分区，这种操作被称为<strong>队列</strong>（MessageQueue）。</p>
<p>为了消费能力的<strong>水平扩展</strong>，ConsumerGroup的概念应运而生。</p>
<h4 id="rocketmq的部署模型"><a href="#rocketmq的部署模型" class="headerlink" title="rocketmq的部署模型"></a>rocketmq的部署模型</h4><p><img src="/.com//RocketMQ%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84.png" srcset="/img/loading.gif" lazyload></p>
<p>Apache RocketMQ 部署架构上主要分为四部分:</p>
<p>生产者 Producer:</p>
<p>发布消息的角色。Producer通过 MQ 的负载均衡模块选择相应的 Broker 集群队列进行消息投递，投递的过程支持快速失败和重试。</p>
<p>消费者 Consumer:</p>
<p>消息消费的角色。</p>
<p>支持以推（push），拉（pull）两种模式对消息进行消费。</p>
<p>同时也支持<strong>集群方式</strong>和广播方式的消费。</p>
<p>提供实时消息订阅机制，可以满足大多数用户的需求。</p>
<p>名字服务器 NameServer:</p>
<p>NameServer是一个简单的 Topic 路由注册中心，支持 Topic、Broker 的动态注册与发现。</p>
<p>主要包括两个功能：</p>
<ul>
<li><strong>Broker管理</strong>，NameServer接受Broker集群的注册信息并且保存下来作为路由信息的基本数据。然后提供心跳检测机制，检查Broker是否还存活；</li>
<li><strong>路由信息管理</strong>，每个NameServer将保存关于 Broker 集群的整个路由信息和用于客户端查询的队列信息。Producer和Consumer通过NameServer就可以知道整个Broker集群的路由信息，从而进行消息的投递和消费。</li>
</ul>
<p>NameServer通常会有多个实例部署，各实例间相互不进行信息通讯。Broker是向每一台NameServer注册自己的路由信息，所以每一个NameServer实例上面都保存一份完整的路由信息。当某个NameServer因某种原因下线了，客户端仍然可以向其它NameServer获取路由信息。</p>
<p>代理服务器 Broker:</p>
<p>Broker主要负责消息的存储、投递和查询以及服务高可用保证。</p>
<p>NameServer几乎无状态节点，因此可集群部署，节点之间无任何信息同步。Broker部署相对复杂。</p>
<p>在 Master-Slave 架构中，Broker 分为 Master 与 Slave。一个Master可以对应多个Slave，但是一个Slave只能对应一个Master。Master 与 Slave 的对应关系通过指定相同的BrokerName，不同的BrokerId 来定义，BrokerId为0表示Master，非0表示Slave。Master也可以部署多个。</p>
<h5 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h5><ul>
<li>每个 <strong>Broker</strong> 与 <strong>NameServer</strong> 集群中的所有节点建立长连接，定时注册 Topic 信息到所有 NameServer。</li>
<li><strong>Producer</strong> 与 <strong>NameServer</strong> 集群中的其中一个节点建立长连接，定期从 NameServer 获取Topic路由信息，并向提供 Topic 服务的 Master 建立长连接，且定时向 Master 发送心跳。Producer 完全无状态。</li>
<li><strong>Consumer</strong> 与 <strong>NameServer</strong> 集群中的其中一个节点建立长连接，定期从 NameServer 获取 Topic 路由信息，并向提供 Topic 服务的 Master、Slave 建立长连接，且定时向 Master、Slave发送心跳。Consumer 既可以从 Master 订阅消息，也可以从Slave订阅消息。</li>
</ul>
<h4 id="RocketMQ集群工作流程"><a href="#RocketMQ集群工作流程" class="headerlink" title="RocketMQ集群工作流程"></a>RocketMQ集群工作流程</h4><p>1.启动NameServer</p>
<p>启动NameServer。NameServer启动后监听端口，等待Broker、Producer、Consumer连接，相当于一个路由控制中心。</p>
<p>2.启动 Broker</p>
<p>启动 Broker。与所有 NameServer 保持长连接，定时发送心跳包。心跳包中包含当前 Broker 信息以及存储所有 Topic 信息。注册成功后，NameServer 集群中就有 Topic跟Broker 的映射关系。</p>
<p>3.创建 Topic</p>
<p>创建 Topic 时需要指定该 Topic 要存储在哪些 Broker 上，也可以在发送消息时自动创建Topic。</p>
<p>4.生产者发送消息</p>
<p>生产者发送消息。启动时先跟 NameServer 集群中的其中一台建立长连接，并从 NameServer 中获取当前发送的 Topic存在于哪些 Broker 上，轮询从队列列表中选择一个队列，然后与队列所在的 Broker建立长连接从而向 Broker发消息。</p>
<p>5.消费者接受消息</p>
<p>消费者接受消息。跟其中一台NameServer建立长连接，获取当前订阅Topic存在哪些Broker上，然后直接跟Broker建立连接通道，然后开始消费消息。</p>
<h3 id="领域模型概述"><a href="#领域模型概述" class="headerlink" title="领域模型概述"></a>领域模型概述</h3><p><strong>消息生产</strong></p>
<p>生产者(producter)：</p>
<p>Apache RocketMQ 中用于产生消息的运行实体，一般集成于业务调用链路的上游。生产者是轻量级匿名无身份的。</p>
<p><strong>消息存储</strong></p>
<p>主题(topic):</p>
<p>Apache RocketMQ 消息传输和存储的分组容器，主题内部由多个队列组成，消息的存储和水平扩展实际是通过主题内的队列实现的。</p>
<p>队列(MessageQueue):</p>
<p>Apache RocketMQ 消息传输和存储的实际单元容器，类比于其他消息队列中的分区。 Apache RocketMQ 通过流式特性的无限队列结构来存储消息，消息在队列内具备顺序性存储特征。</p>
<p>消息(Message):</p>
<p>Apache RocketMQ 的最小传输单元。消息具备不可变性，在初始化发送和完成存储后即不可变。</p>
<p><strong>消息消费</strong></p>
<p>消费者分组(ConsumerGroup):</p>
<p>Apache RocketMQ 发布订阅模型中定义的独立的消费身份分组，用于统一管理底层运行的多个消费者（Consumer）。同一个消费组的多个消费者必须保持消费逻辑和配置一致，共同分担该消费组订阅的消息，实现消费能力的水平扩展。</p>
<p>消费者(consumer):</p>
<p>Apache RocketMQ 消费消息的运行实体，一般集成在业务调用链路的下游。消费者必须被指定到某一个消费组中。</p>
<p>订阅关系(subscription):</p>
<p>Apache RocketMQ 发布订阅模型中消息过滤、重试、消费进度的规则配置。订阅关系以消费组粒度进行管理，消费组通过定义订阅关系控制指定消费组下的消费者如何实现消息过滤、消费重试及消费进度恢复等。</p>
<p>Apache RocketMQ 的订阅关系除过滤表达式之外都是持久化的，即服务端重启或请求断开，订阅关系依然保留。</p>
<h4 id="异步通信"><a href="#异步通信" class="headerlink" title="异步通信"></a>异步通信</h4><p>异步消息通信模式下，各子系统之间无需强耦合直接连接，调用方只需要将请求转化成异步事件（消息）发送给中间代理，发送成功即可认为该异步链路调用完成，剩下的工作中间代理会负责将事件可靠通知到下游的调用系统，确保任务执行完成。该中间代理一般就是消息中间件。</p>
<p>异步通信的优势如下：</p>
<ul>
<li><p>系统拓扑简单。由于调用方和被调用方统一和中间代理通信，系统是星型结构，易于维护和管理。</p>
</li>
<li><p>上下游耦合性弱。上下游系统之间弱耦合，结构更灵活，由中间代理负责缓冲和异步恢复。 上下游系统间可以独立升级和变更，不会互相影响。</p>
</li>
<li><p>容量削峰填谷。基于消息的中间代理往往具备很强的流量缓冲和整形能力，业务流量高峰到来时不会击垮下游。</p>
</li>
</ul>
<h4 id="发布订阅模型"><a href="#发布订阅模型" class="headerlink" title="发布订阅模型"></a>发布订阅模型</h4><p><img src="/.com//rocketmq%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%9E%8B.png" srcset="/img/loading.gif" lazyload></p>
<p>发布订阅模型具有如下特点：</p>
<ul>
<li>消费独立：相比队列模型的匿名消费方式，发布订阅模型中消费方都会具备的身份，一般叫做订阅组（订阅关系），不同订阅组之间相互独立不会相互影响。</li>
<li>一对多通信：基于独立身份的设计，同一个主题内的消息可以被多个订阅组处理，每个订阅组都可以拿到全量消息。因此发布订阅模型可以实现一对多通信。</li>
</ul>
<h3 id="领域模型"><a href="#领域模型" class="headerlink" title="领域模型"></a>领域模型</h3><p>官网领域模型下的各各目录还是可以看看的，主要是使用建议还是值得的。</p>
<h2 id="功能特性"><a href="#功能特性" class="headerlink" title="功能特性"></a>功能特性</h2><h3 id="消费者分类"><a href="#消费者分类" class="headerlink" title="消费者分类"></a>消费者分类</h3><p><strong>Apache RocketMQ 提供了不同的消费者类型： PushConsumer 、SimpleConsumer 和 PullConsumer。</strong></p>
<p>在实际使用场景中，PullConsumer 仅推荐在流处理框架中集成使用，大多数消息收发场景使用 PushConsumer 和 SimpleConsumer 就可以满足需求。</p>
<p>若您的业务场景发生变更，或您当前使用的消费者类型不适合当前业务，您可以选择在 PushConsumer 和SimpleConsumer 之间变更消费者类型。变更消费者类型不影响当前Apache RocketMQ 资源的使用和业务处理。</p>
<p>生产环境中相同的 ConsumerGroup 下严禁混用 PullConsumer 和其他两种消费者，否则会导致消息消费异常。</p>
<table>
<thead>
<tr>
<th>对比项</th>
<th>PushConsumer</th>
<th>SimpleConsumer</th>
<th>PullConsumer</th>
</tr>
</thead>
<tbody><tr>
<td>接口方式</td>
<td>使用监听器回调接口返回消费结果，消费者仅允许在监听器范围内处理消费逻辑。</td>
<td>业务方自行实现消息处理，并主动调用接口返回消费结果。</td>
<td>业务方自行按队列拉取消息，并可选择性地提交消费结果</td>
</tr>
<tr>
<td>消费并发度管理</td>
<td>由SDK管理消费并发度。</td>
<td>由业务方消费逻辑自行管理消费线程。</td>
<td>由业务方消费逻辑自行管理消费线程。</td>
</tr>
<tr>
<td>负载均衡粒度</td>
<td>5.0 SDK是消息粒度，更均衡，早期版本是队列维度</td>
<td>消息粒度，更均衡</td>
<td>队列粒度，吞吐攒批性能更好，但容易不均衡</td>
</tr>
<tr>
<td>接口灵活度</td>
<td>高度封装，不够灵活。</td>
<td>原子接口，可灵活自定义。</td>
<td>原子接口，可灵活自定义。</td>
</tr>
<tr>
<td>适用场景</td>
<td>适用于无自定义流程的业务消息开发场景。</td>
<td>适用于需要高度自定义业务流程的业务开发场景。</td>
<td>仅推荐在流处理框架场景下集成使用</td>
</tr>
</tbody></table>
<p>在rocketmq spring boot starter中,使用的是PushConsumer。</p>
<p>只有引入rocketmq-client-java才会有push、simple、pull的区别吧。</p>
<p>了解更多看官网内容吧。</p>
<h3 id="普通消息"><a href="#普通消息" class="headerlink" title="普通消息"></a>普通消息</h3><h4 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h4><p><strong>典型场景一：微服务异步解耦</strong></p>
<p>以在线的电商交易场景为例，上游订单系统将用户下单支付这一业务事件封装成独立的普通消息并发送至Apache RocketMQ服务端，下游按需从服务端订阅消息并按照本地消费逻辑处理下游任务。每个消息之间都是相互独立的，且不需要产生关联。</p>
<p><strong>典型场景二：数据集成传输</strong></p>
<p>以离线的日志收集场景为例，通过埋点组件收集前端应用的相关操作日志，并转发到 Apache RocketMQ 。每条消息都是一段日志数据，Apache RocketMQ 不做任何处理，只需要将日志数据可靠投递到下游的存储系统和分析系统即可，后续功能由后端应用完成。</p>
<h4 id="spring-boot-代码"><a href="#spring-boot-代码" class="headerlink" title="spring boot 代码"></a>spring boot 代码</h4><p>上面最开始就是普通消息。</p>
<h3 id="顺序消息"><a href="#顺序消息" class="headerlink" title="顺序消息"></a>顺序消息</h3><h4 id="应用场景-1"><a href="#应用场景-1" class="headerlink" title="应用场景"></a>应用场景</h4><p><strong>典型场景一：撮合交易</strong></p>
<p>以证券、股票交易撮合场景为例，对于出价相同的交易单，坚持按照先出价先交易的原则，下游处理订单的系统需要严格按照出价顺序来处理订单。</p>
<p><strong>典型场景二：数据实时增量同步</strong></p>
<p>以数据库变更增量同步场景为例，上游源端数据库按需执行增删改操作，将二进制操作日志作为消息，通过 Apache RocketMQ 传输到下游搜索系统，下游系统按顺序还原消息数据，实现状态数据按序刷新。如果是普通消息则可能会导致状态混乱，和预期操作结果不符，基于顺序消息可以实现下游状态和上游操作结果一致。</p>
<h4 id="如何保证顺序性"><a href="#如何保证顺序性" class="headerlink" title="如何保证顺序性"></a>如何保证顺序性</h4><p>Apache RocketMQ 顺序消息的顺序关系通过消息组（MessageGroup）判定和识别，发送顺序消息时需要为每条消息设置归属的消息组，相同消息组的多条消息之间遵循先进先出的顺序关系，不同消息组、无消息组的消息之间不涉及顺序性。</p>
<p>Apache RocketMQ 的消息的顺序性分为两部分，生产顺序性和消费顺序性。</p>
<p><strong>生产顺序性</strong> ：</p>
<p>Apache RocketMQ 通过生产者和服务端的协议保障单个生产者串行地发送消息，并按序存储和持久化。</p>
<p>如需保证消息生产的顺序性，则必须满足以下条件：</p>
<ul>
<li>单一生产者：消息生产的顺序性仅支持单一生产者，不同生产者分布在不同的系统，即使设置相同的消息组，不同生产者之间产生的消息也无法判定其先后顺序。</li>
<li>串行发送：Apache RocketMQ 生产者客户端支持多线程安全访问，但如果生产者使用多线程并行发送，则不同线程间产生的消息将无法判定其先后顺序。</li>
</ul>
<p>满足以上条件的生产者，将顺序消息发送至 Apache RocketMQ 后，会保证设置了同一消息组的消息，按照发送顺序存储在同一队列中。服务端顺序存储逻辑如下：</p>
<ul>
<li>相同消息组的消息按照先后顺序被存储在同一个队列。</li>
<li>不同消息组的消息可以混合在同一个队列中，且不保证连续。</li>
</ul>
<p><strong>消费顺序性</strong> ：</p>
<p>Apache RocketMQ 通过消费者和服务端的协议保障消息消费严格按照存储的先后顺序来处理。</p>
<p>如需保证消息消费的顺序性，则必须满足以下条件：</p>
<p>投递顺序：</p>
<p>Apache RocketMQ 通过客户端SDK和服务端通信协议保障消息按照服务端存储顺序投递，但业务方消费消息时需要严格按照接收—处理—应答的语义处理消息，避免因异步处理导致消息乱序。</p>
<p>消费者类型为PushConsumer时， Apache RocketMQ 保证消息按照存储顺序一条一条投递给消费者，若消费者类型为SimpleConsumer，则消费者有可能一次拉取多条消息。此时，消息消费的顺序性需要由业务方自行保证。</p>
<p>有限重试：</p>
<p>Apache RocketMQ 顺序消息投递仅在重试次数限定范围内，即一条消息如果一直重试失败，超过最大重试次数后将不再重试，跳过这条消息消费，不会一直阻塞后续消息处理。</p>
<p>对于需要严格保证消费顺序的场景，请务设置合理的重试次数，避免参数不合理导致消息乱序。</p>
<h4 id="spring-boot-代码-1"><a href="#spring-boot-代码-1" class="headerlink" title="spring boot 代码"></a>spring boot 代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.rocketmq.spring.core.RocketMQTemplate;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProducerController</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/sendMsg&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMsg</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 参数一：topic   如果想添加tag,可以使用&quot;topic:tag&quot;的写法</span><br>        <span class="hljs-comment">// 参数二：消息内容</span><br>        <span class="hljs-comment">// 参数三：hashKey 用来计算决定消息发送到哪个消息队列， 一般是订单ID，产品ID等</span><br>        rocketMQTemplate.syncSendOrderly(<span class="hljs-string">&quot;TestTopic&quot;</span>, <span class="hljs-string">&quot;orderId1创建&quot;</span>, <span class="hljs-string">&quot;orderId1&quot;</span>);<br>        rocketMQTemplate.syncSendOrderly(<span class="hljs-string">&quot;TestTopic&quot;</span>, <span class="hljs-string">&quot;orderId2创建&quot;</span>, <span class="hljs-string">&quot;orderId2&quot;</span>);<br>        rocketMQTemplate.syncSendOrderly(<span class="hljs-string">&quot;TestTopic&quot;</span>, <span class="hljs-string">&quot;orderId1支付&quot;</span>, <span class="hljs-string">&quot;orderId1&quot;</span>);<br>        rocketMQTemplate.syncSendOrderly(<span class="hljs-string">&quot;TestTopic&quot;</span>, <span class="hljs-string">&quot;orderId1完成&quot;</span>, <span class="hljs-string">&quot;orderId1&quot;</span>);<br>        rocketMQTemplate.syncSendOrderly(<span class="hljs-string">&quot;TestTopic&quot;</span>, <span class="hljs-string">&quot;orderId2支付&quot;</span>, <span class="hljs-string">&quot;orderId2&quot;</span>);<br>        rocketMQTemplate.syncSendOrderly(<span class="hljs-string">&quot;TestTopic&quot;</span>, <span class="hljs-string">&quot;orderId2完成&quot;</span>, <span class="hljs-string">&quot;orderId2&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.rocketmq.spring.annotation.ConsumeMode;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.spring.annotation.RocketMQMessageListener;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.spring.core.RocketMQListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-comment">// consumeMode = ConsumeMode.ORDERLY 消息模式使用顺序</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@RocketMQMessageListener(topic = &quot;TestTopic&quot;, consumerGroup = &quot;string_consumer&quot;, consumeMode = ConsumeMode.ORDERLY)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;String&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String message)</span> &#123;<br>        System.out.printf(<span class="hljs-string">&quot;------- StringConsumer received: %s \n&quot;</span>, message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="定时-x2F-延时消息"><a href="#定时-x2F-延时消息" class="headerlink" title="定时&#x2F;延时消息"></a>定时&#x2F;延时消息</h3><h4 id="应用场景-2"><a href="#应用场景-2" class="headerlink" title="应用场景"></a>应用场景</h4><p><strong>典型场景一：分布式定时调度</strong></p>
<p>在分布式定时调度场景下，需要实现各类精度的定时任务，例如每天5点执行文件清理，每隔2分钟触发一次消息推送等需求。传统基于数据库的定时调度方案在分布式场景下，性能不高，实现复杂。基于 Apache RocketMQ 的定时消息可以封装出多种类型的定时触发器。</p>
<p><strong>典型场景二：任务超时处理</strong></p>
<p>以电商交易场景为例，订单下单后暂未支付，此时不可以直接关闭订单，而是需要等待一段时间后才能关闭订单。使用 Apache RocketMQ 定时消息可以实现超时任务的检查触发。</p>
<p>基于定时消息的超时任务处理具备如下优势：</p>
<ul>
<li>精度高、开发门槛低：基于消息通知方式不存在定时阶梯间隔。可以轻松实现任意精度事件触发，无需业务去重。</li>
<li>高性能可扩展：传统的数据库扫描方式较为复杂，需要频繁调用接口扫描，容易产生性能瓶颈。 Apache RocketMQ 的定时消息具有高并发和水平扩展的能力。</li>
</ul>
<h4 id="spring-boot代码"><a href="#spring-boot代码" class="headerlink" title="spring boot代码"></a>spring boot代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.rocketmq.spring.core.RocketMQTemplate;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProducerController</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/sendMsg&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMsg</span><span class="hljs-params">()</span> &#123;<br>        rocketMQTemplate.syncSendDelayTimeMills(<span class="hljs-string">&quot;TestTopic&quot;</span>, <span class="hljs-string">&quot;延时消息内容&quot;</span>,<span class="hljs-number">20_000</span>);<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">deliverTimeStamp</span> <span class="hljs-operator">=</span> System.currentTimeMillis() +  <span class="hljs-number">10</span> * <span class="hljs-number">1000</span>;<br>        rocketMQTemplate.syncSendDeliverTimeMills(<span class="hljs-string">&quot;TestTopic&quot;</span>, <span class="hljs-string">&quot;定时消息内容&quot;</span>, deliverTimeStamp);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="事务消息"><a href="#事务消息" class="headerlink" title="事务消息"></a>事务消息</h3><h4 id="应用场景-3"><a href="#应用场景-3" class="headerlink" title="应用场景"></a>应用场景</h4><p><strong>基于Apache RocketMQ分布式事务消息：支持最终一致性</strong></p>
<h4 id="功能原理"><a href="#功能原理" class="headerlink" title="功能原理"></a>功能原理</h4><p><strong>什么是事务消息</strong></p>
<p>事务消息是 Apache RocketMQ 提供的一种高级消息类型，支持在分布式场景下保障消息生产和本地事务的最终一致性。</p>
<p><strong>事务消息处理流程</strong></p>
<p>事务消息交互流程如下图所示。</p>
<p><img src="/.com//rocketmq%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E6%B5%81%E7%A8%8B%E5%9B%BE.png" srcset="/img/loading.gif" lazyload></p>
<ol>
<li>生产者将消息发送至Apache RocketMQ服务端。</li>
<li>Apache RocketMQ服务端将消息持久化成功之后，向生产者返回Ack确认消息已经发送成功，此时消息被标记为”暂不能投递”，这种状态下的消息即为半事务消息。</li>
<li>生产者开始执行本地事务逻辑。</li>
<li>生产者根据本地事务执行结果向服务端提交二次确认结果（Commit或是Rollback），服务端收到确认结果后处理逻辑如下：<ul>
<li>二次确认结果为Commit：服务端将半事务消息标记为可投递，并投递给消费者。</li>
<li>二次确认结果为Rollback：服务端将回滚事务，不会将半事务消息投递给消费者。</li>
</ul>
</li>
<li>在断网或者是生产者应用重启的特殊情况下，若服务端未收到发送者提交的二次确认结果，或服务端收到的二次确认结果为Unknown未知状态，经过固定时间后，服务端将对消息生产者即生产者集群中任一生产者实例发起消息回查。 <strong>说明</strong> 服务端回查的间隔时间和最大回查次数。</li>
<li>生产者收到消息回查后，需要检查对应消息的本地事务执行的最终结果。</li>
<li>生产者根据检查到的本地事务的最终状态再次提交二次确认，服务端仍按照步骤4对半事务消息进行处理。</li>
</ol>
<h4 id="spring-boot代码-1"><a href="#spring-boot代码-1" class="headerlink" title="spring boot代码"></a>spring boot代码</h4><p>添加mybatis-plus代码</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-generator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.31<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.32<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>application.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">rocketmq.name-server</span>=<span class="hljs-string">192.168.158.136:9876</span><br><span class="hljs-attr">rocketmq.producer.group</span>=<span class="hljs-string">my-group2</span><br><span class="hljs-attr">rocketmq.producer.sendMessageTimeout</span>=<span class="hljs-string">300000</span><br><span class="hljs-comment"># default producer tls config</span><br><span class="hljs-attr">rocketmq.producer.tls-enable</span>=<span class="hljs-string">false</span><br><br><span class="hljs-attr">spring.datasource.type</span>=<span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span><br><span class="hljs-attr">spring.datasource.url</span>=<span class="hljs-string">jdbc:mysql://127.0.0.1:3306/test?useSSL=true\</span><br><span class="hljs-string">  &amp;useUnicode=true\</span><br><span class="hljs-string">  &amp;characterEncoding=UTF-8\</span><br><span class="hljs-string">  &amp;useServerPrepStmts=true\</span><br><span class="hljs-string">  &amp;serverTimezone=Asia/Shanghai\</span><br><span class="hljs-string">  &amp;zeroDateTimeBehavior=CONVERT_TO_NULL</span><br><span class="hljs-attr">spring.datasource.username</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">spring.datasource.password</span>=<span class="hljs-string">root123456</span><br></code></pre></td></tr></table></figure>

<p>这里改变了生产者的组和数据库参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@MapperScan(&quot;com.example.rocketmqtest.mapper&quot;)</span><br><span class="hljs-meta">@EnableTransactionManagement</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RocketmqTestApplication</span> &#123;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>		SpringApplication.run(RocketmqTestApplication.class, args);<br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> hqc</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 2023-11-18</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主键ID</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 姓名</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 年龄</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer age;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 邮箱</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String email;<br><br>    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(Integer age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getEmail</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> email;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setEmail</span><span class="hljs-params">(String email)</span> &#123;<br>        <span class="hljs-built_in">this</span>.email = email;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;User&#123;&quot;</span> +<br>            <span class="hljs-string">&quot;id = &quot;</span> + id +<br>            <span class="hljs-string">&quot;, name = &quot;</span> + name +<br>            <span class="hljs-string">&quot;, age = &quot;</span> + age +<br>            <span class="hljs-string">&quot;, email = &quot;</span> + email +<br>        <span class="hljs-string">&quot;&#125;&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.example.rocketmqtest.entity.User;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> *  Mapper 接口</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> hqc</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 2023-11-18</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;User&gt; &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.example.rocketmqtest.rocketmq-test.mapper.UserMapper&quot;</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.example.rocketmqtest.entity.User;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> *  服务类</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> hqc</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 2023-11-18</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;User&gt; &#123;<br><br>    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">update1</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.example.rocketmqtest.entity.User;<br><span class="hljs-keyword">import</span> com.example.rocketmqtest.mapper.UserMapper;<br><span class="hljs-keyword">import</span> com.example.rocketmqtest.service.IUserService;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.spring.core.RocketMQTemplate;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.spring.support.RocketMQHeaders;<br><span class="hljs-keyword">import</span> org.springframework.messaging.Message;<br><span class="hljs-keyword">import</span> org.springframework.messaging.support.MessageBuilder;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> *  服务实现类</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> hqc</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 2023-11-18</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IUserService</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;<br><br>    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getById(<span class="hljs-number">1</span>);<br>        user.setAge(<span class="hljs-number">100</span>);<br>        <span class="hljs-built_in">this</span>.updateById(user);<br><br>        <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> MessageBuilder.withPayload(<span class="hljs-string">&quot;事务消息&quot;</span>).<br>                setHeader(RocketMQHeaders.TRANSACTION_ID, user.getId()).build();<br>        rocketMQTemplate.sendMessageInTransaction(<span class="hljs-string">&quot;TestTranctioinTopic&quot;</span>, msg, <span class="hljs-string">&quot;orderId1&quot;</span>);<br>        <span class="hljs-comment">//int i = 1/0;</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user2</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getById(<span class="hljs-number">2</span>);<br>        user2.setAge(<span class="hljs-number">100</span>);<br>        <span class="hljs-built_in">this</span>.updateById(user2);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.example.rocketmqtest.service.IUserService;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.spring.core.RocketMQTemplate;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.spring.support.RocketMQHeaders;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.messaging.Message;<br><span class="hljs-keyword">import</span> org.springframework.messaging.support.MessageBuilder;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProducerController</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IUserService iUserService;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/sendMsg&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMsg</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> MessageBuilder.withPayload(<span class="hljs-string">&quot;事务消息&quot;</span>).<br>                setHeader(RocketMQHeaders.TRANSACTION_ID, <span class="hljs-number">1</span>).build();<br>        rocketMQTemplate.sendMessageInTransaction(<span class="hljs-string">&quot;TestTranctioinTopic&quot;</span>, msg, <span class="hljs-string">&quot;orderId1&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/sendMsg2&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMsg2</span><span class="hljs-params">()</span> &#123;<br>        iUserService.update1();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>事物消息生产者监听器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.example.rocketmqtest.entity.User;<br><span class="hljs-keyword">import</span> com.example.rocketmqtest.service.IUserService;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.spring.annotation.RocketMQTransactionListener;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.spring.core.RocketMQLocalTransactionListener;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.spring.core.RocketMQLocalTransactionState;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.spring.support.RocketMQHeaders;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.messaging.Message;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@RocketMQTransactionListener</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TranscationProducterListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQLocalTransactionListener</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IUserService iUserService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> RocketMQLocalTransactionState <span class="hljs-title function_">executeLocalTransaction</span><span class="hljs-params">(Message msg, Object arg)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">transId</span> <span class="hljs-operator">=</span> (String) msg.getHeaders().get(RocketMQHeaders.TRANSACTION_ID);<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> iUserService.getById(transId);<br>        System.out.println(transId);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-number">100</span> == user.getAge()) &#123;<br>            <span class="hljs-comment">// 本地事务执行成功</span><br>            <span class="hljs-keyword">return</span> RocketMQLocalTransactionState.COMMIT;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 本地事务执行失败</span><br>            <span class="hljs-keyword">return</span> RocketMQLocalTransactionState.ROLLBACK;<br>        &#125;<br>        <span class="hljs-comment">// 本地事务执行异常</span><br>        <span class="hljs-comment">//return RocketMQLocalTransactionState.UNKNOWN;</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> RocketMQLocalTransactionState <span class="hljs-title function_">checkLocalTransaction</span><span class="hljs-params">(Message msg)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">transId</span> <span class="hljs-operator">=</span> (String) msg.getHeaders().get(RocketMQHeaders.TRANSACTION_ID);<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> iUserService.getById(transId);<br>        System.out.println(transId);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-number">100</span> == user.getAge()) &#123;<br>            <span class="hljs-comment">// 本地事务执行成功</span><br>            <span class="hljs-keyword">return</span> RocketMQLocalTransactionState.COMMIT;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 本地事务执行失败</span><br>            <span class="hljs-keyword">return</span> RocketMQLocalTransactionState.ROLLBACK;<br>        &#125;<br>        <span class="hljs-comment">// 本地事务执行异常</span><br>        <span class="hljs-comment">//return RocketMQLocalTransactionState.UNKNOWN;</span><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个类才会消息状态，半事务消息转为提交待消费。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.rocketmq.spring.annotation.RocketMQMessageListener;<br><span class="hljs-keyword">import</span> org.apache.rocketmq.spring.core.RocketMQListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * StringTransactionalConsumer</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@RocketMQMessageListener(topic = &quot;TestTranctioinTopic&quot;, consumerGroup = &quot;string_trans_consumer&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringTransactionalConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;String&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String message)</span> &#123;<br>        System.out.printf(<span class="hljs-string">&quot;------- StringTransactionalConsumer received: %s \n&quot;</span>, message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>通过注释和取消注释来验证消息发送</p>
<h3 id="消息发送方式"><a href="#消息发送方式" class="headerlink" title="消息发送方式"></a>消息发送方式</h3><p>4.0的文档中生产者-&gt;普通消息发送</p>
<p>Apache RocketMQ可用于以三种方式发送消息：<strong>同步、异步和单向传输</strong>。前两种消息类型是可靠的，因为无论它们是否成功发送都有响应。</p>
<h4 id="同步发送"><a href="#同步发送" class="headerlink" title="同步发送"></a>同步发送</h4><p>同步发送是最常用的方式，是指消息发送方发出一条消息后，会在收到服务端同步响应之后才发下一条消息的通讯方式，可靠的同步传输被广泛应用于各种场景，如重要的通知消息、短消息通知等。</p>
<p>同步发送的整个代码流程如下：</p>
<ol>
<li><strong>首先会创建一个producer</strong>。普通消息可以创建 DefaultMQProducer，创建时需要填写生产组的名称，生产者组是指同一类Producer的集合，这类Producer发送同一类消息且发送逻辑一致。</li>
<li><strong>设置 NameServer 的地址</strong>。Apache RocketMQ很多方式设置NameServer地址(客户端配置中有介绍)，这里是在代码中调用producer的API setNamesrvAddr进行设置，如果有多个NameServer，中间以分号隔开，比如”127.0.0.2:9876;127.0.0.3:9876”。</li>
<li><strong>第三步是构建消息</strong>。指定topic、tag、body等信息，tag可以理解成标签，对消息进行再归类，RocketMQ可以在消费端对tag进行过滤。</li>
<li><strong>最后调用send接口将消息发送出去</strong>。同步发送等待结果最后返回SendResult，SendResut包含实际发送状态还包括SEND_OK（发送成功）, FLUSH_DISK_TIMEOUT（刷盘超时）, FLUSH_SLAVE_TIMEOUT（同步到备超时）, SLAVE_NOT_AVAILABLE（备不可用），如果发送失败会抛出异常。</li>
</ol>
<p>同步发送方式请务必捕获发送异常，并做业务侧失败兜底逻辑，如果忽略异常则可能会导致消息未成功发送的情况。</p>
<h4 id="异步发送"><a href="#异步发送" class="headerlink" title="异步发送"></a>异步发送</h4><p>异步发送是指发送方发出一条消息后，不等服务端返回响应，接着发送下一条消息的通讯方式。</p>
<p>异步发送需要实现<strong>异步发送回调接口</strong>（SendCallback）。</p>
<p>消息发送方在发送了一条消息后，不需要等待服务端响应即可发送第二条消息，发送方通过回调接口接收服务端响应，并处理响应结果。异步发送一般用于链路耗时较长，对响应时间较为敏感的业务场景。例如，视频上传后通知启动转码服务，转码完成后通知推送转码结果等。</p>
<p>异步发送与同步发送代码唯一区别在于调用send接口的参数不同，异步发送不会等待发送返回，取而代之的是send方法需要传入 SendCallback 的实现，SendCallback 接口主要有onSuccess 和 onException 两个方法，表示消息发送成功和消息发送失败。</p>
<h4 id="单向模式发送"><a href="#单向模式发送" class="headerlink" title="单向模式发送"></a>单向模式发送</h4><p>发送方只负责发送消息，不等待服务端返回响应且没有回调函数触发，即只发送请求不等待应答。此方式发送消息的过程耗时非常短，一般在微秒级别。适用于某些耗时非常短，但对可靠性要求并不高的场景，例如日志收集。</p>
<p>单向模式调用sendOneway，不会对返回结果有任何等待和处理。</p>
<h3 id="消息发送重试及消息流控"><a href="#消息发送重试及消息流控" class="headerlink" title="消息发送重试及消息流控"></a>消息发送重试及消息流控</h3><h4 id="消息发送重试"><a href="#消息发送重试" class="headerlink" title="消息发送重试"></a>消息发送重试</h4><p>Apache RocketMQ 客户端连接服务端发起消息发送请求时，可能会因为网络故障、服务异常等原因导致调用失败。为保证消息的可靠性， Apache RocketMQ 在客户端SDK中内置请求重试逻辑，尝试通过重试发送达到最终调用成功的效果。</p>
<p>同步发送和异步发送模式均支持消息发送重试。</p>
<p><strong>重试触发条件</strong></p>
<p>触发消息发送重试机制的条件如下：</p>
<ul>
<li>客户端消息发送请求调用失败或请求超时</li>
<li>网络异常造成连接失败或请求超时。</li>
<li>服务端节点处于重启或下线等状态造成连接失败。</li>
<li>服务端运行慢造成请求超时。</li>
<li>服务端返回失败错误码<ul>
<li>系统逻辑错误：因运行逻辑不正确造成的错误。</li>
<li>系统流控错误：因容量超限造成的流控错误。</li>
</ul>
</li>
</ul>
<p>对于事务消息，只会进行<a target="_blank" rel="noopener" href="https://github.com/grpc/proposal/blob/master/A6-client-retries.md#transparent-retries">透明重试（transparent retries）</a>，网络超时或异常等场景不会进行重试。</p>
<h5 id="重试流程"><a href="#重试流程" class="headerlink" title="重试流程"></a>重试流程</h5><p>生产者在初始化时设置消息发送最大重试次数，当出现上述触发条件的场景时，生产者客户端会按照设置的重试次数一直重试发送消息，直到消息发送成功或达到最大重试次数重试结束，并在最后一次重试失败后返回调用错误响应。</p>
<ul>
<li>同步发送：调用线程会一直阻塞，直到某次重试成功或最终重试失败，抛出错误码和异常。</li>
<li>异步发送：调用线程不会阻塞，但调用结果会通过异常事件或者成功事件返回。</li>
</ul>
<h5 id="重试间隔"><a href="#重试间隔" class="headerlink" title="重试间隔"></a>重试间隔</h5><ul>
<li>除服务端返回系统流控错误场景，其他触发条件触发重试后，均会立即进行重试，无等待间隔。</li>
<li>若由于服务端返回流控错误触发重试，系统会按照指数退避策略进行延迟重试。指数退避算法通过以下参数控制重试行为：<ul>
<li>INITIAL_BACKOFF： 第一次失败重试前后需等待多久，默认值：1秒。</li>
<li>MULTIPLIER ：指数退避因子，即退避倍率，默认值：1.6。</li>
<li>JITTER ：随机抖动因子，默认值：0.2。</li>
<li>MAX_BACKOFF ：等待间隔时间上限，默认值：120秒</li>
<li>MIN_CONNECT_TIMEOUT ：最短重试间隔，默认值：20秒。</li>
</ul>
</li>
</ul>
<h5 id="功能约束"><a href="#功能约束" class="headerlink" title="功能约束"></a>功能约束</h5><ul>
<li>链路耗时阻塞评估：从上述重试机制可以看出，在重试流程中生产者仅能控制最大重试次数。若由于系统异常触发了SDK内置的重试逻辑，则服务端需要等待最终重试结果，可能会导致消息发送请求链路被阻塞。对于某些实时调用类场景，您需要合理评估每次调用请求的超时时间以及最大重试次数，避免影响全链路的耗时。</li>
<li>最终异常兜底： Apache RocketMQ 客户端内置的发送请求重试机制并不能保证消息发送一定成功。当最终重试仍然失败时，业务方调用需要捕获异常，并做好冗余保护处理，避免消息发送结果不一致。</li>
<li>消息重复问题：因远程调用的不确定性，当Apache RocketMQ客户端因请求超时触发消息发送重试流程，此时客户端无法感知服务端的处理结果，客户端进行的消息发送重试可能会产生消息重复问题，业务逻辑需要自行处理消息重复问题。****</li>
</ul>
<h4 id="消息流控机制"><a href="#消息流控机制" class="headerlink" title="消息流控机制"></a>消息流控机制</h4><p>消息流控指的是系统容量或水位过高， Apache RocketMQ 服务端会通过快速失败返回流控错误来避免底层资源承受过高压力。</p>
<h5 id="触发条件"><a href="#触发条件" class="headerlink" title="触发条件"></a>触发条件</h5><p>Apache RocketMQ 的消息流控触发条件如下：</p>
<ul>
<li>存储压力大：参考<a target="_blank" rel="noopener" href="https://rocketmq.apache.org/zh/docs/featureBehavior/09consumerprogress">消费进度管理</a>的原理机制，消费者分组的初始消费位点为当前队列的最大消费位点。若某些场景例如业务上新等需要回溯到指定时刻前开始消费，此时队列的存储压力会瞬间飙升，触发消息流控。</li>
<li>服务端请求任务排队溢出：若消费者消费能力不足，导致队列中有大量堆积消息，当堆积消息超过一定数量后会触发消息流控，减少下游消费系统压力。</li>
</ul>
<h5 id="流控行为"><a href="#流控行为" class="headerlink" title="流控行为"></a>流控行为</h5><p>当系统触发消息发送流控时，客户端会收到系统限流错误和异常，错误码信息如下：</p>
<ul>
<li>reply-code：530</li>
<li>reply-text：TOO_MANY_REQUESTS</li>
</ul>
<p>客户端收到系统流控错误码后，会根据指数退避策略进行消息发送重试。</p>
<h5 id="处理建议"><a href="#处理建议" class="headerlink" title="处理建议"></a>处理建议</h5><ul>
<li>如何避免触发消息流控：触发限流的根本原因是系统容量或水位过高，您可以利用可观测性功能监控系统水位容量等，保证底层资源充足，避免触发流控机制。</li>
<li>突发消息流控处理：如果因为突发原因触发消息流控，且客户端内置的重试流程执行失败，则建议业务方将请求调用临时替换到其他系统进行应急处理。</li>
</ul>
<h3 id="消息过滤"><a href="#消息过滤" class="headerlink" title="消息过滤"></a>消息过滤</h3><p>Apache RocketMQ 支持Tag标签过滤和SQL属性过滤，这两种过滤方式对比如下：</p>
<table>
<thead>
<tr>
<th>对比项</th>
<th>Tag标签过滤</th>
<th>SQL属性过滤</th>
</tr>
</thead>
<tbody><tr>
<td>过滤目标</td>
<td>消息的Tag标签。</td>
<td>消息的属性，包括用户自定义属性以及系统属性（Tag是一种系统属性）。</td>
</tr>
<tr>
<td>过滤能力</td>
<td>精准匹配。</td>
<td>SQL语法匹配。</td>
</tr>
<tr>
<td>适用场景</td>
<td>简单过滤场景、计算逻辑简单轻量。</td>
<td>复杂过滤场景、计算逻辑较复杂。</td>
</tr>
</tbody></table>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">rocketMQTemplate.syncSend() 参数一destination – formats: <span class="hljs-string">`topicName:tags`</span><br></code></pre></td></tr></table></figure>

<h4 id="订阅关系一致性"><a href="#订阅关系一致性" class="headerlink" title="订阅关系一致性"></a>订阅关系一致性</h4><p>过滤表达式属于订阅关系的一部分，Apache RocketMQ 的领域模型规定，同一消费者分组内的多个消费者的订阅关系包括过滤表达式，必须保持一致，否则可能会导致部分消息消费不到。</p>
<h3 id="消息者负载均衡"><a href="#消息者负载均衡" class="headerlink" title="消息者负载均衡"></a>消息者负载均衡</h3><p><img src="/.com//rocketmq%E6%B6%88%E8%B4%B9%E8%80%85%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li><p><strong>消费组间广播消费</strong> ：如上图所示，每个消费者分组只初始化唯一一个消费者，每个消费者可消费到消费者分组内所有的消息，各消费者分组都订阅相同的消息，以此实现单客户端级别的广播一对多推送效果。</p>
<p>该方式一般可用于网关推送、配置推送等场景。</p>
</li>
<li><p><strong>消费组内共享消费</strong> ：如上图所示，每个消费者分组下初始化了多个消费者，这些消费者共同分担消费者分组内的所有消息，实现消费者分组内流量的水平拆分和均衡负载。</p>
<p>该方式一般可用于微服务解耦场景。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RocketMQMessageListener</span> 注解中 messageModel<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">MessageModel</span> &#123;<br>    BROADCASTING(<span class="hljs-string">&quot;BROADCASTING&quot;</span>),<br>    CLUSTERING(<span class="hljs-string">&quot;CLUSTERING&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>内容还是看官网吧。</p>
<h3 id="消费进度管理"><a href="#消费进度管理" class="headerlink" title="消费进度管理"></a>消费进度管理</h3><ul>
<li>消费者启动后从哪里开始消费消息？</li>
<li>消费者每次消费成功后如何标记消息状态，确保下次不会再重复处理该消息？</li>
<li>某消息被指定消费者消费过一次后，如果业务出现异常需要做故障恢复，该消息能否被重新消费？</li>
</ul>
<h3 id="消费重试"><a href="#消费重试" class="headerlink" title="消费重试"></a>消费重试</h3><table>
<thead>
<tr>
<th>消费者类型</th>
<th>重试过程状态机</th>
<th>重试间隔</th>
<th>最大重试次数</th>
</tr>
</thead>
<tbody><tr>
<td>PushConsumer</td>
<td><em>已就绪</em> 处理中 <em>待重试</em> 提交 * 死信</td>
<td>消费者分组创建时元数据控制。 <em>无序消息：阶梯间隔</em> 顺序消息：固定间隔时间</td>
<td>消费者分组创建时的元数据控制。</td>
</tr>
<tr>
<td>SimpleConsumer</td>
<td><em>已就绪</em> 处理中 <em>提交</em> 死信</td>
<td>通过API修改获取消息时的不可见时间。</td>
<td>消费者分组创建时的元数据控制。</td>
</tr>
</tbody></table>
<p>更多看官网。</p>
<h3 id="消息存储和清理机制"><a href="#消息存储和清理机制" class="headerlink" title="消息存储和清理机制"></a>消息存储和清理机制</h3><p>Apache RocketMQ 使用存储时长作为消息存储的依据，即每个节点对外承诺消息的存储时长。在存储时长范围内的消息都会被保留，无论消息是否被消费；超过时长限制的消息则会被清理掉。</p>
<p>在 Apache RocketMQ中，消息保存时长并不能完整控制消息的实际保存时间，因为消息存储仍然使用本地磁盘，本地磁盘空间不足时，为保证服务稳定性消息仍然会被强制清理，导致消息的实际保存时长小于设置的保存时长。</p>
<p>更多看官网。</p>
<h2 id="RocketMQ-Promethus-Exporter"><a href="#RocketMQ-Promethus-Exporter" class="headerlink" title="RocketMQ Promethus Exporter"></a>RocketMQ Promethus Exporter</h2><p><code>Rocketmq-exporter</code> 是用于监控 RocketMQ broker 端和客户端所有相关指标的系统，通过 <code>mqAdmin</code> 从 broker 端获取指标值后封装成 87 个 cache。</p>
<p>就是可以提供监控的exporter。 </p>
<h2 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a>Metrics</h2><ul>
<li>服务端 Metrics 指标</li>
<li>生产者 Metrics 指标</li>
<li>消费者 Metrics 指标</li>
</ul>
<h2 id="权限控制"><a href="#权限控制" class="headerlink" title="权限控制"></a>权限控制</h2><p>看官网吧</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/mq/">mq</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/mq/">mq</a>
                    
                      <a class="hover-with-bg" href="/tags/rocketmq/">rocketmq</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/11/18/mq/rocketmq%E7%9A%84cluster%E5%B8%83%E7%BD%B2/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">rocketmq的cluster布署</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/11/02/mybatis/mybatis_plus%E6%95%B4%E5%90%88%E5%88%B0springboot%E4%BD%BF%E7%94%A8/">
                        <span class="hidden-mobile">mybatis_plus整合到springboot使用</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  
  <!-- 备案信息 -->
  <div class="beian">
    <span>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
        京ICP备18028493号
      </a>
    </span>
    
      
        <span>
          <a
            href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502035713"
            rel="nofollow noopener"
            class="beian-police"
            target="_blank"
          >
            
              <span style="visibility: hidden; width: 0">|</span>
              <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
            
            <span>11010502035713</span>
          </a>
        </span>
      
    
  </div>


  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
