<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>java8的Optional</title>
    <link href="/2023/08/23/java/java8%E7%9A%84Optional/"/>
    <url>/2023/08/23/java/java8%E7%9A%84Optional/</url>
    
    <content type="html"><![CDATA[<h2 id="看源码类注释"><a href="#看源码类注释" class="headerlink" title="看源码类注释"></a>看源码类注释</h2><p>一个容器对象，可以包含或不包含非空值。</p><p>如果存在一个值，{@code isPresent()}将返回{@code true}，{@code get()}将返回该值。</p><p>提供了依赖于包含值的存在与否的其他方法，例如{@link #orElse(java.lang.Object) orElse()}（如果值不存在，则返回默认值）和{@link #ifPresent(java.util.function.Consumer) ifPresent()}（如果值存在，则执行一段代码块）。</p><p>这是一个基于值的类；在{@code Optional}的实例上使用身份敏感操作（包括引用相等性（{@code &#x3D;&#x3D;}），身份哈希码或同步）可能会产生不可预测的结果，应该避免使用。</p><figure class="highlight"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs">这是一个基于值的类，应避免使用在共享资源或比较操作。<br></code></pre></td></tr></table></figure><h2 id="方法介绍"><a href="#方法介绍" class="headerlink" title="方法介绍"></a>方法介绍</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-title function_">isPresent</span><span class="hljs-params">()</span><br>如果值存在则方法会返回<span class="hljs-literal">true</span>，否则返回 <span class="hljs-literal">false</span>。<br></code></pre></td></tr></table></figure><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">T</span> <span class="hljs-function"><span class="hljs-title">get</span>()</span><br>如果在这个<span class="hljs-variable">Optional</span>中包含这个值，返回值，否则抛出异常：<span class="hljs-variable">NoSuchElementException</span><br></code></pre></td></tr></table></figure><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs excel"><span class="hljs-built_in">T</span> orElse(<span class="hljs-built_in">T</span> other)<br>如果存在该值，返回值， 否则返回 other。<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">ifPresent</span><span class="hljs-params">(Consumer&lt;? <span class="hljs-built_in">super</span> T&gt; consumer)</span><br>如果值存在则使用该值调用 consumer , 否则不做任何事情。<br></code></pre></td></tr></table></figure><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scss">static &lt;T&gt; Optional&lt;T&gt; <span class="hljs-built_in">empty</span>()<br>返回空的 Optional 实例。<br></code></pre></td></tr></table></figure><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-keyword">Optional</span>&lt;T&gt; filter(Predicate&lt;? super &lt;T&gt; predicate)<br>如果值存在，并且这个值匹配给定的 predicate，返回一个<span class="hljs-keyword">Optional</span>用以描述这个值，否则返回一个空的<span class="hljs-keyword">Optional</span>。<br></code></pre></td></tr></table></figure><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs fortran">&lt;U&gt; <span class="hljs-keyword">Optional</span>&lt;U&gt; flatMap(<span class="hljs-function"><span class="hljs-keyword">Function</span></span>&lt;? super T,<span class="hljs-keyword">Optional</span>&lt;U&gt;&gt; mapper)<br>如果值存在，返回基于<span class="hljs-keyword">Optional</span>包含的映射方法的值，否则返回一个空的<span class="hljs-keyword">Optional</span><br></code></pre></td></tr></table></figure><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs fortran">&lt;U&gt;<span class="hljs-keyword">Optional</span>&lt;U&gt; map(<span class="hljs-function"><span class="hljs-keyword">Function</span></span>&lt;? super T,? <span class="hljs-keyword">extends</span> U&gt; mapper)<br>如果有值，则对其执行调用映射函数得到返回值。如果返回值不为 null，则创建包含映射返回值的<span class="hljs-keyword">Optional</span>作为map方法返回值，否则返回空<span class="hljs-keyword">Optional</span>。<br></code></pre></td></tr></table></figure><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs excel">static &lt;<span class="hljs-built_in">T</span>&gt; Optional&lt;<span class="hljs-built_in">T</span>&gt; of(<span class="hljs-built_in">T</span> <span class="hljs-built_in">value</span>)<br>返回一个指定非null值的Optional。<br></code></pre></td></tr></table></figure><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vbnet"><span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-keyword">Optional</span>&lt;T&gt; ofNullable(T value)<br>如果为非空，返回 <span class="hljs-keyword">Optional</span> 描述的指定值，否则返回空的 <span class="hljs-keyword">Optional</span>。<br></code></pre></td></tr></table></figure><figure class="highlight gml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gml">T orElseGet(Supplier&lt;? extends T&gt; <span class="hljs-symbol">other</span>)<br>如果存在该值，返回值， 否则触发 <span class="hljs-symbol">other</span>，并返回 <span class="hljs-symbol">other</span> 调用的结果。<br></code></pre></td></tr></table></figure><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">&lt;X <span class="hljs-keyword">extends </span>Throwable&gt; T <span class="hljs-keyword">orElseThrow(Supplier&lt;? </span><span class="hljs-keyword">extends </span>X&gt; exceptionSupplier)<br>如果存在该值，返回包含的值，否则抛出由 Supplier 继承的异常<br></code></pre></td></tr></table></figure><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">// 案例一 如果为空就抛异常</span><br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == person) &#123;<br>            <span class="hljs-keyword">throw</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;person为空&quot;</span>);<br>        &#125;<br>        Optional.ofNullable(person).orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;person为空&quot;</span>));<br><br>        <span class="hljs-comment">// 案例二 如果不空才处理</span><br>        Optional.ofNullable(person).ifPresent(person1 -&gt; System.out.println(person1.getAge()));<br><br>        <span class="hljs-comment">// 案例三 如果符合条件返回原来的对象，不符合返回空</span><br>        person.setAge(<span class="hljs-number">17</span>);<br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">pass</span> <span class="hljs-operator">=</span> Optional.ofNullable(person).filter(person12 -&gt; person12.getAge() &gt; <span class="hljs-number">18</span>).isPresent();<br>        <span class="hljs-comment">// 不符合</span><br>        System.out.println(pass);<br><br>        <span class="hljs-comment">// 案例四 如果有值，进行值转换</span><br>        Optional.ofNullable(person).map((Function&lt;Person, Object&gt;) person13 -&gt; &#123;<br>            person13.setAge(person13.getAge() + <span class="hljs-number">10</span>);<br>            <span class="hljs-keyword">return</span> person13;<br>        &#125;);<br>        person.setName(<span class="hljs-string">&quot;姓名&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> Optional.ofNullable(person).map( person13 -&gt; person13.getName()).orElse(<span class="hljs-string">&quot;&quot;</span>);<br>        System.out.println(name);<br><br>    &#125;<br><br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> Integer age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, Integer age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(Integer age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java8的Stream</title>
    <link href="/2023/08/23/java/java8%E7%9A%84Stream/"/>
    <url>/2023/08/23/java/java8%E7%9A%84Stream/</url>
    
    <content type="html"><![CDATA[<h2 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h2><p>Java 8 API添加了一个新的抽象称为流Stream，可以让你以一种声明的方式处理数据。</p><p>Stream 使用一种类似用 SQL 语句从数据库查询数据的直观方式来提供一种对 Java 集合运算和表达的高阶抽象。</p><p>Stream API可以极大提高Java程序员的生产力，让程序员写出高效率、干净、简洁的代码。</p><p>这种风格将要处理的元素集合看作一种流， 流在管道中传输， 并且可以在管道的节点上进行处理， 比如筛选， 排序，聚合等。</p><p>元素流在管道中经过中间操作（intermediate operation）的处理，最后由最终操作(terminal operation)得到前面处理的结果。</p><h3 id="中间操作"><a href="#中间操作" class="headerlink" title="中间操作"></a>中间操作</h3><ul><li><code>filter(Predicate&lt;T&gt; predicate)</code>: 过滤满足条件的元素。</li><li><code>map(Function&lt;T, R&gt; mapper)</code>: 映射元素到另一种类型。</li><li><code>flatMap(Function&lt;T, Stream&lt;R&gt;&gt; mapper)</code>: 将每个元素映射成一个流，并将多个流扁平化为一个流。</li><li><code>distinct()</code>: 去除重复的元素。</li><li><code>sorted()</code>: 对元素进行自然顺序排序。</li><li><code>sorted(Comparator&lt;T&gt; comparator)</code>: 使用自定义比较器对元素进行排序。</li><li><code>peek(Consumer&lt;T&gt; action)</code>: 在处理每个元素时执行一些操作，但不改变流中的元素。</li></ul><h3 id="终端操作"><a href="#终端操作" class="headerlink" title="终端操作"></a>终端操作</h3><ul><li><code>forEach(Consumer&lt;T&gt; action)</code>: 对每个元素执行操作。</li><li><code>toArray()</code>: 将流中的元素收集到数组中。</li><li><code>collect(Collector&lt;T, A, R&gt; collector)</code>: 将元素收集到一个集合或数据结构中。</li><li><code>reduce(T identity, BinaryOperator&lt;T&gt; accumulator)</code>: 使用给定的初始值和累加函数，将流中的元素归约为一个值。</li><li><code>min(Comparator&lt;T&gt; comparator)</code>: 返回流中的最小元素。</li><li><code>max(Comparator&lt;T&gt; comparator)</code>: 返回流中的最大元素。</li><li><code>count()</code>: 返回流中元素的个数。</li><li><code>anyMatch(Predicate&lt;T&gt; predicate)</code>: 检查是否有元素满足条件。</li><li><code>allMatch(Predicate&lt;T&gt; predicate)</code>: 检查是否所有元素都满足条件。</li><li><code>noneMatch(Predicate&lt;T&gt; predicate)</code>: 检查是否没有元素满足条件。</li><li><code>findFirst()</code>: 返回流中的第一个元素。</li><li><code>findAny()</code>: 返回流中的任意一个元素。</li></ul><h3 id="其他操作"><a href="#其他操作" class="headerlink" title="其他操作"></a>其他操作</h3><ul><li><code>concat(Stream&lt;T&gt; a, Stream&lt;T&gt; b)</code>: 将两个流合并为一个流。</li><li><code>iterate(T seed, UnaryOperator&lt;T&gt; f)</code>: 生成一个无限流，以指定的初始值和递增函数生成序列。</li><li><code>generate(Supplier&lt;T&gt; s)</code>: 生成一个无限流，使用提供的供应商生成元素。</li></ul>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java8的lambda表达式与函数接口</title>
    <link href="/2023/08/23/java/java8%E7%9A%84lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%B8%8E%E5%87%BD%E6%95%B0%E6%8E%A5%E5%8F%A3/"/>
    <url>/2023/08/23/java/java8%E7%9A%84lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%B8%8E%E5%87%BD%E6%95%B0%E6%8E%A5%E5%8F%A3/</url>
    
    <content type="html"><![CDATA[<h2 id="lambda表达式"><a href="#lambda表达式" class="headerlink" title="lambda表达式"></a>lambda表达式</h2><p>Lambda 表达式，也可称为闭包。Lambda 允许把函数作为一个方法的参数（函数作为参数传递进方法中）。</p><p>使用 Lambda 表达式可以使代码变的更加简洁紧凑。</p><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><figure class="highlight livescript"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-function"><span class="hljs-params">(parameters)</span> -&gt;</span> expression<br>或<br><span class="hljs-function"><span class="hljs-params">(parameters)</span> -&gt;</span>&#123; statements; &#125;<br></code></pre></td></tr></table></figure><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-comment">// 1. 不需要参数,返回值为 5  </span><br>() -&gt; <span class="hljs-number">5</span>  <br>  <br><span class="hljs-comment">// 2. 接收一个参数(数字类型),返回其2倍的值  </span><br><span class="hljs-function"><span class="hljs-title">x</span> -&gt;</span> <span class="hljs-number">2</span> * x  <br>  <br><span class="hljs-comment">// 3. 接受2个参数(数字),并返回他们的差值  </span><br>(<span class="hljs-function"><span class="hljs-title">x</span>, y) -&gt;</span> x – y  <br>  <br><span class="hljs-comment">// 4. 接收2个int型整数,返回他们的和  </span><br>(<span class="hljs-function"><span class="hljs-title">int</span> x, int y) -&gt;</span> x + y  <br>  <br><span class="hljs-comment">// 5. 接受一个 string 对象,并在控制台打印,不返回任何值(看起来像是返回void)  </span><br>(S<span class="hljs-function"><span class="hljs-title">tring</span> s) -&gt;</span> System.out.print(s)<br></code></pre></td></tr></table></figure><h3 id="隐式final"><a href="#隐式final" class="headerlink" title="隐式final"></a>隐式final</h3><p>可以直接在 lambda 表达式中访问外层的局部变量,但lambda 表达式的局部变量可以不用声明为 final，但是必须不可被后面的代码修改（即隐性的具有 final 的语义）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>        Converter&lt;Integer, String&gt; s = (param) -&gt; System.out.println(String.valueOf(param + num));<br>        s.convert(<span class="hljs-number">2</span>);  <span class="hljs-comment">// 输出结果为 3</span><br>        <span class="hljs-comment">// num = 5;直接编译期报错。</span><br>        num = <span class="hljs-number">5</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Converter</span>&lt;T1, T2&gt; &#123;<br>        <span class="hljs-keyword">void</span> <span class="hljs-title function_">convert</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="函数接口"><a href="#函数接口" class="headerlink" title="函数接口"></a>函数接口</h2><p>函数式接口(Functional Interface)就是一个有且仅有一个抽象方法，但是可以有多个非抽象方法的接口。</p><p>函数式接口可以被隐式转换为 lambda 表达式。</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">java.util.<span class="hljs-keyword">function</span> <span class="hljs-title">下全部都是</span><br></code></pre></td></tr></table></figure><p>在编程时，可以先写new Xxx() {} 然后在Xxx类名灰色的状态点击上面的小灯，点击转换为lambda表达式。</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java8的方法引用</title>
    <link href="/2023/08/23/java/java8%E7%9A%84%E6%96%B9%E6%B3%95%E5%BC%95%E7%94%A8/"/>
    <url>/2023/08/23/java/java8%E7%9A%84%E6%96%B9%E6%B3%95%E5%BC%95%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="方法引用"><a href="#方法引用" class="headerlink" title="方法引用"></a>方法引用</h2><p>方法引用通过方法的名字来指向一个方法。</p><p>方法引用可以使语言的构造更紧凑简洁，减少冗余代码。</p><p>方法引用使用一对冒号 <strong>::</strong> 。</p><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span> &#123;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Car <span class="hljs-title function_">create</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Supplier&lt;Car&gt; supplier)</span> &#123;<br>        <span class="hljs-keyword">return</span> supplier.get();<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">collide</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Car car)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;静态方法&quot;</span> + car.toString());<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">follow</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Car another)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;应该是this与传进来的对象比较&quot;</span> + another.toString());<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">repair</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;私有方法 &quot;</span> + <span class="hljs-built_in">this</span>.toString());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以先这么写：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Car</span> <span class="hljs-variable">car</span> <span class="hljs-operator">=</span> Car.create(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Supplier</span>&lt;Car&gt;() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Car <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>();<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p>在IDE中，把鼠标移动new Supplier上，可以看到一个黄色的小灯，点击小灯，出现两个选项一个是替换为lambda表达式，一个是替换为方法引用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Car</span> <span class="hljs-variable">car</span> <span class="hljs-operator">=</span> Car.create(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>());<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Car</span> <span class="hljs-variable">car</span> <span class="hljs-operator">=</span> Car.create(Car::<span class="hljs-keyword">new</span>);<br></code></pre></td></tr></table></figure><p><strong>构造器引用：</strong>它的语法是Class::new</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Car</span> <span class="hljs-variable">car</span> <span class="hljs-operator">=</span> Car.create(Car::<span class="hljs-keyword">new</span>);<br></code></pre></td></tr></table></figure><p><strong>静态方法引用：</strong>它的语法是Class::static_method</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> List&lt;Car&gt; cars = Arrays.asList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>());<br>cars.forEach( Car::collide );<br></code></pre></td></tr></table></figure><p><strong>特定类的任意对象的方法引用:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">cars.forEach( Car::repair );<br></code></pre></td></tr></table></figure><p><strong>特定对象的方法引用:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">Car</span> <span class="hljs-variable">police</span> <span class="hljs-operator">=</span> Car.create( Car::<span class="hljs-keyword">new</span> );<br>cars.forEach( police::follow );<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用springboot时kill不掉情况</title>
    <link href="/2023/08/09/spring/%E4%BD%BF%E7%94%A8springboot%E6%97%B6kill%E4%B8%8D%E6%8E%89%E6%83%85%E5%86%B5/"/>
    <url>/2023/08/09/spring/%E4%BD%BF%E7%94%A8springboot%E6%97%B6kill%E4%B8%8D%E6%8E%89%E6%83%85%E5%86%B5/</url>
    
    <content type="html"><![CDATA[<h2 id="记录一下情况"><a href="#记录一下情况" class="headerlink" title="记录一下情况"></a>记录一下情况</h2><p>当重启服务流程为 覆盖jar包  -&gt;  停止服务   -&gt; 启动服务，这时停止服务出现kill不掉的情况。</p><p>当重启服务流程为 mv&#x2F;rm jar包 -&gt; 停止服务 -&gt; 启动服务，这时还未出现服务kill不掉的情况。</p>]]></content>
    
    
    <categories>
      
      <category>springboot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>springboot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>单元测试工具Mockito</title>
    <link href="/2023/07/27/java/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7Mockito/"/>
    <url>/2023/07/27/java/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7Mockito/</url>
    
    <content type="html"><![CDATA[<h2 id="为什么使用Mockito"><a href="#为什么使用Mockito" class="headerlink" title="为什么使用Mockito"></a>为什么使用Mockito</h2><p>项目中代码需要进行单元测试。测试人员用黑盒测试的软件功能，无法完全覆盖代码中的逻辑，所以要有代码的单元测试。</p><p>spring 的单元测试有以下缺点：</p><p>1.每次执行测试方法都必须启动spring容器。当项目规模较大、配置较为复杂时，会很慢。</p><p>2.如果使用数据库如mysql, 还会涉及插入数据、数据库自增ID增加问题、bug引起的大量脏数据</p><p>3.如果使用数据库，需要根据ID查询数据，必须要插入一条数据，每次执行单元测试都需要</p><p>如果只想测试service代码的正确性，使用Mockito就可以解决。</p><p>spring 的单元测试也是有用的，对容器、对组件的验证还是需要的。想要测试哪里选择不同的单元测试工具。</p><h2 id="测试类"><a href="#测试类" class="headerlink" title="测试类"></a>测试类</h2><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestDomain</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TestMapper</span> &#123;<br><br>    Long <span class="hljs-title function_">getMax</span><span class="hljs-params">()</span>;<br><br>    TestDomain <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span>;<br><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">save</span><span class="hljs-params">(TestDomain testDomain)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestService</span> &#123;<br><br>    <span class="hljs-keyword">private</span> TestMapper testMapper;<br><br>    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">method1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> testMapper.getMax();<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(TestDomain testDomain)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> testMapper.save(testDomain);<br>        <span class="hljs-keyword">if</span> (i &lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;插入失败&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> TestDomain <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> testMapper.getById(id);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="使用Mockito"><a href="#使用Mockito" class="headerlink" title="使用Mockito"></a>使用Mockito</h2><p><a href="https://github.com/mockito/mockito">https://github.com/mockito/mockito</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mockito<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mockito-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.23.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.junit.Assert;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.mockito.InjectMocks;<br><span class="hljs-keyword">import</span> org.mockito.Mock;<br><span class="hljs-keyword">import</span> org.mockito.Mockito;<br><span class="hljs-keyword">import</span> org.mockito.junit.MockitoJUnitRunner;<br><br><span class="hljs-meta">@RunWith(MockitoJUnitRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestServiceTest</span> &#123;<br><br>    <span class="hljs-meta">@InjectMocks</span><br>    <span class="hljs-keyword">private</span> TestService testService;<br><br>    <span class="hljs-meta">@Mock</span><br>    <span class="hljs-keyword">public</span> TestMapper testMapper;<br><br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method1</span><span class="hljs-params">()</span> &#123;<br>        Mockito.when(testMapper.getMax()).thenReturn(<span class="hljs-number">20L</span>);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> testService.method1();<br>        Assert.assertEquals(id, <span class="hljs-number">20L</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">TestDomain</span> <span class="hljs-variable">testDomain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestDomain</span>();<br>        testDomain.setId(<span class="hljs-number">39L</span>);<br>        testDomain.setName(<span class="hljs-string">&quot;39&quot;</span>);<br>        Mockito.when(testMapper.save(testDomain)).thenReturn(<span class="hljs-number">1</span>);<br>        testService.save(testDomain);<br><br>        Mockito.when(testMapper.save(testDomain)).thenReturn(<span class="hljs-number">0</span>);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            testService.save(testDomain);<br>        &#125; <span class="hljs-keyword">catch</span> (RuntimeException e) &#123;<br>            Assert.assertEquals(<span class="hljs-string">&quot;插入失败&quot;</span>, e.getMessage());<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getById</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">TestDomain</span> <span class="hljs-variable">testDomain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestDomain</span>();<br>        testDomain.setId(<span class="hljs-number">39L</span>);<br>        testDomain.setName(<span class="hljs-string">&quot;39&quot;</span>);<br>        Mockito.when(testMapper.getById(<span class="hljs-number">39L</span>)).thenReturn(testDomain);<br>        <span class="hljs-type">TestDomain</span> <span class="hljs-variable">testDomain1</span> <span class="hljs-operator">=</span> testService.getById(<span class="hljs-number">39L</span>);<br>        Assert.assertEquals(testDomain, testDomain1);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="使用powermock"><a href="#使用powermock" class="headerlink" title="使用powermock"></a>使用powermock</h2><p>去掉mockito-core、junit依赖，在pom.xml中添加</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">powermock.version</span>&gt;</span>2.0.2<span class="hljs-tag">&lt;/<span class="hljs-name">powermock.version</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>   <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.powermock<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>powermock-module-junit4<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;powermock.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.powermock<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>powermock-api-mockito2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;powermock.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>因为powermock内已经依赖这两个包了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.junit.Assert;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.mockito.InjectMocks;<br><span class="hljs-keyword">import</span> org.mockito.Mock;<br><span class="hljs-keyword">import</span> org.mockito.Mockito;<br><span class="hljs-keyword">import</span> org.powermock.modules.junit4.PowerMockRunner;<br><br><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestServiceTest</span> &#123;<br><br>    <span class="hljs-meta">@InjectMocks</span><br>    <span class="hljs-keyword">private</span> TestService testService;<br><br>    <span class="hljs-meta">@Mock</span><br>    <span class="hljs-keyword">public</span> TestMapper testMapper;<br><br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method1</span><span class="hljs-params">()</span> &#123;<br>        Mockito.when(testMapper.getMax()).thenReturn(<span class="hljs-number">20L</span>);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> testService.method1();<br>        Assert.assertEquals(id, <span class="hljs-number">20L</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">TestDomain</span> <span class="hljs-variable">testDomain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestDomain</span>();<br>        testDomain.setId(<span class="hljs-number">39L</span>);<br>        testDomain.setName(<span class="hljs-string">&quot;39&quot;</span>);<br>        Mockito.when(testMapper.save(testDomain)).thenReturn(<span class="hljs-number">1</span>);<br>        testService.save(testDomain);<br><br>        Mockito.when(testMapper.save(testDomain)).thenReturn(<span class="hljs-number">0</span>);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            testService.save(testDomain);<br>        &#125; <span class="hljs-keyword">catch</span> (RuntimeException e) &#123;<br>            Assert.assertEquals(<span class="hljs-string">&quot;插入失败&quot;</span>, e.getMessage());<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getById</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">TestDomain</span> <span class="hljs-variable">testDomain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestDomain</span>();<br>        testDomain.setId(<span class="hljs-number">39L</span>);<br>        testDomain.setName(<span class="hljs-string">&quot;39&quot;</span>);<br>        Mockito.when(testMapper.getById(<span class="hljs-number">39L</span>)).thenReturn(testDomain);<br>        <span class="hljs-type">TestDomain</span> <span class="hljs-variable">testDomain1</span> <span class="hljs-operator">=</span> testService.getById(<span class="hljs-number">39L</span>);<br>        Assert.assertEquals(testDomain, testDomain1);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="spring-boot-与powermock整合"><a href="#spring-boot-与powermock整合" class="headerlink" title="spring boot 与powermock整合"></a>spring boot 与powermock整合</h2><p>因为spring boot的父pom中已经引入了mockito，所以要注意，如果运行时报类不存在问题，可以明确加入mockito及版本解决。</p><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><h3 id="org-mockito-Mockito"><a href="#org-mockito-Mockito" class="headerlink" title="org.mockito.Mockito"></a>org.mockito.Mockito</h3><p>org.mockito.Mockito是mockito提供的核心api，提供了大量的静态方法，用于帮助我们来mock对象，验证行为等等，然后需要注意的是，很多方法都被封装在了MockitoCore类里面，下面对一些常用的方法做一些介绍。</p><p>mock：构建一个我们需要的对象；可以mock具体的对象，也可以mock接口。<br>spy：构建监控对象<br>verify：验证某种行为<br>when：当执行什么操作的时候，一般配合thenXXX 一起使用。表示执行了一个操作之后产生什么效果。<br>doReturn：返回什么结果<br>doThrow：抛出一个指定异常<br>doAnswer：做一个什么相应，需要我们自定义Answer；<br>times：某个操作执行了多少次<br>atLeastOnce：某个操作至少执行一次<br>atLeast：某个操作至少执行指定次数<br>atMost：某个操作至多执行指定次数<br>atMostOnce：某个操作至多执行一次<br>doNothing：不做任何处理<br>doReturn：返回一个结果<br>doThrow：抛出一个指定异常<br>doAnswer：指定一个操作，传入Answer<br>doCallRealMethod：返回真实业务执行的结果，只能用于监控对象</p><h3 id="ArgumentMatchers"><a href="#ArgumentMatchers" class="headerlink" title="ArgumentMatchers"></a>ArgumentMatchers</h3><p>用于进行参数匹配，减少很多不必要的代码</p><p>anyInt：任何int类型的参数，类似的还有anyLong&#x2F;anyByte等等。<br>eq：等于某个值的时候，如果是对象类型的，则看toString方法<br>isA：匹配某种类型<br>matches：使用正则表达式进行匹配</p><h3 id="OngoingStubbing"><a href="#OngoingStubbing" class="headerlink" title="OngoingStubbing"></a>OngoingStubbing</h3><p>OngoingStubbing用于返回操作的结果。</p><p>thenReturn：指定一个返回的值<br>thenThrow：抛出一个指定异常<br>then：指定一个操作，需要传入自定义Answer；<br>thenCallRealMethod：返回真实业务执行的结果，只能用于监控对象。</p><h3 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h3><p>@RunWith<br>在测试类类名上添加 @RunWith(PowerMockRunner.class) 注解代表该测试类使用 PowerMock。必须添加。</p><p>@PrepareForTest</p><p>这个注解的作用就是告诉 PowerMock 哪些类是需要在字节码级别上进行操作的。也就是需要 mock 某些包含 final、static 等方法的类时使用，使用方法：@PrepareForTest({System.class, LogUtils.class})，在方法中有new对象的时候也需要在@PrepareForTest中声明。</p><p>@PowerMockIgnore</p><p>PowerMock 是使用自定义的类加载器来加载被修改过的类，从而达到打桩的目的。@PowerMockIgnore 注解告诉 PowerMock 忽略哪些包下的类，从而消除类加载器引入的 ClassCastException。使用方法：@PowerMockIgnore({“javax.management.”, “javax.net.ssl.”, “javax.script.*”})</p><p>@SuppressStaticInitializationFor</p><p>告诉 PowerMock 哪些包下的类需要被抑制静态初始化，包括 static 代码块或者 static 变量的初始化。防止因静态初始化导致的错误。使用方法：</p><p>@SuppressStaticInitializationFor({“com.xxx.SmsServiceImpl”})</p><p>@Mock</p><p>mock 待测类的普通属性，最常见的就是通过 Spring @Autowired 自动注入的 bean。这类属性并非 final，也并非 static，只需要在测试类中使用 @Mock 注解，Pwermock 框架就能自动生成 mock 对象，并自动注入到 @InjectMock 修饰的待测类中。<br>也可以使用比较通用的 mock() 方法，调用 mock(XXX.class)，能生成一个 mock 的 XXX 对象，然后通过反射获取待测类的字段，再将 mock 对象赋给字段。一般用于不是由 Spring @Autowired 注入的普通属性。</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议19HTTPDNS</title>
    <link href="/2023/07/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE19HTTPDNS/"/>
    <url>/2023/07/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE19HTTPDNS/</url>
    
    <content type="html"><![CDATA[<h1 id="传统DNS存在哪些问题？"><a href="#传统DNS存在哪些问题？" class="headerlink" title="传统DNS存在哪些问题？"></a>传统DNS存在哪些问题？</h1><h2 id="1-域名缓存问题"><a href="#1-域名缓存问题" class="headerlink" title="1.域名缓存问题"></a>1.域名缓存问题</h2><p>不是每一个请求，它都会去访问权威 DNS 服务器，而是访问过一次就把结果缓存到自己本地，当其他人来问的时候，直接就返回这个缓存数据。这时候缓存数据已经过期。</p><p>有的运营商会把一些静态页面，缓存到本运营商的服务器内，当页面更新，用户会访问到老的页面。</p><p>再就是本地的缓存，往往使得全局负载均衡失败，因为上次进行缓存的时候，缓存中的地址不一定是这次访问离客户最近的地方，如果把这个地址返回给客户，那肯定就会绕远路。</p><h2 id="2-域名转发问题"><a href="#2-域名转发问题" class="headerlink" title="2.域名转发问题"></a>2.域名转发问题</h2><p>如果是 A 运营商的客户，访问自己运营商的 DNS 服务器，如果 A 运营商去权威 DNS 服务器查询的话，权威 DNS 服务器知道你是 A 运营商的，就返回给一个部署在 A 运营商的网站地址，这样针对相同运营商的访问，速度就会快很多。</p><p>但是 A 运营商偷懒，将解析的请求转发给 B 运营商，B 运营商去权威 DNS 服务器查询的话，权威服务器会误认为，你是 B 运营商的，那就返回给你一个在 B 运营商的网站地址吧，结果客户的每次访问都要跨运营商，速度就会很慢。</p><h2 id="3-出口NAT问题"><a href="#3-出口NAT问题" class="headerlink" title="3.出口NAT问题"></a>3.出口NAT问题</h2><p>出口的时候，很多机房都会配置 NAT，也即网络地址转换，使得从这个网关出去的包，都换成新的 IP 地址，当然请求返回的时候，在这个网关，再将 IP 地址转换回去，所以对于访问来说是没有任何问题。</p><p>但是一旦做了网络地址的转换，权威的 DNS 服务器，就没办法通过这个地址，来判断客户到底是来自哪个运营商，而且极有可能因为转换过后的地址，误判运营商，导致跨运营商的访问。</p><h2 id="4-域名更新问题"><a href="#4-域名更新问题" class="headerlink" title="4.域名更新问题"></a>4.域名更新问题</h2><p>本地 DNS 服务器是由不同地区、不同运营商独立部署的。对域名解析缓存的处理上，实现策略也有区别，有的会偷懒，忽略域名解析结果的 TTL 时间限制，在权威 DNS 服务器解析变更的时候，解析结果在全网生效的周期非常漫长。但是有的时候，在 DNS 的切换中，场景对生效时间要求比较高。</p><p>例如双机房部署的时候，跨机房的负载均衡和容灾多使用 DNS 来做。当一个机房出问题之后，需要修改权威 DNS，将域名指向新的 IP 地址，但是如果更新太慢，那很多用户都会出现访问异常。</p><h2 id="5-解析延迟问题"><a href="#5-解析延迟问题" class="headerlink" title="5.解析延迟问题"></a>5.解析延迟问题</h2><p>DNS 的查询过程需要递归遍历多个 DNS 服务器，才能获得最终的解析结果，这会带来一定的时延，甚至会解析超时。</p><h1 id="HTTPDNS的工作模式"><a href="#HTTPDNS的工作模式" class="headerlink" title="HTTPDNS的工作模式"></a>HTTPDNS的工作模式</h1><p>HttpDNS 其实就是，不走传统的 DNS 解析，而是自己搭建基于 HTTP 协议的 DNS 服务器集群，分布在多个地点和多个运营商。当客户端需要 DNS 解析的时候，直接通过 HTTP 协议进行请求这个服务器集群，得到就近的地址。</p><p>在客户端的 SDK 里动态请求服务端，获取 HttpDNS 服务器的 IP 列表，缓存到本地。随着不断地解析域名，SDK 也会在本地缓存 DNS 域名解析的结果。</p><p>当手机应用要访问一个地址的时候，首先看是否有本地的缓存，如果有就直接返回。这个缓存和本地 DNS 的缓存不一样的是，这个是手机应用自己做的，而非整个运营商统一做的。如何更新、何时更新，手机应用的客户端可以和服务器协调来做这件事情。</p><p>如果本地没有，就需要请求 HttpDNS 的服务器，在本地 HttpDNS 服务器的 IP 列表中，选择一个发出 HTTP 的请求，会返回一个要访问的网站的 IP 列表。</p><p>手机客户端自然知道手机在哪个运营商、哪个地址。由于是直接的 HTTP 通信，HttpDNS 服务器能够准确知道这些信息，因而可以做精准的全局负载均衡。</p><p><img src="/.com//HTTPDNS%E6%B5%81%E7%A8%8B.webp"></p><p>其实归结起来就是两大问题。一是解析速度和更新速度的平衡问题，二是智能调度的问题，对应的解决方案是 HttpDNS 的缓存设计和调度设计。</p><h2 id="HttpDNS-的缓存设计"><a href="#HttpDNS-的缓存设计" class="headerlink" title="HttpDNS 的缓存设计"></a>HttpDNS 的缓存设计</h2><p>解析 DNS 过程复杂，通信次数多，对解析速度造成很大影响。为了加快解析，因而有了缓存，但是这又会产生缓存更新速度不及时的问题。最要命的是，这两个方面都掌握在别人手中，也即本地 DNS 服务器手中，它不会为你定制，你作为客户端干着急没办法。</p><p>而 HttpDNS 就是将解析速度和更新速度全部掌控在自己手中。一方面，解析的过程，不需要本地 DNS 服务递归的调用一大圈，一个 HTTP 的请求直接搞定，要实时更新的时候，马上就能起作用；另一方面为了提高解析速度，本地也有缓存，缓存是在客户端 SDK 维护的，过期时间、更新时间，都可以自己控制。</p><p>HttpDNS 的缓存设计策略也是咱们做应用架构中常用的缓存设计模式，也即分为客户端、缓存、数据源三层。</p><p>对于 HttpDNS 来讲，就是手机客户端、DNS 缓存、HttpDNS 服务器。</p><p>只要是缓存模式，就存在缓存的过期、更新、不一致的问题，解决思路也是很像的。</p><p>SDK 中的缓存会严格按照缓存过期时间，如果缓存没有命中，或者已经过期，而且客户端不允许使用过期的记录，则会发起一次解析，保障记录是更新的。</p><p>解析可以同步进行，也就是直接调用 HttpDNS 的接口，返回最新的记录，更新缓存；也可以异步进行，添加一个解析任务到后台，由后台任务调用 HttpDNS 的接口。</p><p>同步更新的优点是实时性好，缺点是如果有多个请求都发现过期的时候，同时会请求 HttpDNS 多次，其实是一种浪费。</p><p>同步更新的方式对应到应用架构中缓存的 Cache-Aside 机制，也即先读缓存，不命中读数据库，同时将结果写入缓存。</p><p>异步更新的优点是，可以将多个请求都发现过期的情况，合并为一个对于 HttpDNS 的请求任务，只执行一次，减少 HttpDNS 的压力。同时可以在即将过期的时候，就创建一个任务进行预加载，防止过期之后再刷新，称为预加载。</p><p>它的缺点是当前请求拿到过期数据的时候，如果客户端允许使用过期数据，需要冒一次风险。如果过期的数据还能请求，就没问题；如果不能请求，则失败一次，等下次缓存更新后，再请求方能成功。</p><p>异步更新的机制对应到应用架构中缓存的 Refresh-Ahead 机制，即业务仅仅访问缓存，当过期的时候定期刷新。在著名的应用缓存 Guava Cache 中，有个 RefreshAfterWrite 机制，对于并发情况下，多个缓存访问不命中从而引发并发回源的情况，可以采取只有一个请求回源的模式。在应用架构的缓存中，也常常用数据预热或者预加载的机制。</p><h2 id="HttpDNS-的调度设计"><a href="#HttpDNS-的调度设计" class="headerlink" title="HttpDNS 的调度设计"></a>HttpDNS 的调度设计</h2><p>由于客户端嵌入了 SDK，因而就不会因为本地 DNS 的各种缓存、转发、NAT，让权威 DNS 服务器误会客户端所在的位置和运营商，而可以拿到第一手资料。</p><p>在客户端，可以知道手机是哪个国家、哪个运营商、哪个省，甚至哪个市，HttpDNS 服务端可以根据这些信息，选择最佳的服务节点访问。</p><p>如果有多个节点，还会考虑错误率、请求时间、服务器压力、网络状况等，进行综合选择，而非仅仅考虑地理位置。当有一个节点宕机或者性能下降的时候，可以尽快进行切换。</p><p>要做到这一点，需要客户端使用 HttpDNS 返回的 IP 访问业务应用。客户端的 SDK 会收集网络请求数据，如错误率、请求时间等网络请求质量数据，并发送到统计后台，进行分析、聚合，以此查看不同的 IP 的服务质量。</p><p>在服务端，应用可以通过调用 HttpDNS 的管理接口，配置不同服务质量的优先级、权重。HttpDNS 会根据这些策略综合地理位置和线路状况算出一个排序，优先访问当前那些优质的、时延低的 IP 地址。</p><p>HttpDNS 通过智能调度之后返回的结果，也会缓存在客户端。为了不让缓存使得调度失真，客户端可以根据不同的移动网络运营商 WIFI 的 SSID 来分维度缓存。不同的运营商或者 WIFI 解析出来的结果会不同。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议20CDN</title>
    <link href="/2023/07/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE20CDN/"/>
    <url>/2023/07/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE20CDN/</url>
    
    <content type="html"><![CDATA[<h1 id="CDN"><a href="#CDN" class="headerlink" title="CDN"></a>CDN</h1><p>全球有这么多的数据中心，无论在哪里上网，临近不远的地方基本上都有数据中心。是不是可以在这些数据中心里部署几台机器，形成一个缓存的集群来缓存部分数据，那么用户访问数据的时候，就可以就近访问了。</p><p>这些分布在各个地方的各个数据中心的节点，就称为边缘节点。</p><p>由于边缘节点数目比较多，但是每个集群规模比较小，不可能缓存下来所有东西，因而可能无法命中，这样就会在边缘节点之上。有区域节点，规模就要更大，缓存的数据会更多，命中的概率也就更大。在区域节点之上是中心节点，规模更大，缓存数据更多。如果还不命中，就只好回源网站访问了。</p><p>这就是 CDN 分发系统的架构。</p><h2 id="CDN访问流程"><a href="#CDN访问流程" class="headerlink" title="CDN访问流程"></a>CDN访问流程</h2><p><img src="/.com//CDN%E8%AE%BF%E9%97%AE%E6%B5%81%E7%A8%8B.webp"></p><p>在没有 CDN 的情况下，用户向浏览器输入 <a href="http://www.web.com/">www.web.com</a> 这个域名，客户端访问本地 DNS 服务器的时候，如果本地 DNS 服务器有缓存，则返回网站的地址；如果没有，递归查询到网站的权威 DNS 服务器，这个权威 DNS 服务器是负责 web.com 的，它会返回网站的 IP 地址。本地 DNS 服务器缓存下 IP 地址，将 IP 地址返回，然后客户端直接访问这个 IP 地址，就访问到了这个网站。</p><p>然而有了 CDN 之后，情况发生了变化。在 web.com 这个权威 DNS 服务器上，会设置一个 CNAME 别名，指向另外一个域名 <a href="http://www.web.cdn.com,返回给本地/">www.web.cdn.com，返回给本地</a> DNS 服务器。</p><p>当本地 DNS 服务器拿到这个新的域名时，需要继续解析这个新的域名。这个时候，再访问的就不是 web.com 的权威 DNS 服务器了，而是 web.cdn.com 的权威 DNS 服务器，这是 CDN 自己的权威 DNS 服务器。在这个服务器上，还是会设置一个 CNAME，指向另外一个域名，也即 CDN 网络的全局负载均衡器。</p><p>接下来，本地 DNS 服务器去请求 CDN 的全局负载均衡器解析域名，全局负载均衡器会为用户选择一台合适的缓存服务器提供服务，选择的依据包括：</p><p>1.根据用户 IP 地址，判断哪一台服务器距用户最近；</p><p>2.用户所处的运营商；</p><p>3.根据用户所请求的 URL 中携带的内容名称，判断哪一台服务器上有用户所需的内容；</p><p>4.查询各个服务器当前的负载情况，判断哪一台服务器尚有服务能力。</p><p>基于以上这些条件，进行综合分析之后，全局负载均衡器会返回一台缓存服务器的 IP 地址。</p><p>本地 DNS 服务器缓存这个 IP 地址，然后将 IP 返回给客户端，客户端去访问这个边缘节点，下载资源。缓存服务器响应用户请求，将用户所需内容传送到用户终端。如果这台缓存服务器上并没有用户想要的内容，那么这台服务器就要向它的上一级缓存服务器请求内容，直至追溯到网站的源服务器将内容拉到本地。</p><h2 id="CDN缓存的内容"><a href="#CDN缓存的内容" class="headerlink" title="CDN缓存的内容"></a>CDN缓存的内容</h2><h3 id="静态页面、图片等"><a href="#静态页面、图片等" class="headerlink" title="静态页面、图片等"></a>静态页面、图片等</h3><p>在进入数据中心的时候，我们希望通过最外层接入层的缓存，将大部分静态资源的访问拦在边缘。而 CDN 则更进一步，将这些静态资源缓存到离用户更近的数据中心。越接近客户，访问性能越好，时延越低。</p><h3 id="流媒体"><a href="#流媒体" class="headerlink" title="流媒体"></a>流媒体</h3><p>CDN 支持流媒体协议，例如前面讲过的 RTMP 协议。在很多情况下，这相当于一个代理，从上一级缓存读取内容，转发给用户。由于流媒体往往是连续的，因而可以进行预先缓存的策略，也可以预先推送到用户的客户端。</p><p>对于静态页面来讲，内容的分发往往采取拉取的方式，也即当发现未命中的时候，再去上一级进行拉取。但是，流媒体数据量大，如果出现回源，压力会比较大，所以往往采取主动推送的模式，将热点数据主动推送到边缘节点。</p><p>对于流媒体来讲，很多 CDN 还提供预处理服务，也即文件在分发之前，经过一定的处理。例如将视频转换为不同的码流，以适应不同的网络带宽的用户需求；再如对视频进行分片，降低存储压力，也使得客户端可以选择使用不同的码率加载不同的分片。这就是我们常见的，“我要看超清、标清、流畅等”。</p><h4 id="防盗链"><a href="#防盗链" class="headerlink" title="防盗链"></a>防盗链</h4><p>对于流媒体 CDN 来讲，有个关键的问题是防盗链问题。因为视频是要花大价钱买版权的，为了挣点钱，收点广告费，如果流媒体被其他的网站盗走，在人家的网站播放，那损失可就大了。</p><p>最常用也最简单的方法就是 HTTP 头的 referer 字段， 当浏览器发送请求的时候，一般会带上 referer，告诉服务器是从哪个页面链接过来的，服务器基于此可以获得一些信息用于处理。如果 refer 信息不是来自本站，就阻止访问或者跳到其它链接。</p><p>referer 的机制相对比较容易破解，所以还需要配合其他的机制。</p><p>一种常用的机制是时间戳防盗链。使用 CDN 的管理员可以在配置界面上，和 CDN 厂商约定一个加密字符串。</p><p>客户端取出当前的时间戳，要访问的资源及其路径，连同加密字符串进行签名算法得到一个字符串，然后生成一个下载链接，带上这个签名字符串和截止时间戳去访问 CDN。</p><p>在 CDN 服务端，根据取出过期时间，和当前 CDN 节点时间进行比较，确认请求是否过期。然后 CDN 服务端有了资源及路径，时间戳，以及约定的加密字符串，根据相同的签名算法计算签名，如果匹配则一致，访问合法，才会将资源返回给客户。</p><h3 id="动态的数据"><a href="#动态的数据" class="headerlink" title="动态的数据"></a>动态的数据</h3><p>动态 CDN，主要有两种模式。</p><p>边缘计算的模式。既然数据是动态生成的，所以数据的逻辑计算和存储，也相应的放在边缘的节点。其中定时从源数据那里同步存储的数据，然后在边缘进行计算得到结果。就像对生鲜的烹饪是动态的，没办法事先做好缓存，因而将生鲜超市放在你家旁边，既能够送货上门，也能够现场烹饪，也是边缘计算的一种体现。</p><p>路径优化的模式。数据不是在边缘计算生成的，而是在源站生成的，但是数据的下发则可以通过 CDN 的网络，对路径进行优化。因为 CDN 节点较多，能够找到离源站很近的边缘节点，也能找到离用户很近的边缘节点。中间的链路完全由 CDN 来规划，选择一个更加可靠的路径，使用类似专线的方式进行访问。</p><h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><p>对于常用的 TCP 连接，在公网上传输的时候经常会丢数据，导致 TCP 的窗口始终很小，发送速度上不去。根据前面的 TCP 流量控制和拥塞控制的原理，在 CDN 加速网络中可以调整 TCP 的参数，使得 TCP 可以更加激进地传输数据。</p><p>可以通过多个请求复用一个连接，保证每次动态请求到达时。连接都已经建立了，不必临时三次握手或者建立过多的连接，增加服务器的压力。另外，可以通过对传输数据进行压缩，增加传输效率。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议21数据中心</title>
    <link href="/2023/07/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE21%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%BF%83/"/>
    <url>/2023/07/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE21%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%BF%83/</url>
    
    <content type="html"><![CDATA[<h1 id="数据中心"><a href="#数据中心" class="headerlink" title="数据中心"></a>数据中心</h1><p>数据中心里面也有一大堆的电脑，数据中心里面是服务器。服务器被放在一个个叫作机架（Rack）的架子上面。</p><p>数据中心的入口和出口也是路由器，由于在数据中心的边界，就像在一个国家的边境，称为边界路由器（Border Router）。为了高可用，边界路由器会有多个。</p><p>数据中心的边界路由器会连接多个运营商网络。</p><p>既然是路由器，就需要跑路由协议，数据中心往往就是路由协议中的自治区域（AS）。数据中心里面的机器要想访问外面的网站，数据中心里面也是有对外提供服务的机器，都可以通过 BGP 协议，获取内外互通的路由信息。这就是我们常听到的多线 BGP 的概念。</p><h2 id="基础架构"><a href="#基础架构" class="headerlink" title="基础架构"></a>基础架构</h2><p><img src="/.com//%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%BF%83%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84.webp"></p><p>数据中心里面往往有非常多的机器，当塞满一机架的时候，需要有交换机将这些服务器连接起来，可以互相通信。</p><p>这些交换机往往是放在机架顶端的，所以经常称为 TOR（Top Of  Rack）交换机。</p><p>这一层的交换机常常称为接入层（Access Layer）。</p><p>当一个机架放不下的时候，就需要多个机架，还需要有交换机将多个机架连接在一起。这些交换机对性能的要求更高，带宽也更大。这些交换机称为汇聚层交换机（Aggregation Layer）。</p><p>数据中心里面的每一个连接都是需要考虑高可用的。这里首先要考虑的是，如果一台机器只有一个网卡，上面连着一个网线，接入到 TOR 交换机上。如果网卡坏了，或者不小心网线掉了，机器就上不去了。所以，需要至少两个网卡、两个网线插到 TOR 交换机上，但是两个网卡要工作得像一张网卡一样，这就是常说的网卡绑定（bond）。</p><p>这就需要服务器和交换机都支持一种协议 LACP（Link Aggregation Control Protocol）。它们互相通信，将多个网卡聚合称为一个网卡，多个网线聚合成一个网线，在网线之间可以进行负载均衡，也可以为了高可用作准备。</p><p>网卡有了高可用保证，但交换机还有问题。如果一个机架只有一个交换机，它挂了，那整个机架都不能上网了。因而 TOR 交换机也需要高可用，同理接入层和汇聚层的连接也需要高可用性，也不能单线连着。</p><p>最传统的方法是，部署两个接入交换机、两个汇聚交换机。服务器和两个接入交换机都连接，接入交换机和两个汇聚都连接，当然这样会形成环，所以需要启用 STP 协议，去除环，但是这样两个汇聚就只能一主一备了。STP 协议里我们学过，只有一条路会起作用。</p><p>交换机有一种技术叫作堆叠，所以另一种方法是，将多个交换机形成一个逻辑的交换机，服务器通过多根线分配连到多个接入层交换机上，而接入层交换机多根线分别连接到多个交换机上，并且通过堆叠的私有协议，形成双活的连接方式。</p><p>由于对带宽要求更大，而且挂了影响也更大，所以两个堆叠可能就不够了，可以就会有更多的，比如四个堆叠为一个逻辑的交换机。</p><p>汇聚层将大量的计算节点相互连接在一起，形成一个集群。在这个集群里面，服务器之间通过二层互通，这个区域常称为一个 POD（Point Of Delivery），有时候也称为一个可用区（Available Zone）。</p><p>当节点数目再多的时候，一个可用区放不下，需要将多个可用区连在一起，连接多个可用区的交换机称为核心交换机。</p><p>核心交换机吞吐量更大，高可用要求更高，肯定需要堆叠，但是往往仅仅堆叠，不足以满足吞吐量，因而还是需要部署多组核心交换机。核心和汇聚交换机之间为了高可用，也是全互连模式的。</p><p>这个时候还存在一个问题，出现环路怎么办？</p><p>一种方式是，不同的可用区在不同的二层网络，需要分配不同的网段。汇聚和核心之间通过三层网络互通的，二层都不在一个广播域里面，不会存在二层环路的问题。三层有环是没有问题的，只要通过路由协议选择最佳的路径就可以了。那为啥二层不能有环路，而三层可以呢？你可以回忆一下二层环路的情况。</p><p>核心层和汇聚层之间通过内部的路由协议 OSPF，找到最佳的路径进行访问，而且还可以通过 ECMP 等价路由，在多个路径之间进行负载均衡和高可用。</p><p>但是随着数据中心里面的机器越来越多，尤其是有了云计算、大数据，集群规模非常大，而且都要求在一个二层网络里面。这就需要二层互连从汇聚层上升为核心层，也即在核心以下，全部是二层互连，全部在一个广播域里面，这就是常说的大二层。</p><p>如果大二层横向流量不大，核心交换机数目不多，可以做堆叠，但是如果横向流量很大，仅仅堆叠满足不了，就需要部署多组核心交换机，而且要和汇聚层进行全互连。由于堆叠只解决一个核心交换机组内的无环问题，而组之间全互连，还需要其他机制进行解决。</p><p>如果是 STP，那部署多组核心无法扩大横向流量的能力，因为还是只有一组起作用。</p><p>于是大二层就引入了 TRILL（Transparent Interconnection of Lots of Link），即多链接透明互联协议。它的基本思想是，二层环有问题，三层环没有问题，那就把三层的路由能力模拟在二层实现。</p><p>运行 TRILL 协议的交换机称为 RBridge，是具有路由转发特性的网桥设备，只不过这个路由是根据 MAC 地址来的，不是根据 IP 来的。</p><p>Rbridage 之间通过链路状态协议运作。记得这个路由协议吗？通过它可以学习整个大二层的拓扑，知道访问哪个 MAC 应该从哪个网桥走；还可以计算最短的路径，也可以通过等价的路由进行负载均衡和高可用性。</p><p>TRILL 协议在原来的 MAC 头外面加上自己的头，以及外层的 MAC 头。TRILL 头里面的 Ingress RBridge，有点像 IP 头里面的源 IP 地址，Egress RBridge 是目标 IP 地址，这两个地址是端到端的，在中间路由的时候，不会发生改变。而外层的 MAC，可以有下一跳的 Bridge，就像路由的下一跳，也是通过 MAC 地址来呈现的一样。</p><p>有一个包要从主机 A 发送到主机 B，中间要经过 RBridge 1、RBridge 2、RBridge X 等等，直到 RBridge 3。在 RBridge 2 收到的包里面，分内外两层，内层就是传统的主机 A 和主机 B 的 MAC 地址以及内层的 VLAN。</p><p>在外层首先加上一个 TRILL 头，里面描述这个包从 RBridge 1 进来的，要从 RBridge 3 出去，并且像三层的 IP 地址一样有跳数。然后再外面，目的 MAC 是 RBridge 2，源 MAC 是 RBridge 1，以及外层的 VLAN。</p><p>当 RBridge 2 收到这个包之后，首先看 MAC 是否是自己的 MAC，如果是，要看自己是不是 Egress RBridge，也即是不是最后一跳；如果不是，查看跳数是不是大于 0，然后通过类似路由查找的方式找到下一跳 RBridge X，然后将包发出去。</p><p>RBridge 2 发出去的包，内层的信息是不变的，外层的 TRILL 头里面。同样，描述这个包从 RBridge 1 进来的，要从 RBridge 3 出去，但是跳数要减 1。外层的目标 MAC 变成 RBridge X，源 MAC 变成 RBridge 2。</p><p>如此一直转发，直到 RBridge 3，将外层解出来，发送内层的包给主机 B。</p><p>对于大二层的广播包，也需要通过分发树的技术来实现。我们知道 STP 是将一个有环的图，通过去掉边形成一棵树，而分发树是一个有环的图形成多棵树，不同的树有不同的 VLAN，有的广播包从 VLAN A 广播，有的从 VLAN B 广播，实现负载均衡和高可用。</p><p>核心交换机之外，就是边界路由器了。至此从服务器到数据中心边界的层次情况已经清楚了。</p><p>在核心交换上面，往往会挂一些安全设备，例如入侵检测、DDoS 防护等等。这是整个数据中心的屏障，防止来自外来的攻击。核心交换机上往往还有负载均衡器，原理前面的章节已经说过了。</p><p>在有的数据中心里面，对于存储设备，还会有一个存储网络，用来连接 SAN 和 NAS。但是对于新的云计算来讲，往往不使用传统的 SAN 和 NAS，而使用部署在 x86 机器上的软件定义存储，这样存储也是服务器了，而且可以和计算节点融合在一个机架上，从而更加有效率，也就没有了单独的存储网络了。</p><p><img src="/.com//%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%BF%83%E7%BD%91%E7%BB%9C%E5%9B%BE.webp"></p><p>这是一个典型的三层网络结构。这里的三层不是指 IP 层，而是指接入层、汇聚层、核心层三层。这种模式非常有利于外部流量请求到内部应用。这个类型的流量，是从外到内或者从内到外，对应到上面那张图里，就是从上到下，从下到上，上北下南，所以称为南北流量。</p><p>但是随着云计算和大数据的发展，节点之间的交互越来越多，例如大数据计算经常要在不同的节点将数据拷贝来拷贝去，这样需要经过交换机，使得数据从左到右，从右到左，左西右东，所以称为东西流量。</p><p>为了解决东西流量的问题，演进出了叶脊网络（Spine&#x2F;Leaf）。</p><p>叶子交换机（leaf），直接连接物理服务器。L2&#x2F;L3 网络的分界点在叶子交换机上，叶子交换机之上是三层网络。</p><p>脊交换机（spine switch），相当于核心交换机。叶脊之间通过 ECMP 动态选择多条路径。脊交换机现在只是为叶子交换机提供一个弹性的 L3 路由网络。南北流量可以不用直接从脊交换机发出，而是通过与 leaf 交换机并行的交换机，再接到边界路由器出去。</p><p>传统的三层网络架构是垂直的结构，而叶脊网络架构是扁平的结构，更易于水平扩展。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议18DNS</title>
    <link href="/2023/07/14/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE18DNS/"/>
    <url>/2023/07/14/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE18DNS/</url>
    
    <content type="html"><![CDATA[<h1 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h1><p>根据前面的学习，互联网上访问是要用IP的。但是用IP非常的不容易记。所以就出现了用域名来访问。域名转换为IP过程叫做域名解析。</p><p>做转换工作的服务器是DNS服务器。</p><p>DNS 服务器，一定要设置成高可用、高并发和分布式的。</p><p>DNS层级结构：</p><p><img src="/.com//DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B1%82%E7%BA%A7%E7%BB%93%E6%9E%84.webp"></p><p>根 DNS 服务器 ：返回顶级域 DNS 服务器的 IP 地址</p><p>顶级域 DNS 服务器：返回权威 DNS 服务器的 IP 地址</p><p>权威 DNS 服务器 ：返回相应主机的 IP 地址</p><h2 id="DNS-解析流程"><a href="#DNS-解析流程" class="headerlink" title="DNS 解析流程"></a>DNS 解析流程</h2><p><img src="/.com//DNS%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B.webp"></p><p>本地域名服务器 (本地 DNS)  ：  如果是通过 DHCP 配置，本地 DNS 由你的网络服务商（ISP），如电信、移动等自动分配，它通常就在你网络服务商的某个机房。</p><p>1.电脑客户端会发出一个 DNS 请求，问 <a href="http://www.163.com/">www.163.com</a> 的 IP 是啥</p><p>2.本地 DNS 收到来自客户端的请求。你可以想象这台服务器上缓存了一张域名与之对应 IP 地址的大表格。如果能找到 <a href="http://www.163.com,它就直接返回/">www.163.com，它就直接返回</a> IP 地址。如果没有，本地 DNS 会去问它的根域名服务器：“老大，能告诉我 <a href="http://www.163.com/">www.163.com</a> 的 IP 地址吗？”根域名服务器是最高层次的，全球共有 13 套。它不直接用于域名解析，但能指明一条道路。</p><p>3.根 DNS 收到来自本地 DNS 的请求，发现后缀是 .com，说：“哦，<a href="http://www.163.com/">www.163.com</a> 啊，这个域名是由.com 区域管理，我给你它的顶级域名服务器的地址，你去问问它吧。”</p><p>4.本地 DNS 转向问顶级域名服务器：“老二，你能告诉我 <a href="http://www.163.com/">www.163.com</a> 的 IP 地址吗？”顶级域名服务器就是大名鼎鼎的比如 .com、.net、 .org 这些一级域名，它负责管理二级域名，比如 163.com，所以它能提供一条更清晰的方向。</p><p>5.顶级域名服务器说：“我给你负责 <a href="http://www.163.com/">www.163.com</a> 区域的权威 DNS 服务器的地址，你去问它应该能问到。”</p><p>6.本地 DNS 转向问权威 DNS 服务器：“您好，<a href="http://www.163.com/">www.163.com</a> 对应的 IP 是啥呀？”163.com 的权威 DNS 服务器，它是域名解析结果的原出处。为啥叫权威呢？就是我的域名我做主。</p><p>7.权威 DNS 服务器查询后将对应的 IP 地址 X.X.X.X 告诉本地 DNS。</p><p>8.本地 DNS 再将 IP 地址返回客户端，客户端和目标建立连接。</p><h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><h3 id="内部负载均衡"><a href="#内部负载均衡" class="headerlink" title="内部负载均衡"></a>内部负载均衡</h3><p>可以把域名解析到两个IP地址，只要配置策略，这次返回第一个IP,下次返回第二个IP,就可以实现负载均衡。</p><h3 id="全局负载均衡"><a href="#全局负载均衡" class="headerlink" title="全局负载均衡"></a>全局负载均衡</h3><p>为了保证我们的应用高可用，往往会部署在多个机房，每个地方都会有自己的 IP 地址。当用户访问某个域名的时候，这个 IP 地址可以轮询访问多个数据中心。如果一个数据中心因为某种原因挂了，只要在 DNS 服务器里面，将这个数据中心对应的 IP 地址删除，就可以实现一定的高可用。</p><p>另外，我们肯定希望北京的用户访问北京的数据中心，上海的用户访问上海的数据中心，这样，客户体验就会非常好，访问速度就会超快。这就是全局负载均衡的概念。</p><h4 id="全局负载均衡器"><a href="#全局负载均衡器" class="headerlink" title="全局负载均衡器"></a>全局负载均衡器</h4><p>对于不需要做全局负载均衡的简单应用来讲，yourcompany.com 的权威 DNS 服务器可以直接将 object.yourcompany.com 这个域名解析为一个或者多个 IP 地址，然后客户端可以通过多个 IP 地址，进行简单的轮询，实现简单的负载均衡。</p><p>但是对于复杂的应用，尤其是跨地域跨运营商的大型应用，则需要更加复杂的全局负载均衡机制，因而需要专门的设备或者服务器来做这件事情，这就是全局负载均衡器（GSLB，Global Server Load Balance）。</p><h4 id="示例：DNS-访问数据中心中对象存储上的静态资源"><a href="#示例：DNS-访问数据中心中对象存储上的静态资源" class="headerlink" title="示例：DNS 访问数据中心中对象存储上的静态资源"></a>示例：DNS 访问数据中心中对象存储上的静态资源</h4><p>假设全国有多个数据中心，托管在多个运营商，每个数据中心三个可用区（Available Zone）。对象存储通过跨可用区部署，实现高可用性。在每个数据中心中，都至少部署两个内部负载均衡器，内部负载均衡器后面对接多个对象存储的前置服务器（Proxy-server）。</p><p><img src="/.com//DNS%E7%A4%BA%E4%BE%8B.webp"></p><p>1.当一个客户端要访问 object.yourcompany.com 的时候，需要将域名转换为 IP 地址进行访问，所以它要请求本地 DNS 解析器。</p><p>2.本地 DNS 解析器先查看看本地的缓存是否有这个记录。如果有则直接使用，因为上面的过程太复杂了，如果每次都要递归解析，就太麻烦了。</p><p>3.如果本地无缓存，则需要请求本地的 DNS 服务器。</p><p>4.本地的 DNS 服务器一般部署在你的数据中心或者你所在的运营商的网络中，本地 DNS 服务器也需要看本地是否有缓存，如果有则返回，因为它也不想把上面的递归过程再走一遍。</p><p>5.至 7. 如果本地没有，本地 DNS 才需要递归地从根 DNS 服务器，查到.com 的顶级域名服务器，最终查到 yourcompany.com 的权威 DNS 服务器，给本地 DNS 服务器，权威 DNS 服务器按说会返回真实要访问的 IP 地址。</p><figure class="highlight stylus"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><pre><code class="hljs stylus">在 yourcompany<span class="hljs-selector-class">.com</span> 的 DNS 服务器中，一般是通过配置 CNAME 的方式，给 <span class="hljs-selector-tag">object</span><span class="hljs-selector-class">.yourcompany</span><span class="hljs-selector-class">.com</span> 起一个别名，例如 <span class="hljs-selector-tag">object</span><span class="hljs-selector-class">.vip</span><span class="hljs-selector-class">.yourcomany</span>.com，然后告诉本地 DNS 服务器，让它请求 GSLB 解析这个域名，GSLB 就可以在解析这个域名的过程中，通过自己的策略实现负载均衡。<br><br>图中画了两层的 GSLB，是因为分运营商和地域。我们希望不同运营商的客户，可以访问相同运营商机房中的资源，这样不跨运营商访问，有利于提高吞吐量，减少时延。<br></code></pre></td></tr></table></figure><p>8.第一层 GSLB，通过查看请求它的本地 DNS 服务器所在的运营商，就知道用户所在的运营商。假设是移动，通过 CNAME 的方式，通过另一个别名 object.yd.yourcompany.com，告诉本地 DNS 服务器去请求第二层的 GSLB。</p><p>9.第二层 GSLB，通过查看请求它的本地 DNS 服务器所在的地址，就知道用户所在的地理位置，然后将距离用户位置比较近的 Region 里面，六个内部负载均衡（SLB，Server Load Balancer）的地址，返回给本地 DNS 服务器。</p><p>10.本地 DNS 服务器将结果返回给本地 DNS 解析器。</p><p>11.本地 DNS 解析器将结果缓存后，返回给客户端。</p><p>12.客户端开始访问属于相同运营商的距离较近的 Region 1 中的对象存储，当然客户端得到了六个 IP 地址，它可以通过负载均衡的方式，随机或者轮询选择一个可用区进行访问。对象存储一般会有三个备份，从而可以实现对存储读写的负载均衡。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议16流媒体协议</title>
    <link href="/2023/07/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE16%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/"/>
    <url>/2023/07/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE16%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="流媒体协议"><a href="#流媒体协议" class="headerlink" title="流媒体协议"></a>流媒体协议</h1><p>视频其实就是快速播放一连串连续的图片。</p><p>每一张图片，我们称为一帧。只要每秒钟帧的数据足够多，也即播放得足够快。比如每秒 30 帧，以人的眼睛的敏感程度，是看不出这是一张张独立的图片的，这就是我们常说的帧率（FPS）。</p><p>每一张图片，都是由像素组成的，假设为 1024*768（这个像素数不算多）。每个像素由 RGB 组成，每个 8 位，共 24 位。</p><p>我们来算一下，每秒钟的视频有多大？30 帧 × 1024 × 768 × 24 &#x3D; 566,231,040Bits &#x3D; 70,778,880Bytes如果一分钟呢？4,246,732,800Bytes，已经是 4 个 G 了。</p><p>这个数据量实在是太大，根本没办法存储和传输。</p><h2 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h2><p>人们想到了编码，编码是一个压缩的过程。</p><p>1.空间冗余：图像的相邻像素之间有较强的相关性，一张图片相邻像素往往是渐变的，不是突变的，没必要每个像素都完整地保存，可以隔几个保存一个，中间的用算法计算出来。</p><p>2.时间冗余：视频序列的相邻图像之间内容相似。一个视频中连续出现的图片也不是突变的，可以根据已有的图片进行预测和推断。</p><p>3.视觉冗余：人的视觉系统对某些细节不敏感，因此不会每一个细节都注意到，可以允许丢失一些数据。</p><p>4.编码冗余：不同像素值出现的概率不同，概率高的用的字节少，概率低的用的字节多，类似霍夫曼编码（Huffman Coding）的思路。</p><p> <img src="/.com//%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81%E8%BF%87%E7%A8%8B.webp"></p><h3 id="视频编码的两大流派"><a href="#视频编码的两大流派" class="headerlink" title="视频编码的两大流派"></a>视频编码的两大流派</h3><p>流派一：ITU（International Telecommunications Union）的 VCEG（Video Coding Experts Group），这个称为国际电联下的 VCEG。他们最初做视频编码，主要侧重传输。标准有H.261、 H.262、H.263、H.264、H.265。</p><p>流派二：ISO（International Standards Organization）的 MPEG（Moving Picture Experts Group），这个是 ISO 旗下的 MPEG，本来是做视频存储的。标准有：MPEG-1、MPEG-2、MPEG-4、MPEG-7。</p><p>后来，ITU-T（国际电信联盟电信标准化部门，ITU Telecommunication Standardization Sector）与 MPEG 联合制定了 H.264&#x2F;MPEG-4 AVC。</p><p>经过编码之后，生动活泼的一帧一帧的图像，就变成了一串串让人看不懂的二进制，这个二进制可以放在一个文件里面，按照一定的格式保存起来，格式有：</p><p>AVI、MPEG、RMVB、MP4、MOV、FLV、WebM、WMV、ASF、MKV。</p><h2 id="直播流程"><a href="#直播流程" class="headerlink" title="直播流程"></a>直播流程</h2><p>网络协议将编码好的视频流，从主播端推送到服务器，在服务器上有个运行了同样协议的服务端来接收这些网络包，从而得到里面的视频流，这个过程称为接流。</p><p>服务端接到视频流之后，可以对视频流进行一定的处理，例如转码，也即从一个编码格式，转成另一种格式。因为观众使用的客户端千差万别，要保证他们都能看到直播。</p><p>流处理完毕之后，就可以等待观众的客户端来请求这些视频流。观众的客户端请求的过程称为拉流。</p><p>如果有非常多的观众，同时看一个视频直播，那都从一个服务器上拉流，压力太大了，因而需要一个视频的分发网络，将视频预先加载到就近的边缘节点，这样大部分观众看的视频，是从边缘节点拉取的，就能降低服务器的压力。</p><p>当观众的客户端将视频流拉下来之后，就需要进行解码，也即通过上述过程的逆过程，将一串串看不懂的二进制，再转变成一帧帧生动的图片，在客户端播放出来，这样你就能看到美女帅哥啦。</p><p><img src="/.com//%E7%9B%B4%E6%92%AD%E6%B5%81%E7%A8%8B.webp"></p><h3 id="直播编码"><a href="#直播编码" class="headerlink" title="直播编码"></a>直播编码</h3><p>虽然我们说视频是一张张图片的序列，但是如果每张图片都完整，就太大了，因而会将视频序列分成三种帧。</p><p>I 帧，也称关键帧。里面是完整的图片，只需要本帧数据，就可以完成解码。</p><p>P 帧，前向预测编码帧。P 帧表示的是这一帧跟之前的一个关键帧（或 P 帧）的差别，解码时需要用之前缓存的画面，叠加上和本帧定义的差别，生成最终画面。</p><p>B 帧，双向预测内插编码帧。B 帧记录的是本帧与前后帧的差别。要解码 B 帧，不仅要取得之前的缓存画面，还要解码之后的画面，通过前后画面的数据与本帧数据的叠加，取得最终的画面。</p><p>可以看出，I 帧最完整，B 帧压缩率最高，而压缩后帧的序列，应该是在 IBBP 的间隔出现的。这就是通过时序进行编码。</p><p>在一帧中，分成多个片，每个片中分成多个宏块，每个宏块分成多个子块，这样将一张大的图分解成一个个小块，可以方便进行空间上的编码。</p><p><img src="/.com//%E5%9B%BE%E7%89%87%E7%BC%96%E7%A0%81%E6%8B%86%E5%88%86%E4%B8%BA.webp"></p><p>尽管时空非常立体地组成了一个序列，但是总归还是要压缩成一个二进制流。这个流是有结构的，是一个个的网络提取层单元（NALU，Network Abstraction Layer Unit）。变成这种格式就是为了传输，因为网络上的传输，默认的是一个个的包，因而这里也就分成了一个个的单元。</p><p><img src="/.com//NALU%E6%A0%BC%E5%BC%8F.webp"></p><p>每一个 NALU 首先是一个起始标识符，用于标识 NALU 之间的间隔；然后是 NALU 的头，里面主要配置了 NALU 的类型；最终 Payload 里面是 NALU 承载的数据。</p><p>在 NALU 头里面，主要的内容是类型 NAL Type。</p><p>0x07 表示 SPS，是序列参数集， 包括一个图像序列的所有信息，如图像尺寸、视频格式等。</p><p>0x08 表示 PPS，是图像参数集，包括一个图像的所有分片的所有相关信息，包括图像类型、序列号等。</p><p>在传输视频流之前，必须要传输这两类参数，不然无法解码。为了保证容错性，每一个 I 帧前面，都会传一遍这两个参数集合。</p><p>如果 NALU Header 里面的表示类型是 SPS 或者 PPS，则 Payload 中就是真正的参数集的内容。</p><p>如果类型是帧，则 Payload 中才是正的视频数据，当然也是一帧一帧存放的，前面说了，一帧的内容还是挺多的，因而每一个 NALU 里面保存的是一片。对于每一片，到底是 I 帧，还是 P 帧，还是 B 帧，在片结构里面也有个 Header，这里面有个类型，然后是片的内容。</p><p>这样，整个格式就出来了，一个视频，可以拆分成一系列的帧，每一帧拆分成一系列的片，每一片都放在一个 NALU 里面，NALU 之间都是通过特殊的起始标识符分隔，在每一个 I 帧的第一片前面，要插入单独保存 SPS 和 PPS 的 NALU，最终形成一个长长的 NALU 序列。</p><h3 id="推流"><a href="#推流" class="headerlink" title="推流"></a>推流</h3><p>那这个格式是不是就能够直接在网上传输到对端，开始直播了呢？其实还不是，还需要将这个二进制的流打包成网络包进行发送，这里我们使用 RTMP 协议。这就进入了第二个过程，推流。</p><p>RTMP 是基于 TCP 的，因而肯定需要双方建立一个 TCP 的连接。在有 TCP 的连接的基础上，还需要建立一个 RTMP 的连接，也即在程序里面，你需要调用 RTMP 类库的 Connect 函数，显示创建一个连接。</p><p>RTMP 为什么需要建立一个单独的连接呢？</p><p>因为它们需要商量一些事情，保证以后的传输能正常进行。主要就是两个事情，一个是版本号，如果客户端、服务器的版本号不一致，则不能工作。另一个就是时间戳，视频播放中，时间是很重要的，后面的数据流互通的时候，经常要带上时间戳的差值，因而一开始双方就要知道对方的时间戳。</p><p>未来沟通这些事情，需要发送六条消息：客户端发送 C0、C1、  C2，服务器发送 S0、  S1、  S2。</p><p>首先，客户端发送 C0 表示自己的版本号，不必等对方的回复，然后发送 C1 表示自己的时间戳。</p><p>服务器只有在收到 C0 的时候，才能返回 S0，表明自己的版本号，如果版本不匹配，可以断开连接。</p><p>服务器发送完 S0 后，也不用等什么，就直接发送自己的时间戳 S1。客户端收到 S1 的时候，发一个知道了对方时间戳的 ACK  C2。同理服务器收到 C1 的时候，发一个知道了对方时间戳的 ACK  S2。</p><p>于是，握手完成。</p><p><img src="/.com//%E6%8E%A8%E6%B5%81%E6%B5%81%E7%A8%8B.webp"></p><p>握手之后，双方需要互相传递一些控制信息，例如 Chunk 块的大小、窗口大小等。</p><p>真正传输数据的时候，还是需要创建一个流 Stream，然后通过这个 Stream 来推流 publish。</p><p>推流的过程，就是将 NALU 放在 Message 里面发送，这个也称为 RTMP Packet 包。Message 的格式就像这样。</p><p><img src="/.com//RTMP%E5%8C%85%E6%A0%BC%E5%BC%8F.webp"></p><p>发送的时候，去掉 NALU 的起始标识符。因为这部分对于 RTMP 协议来讲没有用。接下来，将 SPS 和 PPS 参数集封装成一个 RTMP 包发送，然后发送一个个片的 NALU。</p><p>RTMP 在收发数据的时候并不是以 Message 为单位的，而是把 Message 拆分成 Chunk 发送，而且必须在一个 Chunk 发送完成之后，才能开始发送下一个 Chunk。每个 Chunk 中都带有 Message  ID，表示属于哪个 Message，接收端也会按照这个 ID 将 Chunk 组装成 Message。</p><p>前面连接的时候，设置的 Chunk 块大小就是指这个 Chunk。将大的消息变为小的块再发送，可以在低带宽的情况下，减少网络拥塞。</p><p>这有一个分块的例子，你可以看一下。</p><p>假设一个视频的消息长度为 307，但是 Chunk 大小约定为 128，于是会拆分为三个 Chunk。</p><p>第一个 Chunk 的 Type＝0，表示 Chunk 头是完整的；头里面 Timestamp 为 1000，总长度 Length 为 307，类型为 9，是个视频，Stream  ID 为 12346，正文部分承担 128 个字节的 Data。</p><p>第二个 Chunk 也要发送 128 个字节，Chunk 头由于和第一个 Chunk 一样，因此采用 Chunk Type＝3，表示头一样就不再发送了。</p><p>第三个 Chunk 要发送的 Data 的长度为 307-128-128&#x3D;51 个字节，还是采用 Type＝3。</p><p><img src="/.com//RTMP%E6%8E%A8%E6%B5%81%E5%8C%85.webp"></p><p>这个时候，大量观看直播的观众就可以通过 RTMP 协议从流媒体服务器上拉取，但是这么多的用户量，都去同一个地方拉取，服务器压力会很大，而且用户分布在全国甚至全球，如果都去统一的一个地方下载，也会时延比较长，需要有分发网络。</p><p>分发网络分为中心和边缘两层。边缘层服务器部署在全国各地及横跨各大运营商里，和用户距离很近。中心层是流媒体服务集群，负责内容的转发。智能负载均衡系统，根据用户的地理位置信息，就近选择边缘服务器，为用户提供推 &#x2F; 拉流服务。中心层也负责转码服务，例如，把 RTMP 协议的码流转换为 HLS 码流。</p><p><img src="/.com//%E7%9B%B4%E6%92%AD%E8%AE%BE%E5%A4%87%E6%B5%81%E7%A8%8B%E5%9B%BE.webp"></p><h3 id="拉流"><a href="#拉流" class="headerlink" title="拉流"></a>拉流</h3><p><img src="/.com//%E7%9B%B4%E6%92%AD%E6%8B%89%E6%B5%81%E6%B5%81%E7%A8%8B%E5%9B%BE.webp"></p><p>先读到的是 H.264 的解码参数，例如 SPS 和 PPS，然后对收到的 NALU 组成的一个个帧，进行解码，交给播发器播放，一个绚丽多彩的视频画面就出来了。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议17文件下载协议</title>
    <link href="/2023/07/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE17%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E5%8D%8F%E8%AE%AE/"/>
    <url>/2023/07/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE17%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E5%8D%8F%E8%AE%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="文件下载协议"><a href="#文件下载协议" class="headerlink" title="文件下载协议"></a>文件下载协议</h1><h2 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h2><p>通过浏览器下载的时候，只要文件稍微大点，下载的速度就奇慢无比。无法断点续传。</p><h2 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a>FTP</h2><p>文件传输协议。</p><p>FTP 采用两个 TCP 连接来传输一个文件。</p><p>控制连接：服务器以被动的方式，打开众所周知用于 FTP 的端口 21，客户端则主动发起连接。该连接将命令从客户端传给服务器，并传回服务器的应答。常用的命令有：list——获取文件目录；reter——取一个文件；store——存一个文件。</p><p>数据连接：每当一个文件在客户端与服务器之间传输时，就创建一个数据连接。</p><h3 id="FTP-的两种工作模式"><a href="#FTP-的两种工作模式" class="headerlink" title="FTP 的两种工作模式"></a>FTP 的两种工作模式</h3><p>每传输一个文件，都要建立一个全新的数据连接。</p><p>两种模式都是站在 FTP 服务器的角度来说的。</p><h4 id="主动模式（PORT）"><a href="#主动模式（PORT）" class="headerlink" title="主动模式（PORT）"></a>主动模式（PORT）</h4><p>客户端随机打开一个大于 1024 的端口 N，向服务器的命令端口 21 发起连接，同时开放 N+1 端口监听，并向服务器发出 “port N+1” 命令，由服务器从自己的数据端口 20，主动连接到客户端指定的数据端口 N+1。</p><h4 id="被动模式（PASV）"><a href="#被动模式（PASV）" class="headerlink" title="被动模式（PASV）"></a>被动模式（PASV）</h4><p>当开启一个 FTP 连接时，客户端打开两个任意的本地端口 N（大于 1024）和 N+1。第一个端口连接服务器的 21 端口，提交 PASV 命令。然后，服务器会开启一个任意的端口 P（大于 1024），返回“227 entering passive mode”消息，里面有 FTP 服务器开放的用来进行数据传输的端口。客户端收到消息取得端口号之后，会通过 N+1 号端口连接服务器的端口 P，然后在两个端口之间进行数据传输。</p><h2 id="P2P"><a href="#P2P" class="headerlink" title="P2P"></a>P2P</h2><p>但是无论是 HTTP 的方式，还是 FTP 的方式，都有一个比较大的缺点，就是难以解决单一服务器的带宽压力， 因为它们使用的都是传统的客户端服务器的方式。</p><p>P2P 就是 peer-to-peer。资源开始并不集中地存储在某些设备上，而是分散地存储在多台设备上。</p><p>这些设备我们姑且称为 peer。</p><p>想要下载一个文件的时候，你只要得到那些已经存在了文件的 peer，并和这些 peer 之间，建立点对点的连接，而不需要到中心服务器上，就可以就近下载文件。一旦下载了文件，你也就成为 peer 中的一员，你旁边的那些机器，也可能会选择从你这里下载文件，所以当你使用 P2P 软件的时候，例如 BitTorrent，往往能够看到，既有下载流量，也有上传的流量，也即你自己也加入了这个 P2P 的网络，自己从别人那里下载，同时也提供给其他人下载。可以想象，这种方式，参与的人越多，下载速度越快，一切完美。</p><h3 id="种子（-torrent）文件"><a href="#种子（-torrent）文件" class="headerlink" title="种子（.torrent）文件"></a>种子（.torrent）文件</h3><p>你想下载一个文件的时候，怎么知道哪些 peer 有这个文件呢？</p><p>.torrent 文件由两部分组成，分别是：announce（tracker URL）和文件信息。</p><p>文件信息里面有这些内容：</p><p>info 区：这里指定的是该种子有几个文件、文件有多长、目录结构，以及目录和文件的名字。</p><p>Name 字段：指定顶层目录名字。</p><p>每个段的大小：BitTorrent（简称 BT）协议把一个文件分成很多个小段，然后分段下载。</p><p>段哈希值：将整个种子中，每个段的 SHA-1 哈希值拼在一起。</p><h3 id="P2P-tracker服务器方式"><a href="#P2P-tracker服务器方式" class="headerlink" title="P2P tracker服务器方式"></a>P2P tracker服务器方式</h3><p>下载时，BT 客户端首先解析.torrent 文件，得到 tracker 地址，然后连接 tracker 服务器。tracker 服务器回应下载者的请求，将其他下载者（包括发布者）的 IP 提供给下载者。下载者再连接其他下载者，根据.torrent 文件，两者分别对方告知自己已经有的块，然后交换对方没有的数据。此时不需要其他服务器参与，并分散了单个线路上的数据流量，因此减轻了服务器的负担。</p><p>下载者每得到一个块，需要算出下载块的 Hash 验证码，并与.torrent 文件中的对比。如果一样，则说明块正确，不一样则需要重新下载这个块。这种规定是为了解决下载内容的准确性问题。</p><p>从这个过程也可以看出，这种方式特别依赖 tracker。tracker 需要收集下载者信息的服务器，并将此信息提供给其他下载者，使下载者们相互连接起来，传输数据。虽然下载的过程是非中心化的，但是加入这个 P2P 网络的时候，都需要借助 tracker 中心服务器，这个服务器是用来登记有哪些用户在请求哪些资源。</p><p>所以，这种工作方式有一个弊端，一旦 tracker 服务器出现故障或者线路遭到屏蔽，BT 工具就无法正常工作了。</p><h3 id="去中心化网络（DHT）"><a href="#去中心化网络（DHT）" class="headerlink" title="去中心化网络（DHT）"></a>去中心化网络（DHT）</h3><p>后来就有了一种叫作 DHT（Distributed Hash Table）的去中心化网络。</p><p>每个加入这个 DHT 网络的人，都要负责存储这个网络里的资源信息和其他成员的联系信息，相当于所有人一起构成了一个庞大的分布式存储数据库。</p><p>有一种著名的 DHT 协议，叫 Kademlia 协议。</p><p>任何一个 BitTorrent 启动之后，它都有两个角色。一个是 peer，监听一个 TCP 端口，用来上传和下载文件，这个角色表明，我这里有某个文件。另一个角色 DHT node，监听一个 UDP 的端口，通过这个角色，这个节点加入了一个 DHT 的网络。</p><p><img src="/.com//DHT%E8%8A%82%E7%82%B9%E5%9B%BE.webp"></p><p>在 DHT 网络里面，每一个 DHT node 都有一个 ID。这个 ID 是一个很长的串。每个 DHT node 都有责任掌握一些知识，也就是文件索引，也即它应该知道某些文件是保存在哪些节点上。它只需要有这些知识就可以了，而它自己本身不一定就是保存这个文件的节点。</p><h4 id="哈希值"><a href="#哈希值" class="headerlink" title="哈希值"></a>哈希值</h4><p>当然，每个 DHT node 不会有全局的知识，也即不知道所有的文件保存在哪里，它只需要知道一部分。那应该知道哪一部分呢？这就需要用哈希算法计算出来。</p><p>每个文件可以计算出一个哈希值，而 DHT node 的 ID 是和哈希值相同长度的串。</p><p>DHT 算法是这样规定的：如果一个文件计算出一个哈希值，则和这个哈希值一样的那个 DHT node，就有责任知道从哪里下载这个文件，即便它自己没保存这个文件。</p><p>当然不一定这么巧，总能找到和哈希值一模一样的，有可能一模一样的 DHT node 也下线了，所以 DHT 算法还规定：除了一模一样的那个 DHT node 应该知道，ID 和这个哈希值非常接近的 N 个 DHT node 也应该知道。</p><p>什么叫和哈希值接近呢？例如只修改了最后一位，就很接近；修改了倒数 2 位，也不远；修改了倒数 3 位，也可以接受。总之，凑齐了规定的 N 这个数就行。</p><p>刚才那个图里，文件 1 通过哈希运算，得到匹配 ID 的 DHT node 为 node C，当然还会有其他的，我这里没有画出来。所以，node C 有责任知道文件 1 的存放地址，虽然 node C 本身没有存放文件 1。</p><p>同理，文件 2 通过哈希运算，得到匹配 ID 的 DHT node 为 node E，但是 node D 和 E 的 ID 值很近，所以 node D 也知道。当然，文件 2 本身没有必要一定在 node D 和 E 里，但是碰巧这里就在 E 那有一份。</p><p>接下来一个新的节点 node new 上线了。如果想下载文件 1，它首先要加入 DHT 网络，如何加入呢？</p><p>在这种模式下，种子.torrent 文件里面就不再是 tracker 的地址了，而是一个 list 的 node 的地址，而所有这些 node 都是已经在 DHT 网络里面的。当然随着时间的推移，很可能有退出的，有下线的，但是我们假设，不会所有的都联系不上，总有一个能联系上。</p><p>node new 只要在种子里面找到一个 DHT node，就加入了网络。</p><p>node new 会计算文件 1 的哈希值，并根据这个哈希值了解到，和这个哈希值匹配，或者很接近的 node 上知道如何下载这个文件，例如计算出来的哈希值就是 node C。</p><p>但是 node new 不知道怎么联系上 node C，因为种子里面的 node 列表里面很可能没有 node C，但是它可以问，DHT 网络特别像一个社交网络，node new 只有去它能联系上的 node 问，你们知道不知道 node C 的联系方式呀？</p><p>在 DHT 网络中，每个 node 都保存了一定的联系方式，但是肯定没有 node 的所有联系方式。DHT 网络中，节点之间通过互相通信，也会交流联系方式，也会删除联系方式。和人们的方式一样，你有你的朋友圈，你的朋友有它的朋友圈，你们互相加微信，就互相认识了，过一段时间不联系，就删除朋友关系。</p><p>有个理论是，社交网络中，任何两个人直接的距离不超过六度，也即你想联系比尔盖茨，也就六个人就能够联系到了。</p><p>所以，node new 想联系 node C，就去万能的朋友圈去问，并且求转发，朋友再问朋友，很快就能找到。如果找不到 C，也能找到和 C 的 ID 很像的节点，它们也知道如何下载文件 1。</p><p>在 node C 上，告诉 node new，下载文件 1，要去 B、D、 F，于是 node new 选择和 node B 进行 peer 连接，开始下载，它一旦开始下载，自己本地也有文件 1 了，于是 node new 告诉 node C 以及和 node C 的 ID 很像的那些节点，我也有文件 1 了，可以加入那个文件拥有者列表了。</p><p>但是你会发现 node new 上没有文件索引，但是根据哈希算法，一定会有某些文件的哈希值是和 node new 的 ID 匹配上的。在 DHT 网络中，会有节点告诉它，你既然加入了咱们这个网络，你也有责任知道某些文件的下载地址。</p><p>好了，一切都分布式了。</p><p>DHT node ID 以及文件哈希是个什么东西？</p><p>节点 ID 是一个随机选择的 160bits（20 字节）空间，文件的哈希也使用这样的 160bits 空间。</p><p>所谓 ID 相似，具体到什么程度算相似？</p><p>在 Kademlia 网络中，距离是通过异或（XOR）计算的。我们就不以 160bits 举例了。我们以 5 位来举例。</p><p>01010 与 01000 的距离，就是两个 ID 之间的异或值，为 00010，也即为 2。 01010 与 00010 的距离为 01000，也即为 8,。01010 与 00011 的距离为 01001，也即 8+1&#x3D;9 。以此类推，高位不同的，表示距离更远一些；低位不同的，表示距离更近一些，总的距离为所有的不同的位的距离之和。</p><p>这个距离不能比喻为地理位置，因为在 Kademlia 网络中，位置近不算近，ID 近才算近，所以我把这个距离比喻为社交距离，也即在朋友圈中的距离，或者社交网络中的距离。这个和你住的位置没有关系，和人的经历关系比较大。</p><p>还是以 5 位 ID 来举例，就像在领英中，排第一位的表示最近一份工作在哪里，第二位的表示上一份工作在哪里，然后第三位的是上上份工作，第四位的是研究生在哪里读，第五位的表示大学在哪里读。</p><p>如果你是一个猎头，在上面找候选人，当然最近的那份工作是最重要的。而对于工作经历越丰富的候选人，大学在哪里读的反而越不重要。</p><h4 id="DHT-网络中的朋友圈是怎么维护的？"><a href="#DHT-网络中的朋友圈是怎么维护的？" class="headerlink" title="DHT 网络中的朋友圈是怎么维护的？"></a>DHT 网络中的朋友圈是怎么维护的？</h4><p>就像人一样，虽然我们常联系人的只有少数，但是朋友圈里肯定是远近都有。DHT 网络的朋友圈也是一样，远近都有，并且按距离分层。</p><p>假设某个节点的 ID 为 01010，如果一个节点的 ID，前面所有位数都与它相同，只有最后 1 位不同。这样的节点只有 1 个，为 01011。与基础节点的异或值为 00001，即距离为 1；对于 01010 而言，这样的节点归为“k-bucket 1”。</p><p>如果一个节点的 ID，前面所有位数都相同，从倒数第 2 位开始不同，这样的节点只有 2 个，即 01000 和 01001，与基础节点的异或值为 00010 和 00011，即距离范围为 2 和 3；对于 01010 而言，这样的节点归为“k-bucket 2”。</p><p>如果一个节点的 ID，前面所有位数相同，从倒数第 i 位开始不同，这样的节点只有 2^(i-1) 个，与基础节点的距离范围为[2^(i-1), 2^i)；对于 01010 而言，这样的节点归为“k-bucket i”。</p><p>最终到从倒数 160 位就开始都不同。</p><p>你会发现，差距越大，陌生人越多，但是朋友圈不能都放下，所以每一层都只放 K 个，这是参数可以配置。</p><h4 id="DHT-网络是如何查找朋友的？"><a href="#DHT-网络是如何查找朋友的？" class="headerlink" title="DHT 网络是如何查找朋友的？"></a>DHT 网络是如何查找朋友的？</h4><p>假设，node A 的 ID 为 00110，要找 node B ID 为 10000，异或距离为 10110，距离范围在[2^4, 2^5)，所以这个目标节点可能在“k-bucket 5”中，这就说明 B 的 ID 与 A 的 ID 从第 5 位开始不同，所以 B 可能在“k-bucket 5”中。</p><p>然后，A 看看自己的 k-bucket 5 有没有 B。如果有，太好了，找到你了；如果没有，在 k-bucket 5 里随便找一个 C。因为是二进制，C、B 都和 A 的第 5 位不同，那么 C 的 ID 第 5 位肯定与 B 相同，即它与 B 的距离会小于 2^4，相当于比 A、B 之间的距离缩短了一半以上。</p><p>再请求 C，在它自己的通讯录里，按同样的查找方式找一下 B。如果 C 知道 B，就告诉 A；如果 C 也不知道 B，那 C 按同样的搜索方法，可以在自己的通讯录里找到一个离 B 更近的 D 朋友（D、B 之间距离小于 2^3），把 D 推荐给 A，A 请求 D 进行下一步查找。</p><p>Kademlia 的这种查询机制，是通过折半查找的方式来收缩范围，对于总的节点数目为 N，最多只需要查询 log2(N) 次，就能够找到。</p><p>A 和 B 每一位都不一样，所以相差 31，A 找到的朋友 C，不巧正好在中间。和 A 的距离是 16，和 B 距离为 15，于是 C 去自己朋友圈找的时候，不巧找到 D，正好又在中间，距离 C 为 8，距离 B 为 7。于是 D 去自己朋友圈找的时候，不巧找到 E，正好又在中间，距离 D 为 4，距离 B 为 3，E 在朋友圈找到 F，距离 E 为 2，距离 B 为 1，最终在 F 的朋友圈距离 1 的地方找到 B。当然这是最最不巧的情况，每次找到的朋友都不远不近，正好在中间。</p><p>如果碰巧了，在 A 的朋友圈里面有 G，距离 B 只有 3，然后在 G 的朋友圈里面一下子就找到了 B，两次就找到了。</p><p>在 DHT 网络中，朋友之间怎么沟通呢？</p><p>Kademlia 算法中，每个节点只有 4 个指令。</p><p>PING：测试一个节点是否在线，还活着没，相当于打个电话，看还能打通不。</p><p>STORE：要求一个节点存储一份数据，既然加入了组织，有义务保存一份数据。</p><p>FIND_NODE：根据节点 ID 查找一个节点，就是给一个 160 位的 ID，通过上面朋友圈的方式找到那个节点。</p><p>FIND_VALUE：根据 KEY 查找一个数据，实则上跟 FIND_NODE 非常类似。KEY 就是文件对应的 160 位的 ID，就是要找到保存了文件的节点。</p><p>DHT 网络中，朋友圈如何更新呢？</p><p>每个 bucket 里的节点，都按最后一次接触的时间倒序排列，这就相当于，朋友圈里面最近联系过的人往往是最熟的。</p><p>每次执行四个指令中的任意一个都会触发更新。</p><p>当一个节点与自己接触时，检查它是否已经在 k-bucket 中，也就是说是否已经在朋友圈。如果在，那么将它挪到 k-bucket 列表的最底，也就是最新的位置，刚联系过，就置顶一下，方便以后多联系；如果不在，新的联系人要不要加到通讯录里面呢？假设通讯录已满的情况，PING 一下列表最上面，也即最旧的一个节点。如果 PING 通了，将旧节点挪到列表最底，并丢弃新节点，老朋友还是留一下；如果 PING 不通，删除旧节点，并将新节点加入列表，这人联系不上了，删了吧。</p><p>这个机制保证了任意节点加入和离开都不影响整体网络。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议14HTTP</title>
    <link href="/2023/07/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE14HTTP/"/>
    <url>/2023/07/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE14HTTP/</url>
    
    <content type="html"><![CDATA[<h1 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h1><p>看新闻，使用浏览器访问<a href="http://www.163.com./">http://www.163.com。</a></p><p><a href="http://www.163.com是个/">http://www.163.com是个</a> URL，叫作统一资源定位符。之所以叫统一，是因为它是有格式的。HTTP 称为协议，<a href="http://www.163.com/">www.163.com</a> 是一个域名，表示互联网上的一个位置。有的 URL 会有更详细的位置标识，例如 <a href="http://www.163.com/index.html">http://www.163.com/index.html</a> 。正是因为这个东西是统一的，所以当你把这样一个字符串输入到浏览器的框里的时候，浏览器才知道如何进行统一处理。</p><h2 id="HTTP-请求的准备"><a href="#HTTP-请求的准备" class="headerlink" title="HTTP 请求的准备"></a>HTTP 请求的准备</h2><p>浏览器会将 <a href="http://www.163.com/">www.163.com</a> 这个域名发送给 DNS 服务器，让它解析为 IP 地址。</p><p>HTTP 是基于 TCP 协议的，当然是要先建立 TCP 连接了。</p><p>目前使用的 HTTP 协议大部分都是 1.1。在 1.1 的协议里面，默认是开启了 Keep-Alive 的，这样建立的 TCP 连接，就可以在多次请求中复用。</p><h2 id="HTTP-请求的构建"><a href="#HTTP-请求的构建" class="headerlink" title="HTTP 请求的构建"></a>HTTP 请求的构建</h2><p>建立了连接以后，浏览器就要发送 HTTP 的请求。</p><p><img src="/.com//HTTP%E8%AF%B7%E6%B1%82%E6%A0%BC%E5%BC%8F.webp"></p><p>HTTP 的报文大概分为三大部分。第一部分是请求行，第二部分是请求的首部，第三部分才是请求的正文实体。</p><h3 id="第一部分：请求行"><a href="#第一部分：请求行" class="headerlink" title="第一部分：请求行"></a>第一部分：请求行</h3><p>在请求行中，URL 就是 <a href="http://www.163.com/">http://www.163.com</a> ，版本为 HTTP 1.1。这里要说一下的，就是方法。方法有几种类型。</p><p>GET 就是去服务器获取一些资源。</p><p>POST 它需要主动告诉服务端一些信息，而非获取。</p><p>PUT 就是向指定资源位置上传最新内容。</p><p>在实际使用过程中，POST 往往是用来创建一个资源的，而 PUT 往往是用来修改一个资源的。</p><p>DELETE 用来删除资源的。</p><h3 id="第二部分：首部字段"><a href="#第二部分：首部字段" class="headerlink" title="第二部分：首部字段"></a>第二部分：首部字段</h3><p>请求行下面就是我们的首部字段。首部是 key value，通过冒号分隔。这里面，往往保存了一些非常重要的字段。</p><p>Accept-Charset，表示客户端可以接受的字符集。防止传过来的是另外的字符集，从而导致出现乱码。</p><p>Content-Type 是指正文的格式。例如，我们进行 POST 的请求，如果正文是 JSON，那么我们就应该将这个值设置为 JSON。</p><p>重点说一下的就是缓存。</p><p><img src="/http%E7%BC%93%E5%AD%98.webp"></p><p>Nginx 对于静态资源，有 Vanish 缓存层。当缓存过期的时候，才会访问真正的 Tomcat 应用集群。</p><p>在 HTTP 头里面，Cache-control 是用来控制缓存的。当客户端发送的请求中包含 max-age 指令时，如果判定缓存层中，资源的缓存时间数值比指定时间的数值小，那么客户端可以接受缓存的资源；当指定 max-age 值为 0，那么缓存层通常需要将请求转发给应用集群。</p><p>另外，If-Modified-Since 也是一个关于缓存的。也就是说，如果服务器的资源在某个时间之后更新了，那么客户端就应该下载最新的资源；如果没有更新，服务端会返回“304 Not Modified”的响应，那客户端就不用下载了，也会节省带宽。</p><h2 id="HTTP-请求的发送"><a href="#HTTP-请求的发送" class="headerlink" title="HTTP 请求的发送"></a>HTTP 请求的发送</h2><p>HTTP 协议是基于 TCP 协议的，所以它使用面向连接的方式发送请求，通过 stream 二进制流的方式传给对方。当然，到了 TCP 层，它会把二进制流变成一个个报文段发送给服务器。</p><p>在发送给每个报文段的时候，都需要对方有一个回应 ACK，来保证报文可靠地到达了对方。如果没有回应，那么 TCP 这一层会进行重新传输，直到可以到达。同一个包有可能被传了好多次，但是 HTTP 这一层不需要知道这一点，因为是 TCP 这一层在埋头苦干。</p><p>TCP 层发送每一个报文的时候，都需要加上自己的地址（即源地址）和它想要去的地方（即目标地址），将这两个信息放到 IP 头里面，交给 IP 层进行传输。</p><p>IP 层需要查看目标地址和自己是否是在同一个局域网。如果是，就发送 ARP 协议来请求这个目标地址对应的 MAC 地址，然后将源 MAC 和目标 MAC 放入 MAC 头，发送出去即可；如果不在同一个局域网，就需要发送到网关，还要需要发送 ARP 协议，来获取网关的 MAC 地址，然后将源 MAC 和网关 MAC 放入 MAC 头，发送出去。</p><p>网关收到包发现 MAC 符合，取出目标 IP 地址，根据路由协议找到下一跳的路由器，获取下一跳路由器的 MAC 地址，将包发给下一跳路由器。</p><p>这样路由器一跳一跳终于到达目标的局域网。这个时候，最后一跳的路由器能够发现，目标地址就在自己的某一个出口的局域网上。于是，在这个局域网上发送 ARP，获得这个目标地址的 MAC 地址，将包发出去。</p><p>目标的机器发现 MAC 地址符合，就将包收起来；发现 IP 地址符合，根据 IP 头中协议项，知道自己上一层是 TCP 协议，于是解析 TCP 的头，里面有序列号，需要看一看这个序列包是不是我要的，如果是就放入缓存中然后返回一个 ACK，如果不是就丢弃。</p><p>TCP 头里面还有端口号，HTTP 的服务器正在监听这个端口号。于是，目标机器自然知道是 HTTP 服务器这个进程想要这个包，于是将包发给 HTTP 服务器。HTTP 服务器的进程看到，原来这个请求是要访问一个网页，于是就把这个网页发给客户端。</p><h2 id="HTTP-返回的构建"><a href="#HTTP-返回的构建" class="headerlink" title="HTTP 返回的构建"></a>HTTP 返回的构建</h2><p><img src="/.com//HTTP%E5%93%8D%E5%BA%94%E6%A0%BC%E5%BC%8F.webp"></p><p>状态码会反映 HTTP 请求的结果。 “200”  成功 </p><p>接下来是返回首部的 key value。</p><p>Retry-After 表示，告诉客户端应该在多长时间以后再次尝试一下。“503 错误”是说“服务暂时不再和这个值配合使用”。</p><p>Content-Type，表示返回的是 HTML，还是 JSON。</p><p>构造好了返回的 HTTP 报文，接下来就是把这个报文发送出去。还是交给 Socket 去发送，还是交给 TCP 层，让 TCP 层将返回的 HTML，也分成一个个小的段，并且保证每个段都可靠到达。</p><p>这些段加上 TCP 头后会交给 IP 层，然后把刚才的发送过程反向走一遍。虽然两次不一定走相同的路径，但是逻辑过程是一样的，一直到达客户端。</p><p>客户端发现 MAC 地址符合、IP 地址符合，于是就会交给 TCP 层。根据序列号看是不是自己要的报文段，如果是，则会根据 TCP 头中的端口号，发给相应的进程。这个进程就是浏览器，浏览器作为客户端也在监听某个端口。</p><p>当浏览器拿到了 HTTP 的报文。发现返回“200”，一切正常，于是就从正文中将 HTML 拿出来。HTML 是一个标准的网页格式。浏览器只要根据这个格式，展示出一个绚丽多彩的网页。</p><p>这就是一个正常的 HTTP 请求和返回的完整过程。</p><h1 id="HTTP2-0"><a href="#HTTP2-0" class="headerlink" title="HTTP2.0"></a>HTTP2.0</h1><p>当然 HTTP 协议也在不断的进化过程中，在 HTTP1.1 基础上便有了 HTTP 2.0。</p><p>HTTP 1.1 在应用层以纯文本的形式进行通信。每次通信都要带完整的 HTTP 的头，而且不考虑 pipeline 模式的话，每次的过程总是像上面描述的那样一去一回。这样在实时性、并发性上都存在问题。</p><h2 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h2><p>为了解决这些问题，HTTP 2.0 会对 HTTP 的头进行一定的压缩，将原来每次都要携带的大量 key  value 在两端建立一个索引表，对相同的头只发送索引表中的索引。</p><h2 id="分帧与二进制编码"><a href="#分帧与二进制编码" class="headerlink" title="分帧与二进制编码"></a>分帧与二进制编码</h2><p>另外，HTTP 2.0 协议将一个 TCP 的连接中，切分成多个流，每个流都有自己的 ID，而且流可以是客户端发往服务端，也可以是服务端发往客户端。它其实只是一个虚拟的通道。流是有优先级的。</p><p>HTTP 2.0 还将所有的传输信息分割为更小的消息和帧，并对它们采用二进制格式编码。常见的帧有 Header 帧，用于传输 Header 内容，并且会开启一个新的流。再就是 Data 帧，用来传输正文实体。多个 Data 帧属于同一个流。</p><p>通过这两种机制，HTTP 2.0 的客户端可以将多个请求分到不同的流中，然后将请求内容拆成帧，进行二进制传输。这些帧可以打散乱序发送， 然后根据每个帧首部的流标识符重新组装，并且可以根据优先级，决定优先处理哪个流的数据。</p><p>假设我们的一个页面要发送三个独立的请求，一个获取 css，一个获取 js，一个获取图片 jpg。如果使用 HTTP 1.1 就是串行的，但是如果使用 HTTP 2.0，就可以在一个连接里，客户端和服务端都可以同时发送多个请求或回应，而且不用按照顺序一对一对应。</p><p><img src="/.com//HTTP2.0%E4%B8%8E1.1%E6%AF%94%E8%BE%83.webp"></p><p>HTTP 2.0 其实是将三个请求变成三个流，将数据分成帧，乱序发送到一个 TCP 连接中。</p><p><img src="/.com//HTTP2.0%E4%B8%8E1.1%E5%9C%A8TCP%E5%B1%82%E5%AF%B9%E6%AF%94.webp"></p><p>HTTP 2.0 成功解决了 HTTP 1.1 的队首阻塞问题，同时，也不需要通过 HTTP 1.x 的 pipeline 机制用多条 TCP 连接来实现并行请求与响应；减少了 TCP 连接数对服务器性能的影响，同时将页面的多个数据 css、js、 jpg 等通过一个数据链接进行传输，能够加快页面组件的传输速度。</p><h1 id="QUIC-协议"><a href="#QUIC-协议" class="headerlink" title="QUIC 协议"></a>QUIC 协议</h1><p>HTTP 2.0 虽然大大增加了并发性，但还是有问题的。因为 HTTP 2.0 也是基于 TCP 协议的，TCP 协议在处理包时是有严格顺序的。</p><p>当其中一个数据包遇到问题，TCP 连接需要等待这个包完成重传之后才能继续进行。虽然 HTTP 2.0 通过多个 stream，使得逻辑上一个 TCP 连接上的并行内容，进行多路数据的传输，然而这中间并没有关联的数据。一前一后，前面 stream 2 的帧没有收到，后面 stream 1 的帧也会因此阻塞。</p><h2 id="机制一：自定义连接机制"><a href="#机制一：自定义连接机制" class="headerlink" title="机制一：自定义连接机制"></a>机制一：自定义连接机制</h2><p>一条 TCP 连接是由四元组标识的，分别是源 IP、源端口、目的 IP、目的端口。一旦一个元素发生变化时，就需要断开重连，重新连接。</p><p>在移动互联情况下，当手机信号不稳定或者在 WIFI 和 移动网络切换时，都会导致重连，从而进行再次的三次握手，导致一定的时延。</p><p>这在 TCP 是没有办法的，但是基于 UDP，就可以在 QUIC 自己的逻辑里面维护连接的机制，不再以四元组标识，而是以一个 64 位的随机数作为 ID 来标识，而且 UDP 是无连接的，所以当 IP 或者端口变化的时候，只要 ID 不变，就不需要重新建立连接。</p><h2 id="机制二：自定义重传机制"><a href="#机制二：自定义重传机制" class="headerlink" title="机制二：自定义重传机制"></a>机制二：自定义重传机制</h2><p>TCP 为了保证可靠性，通过使用序号和应答机制，来解决顺序问题和丢包问题。</p><p>任何一个序号的包发过去，都要在一定的时间内得到应答，否则一旦超时，就会重发这个序号的包。那怎么样才算超时呢？还记得我们提过的自适应重传算法吗？这个超时是通过采样往返时间 RTT 不断调整的。</p><p>其实，在 TCP 里面超时的采样存在不准确的问题。例如，发送一个包，序号为 100，发现没有返回，于是再发送一个 100，过一阵返回一个 ACK101。这个时候客户端知道这个包肯定收到了，但是往返时间是多少呢？是 ACK 到达的时间减去后一个 100 发送的时间，还是减去前一个 100 发送的时间呢？事实是，第一种算法把时间算短了，第二种算法把时间算长了。</p><p>QUIC 也有个序列号，是递增的。任何一个序列号的包只发送一次，下次就要加一了。例如，发送一个包，序号是 100，发现没有返回；再次发送的时候，序号就是 101 了；如果返回的 ACK  100，就是对第一个包的响应。如果返回 ACK  101 就是对第二个包的响应，RTT 计算相对准确。</p><p>但是这里有一个问题，就是怎么知道包 100 和包 101 发送的是同样的内容呢？QUIC 定义了一个 offset 概念。QUIC 既然是面向连接的，也就像 TCP 一样，是一个数据流，发送的数据在这个数据流里面有个偏移量 offset，可以通过 offset 查看数据发送到了哪里，这样只要这个 offset 的包没有来，就要重发；如果来了，按照 offset 拼接，还是能够拼成一个流。</p><h2 id="机制三：无阻塞的多路复用"><a href="#机制三：无阻塞的多路复用" class="headerlink" title="机制三：无阻塞的多路复用"></a>机制三：无阻塞的多路复用</h2><p>有了自定义的连接和重传机制，我们就可以解决上面 HTTP  2.0 的多路复用问题。</p><p>同 HTTP 2.0 一样，同一条 QUIC 连接上可以创建多个 stream，来发送多个 HTTP 请求。但是，QUIC 是基于 UDP 的，一个连接上的多个 stream 之间没有依赖。这样，假如 stream2 丢了一个 UDP 包，后面跟着 stream3 的一个 UDP 包，虽然 stream2 的那个包需要重传，但是 stream3 的包无需等待，就可以发给用户。</p><h2 id="自定义流量控制"><a href="#自定义流量控制" class="headerlink" title="自定义流量控制"></a>自定义流量控制</h2><p>CP 的流量控制是通过滑动窗口协议。QUIC 的流量控制也是通过 window_update，来告诉对端它可以接受的字节数。但是 QUIC 的窗口是适应自己的多路复用机制的，不但在一个连接上控制窗口，还在一个连接中的每个 stream 控制窗口。</p><p>在 TCP 协议中，接收端的窗口的起始点是下一个要接收并且 ACK 的包，即便后来的包都到了，放在缓存里面，窗口也不能右移，因为 TCP 的 ACK 机制是基于序列号的累计应答，一旦 ACK 了一个序列号，就说明前面的都到了，所以只要前面的没到，后面的到了也不能 ACK，就会导致后面的到了，也有可能超时重传，浪费带宽。</p><p>QUIC 的 ACK 是基于 offset 的，每个 offset 的包来了，进了缓存，就可以应答，应答后就不会重发，中间的空档会等待到来或者重发即可，而窗口的起始位置为当前收到的最大 offset，从这个 offset 到当前的 stream 所能容纳的最大缓存，是真正的窗口大小。显然，这样更加准确。</p><p><img src="/.com//QUIC%E6%8E%A5%E6%94%B6%E7%AA%97%E5%8F%A3%E5%A4%A7%E5%B0%8F%E5%AF%B9%E6%AF%94.webp"></p><p>另外，还有整个连接的窗口，需要对于所有的 stream 的窗口做一个统计。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议15HTTPS</title>
    <link href="/2023/07/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE15HTTPS/"/>
    <url>/2023/07/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE15HTTPS/</url>
    
    <content type="html"><![CDATA[<h1 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h1><p>http协议是明文转输内容不安全。</p><p>不安全一般思路就是加密。</p><h2 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h2><p>一种是对称加密，一种是非对称加密。</p><p>对称加密算法相比非对称加密算法来说，效率要高得多，性能也好，所以交互的场景下多用对称加密。</p><h3 id="对称加密"><a href="#对称加密" class="headerlink" title="对称加密"></a>对称加密</h3><p>在对称加密算法中，加密和解密使用的密钥是相同的。也就是说，加密和解密使用的是同一个密钥。</p><p>如果要用于HTTP协议，需要线下转输。但是客户端用户很多，不现实。</p><h3 id="非对称加密"><a href="#非对称加密" class="headerlink" title="非对称加密"></a>非对称加密</h3><p>在非对称加密算法中，加密使用的密钥和解密使用的密钥是不相同的。一把是作为公开的公钥，另一把是作为谁都不能给的私钥。公钥加密的信息，只有私钥才能解密。私钥加密的信息，只有公钥才能解密。</p><p>如果要用于HTTP协议，网站的服务器上放着私钥不给别人看，公钥放在网上可以随意下载。这时候客户端拿着公钥加密，客户端上送数据安全性保证了。</p><p>但是因为是公钥，服务器响应给客户端的数据，谁都可以看了。黑客还可以伪造请求给服务器。</p><p>这时候就需要客户端的公钥私钥，把公钥给服务器的过程又是不安全的。</p><h2 id="数字证书"><a href="#数字证书" class="headerlink" title="数字证书"></a>数字证书</h2><p>非对称加密还有一个问题：你怎么鉴别别人给你的公钥是对的，不会是黑客伪造的。</p><p>这个时候就需要权威部门的介入了。由权威部门颁发的称为证书（Certificate）。</p><p>证书里面有公钥,还有证书的所有者，另外还有证书的发布机构和证书的有效期。</p><h3 id="签名算法"><a href="#签名算法" class="headerlink" title="签名算法"></a>签名算法</h3><p>生成证书需要发起一个证书请求，然后将这个请求发给一个权威机构去认证，这个权威机构我们称为 CA（ Certificate Authority）。</p><p>将这个请求发给权威机构，权威机构会给这个证书卡一个章，我们称为签名算法。</p><p>当然只有用只掌握在权威机构手里的东西签名了才行，这就是 CA 的私钥。</p><p>签名算法大概是这样工作的：</p><p>一般是对信息做一个 Hash 计算，得到一个 Hash 值，这个过程是不可逆的，也就是说无法通过 Hash 值得出原来的信息内容。在把信息发送出去时，把这个 Hash 值加密后，作为一个签名和信息一起发出去。</p><p>这里面有个 Issuer，也即证书是谁颁发的；Subject，就是证书颁发给谁；Validity 是证书期限；Public-key 是公钥内容；Signature Algorithm 是签名算法。</p><p>这下好了，你不会从网站上得到一个公钥，而是会得到一个证书，这个证书有个发布机构 CA，你只要得到这个发布机构 CA 的公钥，去解密外卖网站证书的签名，如果解密成功了，Hash 也对的上，就说明这个外卖网站的公钥没有啥问题。</p><p>还是上面的问题“你怎么确定 CA 的公钥就是对的呢”</p><p>所以，CA 的公钥也需要更牛的 CA 给它签名，然后形成 CA 的证书。要想知道某个 CA 的证书是否可靠，要看 CA 的上级证书的公钥，能不能解开这个 CA 的签名。就像你不相信区公安局，可以打电话问市公安局，让市公安局确认区公安局的合法性。这样层层上去，直到全球皆知的几个著名大 CA，称为 root CA，做最后的背书。通过这种层层授信背书的方式，从而保证了非对称加密模式的正常运转。</p><p>除此之外，还有一种证书，称为 Self-Signed Certificate，就是自己给自己签名。这个给人一种“我就是我，你爱信不信”的感觉。这里我就不多说了。</p><h2 id="HTTPS-的工作模式"><a href="#HTTPS-的工作模式" class="headerlink" title="HTTPS 的工作模式"></a>HTTPS 的工作模式</h2><p>公钥私钥主要用于传输对称加密的秘钥，而真正的双方大数据量的通信都是通过对称加密进行的。</p><p><img src="/.com//HTTPS%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.webp"></p><p>当你登录一个外卖网站的时候，由于是 HTTPS，客户端会发送 Client Hello 消息到服务器，以明文传输 TLS 版本信息、加密套件候选列表、压缩算法候选列表等信息。另外，还会有一个随机数，在协商对称密钥的时候使用。</p><p>这就类似在说：“您好，我想定外卖，但你要保密我吃的是什么。这是我的加密套路，再给你个随机数，你留着。”</p><p>然后，外卖网站返回 Server Hello 消息, 告诉客户端，服务器选择使用的协议版本、加密套件、压缩算法等，还有一个随机数，用于后续的密钥协商。</p><p>这就类似在说：“您好，保密没问题，你的加密套路还挺多，咱们就按套路 2 来吧，我这里也有个随机数，你也留着。”</p><p>然后，外卖网站会给你一个服务器端的证书，然后说：“Server Hello Done，我这里就这些信息了。”</p><p>你当然不相信这个证书，于是你从自己信任的 CA 仓库中，拿 CA 的证书里面的公钥去解密外卖网站的证书。如果能够成功，则说明外卖网站是可信的。这个过程中，你可能会不断往上追溯 CA、CA 的 CA、CA 的 CA 的 CA，反正直到一个授信的 CA，就可以了。</p><p>证书验证完毕之后，觉得这个外卖网站可信，于是客户端计算产生随机数字 Pre-master，发送 Client Key Exchange，用证书中的公钥加密，再发送给服务器，服务器可以通过私钥解密出来。</p><p>到目前为止，无论是客户端还是服务器，都有了三个随机数，分别是：自己的、对端的，以及刚生成的 Pre-Master 随机数。通过这三个随机数，可以在客户端和服务器产生相同的对称密钥。</p><p>有了对称密钥，客户端就可以说：“Change Cipher Spec，咱们以后都采用协商的通信密钥和加密算法进行加密通信了。”</p><p>然后发送一个 Encrypted Handshake Message，将已经商定好的参数等，采用协商密钥进行加密，发送给服务器用于数据与握手验证。</p><p>同样，服务器也可以发送 Change Cipher Spec，说：“没问题，咱们以后都采用协商的通信密钥和加密算法进行加密通信了”，并且也发送 Encrypted Handshake Message 的消息试试。当双方握手结束之后，就可以通过对称密钥进行加密传输了。</p><p>这个过程除了加密解密之外，其他的过程和 HTTP 是一样的，过程也非常复杂。</p><p>上面的过程只包含了 HTTPS 的单向认证，也即客户端验证服务端的证书，是大部分的场景，也可以在更加严格安全要求的情况下，启用双向认证，双方互相验证证书。</p><h2 id="重放与篡改"><a href="#重放与篡改" class="headerlink" title="重放与篡改"></a>重放与篡改</h2><p>其实，这里还有一些没有解决的问题，例如重放和篡改的问题。</p><p>没错，有了加密和解密，黑客截获了包也打不开了，但是它可以发送 N 次。这个往往通过 Timestamp 和 Nonce 随机数联合起来，然后做一个不可逆的签名来保证。</p><p>Nonce 随机数保证唯一，或者 Timestamp 和 Nonce 合起来保证唯一，同样的，请求只接受一次，于是服务器多次收到相同的 Timestamp 和 Nonce，则视为无效即可。</p><p>如果有人想篡改 Timestamp 和 Nonce，还有签名保证不可篡改性，如果改了用签名算法解出来，就对不上了，可以丢弃了。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议13Socket</title>
    <link href="/2023/07/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE13Socket/"/>
    <url>/2023/07/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE13Socket/</url>
    
    <content type="html"><![CDATA[<h1 id="Socket"><a href="#Socket" class="headerlink" title="Socket"></a>Socket</h1><p>Socket 这个名字很有意思，可以作插口或者插槽讲。虽然我们是写软件程序，但是你可以想象为弄一根网线，一头插在客户端，一头插在服务端，然后进行通信。所以在通信之前，双方都要建立一个 Socket。</p><p>在网络层，Socket 函数需要指定到底是 IPv4 还是 IPv6，分别对应设置为 AF_INET 和 AF_INET6。另外，还要指定到底是 TCP 还是 UDP。还记得咱们前面讲过的，TCP 协议是基于数据流的，所以设置为 SOCK_STREAM，而 UDP 是基于数据报的，因而设置为 SOCK_DGRAM。</p><h2 id="基于-TCP-协议的-Socket-程序函数调用过程"><a href="#基于-TCP-协议的-Socket-程序函数调用过程" class="headerlink" title="基于 TCP 协议的 Socket 程序函数调用过程"></a>基于 TCP 协议的 Socket 程序函数调用过程</h2><p>TCP 的服务端要先监听一个端口，一般是先调用 bind 函数，给这个 Socket 赋予一个 IP 地址和端口。</p><p>端口：内核要通过 TCP 头里面的这个端口，来找到你这个应用程序，把包给你。</p><p>IP地址：一台机器会有多个网卡，也就会有多个 IP 地址，你可以选择监听所有的网卡，也可以选择监听一个网卡。</p><p>当服务端有了 IP 和端口号，就可以调用 listen 函数进行监听。在 TCP 的状态图里面，有一个 listen 状态，当调用这个函数之后，服务端就进入了这个状态，这个时候客户端就可以发起连接了。</p><p>在内核中，为每个 Socket 维护两个队列。</p><p>一个是已经建立了连接的队列，这时候连接三次握手已经完毕，处于 established 状态；</p><p>一个是还没有完全建立连接的队列，这个时候三次握手还没完成，处于 syn_rcvd 的状态。</p><p>接下来，服务端调用 accept 函数，拿出一个已经完成的连接进行处理。如果还没有完成，就要等着。</p><p>在服务端等待的时候，客户端可以通过 connect 函数发起连接。先在参数中指明要连接的 IP 地址和端口号，然后开始发起三次握手。内核会给客户端分配一个临时的端口。一旦握手成功，服务端的 accept 就会返回另一个 Socket。</p><p>就是监听的 Socket 和真正用来传数据的 Socket 是两个，一个叫作监听 Socket，一个叫作已连接 Socket。</p><p>连接建立成功之后，双方开始通过 read 和 write 函数来读写数据，就像往一个文件流里面写东西一样。</p><p><img src="/.com//%E5%9F%BA%E4%BA%8ETCP%E5%8D%8F%E8%AE%AE%E7%9A%84socket%E7%A8%8B%E5%BA%8F%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B.webp"></p><p>说 TCP 的 Socket 就是一个文件流，是非常准确的。因为，Socket 在 Linux 中就是以文件的形式存在的。除此之外，还存在文件描述符。写入和读出，也是通过文件描述符。</p><p>在内核中，Socket 是一个文件，那对应就有文件描述符。每一个进程都有一个数据结构 task_struct，里面指向一个文件描述符数组，来列出这个进程打开的所有文件的文件描述符。文件描述符是一个整数，是这个数组的下标。</p><p>这个数组中的内容是一个指针，指向内核中所有打开的文件的列表。既然是一个文件，就会有一个 inode，只不过 Socket 对应的 inode 不像真正的文件系统一样，保存在硬盘上的，而是在内存中的。在这个 inode 中，指向了 Socket 在内核中的 Socket 结构。</p><p>在这个结构里面，主要的是两个队列，一个是发送队列，一个是接收队列。在这两个队列里面保存的是一个缓存 sk_buff。这个缓存里面能够看到完整的包的结构。</p><p><img src="/.com//%E8%BF%9B%E7%A8%8B%E4%B8%8Esocket%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.webp"></p><h2 id="基于-UDP-协议的-Socket-程序函数调用过程"><a href="#基于-UDP-协议的-Socket-程序函数调用过程" class="headerlink" title="基于 UDP 协议的 Socket 程序函数调用过程"></a>基于 UDP 协议的 Socket 程序函数调用过程</h2><p>UDP 是没有连接的，所以不需要三次握手，也就不需要调用 listen 和 connect，但是，UDP 的交互仍然需要 IP 和端口号，因而也需要 bind。</p><p>UDP 是没有维护连接状态的，因而不需要每对连接建立一组 Socket，而是只要有一个 Socket，就能够和多个客户端通信。也正是因为没有连接状态，每次通信的时候，都调用 sendto 和 recvfrom，都可以传入 IP 地址和端口。</p><p><img src="/.com//%E5%9F%BA%E4%BA%8EUDP%E5%8D%8F%E8%AE%AE%E7%9A%84socket%E7%A8%8B%E5%BA%8F%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B.webp"></p><h2 id="客户端与服务器可以建立多少连接？如何建立"><a href="#客户端与服务器可以建立多少连接？如何建立" class="headerlink" title="客户端与服务器可以建立多少连接？如何建立"></a>客户端与服务器可以建立多少连接？如何建立</h2><h3 id="可以建立多少连接"><a href="#可以建立多少连接" class="headerlink" title="可以建立多少连接"></a>可以建立多少连接</h3><p>最大连接数，系统会用一个四元组来标识一个 TCP 连接。</p><p>{本机IP, 本机端口, 对端IP, 对端端口}</p><p>服务器通常固定在某个本地端口上监听，等待客户端的连接请求。因此，服务端端 TCP 连接四元组中只有对端 IP, 也就是客户端的 IP 和对端的端口，也即客户端的端口是可变的，因此，最大 TCP 连接数 &#x3D; 客户端 IP 数×客户端端口数。对 IPv4，客户端的 IP 数最多为 2 的 32 次方，客户端的端口数最多为 2 的 16 次方，也就是服务端单机最大 TCP 连接数，约为 2 的 48 次方。</p><p>当然，服务端最大并发 TCP 连接数远不能达到理论上限。首先主要是文件描述符限制，按照上面的原理，Socket 都是文件，所以首先要通过 ulimit 配置文件描述符的数目；另一个限制是内存，按上面的数据结构，每个 TCP 连接都要占用一定内存，操作系统是有限的。</p><h3 id="如何建立"><a href="#如何建立" class="headerlink" title="如何建立"></a>如何建立</h3><h4 id="多进程方式"><a href="#多进程方式" class="headerlink" title="多进程方式"></a>多进程方式</h4><p>这就相当于你是一个代理，在那里监听来的请求。一旦建立了一个连接，就会有一个已连接 Socket，这时候你可以创建一个子进程，然后将基于已连接 Socket 的交互交给这个新的子进程来做。</p><p>在 Linux 下，创建子进程使用 fork 函数。通过名字可以看出，这是在父进程的基础上完全拷贝一个子进程。在 Linux 内核中，会复制文件描述符的列表，也会复制内存空间，还会复制一条记录当前执行到了哪一行程序的进程。显然，复制的时候在调用 fork，复制完毕之后，父进程和子进程都会记录当前刚刚执行完 fork。这两个进程刚复制完的时候，几乎一模一样，只是根据 fork 的返回值来区分到底是父进程，还是子进程。如果返回值是 0，则是子进程；如果返回值是其他的整数，就是父进程。</p><p><img src="/.com//fork%E8%BF%9B%E7%A8%8B%E5%A4%8D%E5%88%B6%E8%BF%87%E7%A8%8B.jpg"></p><p>因为复制了文件描述符列表，而文件描述符都是指向整个内核统一的打开文件列表的，因而父进程刚才因为 accept 创建的已连接 Socket 也是一个文件描述符，同样也会被子进程获得。</p><p>接下来，子进程就可以通过这个已连接 Socket 和客户端进行互通了，当通信完毕之后，就可以退出进程，那父进程如何知道子进程干完了项目，要退出呢？还记得 fork 返回的时候，如果是整数就是父进程吗？这个整数就是子进程的 ID，父进程可以通过这个 ID 查看子进程是否完成项目，是否需要退出。</p><h4 id="多线程方式"><a href="#多线程方式" class="headerlink" title="多线程方式"></a>多线程方式</h4><p>进程的成本太大。</p><p>多线程方式。</p><p>在 Linux 下，通过 pthread_create 创建一个线程，也是调用 do_fork。不同的是，虽然新的线程在 task 列表会新创建一项，但是很多资源，例如文件描述符列表、进程空间，还是共享的，只不过多了一个引用而已。</p><p><img src="/.com//linux%E7%BA%BF%E7%A8%8B%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B.webp"></p><p>新的线程也可以通过已连接 Socket 处理请求，从而达到并发处理的目的。</p><h4 id="C10K问题"><a href="#C10K问题" class="headerlink" title="C10K问题"></a>C10K问题</h4><p>一台机器无法创建很多进程或者线程。有个 C10K，它的意思是一台机器要维护 1 万个连接，就要创建 1 万个进程或者线程，那么操作系统是无法承受的。如果维持 1 亿用户在线需要 10 万台服务器，成本也太高了。</p><h4 id="IO-多路复用，派人盯着"><a href="#IO-多路复用，派人盯着" class="headerlink" title="IO 多路复用，派人盯着"></a>IO 多路复用，派人盯着</h4><p>一个线程可以维护多个socket。</p><p>由于 Socket 是文件描述符，因而某个线程盯的所有的 Socket，都放在一个文件描述符集合 fd_set 中，然后调用 select 函数来监听文件描述符集合是否有变化。一旦有变化，就会依次查看每个文件描述符。那些发生变化的文件描述符在 fd_set 对应的位都设为 1，表示 Socket 可读或者可写，从而可以进行读写操作，然后再调用 select，接着盯着下一轮的变化。</p><h4 id="IO-多路复用，有事通知"><a href="#IO-多路复用，有事通知" class="headerlink" title="IO 多路复用，有事通知"></a>IO 多路复用，有事通知</h4><p>上面 select 函数还是有问题的，因为每次 Socket 所在的文件描述符集合中有 Socket 发生变化的时候，都需要通过轮询的方式。因而使用 select，能够同时盯的项目数量由 FD_SETSIZE 限制。</p><p>如果改成事件通知的方式，情况就会好很多，项目组不需要通过轮询挨个盯着这些项目，而是当项目进度发生变化的时候，主动通知项目组，然后项目组再根据项目进展情况做相应的操作。</p><p>能完成这件事情的函数叫 epoll，它在内核中的实现不是通过轮询的方式，而是通过注册 callback 函数的方式，当某个文件描述符发送变化的时候，就会主动通知。</p><p><img src="/.com//epoll%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.webp"></p><p>如图所示，假设进程打开了 Socket m, n, x 等多个文件描述符，现在需要通过 epoll 来监听是否这些 Socket 都有事件发生。其中 epoll_create 创建一个 epoll 对象，也是一个文件，也对应一个文件描述符，同样也对应着打开文件列表中的一项。在这项里面有一个红黑树，在红黑树里，要保存这个 epoll 要监听的所有 Socket。</p><p>当 epoll_ctl 添加一个 Socket 的时候，其实是加入这个红黑树，同时红黑树里面的节点指向一个结构，将这个结构挂在被监听的 Socket 的事件列表中。当一个 Socket 来了一个事件的时候，可以从这个列表中得到 epoll 对象，并调用 call  back 通知它。</p><p>这种通知方式使得监听的 Socket 数据增加的时候，效率不会大幅度降低，能够同时监听的 Socket 的数目也非常的多了。上限就为系统定义的、进程打开的最大文件描述符个数。因而，epoll 被称为解决 C10K 问题的利器。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议11TCP下</title>
    <link href="/2023/07/10/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE12TCP%E4%B8%8B/"/>
    <url>/2023/07/10/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE12TCP%E4%B8%8B/</url>
    
    <content type="html"><![CDATA[<h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><p>TCP使用”缓存”来记录接收与发送，用序号来标识包，如果收到确认，把该序号的包标识为已确认，如果超时未收到包确认，主动发送一个该序号的包。</p><p>TCP为了保证顺序性，每一个包都有一个序号，然后一个个的发送，为了保证不丢包，对于发送的包都要有应答，这个应答不是一个个应答，而是应答某个之前的序号，这种模式称为累计确认或者累计应答(cumulative acknowledgment)。</p><h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p>为了记录所有发送的包和接收的包，TCP 也需要发送端和接收端分别都有缓存来保存这些记录。</p><h4 id="发送端的缓存"><a href="#发送端的缓存" class="headerlink" title="发送端的缓存"></a>发送端的缓存</h4><p>发送端的缓存里是按照包的 ID 一个个排列，根据处理的情况分成四个部分。</p><p>第一部分：发送了并且已经确认的。</p><p>第二部分：发送了并且尚未确认的。</p><p>第三部分：没有发送，但是已经等待发送的。</p><p>第四部分：没有发送，并且暂时还不会发送的。</p><p>在 TCP 里，接收端会给发送端报一个窗口的大小，叫 Advertised window。这个窗口的大小应该等于上面的第二部分加上第三部分，就是已经交代了没做完的加上马上要交代的。超过这个窗口的，接收端做不过来，就不能发送了。</p><p><img src="/.com//TCP%E5%8F%91%E9%80%81%E7%AB%AF%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.webp"></p><p>LastByteAcked：第一部分和第二部分的分界线</p><p>LastByteSent：第二部分和第三部分的分界线</p><p>LastByteAcked + AdvertisedWindow：第三部分和第四部分的分界线</p><h4 id="接收端的缓存"><a href="#接收端的缓存" class="headerlink" title="接收端的缓存"></a>接收端的缓存</h4><p>第一部分：接受并且确认过的。</p><p>第二部分：还没接收，但是马上就能接收的。</p><p>第三部分：还没接收，也没法接收的。</p><p><img src="/.com//TCP%E6%8E%A5%E6%94%B6%E7%AB%AF%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png"></p><p>LastByteRead：TCP缓冲区中读到的位置（LastByteRead 之后是已经接收了，但是还没被应用层读取的）</p><p>NextByteExpected：收到的连续包的最后一个位置</p><p>LastByteRcved：收到的包的最后一个位置</p><p>NextByteExpected ~ LastByteRcved区间：未到达的数据区间</p><p>LastByteRead ~ NextByteExpected区间：已收到的数据区间</p><p>MaxRcvBuffer：最大缓存的量</p><p>NextByteExpected值与LastByteRead值因为应用层的读取和接收包变化。所以AdvertisedWindow是个变化的值。</p><p>NextByteExpected 和 LastByteRead 的差其实是还没被应用层读取的部分占用掉的 MaxRcvBuffer 的量，我们定义为 A。</p><p>AdvertisedWindow 其实是 MaxRcvBuffer 减去 A。也就是：AdvertisedWindow&#x3D;MaxRcvBuffer-((NextByteExpected-1)-LastByteRead)。</p><h3 id="确认与重发的机制-解决顺序与丢包问题"><a href="#确认与重发的机制-解决顺序与丢包问题" class="headerlink" title="确认与重发的机制 解决顺序与丢包问题"></a>确认与重发的机制 解决顺序与丢包问题</h3><h4 id="超时重试"><a href="#超时重试" class="headerlink" title="超时重试"></a>超时重试</h4><p>每一个发送了，但是没有 ACK 的包，都有设一个定时器，超过了一定的时间，就重新尝试。但是这个超时的时间如何评估呢？这个时间不宜过短，时间必须大于往返时间 RTT，否则会引起不必要的重传。也不宜过长，这样超时时间变长，访问就变慢了。</p><p>估计往返时间，需要 TCP 通过采样 RTT 的时间，然后进行加权平均，算出一个值，而且这个值还是要不断变化的，因为网络状况不断地变化。除了采样 RTT，还要采样 RTT 的波动范围，计算出一个估计的超时时间。由于重传时间是不断变化的，我们称为自适应重传算法（Adaptive Retransmission Algorithm）。</p><p>TCP 的策略是超时间隔加倍。每当遇到一次超时重传的时候，都会将下一次超时时间间隔设为先前值的两倍。两次超时，就说明网络环境差，不宜频繁反复发送。</p><p>超时触发重传存在的问题是，超时周期可能相对较长。那是不是可以有更快的方式呢？</p><p>有一个可以快速重传的机制，当接收方收到一个序号大于下一个所期望的报文段时，就会检测到数据流中的一个间隔，于是它就会发送冗余的 ACK，仍然 ACK 的是期望接收的报文段。而当客户端收到三个冗余的 ACK 后，就会在定时器过期之前，重传丢失的报文段。</p><p>例如，接收方发现 6 收到了，8 也收到了，但是 7 还没来，那肯定是丢了，于是发送 6 的 ACK，要求下一个是 7。接下来，收到后续的包，仍然发送 6 的 ACK，要求下一个是 7。当客户端收到 3 个重复 ACK，就会发现 7 的确丢了，不等超时，马上重发。</p><p>还有一种方式称为 Selective Acknowledgment  （SACK）。这种方式需要在 TCP 头里加一个 SACK 的东西，可以将缓存的地图发送给发送方。例如可以发送 ACK6、SACK8、SACK9，有了地图，发送方一下子就能看出来是 7 丢了。</p><h4 id="流量控制问题"><a href="#流量控制问题" class="headerlink" title="流量控制问题"></a>流量控制问题</h4><p>在对于包的确认中，同时会携带一个窗口的大小。</p><p>假设窗口大小固定为9。</p><p>就是一端在发送，一端在接收，如果接收的慢，变导致发送的窗口变为0。就是让发送端别发了。</p><p>如果应用层一直不读取接收端的数据，也会导至窗口变为0。</p><p>如果这样的话，发送方会定时发送窗口探测数据包，看是否有机会调整窗口的大小。当接收方比较慢的时候，要防止低能窗口综合征，别空出一个字节来就赶快告诉发送方，然后马上又填满了，可以当窗口太小的时候，不更新窗口，直到达到一定大小，或者缓冲区一半为空，才更新窗口。这就是我们常说的流量控制。</p><h4 id="拥塞控制问题"><a href="#拥塞控制问题" class="headerlink" title="拥塞控制问题"></a>拥塞控制问题</h4><p>拥塞控制，也是通过窗口的大小来控制的，前面的滑动窗口 rwnd 是怕发送方把接收方缓存塞满，而拥塞窗口 cwnd，是怕把网络塞满。</p><p>这里有一个公式 LastByteSent - LastByteAcked &lt;&#x3D; min {cwnd, rwnd} ，是拥塞窗口和滑动窗口共同控制发送的速度。</p><p>如果拥塞窗口较小，说明网络状况不好，需要发慢点。 如果滑动窗口小，你网络状况好没用，接收方处理不了你的快速度，你只能降下来速度。</p><p>TCP 的拥塞控制就是在不堵塞，不丢包的情况下，尽量发挥带宽。</p><p>于是 TCP 的拥塞控制主要来避免两种现象，包丢失和超时重传。</p><p>一旦出现了这些现象就说明，发送速度太快了，要慢一点。但是一开始我怎么知道速度多快呢，我怎么知道应该把窗口调整到多大呢？</p><p>一条 TCP 连接开始，cwnd 设置为一个报文段，一次只能发送一个；</p><p>当收到这一个确认的时候，cwnd 加一，于是一次能够发送两个；</p><p>当这两个的确认到来的时候，每个确认 cwnd 加一，两个确认 cwnd 加二，于是一次能够发送四个；</p><p>当这四个的确认到来的时候，每个确认 cwnd 加一，四个确认 cwnd 加四，于是一次能够发送八个。</p><p>可以看出这是指数性的增长。</p><p>有一个值 ssthresh 为 65535 个字节，当超过这个值的时候，就要小心一点了，不能倒这么快了，可能快满了，再慢下来。</p><p>每收到一个确认后，cwnd 增加 1&#x2F;cwnd，我们接着上面的过程来，一次发送八个，当八个确认到来的时候，每个确认增加 1&#x2F;8，八个确认一共 cwnd 增加 1，于是一次能够发送九个，变成了线性增长。</p><p>但是线性增长还是增长，还是越来越多，直到有一天，水满则溢，出现了拥塞，这时候一般就会一下子降低倒水的速度，等待溢出的水慢慢渗下去。</p><p>拥塞的一种表现形式是丢包，需要超时重传，这个时候，将 sshresh 设为 cwnd&#x2F;2，将 cwnd 设为 1，重新开始慢启动。这真是一旦超时重传，马上回到解放前。但是这种方式太激进了，将一个高速的传输速度一下子停了下来，会造成网络卡顿。</p><p>前面我们讲过快速重传算法。当接收端发现丢了一个中间包的时候，发送三次前一个包的 ACK，于是发送端就会快速地重传，不必等待超时再重传。TCP 认为这种情况不严重，因为大部分没丢，只丢了一小部分，cwnd 减半为 cwnd&#x2F;2，然后 sshthresh &#x3D; cwnd，当三个包返回的时候，cwnd &#x3D; sshthresh + 3，也就是没有一夜回到解放前，而是还在比较高的值，呈线性增长。</p><p>TCP 的拥塞控制主要来避免的两个现象都是有问题的。</p><p>第一个问题是丢包并不代表着通道满了，也可能是管子本来就漏水。例如公网上带宽不满也会丢包，这个时候就认为拥塞了，退缩了，其实是不对的。</p><p>第二个问题是 TCP 的拥塞控制要等到将中间设备都填充满了，才发生丢包，从而降低速度，这时候已经晚了。其实 TCP 只要填满管道就可以了，不应该接着填，直到连缓存也填满。</p><p>为了优化这两个问题，后来有了 TCP BBR 拥塞算法。它企图找到一个平衡点，就是通过不断地加快发送速度，将管道填满，但是不要填满中间设备的缓存，因为这样时延会增加，在这个平衡点可以很好的达到高带宽和低时延的平衡。</p><p><img src="/.com//TCPBBR%E7%AE%97%E6%B3%95%E5%AF%B9%E6%AF%94%E5%9B%BE.webp"></p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议11TCP上</title>
    <link href="/2023/07/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE11TCP%E4%B8%8A/"/>
    <url>/2023/07/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE11TCP%E4%B8%8A/</url>
    
    <content type="html"><![CDATA[<h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><h3 id="TCP包头"><a href="#TCP包头" class="headerlink" title="TCP包头"></a>TCP包头</h3><p><img src="/.com//TCP%E5%A4%B4.webp"></p><p>首先，源端口号和目标端口号是不可少的，这一点和 UDP 是一样的。如果没有这两个端口号。数据就不知道应该发给哪个应用。</p><p>接下来是包的序号。当然是为了解决乱序的问题。</p><p>还应该有的就是确认序号。发出去的包应该有确认，要不然我怎么知道对方有没有收到呢？如果没有收到就应该重新发送，直到送达。这个可以解决不丢包的问题。作为老司机，做事当然要靠谱，答应了就要做到，暂时做不到也要有个回复。</p><p>接下来有一些状态位。 SYN 是发起一个连接，ACK 是回复，RST 是重新连接，FIN 是结束连接等。TCP 是面向连接的，因而双方要维护连接的状态，这些带状态位的包的发送，会引起双方的状态变更。</p><p>还有一个重要的就是窗口大小。TCP 要做流量控制，通信双方各声明一个窗口，标识自己当前能够的处理能力，别发送的太快，撑死我，也别发的太慢，饿死我。</p><p>TCP 还会做拥塞控制，对于真正的通路堵车不堵车，它无能为力，唯一能做的就是控制自己，也即控制发送的速度。不能改变世界，就改变自己嘛。</p><p>通过对 TCP 头的解析，我们知道要掌握 TCP 协议，重点应该关注以下几个问题：</p><p>顺序问题 ，稳重不乱；</p><p>丢包问题，承诺靠谱；</p><p>连接维护，有始有终；</p><p>流量控制，把握分寸；</p><p>拥塞控制，知进知退。</p><h3 id="TCP-的三次握手"><a href="#TCP-的三次握手" class="headerlink" title="TCP 的三次握手"></a>TCP 的三次握手</h3><p>所有的问题，首先都要先建立一个连接，所以我们先来看连接维护问题。</p><p>TCP 的连接建立，我们常常称为三次握手。</p><p>A：您好，我是 A。</p><p>B：您好 A，我是 B。</p><p>A：您好 B。</p><p>我们也常称为“请求 -&gt; 应答 -&gt; 应答之应答”的三个回合。</p><h4 id="为什么不是两次？"><a href="#为什么不是两次？" class="headerlink" title="为什么不是两次？"></a>为什么不是两次？</h4><p>因为两次不能信息对等，还会造成超时脏连接。</p><p><img src="/.com//TCP%E4%BF%A1%E6%81%AF%E5%AF%B9%E7%AD%89.webp"></p><p>只有经历三次握手后，才能确定双端都具有收发能力。</p><p><img src="/.com//TCP%E8%B6%85%E6%97%B6%E8%84%8F%E8%BF%9E%E6%8E%A5.webp"></p><p>如果两次握手就可以创建连接，重新发送的连接请求传输数据并释放连接后，第一个超时的连接请求才到达 B 机器的话，B 机器会以为是 A 创建新连接的请求，然后确认同意创建连接。因为 A 机器的状态不是 SYN_SENT，所以直接丢弃了 B 的确认数据，以致最后只是 B 机器单方面创建连接完毕。 </p><p>如果是三次握手，则 B 机器收到连接请求后，同样会向 A 机器确认同意创建连接，但因为 A 机器不是 SYN_SENT 状态，所以会直接丢弃，B 机器由于长时间没有收到确认信息，最终超时导致连接创建失败，因而不会出现脏连接。</p><h4 id="为什么不是四次？"><a href="#为什么不是四次？" class="headerlink" title="为什么不是四次？"></a>为什么不是四次？</h4><p>四次是可以的，四十次也是可以的，但是多次与三次的效果是一样的，多次也无法保证多次之后的下一次就肯定到达对方。</p><h4 id="三次握手之沟通序号"><a href="#三次握手之沟通序号" class="headerlink" title="三次握手之沟通序号"></a>三次握手之沟通序号</h4><h5 id="序号为什么不能从1开始"><a href="#序号为什么不能从1开始" class="headerlink" title="序号为什么不能从1开始"></a>序号为什么不能从1开始</h5><p>因为这样往往会出现冲突。</p><p>例如，如果一直从序号1开始，A 连上 B 之后，发送了 1、2、3 三个包，但是发送 3 的时候，中间丢了，或者绕路了，于是重新发送，后来 A 掉线了，重新连上 B 后，序号又从 1 开始，然后发送 2，但是压根没想发送 3，但是上次绕路的那个 3 又回来了，发给了 B，B 自然认为，这就是下一个包，于是发生了错误。</p><h5 id="序号的生成"><a href="#序号的生成" class="headerlink" title="序号的生成"></a>序号的生成</h5><p>每个连接都要有不同的序号。这个序号的起始序号是随着时间变化的，可以看成一个 32 位的计数器，每 4 微秒加一，如果计算一下，如果到重复，需要 4 个多小时，那个绕路的包早就死翘翘了，因为我们都知道 IP 包头里面有个 TTL，也即生存时间。</p><h4 id="三次握手总结"><a href="#三次握手总结" class="headerlink" title="三次握手总结"></a>三次握手总结</h4><p><img src="/.com//TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E7%8A%B6%E6%80%81%E4%B8%8E%E5%BA%8F%E5%8F%B7.webp"></p><p>一开始，客户端和服务端都处于 CLOSED 状态。先是服务端主动监听某个端口，处于 LISTEN 状态。然后客户端主动发起连接 SYN，之后处于 SYN-SENT 状态。服务端收到发起的连接，返回 SYN，并且 ACK 客户端的 SYN，之后处于 SYN-RCVD 状态。客户端收到服务端发送的 SYN 和 ACK 之后，发送 ACK 的 ACK，之后处于 ESTABLISHED 状态，因为它一发一收成功了。服务端收到 ACK 的 ACK 之后，处于 ESTABLISHED 状态，因为它也一发一收了。</p><h3 id="TCP-四次挥手"><a href="#TCP-四次挥手" class="headerlink" title="TCP 四次挥手"></a>TCP 四次挥手</h3><p>A：B 啊，我不想玩了。</p><p>B：哦，你不想玩了啊，我知道了。</p><p>这个时候，还只是 A 不想玩了，也即 A 不会再发送数据，但是 B 能不能在 ACK 的时候，直接关闭呢？当然不可以了，很有可能 A 是发完了最后的数据就准备不玩了，但是 B 还没做完自己的事情，还是可以发送数据的，所以称为半关闭的状态。</p><p>这个时候 A 可以选择不再接收数据了，也可以选择最后再接收一段数据，等待 B 也主动关闭。</p><p>B：A 啊，好吧，我也不玩了，拜拜。</p><p>A：好的，拜拜。</p><p>一种情况是，A 说完“不玩了”之后，直接跑路，是会有问题的，因为 B 还没有发起结束，而如果 A 跑路，B 就算发起结束，也得不到回答，B 就不知道该怎么办了。</p><p>另一种情况是，A 说完“不玩了”，B 直接跑路，也是有问题的，因为 A 不知道 B 是还有事情要处理，还是过一会儿会发送结束。</p><p>TCP 协议专门设计了几个状态来处理这些问题。我们来看断开连接的时候的状态时序图。</p><p><img src="/.com//TCP%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%8A%B6%E6%80%81%E5%9B%BE.webp"></p><p>断开的时候，我们可以看到，当 A 说“不玩了”，就进入 FIN_WAIT_1 的状态，B 收到“A 不玩”的消息后，发送知道了，就进入 CLOSE_WAIT 的状态。</p><p>A 收到“B 说知道了”，就进入 FIN_WAIT_2 的状态，如果这个时候 B 直接跑路，则 A 将永远在这个状态。TCP 协议里面并没有对这个状态的处理，但是 Linux 有，可以调整 tcp_fin_timeout 这个参数，设置一个超时时间。</p><p>如果 B 没有跑路，发送了“B 也不玩了”的请求到达 A 时，A 发送“知道 B 也不玩了”的 ACK 后，从 FIN_WAIT_2 状态结束，按说 A 可以跑路了，但是最后的这个 ACK 万一 B 收不到呢？则 B 会重新发一个“B 不玩了”，这个时候 A 已经跑路了的话，B 就再也收不到 ACK 了，因而 TCP 协议要求 A 最后等待一段时间 TIME_WAIT，这个时间要足够长，长到如果 B 没收到 ACK 的话，“B 说不玩了”会重发的，A 会重新发一个 ACK 并且足够时间到达 B。</p><p>A 直接跑路还有一个问题是，A 的端口就直接空出来了，但是 B 不知道，B 原来发过的很多包很可能还在路上，如果 A 的端口被一个新的应用占用了，这个新的应用会收到上个连接中 B 发过来的包，虽然序列号是重新生成的，但是这里要上一个双保险，防止产生混乱，因而也需要等足够长的时间，等到原来 B 发送的所有的包都死翘翘，再空出端口来。</p><p>等待的时间设为 2MSL，MSL 是 Maximum Segment Lifetime，报文最大生存时间，它是任何报文在网络上存在的最长时间，超过这个时间报文将被丢弃。因为 TCP 报文基于是 IP 协议的，而 IP 头中有一个 TTL 域，是 IP 数据报可以经过的最大路由数，每经过一个处理他的路由器此值就减 1，当此值为 0 则数据报将被丢弃，同时发送 ICMP 报文通知源主机。协议规定 MSL 为 2 分钟，实际应用中常用的是 30 秒，1 分钟和 2 分钟等。</p><p>还有一个异常情况就是，B 超过了 2MSL 的时间，依然没有收到它发的 FIN 的 ACK，怎么办呢？按照 TCP 的原理，B 当然还会重发 FIN，这个时候 A 再收到这个包之后，A 就表示，我已经在这里等了这么长时间了，已经仁至义尽了，之后的我就都不认了，于是就直接发送 RST，B 就知道 A 早就跑了。</p><h3 id="TCP状态机"><a href="#TCP状态机" class="headerlink" title="TCP状态机"></a>TCP状态机</h3><p><img src="/.com//TCP%E7%8A%B6%E6%80%81%E6%9C%BA.webp"></p><p>在这个图中，加黑加粗的部分，是上面说到的主要流程，其中阿拉伯数字的序号，是连接过程中的顺序，而大写中文数字的序号，是连接断开过程中的顺序。加粗的实线是客户端 A 的状态变迁，加粗的虚线是服务端 B 的状态变迁。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议08网关</title>
    <link href="/2023/07/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE08%E7%BD%91%E5%85%B3/"/>
    <url>/2023/07/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE08%E7%BD%91%E5%85%B3/</url>
    
    <content type="html"><![CDATA[<h2 id="如何上可以访问百度的网"><a href="#如何上可以访问百度的网" class="headerlink" title="如何上可以访问百度的网"></a>如何上可以访问百度的网</h2><p>几台电脑用集线器或交换机连接起来形成一个网络，这种只能互相访问，不能去外网访问。</p><p>想上外网，只有运营商给你开网，运营商可以给学校、公司等机构分配网络号或者IP。</p><p>宿舍网给你的IP为192.168.1.x。 学校给你的IP为10.10.x.x。</p><h3 id="学校给你IP了，你如何上网？"><a href="#学校给你IP了，你如何上网？" class="headerlink" title="学校给你IP了，你如何上网？"></a>学校给你IP了，你如何上网？</h3><p>方法一：让你们宿舍其中的一台电脑拥有双网卡。然后新网卡设置为学校给你们宿舍的IP。这种情况下，如果你们宿舍的人要上网，就需要一直开着这台的电脑。</p><p>方法二：买个家庭路由。外网口插入学校给你们宿舍的网线，内网口你们连上。这种情况下，如果你们宿舍的人要上网，就需要一直开着路由器。</p><p>这两种方法是一样的。家庭路由器其实就是嵌入式的系统。</p><h2 id="路由器"><a href="#路由器" class="headerlink" title="路由器"></a>路由器</h2><h3 id="IP头和MAC头"><a href="#IP头和MAC头" class="headerlink" title="IP头和MAC头"></a>IP头和MAC头</h3><p><img src="/.com//IP%E5%A4%B4%E4%B8%8EMAC%E5%A4%B4.webp"></p><p>在 MAC 头里面，先是目标 MAC 地址，然后是源 MAC 地址，然后有一个协议类型，用来说明里面是 IP 协议。IP 头里面的版本号，目前主流的还是 IPv4，服务类型 TOS 在第三节讲 ip addr 命令的时候讲过，TTL 在第 7 节讲 ICMP 协议的时候讲过。另外，还有 8 位标识协议。这里到了下一层的协议，也就是，是 TCP 还是 UDP。最重要的就是源 IP 和目标 IP。先是源 IP 地址，然后是目标 IP 地址。</p><h3 id="网段判定"><a href="#网段判定" class="headerlink" title="网段判定"></a>网段判定</h3><p>在任何一台机器上，当要访问另一个 IP 地址的时候，都会先判断，这个目标 IP 地址，和当前机器的 IP 地址，是否在同一个网段。</p><p><strong>怎么判断同一个网段呢？</strong>需要 CIDR 和子网掩码。</p><p><strong>如果是同一个网段，</strong>例如，你访问你旁边的兄弟的电脑，那就没网关什么事情，直接将源地址和目标地址放入 IP 头中，然后通过 ARP 获得 MAC 地址，将源 MAC 和目的 MAC 放入 MAC 头中，发出去就可以了。</p><p><strong>如果不是同一网段，</strong>例如，你要访问你们校园网里面的 BBS，该怎么办？这就需要发往默认网关 Gateway。Gateway 的地址一定是和源 IP 地址是一个网段的。往往不是第一个，就是第二个。例如 192.168.1.0&#x2F;24 这个网段，Gateway 往往会是 192.168.1.1&#x2F;24 或者 192.168.1.2&#x2F;24。</p><p>如何发往默认网关呢？网关不是和源 IP 地址是一个网段的么？这个过程就和发往同一个网段的其他机器是一样的：将源地址和目标 IP 地址放入 IP 头中，通过 ARP 获得网关的 MAC 地址，将源 MAC 和网关的 MAC 放入 MAC 头中，发送出去。网关所在的端口，例如 192.168.1.1&#x2F;24 将网络包收进来，然后接下来怎么做，就完全看网关的了。</p><p><strong>网关往往是一个路由器，</strong>是一个三层转发的设备。啥叫三层设备？前面也说过了，就是把 MAC 头和 IP 头都取下来，然后根据里面的内容，看看接下来把包往哪里转发的设备。</p><p>在你的宿舍里面，网关就是你宿舍长的电脑。一个路由器往往有多个网口，如果是一台服务器做这个事情，则就有多个网卡，其中一个网卡是和源 IP 同网段的。</p><p>很多情况下，人们把网关就叫做路由器。其实不完全准确，而另一种比喻更加恰当：路由器是一台设备，它有五个网口或者网卡，相当于有五只手，分别连着五个局域网。每只手的 IP 地址都和局域网的 IP 地址相同的网段，每只手都是它握住的那个局域网的网关。</p><p>任何一个想发往其他局域网的包，都会到达其中一只手，被拿进来，拿下 MAC 头和 IP 头，看看，根据自己的路由算法，选择另一只手，加上 IP 头和 MAC 头，然后扔出去。</p><h3 id="路由规则"><a href="#路由规则" class="headerlink" title="路由规则"></a>路由规则</h3><p>一个是静态路由，一个是动态路由。</p><h4 id="静态路由"><a href="#静态路由" class="headerlink" title="静态路由"></a>静态路由</h4><p>静态路由，其实就是在路由器上，配置一条一条规则。这些规则包括：想访问 BBS 站（它肯定有个网段），从 2 号口出去，下一跳是 IP2；想访问教学视频站（它也有个自己的网段），从 3 号口出去，下一跳是 IP3，然后保存在路由器里。</p><p>每当要选择从哪只手抛出去的时候，就一条一条的匹配规则，找到符合的规则，就按规则中设置的那样，从某个口抛出去，找下一跳 IPX。</p><h3 id="转发网关与NAT网关"><a href="#转发网关与NAT网关" class="headerlink" title="转发网关与NAT网关"></a>转发网关与NAT网关</h3><p>MAC 地址是一个局域网内才有效的地址。</p><p>因而，MAC 地址只要过网关，就必定会改变，因为已经换了局域网。两者主要的区别在于 IP 地址是否改变。</p><p>不改变 IP 地址的网关，我们称为转发网关；</p><p>改变 IP 地址的网关，我们称为NAT 网关。</p><h4 id="转发网关"><a href="#转发网关" class="headerlink" title="转发网关"></a>转发网关</h4><p><img src="/.com//%E8%BD%AC%E5%8F%91%E7%BD%91%E5%85%B3.webp"></p><p>服务器 A 要访问服务器 B。首先，服务器 A 会思考，192.168.4.101 和我不是一个网段的，因而需要先发给网关。那网关是谁呢？已经静态配置好了，网关是 192.168.1.1。网关的 MAC 地址是多少呢？发送 ARP 获取网关的 MAC 地址，然后发送包。包的内容是这样的：</p><p>源 MAC：服务器 A 的 MAC</p><p>目标 MAC：192.168.1.1 这个网口的 MAC</p><p>源 IP：192.168.1.101</p><p>目标 IP：192.168.4.101</p><p>包到达 192.168.1.1 这个网口，发现 MAC 一致，将包收进来，开始思考往哪里转发。</p><p>在路由器 A 中配置了静态路由之后，要想访问 192.168.4.0&#x2F;24，要从 192.168.56.1 这个口出去，下一跳为 192.168.56.2。</p><p>于是，路由器 A 思考的时候，匹配上了这条路由，要从 192.168.56.1 这个口发出去，发给 192.168.56.2，那 192.168.56.2 的 MAC 地址是多少呢？路由器 A 发送 ARP 获取 192.168.56.2 的 MAC 地址，然后发送包。包的内容是这样的：</p><p>源 MAC：192.168.56.1 的 MAC 地址</p><p>目标 MAC：192.168.56.2 的 MAC 地址</p><p>源 IP：192.168.1.101</p><p>目标 IP：192.168.4.101</p><p>包到达 192.168.56.2 这个网口，发现 MAC 一致，将包收进来，开始思考往哪里转发。</p><p>在路由器 B 中配置了静态路由，要想访问 192.168.4.0&#x2F;24，要从 192.168.4.1 这个口出去，没有下一跳了。因为我右手这个网卡，就是这个网段的，我是最后一跳了。</p><p>于是，路由器 B 思考的时候，匹配上了这条路由，要从 192.168.4.1 这个口发出去，发给 192.168.4.101。那 192.168.4.101 的 MAC 地址是多少呢？路由器 B 发送 ARP 获取 192.168.4.101 的 MAC 地址，然后发送包。包的内容是这样的：</p><p>源 MAC：192.168.4.1 的 MAC 地址</p><p>目标 MAC：192.168.4.101 的 MAC 地址</p><p>源 IP：192.168.1.101</p><p>目标 IP：192.168.4.101</p><p>包到达服务器 B，MAC 地址匹配，将包收进来。</p><p>通过这个过程可以看出，每到一个新的局域网，MAC 都是要变的，但是 IP 地址都不变。在 IP 头里面，不会保存任何网关的 IP 地址。所谓的下一跳是，某个 IP 要将这个 IP 地址转换为 MAC 放入 MAC 头。</p><h4 id="NAT网关"><a href="#NAT网关" class="headerlink" title="NAT网关"></a>NAT网关</h4><p><img src="/.com//NAT%E7%BD%91%E5%85%B3.webp"></p><p>局域网之间没有商量过，各定各的网段，因而 IP 段冲突了。最左面大唐的地址是 192.168.1.101，最右面印度的地址也是 192.168.1.101，如果单从 IP 地址上看，简直是自己访问自己，其实是大唐的 192.168.1.101 要访问印度的 192.168.1.101。</p><p>到国际上，也即中间的局域网里面，就需要使用另外的地址。就像出国，不能用咱们自己的身份证，而要改用护照一样。</p><p>首先，目标服务器 B 在国际上要有一个国际的身份，我们给它一个 192.168.56.2。在网关 B 上，我们记下来，国际身份 192.168.56.2 对应国内身份 192.168.1.101。凡是要访问 192.168.56.2，都转成 192.168.1.101。</p><p>于是，源服务器 A 要访问目标服务器 B，要指定的目标地址为 192.168.56.2。这是它的国际身份。服务器 A 想，192.168.56.2 和我不是一个网段的，因而需要发给网关，网关是谁？已经静态配置好了，网关是 192.168.1.1，网关的 MAC 地址是多少？发送 ARP 获取网关的 MAC 地址，然后发送包。包的内容是这样的：</p><p>源 MAC：服务器 A 的 MAC</p><p>目标 MAC：192.168.1.1 这个网口的 MAC</p><p>源 IP：192.168.1.101</p><p>目标 IP：192.168.56.2</p><p>包到达 192.168.1.1 这个网口，发现 MAC 一致，将包收进来，开始思考往哪里转发。</p><p>在路由器 A 中配置了静态路由：要想访问 192.168.56.2&#x2F;24，要从 192.168.56.1 这个口出去，没有下一跳了，因为我右手这个网卡，就是这个网段的，我是最后一跳了。</p><p>于是，路由器 A 思考的时候，匹配上了这条路由，要从 192.168.56.1 这个口发出去，发给 192.168.56.2。那 192.168.56.2 的 MAC 地址是多少呢？路由器 A 发送 ARP 获取 192.168.56.2 的 MAC 地址。</p><p>当网络包发送到中间的局域网的时候，服务器 A 也需要有个国际身份，因而在国际上，源 IP 地址也不能用 192.168.1.101，需要改成 192.168.56.1。发送包的内容是这样的：</p><p>源 MAC：192.168.56.1 的 MAC 地址</p><p>目标 MAC：192.168.56.2 的 MAC 地址</p><p>源 IP：192.168.56.1</p><p>目标 IP：192.168.56.2</p><p>包到达 192.168.56.2 这个网口，发现 MAC 一致，将包收进来，开始思考往哪里转发。</p><p>路由器 B 是一个 NAT 网关，它上面配置了，要访问国际身份 192.168.56.2 对应国内身份 192.168.1.101，于是改为访问 192.168.1.101。</p><p>在路由器 B 中配置了静态路由：要想访问 192.168.1.0&#x2F;24，要从 192.168.1.1 这个口出去，没有下一跳了，因为我右手这个网卡，就是这个网段的，我是最后一跳了。</p><p>于是，路由器 B 思考的时候，匹配上了这条路由，要从 192.168.1.1 这个口发出去，发给 192.168.1.101。</p><p>那 192.168.1.101 的 MAC 地址是多少呢？路由器 B 发送 ARP 获取 192.168.1.101 的 MAC 地址，然后发送包。内容是这样的：</p><p>源 MAC：192.168.1.1 的 MAC 地址</p><p>目标 MAC：192.168.1.101 的 MAC 地址</p><p>源 IP：192.168.56.1</p><p>目标 IP：192.168.1.101</p><p>包到达服务器 B，MAC 地址匹配，将包收进来。</p><p>从服务器 B 接收的包可以看出，源 IP 为服务器 A 的国际身份，因而发送返回包的时候，也发给这个国际身份，由路由器 A 做 NAT，转换为国内身份。</p><p>从这个过程可以看出，IP 地址也会变。这个过程用英文说就是 Network Address Translation，简称 NAT。</p><p>其实这第二种方式我们经常见，现在大家每家都有家用路由器，家里的网段都是 192.168.1.x，所以你肯定访问不了你邻居家的这个私网的 IP 地址的。所以，当我们家里的包发出去的时候，都被家用路由器 NAT 成为了运营商的地址了。</p><p>很多办公室访问外网的时候，也是被 NAT 过的，因为不可能办公室里面的 IP 也是公网可见的，公网地址实在是太贵了，所以一般就是整个办公室共用一个到两个出口 IP 地址。你可以通过 <a href="https://www.whatismyip.com/">https://www.whatismyip.com/</a> 查看自己的出口 IP 地址。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议09路由协议</title>
    <link href="/2023/07/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE09%E8%B7%AF%E7%94%B1%E5%8D%8F%E8%AE%AE/"/>
    <url>/2023/07/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE09%E8%B7%AF%E7%94%B1%E5%8D%8F%E8%AE%AE/</url>
    
    <content type="html"><![CDATA[<h2 id="路由表"><a href="#路由表" class="headerlink" title="路由表"></a>路由表</h2><p>路由器就是一台网络设备，它有多张网卡。当一个入口的网络包送到路由器时，它会根据一个本地的转发信息库，来决定如何正确地转发流量。这个转发信息库通常被称为路由表。</p><p>一张路由表中会有多条路由规则。每一条规则至少包含这三项信息。</p><p>目的网络：这个包想去哪儿？</p><p>出口设备：将包从哪个口扔出去？</p><p>下一跳网关：下一个路由器的地址。</p><p>通过 route 命令和 ip route 命令都可以进行查询或者配置。</p><p>例如，我们设置 ip route add 10.176.48.0&#x2F;20 via 10.173.32.1 dev eth0，就说明要去 10.176.48.0&#x2F;20 这个目标网络，要从 eth0 端口出去，经过 10.173.32.1。</p><p>网关上的路由策略就是按照这三项配置信息进行配置的。这种配置方式的一个核心思想是：根据目的 IP 地址来配置路由。</p><h2 id="策略路由"><a href="#策略路由" class="headerlink" title="策略路由"></a>策略路由</h2><p>在真实的复杂的网络环境中，除了可以根据目的 ip 地址配置路由外，还可以根据多个参数来配置路由，这就称为策略路由。</p><p>可以配置多个路由表，可以根据源 IP 地址、入口设备、TOS 等选择路由表，然后在路由表中查找路由。这样可以使得来自不同来源的包走不同的路由。</p><p>例如，我们设置：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><pre><code class="hljs pgsql">ip <span class="hljs-keyword">rule</span> <span class="hljs-keyword">add</span> <span class="hljs-keyword">from</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> <span class="hljs-keyword">table</span> <span class="hljs-number">10</span> <br>ip <span class="hljs-keyword">rule</span> <span class="hljs-keyword">add</span> <span class="hljs-keyword">from</span> <span class="hljs-number">192.168</span><span class="hljs-number">.2</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> <span class="hljs-keyword">table</span> <span class="hljs-number">20</span><br></code></pre></td></tr></table></figure><p>表示从 192.168.1.10&#x2F;24 这个网段来的，使用 table 10 中的路由表，而从 192.168.2.0&#x2F;24 网段来的，使用 table20 的路由表。</p><p>在一条路由规则中，也可以走多条路径。例如，在下面的路由规则中：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ip</span> route add default scope global nexthop via <span class="hljs-number">100.100.100.1</span> weight <span class="hljs-number">1</span> nexthop via <span class="hljs-number">200.200.200.1</span> weight <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>下一跳有两个地方，分别是 100.100.100.1 和 200.200.200.1，权重分别为 1 比 2。</p><p>例子：家里从运营商拉了两条网线，一条快，一条慢。</p><p><img src="/.com//%E5%AE%B6%E9%87%8C%E5%BF%AB%E6%85%A2%E7%BD%91%E7%AD%96%E7%95%A5%E8%B7%AF%E7%94%B1.webp"></p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">ip route list table main <br><span class="hljs-number">60.190.27.189</span>/<span class="hljs-number">30</span> dev eth3  proto kernel  scope link  src <span class="hljs-number">60</span>.<span class="hljs-number">190</span>.<span class="hljs-number">27</span>.<span class="hljs-number">190</span><br><span class="hljs-number">183.134.188.1</span> dev eth2  proto kernel  scope link  src <span class="hljs-number">183</span>.<span class="hljs-number">134</span>.<span class="hljs-number">189</span>.<span class="hljs-number">34</span><br><span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span> dev eth1  proto kernel  scope link  src <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">1</span><br><span class="hljs-number">127.0.0.0</span>/<span class="hljs-number">8</span> dev lo  scope link<br>default via <span class="hljs-number">183</span>.<span class="hljs-number">134</span>.<span class="hljs-number">188</span>.<span class="hljs-number">1</span> dev eth2<br></code></pre></td></tr></table></figure><p>当路由这样配置的时候，就告诉这个路由器如下的规则：</p><p>如果去运营商二，就走 eth3；</p><p>如果去运营商一呢，就走 eth2；</p><p>如果访问内网，就走 eth1；</p><p>如果所有的规则都匹配不上，默认走运营商一，也即走快的网络。</p><p>上面说的都是静态的路由，一般来说网络环境简单的时候，在自己的可控范围之内，自己捣鼓还是可以的。但是有时候网络环境复杂并且多变，如果总是用静态路由，一旦网络结构发生变化，让网络管理员手工修改路由太复杂了，因而需要动态路由算法。</p><h2 id="动态路由算法"><a href="#动态路由算法" class="headerlink" title="动态路由算法"></a>动态路由算法</h2><p>使用动态路由路由器，可以根据路由协议算法生成动态路由表，随网络运行状况的变化而变化。</p><p>我们把可以把网络抽象为一种叫作图的数据结构。网络传输路越少越好，道路越短越好。因而这就转化成为如何在图中找到最短路径的问题。</p><h3 id="1-距离矢量路由算法"><a href="#1-距离矢量路由算法" class="headerlink" title="1. 距离矢量路由算法"></a>1. 距离矢量路由算法</h3><p>第一大类的算法称为距离矢量路由（distance vector routing）。它是基于 Bellman-Ford 算法的。</p><p>这种算法的基本思路是，每个路由器都保存一个路由表，包含多行，每行对应网络中的一个路由器，每一行包含两部分信息，一个是要到目标路由器，从那条线出去，另一个是到目标路由器的距离。</p><p>由此可以看出，每个路由器都是知道全局信息的。那这个信息如何更新呢？每个路由器都知道自己和邻居之间的距离，每过几秒，每个路由器都将自己所知的到达所有的路由器的距离告知邻居，每个路由器也能从邻居那里得到相似的信息。</p><p>每个路由器根据新收集的信息，计算和其他路由器的距离，比如自己的一个邻居距离目标路由器的距离是 M，而自己距离邻居是 x，则自己距离目标路由器是 x+M。</p><h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><p>问题1：好消息传得快，坏消息传得慢。</p><p>如果有个路由器加入了这个网络，它的邻居就能很快发现它，然后将消息广播出去。要不了多久，整个网络就都知道了。但是一旦一个路由器挂了，挂的消息是没有广播的。当每个路由器发现原来的道路到不了这个路由器的时候，感觉不到它已经挂了，而是试图通过其他的路径访问，直到试过了所有的路径，才发现这个路由器是真的挂了。</p><p>问题2：每次发送的时候，要发送整个全局路由表。</p><p>网络大了，谁也受不了，所以最早的路由协议 RIP 就是这个算法。它适用于小型网络（小于 15 跳）。当网络规模都小的时候，没有问题。现在一个数据中心内部路由器数目就很多，因而不适用了。</p><p>所以上面的两个问题，限制了距离矢量路由的网络规模。</p><h3 id="2-链路状态路由算法"><a href="#2-链路状态路由算法" class="headerlink" title="2. 链路状态路由算法"></a>2. 链路状态路由算法</h3><p>第二大类算法是链路状态路由（link state routing），基于 Dijkstra 算法。</p><p>这种算法的基本思路是：当一个路由器启动的时候，首先是发现邻居，向邻居 say hello，邻居都回复。然后计算和邻居的距离，发送一个 echo，要求马上返回，除以二就是距离。然后将自己和邻居之间的链路状态包广播出去，发送到整个网络的每个路由器。这样每个路由器都能够收到它和邻居之间的关系的信息。因而，每个路由器都能在自己本地构建一个完整的图，然后针对这个图使用 Dijkstra 算法，找到两点之间的最短路径。</p><p>不像距离距离矢量路由协议那样，更新时发送整个路由表。链路状态路由协议只广播更新的或改变的网络拓扑，这使得更新信息更小，节省了带宽和 CPU 利用率。而且一旦一个路由器挂了，它的邻居都会广播这个消息，可以使得坏消息迅速收敛。</p><h2 id="动态路由协议"><a href="#动态路由协议" class="headerlink" title="动态路由协议"></a>动态路由协议</h2><h3 id="1-基于链路状态路由算法的-OSPF"><a href="#1-基于链路状态路由算法的-OSPF" class="headerlink" title="1. 基于链路状态路由算法的 OSPF"></a>1. 基于链路状态路由算法的 OSPF</h3><p>OSPF（Open Shortest Path First，开放式最短路径优先）就是这样一个基于链路状态路由协议，广泛应用在数据中心中的协议。由于主要用在数据中心内部，用于路由决策，因而称为内部网关协议（Interior Gateway Protocol，简称 IGP）。</p><p>内部网关协议的重点就是找到最短的路径。在一个组织内部，路径最短往往最优。当然有时候 OSPF 可以发现多个最短的路径，可以在这多个路径中进行负载均衡，这常常被称为等价路由。</p><p>这一点非常重要。有了等价路由，到一个地方去可以有相同的两个路线，可以分摊流量，还可以当一条路不通的时候，走另外一条路。这个在后面我们讲数据中心的网络的时候，一般应用的接入层会有负载均衡 LVS。它可以和 OSPF 一起，实现高吞吐量的接入层设计。</p><h3 id="2-基于距离矢量路由算法的-BGP"><a href="#2-基于距离矢量路由算法的-BGP" class="headerlink" title="2. 基于距离矢量路由算法的 BGP"></a>2. 基于距离矢量路由算法的 BGP</h3><p>我们称为外网路由协议（Border Gateway Protocol，简称 BGP）。外网的路由协议。</p><p>对于网络包同样，每个数据中心都设置自己的 Policy。例如，哪些外部的 IP 可以让内部知晓，哪些内部的 IP 可以让外部知晓，哪些可以通过，哪些不能通过。这就好比，虽然从我家里到目的地最近，但是不能谁都能从我家走啊！</p><p>在网络世界，这一个个国家成为自治系统 AS（Autonomous System）。自治系统分几种类型。</p><p>Stub AS：对外只有一个连接。这类 AS 不会传输其他 AS 的包。例如，个人或者小公司的网络。</p><p>Multihomed AS：可能有多个连接连到其他的 AS，但是大多拒绝帮其他的 AS 传输包。例如一些大公司的网络。</p><p>Transit AS：有多个连接连到其他的 AS，并且可以帮助其他的 AS 传输包。例如主干网。</p><p>每个自治系统都有边界路由器，通过它和外面的世界建立联系。</p><p><img src="/.com//%E5%A4%96%E7%BD%91%E8%B7%AF%E7%94%B1%E5%8D%8F%E8%AE%AE.webp"></p><p>BGP 又分为两类，eBGP 和 iBGP。自治系统间，边界路由器之间使用 eBGP 广播路由。内部网络也需要访问其他的自治系统。边界路由器如何将 BGP 学习到的路由导入到内部网络呢？就是通过运行 iBGP，使得内部的路由器能够找到到达外网目的地的最好的边界路由器。</p><p>BGP 协议使用的算法是路径矢量路由协议（path-vector protocol）。它是距离矢量路由协议的升级版。</p><p>前面说了距离矢量路由协议的缺点。其中一个是收敛慢。在 BGP 里面，除了下一跳 hop 之外，还包括了自治系统 AS 的路径，从而可以避免坏消息传得慢的问题，也即上面所描述的，B 知道 C 原来能够到达 A，是因为通过自己，一旦自己都到达不了 A 了，就不用假设 C 还能到达 A 了。</p><p>另外，在路径中将一个自治系统看成一个整体，不区分自治系统内部的路由器，这样自治系统的数目是非常有限的。就像大家都能记住出去玩，从中国出发先到韩国然后到日本，只要不计算细到具体哪一站，就算是发送全局信息，也是没有问题的。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议10UDP与TCP主讲UDP</title>
    <link href="/2023/07/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE10UDP%E4%B8%8ETCP%E4%B8%BB%E8%AE%B2UDP/"/>
    <url>/2023/07/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE10UDP%E4%B8%8ETCP%E4%B8%BB%E8%AE%B2UDP/</url>
    
    <content type="html"><![CDATA[<p>传输层里比较重要的两个协议，一个是 TCP，一个是 UDP。</p><h2 id="TCP-和-UDP-有哪些区别？"><a href="#TCP-和-UDP-有哪些区别？" class="headerlink" title="TCP 和 UDP 有哪些区别？"></a>TCP 和 UDP 有哪些区别？</h2><p>TCP 是面向连接的，UDP 是面向无连接的。</p><p>所谓的建立连接，是为了在客户端和服务端维护连接，而建立一定的数据结构来维护双方交互的状态，用这样的数据结构来保证所谓的面向连接的特性。</p><p>TCP 提供可靠交付。通过 TCP 连接传输的数据，无差错、不丢失、不重复、并且按序到达。</p><p> IP 包是没有任何可靠性保证的，一旦发出去，各种情况走丢了，都只能随它去。</p><p>UDP 继承了 IP 包的特性，不保证不丢失，不保证按顺序到达。</p><p>TCP 是面向字节流的。发送的时候发的是一个流，没头没尾。</p><p>IP 包可不是一个流，而是一个个的 IP 包。之所以变成了流，这也是 TCP 自己的状态维护做的事情。</p><p>而 UDP 继承了 IP 的特性，基于数据报的，一个一个地发，一个一个地收。</p><p>TCP 是可以有拥塞控制的。它意识到包丢弃了或者网络的环境不好了，就会根据情况调整自己的行为，看看是不是发快了，要不要发慢点。</p><p>UDP 就不会，应用让我发，我就发，管它洪水滔天。</p><p>TCP 其实是一个有状态服务，通俗地讲就是有脑子的，里面精确地记着发送了没有，接收到没有，发送到哪个了，应该接收哪个了，错一点儿都不行。</p><p>而 UDP 则是无状态服务。通俗地说是没脑子的，天真无邪的，发出去就发出去了。</p><p>我们可以这样比喻，如果 MAC 层定义了本地局域网的传输行为，IP 层定义了整个网络端到端的传输行为，这两层基本定义了这样的基因：网络传输是以包为单位的，二层叫帧，网络层叫包，传输层叫段。我们笼统地称为包。包单独传输，自行选路，在不同的设备封装解封装，不保证到达。基于这个基因，生下来的孩子 UDP 完全继承了这些特性，几乎没有自己的思想。</p><h2 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h2><p>当发送的包到达目标机器后，发现MAC地址匹配，把MAC头取下来，将剩下的包传给处理IP的代码。把IP头取下来，发现目标IP匹配，把IP头取下来，IP头中有一个协议字段，存着TCP还是UDP,知道了用的协议是UDP，又知道到UDP头的格式，就能从数据里面将它解析出来。（处理完传输层的事情，内核的事情基本就干完了，里面的数据应该交给应用程序自己去处理）</p><p>无论应用程序写的使用 TCP 传数据，还是 UDP 传数据，都要监听一个端口。</p><p>无论是 TCP 还是 UDP 包头里面应该有端口号，根据端口号，将数据交给相应的应用程序。</p><h3 id="UDP头"><a href="#UDP头" class="headerlink" title="UDP头"></a>UDP头</h3><p><img src="/.com//UDP%E5%A4%B4.webp"></p><p>当我们看到 UDP 包头的时候，发现的确有端口号，有源端口号和目标端口号。因为是两端通信嘛。</p><h3 id="UDP-的三大特点"><a href="#UDP-的三大特点" class="headerlink" title="UDP 的三大特点"></a>UDP 的三大特点</h3><p>第一，沟通简单，不需要一肚子花花肠子（大量的数据结构、处理逻辑、包头字段）。前提是它相信网络世界是美好的，秉承性善论，相信网络通路默认就是很容易送达的，不容易被丢弃的。</p><p>第二，轻信他人。它不会建立连接，虽然有端口号，但是监听在这个地方，谁都可以传给他数据，他也可以传给任何人数据，甚至可以同时传给多个人数据。</p><p>第三，愣头青，做事不懂权变。不知道什么时候该坚持，什么时候该退让。它不会根据网络的情况进行发包的拥塞控制，无论网络丢包丢成啥样了，它该怎么发还怎么发。</p><h3 id="UDP-的三大使用场景"><a href="#UDP-的三大使用场景" class="headerlink" title="UDP 的三大使用场景"></a>UDP 的三大使用场景</h3><p>第一，需要资源少，在网络情况比较好的内网，或者对于丢包不敏感的应用。</p><p>DHCP 就是基于 UDP 协议的。一般的获取 IP 地址都是内网请求，而且一次获取不到 IP 又没事，过一会儿还有机会。我们讲过 PXE 可以在启动的时候自动安装操作系统，操作系统镜像的下载使用的 TFTP，这个也是基于 UDP 协议的。在还没有操作系统的时候，客户端拥有的资源很少，不适合维护一个复杂的状态机，而且因为是内网，一般也没啥问题。</p><p>第二，不需要一对一沟通，建立连接，而是可以广播的应用。</p><p>UDP 的不面向连接的功能，可以使得可以承载广播或者多播的协议。DHCP 就是一种广播的形式，就是基于 UDP 协议的，而广播包的格式前面说过了。</p><p>对于多播，我们在讲 IP 地址的时候，讲过一个 D 类地址，也即组播地址，使用这个地址，可以将包组播给一批机器。当一台机器上的某个进程想监听某个组播地址的时候，需要发送 IGMP 包，所在网络的路由器就能收到这个包，知道有个机器上有个进程在监听这个组播地址。当路由器收到这个组播地址的时候，会将包转发给这台机器，这样就实现了跨路由器的组播。在后面云中网络部分，有一个协议 VXLAN，也是需要用到组播，也是基于 UDP 协议的。</p><p>第三，需要处理速度快，时延低，可以容忍少数丢包，但是要求即便网络拥塞，也毫不退缩，一往无前的时候。</p><h3 id="基于-UDP-的“城会玩”的五个例子"><a href="#基于-UDP-的“城会玩”的五个例子" class="headerlink" title="基于 UDP 的“城会玩”的五个例子"></a>基于 UDP 的“城会玩”的五个例子</h3><h4 id="“城会玩”一：网页或者-APP-的访问"><a href="#“城会玩”一：网页或者-APP-的访问" class="headerlink" title="“城会玩”一：网页或者 APP 的访问"></a>“城会玩”一：网页或者 APP 的访问</h4><p>原来访问网页和手机 APP 都是基于 HTTP 协议的。HTTP 协议是基于 TCP 的，建立连接都需要多次交互，对于时延比较大的目前主流的移动互联网来讲，建立一次连接需要的时间会比较长，然而既然是移动中，TCP 可能还会断了重连，也是很耗时的。而且目前的 HTTP 协议，往往采取多个数据通道共享一个连接的情况，这样本来为了加快传输速度，但是 TCP 的严格顺序策略使得哪怕共享通道，前一个不来，后一个和前一个即便没关系，也要等着，时延也会加大。</p><p>而 QUIC（全称 Quick UDP Internet Connections，快速 UDP 互联网连接）是 Google 提出的一种基于 UDP 改进的通信协议，其目的是降低网络通信的延迟，提供更好的用户互动体验。</p><p>QUIC 在应用层上，会自己实现快速连接建立、减少重传时延，自适应拥塞控制，是应用层“城会玩”的代表。这一节主要是讲 UDP，QUIC 我们放到应用层去讲。</p><h4 id="“城会玩”二：流媒体的协议"><a href="#“城会玩”二：流媒体的协议" class="headerlink" title="“城会玩”二：流媒体的协议"></a>“城会玩”二：流媒体的协议</h4><p>现在直播比较火，直播协议多使用 RTMP，这个协议我们后面的章节也会讲，而这个 RTMP 协议也是基于 TCP 的。TCP 的严格顺序传输要保证前一个收到了，下一个才能确认，如果前一个收不到，下一个就算包已经收到了，在缓存里面，也需要等着。对于直播来讲，这显然是不合适的，因为老的视频帧丢了其实也就丢了，就算再传过来用户也不在意了，他们要看新的了，如果老是没来就等着，卡顿了，新的也看不了，那就会丢失客户，所以直播，实时性比较比较重要，宁可丢包，也不要卡顿的。</p><p>另外，对于丢包，其实对于视频播放来讲，有的包可以丢，有的包不能丢，因为视频的连续帧里面，有的帧重要，有的不重要，如果必须要丢包，隔几个帧丢一个，其实看视频的人不会感知，但是如果连续丢帧，就会感知了，因而在网络不好的情况下，应用希望选择性的丢帧。</p><p>还有就是当网络不好的时候，TCP 协议会主动降低发送速度，这对本来当时就卡的看视频来讲是要命的，应该应用层马上重传，而不是主动让步。因而，很多直播应用，都基于 UDP 实现了自己的视频传输协议。</p><h4 id="“城会玩”三：实时游戏"><a href="#“城会玩”三：实时游戏" class="headerlink" title="“城会玩”三：实时游戏"></a>“城会玩”三：实时游戏</h4><p>游戏有一个特点，就是实时性比较高。快一秒你干掉别人，慢一秒你被别人爆头，所以很多职业玩家会买非常专业的鼠标和键盘，争分夺秒。</p><p>因而，实时游戏中客户端和服务端要建立长连接，来保证实时传输。但是游戏玩家很多，服务器却不多。由于维护 TCP 连接需要在内核维护一些数据结构，因而一台机器能够支撑的 TCP 连接数目是有限的，然后 UDP 由于是没有连接的，在异步 IO 机制引入之前，常常是应对海量客户端连接的策略。</p><p>另外还是 TCP 的强顺序问题，对战的游戏，对网络的要求很简单，玩家通过客户端发送给服务器鼠标和键盘行走的位置，服务器会处理每个用户发送过来的所有场景，处理完再返回给客户端，客户端解析响应，渲染最新的场景展示给玩家。</p><p>如果出现一个数据包丢失，所有事情都需要停下来等待这个数据包重发。客户端会出现等待接收数据，然而玩家并不关心过期的数据，激战中卡 1 秒，等能动了都已经死了。</p><p>游戏对实时要求较为严格的情况下，采用自定义的可靠 UDP 协议，自定义重传策略，能够把丢包产生的延迟降到最低，尽量减少网络问题对游戏性造成的影响。</p><h4 id="“城会玩”四：IoT-物联网"><a href="#“城会玩”四：IoT-物联网" class="headerlink" title="“城会玩”四：IoT 物联网"></a>“城会玩”四：IoT 物联网</h4><p>一方面，物联网领域终端资源少，很可能只是个内存非常小的嵌入式系统，而维护 TCP 协议代价太大；另一方面，物联网对实时性要求也很高，而 TCP 还是因为上面的那些原因导致时延大。Google 旗下的 Nest 建立 Thread Group，推出了物联网通信协议 Thread，就是基于 UDP 协议的。</p><h4 id="“城会玩”五：移动通信领域"><a href="#“城会玩”五：移动通信领域" class="headerlink" title="“城会玩”五：移动通信领域"></a>“城会玩”五：移动通信领域</h4><p>在 4G 网络里，移动流量上网的数据面对的协议 GTP-U 是基于 UDP 的。因为移动网络协议比较复杂，而 GTP 协议本身就包含复杂的手机上线下线的通信协议。如果基于 TCP，TCP 的机制就显得非常多余。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议07ICMP和ping</title>
    <link href="/2023/06/30/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE07ICMP%E5%92%8Cping/"/>
    <url>/2023/06/30/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE07ICMP%E5%92%8Cping/</url>
    
    <content type="html"><![CDATA[<p> 我们常常会遇到网络不通的问题。那台机器明明就在那里，你甚至都可以通过机器的终端连上去看。</p><p>你会想到 ping 一下。</p><h2 id="ICMP-协议"><a href="#ICMP-协议" class="headerlink" title="ICMP 协议"></a>ICMP 协议</h2><p>ping 是基于 ICMP 协议工作的。ICMP 全称 Internet Control Message Protocol，就是互联网控制报文协议。</p><p>ICMP就是一个机制，这个机制就是有一个探路小兵去找，看看网络有没有通，哪里有问题。</p><p>ICMP 报文是封装在 IP 包里面的。因为传输指令的时候，肯定需要源地址和目标地址。它本身非常简单。因为作为侦查兵，要轻装上阵，不能携带大量的包袱。</p><p><img src="/.com//ICMP%E5%8D%8F%E8%AE%AE%E6%A0%BC%E5%BC%8F.webp"></p><p>ICMP 报文有很多的类型，不同的类型有不同的代码。最常用的类型是主动请求为 8，主动请求的应答为 0。</p><h3 id="报文类型"><a href="#报文类型" class="headerlink" title="报文类型"></a>报文类型</h3><h4 id="查询报文类型"><a href="#查询报文类型" class="headerlink" title="查询报文类型"></a>查询报文类型</h4><p>主动:</p><p>常用的 ping 就是查询报文，是一种主动请求，并且获得主动应答的 ICMP 协议。所以，ping 发的包也是符合 ICMP 协议格式的，只不过它在后面增加了自己的格式。</p><p>对 ping 的主动请求，进行网络抓包，称为 ICMP ECHO REQUEST。同理主动请求的回复，称为ICMP ECHO REPLY。比起原生的 ICMP，这里面多了两个字段，一个是标识符。功能不同，标识符不同。另一个是序号，你派出去的侦查兵，都要编个号。如果派出去 10 个，回来 10 个，就说明前方战况不错；如果派出去 10 个，回来 2 个，说明情况可能不妙。</p><p>在选项数据中，ping 还会存放发送请求的时间值，来计算往返时间，说明路程的长短。</p><h4 id="差错报文类型"><a href="#差错报文类型" class="headerlink" title="差错报文类型"></a>差错报文类型</h4><p>被动：</p><p>异常情况发起的，来报告发生了不好的事情，对应 ICMP 的差错报文类型。</p><p>终点不可达为 3，源抑制为 4，超时为 11，重定向为 5。</p><p>第一种是终点不可达。</p><p>网络不可达代码为 0，主机不可达代码为 1，协议不可达代码为 2，端口不可达代码为 3，需要进行分片但设置了不分片位代码为 4。</p><p>网络不可达：主公，找不到地方呀？</p><p>主机不可达：主公，找到地方没这个人呀？</p><p>协议不可达：主公，找到地方，找到人，口号没对上，人家天王盖地虎，我说 12345！</p><p>端口不可达：主公，找到地方，找到人，对了口号，事儿没对上，我去送粮草，人家说他们在等救兵。</p><p>需要进行分片但设置了不分片位：主公，走到一半，山路狭窄，想换小车，但是您的将令，严禁换小车，就没办法送到了。</p><p>第二种是源站抑制，也就是让源站放慢发送速度。</p><p>第三种是时间超时，也就是超过网络包的生存时间还是没到。</p><p>第四种是路由重定向，也就是让下次发给另一个路由器。</p><p>差错报文的结构相对复杂一些。除了前面还是 IP，ICMP 的前 8 字节不变，后面则跟上出错的那个 IP 包的 IP 头和 IP 正文的前 8 个字节。</p><h3 id="ping：查询报文类型的使用"><a href="#ping：查询报文类型的使用" class="headerlink" title="ping：查询报文类型的使用"></a>ping：查询报文类型的使用</h3><p>ping 的发送和接收过程：</p><p><img src="/.com//ping%E5%8F%91%E9%80%81%E5%92%8C%E6%8E%A5%E6%94%B6%E8%BF%87%E7%A8%8B.webp"></p><p>ping 命令执行的时候，源主机首先会构建一个 ICMP 请求数据包，ICMP 数据包内包含多个字段。最重要的是两个，第一个是类型字段，对于请求数据包而言该字段为 8；另外一个是顺序号，主要用于区分连续 ping 的时候发出的多个数据包。每发出一个请求数据包，顺序号会自动加 1。为了能够计算往返时间 RTT，它会在报文的数据部分插入发送时间。</p><p>然后，由 ICMP 协议将这个数据包连同地址 192.168.1.2 一起交给 IP 层。IP 层将以 192.168.1.2 作为目的地址，本机 IP 地址作为源地址，加上一些其他控制信息，构建一个 IP 数据包。</p><p>接下来，需要加入 MAC 头。如果在本节 ARP 映射表中查找出 IP 地址 192.168.1.2 所对应的 MAC 地址，则可以直接使用；如果没有，则需要发送 ARP 协议查询 MAC 地址，获得 MAC 地址后，由数据链路层构建一个数据帧，目的地址是 IP 层传过来的 MAC 地址，源地址则是本机的 MAC 地址；还要附加上一些控制信息，依据以太网的介质访问规则，将它们传送出去。</p><p>主机 B 收到这个数据帧后，先检查它的目的 MAC 地址，并和本机的 MAC 地址对比，如符合，则接收，否则就丢弃。接收后检查该数据帧，将 IP 数据包从帧中提取出来，交给本机的 IP 层。同样，IP 层检查后，将有用的信息提取后交给 ICMP 协议。</p><p>主机 B 会构建一个 ICMP 应答包，应答数据包的类型字段为 0，顺序号为接收到的请求数据包中的顺序号，然后再发送出去给主机 A。</p><p>在规定的时候间内，源主机如果没有接到 ICMP 的应答包，则说明目标主机不可达；如果接收到了 ICMP 应答包，则说明目标主机可达。此时，源主机会检查，用当前时刻减去该数据包最初从源主机上发出的时刻，就是 ICMP 数据包的时间延迟。</p><p>当然这只是最简单的，同一个局域网里面的情况。如果跨网段的话，还会涉及网关的转发、路由器的转发等等。但是对于 ICMP 的头来讲，是没什么影响的。会影响的是根据目标 IP 地址，选择路由的下一跳，还有每经过一个路由器到达一个新的局域网，需要换 MAC 头里面的 MAC 地址。这个过程后面几节会详细描述，这里暂时不多说。</p><p>如果在自己的可控范围之内，当遇到网络不通的问题的时候，除了直接 ping 目标的 IP 地址之外，还应该有一个清晰的网络拓扑图。并且从理论上来讲，应该要清楚地知道一个网络包从源地址到目标地址都需要经过哪些设备，然后逐个 ping 中间的这些设备或者机器。如果可能的话，在这些关键点，通过 tcpdump -i eth0 icmp，查看包有没有到达某个点，回复的包到达了哪个点，可以更加容易推断出错的位置。</p><p>经常会遇到一个问题，如果不在我们的控制范围内，很多中间设备都是禁止 ping 的，但是 ping 不通不代表网络不通。这个时候就要使用 telnet，通过其他协议来测试网络是否通，这个就不在本篇的讲述范围了。</p><p>说了这么多，你应该可以看出 ping 这个程序是使用了 ICMP 里面的 ECHO REQUEST 和 ECHO REPLY 类型的。</p><h3 id="Traceroute：差错报文类型的使用"><a href="#Traceroute：差错报文类型的使用" class="headerlink" title="Traceroute：差错报文类型的使用"></a>Traceroute：差错报文类型的使用</h3><p>Traceroute会使用 ICMP 的规则，故意制造一些能够产生错误的场景。</p><p>所以，Traceroute 的第一个作用就是故意设置特殊的 TTL，来追踪去往目的地时沿途经过的路由器。Traceroute 的参数指向某个目的 IP 地址，它会发送一个 UDP 的数据包。将 TTL 设置成 1，也就是说一旦遇到一个路由器或者一个关卡，就表示它“牺牲”了。</p><p>如果中间的路由器不止一个，当然碰到第一个就“牺牲”。于是，返回一个 ICMP 包，也就是网络差错包，类型是时间超时。那大军前行就带一顿饭，试一试走多远会被饿死，然后找个哨探回来报告，那我就知道大军只带一顿饭能走多远了。</p><p>接下来，将 TTL 设置为 2。第一关过了，第二关就“牺牲”了，那我就知道第二关有多远。如此反复，直到到达目的主机。这样，Traceroute 就拿到了所有的路由器 IP。当然，有的路由器压根不会回这个 ICMP。这也是 Traceroute 一个公网的地址，看不到中间路由的原因。</p><p>怎么知道 UDP 有没有到达目的主机呢？Traceroute 程序会发送一份 UDP 数据报给目的主机，但它会选择一个不可能的值作为 UDP 端口号（大于 30000）。当该数据报到达时，将使目的主机的 UDP 模块产生一份“端口不可达”错误 ICMP 报文。如果数据报没有到达，则可能是超时。</p><p>这就相当于故意派人去西天如来那里去请一本《道德经》，结果人家信佛不信道，消息就会被打出来。被打的消息传回来，你就知道西天是能够到达的。为什么不去取《心经》呢？因为 UDP 是无连接的。也就是说这人一派出去，你就得不到任何音信。你无法区别到底是半路走丢了，还是真的信佛遁入空门了，只有让人家打出来，你才会得到消息。</p><p>Traceroute 还有一个作用是故意设置不分片，从而确定路径的 MTU。要做的工作首先是发送分组，并设置“不分片”标志。发送的第一个分组的长度正好与出口 MTU 相等。如果中间遇到窄的关口会被卡住，会发送 ICMP 网络差错包，类型为“需要进行分片但设置了不分片位”。其实，这是人家故意的好吧，每次收到 ICMP“不能分片”差错时就减小分组的长度，直到到达目标主机。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring_boot关闭与kill</title>
    <link href="/2023/06/30/spring/spring_boot%E5%85%B3%E9%97%AD%E4%B8%8Ekill/"/>
    <url>/2023/06/30/spring/spring_boot%E5%85%B3%E9%97%AD%E4%B8%8Ekill/</url>
    
    <content type="html"><![CDATA[<h2 id="kill"><a href="#kill" class="headerlink" title="kill"></a>kill</h2><p>kill 可将指定的信息送至程序。</p><p>预设的信息为 SIGTERM(15)，可将指定程序终止。就是默认 kill 传送的信息。</p><figure class="highlight css"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs css">kill <span class="hljs-selector-attr">[-s &lt;信息名称或编号&gt;]</span><span class="hljs-selector-attr">[程序]</span>　或　kill <span class="hljs-selector-attr">[-l &lt;信息编号&gt;]</span><br></code></pre></td></tr></table></figure><ul><li>-l &lt;信息编号&gt; 　若不加&lt;信息编号&gt;选项，则 -l 参数会列出全部的信息名称。</li><li>-s &lt;信息名称或编号&gt; 　指定要送出的信息。</li><li>[程序] 　[程序]可以是程序的PID或是PGID，也可以是工作编号。</li></ul><p>最常用的信号是：</p><ul><li>1 (HUP)：重新加载进程。</li><li>9 (KILL)：杀死一个进程。</li><li>15 (TERM)：正常停止一个进程。</li></ul><p>有的文章说：kill -9 进程ID</p><p>是从内核级别把进程杀死。会使你的程序里执行到哪处于一种不知的状态。所以除非必要时刻不要使用kill -9 进程ID。</p><p>kill 进程ID</p><p>正常停止一个进程。是发送一个信号给你的程序告诉他，他要停止，他会走关闭流程。</p><h3 id="什么情况会引发kill不掉要使用Kill-9"><a href="#什么情况会引发kill不掉要使用Kill-9" class="headerlink" title="什么情况会引发kill不掉要使用Kill -9"></a>什么情况会引发kill不掉要使用Kill -9</h3><p>例如进程陷入无限循环、资源泄漏、线程死锁等。在这种情况下，标准的kill命令可能无法将进程正确地终止。</p><p>判断一个进程是否进入无限循环、资源泄漏、线程死锁等问题是一个复杂的任务，通常需要运行时监控和诊断工具来帮助我们进行分析。下面是一些常见的工具和方法：</p><ol><li>监控进程的系统资源使用情况：使用操作系统的监控工具（如top、ps等）来观察进程的CPU使用率、内存占用情况等。如果发现一个进程占用过高的CPU或内存资源而无法恢复正常状态，那可能是进入了无限循环或资源泄漏的情况。</li><li>分析进程的日志文件：进程的日志文件可能包含关于异常、错误信息、死锁等的记录。通过仔细分析日志文件，可以定位到具体的代码段或操作可能导致进程陷入无限循环或死锁。</li><li>使用诊断工具：Java提供了一些用于诊断的工具，如jps、jstack、jmap、jconsole等。这些工具可以提供线程堆栈信息、内存快照、垃圾收集信息等，有助于分析进程中的问题。</li><li>执行代码审查：检查进程中的代码，特别是涉及到循环、锁、资源关闭等的地方。查看是否存在潜在的无限循环、不正确的锁使用、未及时释放资源等问题。</li></ol><h2 id="spring-boot-优雅关闭"><a href="#spring-boot-优雅关闭" class="headerlink" title="spring boot 优雅关闭"></a>spring boot 优雅关闭</h2><h3 id="什么叫优雅结束"><a href="#什么叫优雅结束" class="headerlink" title="什么叫优雅结束?"></a>什么叫优雅结束?</h3><ul><li>第一步：停止接收请求和内部线程。</li><li>第二步：判断是否有线程正在执行。</li><li>第三步：等待正在执行的线程执行完毕。</li><li>第四步：停止容器。</li></ul><h3 id="优雅关闭"><a href="#优雅关闭" class="headerlink" title="优雅关闭"></a>优雅关闭</h3><p>测试代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(value = &quot;/test&quot;)</span> <br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test</span><span class="hljs-params">()</span>&#123; <br>        log.info(<span class="hljs-string">&quot;test --- start&quot;</span>); <br>        <span class="hljs-keyword">try</span> &#123; <br>            Thread.sleep(<span class="hljs-number">100000</span>); <br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; <br>            e.printStackTrace(); <br>        &#125; <br>        log.info(<span class="hljs-string">&quot;test --- end&quot;</span>); <br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;test&quot;</span>; <br>    &#125; <br></code></pre></td></tr></table></figure><p>注意这里是补获取异常没有抛出异常。</p><h4 id="kill-15-pid"><a href="#kill-15-pid" class="headerlink" title="kill -15 pid"></a>kill -15 pid</h4><p>启动spring boot项目</p><p>访问测试接口</p><p>使用 kill -15 pid（kill pid） 来结束这个进程</p><p>这时观察日志(console):  发现test — start   和  test — end 还有打断异常输出。</p><p>所以在生产环境中，使用kill -15 是基本安全的，程序正常执行至完毕。</p><h4 id="ConfigurableApplicationContext-colse"><a href="#ConfigurableApplicationContext-colse" class="headerlink" title="ConfigurableApplicationContext colse"></a>ConfigurableApplicationContext colse</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j; <br><span class="hljs-keyword">import</span> org.springframework.beans.BeansException; <br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext; <br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContextAware; <br><span class="hljs-keyword">import</span> org.springframework.context.ConfigurableApplicationContext; <br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping; <br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping; <br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController; <br> <br><span class="hljs-meta">@RestController</span> <br><span class="hljs-meta">@Slf4j</span> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span>  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span> &#123; <br> <br>    <span class="hljs-keyword">private</span>  ApplicationContext  context; <br> <br>    <span class="hljs-meta">@Override</span> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext applicationContext)</span> <span class="hljs-keyword">throws</span> BeansException &#123; <br>        <span class="hljs-built_in">this</span>.context = applicationContext; <br>    &#125; <br> <br> <br>    <span class="hljs-meta">@GetMapping(value = &quot;/test&quot;)</span> <br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test</span><span class="hljs-params">()</span>&#123; <br>        log.info(<span class="hljs-string">&quot;test --- start&quot;</span>); <br>        <span class="hljs-keyword">try</span> &#123; <br>            Thread.sleep(<span class="hljs-number">100000</span>); <br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; <br>            e.printStackTrace(); <br>        &#125; <br>        log.info(<span class="hljs-string">&quot;test --- end&quot;</span>); <br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;test&quot;</span>; <br>    &#125; <br> <br>    <span class="hljs-comment">/** </span><br><span class="hljs-comment">     * 停机 </span><br><span class="hljs-comment">     */</span> <br>    <span class="hljs-meta">@PostMapping(value = &quot;shutdown&quot;)</span> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span>&#123; <br>        <span class="hljs-type">ConfigurableApplicationContext</span> <span class="hljs-variable">cyx</span> <span class="hljs-operator">=</span> (ConfigurableApplicationContext) context; <br>        cyx.close(); <br>    &#125; <br>&#125; <br></code></pre></td></tr></table></figure><p>程序在启动的时候向 JVM 注册了一个关闭钩子，我们在执行 colse 方法的时候会删除这个关闭钩子，JVM 就会知道这是需要停止服务。</p><p>访问shutdown接口。观察同kill -15。</p><h4 id="actuator"><a href="#actuator" class="headerlink" title="actuator"></a>actuator</h4><p>这种方式是通过引入依赖的方式停止服务，actuator 提供了很多接口，比如健康检查，基本信息等等，我们也可以使用他来优雅的停机。</p><p>引入依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span> <br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span> <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span> <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span> <br></code></pre></td></tr></table></figure><p>application.yml：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">management:</span> <br>  <span class="hljs-attr">endpoints:</span> <br>    <span class="hljs-attr">web:</span> <br>      <span class="hljs-attr">exposure:</span> <br>        <span class="hljs-attr">include:</span> <span class="hljs-string">shutdown</span> <br>  <span class="hljs-attr">endpoint:</span> <br>    <span class="hljs-attr">shutdown:</span> <br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <br>  <span class="hljs-attr">server:</span> <br>    <span class="hljs-attr">port:</span> <span class="hljs-number">8888</span> <br></code></pre></td></tr></table></figure><p>访问：<a href="http://127.0.0.1:8888/actuator/shutdown">http://127.0.0.1:8888/actuator/shutdown</a></p><h3 id="10-秒以后再停止服务"><a href="#10-秒以后再停止服务" class="headerlink" title="10 秒以后再停止服务"></a>10 秒以后再停止服务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.catalina.connector.Connector; <br><span class="hljs-keyword">import</span> org.springframework.boot.web.embedded.tomcat.TomcatConnectorCustomizer; <br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationListener; <br><span class="hljs-keyword">import</span> org.springframework.context.event.ContextClosedEvent; <br> <br><span class="hljs-keyword">import</span> java.util.concurrent.Executor; <br><span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor; <br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit; <br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ElegantShutdownConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TomcatConnectorCustomizer</span>, ApplicationListener&lt;ContextClosedEvent&gt; &#123; <br> <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Connector connector; <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">waitTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>; <br> <br>    <span class="hljs-meta">@Override</span> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">customize</span><span class="hljs-params">(Connector connector)</span> &#123; <br>        <span class="hljs-built_in">this</span>.connector = connector; <br>    &#125; <br> <br>    <span class="hljs-meta">@Override</span> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onApplicationEvent</span><span class="hljs-params">(ContextClosedEvent event)</span> &#123; <br>        connector.pause(); <br>        <span class="hljs-type">Executor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> connector.getProtocolHandler().getExecutor(); <br>        <span class="hljs-keyword">if</span> (executor <span class="hljs-keyword">instanceof</span> ThreadPoolExecutor) &#123; <br>            <span class="hljs-keyword">try</span> &#123; <br>                <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">threadPoolExecutor</span> <span class="hljs-operator">=</span> (ThreadPoolExecutor) executor; <br>                threadPoolExecutor.shutdown(); <br>                <span class="hljs-keyword">if</span> (!threadPoolExecutor.awaitTermination(waitTime, TimeUnit.SECONDS)) &#123; <br>                    System.out.println(<span class="hljs-string">&quot;请尝试暴力关闭&quot;</span>); <br>                &#125; <br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException ex) &#123; <br>                System.out.println(<span class="hljs-string">&quot;异常了&quot;</span>); <br>                Thread.currentThread().interrupt(); <br>            &#125; <br>        &#125; <br> <br>    &#125; <br>&#125; <br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.ymy.config.ElegantShutdownConfig; <br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j; <br><span class="hljs-keyword">import</span> org.apache.catalina.connector.Connector; <br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication; <br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication; <br><span class="hljs-keyword">import</span> org.springframework.boot.web.embedded.tomcat.TomcatConnectorCustomizer; <br><span class="hljs-keyword">import</span> org.springframework.boot.web.embedded.tomcat.TomcatServletWebServerFactory; <br><span class="hljs-keyword">import</span> org.springframework.boot.web.servlet.server.ServletWebServerFactory; <br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationListener; <br><span class="hljs-keyword">import</span> org.springframework.context.ConfigurableApplicationContext; <br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean; <br><span class="hljs-keyword">import</span> org.springframework.context.event.ContextClosedEvent; <br> <br><span class="hljs-keyword">import</span> java.util.concurrent.Executor; <br><span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor; <br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit; <br> <br><span class="hljs-meta">@SpringBootApplication</span> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShutdownServerApplication</span> &#123; <br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123; <br>        <span class="hljs-type">ConfigurableApplicationContext</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> SpringApplication.run(ShutdownServerApplication.class, args); <br>        run.registerShutdownHook(); <br>    &#125; <br> <br> <br>    <span class="hljs-meta">@Bean</span> <br>    <span class="hljs-keyword">public</span> ElegantShutdownConfig <span class="hljs-title function_">elegantShutdownConfig</span><span class="hljs-params">()</span> &#123; <br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ElegantShutdownConfig</span>(); <br>    &#125; <br> <br>    <span class="hljs-meta">@Bean</span> <br>    <span class="hljs-keyword">public</span> ServletWebServerFactory <span class="hljs-title function_">servletContainer</span><span class="hljs-params">()</span> &#123; <br>        <span class="hljs-type">TomcatServletWebServerFactory</span> <span class="hljs-variable">tomcat</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TomcatServletWebServerFactory</span>(); <br>        tomcat.addConnectorCustomizers(elegantShutdownConfig()); <br>        <span class="hljs-keyword">return</span> tomcat; <br>    &#125; <br>&#125; <br></code></pre></td></tr></table></figure><p>启动项目，再访问接口test接口，因为test也是10秒，10秒后再停止服务，操作需要一定的时间，所以test不会被打断，不会出现打断日志。</p><h3 id="销毁前数据备份操作"><a href="#销毁前数据备份操作" class="headerlink" title="销毁前数据备份操作"></a>销毁前数据备份操作</h3><p>如果我想在服务停止的时候做点备份操作啥的，应该怎么做呢?其实很简单在你要执行的方法上添加一个注解即可：@PreDestroy。</p><ul><li>Destroy：消灭、毁灭。</li><li>pre：前缀缩写。</li></ul><p>所以合在一起的意思就是在容器停止之前执行一次，你可以在这里面做备份操作，也可以做记录停机时间等。</p><p>新增服务停止备份工具类：DataBackupConfig.java。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration; <br> <br><span class="hljs-keyword">import</span> javax.annotation.PreDestroy; <br> <br><span class="hljs-meta">@Configuration</span> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataBackupConfig</span> &#123; <br> <br>    <span class="hljs-meta">@PreDestroy</span> <br>    <span class="hljs-keyword">public</span>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">backData</span><span class="hljs-params">()</span>&#123; <br> <br>        System.out.println(<span class="hljs-string">&quot;正在备份数据。。。。。。。。。。。&quot;</span>); <br>    &#125; <br>&#125; <br></code></pre></td></tr></table></figure><p>用上面的优雅关闭，可以看到执行打印日志。</p><h2 id="结合nginx已连接的请求去掉负载后是否成功返回文章"><a href="#结合nginx已连接的请求去掉负载后是否成功返回文章" class="headerlink" title="结合nginx已连接的请求去掉负载后是否成功返回文章"></a>结合nginx已连接的请求去掉负载后是否成功返回文章</h2><p>可以发现，重启流程为修改ningx负载，重新加载nginx配置文件，等一会儿，使用kill (kill -15)等优雅关闭spring boot 服务可以基本保证程序可控。</p><h2 id="其它的风险"><a href="#其它的风险" class="headerlink" title="其它的风险"></a>其它的风险</h2><p>正常情况按照上面的操作步骤就可以了。</p><p>但是还要看代码编写，比如如果在sleep的地方不是只打印日志或者异常出现在事务中，代码就会被中断，如果没有事务的保护，数据就会出错，代码要有可重入性、强壮性。</p><p>还有一些其他情况比如服务器断电等情况，还是未知情况。</p>]]></content>
    
    
    <categories>
      
      <category>spring boot</category>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring boot</tag>
      
      <tag>kill</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议05物理层到MAC层</title>
    <link href="/2023/06/29/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE05%E7%89%A9%E7%90%86%E5%B1%82%E5%88%B0MAC%E5%B1%82/"/>
    <url>/2023/06/29/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE05%E7%89%A9%E7%90%86%E5%B1%82%E5%88%B0MAC%E5%B1%82/</url>
    
    <content type="html"><![CDATA[<h2 id="第一层（物理层）"><a href="#第一层（物理层）" class="headerlink" title="第一层（物理层）"></a>第一层（物理层）</h2><p>两台电脑相连，以前使用交叉网线插在两台电脑的网卡上，用的所谓的1-3、2-6交叉接法。</p><p>水晶头的第1、2和第3、6脚，它们分别起着收、发信号的作用。将一端的1号和3号线、2号线和6号线互换一下位置，就能够在物理层实现一端发送的信号，别一端能收到。</p><p>配置两台电脑的IP地址、子网掩码和默认网关。配置成一个网络，可以一个是192.168.0.1&#x2F;24, 另一个是192.168.0.2&#x2F;24。</p><p>这时候两台电脑已经构成了一个最小的局域网，也即LAN。可以玩联机局域网游戏啦！</p><h3 id="如何把三台电脑连在一起？"><a href="#如何把三台电脑连在一起？" class="headerlink" title="如何把三台电脑连在一起？"></a>如何把三台电脑连在一起？</h3><p>有一个叫做 Hub 的东西，也就是集线器。</p><p>这种设备有多个口，可以将宿舍里的多台电脑连接起来。但是，和交换机不同，集线器没有大脑，它完全在物理层工作。它会将自己收到的每一个字节，都复制到其他端口上去。这是第一层物理层联通的方案。</p><h2 id="第二层-数据链路层"><a href="#第二层-数据链路层" class="headerlink" title="第二层(数据链路层)"></a>第二层(数据链路层)</h2><p>Hub 采取的是广播的模式。</p><p>多台电脑都收到了包。</p><p>需要解决几个问题：</p><p>1.这个包是发给谁的？谁应该接收？</p><p>2.大家都在发，会不会产生混乱？有没有谁先发、谁后发的规则？</p><p>3.如果发送的时候出现了错误，怎么办？</p><p>这几个问题，都是第二层，数据链路层，也即 MAC 层要解决的问题。</p><p>MAC 的全称是 Medium Access Control，即媒体访问控制。控制什么呢？其实就是控制在往媒体上发数据的时候，谁先发、谁后发的问题。防止发生混乱。这解决的是第二个问题。这个问题中的规则，学名叫多路访问。</p><h3 id="如何解决问题2"><a href="#如何解决问题2" class="headerlink" title="如何解决问题2"></a>如何解决问题2</h3><p>方式一：分多个车道。每个车一个车道，你走你的，我走我的。这在计算机网络里叫作信道划分；</p><p>方式二：今天单号出行，明天双号出行，轮着来。这在计算机网络里叫作轮流协议；</p><p>方式三：不管三七二十一，有事儿先出门，发现特堵，就回去。错过高峰再出。我们叫作随机接入协议。著名的以太网，用的就是这个方式。</p><h3 id="解决问题1：发给谁，谁接收"><a href="#解决问题1：发给谁，谁接收" class="headerlink" title="解决问题1：发给谁，谁接收"></a>解决问题1：发给谁，谁接收</h3><p>这里用到一个物理地址，叫作链路层地址。但是因为第二层主要解决媒体接入控制的问题，所以它常被称为MAC 地址。</p><p>就牵扯到第二层的网络包格式。对于以太网，第二层的最开始，就是目标的 MAC 地址和源的 MAC 地址。</p><table><thead><tr><th>目标mac(6bytes)</th><th>源mac(6bytes)</th><th>类型(2bytes)</th><th>数据(46-1500 bytes)</th><th>CRC(4 bytes)</th></tr></thead><tbody><tr><td></td><td></td><td>类型0800：IP数据报</td><td></td><td></td></tr><tr><td></td><td></td><td>类型0806：ARP请求、应答</td><td></td><td></td></tr></tbody></table><p>接下来是类型，大部分的类型是 IP 数据包，然后 IP 里面包含 TCP、UDP，以及 HTTP 等，这都是里层封装的事情。</p><p>有了这个目标 MAC 地址，数据包在链路上广播，MAC 的网卡才能发现，这个包是给它的。MAC 的网卡把包收进来，然后打开 IP 包，发现 IP 地址也是自己的，再打开 TCP 包，发现端口是自己，也就是 80，而 nginx 就是监听 80。</p><p>于是将请求提交给 nginx，nginx 返回一个网页。然后将网页需要发回请求的机器。然后层层封装，最后到 MAC 层。因为来的时候有源 MAC 地址，返回的时候，源 MAC 就变成了目标 MAC，再返给请求的机器。</p><h3 id="解决问题3："><a href="#解决问题3：" class="headerlink" title="解决问题3："></a>解决问题3：</h3><p>对于以太网，第二层的最后面是 CRC，也就是循环冗余检测。通过 XOR 异或的算法，来计算整个包是否在发送的过程中出现了错误。</p><h3 id="知道IP-不知道MAC地址，ARP协议"><a href="#知道IP-不知道MAC地址，ARP协议" class="headerlink" title="知道IP, 不知道MAC地址，ARP协议"></a>知道IP, 不知道MAC地址，ARP协议</h3><p>知道IP地址，求MAC地址的协议叫做ARP协议。</p><p>在一个局域网里面，当知道了 IP 地址，不知道 MAC 怎么办呢？</p><p>广而告之，发送一个广播包，谁是这个 IP 谁来回答。</p><table><thead><tr><th>目标mac(6bytes)</th><th>源mac(6bytes)</th><th>类型(2bytes)</th><th>ARP报文</th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td></td><td></td><td></td><td>硬件类型(Ethemet)</td><td>协议类型(IP)</td><td>硬件地址长度(6)</td><td>协议地址长度(6)</td><td>操作代码（1 request  2 reply）</td><td>发送者mac</td><td>发送者IP</td><td>目标MAC</td><td>目标IP</td></tr></tbody></table><p>为了避免每次都用 ARP 请求，机器本地也会进行 ARP 缓存。当然机器会不断地上线下线，IP 也可能会变，所以 ARP 的 MAC 地址缓存过一段时间就会过期。</p><h3 id="交换机"><a href="#交换机" class="headerlink" title="交换机"></a>交换机</h3><p>hub是广播的，所有包都发送到整个网络的主机上，主机判断是不是需要，把不需要的包转发过去纯属浪费。</p><p>交换机是一个二层设备。</p><p>因为电脑不经常换IP和MAC地址，交换机会记住这台电脑的MAC地址。交换机会把MAC头拿下来，检查一下目标地址，如果不是这台电脑，这个口就不用转发了。</p><h4 id="交接机如何记住各个电脑的mac地址？"><a href="#交接机如何记住各个电脑的mac地址？" class="headerlink" title="交接机如何记住各个电脑的mac地址？"></a>交接机如何记住各个电脑的mac地址？</h4><p>一开始，交换机谁的也不知道，有发送时，发广播。你发送的，我记住你的MAC地址了。以后发给你，我就直接给你了。</p><p>当然，每个机器的IP地址会变，所在的口也会变，因而交换机上的学习的结果，我们称为转发表，是有一个过期时间的。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议06交接机与VLAN</title>
    <link href="/2023/06/29/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE06%E4%BA%A4%E6%8E%A5%E6%9C%BA%E4%B8%8EVLAN/"/>
    <url>/2023/06/29/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE06%E4%BA%A4%E6%8E%A5%E6%9C%BA%E4%B8%8EVLAN/</url>
    
    <content type="html"><![CDATA[<p> 有了集线器和交换机后就可以形成一个复杂的网络结构。叫拓扑结构。</p><h2 id="拓扑结构"><a href="#拓扑结构" class="headerlink" title="拓扑结构"></a>拓扑结构</h2><p>两台交换机的情形。两台交换机连接着三个局域网，每个局域网上都有多台机器。其中LAN1、LAN2、LAN3是集线器。</p><p><img src="/.com//%E4%B8%A4%E4%B8%AA%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%9A%84%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84.webp"></p><p>如果机器 1 只知道机器 4 的 IP 地址，当它想要访问机器 4，把包发出去的时候，它必须要知道机器 4 的 MAC 地址。</p><p>于是机器 1 发起广播，机器 2 收到这个广播，但是这不是找它的，所以没它什么事。</p><p>交换机 A 一开始是不知道任何拓扑信息的，在它收到这个广播后，采取的策略是，除了广播包来的方向外，它还要转发给其他所有的网口。</p><p>于是机器 3 也收到广播信息了，但是这和它也没什么关系。</p><p>当然，交换机 B 也是能够收到广播信息的，但是这时候它也是不知道任何拓扑信息的，因而也是进行广播的策略，将包转发到局域网三。这个时候，机器 4 和机器 5 都收到了广播信息。</p><p>机器 4 主动响应说，这是找我的，这是我的 MAC 地址。于是一个 ARP 请求就成功完成了。</p><p>这里 ARP 的目标地址是广播的，所以无论是否进行地址学习，都会广播，而对于某个 MAC 的访问，在没有地址学习的时候，是转发到所有的端口的，学习之后，只会转发到有这个 MAC 的端口。</p><h2 id="如何解决常见的环路问题？"><a href="#如何解决常见的环路问题？" class="headerlink" title="如何解决常见的环路问题？"></a>如何解决常见的环路问题？</h2><p>什么是环路问题？</p><p>例如这个图，当两个交换机将两个局域网同时连接起来的时候。你可能会觉得，这样反而有了高可用性。但是却不幸地出现了环路。出现了环路会有什么结果呢？</p><p><img src="/.com//%E4%B8%A4%E4%B8%AA%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%8E%AF%E8%B7%AF%E9%97%AE%E9%A2%98.webp"></p><p>环路会导致广播风暴、MAC地址震荡等。</p><p>我们来想象一下机器 1 访问机器 2 的过程。一开始，机器 1 并不知道机器 2 的 MAC 地址，所以它需要发起一个 ARP 的广播。广播到达机器 2，机器 2 会把 MAC 地址返回来，看起来没有这两个交换机什么事情。</p><p>但是问题来了，这两个交换机还是都能够收到广播包的。交换机 A 一开始是不知道机器 2 在哪个局域网的，所以它会把广播消息放到局域网二，在局域网二广播的时候，交换机 B 右边这个网口也是能够收到广播消息的。交换机 B 会将这个广播信息发送到局域网一。局域网一的这个广播消息，又会到达交换机 A 左边的这个接口。交换机 A 这个时候还是不知道机器 2 在哪个局域网，于是将广播包又转发到局域网二。左转左转左转，好像是个圈哦。</p><p>可能有人会说，当两台交换机都能够逐渐学习到拓扑结构之后，是不是就可以了？</p><p>别想了，压根儿学不会的。机器 1 的广播包到达交换机 A 和交换机 B 的时候，本来两个交换机都学会了机器 1 是在局域网一的，但是当交换机 A 将包广播到局域网二之后，交换机 B 右边的网口收到了来自交换机 A 的广播包。根据学习机制，这彻底损坏了交换机 B 的三观，刚才机器 1 还在左边的网口呢，怎么又出现在右边的网口呢？哦，那肯定是机器 1 换位置了，于是就误会了，交换机 B 就学会了，机器 1 是从右边这个网口来的，把刚才学习的那一条清理掉。同理，交换机 A 右边的网口，也能收到交换机 B 转发过来的广播包，同样也误会了，于是也学会了，机器 1 从右边的网口来，不是从左边的网口来。</p><p>然而当广播包从左边的局域网一广播的时候，两个交换机再次刷新三观，原来机器 1 是在左边的，过一会儿，又发现不对，是在右边的，过一会，又发现不对，是在左边的。</p><p>这还是一个包转来转去，每台机器都会发广播包，交换机转发也会复制广播包，当广播包越来越多的时候，按照上一节讲过一个共享道路的算法，也就是路会越来越堵，最后谁也别想走。所以，必须有一个方法解决环路的问题，怎么破除环路呢？</p><h2 id="STP"><a href="#STP" class="headerlink" title="STP"></a>STP</h2><p>在数据结构中，有一个方法叫做最小生成树。有环的我们常称为图。将图中的环破了，就生成了树。在计算机网络中，生成树的算法叫作 STP，全称 Spanning Tree Protocol。</p><p>Root Bridge，也就是根交换机。这个比较容易理解，可以比喻为“掌门”交换机，是某棵树的老大，是掌门，最大的大哥。</p><p>Designated Bridges，有的翻译为指定交换机。这个比较难理解，可以想像成一个“小弟”，对于树来说，就是一棵树的树枝。所谓“指定”的意思是，我拜谁做大哥，其他交换机通过这个交换机到达根交换机，也就相当于拜他做了大哥。这里注意是树枝，不是叶子，因为叶子往往是主机。</p><p>Bridge Protocol Data Units （BPDU） ，网桥协议数据单元。可以比喻为“相互比较实力”的协议。行走江湖，比的就是武功，拼的就是实力。当两个交换机碰见的时候，也就是相连的时候，就需要互相比一比内力了。BPDU 只有掌门能发，已经隶属于某个掌门的交换机只能传达掌门的指示。</p><p>Priority Vector，优先级向量。可以比喻为实力 （值越小越牛）。实力是啥？就是一组 ID 数目，[Root Bridge ID, Root Path Cost, Bridge ID, and Port ID]。为什么这样设计呢？这是因为要看怎么来比实力。先看 Root Bridge ID。拿出老大的 ID 看看，发现掌门一样，那就是师兄弟；再比 Root Path Cost，也即我距离我的老大的距离，也就是拿和掌门关系比，看同一个门派内谁和老大关系铁；最后比 Bridge ID，比我自己的 ID，拿自己的本事比。</p><h3 id="STP-的工作过程是怎样的？"><a href="#STP-的工作过程是怎样的？" class="headerlink" title="STP 的工作过程是怎样的？"></a>STP 的工作过程是怎样的？</h3><p>看原文吧</p><h2 id="VLAN-公司大了如何解决广播问题和安全问题？"><a href="#VLAN-公司大了如何解决广播问题和安全问题？" class="headerlink" title="VLAN(公司大了如何解决广播问题和安全问题？)"></a>VLAN(公司大了如何解决广播问题和安全问题？)</h2><p>公司大了，如果都用一个网络会有广播问题和安全问题。</p><p>那咋办，分部门，分会议室呗。</p><p>有两种分的方法，</p><p>一个是物理隔离。就是每个部门有单独的交换机，配置单独的子网，这样部门之间的沟通就需要路由器了。</p><p>另外一种方式是虚拟隔离，就是用我们常说的 VLAN，或者叫虚拟局域网。使用 VLAN，一个交换机上会连属于多个局域网的机器。</p><p>我们只需要在原来的二层的头上加一个 TAG，里面有一个 VLAN ID，一共 12 位。 12 位可以划分 4096 个 VLAN。</p><p>如果我们买的交换机是支持 VLAN 的，当这个交换机把二层的头取下来的时候，就能够识别这个 VLAN ID。这样只有相同 VLAN 的包，才会互相转发，不同 VLAN 的包，是看不到的。这样广播问题和安全问题就都能够解决了</p><p>将两个交换机连接起来的口应该设置成什么 VLAN 呢？对于支持 VLAN 的交换机，有一种口叫作 Trunk 口。它可以转发属于任何 VLAN 的口。交换机之间可以通过这种口相互连接。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议04IP地址</title>
    <link href="/2023/06/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE04IP%E5%9C%B0%E5%9D%80/"/>
    <url>/2023/06/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE04IP%E5%9C%B0%E5%9D%80/</url>
    
    <content type="html"><![CDATA[<h2 id="如何配置IP地址"><a href="#如何配置IP地址" class="headerlink" title="如何配置IP地址"></a>如何配置IP地址</h2><p>使用 net-tools：</p><figure class="highlight apache"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> ifconfig eth1 <span class="hljs-number">10.0.0.1</span>/<span class="hljs-number">24</span><br><span class="hljs-attribute">sudo</span> ifconfig eth1 up<br></code></pre></td></tr></table></figure><p>使用 iproute2：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">sudo<span class="hljs-built_in"> ip </span>addr <span class="hljs-built_in">add</span> 10.0.0.1/24 dev eth1<br>sudo<span class="hljs-built_in"> ip </span>link <span class="hljs-built_in">set</span> up eth1<br></code></pre></td></tr></table></figure><p>配置文件配置：</p><p>不同系统的配置文件格式不同，但是无非就是CIDR、子网掩码、广播地址和网关地址。</p><h2 id="包发送简述"><a href="#包发送简述" class="headerlink" title="包发送简述"></a>包发送简述</h2><p>linux系统首先会判断，要去的地址和我的网卡是一个网络吗？是一个网络，才会发送ARP请求，获取MAC地址。</p><p>linux默认的逻辑是，如果这是一个跨网段的调用，它便不会直接将包发送到网络上，而是企图将包发送到网关。</p><p>如果没有网关，包根本发不出去。</p><p>192.168.23.6 不可能设置网关为 192.168.1.6。网关要和当前的网络至少一个网卡是同一个网段的。</p><h2 id="动态主机配置协议（DHCP）"><a href="#动态主机配置协议（DHCP）" class="headerlink" title="动态主机配置协议（DHCP）"></a>动态主机配置协议（DHCP）</h2><p>如果公司每个人都要需要IT人员配置，肯定忙不过来啊。所以出现了DHCP。</p><p>自动配置的协议，也就是动态主机配置协议（Dynamic Host Configuration Protocol），简称 DHCP。</p><p>网络管理员只需要配置一段共享的IP地址。申请、用完了、还回去。</p><p>如果是数据中心里面的服务器，IP 一旦配置好，基本不会变，这就相当于买房自己装修。DHCP 的方式就相当于租房。你不用装修，都是帮你配置好的。你暂时用一下，用完退租就可以了。</p><h2 id="解析-DHCP-的工作方式"><a href="#解析-DHCP-的工作方式" class="headerlink" title="解析 DHCP 的工作方式"></a>解析 DHCP 的工作方式</h2><p>当一台机器新加入一个网络的时候，只知道自己的MAC地址，先发广播，说我来啦，称为DHCP discover。</p><p>DHCP discover报文：</p><table><thead><tr><th>头</th><th>值</th></tr></thead><tbody><tr><td>MAC头</td><td>新机器的mac地址<br>广播mac地址:ff:ff:ff:ff:ff:ff</td></tr><tr><td>IP头</td><td>新机器的IP: 0.0.0.0<br>目标IP: 255.255.255.255</td></tr><tr><td>UDP头</td><td>源端口：68<br>目标端口：67</td></tr><tr><td>BOOTP头</td><td>boot request</td></tr><tr><td></td><td>我的mac是这个，我还没有IP!</td></tr></tbody></table><p>新来的机器使用IP地址0.0.0.0发送了一个广播包，目的IP地址为255.255.255.255,广播包封装了UDP, UDP封装了BOOTP。其实DHCP是BOOTP的增强版，但是如果你去抓包的话，很可能看到的名称还是BOOTP协议。</p><p>DHCP server,网络管理员在网络里面配置了DHCP server的话，相当于这些IP的管理员。</p><p>只有MAC惟一，IP管理员才能知道这是一个新人，需要租给它一个IP地址，这个过程我们称为DHCP offer。DHCP server为此客户保留这个IP地址，租约内不在给其他DHCP客户分配此IP地址。</p><p>DHCP offer报文：</p><table><thead><tr><th>头</th><th>值</th></tr></thead><tbody><tr><td>MAC头</td><td>DHCP的mac地址<br>广播mac地址:ff:ff:ff:ff:ff:ff</td></tr><tr><td>IP头</td><td>DHCP的IP: 192.168.1.2<br>广播IP: 255.255.255.255</td></tr><tr><td>UDP头</td><td>源端口：67<br>目标端口：68</td></tr><tr><td>BOOTP头</td><td>boot reply</td></tr><tr><td></td><td>这是你的MAC，我分配了这个IP,租给你，你看如何？</td></tr></tbody></table><p>DHCP server仍然使用广播地址作为目的地址，因为，此时请求分配IP的新人还没有自己的IP。DHCP server回复说：这是你的MAC,我分配了这个IP,租给你，你看如何？除此之外，服务器还发送了子网掩码、网关和 IP 地址租用期等信息。</p><p>DHCP server可以有多台。新机器会选择其中一台，一般是最先到达的那个，并且会向网络发送一个 DHCP Request 广播数据包，包中包含客户端的 MAC 地址、接受的租约中的 IP 地址、提供此租约的 DHCP 服务器地址等，并告诉所有 DHCP Server 它将接受哪一台服务器提供的 IP 地址，告诉其他 DHCP 服务器，谢谢你们的接纳，并请求撤销它们提供的 IP 地址，以便提供给下一个 IP 租用请求者。</p><p> DHCP Request 广播数据包：</p><table><thead><tr><th>头</th><th>值</th></tr></thead><tbody><tr><td>MAC头</td><td>新机器的mac地址<br>广播mac地址:ff:ff:ff:ff:ff:ff</td></tr><tr><td>IP头</td><td>新机器的IP: 0.0.0.0<br>目标IP: 255.255.255.255</td></tr><tr><td>UDP头</td><td>源端口：68<br>目标端口：67</td></tr><tr><td>BOOTP头</td><td>boot request</td></tr><tr><td></td><td>我的mac是这个，我准备租用这个DHCP server给分配的IP。</td></tr></tbody></table><p>由于还没有得到DHCP server的最后确认，客户端仍然使用0.0.0.0为源IP地址、255.255.255.255为目标地址进行广播。 在BOOTP里面，接受某个DHCP server的分配IP。</p><p>当DHCP server接收到客户机的DHCP request之后，会广播返回客户机一个DHCP ack消息包，表明已经接受客户机的选择，并将这一 IP 地址的合法租用信息和其他的配置信息都放入该广播包，发给客户机，欢迎它加入网络大家庭。</p><p>DHCP ack消息包：</p><table><thead><tr><th>头</th><th>值</th></tr></thead><tbody><tr><td>MAC头</td><td>DHCP的mac地址<br>广播mac地址:ff:ff:ff:ff:ff:ff</td></tr><tr><td>IP头</td><td>DHCP的IP: 192.168.1.2<br>广播IP: 255.255.255.255</td></tr><tr><td>UDP头</td><td>源端口：67<br>目标端口：68</td></tr><tr><td>BOOTP头</td><td>boot reply</td></tr><tr><td></td><td>DHCP ACK, 这个新人的IP是我这个DHCP server租的，租约在此！</td></tr></tbody></table><h2 id="IP-地址的收回和续租"><a href="#IP-地址的收回和续租" class="headerlink" title="IP 地址的收回和续租"></a>IP 地址的收回和续租</h2><p>DHCP的IP是有租约的。如果不续约就回收。提前一段时间说续约不续约。</p><p>客户机会在租期过去 50% 的时候，直接向为其提供 IP 地址的 DHCP Server 发送 DHCP request 消息包。客户机接收到该服务器回应的 DHCP ACK 消息包，会根据包中所提供的新的租期以及其他已经更新的 TCP&#x2F;IP 参数，更新自己的配置。这样，IP 租用更新就完成了。</p><h2 id="预启动执行环境（PXE）"><a href="#预启动执行环境（PXE）" class="headerlink" title="预启动执行环境（PXE）"></a>预启动执行环境（PXE）</h2><p>在数据中心，都是新设备，没有操作系统。</p><p>数据中心管理员需要自己安装系统，装好系统后自动分配IP地址，直接启动就能用。</p><p>操作系统启动的过程：</p><p>启动BIOS,读取MBR启动扇区，将GRUB启动起来，权力交给GRUB,GRUB加载内核，加载作为根文件系统的initramfs文件，权力交给内核，内核启动，初始化整个操作系统。</p><p>那我们安装操作系统的过程，只能插在 BIOS 启动之后了。因为没安装系统之前，连启动扇区都没有。因而这个过程叫做预启动执行环境（Pre-boot Execution Environment），简称 PXE。</p><p>PXE 协议分为客户端和服务器端，由于还没有操作系统，只能先把客户端放在 BIOS 里面。当计算机启动时，BIOS 把 PXE 客户端调入内存里面，就可以连接到服务端做一些操作了。</p><p>PXE 客户端自己也需要有个 IP 地址。因为 PXE 的客户端启动起来，就可以发送一个 DHCP 的请求，让 DHCP Server 给它分配一个地址。</p><p>需要知道PXE服务器地址？</p><p>PXE 客户端启动的时候，啥都没有。好在 DHCP Server 除了分配 IP 地址以外，还可以做一些其他的事情。这里有一个 DHCP Server 的一个样例配置：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><br>ddns-update-style interim<span class="hljs-comment">;</span><br>ignore client-updates<span class="hljs-comment">;</span><br>allow booting<span class="hljs-comment">;</span><br>allow bootp<span class="hljs-comment">;</span><br>subnet <span class="hljs-number">192.168</span>.<span class="hljs-number">1.0</span> netmask <span class="hljs-number">255.255</span>.<span class="hljs-number">255.0</span><br>&#123;<br>option routers <span class="hljs-number">192.168</span>.<span class="hljs-number">1.1</span><span class="hljs-comment">;</span><br>option subnet-mask <span class="hljs-number">255.255</span>.<span class="hljs-number">255.0</span><span class="hljs-comment">;</span><br>option time-offset -<span class="hljs-number">18000</span><span class="hljs-comment">;</span><br>default-lease-time <span class="hljs-number">21600</span><span class="hljs-comment">;</span><br>max-lease-time <span class="hljs-number">43200</span><span class="hljs-comment">;</span><br>range dynamic-bootp <span class="hljs-number">192.168</span>.<span class="hljs-number">1.240</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">1.250</span><span class="hljs-comment">;</span><br>filename <span class="hljs-string">&quot;pxelinux.0&quot;</span><span class="hljs-comment">;</span><br>next-server <span class="hljs-number">192.168</span>.<span class="hljs-number">1.180</span><span class="hljs-comment">;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>按照上面的原理，默认的 DHCP Server 是需要配置的，无非是我们配置 IP 的时候所需要的 IP 地址段、子网掩码、网关地址、租期等。如果想使用 PXE，则需要配置 next-server，指向 PXE 服务器的地址，另外要配置初始启动文件 filename。</p><p>这样 PXE 客户端启动之后，发送 DHCP 请求之后，除了能得到一个 IP 地址，还可以知道 PXE 服务器在哪里，也可以知道如何从 PXE 服务器上下载某个文件，去初始化操作系统。</p><h2 id="解析-PXE-的工作过程"><a href="#解析-PXE-的工作过程" class="headerlink" title="解析 PXE 的工作过程"></a>解析 PXE 的工作过程</h2><p>启动 PXE 客户端, 通过DHCP协议向DHCP server获取IP地址、PXE服务器的地址、启动文件pxelinux.0。</p><p>PXE客户端去PXE服务器下载这个文件，初始化机器。下载使用的TFTP协议。PXE服务器上要安装TFTP服务器。</p><p>PXE客户端收到这个文件后，执行这个文件 ，这个文件会指示PXE客户端，向TFTP服务器请求计算机的配置信息pxelinux.cfg。TFTP服务器会给PXE客户端一个配置文件，里面会说内核在哪里、initramfs 在哪里。PXE 客户端会请求这些文件。</p><p>最后，启动 Linux 内核。一旦启动了操作系统，以后就啥都好办了。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nginx已连接的请求去掉负载后是否成功返回</title>
    <link href="/2023/06/27/linux/nginx%E5%B7%B2%E8%BF%9E%E6%8E%A5%E7%9A%84%E8%AF%B7%E6%B1%82%E5%8E%BB%E6%8E%89%E8%B4%9F%E8%BD%BD%E5%90%8E%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F%E8%BF%94%E5%9B%9E/"/>
    <url>/2023/06/27/linux/nginx%E5%B7%B2%E8%BF%9E%E6%8E%A5%E7%9A%84%E8%AF%B7%E6%B1%82%E5%8E%BB%E6%8E%89%E8%B4%9F%E8%BD%BD%E5%90%8E%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F%E8%BF%94%E5%9B%9E/</url>
    
    <content type="html"><![CDATA[<h2 id="nginx已连接的请求去掉负载后是否成功返回"><a href="#nginx已连接的请求去掉负载后是否成功返回" class="headerlink" title="nginx已连接的请求去掉负载后是否成功返回"></a>nginx已连接的请求去掉负载后是否成功返回</h2><h3 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h3><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>1.布署nginx负载两个spring boot 项目</p><p>2.spring boot 项目不同端口</p><p>创建test1方法，直接返回json结果，结果包含端口号。（为了验证项目是否存活，是否负载成功）</p><p>创建test2方法，进入方法打印日志，睡眠30秒，出方法打印日志，返回结果可同test1稍加区别。</p><p>测试步骤：</p><p>1.保证nginx 负载到两个项目</p><p>2.nginx 负载改为轮询,并调用test1方法验证</p><p>3.修改nginx配置文件，去掉一个项目，写好重新加载命令。</p><p>4.浏览器打开两个标签，同时访问test2方法，查看日志，看项目有进入方法的日志。</p><p>5.重新加载nginx配置文件</p><p>6.观察发现，已建立的连接（到负载后面的服务器）也可以返回结果。</p>]]></content>
    
    
    <categories>
      
      <category>nginx</category>
      
    </categories>
    
    
    <tags>
      
      <tag>nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议03ifconfig</title>
    <link href="/2023/06/25/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE03ifconfig/"/>
    <url>/2023/06/25/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE03ifconfig/</url>
    
    <content type="html"><![CDATA[<h2 id="你知道怎么查看-IP-地址吗？"><a href="#你知道怎么查看-IP-地址吗？" class="headerlink" title="你知道怎么查看 IP 地址吗？"></a>你知道怎么查看 IP 地址吗？</h2><p>在 Windows 上是 ipconfig，在 Linux 上是 ifconfig。</p><h3 id="你知道在-Linux-上还有什么其他命令可以查看-IP-地址吗？"><a href="#你知道在-Linux-上还有什么其他命令可以查看-IP-地址吗？" class="headerlink" title="你知道在 Linux 上还有什么其他命令可以查看 IP 地址吗？"></a>你知道在 Linux 上还有什么其他命令可以查看 IP 地址吗？</h3><p> ip addr</p><h3 id="没有ifconfig和ip-addr的linux系统"><a href="#没有ifconfig和ip-addr的linux系统" class="headerlink" title="没有ifconfig和ip addr的linux系统"></a>没有ifconfig和ip addr的linux系统</h3><p>安装net-tools 和 iproute2 这两个工具。</p><h3 id="ip-addr"><a href="#ip-addr" class="headerlink" title="ip addr"></a>ip addr</h3><p>显示了这台机器上所有的网卡。</p><h3 id="ip-addr-与-ifconfig的区别"><a href="#ip-addr-与-ifconfig的区别" class="headerlink" title="ip addr 与 ifconfig的区别"></a>ip addr 与 ifconfig的区别</h3><p>要了解这两个命令的区别，需要先看看它们的历史起源：</p><p>ifconfig 命令归属于 net-tools 工具集。net-tools 起源于 BSD，自 2001 年起，Linux 社区已经停止对其进行维护。</p><p>而 ip 命令归属于 iproute2 工具集，iproute2 旨在取代 net-tools，并提供了一些新功能。</p><p>一些 Linux 发行版已经停止支持 net-tools，只支持 iproute2，在这些 Linux 版本中，只能使用 ip addr 命令查看 IP 地址，使用 ifconfig 会提示命名不存在。</p><p>net-tools 通过 procfs(&#x2F;proc) 和 ioctl 系统调用去访问和改变内核网络配置，而 iproute2 则通过 netlink 套接字接口与内核通讯。</p><p>net-tools 中工具的名字比较杂乱，而 iproute2 则相对整齐和直观，基本是 ip 命令加后面的子命令。</p><h2 id="IP地址"><a href="#IP地址" class="headerlink" title="IP地址"></a>IP地址</h2><p>IP 地址是一个网卡在网络世界的通讯地址，相当于我们现实世界的门牌号码。</p><p>IPV4 32位</p><p>IPV8 128位</p><h3 id="IP地址分类"><a href="#IP地址分类" class="headerlink" title="IP地址分类"></a>IP地址分类</h3><p>A类：0 + 7位网络号 + 24位主机号</p><p>B类：10 + 14位网络号 + 16位主机号</p><p>C类：110 + 21位网络号 + 8 位主机号</p><p>D类：1110 + 28位多播组号</p><p>E类：11110 + 27位留待后用</p><table><thead><tr><th>类别</th><th>IP地址范围</th><th>最大主机数</th><th>私有IP地址范围</th></tr></thead><tbody><tr><td>A</td><td>0.0.0.1 - 127.255.255.254</td><td>16777214</td><td>10.0.0.0 - 255.255.255.255</td></tr><tr><td>B</td><td>128.0.0.1 - 191.255.255.254</td><td>65534</td><td>172.16.0.0 - 172.31.255.255</td></tr><tr><td>C</td><td>192.0.0.1 - 223.255.255.254</td><td>254</td><td>192.168.0.0 - 192.168.255.255</td></tr></tbody></table><p>当含有多台主机和路由的某个机关、单位、公司、机构、组织等申请一个IP地址时：</p><p>1.首先获得(实现上)是一个网络号。根据不同网络的性质，可能是获得A、B、C类地址中的某个网络号;</p><p>2.然后再由本单位根据自身情况自行分配具体的主机号;</p><p>D类是组播地址，使用这一类地址，属于某个组的机器都能收到。</p><p>E类为保留地址，做为研究使用。</p><h3 id="无类型域间选路-CIDR"><a href="#无类型域间选路-CIDR" class="headerlink" title="无类型域间选路(CIDR)"></a>无类型域间选路(CIDR)</h3><p>因为分类的IP化分，C类包含最大主机数量实在太少，B类最大主机数量又太多了。</p><p>所以出现了CIDR，将32位的IP地址一分为二，前面是网络号，后面是主机号。</p><p>10.100.122.2&#x2F;24，这个 IP 地址中有一个斜杠，斜杠后面有个数字 24。这种地址表示形式，就是 CIDR。后面 24 的意思是，32 位中，前 24 位是网络号，后 8 位是主机号。</p><p>伴随着 CIDR 存在的，一个是广播地址，10.100.122.255。如果发送这个地址，所有 10.100.122 网络里面的机器都可以收到。</p><p>另一个是子网掩码，255.255.255.0。将子网掩码和 IP 地址进行 AND 计算。得出10.100.122.0，这就是网络号，将子网掩码和IP地址按位计算AND,就可以得到网络号。</p><h3 id="公有-IP-地址和私有-IP-地址"><a href="#公有-IP-地址和私有-IP-地址" class="headerlink" title="公有 IP 地址和私有 IP 地址"></a>公有 IP 地址和私有 IP 地址</h3><p>在日常的工作中，几乎不用划分 A 类、B 类或者 C 类，所以时间长了，很多人就忘记了这个分类，而只记得 CIDR。但是有一点还是要注意的，就是公有 IP 地址和私有 IP 地址。</p><p>平时我们看到的数据中心里，办公室、家里或学校的 IP 地址，一般都是私有 IP 地址段。这些地址是配置与管理，不同组织可以重复。</p><p>两个小区都有第6栋。</p><p>一般家里的上网设备不会超过256个，所以&#x2F;24基本就够了。也可以用&#x2F;16的CIDR。</p><p>&#x2F;16的网络号是192.168.0。而整个网络里面的第一个地址192.168.0.1，往往是私有网络的出口地址。</p><p>例如：</p><p>家里电脑连接WIFI,WIFI路由器的地址就是192.168.0.1,而192.168.0.1,往往是私有网络的出口地址。</p><h3 id="举例：一个容易“犯错”的CIDR"><a href="#举例：一个容易“犯错”的CIDR" class="headerlink" title="举例：一个容易“犯错”的CIDR"></a>举例：一个容易“犯错”的CIDR</h3><p>16.158.165.91&#x2F;22 这个CIDR。求第一个地址、子网掩码和广播地址。</p><p>16.158.165.1并不是第一个地址。</p><p>第一个地址是16.158.164.1。子网掩码是255.255.252.0。广播地址为 16.158.167.255。</p><h2 id="ip-addr解析"><a href="#ip-addr解析" class="headerlink" title="ip addr解析"></a>ip addr解析</h2><figure class="highlight apache"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="hljs-number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="hljs-number">1000</span><br>    <span class="hljs-attribute">link</span>/loopback <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> brd <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span><br>    <span class="hljs-attribute">inet</span> <span class="hljs-number">127.0.0.1</span>/<span class="hljs-number">8</span> scope host lo<br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br>    <span class="hljs-attribute">inet6</span> ::<span class="hljs-number">1</span>/<span class="hljs-number">128</span> scope host <br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br><span class="hljs-attribute">2</span>: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1500</span> qdisc mq state UP group default qlen <span class="hljs-number">1000</span><br>    <span class="hljs-attribute">link</span>/ether <span class="hljs-number">00</span>:<span class="hljs-number">16</span>:<span class="hljs-number">3</span>e:<span class="hljs-number">10</span>:<span class="hljs-number">7</span>c:b9 brd ff:ff:ff:ff:ff:ff<br>    <span class="hljs-attribute">inet</span> <span class="hljs-number">172.27.72.192</span>/<span class="hljs-number">20</span> brd <span class="hljs-number">172.27.79.255</span> scope global dynamic eth0<br>       <span class="hljs-attribute">valid_lft</span> <span class="hljs-number">312864437</span>sec preferred_lft <span class="hljs-number">312864437</span>sec<br>    <span class="hljs-attribute">inet6</span> fe80::<span class="hljs-number">216</span>:<span class="hljs-number">3</span>eff:fe10:<span class="hljs-number">7</span>cb9/<span class="hljs-number">64</span> scope link <br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br></code></pre></td></tr></table></figure><p>网卡信息中 IP 地址的后面有个 scope，对于 eth0 这张网卡来讲，是 global，说明这张网卡是可以对外的，可以接收来自各个地方的包。对于 lo 来讲，是 host，说明这张网卡仅仅可以供本机相互通信。</p><h3 id="MAC地址"><a href="#MAC地址" class="headerlink" title="MAC地址"></a>MAC地址</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">link</span>/ether <span class="hljs-number">00</span>:<span class="hljs-number">16</span>:<span class="hljs-number">3</span>e:<span class="hljs-number">10</span>:<span class="hljs-number">7</span>c:b9 brd ff:ff:ff:ff:ff:ff<br></code></pre></td></tr></table></figure><p>这个被称为 MAC 地址，是一个网卡的物理地址，用十六进制，6 个 byte 表示。</p><p> 一个网络包要从一个地方传到另一个地方，除了要有确定的地址，还需要有定位功能。</p><p>mac地址就是门牌号，IP就是哪个省市区楼栋。</p><p>MAC 地址更像是身份证，是一个唯一的标识。它的唯一性设计是为了组网的时候，不同的网卡放在一个网络里面的时候，可以不用担心冲突。从硬件角度，保证不同的网卡有不同的标识。</p><p>MAC 地址的通信范围比较小，局限在一个子网里面。</p><h3 id="网络设备的状态标识"><a href="#网络设备的状态标识" class="headerlink" title="网络设备的状态标识"></a>网络设备的状态标识</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-section">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span><br></code></pre></td></tr></table></figure><p>这个叫做 net_device flags，网络设备的状态标识。</p><p>UP 表示网卡处于启动的状态；</p><p>BROADCAST 表示这个网卡有广播地址，可以发送广播包；</p><p>MULTICAST 表示网卡可以发送多播包；</p><p>LOWER_UP 表示 L1 是启动的，也即网线插着呢。</p><p>mtu 1500 最大传输单元 MTU 为 1500，这是以太网的默认值。</p><p>MTU 是二层 MAC 层的概念。MAC 层有 MAC 的头，以太网规定正文部分不允许超过 1500 个字节。正文里面有 IP 的头、TCP 的头、HTTP 的头。如果放不下，就需要分片来传输。</p><p>qdisc 全称是 queueing discipline, 中文叫排队规则。内核如果需要通过某个网络接口发送数据包，它都需要按照为这个接口配置的 qdisc（排队规则）把数据包加入队列。</p><p>qdisc 规则： pfifo 和 pfifo_fast</p><p>pfifo:</p><p>​它不对进入的数据包做任何的处理，数据包采用先入先出的方式通过队列。</p><p>pfifo:</p><p>​它的队列包括三个波段（band）。在每个波段里面，使用先进先出规则。</p><p>​三个波段（band）的优先级也不相同。band 0 的优先级最高，band 2 的最低。如果 band 0 里面有数据包，系统就不会处理 band 1 里面的数据包，band 1 和 band 2 之间也是一样。</p><p>​数据包是按照服务类型（Type of Service，TOS）被分配到三个波段（band）里面的。TOS 是 IP 头里面的一个字段，代表了当前的包是高优先级的，还是低优先级的。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>rabbitmq高可用与高可靠</title>
    <link href="/2023/06/20/mq/rabbitmq%E9%AB%98%E5%8F%AF%E7%94%A8%E4%B8%8E%E9%AB%98%E5%8F%AF%E9%9D%A0/"/>
    <url>/2023/06/20/mq/rabbitmq%E9%AB%98%E5%8F%AF%E7%94%A8%E4%B8%8E%E9%AB%98%E5%8F%AF%E9%9D%A0/</url>
    
    <content type="html"><![CDATA[<h2 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h2><h3 id="单机模式"><a href="#单机模式" class="headerlink" title="单机模式"></a>单机模式</h3><p>单机存在单点故障，随时可能发生宕机。</p><h3 id="普通集群模式"><a href="#普通集群模式" class="headerlink" title="普通集群模式"></a>普通集群模式</h3><table><thead><tr><th>broker1</th><th>broker2</th><th>broker3</th></tr></thead><tbody><tr><td>queue1、2、3的元数据</td><td>queue1、2、3的元数据</td><td>queue1、2、3的元数据</td></tr><tr><td>queue1</td><td>queue2</td><td>queue3</td></tr></tbody></table><p>1.queue的元数据包含了queue的具体信息，例如queue放在哪台broker上，是否持久化等，但不包含发送到queue里的消息;<br>2.单台broker只有集群中部分的queue（queue中包含消息）和集群中所有的queue元数据;<br>3.订阅queue1的消费者若在queue2拉取，则消息会先从queue1传输到queue2，再由消费者进行消费;</p><h3 id="镜像集群模式"><a href="#镜像集群模式" class="headerlink" title="镜像集群模式"></a>镜像集群模式</h3><table><thead><tr><th>broker1</th><th>broker2</th><th>broker3</th></tr></thead><tbody><tr><td>queue1、2、3的元数据</td><td>queue1、2、3的元数据</td><td>queue1、2、3的元数据</td></tr><tr><td>queue1、2、3</td><td>queue1、2、3</td><td>queue1、2、3</td></tr></tbody></table><p>1.无论元数据还是 queue 里的消息都会存在于多个broker上;<br>2.每个queue都想拥有多个镜像放在其他broker上，可以选择镜像队列的数量;<br>3.由于每个broker上都具有近乎完整的数据，所以消费者消费的时候并不需要进行消息传输，但由于并不是想Kafka分布式消息队列那样的分片存储，所以性能并不高;</p><p>RabbitMQ其实并不是分布式消息队列，大厂使用的分布式消息队列，更多是RocketMQ或者Kafka，可以分布式分片存储，水平扩容性能会有明显提升。</p><h2 id="高可靠"><a href="#高可靠" class="headerlink" title="高可靠"></a>高可靠</h2><p>高可靠也分成三个方面，生产者高可靠、MQ高可靠和消费者高可靠</p><p>生产者的高可靠主要是依靠补偿机制来实现的，确保生产者能够将消息发送至MQ，如果发送失败，则需要进行重发</p><h3 id="发送高可靠"><a href="#发送高可靠" class="headerlink" title="发送高可靠"></a>发送高可靠</h3><h4 id="方法一：日志记录-定时任务健康检查-消息补偿"><a href="#方法一：日志记录-定时任务健康检查-消息补偿" class="headerlink" title="方法一：日志记录 + 定时任务健康检查 + 消息补偿"></a>方法一：日志记录 + 定时任务健康检查 + 消息补偿</h4><p>发送消息前，先将消息存入消息表，状态为0;</p><p>开启confirm机制，收到ack后，修改消息对应状态为1;</p><p>定时任务轮询状态为0的消息进行重发，超过3次则标记为异常，人工补偿;</p><h4 id="方法二：消息延迟投递-二次确认-回调检查"><a href="#方法二：消息延迟投递-二次确认-回调检查" class="headerlink" title="方法二：消息延迟投递 + 二次确认 + 回调检查"></a>方法二：消息延迟投递 + 二次确认 + 回调检查</h4><p>生产者发送消息的时候，同时也发送延迟消息，比如60min;<br>消费者订阅到消息后，会给回调检查服务订阅的confirm queue发送消息，消息数据库生成一条记录;<br>回调检查服务订阅了延迟queue，60min过后，消费延迟消息，如果数据库已经存在该消息，则什么都不做，如果数据库不存在，则表明消费者尚未消费该消息，则通知生产者重新发送消息;</p><h3 id="存储高可靠"><a href="#存储高可靠" class="headerlink" title="存储高可靠"></a>存储高可靠</h3><p>RabbitMQ提供了持久化机制，交换器、队列、消息都可以进行持久化。</p><h3 id="消费高可靠"><a href="#消费高可靠" class="headerlink" title="消费高可靠"></a>消费高可靠</h3><p>消费者高可靠，一是保证消息能够被消费者消费（消费者ack机制），二是保证消息重复消费的幂等性</p><p>关于消息消费的幂等性：</p><ol><li>主要是通过一个惟一的键进行查重，比如数据库主键ID</li><li>消息消费的时候，判断该ID是否已经被记录</li><li>如果未记录，则记录该ID，如果已记录，则什么都不做。</li></ol><p>数据库惟一ID、去重表、Redis，基本都是这个思路</p>]]></content>
    
    
    <categories>
      
      <category>rabbitmq</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mq</tag>
      
      <tag>rabbitmq</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JMS与AMQP与MQTT</title>
    <link href="/2023/06/20/mq/JMS%E4%B8%8EAMQP%E4%B8%8EMQTT/"/>
    <url>/2023/06/20/mq/JMS%E4%B8%8EAMQP%E4%B8%8EMQTT/</url>
    
    <content type="html"><![CDATA[<h2 id="JMS"><a href="#JMS" class="headerlink" title="JMS"></a>JMS</h2><p> Java消息服务（Java Message Service),Java平 台中关于⾯向消息中间件的接⼝。</p><p>JMS是⼀种与⼚商⽆关的 API，⽤来访问消息收发系统 消息，它类似于JDBC(Java Database Connectivity)。 这⾥，JDBC 是可以⽤来访问许多不同关系数据库的 API。</p><p>是由Sun公司早期提出的消息标准，旨在为java应⽤提 供统⼀的消息操作，包括create、send、receive。</p><h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><p>⾯向Java平台的标准消息传递API</p><p>在Java或JVM语⾔⽐如Scala、Groovy中具有互⽤性</p><p>⽆需担⼼底层协议</p><p>有queues和topics两种消息传递模型</p><p>⽀持事务、能够定义消息格式（消息头、属性和内容）</p><h3 id="常⻅概念"><a href="#常⻅概念" class="headerlink" title="常⻅概念"></a>常⻅概念</h3><p>JMS提供者：连接⾯向消息中间件的，JMS接⼝的⼀个 实现，RocketMQ,ActiveMQ,Kafka等等</p><p>JMS⽣产者(Message Producer)：⽣产消息的服务 </p><p>JMS消费者(Message Consumer)：消费消息的服务 </p><p>JMS消息：数据对象 </p><p>JMS队列：存储待消费消息的区域 </p><p>JMS主题：⼀种⽀持发送消息给多个订阅者的机制 </p><p>JMS消息通常有两种类型：点对点（Point-to-Point)、 发布&#x2F;订阅（Publish&#x2F;Subscribe）</p><h3 id="基础编程模型"><a href="#基础编程模型" class="headerlink" title="基础编程模型"></a>基础编程模型</h3><p>MQ中需要⽤的⼀些类 </p><p>ConnectionFactory ：连接⼯⼚，JMS ⽤它创建连接 </p><p>Connection ：JMS 客户端到JMS Provider 的连接 </p><p>Session： ⼀个发送或接收消息的线程 </p><p>Destination ：消息的⽬的地;消息发送给谁. </p><p>MessageConsumer &#x2F; MessageProducer： 消息消费者，消息⽣产者</p><h2 id="AMQP"><a href="#AMQP" class="headerlink" title="AMQP"></a>AMQP</h2><p>JMS都没有标准的底层协议，它们可以在任何底层协议上运⾏，但是API是与编程语⾔绑定的，AMQP解决了这个问题，它使⽤了⼀套标准的底层协议。</p><p>AMQP（advanced message queuing protocol）在 2003年时被提出，最早⽤于解决⾦融领不同平台之间 的消息传递交互问题,就是⼀种协议，兼容JMS。</p><p>更准确说的链接协议 binary- wire-level-protocol 直接 定义⽹络交换的数据格式，类似http。</p><p>具体的产品实现⽐较多，RabbitMQ就是其中⼀种。</p><h3 id="特性-1"><a href="#特性-1" class="headerlink" title="特性"></a>特性</h3><p>独⽴于平台的底层消息传递协议 </p><p>消费者驱动消息传递 </p><p>跨语⾔和平台的互⽤性、属于底层协议 </p><p>有5种交换类型direct，fanout，topic，headers， system </p><p>⾯向缓存的、可实现⾼性能、⽀持经典的消息队列，循环，存储和转发 </p><p>⽀持⻓周期消息传递、⽀持事务（跨消息队列）</p><h2 id="AMQP和JMS的主要区别"><a href="#AMQP和JMS的主要区别" class="headerlink" title="AMQP和JMS的主要区别"></a>AMQP和JMS的主要区别</h2><p>1.AMQP不从API层进⾏限定，直接定义⽹络交换的数据 格式,这使得实现了AMQP的provider天然性就是跨平台</p><p>⽐如Java语⾔产⽣的消息，可以⽤其他语⾔⽐如python 的进⾏消费</p><p>2.AQMP可以⽤http来进⾏类⽐，不关⼼实现接⼝的语⾔，只要都按照相应的数据格式去发送报⽂请求，不同语⾔的client可以和不同语⾔的server进⾏通讯</p><p>3.JMS消息类型： TextMessage&#x2F;ObjectMessage&#x2F;StreamMessage等</p><p>AMQP消息类型：Byte[]</p><h2 id="MQTT"><a href="#MQTT" class="headerlink" title="MQTT"></a>MQTT</h2><p>MQTT: 消息队列遥测传输（Message Queueing Telemetry Transport ）</p><p>计算性能不⾼的设备不能适应AMQP上的复杂操 作,MQTT它是专⻔为⼩设备设计的。</p><p>MQTT主要是是物联⽹（IOT）中⼤量的使⽤。</p><h3 id="特性-2"><a href="#特性-2" class="headerlink" title="特性"></a>特性</h3><p>内存占⽤低，为⼩型⽆声设备之间通过低带宽发送 短消息⽽设计。</p><p>不⽀持⻓周期存储和转发，不允许分段消息（很难 发送⻓消息）。</p><p>⽀持主题发布-订阅、不⽀持事务（仅基本确认）。</p><p>消息实际上是短暂的（短周期）。</p><p>简单⽤户名和密码、不⽀持安全连接、消息不透明。</p>]]></content>
    
    
    <categories>
      
      <category>mq</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mq</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>springboot简单使用rabbitmq</title>
    <link href="/2023/06/16/mq/springboot%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8rabbitmq/"/>
    <url>/2023/06/16/mq/springboot%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8rabbitmq/</url>
    
    <content type="html"><![CDATA[<h2 id="初体验"><a href="#初体验" class="headerlink" title="初体验"></a>初体验</h2><p>新建一个maven项目。</p><p>添加父pom：</p><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br></code></pre></td></tr></table></figure><p>添加依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>添加启动类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(MyApplication.class, args);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>添加application.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br></code></pre></td></tr></table></figure><p>这时候启动应该不成问题。</p><p>添加amqp依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>添加消息队列配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#消息队列</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">admin</span><br></code></pre></td></tr></table></figure><p>添加配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> org.springframework.amqp.core.*;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitMQConfig</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">EXCHANGE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;order_exchange&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;order_queue&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 交换机</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Exchange <span class="hljs-title function_">orderExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 这里是build模式</span><br>        <span class="hljs-keyword">return</span> ExchangeBuilder.topicExchange(EXCHANGE_NAME).durable(<span class="hljs-literal">true</span>).build();<br>        <span class="hljs-comment">//return new TopicExchange(EXCHANGE_NAME, true, false);</span><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 队列</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">orderQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> QueueBuilder.durable(QUEUE_NAME).build();<br>        <span class="hljs-comment">//return new Queue(QUEUE_NAME, true,false, false, null);</span><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 交换机和队列绑定关系</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">orderBinding</span><span class="hljs-params">(Queue queue, Exchange exchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="hljs-string">&quot;order.#&quot;</span>).noargs();<br>        <span class="hljs-comment">//return new Binding(QUEUE_NAME, Binding.DestinationType.QUEUE, EXCHANGE_NAME, &quot;order.#&quot;, null);</span><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>消费者：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> org.springframework.amqp.core.Message;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitHandler;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@RabbitListener(queues = &quot;order_queue&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderMQListener</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * RabbitHandler 会⾃动匹配 消息类型（消息⾃动确认）</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> msg</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitHandler</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseCouponRecord</span><span class="hljs-params">(String msg, Message message)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">msgTag</span> <span class="hljs-operator">=</span> message.getMessageProperties().getDeliveryTag();<br>        System.out.println(<span class="hljs-string">&quot;msgTag=&quot;</span>+msgTag);<br>        System.out.println(<span class="hljs-string">&quot;message=&quot;</span>+message);<br>        System.out.println(<span class="hljs-string">&quot;监听到消息：消息内容:&quot;</span>+<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(message.getBody(), <span class="hljs-string">&quot;utf-8&quot;</span>));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>生产者：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.example.MyApplication;<br><span class="hljs-keyword">import</span> org.example.RabbitMQConfig;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-meta">@SpringBootTest(classes = MyApplication.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoApplicationTests</span> &#123;<br><br>  <span class="hljs-meta">@Autowired</span><br>  <span class="hljs-keyword">private</span> RabbitTemplate template;<br><br>  <span class="hljs-meta">@Test</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">send</span><span class="hljs-params">()</span> &#123;<br>   template.convertAndSend(RabbitMQConfig.EXCHANGE_NAME,<span class="hljs-string">&quot;order.new&quot;</span>,<span class="hljs-string">&quot;新订单来啦1&quot;</span>);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>运行spring boot 项目， 再运行单元测试方法send()。看到消费者打印消息。</p><h2 id="可靠性的回调-ConfirmCallback与ReturnsCallback"><a href="#可靠性的回调-ConfirmCallback与ReturnsCallback" class="headerlink" title="可靠性的回调(ConfirmCallback与ReturnsCallback)"></a>可靠性的回调(ConfirmCallback与ReturnsCallback)</h2><h3 id="ConfirmCallback"><a href="#ConfirmCallback" class="headerlink" title="ConfirmCallback"></a>ConfirmCallback</h3><p>⽣产者到交换机</p><p>⽣产者投递消息后，如果Broker收到消息后，会给⽣产 者⼀个ACK。⽣产者通过ACK，可以确认这条消息是否 正常发送到Broker，这种⽅式是消息可靠性投递的核⼼。</p><h4 id="开启confirmCallback"><a href="#开启confirmCallback" class="headerlink" title="开启confirmCallback"></a>开启confirmCallback</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">#旧版，确认消息发送成功，通过实现ConfirmCallBack接⼝，消息发送到交换器Exchange后触发回调</span><br><span class="hljs-attr">spring.rabbitmq.publisher-confirms</span>=<span class="hljs-string">true</span><br><span class="hljs-comment">#新版，NONE值是禁⽤发布确认模式，是默认值，CORRELATED值是发布消息成功到交换器后会触发回调⽅法</span><br><span class="hljs-attr">spring.rabbitmq.publisher-confirm-type</span>:<span class="hljs-string">correlated</span><br></code></pre></td></tr></table></figure><h4 id="代码实例"><a href="#代码实例" class="headerlink" title="代码实例"></a>代码实例</h4><p>注释掉RabbitMQConfig类中代码只留两个静态变量(因为如果这类的代码会创建交换机、队列、绑定关系)。</p><p>在单元测试类中添加：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testConfirmCallback</span><span class="hljs-params">()</span> &#123;<br>    template.setConfirmCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RabbitTemplate</span>.ConfirmCallback() &#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> correlationData 配置</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> ack 交换机是否收到消息，true是成</span><br><span class="hljs-comment">        功，false是失败</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> cause 失败的原因</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(CorrelationData correlationData, <span class="hljs-type">boolean</span> ack, String cause)</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;confirm=====&gt;&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;confirm==== ack=&quot;</span> + ack);<br>            System.out.println(<span class="hljs-string">&quot;confirm==== cause=&quot;</span> + cause);<br>            <span class="hljs-comment">// 根据ACK状态做对应的消息更新操作 TODO</span><br>        &#125;<br>    &#125;);<br><br>    template.convertAndSend(RabbitMQConfig.EXCHANGE_NAME, <span class="hljs-string">&quot;order.new&quot;</span>, <span class="hljs-string">&quot;新订单来啦1&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>直接启动单元测试方法，ack&#x3D;true的消息。</p><p>修改交换机名称，找不到交换机，所有收到ack&#x3D;false的消息和原因。</p><h3 id="ReturnsCallback"><a href="#ReturnsCallback" class="headerlink" title="ReturnsCallback"></a>ReturnsCallback</h3><p>交换机到队列。</p><p>消息从交换器发送到对应队列失败时触发。</p><p>两种模式：</p><p>交换机到队列不成功，则丢弃消息（默认）。</p><p>交换机到队列不成功，返回给消息⽣产者，触发returnCallback。</p><h4 id="开启ReturnsCallback"><a href="#开启ReturnsCallback" class="headerlink" title="开启ReturnsCallback"></a>开启ReturnsCallback</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">#新版</span><br><span class="hljs-attr">spring.rabbitmq.publisher-returns</span>=<span class="hljs-string">true</span><br></code></pre></td></tr></table></figure><h4 id="代码实例-1"><a href="#代码实例-1" class="headerlink" title="代码实例"></a>代码实例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testReturnCallback</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//为true,则交换机处理消息到路由失败，则会返回给⽣产者</span><br>        <span class="hljs-comment">//开启强制消息投递（mandatory为设置为true），但消息未被路由⾄任何⼀个queue，则回退⼀条消息</span><br>        template.setReturnsCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RabbitTemplate</span>.ReturnsCallback() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span><br>            <span class="hljs-title function_">returnedMessage</span><span class="hljs-params">(ReturnedMessage returned)</span> &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> returned.getReplyCode();<br>                System.out.println(<span class="hljs-string">&quot;code=&quot;</span> + code);<br><br>                System.out.println(<span class="hljs-string">&quot;returned=&quot;</span> + returned.toString());<br>            &#125;<br>        &#125;);<br><br>        template.convertAndSend(RabbitMQConfig.EXCHANGE_NAME, <span class="hljs-string">&quot;xxx.order.new&quot;</span>, <span class="hljs-string">&quot;新订单来啦11&quot;</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><p>直接启动单元测试方法，收到code&#x3D;3xx的消息，把消息内容发送回来了。</p><p>把routekey(xxx.order.new) 改为 order.new，这时收不到ReturnsCallback。</p><h4 id="mandatory"><a href="#mandatory" class="headerlink" title="mandatory"></a>mandatory</h4><p>开启强制消息投递（mandatory为设置为true），但消息未被路由至任何一个queue，则回退一条消息到RabbitTemplate.ReturnCallback中的returnedMessage方法。</p><p>浏览RabbitAutoConfiguration发现如下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">determineMandatoryFlag</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">mandatory</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.properties.getTemplate().getMandatory();<br>    <span class="hljs-keyword">return</span> (mandatory != <span class="hljs-literal">null</span> ? mandatory : <span class="hljs-built_in">this</span>.properties.isPublisherReturns());<br>&#125;<br></code></pre></td></tr></table></figure><p>如果设置了mandatory参数，则直接取值；如若mandatory参数为空，则取之于否起开了消息回退，所以设置一个publisher-returns参数即可。</p><h2 id="ACK"><a href="#ACK" class="headerlink" title="ACK"></a>ACK</h2><p>为什么要有ACK机制。因为mq需要知道哪些消息已经发了，哪些没有发。</p><p>消费者从RabbitMQ收到消息并处理完成后，反馈给 RabbitMQ，RabbitMQ收到反馈后才将此消息从队列 中删除。</p><p>消费者在处理消息出现了⽹络不稳定、服务器异常等现 象，那么就不会有ACK反馈，RabbitMQ会认为这个消 息没有正常消费，会将消息重新放⼊队列中。</p><p>只有当消费者正确发送ACK反馈，RabbitMQ确认收到 后，消息才会从RabbitMQ服务器的数据中删除。</p><p>消息的ACK确认机制默认是打开的，消息如未被进⾏ ACK的消息，这条消息被标记为Unacked。</p><h3 id="确认模式"><a href="#确认模式" class="headerlink" title="确认模式"></a>确认模式</h3><p>自动确认和手动确认。</p><p>自动确认就是最初的例子的消费者。</p><h3 id="手动确认"><a href="#手动确认" class="headerlink" title="手动确认"></a>手动确认</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">MANUAL</span><br></code></pre></td></tr></table></figure><p>这时候发送消息，也是可以收到消息的，但是进入rabbit后台管理页面，查看相应的队列，发现消息为Unacked。</p><p>把消费者改为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitHandler</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseCouponRecord</span><span class="hljs-params">(String msg, Message message, <span class="hljs-meta">@Header(AmqpHeaders.DELIVERY_TAG)</span><span class="hljs-type">long</span> deliveryTag, Channel channel)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">msgTag</span> <span class="hljs-operator">=</span> message.getMessageProperties().getDeliveryTag();<br>    System.out.println(<span class="hljs-string">&quot;msgTag=&quot;</span>+msgTag);<br>    System.out.println(<span class="hljs-string">&quot;message=&quot;</span>+message);<br>    System.out.println(<span class="hljs-string">&quot;监听到消息：消息内容:&quot;</span>+<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(message.getBody(), <span class="hljs-string">&quot;utf-8&quot;</span>));<br>    channel.basicAck(deliveryTag, <span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">channel.basicAck(msg.getMessageProperties().getDeliveryTag(),<span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></figure><p>ack表示确认消息。multiple：false只确认该delivery_tag的消息，true确认该delivery_tag前的所有消息（tag&#x3D;10  7、8、9也被确认）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">channel.basicReject(msg.getMessageProperties().getDeliveryTag(),<span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></figure><p>Reject表示拒绝消息。requeue：false表示被拒绝的消息是丢弃；true表示重回队列</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">channel.basicNack(msg.getMessageProperties().getDeliveryTag(),<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></figure><p>nack表示拒绝消息。multiple表示拒绝指定了delivery_tag的所有未确认的消息，requeue表示是不是重回队列</p><p>deliveryTag 表示消息投递序号，每次消费消息或者消息重新投递后， deliveryTag都会增加。</p><h2 id="重试"><a href="#重试" class="headerlink" title="重试"></a>重试</h2><p>我使用spring boot 整合rabbitmq后，在消费者方法中添加异常，但是一直不会等到重试。等看源码时再说吧。</p><p>为什么要重试机制。因为有可能会出现网络波动或者消费者逻辑代码错误。如果自动ACK,消息直接丢了，如果手动ACK直接进入unacked状态，程序断开于rabbitmq的链接后unacked的消息状态会重新变为ready 等待消费。</p><p>如果是代码逻辑问题，重试几次还是不成功，程序员改代码，重启(断开于rabbitmq的连接)，消费。</p><p>如果是网络波动，不管是自动ack还是手动ack都会重试几次，不可能一直波动吧。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>  <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>      <span class="hljs-attr">retry:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-comment"># 重试次数,默认为3次</span><br>          <span class="hljs-attr">max-attempts:</span> <span class="hljs-number">5</span><br>          <span class="hljs-comment"># 重试最大间隔时间</span><br>          <span class="hljs-attr">max-interval:</span> <span class="hljs-string">10000ms</span><br>          <span class="hljs-comment"># 重试初始间隔时间</span><br>          <span class="hljs-attr">initial-interval:</span> <span class="hljs-string">2000ms</span><br>          <span class="hljs-comment"># 间隔时间乘子，间隔时间*乘子=下一次的间隔时间，最大不能超过设置的最大间隔时间</span><br>          <span class="hljs-attr">multiplier:</span> <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>这时我在消费者中修改：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitHandler</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseCouponRecord</span><span class="hljs-params">(String msg, Message message, <span class="hljs-meta">@Header(AmqpHeaders.DELIVERY_TAG)</span><span class="hljs-type">long</span> deliveryTag, Channel channel)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">msgTag</span> <span class="hljs-operator">=</span> message.getMessageProperties().getDeliveryTag();<br>    System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis()));<br>    System.out.println(<span class="hljs-string">&quot;msgTag=&quot;</span>+msgTag);<br>    System.out.println(<span class="hljs-string">&quot;message=&quot;</span>+message);<br>    System.out.println(<span class="hljs-string">&quot;监听到消息：消息内容:&quot;</span>+<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(message.getBody(), <span class="hljs-string">&quot;utf-8&quot;</span>));<br>    <span class="hljs-comment">// 抛出一个运行时异常，模仿消费异常</span><br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>();<br>    <span class="hljs-comment">// channel.basicAck(deliveryTag, false);</span><br>&#125;<br></code></pre></td></tr></table></figure><p>看时间，发现配置生效，只有最后一次会抛出异常。</p><h2 id="死信队列"><a href="#死信队列" class="headerlink" title="死信队列"></a>死信队列</h2><p>什么是TTL？</p><p>time to live 消息存活时间</p><p>如果消息在存活时间内未被消费，则会别清除</p><p>RabbitMQ⽀持两种ttl设置：</p><p>单独消息进⾏配置ttl</p><p>整个队列进⾏配置ttl（使用的居多）</p><p>什么是rabbitmq的死信队列？</p><p>没有被及时消费的消息存放的队列。</p><p>什么是rabbitmq的死信交换机？</p><p>Dead Letter Exchange（死信交换机，缩写：DLX）当 消息成为死信后，会被重新发送到另⼀个交换机，这个交换机就是DLX死信交换机。</p><p>交换机 —-&gt;  队列  —消息过期，成为死信–&gt;  死信交换机 —&gt; 死信队列</p><p>消息有哪⼏种情况成为死信？</p><p>1.消费者拒收消息（basic.reject&#x2F; basic.nack），并且 没有重新⼊队 requeue&#x3D;false。</p><p>2.消息在队列中未被消费，且超过队列或者消息本身的过期时间TTL(time-to-live)。</p><p>3.队列的消息⻓度达到极限。</p><p>消息成为死信后，如果该队列绑定了死信交换机，则消息会被死信交换机重新路由到死信队列。</p><h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>新建一个topic类型的名为dead_exchange的死信交换机，跟普通的交换机是一样的。</p><p>新建一个名为dead_queue的队列，跟普通的队列一样。</p><p>在死信交换机下建立绑定关系，dead_queue   与  dead.#</p><p>新建一个名为product_queue的队列，并设置参数：</p><p>x-message-ttl &#x3D; 10000</p><p>x-dead-letter-exchange &#x3D; dead_exchange</p><p>x-dead-letter-routing-key &#x3D; dead.product</p><p>这时候用管理平台发送消息，10秒后会有消息进入死信队列。</p><p>也可以在发送消息时设置header，expiration &#x3D; 5000， 5秒后会有消息进入死信队列。</p><p>RabbitMQ中TTL设置：</p><p>队列过期时间使⽤参数，对整个队列消息统⼀过期， x-message-ttl， 单位ms(毫秒)。</p><p>消息过期时间使⽤参数（如果队列头部消息未过期，队列中部消息已经过期，中部还在队列⾥⾯）</p><p>两者都配置的话，时间短的先触发。</p><h2 id="延时队列"><a href="#延时队列" class="headerlink" title="延时队列"></a>延时队列</h2><p>什么是延迟队列？</p><p>⼀种带有延迟功能的消息队列，Producer 将消息发送到消息队列服务端，但并不期望这条消息⽴⻢投递，⽽是推迟到在当前时间点之后的某⼀个时间投递到 Consumer 进⾏消费，该消息即定时消息。</p><p>使⽤场景：</p><p>1.通过消息触发⼀些定时任务，⽐如在某⼀固定时间点向 ⽤户发送提醒消息;</p><p>2.⽤户登录之后5分钟给⽤户做分类推送、⽤户多少天未 登录给⽤户做召回推送；</p><p>3.消息⽣产和消费有时间窗⼝要求：⽐如在天猫电商交易 中超时未⽀付关闭订单的场景，在订单创建时会发送⼀ 条 延时消息。这条消息将会在 30 分钟以后投递给消费 者，消费者收到此消息后需要判断对应的订单是否已完 成⽀付。 如⽀付未完成，则关闭订单。如已完成⽀付则忽略。</p><h3 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h3><p>本身没有直接支持延迟队列的功能，但是可以通过TTL和DLX模拟出延迟队列的功能。</p><p>还可以安装rabbitmq_delayed_message_exchange插件来实现。</p><h4 id="TTL和DLX"><a href="#TTL和DLX" class="headerlink" title="TTL和DLX"></a>TTL和DLX</h4><p>这一种实现上面已经在管理平台操作了，转换成代码即可。</p><h4 id="插件方式"><a href="#插件方式" class="headerlink" title="插件方式"></a>插件方式</h4><p>安装插件有别的文章已经写好了。</p><p>声明一个延时队列交换机：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;String, Object&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>args.put(<span class="hljs-string">&quot;x-delayed-type&quot;</span>, <span class="hljs-string">&quot;direct&quot;</span>);<br>channel.exchangeDeclare(<span class="hljs-string">&quot;my-exchange&quot;</span>, <span class="hljs-string">&quot;x-delayed-message&quot;</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, args);<br></code></pre></td></tr></table></figure><p>或者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean(&quot;exchangeA&quot;)</span><br><span class="hljs-keyword">public</span> CustomExchange <span class="hljs-title function_">delayedExchange</span><span class="hljs-params">()</span>&#123;<br>    HashMap&lt;String, Object&gt; arguments = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    <span class="hljs-comment">//自定义交换机的类型</span><br>    arguments.put(<span class="hljs-string">&quot;x-delayed-type&quot;</span>, <span class="hljs-string">&quot;direct&quot;</span>);<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 交换机名</span><br><span class="hljs-comment">     * 交换机类型</span><br><span class="hljs-comment">     * 持久化</span><br><span class="hljs-comment">     * 自动删除</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomExchange</span>(DELAYED_EXCHANGE,<span class="hljs-string">&quot;x-delayed-message&quot;</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,arguments);<br>&#125;<br></code></pre></td></tr></table></figure><p>发送消息：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">send1</span><span class="hljs-params">()</span> &#123;<br>    template.convertAndSend(RabbitMQConfig.EXCHANGE_NAME, <span class="hljs-string">&quot;order.new&quot;</span>, <span class="hljs-string">&quot;新订单来啦1&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessagePostProcessor</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Message <span class="hljs-title function_">postProcessMessage</span><span class="hljs-params">(Message message)</span> <span class="hljs-keyword">throws</span> AmqpException &#123;<br>            message.getMessageProperties().setDelay(<span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);<br>            <span class="hljs-keyword">return</span> message;<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="RabbitmqAdmin使用和到底用不用"><a href="#RabbitmqAdmin使用和到底用不用" class="headerlink" title="RabbitmqAdmin使用和到底用不用"></a>RabbitmqAdmin使用和到底用不用</h2><p>RabbitAdmin类完成对Exchange，Queue，Binging的操作，在容器中管理了RabbitAdmin类的时候，可以对Exchange，Queue，Binging进行自动声明。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> RabbitAdmin <span class="hljs-title function_">rabbitAdmin</span><span class="hljs-params">(ConnectionFactory connectionFactory)</span>&#123;<br>    <span class="hljs-type">RabbitAdmin</span> <span class="hljs-variable">rabbitAdmin</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RabbitAdmin</span>(connectionFactory);<br>    <span class="hljs-comment">//定义Exchange</span><br>    rabbitAdmin.declareExchange(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(<span class="hljs-string">&quot;xxx.direct.exchange&quot;</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>));<br>    <span class="hljs-comment">//定义队列</span><br>    rabbitAdmin.declareQueue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(<span class="hljs-string">&quot;xxx.debug&quot;</span>,<span class="hljs-literal">true</span>));<br>    <span class="hljs-comment">//定义绑定关系</span><br>    rabbitAdmin.declareBinding(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Binding</span>(<span class="hljs-string">&quot;xxx.debug&quot;</span>,Binding.DestinationType.QUEUE,<br>            <span class="hljs-string">&quot;xxx.direct.exchange&quot;</span>,<span class="hljs-string">&quot;xxx.hehe&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>()));<br>    <span class="hljs-keyword">return</span> rabbitAdmin;<br>&#125;<br></code></pre></td></tr></table></figure><p>在spring boot 启动后，会自动创建交换机、队列、绑定关系。</p><h3 id="到底用不用"><a href="#到底用不用" class="headerlink" title="到底用不用"></a>到底用不用</h3><p>用：可以明确绑定关系，在用迁移或者本地搭建的需求时，可以自动创建。</p><p>不用：让运维人员来维护交换机、队列、绑定关系，迁移和本地搭建时比较麻烦，流程规范了也就是繁琐了。</p><h2 id="SimpleMessageListenerContainer"><a href="#SimpleMessageListenerContainer" class="headerlink" title="SimpleMessageListenerContainer"></a>SimpleMessageListenerContainer</h2><p>消息监听器容器</p><p>感觉有一定的局限性，不使用。</p><h2 id="MessageListenerAdapter"><a href="#MessageListenerAdapter" class="headerlink" title="MessageListenerAdapter"></a>MessageListenerAdapter</h2><p>消息监听适配器（adapter），通过反射将消息处理委托给目标监听器的处理方法，并进行灵活的消息类型转换。</p><p>感觉有一定的局限性，不使用。</p><h2 id="MessageConverter"><a href="#MessageConverter" class="headerlink" title="MessageConverter"></a>MessageConverter</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitHandler</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseCouponRecord1</span><span class="hljs-params">(String msg, <span class="hljs-meta">@Header(AmqpHeaders.DELIVERY_TAG)</span><span class="hljs-type">long</span> deliveryTag, Channel channel)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>       System.out.println(<span class="hljs-string">&quot;监听到消息：消息内容1:&quot;</span>+ msg);<br>       channel.basicAck(deliveryTag, <span class="hljs-literal">false</span>);<br>   &#125;<br><br>   <span class="hljs-meta">@RabbitHandler</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseCouponRecord2</span><span class="hljs-params">(Message msg, <span class="hljs-meta">@Header(AmqpHeaders.DELIVERY_TAG)</span><span class="hljs-type">long</span> deliveryTag, Channel channel)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>       System.out.println(<span class="hljs-string">&quot;监听到消息：消息内容2:&quot;</span>+ msg);<br>       channel.basicAck(deliveryTag, <span class="hljs-literal">false</span>);<br>   &#125;<br><br>   <span class="hljs-meta">@RabbitHandler</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseCouponRecord3</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] msg, <span class="hljs-meta">@Header(AmqpHeaders.DELIVERY_TAG)</span><span class="hljs-type">long</span> deliveryTag, Channel channel)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>       System.out.println(<span class="hljs-string">&quot;监听到消息：消息内容3:&quot;</span>+ msg);<br>       channel.basicAck(deliveryTag, <span class="hljs-literal">false</span>);<br>   &#125;<br></code></pre></td></tr></table></figure><p>如果在管理平台发送xxx文字，会发送至方法3。</p><p>spring boot 提供了MessageConverter用于消息的转化。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MessageConverter <span class="hljs-title function_">myMessageConverter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageConverter</span>()&#123;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Message <span class="hljs-title function_">toMessage</span><span class="hljs-params">(Object o, MessageProperties messageProperties)</span> <span class="hljs-keyword">throws</span> MessageConversionException &#123;<br>                System.out.println(<span class="hljs-string">&quot;tomessage1&quot;</span> + o);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Message <span class="hljs-title function_">toMessage</span><span class="hljs-params">(Object object, MessageProperties messageProperties, Type genericType)</span> <span class="hljs-keyword">throws</span> MessageConversionException &#123;<br>                System.out.println(<span class="hljs-string">&quot;tomessage2&quot;</span> + object);<br>                <span class="hljs-keyword">return</span> MessageConverter.<span class="hljs-built_in">super</span>.toMessage(object, messageProperties, genericType);<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">fromMessage</span><span class="hljs-params">(Message message)</span> <span class="hljs-keyword">throws</span> MessageConversionException &#123;<br>                System.out.println(<span class="hljs-string">&quot;fromMessage2&quot;</span> + message);<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(message.getBody(), <span class="hljs-string">&quot;utf-8&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (UnsupportedEncodingException e) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>                &#125;<br>            &#125;<br>        &#125;;<br>    &#125;<br></code></pre></td></tr></table></figure><p>这时候会调用第一个方法。</p><p>spring 根据 contentType 找到适合的处理方法处理。</p><p>方法一：生产者消费者统一contentType</p><p>方法二：设置默认处理方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitHandler(isDefault = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(Message message)</span> &#123;<br>    &#125;<br></code></pre></td></tr></table></figure><p>方法三：把RabbitListener标注在方法上</p><h2 id="实践总结"><a href="#实践总结" class="headerlink" title="实践总结"></a>实践总结</h2><p>一般可以在发送之后保存至可持久化的数据库中。</p><p>在confirmCallback和returnsCallback中修改相应表的状态，如果没有发送成功记录原因等。这样可以快速的排查问题。</p><p>再加上rabbitmqAdmin的用不用。</p><p>最好设置消费者默认处理方法为Message message对象。</p><p>可选消息转换类。</p>]]></content>
    
    
    <categories>
      
      <category>rabbitmq</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mq</tag>
      
      <tag>rabbitmq</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>跟着rabbit官网教程练习</title>
    <link href="/2023/06/15/mq/%E8%B7%9F%E7%9D%80rabbit%E5%AE%98%E7%BD%91%E6%95%99%E7%A8%8B%E7%BB%83%E4%B9%A0/"/>
    <url>/2023/06/15/mq/%E8%B7%9F%E7%9D%80rabbit%E5%AE%98%E7%BD%91%E6%95%99%E7%A8%8B%E7%BB%83%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h2 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h2><p>进入官网<a href="https://www.rabbitmq.com/">https://www.rabbitmq.com/</a></p><p>点击get started</p><p>点击 RabbitMQ Tutorials</p><p>里面有7种教程。</p><p>网上有很多资料都说几种模式，好多图都是从这里来的。</p><h2 id="hello-word"><a href="#hello-word" class="headerlink" title="hello word"></a>hello word</h2><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Common</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException &#123;<br>        <span class="hljs-comment">//1.创建连接工厂</span><br>        <span class="hljs-comment">//MQ采用工厂模式来完成连接的创建</span><br>        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">//2.在工厂对象中设置连接信息(ip,port,virtualhost,username,password)</span><br>        <span class="hljs-comment">//设置MQ安装的服务器ip地址</span><br>        factory.setHost(<span class="hljs-string">&quot;127.0.0.1&quot;</span>);<br>        <span class="hljs-comment">//设置端口号</span><br>        factory.setPort(<span class="hljs-number">5672</span>);<br>        <span class="hljs-comment">//设置虚拟主机名称</span><br>        factory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-comment">//MQ通过用户来管理</span><br>        <span class="hljs-comment">//设置用户名称</span><br>        <span class="hljs-comment">//设置用户密码</span><br>        factory.setUsername(<span class="hljs-string">&quot;admin&quot;</span>);<br>        factory.setPassword(<span class="hljs-string">&quot;123456&quot;</span>);<br>        <span class="hljs-comment">//3.通过工厂对象获取连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> factory.newConnection();<br>        <span class="hljs-keyword">return</span> connection;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Send</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//获取连接</span><br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> Common.getConnection();<br>             <span class="hljs-comment">//创建Channel</span><br>             <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel()) &#123;<br>            <span class="hljs-comment">//通道绑定对应消息队列</span><br>            <span class="hljs-comment">//参数1:  队列名称 如果队列不存在自动创建</span><br>            <span class="hljs-comment">//参数2:  用来定义队列特性是否要持久化 true 持久化队列   false 不持久化</span><br>            <span class="hljs-comment">//参数3:  exclusive 是否独占队列，表示声明的当前队列只允许当前的连接所使用  true 独占队列   false  不独占</span><br>            <span class="hljs-comment">//参数4:  autoDelete: 是否在消费完成后自动删除队列  true 自动删除  false 不自动删除</span><br>            <span class="hljs-comment">//参数5:  额外附加参数</span><br>            channel.queueDeclare(QUEUE_NAME, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Hello World!&quot;</span>;<br>            <span class="hljs-comment">//basicPublish将消息发送到指定的交换机</span><br>            <span class="hljs-comment">//发布消息</span><br>            <span class="hljs-comment">// 参数1:交换机名称</span><br>            <span class="hljs-comment">// 参数2:队列名称</span><br>            <span class="hljs-comment">// 参数3:传递息额外设置（MessageProperties.PERSISTENT_TEXT_PLAIN 设置消息持久化）</span><br>            <span class="hljs-comment">// 参数4:消息的具体内容</span><br>            channel.basicPublish(<span class="hljs-string">&quot;&quot;</span>, QUEUE_NAME, <span class="hljs-literal">null</span>, message.getBytes(StandardCharsets.UTF_8));<br>            System.out.println(<span class="hljs-string">&quot; [x] Sent &#x27;&quot;</span> + message + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (TimeoutException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Recv</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException &#123;<br>        <span class="hljs-comment">//获取连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> Common.getConnection();<br>        <span class="hljs-comment">//创建Channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        <span class="hljs-comment">//通道绑定队列：与生产端一致</span><br>        channel.queueDeclare(QUEUE_NAME, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br><br><br><span class="hljs-comment">//        Consumer consumer = new DefaultConsumer(channel)&#123;</span><br><span class="hljs-comment">//            @Override</span><br><span class="hljs-comment">//            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123;</span><br><span class="hljs-comment">//                String msg = new String(body);</span><br><span class="hljs-comment">//                System.out.println(msg);</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//        &#125;;</span><br><span class="hljs-comment">//        channel.basicConsume(QUEUE_NAME, true, consumer);</span><br><br>        <span class="hljs-type">DeliverCallback</span> <span class="hljs-variable">deliverCallback</span> <span class="hljs-operator">=</span> (consumerTag, delivery) -&gt; &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(delivery.getBody(), StandardCharsets.UTF_8);<br>            System.out.println(<span class="hljs-string">&quot; [x] Received &#x27;&quot;</span> + message + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>        &#125;;<br>        channel.basicConsume(QUEUE_NAME, <span class="hljs-literal">true</span>, deliverCallback, consumerTag -&gt; &#123; &#125;);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="工作队列"><a href="#工作队列" class="headerlink" title="工作队列"></a>工作队列</h2><p>消息⽣产能⼒⼤于消费能⼒，增加多⼏个消费节点</p><p>和简单队列类似，增加多个⼏个消费节点，处于竞争关 系</p><p>默认：多个消费者循环调度。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Send1</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;work_mq_rr&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> Common.getConnection();<br>             <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel()) &#123;<br>            channel.queueDeclare(QUEUE_NAME, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br>            <span class="hljs-comment">//发送 10个 模拟生产者生产能力强</span><br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i++)&#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Hello World!&quot;</span>+i;<br>                channel.basicPublish(<span class="hljs-string">&quot;&quot;</span>, QUEUE_NAME, <span class="hljs-literal">null</span>, message.getBytes(StandardCharsets.UTF_8));<br>                System.out.println(<span class="hljs-string">&quot; [x] Sent &#x27;&quot;</span> + message + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (TimeoutException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.DeliverCallback;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Recv1_1</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;work_mq_rr&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException &#123;<br>        <span class="hljs-comment">//获取连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> Common.getConnection();<br>        <span class="hljs-comment">//创建Channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        <span class="hljs-comment">//通道绑定队列：与生产端一致</span><br>        channel.queueDeclare(QUEUE_NAME, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">DeliverCallback</span> <span class="hljs-variable">deliverCallback</span> <span class="hljs-operator">=</span> (consumerTag, delivery) -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 模拟消费者消费慢</span><br>                TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(delivery.getBody(), StandardCharsets.UTF_8);<br>            System.out.println(Thread.currentThread().getId() + <span class="hljs-string">&quot; [x] Received &#x27;&quot;</span> + message + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>            <span class="hljs-comment">//⼿⼯确认消息消费，不是多条确认</span><br>            channel.basicAck(delivery.getEnvelope().getDeliveryTag(), <span class="hljs-literal">false</span>);<br>        &#125;;<br>        <span class="hljs-comment">// 关闭⾃动确认消息</span><br>        channel.basicConsume(QUEUE_NAME, <span class="hljs-literal">false</span>, deliverCallback, consumerTag -&gt; &#123; &#125;);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.DeliverCallback;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Recv1_2</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;work_mq_rr&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException &#123;<br>        <span class="hljs-comment">//获取连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> Common.getConnection();<br>        <span class="hljs-comment">//创建Channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        <span class="hljs-comment">//通道绑定队列：与生产端一致</span><br>        channel.queueDeclare(QUEUE_NAME, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">DeliverCallback</span> <span class="hljs-variable">deliverCallback</span> <span class="hljs-operator">=</span> (consumerTag, delivery) -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 模拟消费者消费慢</span><br>                TimeUnit.SECONDS.sleep(<span class="hljs-number">3</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(delivery.getBody(), StandardCharsets.UTF_8);<br>            System.out.println(Thread.currentThread().getId() + <span class="hljs-string">&quot; [x] Received &#x27;&quot;</span> + message + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>            <span class="hljs-comment">//⼿⼯确认消息消费，不是多条确认</span><br>            channel.basicAck(delivery.getEnvelope().getDeliveryTag(), <span class="hljs-literal">false</span>);<br>        &#125;;<br>        <span class="hljs-comment">// 关闭⾃动确认消息</span><br>        channel.basicConsume(QUEUE_NAME, <span class="hljs-literal">false</span>, deliverCallback, consumerTag -&gt; &#123; &#125;);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>先启动两个消费者，再启动⽣产者。</p><p>观察发现sleep(1) 的很早接收完5条，sleep(3)的也是接收5条，说明不看处理效率。 </p><h3 id="消费快的消费者多消费"><a href="#消费快的消费者多消费" class="headerlink" title="消费快的消费者多消费"></a>消费快的消费者多消费</h3><p>在消费者添加：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">channel.basicQos(<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p>这时再启动两个消费者，再启动生产者，这时发现sleep(1)收到的消息多，sleep(3)的收到的少。</p><h2 id="发布与订阅"><a href="#发布与订阅" class="headerlink" title="发布与订阅"></a>发布与订阅</h2><p>发布-订阅模型中，消息⽣产者不再是直接⾯对 queue(队列名称)，⽽是直⾯exchange,都需要经过 exchange来进⾏消息的发送, 所有发往同⼀个fanout交 换机的消息都会被所有监听这个交换机的消费者接收到。</p><p>发布订阅-消息模型引⼊fanout交换机。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> channel.queueDeclare().getQueue();<br></code></pre></td></tr></table></figure><p>这个获取的队列是独占的(exclusive:true), 自动删除(autodelete:true)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Send3</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span>  <span class="hljs-variable">EXCHANGE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;exchange_fanout&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> Common.getConnection();<br>             <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel()) &#123;<br>            <span class="hljs-comment">//绑定交换机,fanout扇形，即⼴播类型</span><br>            channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.FANOUT);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Hello World pub !&quot;</span>;<br>            channel.basicPublish(EXCHANGE_NAME, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">null</span>, message.getBytes(StandardCharsets.UTF_8));<br>            System.out.println(<span class="hljs-string">&quot; [x] Sent &#x27;&quot;</span> + message + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (TimeoutException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>消费1与消费2一样</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.DeliverCallback;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Recv3_1</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span>  <span class="hljs-variable">EXCHANGE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;exchange_fanout&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException &#123;<br>        <span class="hljs-comment">//获取连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> Common.getConnection();<br>        <span class="hljs-comment">//创建Channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        <span class="hljs-comment">//绑定交换机,fanout扇形，即⼴播类型</span><br>        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.FANOUT);<br>        <span class="hljs-comment">//获取队列（排它队列）</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> channel.queueDeclare().getQueue();<br>        <span class="hljs-comment">//绑定队列和交换机,fanout交换机不⽤指定routingkey</span><br>        channel.queueBind(queueName, EXCHANGE_NAME,<span class="hljs-string">&quot;&quot;</span>);<br><br>        <span class="hljs-type">DeliverCallback</span> <span class="hljs-variable">deliverCallback</span> <span class="hljs-operator">=</span> (consumerTag, delivery) -&gt; &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(delivery.getBody(), StandardCharsets.UTF_8);<br>            System.out.println(<span class="hljs-string">&quot; [x] Received &#x27;&quot;</span> + message + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>            <span class="hljs-comment">//⼿⼯确认消息消费，不是多条确认</span><br>            channel.basicAck(delivery.getEnvelope().getDeliveryTag(), <span class="hljs-literal">false</span>);<br>        &#125;;<br>        <span class="hljs-comment">// 关闭⾃动确认消息</span><br>        channel.basicConsume(queueName, <span class="hljs-literal">false</span>, deliverCallback, consumerTag -&gt; &#123; &#125;);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>启动两个消费者，再启动生产者，发现两个消费者都能收到同样的消息。</p><h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><p>根据routingkey路由到不同的队列。</p><p>交换机类型是Direct。</p><p>消息⽣产者发送消息给交换机，需要指定routingKey，交换机根据消息的路由key，转发给对应的队列。</p><p>例⼦：⽇志采集系统 ELK </p><p>⼀个队列收集error信息-》告警 </p><p>⼀个队列收集全部信息-》⽇常使⽤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Send4</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">EXCHANGE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;exchange_direct&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> Common.getConnection();<br>             <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel()) &#123;<br>            <span class="hljs-comment">//绑定交换机,直连交换机</span><br>            channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;我是错误⽇志&quot;</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;我是info⽇志&quot;</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">debug</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;我是debug⽇志&quot;</span>;<br>            channel.basicPublish(EXCHANGE_NAME, <span class="hljs-string">&quot;errorRoutingKey&quot;</span>, <span class="hljs-literal">null</span>, error.getBytes(StandardCharsets.UTF_8));<br>            channel.basicPublish(EXCHANGE_NAME, <span class="hljs-string">&quot;infoRoutingKey&quot;</span>, <span class="hljs-literal">null</span>, info.getBytes(StandardCharsets.UTF_8));<br>            channel.basicPublish(EXCHANGE_NAME, <span class="hljs-string">&quot;debugRoutingKey&quot;</span>, <span class="hljs-literal">null</span>, debug.getBytes(StandardCharsets.UTF_8));<br>            System.out.println(<span class="hljs-string">&quot;消息发送成功&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (TimeoutException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.DeliverCallback;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Recv4_1</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">EXCHANGE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;exchange_direct&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException &#123;<br>        <span class="hljs-comment">//获取连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> Common.getConnection();<br>        <span class="hljs-comment">//创建Channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br><br>        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);<br><br>        <span class="hljs-comment">//获取队列（排它队列）</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> channel.queueDeclare().getQueue();<br>        <span class="hljs-comment">//绑定队列和交换机，另外⼀个节点只绑定⼀个errorRoutingKey</span><br>        channel.queueBind(queueName,EXCHANGE_NAME,<span class="hljs-string">&quot;errorRoutingKey&quot;</span>);<br>        channel.queueBind(queueName,EXCHANGE_NAME,<span class="hljs-string">&quot;infoRoutingKey&quot;</span>);<br>        channel.queueBind(queueName,EXCHANGE_NAME,<span class="hljs-string">&quot;debugRoutingKey&quot;</span>);<br><br>        <span class="hljs-type">DeliverCallback</span> <span class="hljs-variable">deliverCallback</span> <span class="hljs-operator">=</span> (consumerTag, delivery) -&gt; &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(delivery.getBody(), StandardCharsets.UTF_8);<br>            System.out.println(<span class="hljs-string">&quot; [x] Received &#x27;&quot;</span> + message + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>            <span class="hljs-comment">//⼿⼯确认消息消费，不是多条确认</span><br>            channel.basicAck(delivery.getEnvelope().getDeliveryTag(), <span class="hljs-literal">false</span>);<br>        &#125;;<br>        <span class="hljs-comment">// 关闭⾃动确认消息</span><br>        channel.basicConsume(queueName, <span class="hljs-literal">false</span>, deliverCallback, consumerTag -&gt; &#123; &#125;);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="主题"><a href="#主题" class="headerlink" title="主题"></a>主题</h2><p>topic交换机⽀持通配符匹配模式</p><p>交换机是 topic, 可以实现发布订阅模式fanout和路由模 式Direct 的功能，更加灵活，⽀持模式匹配，通配符等</p><p>交换机同过通配符进⾏转发到对应的队列，* 代表⼀个 词，#代表1个或多个词，⼀般⽤#作为通配符居多，⽐ 如 #.order, 会匹配 info.order 、sys.error.order, ⽽ *.order ，只会匹配 info.order, 之间是使⽤. 点进⾏分 割多个词的； 如果是 .， 则info.order、error.order都 会匹配。</p><p>例⼦：⽇志采集系统 </p><p>⼀个队列收集订单系统的error⽇志信息，order.log.error</p><p>⼀个队列收集全部系统的全部⽇志信息, #.log</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Send5</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">EXCHANGE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;exchange_topic&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> Common.getConnection();<br>             <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel()) &#123;<br>            <span class="hljs-comment">//绑定交换机,直连交换机</span><br>            channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;我是订单错误⽇志&quot;</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;我是订单info⽇志&quot;</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">debug</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;我是商品debug⽇志&quot;</span>;<br>            channel.basicPublish(EXCHANGE_NAME, <span class="hljs-string">&quot;order.log.error&quot;</span>, <span class="hljs-literal">null</span>, error.getBytes(StandardCharsets.UTF_8));<br>            channel.basicPublish(EXCHANGE_NAME, <span class="hljs-string">&quot;order.log.info&quot;</span>, <span class="hljs-literal">null</span>, info.getBytes(StandardCharsets.UTF_8));<br>            channel.basicPublish(EXCHANGE_NAME, <span class="hljs-string">&quot;product.log.debug&quot;</span>, <span class="hljs-literal">null</span>, debug.getBytes(StandardCharsets.UTF_8));<br>            System.out.println(<span class="hljs-string">&quot;消息发送成功&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (TimeoutException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.DeliverCallback;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Recv5_1</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">EXCHANGE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;exchange_topic&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException &#123;<br>        <span class="hljs-comment">//获取连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> Common.getConnection();<br>        <span class="hljs-comment">//创建Channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br><br>        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);<br><br>        <span class="hljs-comment">//获取队列（排它队列）</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> channel.queueDeclare().getQueue();<br><br>        <span class="hljs-comment">//绑定队列和交换机，节点一配置</span><br>        channel.queueBind(queueName,EXCHANGE_NAME,<span class="hljs-string">&quot;order.log.error&quot;</span>);<br>        <span class="hljs-comment">// 节点二配置</span><br>        <span class="hljs-comment">// channel.queueBind(queueName,EXCHANGE_NAME,&quot;*.log.*&quot;);</span><br><br>        <span class="hljs-type">DeliverCallback</span> <span class="hljs-variable">deliverCallback</span> <span class="hljs-operator">=</span> (consumerTag, delivery) -&gt; &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(delivery.getBody(), StandardCharsets.UTF_8);<br>            System.out.println(<span class="hljs-string">&quot; [x] Received &#x27;&quot;</span> + message + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>            <span class="hljs-comment">//⼿⼯确认消息消费，不是多条确认</span><br>            channel.basicAck(delivery.getEnvelope().getDeliveryTag(), <span class="hljs-literal">false</span>);<br>        &#125;;<br>        <span class="hljs-comment">// 关闭⾃动确认消息</span><br>        channel.basicConsume(queueName, <span class="hljs-literal">false</span>, deliverCallback, consumerTag -&gt; &#123; &#125;);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="待续"><a href="#待续" class="headerlink" title="待续"></a>待续</h2>]]></content>
    
    
    <categories>
      
      <category>rabbitmq</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mq</tag>
      
      <tag>rabbitmq</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>rabbitmq性能测试</title>
    <link href="/2023/06/15/mq/rabbitmq%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/"/>
    <url>/2023/06/15/mq/rabbitmq%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/</url>
    
    <content type="html"><![CDATA[<h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p>rabbitmq提供了测试项目rabbitmq-perf-test</p><p><a href="https://github.com/rabbitmq/rabbitmq-perf-test">https://github.com/rabbitmq/rabbitmq-perf-test</a></p><h2 id="查看帮助"><a href="#查看帮助" class="headerlink" title="查看帮助"></a>查看帮助</h2><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">java -jar perf-test-latest.jar --<span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>一个消费，一个生产 默认12字节的消息大小 接收和发送有1w+ msg&#x2F;s</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">java </span>-<span class="hljs-keyword">jar </span>perf-test-latest.<span class="hljs-keyword">jar </span>-x <span class="hljs-number">1</span> -y <span class="hljs-number">1</span> -h <span class="hljs-string">&quot;amqp://guest:guest@192.168.1.90:5672&quot;</span> -u <span class="hljs-string">&quot;perf-test1&quot;</span> -a --id <span class="hljs-string">&quot;test1&quot;</span><br></code></pre></td></tr></table></figure><p>-x 生产者</p><p>-y 消费者</p><p>-h 地址与用户名密码</p><p>-u 队列名称</p><p>-a 自动ack</p><p>–id  测试ID</p><p>“test1”测试内容。</p><p>一个消费，一个生产 改成 4kb的消息大小 接收和发送只有2000+msg&#x2F;s</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">java</span> -jar perf-test-<span class="hljs-number">2</span>.<span class="hljs-number">18</span>.<span class="hljs-number">0</span>.jar -x <span class="hljs-number">1</span> -y <span class="hljs-number">1</span> -h <span class="hljs-string">&quot;amqp://guest:guest@192.168.1.90:5672&quot;</span> -u <span class="hljs-string">&quot;perf-test1&quot;</span> -a --id <span class="hljs-string">&quot;test1&quot;</span> -s <span class="hljs-number">4000</span><br></code></pre></td></tr></table></figure><p>-s 消息大小</p><h2 id="还有其他测试"><a href="#还有其他测试" class="headerlink" title="还有其他测试"></a>还有其他测试</h2><p>如果不相信官方的测试工具可网上搜下其他的。</p>]]></content>
    
    
    <categories>
      
      <category>rabbitmq</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mq</tag>
      
      <tag>rabbitmq</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>rabbitmq概念</title>
    <link href="/2023/06/15/mq/rabbitmq%E6%A6%82%E5%BF%B5/"/>
    <url>/2023/06/15/mq/rabbitmq%E6%A6%82%E5%BF%B5/</url>
    
    <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>RabbitMQ：<a href="http://www.rabbitmq.com/">http://www.rabbitmq.com/</a></p><p>是⼀个开源的AMQP实现，服务器端⽤Erlang语⾔编写，⽀持多种客户端，如：Python、Ruby、.NET、Java、C、⽤于在分布式系统中存储转发消息，在易⽤<br>性、扩展性、⾼可⽤性等⽅⾯表现不错，与SpringAMQP完美的整合、API丰富易⽤。<br>⽂档：<a href="https://www.rabbitmq.com/getstarted.html">https://www.rabbitmq.com/getstarted.html</a></p><p>RabbitMQ 在吞吐量方面虽然稍逊于 Kafka 和 RocketMQ ，但是由于它基于 erlang 开发，所以并发能力很强，性能极其好，延时很低，达到微秒级。但是也因为 RabbitMQ 基于 erlang 开发，所以国内很少有公司有实力做erlang源码级别的研究和定制。</p><p>如果业务场景对并发量要求不是太高（十万级、百万级），那这些消息队列中，RabbitMQ 一定是你的首选。</p><h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><p><strong>Broker：</strong></p><p>RabbitMQ的服务端程序，可以认为⼀个mq节点就是⼀个broker</p><p><strong>Virtual host 虚拟主机:</strong></p><p>虚拟主机，表示一批交换器、消息队列和相关对象。虚拟主机是共享相同的身份认证和加密环境的独立服务器域。每个 vhost 本质上就是一个 mini 版的 RabbitMQ 服务器，拥有自己的队列、交换器、绑定和权限机制。vhost 是 AMQP 概念的基础，必须在连接时指定，RabbitMQ 默认的 vhost 是 &#x2F; 。<br>⽤于不同业务模块的逻辑隔离，⼀个Virtual Host⾥⾯可以有若⼲个Exchange和Queue，同⼀个VirtualHost ⾥⾯不能有相同名称的Exchange或Queue。</p><p><strong>Connection连接：</strong></p><p>是RabbitMQ的socket连接，它封装了socket协议相关部分逻辑，⼀个连接上可以有多个channel进⾏通信。</p><p><strong>Channel 信道：</strong></p><p>⼀条⽀持多路复⽤的通道，独⽴的双向数据流通道，可以发布、订阅、接收消息。</p><p>信道是建⽴在真实的TCP连接内的虚拟连接，复⽤TCP连接的通道。</p><p><strong>Producer⽣产者：</strong></p><p>创建消息Message，然后发布到RabbitMQ中</p><p><strong>Consumer消费者:</strong></p><p>消费队列⾥⾯的消息</p><p><strong>Message 消息：</strong></p><p>消息，消息是不具名(没有署名)的，它由消息头和消息体组成。消息体是不透明的，而消息头则由一系列的可选属性组成，这些属性包括routing-key（路由键）、priority（相对于其他消息的优先权）、delivery-mode（指出该消息可能需要持久性存储）等。</p><p><strong>RoutingKey 路由键：</strong></p><p>⽣产者将消息发给交换器的时候，⼀般会指定⼀个RoutingKey，⽤来指定这个消息的路由规则。</p><p>最⼤⻓度255 字节。</p><p><strong>Exchange 交换器：</strong></p><p>⽣产者将消息发送到 Exchange，交换器将消息路由到⼀个或者多个队列中，⾥⾯有多个类型，后续再⼀⼀介绍，队列和交换机是多对多的关系。</p><p><strong>Binding 绑定：</strong></p><p>通过绑定将交换器与队列关联起来，在绑定的时候⼀般会指定⼀个绑定键 ( BindingKey )，这样RabbitMQ 就知道如何正确地将消息路由到队列了。</p><p>⽣产者将消息发送给交换器时，需要⼀个RoutingKey，当BindingKey和 RoutingKey相匹配时，消息会被路由到对应的队列中。</p><p><strong>Queue 队列：</strong></p><p>是RabbitMQ 的内部对象，⽤于存储消息，消息都只能存储在队列中。</p><p><img src="/.com//rabbitmq%E6%A6%82%E5%BF%B5%E5%9B%BE.png"></p><h2 id="交换机类型"><a href="#交换机类型" class="headerlink" title="交换机类型"></a>交换机类型</h2><h3 id="Direct-Exchange-定向"><a href="#Direct-Exchange-定向" class="headerlink" title="Direct Exchange 定向"></a>Direct Exchange 定向</h3><p>将⼀个队列绑定到交换机上，要求该消息与⼀个特定的路由键完全匹配。</p><p>例⼦：如果⼀个队列绑定到该交换机上要求路由键 “aabb”，则只有被标记为“aabb”的消息才被转发， 不会转发aabb.cc，也不会转发gg.aabb，只会转发 aabb。</p><p>处理路由键。</p><h3 id="Fanout-Exchange-⼴播"><a href="#Fanout-Exchange-⼴播" class="headerlink" title="Fanout Exchange ⼴播"></a>Fanout Exchange ⼴播</h3><p>只需要简单的将队列绑定到交换机上，⼀个发送到交换机的消息都会被转发到与该交换机绑定的所有队列上。很像⼦⽹⼴播，⼦⽹内每台的主机都获得 了⼀份复制的消息。</p><p>Fanout交换机转发消息是最快的，⽤于发布订阅， ⼴播形式，中⽂是扇形。</p><p>不处理路由键。</p><h3 id="Topic-Exchange-通配符"><a href="#Topic-Exchange-通配符" class="headerlink" title="Topic Exchange 通配符"></a>Topic Exchange 通配符</h3><p>主题交换机是⼀种发布&#x2F;订阅的模式，结合了直连交换机与扇形交换机的特点。</p><p>将路由键和某模式进⾏匹配。此时队列需要绑定要⼀个模式上。</p><p>符号“#”匹配⼀个或多个词，符号“*”匹配不多不少⼀个词。</p><p>例⼦：因此“abc.#”能够匹配到“abc.def.ghi”，但是 “abc.*” 只会匹配到“abc.def”。</p><p>处理路由键。</p><h3 id="Headers-Exchanges（很少使用）"><a href="#Headers-Exchanges（很少使用）" class="headerlink" title="Headers Exchanges（很少使用）"></a>Headers Exchanges（很少使用）</h3><p>根据发送的消息内容中的headers属性进⾏匹配, 在绑定Queue与Exchange时指定⼀组键值对。</p><p>当消息发送到RabbitMQ时会取到该消息的headers 与Exchange绑定时指定的键值对进⾏匹配。</p><p>如果完全匹配则消息会路由到该队列，否则不会路由到该队列。</p><p>不处理路由键</p><h2 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h2><p>进入官网<a href="https://www.rabbitmq.com/">https://www.rabbitmq.com/</a></p><p>点击get started</p><p>点击 RabbitMQ Tutorials</p><p>里面有7种教程。</p><p>网上有很多资料都说几种模式，好多图都是从这里来的。</p>]]></content>
    
    
    <categories>
      
      <category>rabbitmq</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mq</tag>
      
      <tag>rabbitmq</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mq的应用场景</title>
    <link href="/2023/06/15/mq/mq%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/"/>
    <url>/2023/06/15/mq/mq%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/</url>
    
    <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>“消息队列”是在消息的传输过程中保存消息的容器。</p><p>“消息”是在两台计算机间传送的数据单位。消息可以非常简单，例如只包含文本字符串；也可以更复杂，可能包含嵌入对象。消息被发送到队列中。</p><p>“消息队列”是在消息的传输过程中保存消息的容器。</p><p>消息队列管理器在将消息从它的源中继到它的目标时充当中间人。队列的主要目的是提供路由并保证消息的传递；如果发送消息时接收者不可用，消息队列会保留消息，直到可以成功地传递它。</p><p>消息队列中间件是分布式系统中重要的组件，主要解决应用解耦，异步消息，流量削锋等问题，实现高性能，高可用，可伸缩和最终一致性架构。目前使用较多的消息队列有ActiveMQ，RabbitMQ，ZeroMQ，Kafka，MetaMQ，RocketMQ。</p><p>针对MQ的核心场景，我们从异步、解耦、削峰填谷等特性进行分析，区别于传统的RPC调用。尤其在引入中间节点的情况下，通过空间（拥有存储能力）换时间（RPC同步等待响应）的思想，增加更多的可能性和能力。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><h3 id="消息通讯"><a href="#消息通讯" class="headerlink" title="消息通讯"></a>消息通讯</h3><p>作为消息队列，其场景就是实现消息通讯。</p><p>应用举例：微信发消息、QQ聊天群等。</p><p>消息队列主要有两种模式：点对点（Point to Point）模式和发布-订阅（Publisher-Subscriber）模式。</p><h3 id="异步通信"><a href="#异步通信" class="headerlink" title="异步通信"></a>异步通信</h3><p>针对不需要立即处理消息，尤其那种非常耗时的操作，通过消息队列提供了异步处理机制，通过额外的消费线程接管这部分进行异步操作处理。</p><h3 id="应用解耦"><a href="#应用解耦" class="headerlink" title="应用解耦"></a>应用解耦</h3><p>在应用和应用之间，提供了异构系统之间的消息通讯的机制，通过消息中间件解决多个系统或异构系统之间除了RPC之外另一种单向通讯的机制。</p><h3 id="扩展性"><a href="#扩展性" class="headerlink" title="扩展性"></a>扩展性</h3><p>因为消息队列解耦了主流程的处理过程，只要另外增加处理过程即可，不需要改变代码、不需要调整参数，便于分布式扩容。</p><p>例如：使用发布与订阅模型，新增功能只要添加一个新的消息者实现新的功能即可。</p><h3 id="流量削峰"><a href="#流量削峰" class="headerlink" title="流量削峰"></a>流量削峰</h3><p>在秒杀场景，由于峰值访问量过大，超出服务能力，则会压垮服务，导致服务崩溃。此时，可以先将用户的秒杀请求作为消息存入MQ，然后服务再根据自身能力慢慢处理这些请求。</p><p>优点：提示峰值处理能力，提示服务稳定性。</p><p>应用举例：秒杀活动、团购抢单等。</p><h3 id="顺序保证"><a href="#顺序保证" class="headerlink" title="顺序保证"></a>顺序保证</h3><p>在大多使用场景下，数据处理的顺序都很重要。大部分消息队列本来就是排序的，并且能保证数据会按照特定的顺序来进行处理。</p><h3 id="数据流处理"><a href="#数据流处理" class="headerlink" title="数据流处理"></a>数据流处理</h3><p>分布式系统产生的海量数据流，如：业务日志、监控数据、用户行为等，针对这些数据流进行实时或批量采集汇总，然后导入到大数据实时计算引擎，通过消息队列解决异构系统的数据对接能力。</p>]]></content>
    
    
    <categories>
      
      <category>mq</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mq</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>github之前设置过代理后连接不上问题</title>
    <link href="/2023/06/14/git/github%E4%B9%8B%E5%89%8D%E8%AE%BE%E7%BD%AE%E8%BF%87%E4%BB%A3%E7%90%86%E5%90%8E%E8%BF%9E%E6%8E%A5%E4%B8%8D%E4%B8%8A%E9%97%AE%E9%A2%98/"/>
    <url>/2023/06/14/git/github%E4%B9%8B%E5%89%8D%E8%AE%BE%E7%BD%AE%E8%BF%87%E4%BB%A3%E7%90%86%E5%90%8E%E8%BF%9E%E6%8E%A5%E4%B8%8D%E4%B8%8A%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h2 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h2><p>fatal: unable to access ‘<a href="https://github.com/.git/%E2%80%98">https://github.com/.git/‘</a>: Failed to conne拒绝连接</p><h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">git config --global --<span class="hljs-built_in">unset</span> http.proxy <br>git config --global --<span class="hljs-built_in">unset</span> https.proxy<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>rabbitmq内存不足触发内存告警</title>
    <link href="/2023/06/13/mq/rabbitmq%E5%86%85%E5%AD%98%E4%B8%8D%E8%B6%B3%E8%A7%A6%E5%8F%91%E5%86%85%E5%AD%98%E5%91%8A%E8%AD%A6/"/>
    <url>/2023/06/13/mq/rabbitmq%E5%86%85%E5%AD%98%E4%B8%8D%E8%B6%B3%E8%A7%A6%E5%8F%91%E5%86%85%E5%AD%98%E5%91%8A%E8%AD%A6/</url>
    
    <content type="html"><![CDATA[<h2 id="启因"><a href="#启因" class="headerlink" title="启因"></a>启因</h2><p>因为项目是直接拿过来的(有生产无测试环境)，需要搭建测试环境，但是测试环境与生产环境的配置不一致。</p><p>启动项目时提示</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs livecodeserver">Consumer failed <span class="hljs-built_in">to</span> <span class="hljs-built_in">start</span> <span class="hljs-keyword">in</span> <span class="hljs-number">60000</span> <span class="hljs-built_in">milliseconds</span>; does <span class="hljs-keyword">the</span> task executor have enough threads <span class="hljs-built_in">to</span> support <span class="hljs-keyword">the</span> container concurrency?<br></code></pre></td></tr></table></figure><h2 id="网上查询说是rabbitmq内存告警"><a href="#网上查询说是rabbitmq内存告警" class="headerlink" title="网上查询说是rabbitmq内存告警"></a>网上查询说是rabbitmq内存告警</h2><p>在rabbitmq的配置文件里加入</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">vm_memory_high_watermark.absolute</span> = <span class="hljs-number">1073741824</span><br></code></pre></td></tr></table></figure><p>配置文件需要创建。</p><p>查看配置文件路径：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> rabbitmq-defaults<br></code></pre></td></tr></table></figure><p>一般都在&#x2F;etc&#x2F;rabbitmq&#x2F;</p><p>vim rabbitmq.conf</p><p>添加上面的内容。</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stata">配置文件 rabbitmq.<span class="hljs-keyword">conf</span><br>环境变量文件 rabbitmq-env.<span class="hljs-keyword">conf</span><br>补充配置文件 advanced.config<br></code></pre></td></tr></table></figure><h2 id="了解"><a href="#了解" class="headerlink" title="了解"></a>了解</h2><p>RabbitMQ服务器，会在启动时以及执行 rabbitmqctl set_vm_memory_high_watermark 命令时，检测计算机安装的RAM总量。默认情况下，当RabbitMQ服务器使用超过40%的可用RAM空间时，它便会触发告警，并阻塞所有正在发布消息的连接。一旦内存告警被解除（例如，服务器将内存中的消息持久化到磁盘，或者将消息交付给消费者并得到消费者确认），便会恢复正常服务。</p><p>默认的内存阈值，被设置为系统安装RAM的40%。请注意，这不会阻止RabbitMQ使用超过40%的内存，这仅仅是指消息发布者会被限制。在最坏的情况下，Erlang的垃圾回收器可能导致使用的内存量增加一倍（默认情况下，为80%）。所以强烈建议，启用操作系统的swap（linux）或分页文件（windows）。</p><p>32位体系结构倾向于对每个进程施加2GB的内存限制。64位体系结构（例如，AMD64和Intel EM64T）的常见实现是，每个进程仅允许微不足道的256TB。64位Windows将其进一步限制为8TB。但是，请注意，即使在64位操作系统下，一个32位进程也经常只有2GB的最大地址空间可用。</p><p>所有 32 位应用程序都有 4 GB 的进程地址空间（32 位地址最多可以映射 4 GB 的内存）。对于 Microsoft Windows 操作系统，应用程序可以访问 2 GB 的进程地址空间，称为用户模式虚拟地址空间。应用程序拥有的所有线程都共享同一个用户模式虚拟地址空间。其余 2 GB 为操作系统保留（也称为内核模式地址空间）。所有操作系统版本（从 Windows 2000 Server 开始，包括 Windows Server 2003）都有一个 boot.ini 开关，可以为应用程序提供访问 3 GB 的进程地址空间的权限，从而将内核模式地址空间限定为 1 GB。</p><h3 id="配置内存阈值"><a href="#配置内存阈值" class="headerlink" title="配置内存阈值"></a>配置内存阈值</h3><p>可以通过编辑配置文件，来调整触发流控的内存阈值。</p><p>下面的示例，将内存阈值设置为默认的0.4：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">vm_memory_high_watermark</span>.relative = <span class="hljs-number">0</span>.<span class="hljs-number">4</span><br></code></pre></td></tr></table></figure><p>默认值0.4代表40%的可用内存（监测到的），或者可用虚拟地址空间的40%，以较小者为准。例如，在安装了4GiB RAM的32位平台上，4GiB的40%是1.6GiB，但是32位Windows通常将进程限制为2GiB，因此阈值实际上是2GiB的40%（也就是820MiB）。</p><p>或者，可以通过设置一个节点使用的RAM的绝对限制，来调整内存阈值。下面的示例，将阈值设置为1073741824 bytes（1024 MiB）：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">vm_memory_high_watermark.absolute</span> = <span class="hljs-number">1073741824</span><br></code></pre></td></tr></table></figure><p>或者，使用存储单位表示：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">vm_memory_high_watermark.absolute</span> = <span class="hljs-number">1024</span>MiB<br></code></pre></td></tr></table></figure><p>如果设置的绝对限制值，比安装的RAM大，或者比可用的虚拟地址空间大，则阈值被设置为限制值较小的那个。RabbitMQ节点启动时，会将内存阈值配置追加到日志文件，如下：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">2023</span>-<span class="hljs-number">06</span>-<span class="hljs-number">13</span> <span class="hljs-number">10</span>:<span class="hljs-number">06</span>:<span class="hljs-number">34</span>.<span class="hljs-number">692754</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span><span class="hljs-meta"> [info] &lt;0.379.0&gt; Memory high watermark set to 1024 MiB (1073741824 bytes) of 3646 MiB (3823181824 bytes) total</span><br></code></pre></td></tr></table></figure><p>也可以使用如下两条命令查询内存限制配置：</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">rabbitmq-diagnostics memory_breakdown</span><br><span class="hljs-attribute">rabbitmqctl status</span><br></code></pre></td></tr></table></figure><p>在代理运行时，可以使用如下两条命令更改阈值：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml">rabbitmqctl set_vm_memory_high_watermark <span class="hljs-tag">&lt;<span class="hljs-name">fraction</span>&gt;</span><br>rabbitmqctl set_vm_memory_high_watermark absolute <span class="hljs-tag">&lt;<span class="hljs-name">memory_limit</span>&gt;</span><br></code></pre></td></tr></table></figure><p>例如：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">rabbitmqctl</span> set_vm_memory_high_watermark <span class="hljs-number">0</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">rabbitmqctl</span> set_vm_memory_high_watermark absolute “<span class="hljs-number">4</span>G”<br></code></pre></td></tr></table></figure><p>这两个命令都将起作用，直到节点停止运行。要使该设置在节点重启后仍然有效，可以使用配置设置代替。执行此命令时，即使未修改阈值，在具有可热插拔RAM的系统上，内存限制值可能还是会变化，因为查询的是系统RAM的总量。</p><ul><li>M，MiB，兆字节（2 ^ 20字节，1024 * 1024）</li><li>G，GiB，gibibytes（2 ^ 30字节，1024 * 1024 * 1024）</li><li>MB，兆字节（10 ^ 6字节，1000 * 1000）</li><li>GB，千兆字节（10 ^ 9字节， 1000 * 1000 * 1000）</li></ul><p>对于单位的使用，原文使用了G，GiB，也使用了GB，感觉上是有点乱的。</p><p>Gibibyte（giga binary byte的缩写）是信息或计算机硬盘存储的一个单位，简称GiB。由来“GiB”、“KiB”、“MiB”等是于1999年由国际电工协会（IEC）拟定了”KiB”、“MiB”、“GiB”的二进制单位，专用来标示“1024进位”的数据大小。而后，这一标注规范又于2008年并入国际标准化组织（ISO）文件。具体的来说,1GiB&#x3D;1024MiB，1MiB&#x3D;1024KiB。他们与GB、MB、KB是不一样的，GB等则是1000进位的数据单位。根据Wikipedia的注译，GB（gigabyte）是十进制的容量单位，1GB等于1,000,000,000 Bytes。而二进制的容量单位则是用GiB（Gibibyte）就是Giga Binary Byte，相等于1,073,741,824 Bytes。</p>]]></content>
    
    
    <categories>
      
      <category>rabbitmq</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mq</tag>
      
      <tag>rabbitmq</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>rabbitmq安装延时队列插件</title>
    <link href="/2023/06/12/mq/rabbitmq%E5%AE%89%E8%A3%85%E5%BB%B6%E6%97%B6%E9%98%9F%E5%88%97%E6%8F%92%E4%BB%B6/"/>
    <url>/2023/06/12/mq/rabbitmq%E5%AE%89%E8%A3%85%E5%BB%B6%E6%97%B6%E9%98%9F%E5%88%97%E6%8F%92%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<h2 id="下载插件"><a href="#下载插件" class="headerlink" title="下载插件"></a>下载插件</h2><p><a href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases">https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases</a></p><p>版本号需要对应</p><figure class="highlight apache"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">v3</span>.<span class="hljs-number">11</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">This</span> release targets RabbitMQ <span class="hljs-number">3</span>.<span class="hljs-number">11</span>.x and as such, requires Erlang <span class="hljs-number">25</span>.<br></code></pre></td></tr></table></figure><h2 id="解压并启用插件"><a href="#解压并启用插件" class="headerlink" title="解压并启用插件"></a>解压并启用插件</h2><p>把下载的插件直接放到rabbitmq的plugins目录下。</p><p>启用插件</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">rabbitmq-plugins <span class="hljs-built_in">enable</span> rabbitmq_delayed_message_exchange<br></code></pre></td></tr></table></figure><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>进入图形管理界面，exchanges, 点击添加交换机，选择type发现有x-delayed-message选项。</p>]]></content>
    
    
    <categories>
      
      <category>rabbitmq</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mq</tag>
      
      <tag>rabbitmq</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux的zcat</title>
    <link href="/2023/06/09/linux/linux%E7%9A%84zcat%E5%91%BD%E4%BB%A4/"/>
    <url>/2023/06/09/linux/linux%E7%9A%84zcat%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h3 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h3><p>zcat命令用于不真正解压缩文件，就能显示压缩包中文件的内容的场合。zcat是一个命令行实用程序，用于查看压缩文件的内容，而无需对其进行解压缩。 它将压缩文件扩展为标准输出，使您可以查看其内容。 另外，zcat与运行gunzip -c命令完全相同。</p><h3 id="语法格式"><a href="#语法格式" class="headerlink" title="语法格式"></a>语法格式</h3><p>zcat [参数]</p><table><thead><tr><th>-S</th><th>当后缀不是标准压缩包后缀时使用此选项</th></tr></thead><tbody><tr><td>-c</td><td>将文件内容写到标注输出</td></tr><tr><td>-d</td><td>执行解压缩操作</td></tr><tr><td>-l</td><td>显示压缩包中文件的列表</td></tr><tr><td>-L</td><td>显示软件许可信息</td></tr><tr><td>-q</td><td>禁用警告信息</td></tr><tr><td>-r</td><td>在目录上执行递归操作</td></tr><tr><td>-t</td><td>测试压缩文件的完整性</td></tr><tr><td>-V</td><td>显示指令的版本信息</td></tr><tr><td>-l</td><td>更快的压缩速度</td></tr><tr><td>-9</td><td>更高的压缩比</td></tr></tbody></table><h3 id="参考实例"><a href="#参考实例" class="headerlink" title="参考实例"></a>参考实例</h3><p>不解压缩文件的情况下，显示压缩包中文件的内容：</p><figure class="highlight applescript"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs applescript">zcat <span class="hljs-built_in">file</span>.gz<br></code></pre></td></tr></table></figure><p>查看多个压缩文件：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">zcat</span> file1.gz file2.gz<br></code></pre></td></tr></table></figure><p>查看普通文件的内容：</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">zcat -f <span class="hljs-built_in">file</span><br></code></pre></td></tr></table></figure><p>获取压缩文件的属性（压缩大小，未压缩大小，比率 – 压缩率）：</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">zcat -l <span class="hljs-built_in">file</span>.gz<br></code></pre></td></tr></table></figure><p>禁止所有警告：</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">zcat -q <span class="hljs-built_in">file</span>.gz<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>zcat</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>windows安装rabbitmq</title>
    <link href="/2023/06/09/mq/windows%E5%AE%89%E8%A3%85rabbitmq/"/>
    <url>/2023/06/09/mq/windows%E5%AE%89%E8%A3%85rabbitmq/</url>
    
    <content type="html"><![CDATA[<h3 id="安装Erlang"><a href="#安装Erlang" class="headerlink" title="安装Erlang"></a>安装Erlang</h3><p><a href="https://www.erlang.org/">https://www.erlang.org/</a></p><p>点击download</p><p><a href="https://www.erlang.org/downloads">https://www.erlang.org/downloads</a></p><p>下载安装即可</p><h3 id="安装rabbitmq-server"><a href="#安装rabbitmq-server" class="headerlink" title="安装rabbitmq-server"></a>安装rabbitmq-server</h3><p><a href="https://www.rabbitmq.com/">https://www.rabbitmq.com/</a></p><p>搜索 Download</p><p>点击 Download + installation</p><p>点击 install windows</p><p>下载<a href="https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.12.0/rabbitmq-server-3.12.0.exe">rabbitmq-server-3.12.0.exe</a></p><p>图形化的安装。</p><p>安装完成后，这时windows服务已经启动。</p><p>执行 rabbitmqctl.bat status</p><p>有可能会出现</p><figure class="highlight pgsql"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs pgsql">Error: unable <span class="hljs-keyword">to</span> <span class="hljs-keyword">perform</span> an operation <span class="hljs-keyword">on</span> node <span class="hljs-string">&#x27;rabbit@DESKTOP-UVTEHFR&#x27;</span>. Please see <span class="hljs-keyword">diagnostics</span> information <span class="hljs-keyword">and</span> suggestions below.<br></code></pre></td></tr></table></figure><p>rabbitmq在报错信息之后给出了一些建议的解决办法</p><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs vhdl">Most common reasons <span class="hljs-keyword">for</span> this are:<br><br> * Target node <span class="hljs-keyword">is</span> unreachable (e.g. due <span class="hljs-keyword">to</span> hostname resolution, TCP connection <span class="hljs-keyword">or</span> firewall issues)<br><br> * CLI tool fails <span class="hljs-keyword">to</span> authenticate <span class="hljs-keyword">with</span> the server (e.g. due <span class="hljs-keyword">to</span> CLI tool<span class="hljs-symbol">&#x27;s</span> Erlang cookie <span class="hljs-keyword">not</span> matching that <span class="hljs-keyword">of</span> the server)<br><br> * Target node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> running<br><br><span class="hljs-keyword">In</span> addition <span class="hljs-keyword">to</span> the diagnostics info below:<br><br> * See the CLI, clustering <span class="hljs-keyword">and</span> networking guides <span class="hljs-keyword">on</span> http://rabbitmq.com/documentation.html <span class="hljs-keyword">to</span> learn more<br></code></pre></td></tr></table></figure><p>一般是第二条</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">CLI tool fails <span class="hljs-keyword">to</span> authenticate <span class="hljs-keyword">with</span> the server (e.g. due <span class="hljs-keyword">to</span> CLI tool<span class="hljs-comment">&#x27;s Erlang cookie not matching that of the server)</span><br></code></pre></td></tr></table></figure><p>Erlangcookie不匹配</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">C:\Windows\System32\config\systemprofile\<span class="hljs-selector-class">.erlang</span><span class="hljs-selector-class">.cookie</span><br>与<br>C:\用户\你的用户名\<span class="hljs-selector-class">.erlang</span><span class="hljs-selector-class">.cookie</span><br>不匹配，把这两个改成一个就可以了，覆盖就可以了<br></code></pre></td></tr></table></figure><p>这时右键我的电脑-&gt;管理-&gt;服务和应用程序  停止rabbitmq服务  启动rabbitmq服务。</p><p>这时再一执行rabbitmqctl.bat status， 显示正常。</p><h4 id="启用web管理"><a href="#启用web管理" class="headerlink" title="启用web管理"></a>启用web管理</h4><p>rabbitmq-plugins enable rabbitmq_management</p><p>浏览器访问：<a href="http://localhost:15672/%EF%BC%8C%E9%BB%98%E8%AE%A4%E8%B4%A6%E5%8F%B7%E5%92%8C%E5%AF%86%E7%A0%81%E4%B8%BA%EF%BC%9Aguest">http://localhost:15672/，默认账号和密码为：guest</a></p><p>登录进去后就可以看到交换机和队列了。</p><p>也可以点击admin添加用户</p>]]></content>
    
    
    <categories>
      
      <category>rabbitmq</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mq</tag>
      
      <tag>rabbitmq</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>git改分支名master改main</title>
    <link href="/2023/06/08/git/git%E6%94%B9%E5%88%86%E6%94%AF%E5%90%8Dmaster%E6%94%B9main/"/>
    <url>/2023/06/08/git/git%E6%94%B9%E5%88%86%E6%94%AF%E5%90%8Dmaster%E6%94%B9main/</url>
    
    <content type="html"><![CDATA[<figure class="highlight pgsql"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs pgsql">GitHub <span class="hljs-keyword">is</span> working <span class="hljs-keyword">on</span> replacing the term “master” <span class="hljs-keyword">on</span> its service <span class="hljs-keyword">with</span> a neutral term <span class="hljs-keyword">like</span> “main” <span class="hljs-keyword">to</span> avoid <span class="hljs-keyword">any</span> unnecessary <span class="hljs-keyword">references</span> <span class="hljs-keyword">to</span> slavery<br></code></pre></td></tr></table></figure><p>github觉得<strong>master</strong>有点slavery那味。</p><p>我们将本地仓库的<strong>master</strong>分支改名为**main</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git branch -m master main<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议网络分层</title>
    <link href="/2023/06/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE02%E7%BD%91%E7%BB%9C%E5%88%86%E5%B1%82/"/>
    <url>/2023/06/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE02%E7%BD%91%E7%BB%9C%E5%88%86%E5%B1%82/</url>
    
    <content type="html"><![CDATA[<p>  计算机网络有一个显著的特点，就是这是一个仅需要背诵，而且特别需要将原理烂熟于心的学科。</p><p>网络为什么要分层？</p><p>因为是个复杂的程序都要分层。</p><p>复杂的程序都要分层，这是程序设计的要求。</p><p>只要在网络上跑的包，都是完整的。可以有下层没有上层，绝对不可能有上层没下层。</p><p>所以，对TCP协议来说，三次握手也好，重试也好，只要想发出去包，就要有IP层和MAC层，不然发不出去。</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>趣谈网络协议开始</title>
    <link href="/2023/06/06/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE01%E5%BC%80%E5%A7%8B/"/>
    <url>/2023/06/06/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE01%E5%BC%80%E5%A7%8B/</url>
    
    <content type="html"><![CDATA[<p> 从计算机出现后，就出现了协议的概念。</p><p>代码就是人和计算机沟通的协议，只有通过这种协议 ，计算机才知道我们想让它做什么。</p><p>协议三要素：</p><p>语法：规则</p><p>语义：函义</p><p>顺序：先做啥，后干啥。</p><p>网络协议：如何让一片机器做什么。</p><p>只有通过网络协议，才能使一片机器互相协作、共同完成一件事。</p><p>网络协议：</p><p>应用层：DHCP&#x2F;HTTP&#x2F;HTTPS&#x2F;RTMP&#x2F;P2P&#x2F;DNS&#x2F;GTP&#x2F;RPC</p><p>传输层：UDP&#x2F;TCP</p><p>网络层：ICMP&#x2F;IP&#x2F;OSRF&#x2F;BGP&#x2F;IPSec&#x2F;GRE</p><p>链路层：ARP&#x2F;VLAN&#x2F;STP</p><p>物理层:网络跳线</p><p>URL</p><p>DNS</p><p>HTTPDNS</p><p>IP</p><p>HTTP</p><p>HTTPS</p><p>UDP</p><p>TCP</p><p>DHCP</p><p>ARP</p><p>网卡</p><p>网关</p><p>路由表</p><p>路由协议：OSPF和BGP</p><p>TCP重试</p><p>RPC</p>]]></content>
    
    
    <categories>
      
      <category>网络协议</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>文件上传413错误</title>
    <link href="/2023/05/31/linux/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0413%E9%94%99%E8%AF%AF/"/>
    <url>/2023/05/31/linux/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0413%E9%94%99%E8%AF%AF/</url>
    
    <content type="html"><![CDATA[<h2 id="上传文件报413错误"><a href="#上传文件报413错误" class="headerlink" title="上传文件报413错误"></a>上传文件报413错误</h2><p>其实不是上传文件的问题。查看请求body的大小，在Content-Length后显示，nginx默认的request body 为1M,  content-length单位为b。</p><p>在nginx配置文件nginx.cnf中在http{}段中加入 client_max_body_size 20m。</p>]]></content>
    
    
    <categories>
      
      <category>nginx</category>
      
    </categories>
    
    
    <tags>
      
      <tag>nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>git强制提交忽略文件到远程</title>
    <link href="/2023/05/31/git/git%E5%BC%BA%E5%88%B6%E6%8F%90%E4%BA%A4%E5%BF%BD%E7%95%A5%E6%96%87%E4%BB%B6%E5%88%B0%E8%BF%9C%E7%A8%8B/"/>
    <url>/2023/05/31/git/git%E5%BC%BA%E5%88%B6%E6%8F%90%E4%BA%A4%E5%BF%BD%E7%95%A5%E6%96%87%E4%BB%B6%E5%88%B0%E8%BF%9C%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>平时使用git时都会把项目中的target目录屏蔽掉，但是有时候就是需要用这个目录怎么办呢？</p><h3 id="1-方法一"><a href="#1-方法一" class="headerlink" title="1.方法一"></a>1.方法一</h3><p>之前我都是直接把.gitignore文件中的&#x2F;target目录去掉，等把需要的这个target文件提交后再把.gitignore改回来，这样比较麻烦。</p><h3 id="2-方法二"><a href="#2-方法二" class="headerlink" title="2.方法二"></a>2.方法二</h3><p>强制提交忽略的文件到git。</p><p>如下，找到文件位置，使用git add -f 文件名 命令来强制提交该文件到git，</p><p>并且以后再次提交的时候就已经可以正常提交，不需要强制提交。</p>]]></content>
    
    
    <categories>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>git忽略文件不起作用的原因及解决办法</title>
    <link href="/2023/05/31/git/git%E5%BF%BD%E7%95%A5%E6%96%87%E4%BB%B6%E4%B8%8D%E8%B5%B7%E4%BD%9C%E7%94%A8%E7%9A%84%E5%8E%9F%E5%9B%A0%E5%8F%8A%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/"/>
    <url>/2023/05/31/git/git%E5%BF%BD%E7%95%A5%E6%96%87%E4%BB%B6%E4%B8%8D%E8%B5%B7%E4%BD%9C%E7%94%A8%E7%9A%84%E5%8E%9F%E5%9B%A0%E5%8F%8A%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>你们有没有在使用git的时候会遇到这种情况。在开发过程中，我们会在 .gitignore 文件中添加一些忽略项，然而当我们push到远程的时候会出现一个问题,那就是我们在 .gitignore 添加的文件仍然push到了远程。</p><h2 id="错误原因"><a href="#错误原因" class="headerlink" title="错误原因"></a>错误原因</h2><p>我们首次将项目push到远程的时候,没有创建 .gitignore 文件。之后我们想创建 .gitignore 文件并添加忽略项时,发现并不会起作用.  为什么我们后来添加不会起作用呢?  是因为我们在项目第一次push 之前已经将项目的所有文件在本地进行了缓存(commit)或者说是所有的项目已经被跟踪(track)纳入版本管理中。所以我们再添加忽略项的时候没有作用。</p><h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><p>切记一定要按步骤完成, 不要清除本地缓存后,直接commit,否则你会发现远程仓库文件全没了。</p><p>一定要      清除缓存 &#x3D;&#x3D;&gt;  add .  &#x3D;&#x3D;&gt;  commit &#x3D;&#x3D;&gt; push </p><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">1. git <span class="hljs-built_in">rm</span> -r --cached .     <br>或者<br>1. git <span class="hljs-built_in">rm</span> -r --cached  不需要跟踪的文件名  <br><br>2. git add .<br>3. git commit -m <span class="hljs-string">&quot;update .gitignore&quot;</span><br>4. git push origin 远程分支名<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nginx地址截断</title>
    <link href="/2023/05/30/linux/nginx%E5%9C%B0%E5%9D%80%E6%88%AA%E6%96%AD/"/>
    <url>/2023/05/30/linux/nginx%E5%9C%B0%E5%9D%80%E6%88%AA%E6%96%AD/</url>
    
    <content type="html"><![CDATA[<h2 id="地址截断"><a href="#地址截断" class="headerlink" title="地址截断"></a>地址截断</h2><h3 id="使用location上的路径"><a href="#使用location上的路径" class="headerlink" title="使用location上的路径"></a>使用location上的路径</h3><p><strong>location 中的 root 和 alias</strong></p><ul><li>root 指令只是将搜索的根设置为 root 设定的目录，即不会截断 uri，而是使用原始 uri 跳转该目录下查找文件</li><li>aias 指令则会截断匹配的 uri，然后使用 alias 设定的路径加上剩余的 uri 作为子路径进行查找</li></ul><p>示例 1：root</p><figure class="highlight awk"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#------------目录结构----------</span><br><span class="hljs-regexp">/www/</span>x1/index.html<br><span class="hljs-regexp">/www/</span>x2/index.html<br><br><span class="hljs-comment">#--------配置-----------------------</span><br>index index.html index.php;<br>location <span class="hljs-regexp">/x/</span> &#123;<br>    root <span class="hljs-string">&quot;/www/&quot;</span>;<br>&#125;<br><br><span class="hljs-comment">#-------访问--------------</span><br>curl http:<span class="hljs-regexp">//</span>localhost<span class="hljs-regexp">/x1/i</span>ndex.html<br>curl http:<span class="hljs-regexp">//</span>localhost<span class="hljs-regexp">/x2/i</span>ndex.html<br></code></pre></td></tr></table></figure><p>示例 2：alias</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#----------配置-----------------</span><br>location <span class="hljs-regexp">/y/</span>z/ &#123;<br>    alias <span class="hljs-regexp">/www/</span>x1/;<br>&#125;<br><br><span class="hljs-comment">#---------访问--------------</span><br>curl http:<span class="hljs-regexp">//</span>localhost<span class="hljs-regexp">/y/</span>z/index.html<br></code></pre></td></tr></table></figure><p><strong>location 中的 proxy_pass 的 uri</strong></p><p>如果 proxy_pass 的 url 不带 uri</p><p>如果尾部是”&#x2F;“，则会截断匹配的uri</p><p>如果尾部不是”&#x2F;“，则不会截断匹配的uri</p><p>如果proxy_pass的url带uri，则会截断匹配的uri</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#-------servers配置--------------------</span><br>location / &#123;<br>    <span class="hljs-built_in">echo</span> <span class="hljs-variable">$uri</span>    <span class="hljs-comment">#回显请求的uri</span><br>&#125;<br><br><span class="hljs-comment">#--------proxy_pass配置---------------------</span><br>location /t1/ &#123; proxy_pass http://servers; &#125;    <span class="hljs-comment">#正常，不截断</span><br>location /t2/ &#123; proxy_pass http://servers/; &#125;    <span class="hljs-comment">#正常，截断</span><br>location /t3  &#123; proxy_pass http://servers; &#125;    <span class="hljs-comment">#正常，不截断</span><br>location /t4  &#123; proxy_pass http://servers/; &#125;    <span class="hljs-comment">#正常，截断</span><br>location /t5/ &#123; proxy_pass http://servers/test/; &#125;    <span class="hljs-comment">#正常，截断</span><br>location /t6/ &#123; proxy_pass http://servers/test; &#125;    <span class="hljs-comment">#缺&quot;/&quot;，截断</span><br>location /t7  &#123; proxy_pass http://servers/test/; &#125;    <span class="hljs-comment">#含&quot;//&quot;，截断</span><br>location /t8  &#123; proxy_pass http://servers/test; &#125;    <span class="hljs-comment">#正常，截断</span><br><span class="hljs-comment">#---------访问----------------------</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">seq</span> 6)<br><span class="hljs-keyword">do</span><br>    url=http://localhost/t<span class="hljs-variable">$i</span>/doc/index.html<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;-----------<span class="hljs-variable">$url</span>-----------&quot;</span><br>    curl url<br><span class="hljs-keyword">done</span><br><br><span class="hljs-comment">#--------结果---------------------------</span><br>----------http://localhost:8080/t1/doc/index.html------------<br>/t1/doc/index.html<br><br>----------http://localhost:8080/t2/doc/index.html------------<br>/doc/index.html<br><br>----------http://localhost:8080/t3/doc/index.html------------<br>/t3/doc/index.html<br><br>----------http://localhost:8080/t4/doc/index.html------------<br>/doc/index.html<br><br>----------http://localhost:8080/t5/doc/index.html------------<br>/test/doc/index.html<br><br>----------http://localhost:8080/t6/doc/index.html------------<br>/testdoc/index.html<br><br>----------http://localhost:8080/t7/doc/index.html------------<br>/test//doc/index.html<br><br>----------http://localhost:8080/t8/doc/index.html------------<br>/test/doc/index.html<br></code></pre></td></tr></table></figure><h3 id="正则判断"><a href="#正则判断" class="headerlink" title="正则判断"></a>正则判断</h3><p>比如，<a href="http://baidu.com/sina/search/hello.com">http://baidu.com/sina/search/hello.com</a></p><p>我想截取sina后面的路径作为代理，就可以这么写</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span><span class="hljs-regexp"> ^~</span> /sina/&#123;<br><span class="hljs-attribute">if</span> (<span class="hljs-variable">$request_uri</span> <span class="hljs-regexp">~ /sina/(.+))</span><br>&#123;<br><span class="hljs-attribute">set</span> <span class="hljs-variable">$rightUrl</span> <span class="hljs-variable">$1</span>;<br>&#125;<br><span class="hljs-attribute">proxy_pass</span> http://127.0.0.1:8080/<span class="hljs-variable">$rightUrl</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>假设你想截取两个字符串之间的字符，可以这么写</p><p>我想截取(<a href="http://baidu.com/test/AcenterB)A%E5%92%8CB%E4%B9%8B%E9%97%B4%E7%9A%84%E5%AD%97%E7%AC%A6%EF%BC%9A">http://baidu.com/test/AcenterB)A和B之间的字符：</a></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span><span class="hljs-regexp"> ^~</span> /test/&#123;<br>       <span class="hljs-attribute">if</span> (<span class="hljs-variable">$request_uri</span> <span class="hljs-regexp">~ A(.*?)B</span> )<br>       &#123;<br>               <span class="hljs-attribute">set</span> <span class="hljs-variable">$center</span> <span class="hljs-variable">$1</span>;<br>       &#125;<br>       <span class="hljs-attribute">proxy_pass</span> http://127.0.0.1:8080/<span class="hljs-variable">$center</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>location语法规则</p><p>​    location [&#x3D;|<del>|</del>*|^~|@] &#x2F;uri&#x2F; { … } </p><p>location分为两个部分</p><h4 id="第一个部分"><a href="#第一个部分" class="headerlink" title="第一个部分"></a>第一个部分</h4><p>​    [&#x3D;|<del>|</del>*|^~|@] </p><p>​      &#x3D; : 表示精确匹配后面的url<br>​      ~ : 表示正则匹配，但是区分大小写<br>​      <del>* : 正则匹配，不区分大小写<br>​      ^</del> : 表示普通字符匹配，如果该选项匹配,只匹配该选项.不匹配别的选项,一般用来匹配目录<br>​     @ : “@” 定义一个命名的 location，使用在内部定向时，例如 error_page</p><div class="code-wrapper"><pre><code class="hljs">  = 是精确完整匹配, 且优先级最高 正则匹配时，如果 ~ 和 ^~ 同时匹配规则，则 ^~ 优先  ^~ 这个不会匹配请求url中后面的路径, 如上面的 /test/hello 没有匹配上 ^~ 不支持正则，和=相比，范围更广， hellowo 是可以被^~匹配，但是 = 不会匹配 ~ 路径中只要包含就可以匹配，如上面的 /test/hellowo 返回了602</code></pre></div><h4 id="第二个部分"><a href="#第二个部分" class="headerlink" title="第二个部分"></a>第二个部分</h4><p>&#x2F;uri&#x2F;  这里主要填的就是需要匹配的path路径,根据前面的符号,这里可以填写精确的path路径.也可以填正则表达式,下面则主要针对正则进行说明</p><p>​      . ： 匹配除换行符以外的任意字符<br>​      ? ： 重复0次或1次<br>​      + ： 重复1次或更多次<br>​      * ： 重复0次或更多次<br>​      \d ：匹配数字<br>​      ^ ： 匹配字符串的开始<br>​     $ ： 匹配字符串的介绍<br>​     {n} ： 重复n次<br>​     {n,} ： 重复n次或更多次<br>​     [c] ： 匹配单个字符c<br>​     [a-z] ： 匹配a-z小写字母的任意一个<br>​    小括号()之间匹配的内容,可以在后面通过$1来引用,$2表示的是前面第二个()里的内容.正则里面容易让人困惑的是\转义特殊字符。</p>]]></content>
    
    
    <categories>
      
      <category>nginx</category>
      
    </categories>
    
    
    <tags>
      
      <tag>nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>session共享</title>
    <link href="/2023/05/30/java/session%E5%85%B1%E4%BA%AB/"/>
    <url>/2023/05/30/java/session%E5%85%B1%E4%BA%AB/</url>
    
    <content type="html"><![CDATA[<h2 id="session共享问题的由来"><a href="#session共享问题的由来" class="headerlink" title="session共享问题的由来"></a>session共享问题的由来</h2><p>session共享是因为架构演变而出现的问题。</p><p>项目由初期直接使用一台tomcat做为web服务器，这时是没有session问题。</p><p>项目到nginx做动静分离，还是一台tomcat做为web服务器，这时是没有session问题。</p><p>项目到nginx做负载均衡，后端是多台tomcat时，还使用tomcat的session，这时就会出现session问题。</p><h2 id="session共享的解决方案"><a href="#session共享的解决方案" class="headerlink" title="session共享的解决方案"></a>session共享的解决方案</h2><p>client-&gt;nginx-&gt;tomcat</p><p>方案1：nginx使用ip_hash负载均衡算法，这样同一个ip请求的是一直是一个tomcat，所以使用的session也是一个。</p><p>方案2：tomcat内置session同步</p><p>方案3：增加后端组件存储session。数据库：mysql&#x2F;mongodb 、redis、memcached</p><p>方案4：存储在client,  jwt</p><p>方案对比：</p><p>​在项目初期使用方案1,配置简单，但是因为是ip_hash，这样如果是一批ip都请求到一个tomcat，这时候就造成一个tomcat空闲，一个忙的情况。</p><p>​为了解决造成一个tomcat空闲，一个忙的情况，可以使用方案2，方案2使用内置同步机制，同步机制就会出现同步延迟。增加tomcat的压力。</p><p>​因为同步session会有同步延迟等问题，采用增加组件存储session。如果用户比较少可以使用mysql、mongodb进行存储。</p><p>​如果对用户数大，可以内存数据库redis或memcached进行存储。</p><p>​如果没有踢出用户和查看登录用户数的要求可以使用jwt进行客户端存储。</p><h2 id="方案1实现"><a href="#方案1实现" class="headerlink" title="方案1实现"></a>方案1实现</h2><p>在nginx那一篇已经实现</p><h2 id="方案2实现"><a href="#方案2实现" class="headerlink" title="方案2实现"></a>方案2实现</h2><p>Tomcat 官网 <a href="https://tomcat.apache.org/tomcat-8.5-doc/cluster-howto.html">https://tomcat.apache.org/tomcat-8.5-doc/cluster-howto.html</a></p><p>tomcat自带的session同步支持3种存储类型</p><p>1.文件系统</p><p>2.数据库</p><p>3.内存</p><p>这里使用的内存。</p><p>安装jdk</p><p>下载安装tomcat</p><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">tar zxf apache-tomcat-8.5.78.tar.gz<br></code></pre></td></tr></table></figure><p>配置环境变量</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> JAVA_HOME=/usr/java/jdk1.8.0_333-aarch64<br><span class="hljs-built_in">export</span> JRE_HOME=<span class="hljs-variable">$&#123;JAVA_HOME&#125;</span>/jre<br><span class="hljs-built_in">export</span> CLASSPATH=.:<span class="hljs-variable">$&#123;JAVA_HOME&#125;</span>/lib:<span class="hljs-variable">$&#123;JRE_HOME&#125;</span>/lib<br><span class="hljs-built_in">export</span> CATALINA_HOME=/usr/local/apache-tomcat-8.5.78<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$&#123;JAVA_HOME&#125;</span>/bin:<span class="hljs-variable">$CATALINA_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> /etc/profile<br></code></pre></td></tr></table></figure><p>环境变量验证</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">catalina.sh version<br></code></pre></td></tr></table></figure><p>启动tomcat</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">startup.sh<br></code></pre></td></tr></table></figure><p>访问 <a href="http://192.168.158.137:8080/">http://192.168.158.137:8080/</a></p><p>&#x2F;usr&#x2F;local&#x2F;apache-tomcat-8.5.78&#x2F;bin&#x2F;shutdown.sh</p><p>创建测试项目：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /usr/local/apache-tomcat-8.5.78/webapps<br><span class="hljs-built_in">mkdir</span> webapp1<br><span class="hljs-built_in">cd</span> webapp1<br>vi index.jsp<br></code></pre></td></tr></table></figure><p>index.jsp内容</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> contentType=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span> pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.*&quot;</span> %&gt;<br>&lt;html&gt;<br>  &lt;head&gt;<br>  &lt;title&gt;session&lt;/title&gt;<br>  &lt;/head&gt;<br>  &lt;body&gt;<br>&lt;table&gt;<br>      &lt;tr&gt;<br>        &lt;td&gt;session id&lt;/td&gt;<br>        &lt;td&gt;&lt;%=session.getId() %&gt;&lt;/td&gt;<br>        &lt;% session.setAttribute(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;abc&quot;</span>); %&gt;<br>      &lt;/tr&gt;<br>      &lt;tr&gt;<br>        &lt;td&gt;create time&lt;/td&gt;<br>        &lt;td&gt;&lt;%= session.getCreationTime()%&gt;&lt;/td&gt;<br>      &lt;/tr&gt;<br>    &lt;/table&gt;<br>    ip: <span class="hljs-number">192.168</span><span class="hljs-number">.128</span><span class="hljs-number">.137</span><br>  &lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>配置tomcat的server.xml</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /usr/local/apache-tomcat-8.5.78/conf<br>vi server.xml<br></code></pre></td></tr></table></figure><p>在localhost的Host中添加</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Context</span> <span class="hljs-attr">docBase</span>=<span class="hljs-string">&quot;webapp1&quot;</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">reloadable</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><p>启动服务，访问<a href="http://192.168.158.137:8080/">http://192.168.158.137:8080/</a></p><p>重复配置两台服务器，发现两个session是不一样的。</p><p>配置tomcat会话共享集群：</p><p>在tomcat的server.xml的Engine标签上添加jvmRoute属性</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">&lt;Engine name=<span class="hljs-string">&quot;Catalina&quot;</span> defaultHost=<span class="hljs-string">&quot;localhost&quot;</span> jvmRoute=<span class="hljs-string">&quot;tomcat-1&quot;</span>&gt;<br>&lt;Engine name=<span class="hljs-string">&quot;Catalina&quot;</span> defaultHost=<span class="hljs-string">&quot;localhost&quot;</span> jvmRoute=<span class="hljs-string">&quot;tomcat-2&quot;</span>&gt;<br></code></pre></td></tr></table></figure><p>在Engine标签下：把cluster打开</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Cluster</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><p>在新建的webapp1项目下添加 </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">mkdir</span> WEB-INF<br>vi web.xml<br></code></pre></td></tr></table></figure><p>Web.xml内容：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee</span></span><br><span class="hljs-string"><span class="hljs-tag">                      http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;3.1&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">distributable</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></table></figure><p>tomcat里使用的java.net.InetAddress.getLocalHost().getHostAddress()获取IP地址，需要修改hosts文件，把127.0.0.1改为你的IP</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">vi /etc/hosts<br>192.168.158.137   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br></code></pre></td></tr></table></figure><p>启动tomcat</p><p>配置nginx为轮询负载。</p><p>这时访问nginx的地址一直返回同一个sessionID。</p><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>tomcat同步需要开放端口tcp 4000   udp 45564</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">firewall-cmd --add-port=4000/tcp --permanent<br>firewall-cmd --add-port=45564/udp --permanent<br>firewall-cmd --reload<br></code></pre></td></tr></table></figure><h3 id="其他第三方包实现"><a href="#其他第三方包实现" class="headerlink" title="其他第三方包实现"></a>其他第三方包实现</h3><p>memcached-session-filter</p><p>memcached-session-manager</p><p>tomcat-redis-session-manager </p><h2 id="方案3实现"><a href="#方案3实现" class="headerlink" title="方案3实现"></a>方案3实现</h2><p>创建java maven项目</p><p>加入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml">   <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.session<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-session-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>添加redis配置</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.redis.host</span>=<span class="hljs-string">192.168.158.137</span><br><span class="hljs-attr">spring.redis.port</span>=<span class="hljs-string">6379</span><br><span class="hljs-attr">spring.redis.password</span>=<span class="hljs-string">123456</span><br></code></pre></td></tr></table></figure><p>添加controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedidSessionController</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String port;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/save&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">saveName</span><span class="hljs-params">(String name, HttpSession session)</span> <span class="hljs-keyword">throws</span> SocketException &#123;<br>        session.setAttribute(<span class="hljs-string">&quot;name&quot;</span>, name);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello,&quot;</span> + IpUtil.getLocalIp4Address().get().toString().replaceAll(<span class="hljs-string">&quot;/&quot;</span>,<span class="hljs-string">&quot;&quot;</span>) + <span class="hljs-string">&quot;:&quot;</span> + session.getAttribute(<span class="hljs-string">&quot;name&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/get&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">(HttpSession session)</span> <span class="hljs-keyword">throws</span> SocketException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello,&quot;</span> + session.getAttribute(<span class="hljs-string">&quot;name&quot;</span>) + <span class="hljs-string">&quot;:&quot;</span> + IpUtil.getLocalIp4Address().get().toString().replaceAll(<span class="hljs-string">&quot;/&quot;</span>,<span class="hljs-string">&quot;&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>启动 两台spring boot 项目  配置nginx</p><p>先请求save接口<a href="http://192.168.158.135/save?name=test1">http://192.168.158.135/save?name=test1</a></p><p>再一直访问<a href="http://192.168.158.135/get%EF%BC%8C%E8%BF%99%E6%97%B6ip%E4%BC%9A%E5%8F%98%E4%BD%86%E6%98%AF%E4%B8%80%E7%9B%B4%E5%8F%AF%E4%BB%A5%E5%8F%96%E5%88%B0name%E5%80%BC">http://192.168.158.135/get，这时ip会变但是一直可以取到name值</a></p><h2 id="方案4实现"><a href="#方案4实现" class="headerlink" title="方案4实现"></a>方案4实现</h2><p>加入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.auth0<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>java-jwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.19.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>添加jwt工具类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenUtli</span> &#123;<br><br>    <span class="hljs-comment">//Issuer</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ISSUER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;auth0&quot;</span>;<br>    <span class="hljs-comment">//Audience</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">AUDIENCE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Client&quot;</span>;<br>    <span class="hljs-comment">//密钥</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;123456&quot;</span>;<br>    <span class="hljs-comment">//算法</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Algorithm</span> <span class="hljs-variable">ALGORITHM</span> <span class="hljs-operator">=</span> Algorithm.HMAC256(TokenUtli.KEY);<br>    <span class="hljs-comment">//Header</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; HEADER_MAP = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;() &#123;<br>        &#123;<br>            put(<span class="hljs-string">&quot;alg&quot;</span>, <span class="hljs-string">&quot;HS256&quot;</span>);<br>            put(<span class="hljs-string">&quot;typ&quot;</span>, <span class="hljs-string">&quot;JWT&quot;</span>);<br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成 Token 字符串</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> claimMap claim 数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Token 字符串</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">GenerateToken</span><span class="hljs-params">(Map&lt;String, String&gt; claimMap)</span> &#123;<br>        <span class="hljs-type">Date</span> <span class="hljs-variable">nowDate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br>        <span class="hljs-comment">//120 分钟过期</span><br>        <span class="hljs-type">Date</span> <span class="hljs-variable">expireDate</span> <span class="hljs-operator">=</span> TokenUtli.AddDate(nowDate, <span class="hljs-number">2</span> * <span class="hljs-number">60</span>);<br><br>        <span class="hljs-comment">//Token 建造器</span><br>        JWTCreator.<span class="hljs-type">Builder</span> <span class="hljs-variable">tokenBuilder</span> <span class="hljs-operator">=</span> JWT.create();<br><br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : claimMap.entrySet()) &#123;<br>            <span class="hljs-comment">//Payload 部分，根据需求添加</span><br>            tokenBuilder.withClaim(entry.getKey(), entry.getValue());<br>        &#125;<br><br>        <span class="hljs-comment">//token 字符串</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> tokenBuilder.withHeader(TokenUtli.HEADER_MAP)<span class="hljs-comment">//Header 部分</span><br>                .withIssuer(TokenUtli.ISSUER)<span class="hljs-comment">//issuer</span><br>                .withAudience(TokenUtli.AUDIENCE)<span class="hljs-comment">//audience</span><br>                .withIssuedAt(nowDate)<span class="hljs-comment">//生效时间</span><br>                .withExpiresAt(expireDate)<span class="hljs-comment">//过期时间</span><br>                .sign(TokenUtli.ALGORITHM);<span class="hljs-comment">//签名，算法加密</span><br><br>        <span class="hljs-keyword">return</span> token;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 时间加法</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> date   当前时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> minute 持续时间（分钟）</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 时间加法结果</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Date <span class="hljs-title function_">AddDate</span><span class="hljs-params">(Date date, Integer minute)</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == date) &#123;<br>            date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br>        &#125;<br>        <span class="hljs-type">Calendar</span> <span class="hljs-variable">calendar</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GregorianCalendar</span>();<br>        calendar.setTime(date);<br>        calendar.add(Calendar.MINUTE, minute);<br><br>        <span class="hljs-keyword">return</span> calendar.getTime();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 验证 Token</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> webToken 前端传递的 Token 字符串</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Token 字符串是否正确</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception 异常信息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">VerifyJWTToken</span><span class="hljs-params">(String webToken)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(webToken)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        String[] token = webToken.split(<span class="hljs-string">&quot; &quot;</span>);<br>        <span class="hljs-keyword">if</span> (token.length &lt;= <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;token错误&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (token[<span class="hljs-number">1</span>].equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;token错误&quot;</span>);<br>        &#125;<br><br><br>        <span class="hljs-comment">//JWT验证器</span><br>        <span class="hljs-type">JWTVerifier</span> <span class="hljs-variable">verifier</span> <span class="hljs-operator">=</span> JWT.require(TokenUtli.ALGORITHM).withIssuer(TokenUtli.ISSUER).build();<br><br>        <span class="hljs-comment">//解码</span><br>        <span class="hljs-type">DecodedJWT</span> <span class="hljs-variable">jwt</span> <span class="hljs-operator">=</span> verifier.verify(token[<span class="hljs-number">1</span>]);<span class="hljs-comment">//如果 token 过期，此处就会抛出异常</span><br><br>        <span class="hljs-comment">//Audience</span><br>        List&lt;String&gt; audienceList = jwt.getAudience();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">audience</span> <span class="hljs-operator">=</span> audienceList.get(<span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">//Payload</span><br>        Map&lt;String, Claim&gt; claimMap = jwt.getClaims();<br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Claim&gt; entry : claimMap.entrySet()) &#123;<br><br>        &#125;<br><br>        <span class="hljs-comment">//生效时间</span><br>        <span class="hljs-type">Date</span> <span class="hljs-variable">issueTime</span> <span class="hljs-operator">=</span> jwt.getIssuedAt();<br>        <span class="hljs-comment">//过期时间</span><br>        <span class="hljs-type">Date</span> <span class="hljs-variable">expiresTime</span> <span class="hljs-operator">=</span> jwt.getExpiresAt();<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>登录接口返回jwt</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/login&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginController</span> &#123;<br><br>    <span class="hljs-meta">@PostMapping(value = &quot;/login&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">Login</span><span class="hljs-params">()</span> &#123;<br>        Map&lt;String, String&gt; claimMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        claimMap.put(<span class="hljs-string">&quot;username&quot;</span>, <span class="hljs-string">&quot;abc&quot;</span>);<br>        <span class="hljs-keyword">return</span> TokenUtli.GenerateToken(claimMap);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>需要jwt的接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/demo&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/get&quot;)</span><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;<br>        List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        list.add(<span class="hljs-string">&quot;test1&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;test2&quot;</span>);<br>        <span class="hljs-keyword">return</span> list;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>jwt拦截器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JWTInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span><br>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-comment">//从请求头内获取token</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;authorization&quot;</span>);<br><br>        <span class="hljs-comment">//验证令牌，如果令牌不正确会出现异常会被全局异常处理</span><br>        <span class="hljs-keyword">return</span> TokenUtli.VerifyJWTToken(token);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>拦载器配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterceptorConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span><br>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span><br>    &#123;<br>        registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JWTInterceptor</span>()).addPathPatterns(<span class="hljs-string">&quot;/**&quot;</span>)<span class="hljs-comment">//全部路径</span><br>                .excludePathPatterns(<span class="hljs-string">&quot;/login/login&quot;</span>);<span class="hljs-comment">//开放登录路径</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试：直接访问 <a href="http://localhost:8080/demo/get">http://localhost:8080/demo/get</a></p><p>登录 <a href="http://localhost:8080/login/login">http://localhost:8080/login/login</a></p><p>添加header的authorization再访问<a href="http://localhost:8080/demo/get">http://localhost:8080/demo/get</a></p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker入门</title>
    <link href="/2022/08/10/devops/docker%E5%85%A5%E9%97%A8/"/>
    <url>/2022/08/10/devops/docker%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="历史演化"><a href="#历史演化" class="headerlink" title="历史演化"></a>历史演化</h1><p>物理机时代   —&gt;   虚拟化时代 —&gt;    容器化时代</p><h2 id="物理机时代"><a href="#物理机时代" class="headerlink" title="物理机时代"></a>物理机时代</h2><p>部署非常慢</p><p>成本很高</p><p>资源浪费</p><p>难于扩展与迁移</p><p>受制于硬件</p><h2 id="虚拟化时代"><a href="#虚拟化时代" class="headerlink" title="虚拟化时代"></a>虚拟化时代</h2><p>多部署</p><p>资源池</p><p>资源隔离</p><p>很容易扩展</p><p>VM需要安装操作系统</p><h2 id="容器化时代"><a href="#容器化时代" class="headerlink" title="容器化时代"></a>容器化时代</h2><p>容器架构降低了硬件成本</p><p>更快速的部署开发&#x2F;测试&#x2F;生产环境</p><p>更简便的维护开发&#x2F;测试&#x2F;生产环境</p><p>与微服务架构更为契合</p><h3 id="容器化技术的应用场景"><a href="#容器化技术的应用场景" class="headerlink" title="容器化技术的应用场景"></a>容器化技术的应用场景</h3><p>标准化的迁移方式</p><p>统一的参数配置</p><p>自动化部署</p><p>应用集群监控</p><p>开发与运维之间的沟通桥梁</p><h2 id="虚拟化与容器化对比"><a href="#虚拟化与容器化对比" class="headerlink" title="虚拟化与容器化对比"></a>虚拟化与容器化对比</h2><p><img src="/.com//%E8%99%9A%E6%8B%9F%E5%8C%96%E4%B8%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="虚拟化与容器化架构图"></p><h3 id="左图是虚拟机"><a href="#左图是虚拟机" class="headerlink" title="左图是虚拟机"></a>左图是虚拟机</h3><p>从下到上理解:</p><ul><li><strong>基础设施(Infrastructure)<strong>。它可以是你的</strong>个人电脑</strong>，数据中心的<strong>服务器</strong>，或者是<strong>云主机</strong>。</li><li><strong>主机操作系统（Host Operating System）</strong></li><li><strong>虚拟机管理系统(Hypervisor)<strong>。利用Hypervisor，可以在</strong>主操作系统</strong>之上运行多个不同的<strong>从操作系统</strong>。类型1的Hypervisor有支持MacOS的<strong>HyperKit</strong>，支持Windows的<strong>Hyper-V、Xen</strong>以及<strong>KVM</strong>。类型2的Hypervisor有VirtualBox和VMWare workstation。</li><li><strong>客户机操作系统(Guest Operating System)<strong>。假设你需要运行3个相互隔离的应用，则需要使用Hypervisor启动3个</strong>客户机操作系统</strong>，也就是3个<strong>虚拟机</strong>。这些虚拟机都非常大，也许有700MB，这就意味着它们将占用2.1GB的磁盘空间。更糟糕的是，它们还会消耗很多CPU和内存。</li><li><strong>各种依赖。</strong>每一个<strong>客户机操作系统</strong>都需要安装许多依赖。如果你的应用需要连接PostgreSQL的话，则需要安装<strong>libpq-dev</strong>；如果你使用Ruby的话，应该需要安装gems；如果使用其他编程语言，比如Python或者Node.js，都会需要安装对应的依赖库。</li><li><strong>应用</strong>。安装依赖之后，就可以在各个<strong>客户机操作系统</strong>分别运行应用了，这样各个应用就是相互隔离的。</li></ul><h3 id="右图是容器化"><a href="#右图是容器化" class="headerlink" title="右图是容器化"></a>右图是容器化</h3><p><strong>从下到上理解上图:</strong></p><ul><li>**基础设施(Infrastructure)**。</li><li>**主操作系统(Host Operating System)**。所有主流的Linux发行版都可以运行Docker。对于MacOS和Windows，也有一些办法”运行”Docker。</li><li>**Docker守护进程(Docker Daemon)**。Docker守护进程取代了Hypervisor，它是运行在操作系统之上的后台进程，负责管理Docker容器。</li><li><strong>各种依赖</strong>。对于Docker，应用的所有依赖都打包在<strong>Docker镜像</strong>中，<strong>Docker容器</strong>是基于<strong>Docker镜像</strong>创建的。</li><li><strong>应用</strong>。应用的源代码与它的依赖都打包在<strong>Docker镜像</strong>中，不同的应用需要不同的<strong>Docker镜像</strong>。不同的应用运行在不同的<strong>Docker容器</strong>中，它们是相互隔离的。</li></ul><h1 id="什么是docker"><a href="#什么是docker" class="headerlink" title="什么是docker"></a>什么是docker</h1><p>一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的容器中，然后发布到任 何流行的 Linux 机器上，也可以实现虚拟化。容器是完全使用沙箱机制，相互之间不会有任何接口； 使用go语言编写，在LCX（linux容器）基础上进行的封装</p><p>1、提供一次性的环境，假如需要安装Mysql，则需要安装很多依赖库、版本等，如果使用Docker则通过镜像就 可以直接启动运行 </p><p>2、快速动态扩容，使用docker部署了一个应用，可以制作成镜像，然后通过Dokcer快速启动 </p><p>3、组建微服务架构，可以在一个机器上模拟出多个微服务，启动多个应用 </p><p>4、更好的资源隔离和共享</p><p>开箱即用，快速部署，可移植性强，环境隔离</p><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>官网： <a href="https://www.docker.com/">https://www.docker.com/</a></p><p>文档：<a href="https://docs.docker.com/">https://docs.docker.com/</a></p><p>点击文档连接,点击manuals。点击docker engine。</p><p>选择操作系统，并注意版本。</p><p>Docker 引擎包现在称为<code>docker-ce</code>.</p><h3 id="卸载旧版本"><a href="#卸载旧版本" class="headerlink" title="卸载旧版本"></a>卸载旧版本</h3><p>较旧的 Docker 版本称为 docker 或 docker-engine 。如果已安装这些程序，请卸载它们以及相关的依赖项。</p><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">sudo yum remove docker \<br>                  docker-client \<br>                  docker-client-latest \<br>                  docker-common \<br>                  docker-latest \<br>                  docker-latest-logrotate \<br>                  docker-logrotate \<br>                  docker-engine<br></code></pre></td></tr></table></figure><h2 id="安装方式"><a href="#安装方式" class="headerlink" title="安装方式"></a>安装方式</h2><p>1.使用存储库的安装</p><p>2.直接下载包，安装</p><p>3.自动化脚本安装</p><h2 id="存储库方式安装"><a href="#存储库方式安装" class="headerlink" title="存储库方式安装"></a>存储库方式安装</h2><p>在新主机上首次安装 Docker Engine 之前，您需要设置 Docker 存储库。之后，您可以从存储库安装和更新 Docker。</p><h4 id="设置存储库"><a href="#设置存储库" class="headerlink" title="设置存储库"></a>设置存储库</h4><p>安装<code>yum-utils</code>包（提供<code>yum-config-manager</code> 实用程序）并设置存储库。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo yum install -y yum-utils<br></code></pre></td></tr></table></figure><p>官方源(比较慢)</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo yum-config-manager \<br>    --add-repo \<br>    https://download.docker.com/linux/centos/docker-ce.repo<br></code></pre></td></tr></table></figure><p>阿里云源</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo yum-config-manager \<br>    --add-repo \<br>    http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br></code></pre></td></tr></table></figure><h3 id="安装Docker-Engine"><a href="#安装Docker-Engine" class="headerlink" title="安装Docker Engine"></a>安装Docker Engine</h3><ol><li>安装<em>最新版本</em>的 Docker Engine、containerd 和 Docker Compose 或进入下一步安装特定版本：</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo yum install docker-ce docker-ce-cli containerd.io docker-compose-plugin<br></code></pre></td></tr></table></figure><p>如果提示接受 GPG 密钥，请验证指纹是否匹配 <code>060A 61C5 1B55 8A7F 742B 77AA C52F EB6B 621E 9F35</code>，如果是，则接受它。</p><p>此命令会安装 Docker，但不会启动 Docker。它还会创建一个 <code>docker</code>组，但是默认情况下它不会将任何用户添加到该组中。</p><ol start="2"><li>要安装<em>特定版本</em>的 Docker Engine，请在 repo 中列出可用版本，然后选择并安装：</li></ol><p>一个。列出并排序您的存储库中可用的版本。此示例按版本号从最高到最低对结果进行排序，并被截断：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum list docker-ce --showduplicates | <span class="hljs-built_in">sort</span> -r<br></code></pre></td></tr></table></figure><p>返回的列表取决于启用了哪些存储库，并且特定于您的 CentOS 版本（<code>.el7</code>在本例中由后缀表示）。</p><p>通过其完全限定的包名称安装特定版本，即包名称 ( <code>docker-ce</code>) 加上版本字符串（第 2 列），从第一个冒号 ( <code>:</code>) 开始，一直到第一个连字符，用连字符 ( <code>-</code>) 分隔。例如，<code>docker-ce-18.09.1</code>。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo yum install docker-ce-&lt;VERSION_STRING&gt; docker-ce-cli-&lt;VERSION_STRING&gt; containerd.io docker-compose-plugin<br></code></pre></td></tr></table></figure><p>此命令会安装 Docker，但不会启动 Docker。它还会创建一个 <code>docker</code>组，但是默认情况下它不会将任何用户添加到该组中。</p><ol start="3"><li>启动 Docker。</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo systemctl start docker<br></code></pre></td></tr></table></figure><ol start="4"><li><code>hello-world</code> 通过运行映像来验证 Docker 引擎是否已正确安装。</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo docker run hello-world<br></code></pre></td></tr></table></figure><ol><li>此命令下载测试映像并在容器中运行它。当容器运行时，它会打印一条消息并退出。</li></ol><p>这将安装并运行 Docker 引擎。用于<code>sudo</code>运行 Docker 命令。继续<a href="https://docs.docker.com/engine/install/linux-postinstall/">Linux 后安装</a>以允许非特权用户运行 Docker 命令和其他可选配置步骤。</p><h3 id="升级-Docker-引擎"><a href="#升级-Docker-引擎" class="headerlink" title="升级 Docker 引擎"></a>升级 Docker 引擎</h3><p>要升级 Docker Engine，请下载较新的包文件并重复 <a href="https://docs.docker.com/engine/install/centos/#install-from-a-package">安装过程</a>，使用<code>yum -y upgrade</code> 代替<code>yum -y install</code>，并指向新文件。</p><h3 id="设置开机启动"><a href="#设置开机启动" class="headerlink" title="设置开机启动"></a>设置开机启动</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">systemctl <span class="hljs-built_in">enable</span> docker<br></code></pre></td></tr></table></figure><h3 id="查看版本"><a href="#查看版本" class="headerlink" title="查看版本"></a>查看版本</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker version<br></code></pre></td></tr></table></figure><h3 id="查看详细信息"><a href="#查看详细信息" class="headerlink" title="查看详细信息"></a>查看详细信息</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker info<br></code></pre></td></tr></table></figure><h1 id="结构图"><a href="#结构图" class="headerlink" title="结构图"></a>结构图</h1><p><img src="/.com//docker%E6%A8%A1%E5%9D%97%E5%9B%BE.svg" alt="docker模块图"></p><h2 id="宿主机（Docker-Host）"><a href="#宿主机（Docker-Host）" class="headerlink" title="宿主机（Docker_Host）"></a>宿主机（Docker_Host）</h2><p>在docker中，宿主机也就是“Docker_Host”，是Docker的整体架构之一，可以是物理机也可以是虚拟机，在宿主机上跑着一个dockers服务，使用“docker daemon”可以实现对docker对象生命周期管理。</p><h2 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h2><p>镜像是文件，是只读的，提供了运行程序完整的软硬件资源，是应用程序的“集装箱”</p><p>类比为：操作系统的安装光盘</p><h2 id="Container-容器"><a href="#Container-容器" class="headerlink" title="Container(容器)"></a>Container(容器)</h2><p>是镜像的实例，由Docker负责创建，容器之间彼此隔离。</p><p>类比为：操作系统</p><h2 id="registry"><a href="#registry" class="headerlink" title="registry"></a>registry</h2><p>镜像构建完成后，可以很容易的在当前宿主机上运行，但是，如果需要在其它服务器上使用这个镜像，我们就需要一个集中的存储、分发镜像的服务，Docker Registry就是这样的服务。</p><p>一个 <strong>Docker Registry</strong> 中可以包含多个 <strong>仓库</strong>（<code>Repository</code>）；每个仓库可以包含多个 <strong>标签</strong>（<code>Tag</code>）；每个标签对应一个镜像。</p><p>通常，一个仓库会包含同一个软件不同版本的镜像，而标签就常用于对应该软件的各个版本。我们可以通过 <code>&lt;仓库名&gt;:&lt;标签&gt;</code> 的格式来指定具体是这个软件哪个版本的镜像。如果不给出标签，将以 <code>latest</code> 作为默认标签。</p><h3 id="Docker-Registry-公开服务"><a href="#Docker-Registry-公开服务" class="headerlink" title="Docker Registry 公开服务"></a>Docker Registry 公开服务</h3><p>Docker Registry 公开服务是开放给用户使用、允许用户管理镜像的 Registry 服务。一般这类公开服务允许用户免费上传、下载公开的镜像，并可能提供收费服务供用户管理私有镜像。</p><p>最常使用的 Registry 公开服务是官方的 <a href="https://hub.docker.com/">Docker Hub (opens new window)</a>，这也是默认的 Registry，并拥有大量的高质量的 <a href="https://hub.docker.com/search?q=&type=image&image_filter=official">官方镜像 (opens new window)</a>。除此以外，还有 Red Hat 的 <a href="https://quay.io/repository/">Quay.io (opens new window)</a>；Google 的 <a href="https://cloud.google.com/container-registry/">Google Container Registry (opens new window)</a>，<a href="https://kubernetes.io/">Kubernetes (opens new window)</a>的镜像使用的就是这个服务；代码托管平台 <a href="https://github.com/">GitHub (opens new window)</a>推出的 <a href="https://docs.github.com/cn/packages/working-with-a-github-packages-registry/working-with-the-container-registry">ghcr.io (opens new window)</a>。</p><p>由于某些原因，在国内访问这些服务可能会比较慢。国内的一些云服务商提供了针对 Docker Hub 的镜像服务（<code>Registry Mirror</code>），这些镜像服务被称为 <strong>加速器</strong>。常见的有 <a href="https://www.aliyun.com/product/acr?source=5176.11533457&userCode=8lx5zmtu">阿里云加速器 (opens new window)</a>、<a href="https://www.daocloud.io/mirror#accelerator-doc">DaoCloud 加速器 (opens new window)</a>等。使用加速器会直接从国内的地址下载 Docker Hub 的镜像，比直接从 Docker Hub 下载速度会提高很多。在 <a href="https://vuepress.mirror.docker-practice.com/install/mirror.html">安装 Docker</a> 一节中有详细的配置方法。</p><p>国内也有一些云服务商提供类似于 Docker Hub 的公开服务。比如 <a href="https://c.163.com/hub#/m/library/">网易云镜像服务 (opens new window)</a>、<a href="https://hub.daocloud.io/">DaoCloud 镜像市场 (opens new window)</a>、<a href="https://www.aliyun.com/product/acr?source=5176.11533457&userCode=8lx5zmtu">阿里云镜像库 (opens new window)</a>等。</p><h3 id="私有-Docker-Registry"><a href="#私有-Docker-Registry" class="headerlink" title="私有 Docker Registry"></a>私有 Docker Registry</h3><p>除了使用公开服务外，用户还可以在本地搭建私有 Docker Registry。Docker 官方提供了 <a href="https://hub.docker.com/_/registry/">Docker Registry (opens new window)</a>镜像，可以直接使用做为私有 Registry 服务。在 <a href="https://vuepress.mirror.docker-practice.com/repository/registry.html">私有仓库</a> 一节中，会有进一步的搭建私有 Registry 服务的讲解。</p><p>开源的 Docker Registry 镜像只提供了 <a href="https://docs.docker.com/registry/spec/api/">Docker Registry API (opens new window)</a>的服务端实现，足以支持 <code>docker</code> 命令，不影响使用。但不包含图形界面，以及镜像维护、用户管理、访问控制等高级功能。</p><p>除了官方的 Docker Registry 外，还有第三方软件实现了 Docker Registry API，甚至提供了用户界面以及一些高级功能。比如，<a href="https://github.com/goharbor/harbor">Harbor (opens new window)</a>和 <a href="https://vuepress.mirror.docker-practice.com/repository/nexus3_registry.html">Sonatype Nexus</a>。</p><h1 id="镜像操作"><a href="#镜像操作" class="headerlink" title="镜像操作"></a>镜像操作</h1><p>查看本地镜像：docker images<br>搜索镜像：docker search centos<br>搜索镜像并过滤是官方的： docker search –filter “is-official&#x3D;true” centos<br>搜索镜像并过滤大于多少颗星星的：docker search –filter stars&#x3D;10 centos<br>下载centos7镜像：docker pull centos:7<br>修改本地镜像名字（小写）：docker tag centos:7 mycentos:1<br>本地镜像的删除：docker rmi centos:7</p><h2 id="配置镜像加速"><a href="#配置镜像加速" class="headerlink" title="配置镜像加速"></a>配置镜像加速</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">科大镜像：https://docker.mirrors.ustc.edu.cn/<br>网易：https://hub-mirror.c.163.com/<br>阿里云：https://&lt;你的ID&gt;.mirror.aliyuncs.com<br>七牛云加速器：https://reg-mirror.qiniu.com<br></code></pre></td></tr></table></figure><p>阿里云镜像获取地址：<a href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors%EF%BC%8C%E7%99%BB%E9%99%86%E5%90%8E%EF%BC%8C%E5%B7%A6%E4%BE%A7%E8%8F%9C%E5%8D%95%E9%80%89%E4%B8%AD%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F%E5%99%A8%E5%B0%B1%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E4%BD%A0%E7%9A%84%E4%B8%93%E5%B1%9E%E5%9C%B0%E5%9D%80%E4%BA%86%EF%BC%9A">https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors，登陆后，左侧菜单选中镜像加速器就可以看到你的专属地址了：</a></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">https://&lt;你的ID&gt;.mirror.aliyuncs.com<br></code></pre></td></tr></table></figure><p>编辑文件vi &#x2F;etc&#x2F;docker&#x2F;daemon.json（如果文件不存在请新建该文件）</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">&#123;&quot;registry-mirrors&quot;:[&quot;https://reg-mirror.qiniu.com/&quot;]&#125;<br></code></pre></td></tr></table></figure><p>重启：systemctl daemon-reload &amp;&amp; systemctl restart docker</p><h1 id="容器操作"><a href="#容器操作" class="headerlink" title="容器操作"></a>容器操作</h1><p>构建容器：docker run -itd –name&#x3D;mycentos centos:7<br>-i ：表示以交互模式运行容器（让容器的标准输入保持打开）<br>-d：表示后台运行容器，并返回容器ID<br>-t：为容器重新分配一个伪输入终端<br>–name：为容器指定名称</p><p>查看本地所有的容器：docker ps -a<br>查看本地正在运行的容器：docker ps<br>停止容器：docker stop CONTAINER_ID &#x2F; CONTAINER_NAME<br>一次性停止所有容器：docker stop $(docker ps -a -q)<br>启动容器：docker start CONTAINER_ID &#x2F; CONTAINER_NAME<br>重启容器：docker restart CONTAINER_ID &#x2F; CONTAINER_NAME<br>删除容器：docker rm CONTAINER_ID &#x2F; CONTAINER_NAME<br>强制删除容器：docker rmi -f CONTAINER_ID &#x2F; CONTAINER_NAME<br>查看容器详细信息：docker inspect CONTAINER_ID &#x2F; CONTAINER_NAME<br>进入容器：docker exec -it 0ad5d7b2c3a4 &#x2F;bin&#x2F;bash</p><h1 id="容器与宿主机操作"><a href="#容器与宿主机操作" class="headerlink" title="容器与宿主机操作"></a>容器与宿主机操作</h1><h2 id="容器与宿主机端口映射"><a href="#容器与宿主机端口映射" class="headerlink" title="容器与宿主机端口映射"></a>容器与宿主机端口映射</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -p 宿主机端口:容器端口  镜像名<br></code></pre></td></tr></table></figure><h2 id="容器与宿主机之间文件复制与挂载"><a href="#容器与宿主机之间文件复制与挂载" class="headerlink" title="容器与宿主机之间文件复制与挂载"></a>容器与宿主机之间文件复制与挂载</h2><p>从宿主机复制到容器：docker cp 宿主机本地路径 容器名字&#x2F;ID：容器路径<br>docker cp &#x2F;root&#x2F;123.txt mycentos:&#x2F;home&#x2F;<br>从容器复制到宿主机：docker cp 容器名字&#x2F;ID：容器路径 宿主机本地路径<br>docker cp mycentos:&#x2F;home&#x2F;456.txt &#x2F;root<br>宿主机文件夹挂载到容器里：docker run -itd -v 宿主机路径:容器路径 镜像ID<br>docker run -itd -v &#x2F;root&#x2F;xdclass&#x2F;:&#x2F;home centos:7</p><h1 id="commit构建自定义镜像"><a href="#commit构建自定义镜像" class="headerlink" title="commit构建自定义镜像"></a>commit构建自定义镜像</h1><p>对容器的修改以及保存</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs text">启动并进入容器：docker run -it centos:7 /bin/bash<br>在/home 路径下创建xdclass文件夹：mkdir /home/xdclass<br>安装ifconfig命令：yum -y install net-tools<br>重启容器，查看容器的xdclass文件夹还在不在：docker restart 67862569d4f7<br>删除容器，再重新启动一个容器进入查看有没有xdclass文件夹：docker rm 67862569d4f7 &amp;&amp; docker<br>run -it centos:7 /bin/bash<br>构建镜像：<br>  docker commit 4eb9d14ebb18 mycentos:7<br>  docker commit -a &quot;XD&quot; -m &quot;mkdir /home/xdclass&quot; 4eb9d14ebb18 mcentos:7<br>  -a：标注作者<br>  -m：说明注释<br>  查看详细信息：docker inspect 180176be1b4c<br>启动容器：docker run -itd 180176be1b4c /bin/bash<br>进入容器查看：docker exec -it 2a4d38eca64f /bin/bash<br></code></pre></td></tr></table></figure><h1 id="Dockerfile构建镜像"><a href="#Dockerfile构建镜像" class="headerlink" title="Dockerfile构建镜像"></a>Dockerfile构建镜像</h1><p>Dockerfile文件</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text"># this is a dockerfile<br>FROM centos:7<br>MAINTAINER XD 123456@qq.com<br>RUN echo &quot;正在构建镜像！！！&quot;<br>WORKDIR /home/xdclass<br>COPY 123.txt /home/xdclass<br>RUN yum install -y net-tools<br></code></pre></td></tr></table></figure><p>构建：docker build -t mycentos:v2 </p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">docker build -t 机构/镜像名&lt;:tags&gt; Dockerfile目录<br></code></pre></td></tr></table></figure><p>查看：docker images<br>进入验证：验证成功</p><h2 id="Dockerfile基础指令"><a href="#Dockerfile基础指令" class="headerlink" title="Dockerfile基础指令"></a>Dockerfile基础指令</h2><p>FROM<br>    基于哪个镜像<br>MAINTAINER<br>    注明作者<br>COPY<br>    复制文件进入镜像（只能用相对路径，不能用绝对路径）<br>ADD<br>    复制文件进入镜像（假如文件是.tar.gz文件会解压）<br>WORKDIR：<br>    指定工作目录，假如路径不存在会创建路径<br>ENV<br>    设置环境变量<br>EXPOSE<br>    暴露容器端口<br>RUN</p><p>​在构建镜像的时候执行，作用于镜像层面</p><p>ENTRYPOINT<br>    在容器启动的时候执行，作用于容器层，dockerfile里有多条时只允许执行最后一条<br>CMD<br>    在容器启动的时候执行，作用于容器层，dockerfile里有多条时只允许执行最后一条<br>    容器启动后执行默认的命令或者参数，允许被修改<br>命令格式：<br>shell命令格式：RUN yum install -y net-tools<br>exec命令格式：RUN [ “yum”,”install” ,”-y” ,”net-tools”]</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs text">#第一个<br>FROM centos:7<br>RUN echo &quot;images building!&quot;<br>CMD [&quot;echo&quot;,&quot;container&quot;,&quot;starting...&quot;]<br>ENTRYPOINT [&quot;echo&quot;,&quot;container&quot;,&quot;starting ！！！&quot;]<br><br>#第二个<br>FROM centos:7<br>RUN echo &quot;images building!&quot;<br>CMD [&quot;echo&quot;,&quot;containe1r&quot;,&quot;starting...&quot;]<br>CMD [&quot;echo&quot;,&quot;container2&quot;,&quot;starting...&quot;]<br>ENTRYPOINT [&quot;echo&quot;,&quot;container2&quot;,&quot;starting ！！！&quot;]<br>ENTRYPOINT [&quot;echo&quot;,&quot;container2&quot;,&quot;starting ！！！&quot;]<br><br>#第三个<br>FROM centos:7<br>CMD [&quot;-ef&quot;]<br>ENTRYPOINT [&quot;ps&quot;]<br></code></pre></td></tr></table></figure><h2 id="Dockerfile构建tomcat"><a href="#Dockerfile构建tomcat" class="headerlink" title="Dockerfile构建tomcat"></a>Dockerfile构建tomcat</h2><p>本地宿主机配置jdk</p><p>vi &#x2F;etc&#x2F;profile</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">export JAVA_HOME=/usr/local/jdk<br>export JRE_HOME=$JAVA_HOME/jre<br>export CLASSPATH=$JAVA_HOME/lib:$JRE_HOME/lib:$CLASSPATH<br>export PATH=$JAVA_HOME/bin:$JRE_HOME/bin:$PATH<br></code></pre></td></tr></table></figure><p>source &#x2F;etc&#x2F;profile<br>检验：java -version</p><p>Dockerfile文件</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs text">FROM centos:7<br>ADD jdk-8u211-linux-x64.tar.gz /usr/local<br>RUN mv /usr/local/jdk1.8.0_211 /usr/local/jdk<br>ENV JAVA_HOME=/usr/local/jdk<br>ENV JRE_HOME=$JAVA_HOME/jre<br>ENV CLASSPATH=$JAVA_HOME/lib:$JRE_HOME/lib:$CLASSPATH<br>ENV PATH=$JAVA_HOME/bin:$JRE_HOME/bin:$PATH<br>ADD apache-tomcat-8.5.35.tar.gz /usr/local<br>RUN mv /usr/local/apache-tomcat-8.5.35 /usr/local/tomcat<br>EXPOSE 8080<br>ENTRYPOINT [&quot;/usr/local/tomcat/bin/catalina.sh&quot;,&quot;run&quot;]<br></code></pre></td></tr></table></figure><p>启动容器</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">docker run -itd -p 80:8080 -v /root/test/ROOT:/usr/local/tomcat/webapps/ROOT<br>mycentos:jdk /bin/bash<br></code></pre></td></tr></table></figure><h2 id="Dockerfile构建"><a href="#Dockerfile构建" class="headerlink" title="Dockerfile构建"></a>Dockerfile构建</h2><p>Dockerfile文件</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">FROM centos:7<br>ADD nginx-1.16.0.tar.gz /usr/local<br>COPY nginx_install.sh /usr/local<br>RUN sh /usr/local/nginx_install.sh<br>EXPOSE 80<br></code></pre></td></tr></table></figure><p>安装nginx的shell脚本</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br>yum install -y gcc gcc-c++ make pcre pcre-devel zlib zlib-devel<br><span class="hljs-built_in">cd</span> /usr/local/nginx-1.16.0<br>./configure --prefix=/usr/local/nginx &amp;&amp; make &amp;&amp; make install<br></code></pre></td></tr></table></figure><p>制作Nginx镜像</p><p>​docker build -t mycentos:nginx .</p><p>Nginx镜像启动注意</p><p>​在容器里nginx是以daemon方式启动，退出容器时，nginx程序也会随着停止：<br>​&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx<br>​使用前台方式永久运行：&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -g “daemon off;”</p><p>运行：</p><p>docker run -itd -p 80:80 mycentos:nginx &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -g “daemon off;”</p><h1 id="镜像分层"><a href="#镜像分层" class="headerlink" title="镜像分层"></a>镜像分层</h1><p>1.构建测试镜像v1.0：<code>docker build -t image_test:1.0 .</code></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">FROM</span> alpine:<span class="hljs-number">3</span>.<span class="hljs-number">15</span>.<span class="hljs-number">0</span> #除了继承基础镜像，啥也不做<br></code></pre></td></tr></table></figure><p>2.构建测试镜像v2.0：<code>docker build -t image_test:2.0 .</code></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-keyword">FROM</span> alpine:3.15.0<br><span class="hljs-built_in">RUN</span> dd <span class="hljs-attribute">if</span>=/dev/zero <span class="hljs-attribute">of</span>=file1 <span class="hljs-attribute">bs</span>=10M <span class="hljs-attribute">count</span>=1 #添加一个10M的文件file1<br></code></pre></td></tr></table></figure><p>3.构建测试镜像v3.0：<code>docker build -t image_test:3.0 .</code></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-keyword">FROM</span> alpine:3.15.0<br><span class="hljs-built_in">RUN</span> dd <span class="hljs-attribute">if</span>=/dev/zero <span class="hljs-attribute">of</span>=file1 <span class="hljs-attribute">bs</span>=10M <span class="hljs-attribute">count</span>=1 #添加一个10M的文件file1<br><span class="hljs-built_in">RUN</span> dd <span class="hljs-attribute">if</span>=/dev/zero <span class="hljs-attribute">of</span>=file2 <span class="hljs-attribute">bs</span>=10M <span class="hljs-attribute">count</span>=1 #添加一个10M的文件file2<br></code></pre></td></tr></table></figure><p>使用<code>docker history</code>可以看到镜像的构建历史。<br>我们每一行列出了镜像包含的层。</p><p>使用<code>docker history</code>我们看到有一行很特别，就是镜像ID为的行，这一行是什么呢？<br>看了 <a href="https://docs.docker.com/storage/storagedriver/">官方文档</a> 的描述，我们知道这些构建步骤要么是构建在另一个系统，要么是镜像的部分是从DockerHub上拉取下来的，要么是使用的是另一种构建工具BuildKit构建的。<br>很显然，我们这里就是第二种情况，因为我们的Dockerfile中第一句指令就是<code>FROM alpine:3.15.0</code>.</p><p><img src="/.com//%E9%95%9C%E5%83%8F%E5%88%86%E5%B1%82.png" alt="镜像分层"></p><p>从上面的图可以看到，我们的镜像是分层的，我们的Dockerfile中新增一条指令，就会新增一层！<br>如果我们将多个命令合成一个，那么也只会生成一层。修改一下上面的image_test:3.0，把两条RUN合并成一条</p><p>如果我们将多个命令合成一个，那么也只会生成一层。修改一下上面的image_test:3.0，把两条RUN合并成一条：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">FROM alpine:3.15.0<br>RUN dd if=/dev/zero of=file1 bs=10M count=1 &amp;&amp; \<br>    dd if=/dev/zero of=file2 bs=10M count=1<br></code></pre></td></tr></table></figure><p>使用<code>docker history</code> 查看image_test:4.0，可以看到，只有2层了！</p><h2 id="镜像分层的好处"><a href="#镜像分层的好处" class="headerlink" title="镜像分层的好处"></a>镜像分层的好处</h2><ul><li>拉取<strong>更快</strong>：因为分层了，只需拉取本地不存在的层即可！</li><li>存储<strong>更少</strong>：因为共同的层只需存储一份即可！</li><li>运行时存储<strong>更少</strong>：容器运行时可以共享相同的层！</li></ul><h1 id="docker网络模式与通信"><a href="#docker网络模式与通信" class="headerlink" title="docker网络模式与通信"></a>docker网络模式与通信</h1><p>默认的三种网络模式：<br>bridge：桥接模式<br>host：主机模式<br>none：无网络模式<br>查看网络模式：<br>docker network ls</p><p><img src="/.com//%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F.png" alt="网络模式"></p><h2 id="桥接模式"><a href="#桥接模式" class="headerlink" title="桥接模式"></a>桥接模式</h2><p>桥接模式是docker 的默认网络设置，当Docker服务启动时，会在主机上创建一个名为docker0的虚拟网桥，并<br>选择一个和宿主机不同的IP地址和子网分配给docker0网桥</p><p>安装工具：<br>yum -y install net-tools<br>yum install -y bridge-utils</p><p>查看桥接情况：<br>brctl show</p><h2 id="host模式"><a href="#host模式" class="headerlink" title="host模式"></a>host模式</h2><p>该模式下容器是不会拥有自己的ip地址，而是使用宿主机的ip地址和端口。</p><p>启动nginx容器命令并防火墙放开80端口：<br>docker run -d –net&#x3D;host mycentos:nginx &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -g “daemon off;”<br>firewall-cmd –zone&#x3D;public –add-port&#x3D;80&#x2F;tcp –permanent<br>firewall-cmd –reload</p><h2 id="none模式"><a href="#none模式" class="headerlink" title="none模式"></a>none模式</h2><p>none模式：关闭模式<br>无法连外网</p><h2 id="Docker-容器间基于Link实现单向通信"><a href="#Docker-容器间基于Link实现单向通信" class="headerlink" title="Docker 容器间基于Link实现单向通信"></a>Docker 容器间基于Link实现单向通信</h2><p>启动mysql数据库容器：<br>docker run –name mydb -e MYSQL_ROOT_PASSWORD&#x3D;abc123456 -d mysql:5.7<br>启动tomcat应用容器并link到mysql数据库：<br>docker run -itd –name tomcat1 –link mydb tomcat:tag注意：mydb 这个容器一定要存在！<br>官方版的mysql 5.7 需要安装工具才有ping命令:<br>apt-get update &amp;&amp; apt-get install iputils-ping</p><h2 id="Docker容器间利用brige网桥实现双向通信"><a href="#Docker容器间利用brige网桥实现双向通信" class="headerlink" title="Docker容器间利用brige网桥实现双向通信"></a>Docker容器间利用brige网桥实现双向通信</h2><p>执行：docker network ls</p><p>创建一个新的网桥：docker network create -d bridge my_bridge<br>启动第一个容器：docker run -itd –name tomcat centos:7<br>启动第二个容器：docker run -itd –name redis centos:7<br>把第一个容器加入网桥：docker network connect my_bridge tomcat<br>把第二个容器加入网桥：docker network connect my_bridge redis<br>最后分别进入俩个容器中进行验证</p><h2 id="特权模式"><a href="#特权模式" class="headerlink" title="特权模式"></a>特权模式</h2><p>启动一个普通的容器<br>docker run -itd –name mycentos centos:7 &#x2F;bin&#x2F;bash<br>安装网络工具：<br>yum -y install net-tools<br>执行route -n<br>删除网关：<br>route del default gw 172.17.0.1<br>启动拥有特权模式的容器：</p><p>docker run -itd –privileged&#x3D;true –name mycentos1 centos:7 &#x2F;bin&#x2F;bash<br>进入容器：<br>docker exec -it ef &#x2F;bin&#x2F;bash<br>删除网关<br>route del default gw 172.17.0.1<br>成功<br>备注：特权模式用的比较少</p><h2 id="Volume数据共享"><a href="#Volume数据共享" class="headerlink" title="Volume数据共享"></a>Volume数据共享</h2><p>dockerfile</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">FROM centos:7<br>VOLUME [&quot;/usr/local&quot;]<br></code></pre></td></tr></table></figure><p>注意：在dockerfile里设置volume是无法修改宿主机的挂载路径的</p><p>使用volume容器共享创建nginx集群<br>使用–volumes-from 实现容器与容器之间volume共享<br>创建nginx1<br>docker run -itd -p 8080:80 -v &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html:&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html –name nginx1<br>mycentos:nginx &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -g “daemon off;”<br>创建nginx2<br>docker run -itd -p 8081:80 –volumes-from nginx1 –name nginx2 mycentos:nginx<br>&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -g “daemon off;”<br>创建nginx3<br>docker run -itd -p 8082:80 –volumes-from nginx1 –name nginx3 mycentos:nginx<br>&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -g “daemon off;”<br>对&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html&#x2F;index.html进行修改<br>打开浏览器进行访问测试<br>使用docker inspect 容器ID 可以查看详细的挂载信息</p><h1 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker-Compose"></a>Docker-Compose</h1><p>docker-compose：是一个用于定义和运行多容器 Docker 的应用程序工具，可以帮助我们可以轻松、高效的管理容器.</p><p>查看docker-compose版本：(docker-compose version  老版本的)<br>docker compose version</p><h2 id="运行WordPress"><a href="#运行WordPress" class="headerlink" title="运行WordPress"></a>运行WordPress</h2><p><a href="https://docs.docker.com/samples/wordpress/">https://docs.docker.com/samples/wordpress/</a></p><ol><li>创建一个空的项目目录。</li><li>切换到您的项目目录。</li><li>创建docker-compose.yml</li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">db:</span><br>    <span class="hljs-comment"># We use a mariadb image which supports both amd64 &amp; arm64 architecture</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">mariadb:10.6.4-focal</span><br>    <span class="hljs-comment"># If you really want to use MySQL, uncomment the following line</span><br>    <span class="hljs-comment">#image: mysql:8.0.27</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">&#x27;--default-authentication-plugin=mysql_native_password&#x27;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">db_data:/var/lib/mysql</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">MYSQL_ROOT_PASSWORD=somewordpress</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">MYSQL_DATABASE=wordpress</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">MYSQL_USER=wordpress</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">MYSQL_PASSWORD=wordpress</span><br>    <span class="hljs-attr">expose:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">3306</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">33060</span><br>  <span class="hljs-attr">wordpress:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">wordpress:latest</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">80</span><span class="hljs-string">:80</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">WORDPRESS_DB_HOST=db</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">WORDPRESS_DB_USER=wordpress</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">WORDPRESS_DB_PASSWORD=wordpress</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">WORDPRESS_DB_NAME=wordpress</span><br><span class="hljs-attr">volumes:</span><br>  <span class="hljs-attr">db_data:</span><br></code></pre></td></tr></table></figure><p>构建：</p><p>docker compose up -d</p><p>在浏览器中打开wordPress  <a href="http://localhost:8000/">http://localhost:8000</a></p><p>关闭和清理</p><p>该命令<a href="https://docs.docker.com/engine/reference/commandline/compose_down/"><code>docker compose down</code></a>会删除容器和默认网络，但会保留您的 WordPress 数据库。</p><p>该命令<code>docker compose down --volumes</code>删除容器、默认网络和 WordPress 数据库。</p><h2 id="compose命令"><a href="#compose命令" class="headerlink" title="compose命令"></a>compose命令</h2><p>compose操作容器（一定要进入配置文件目录）<br>后台启动容器：docker compose up -d<br>查看容器运行情况：docker compose ps<br>停止并删除容器：docker compose down<br>停止并删除容器并删除volume：docker compose down –volumes<br>停止启动容器：docker-compose stop；docker-compose start<br>docker-compose exec的使用：docker-compose exec redis bash</p><h2 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h2><p>docker-compose.yml的三大部分：version，services，networks，最关键是services和networks两个部分<br>compose设置网络模式<br>compose使用端口映射<br>compose设置文件共享<br>compose管理多个容器</p><p>docker-compose.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><br><span class="hljs-attr">services:</span><br><span class="hljs-attr">nginx:</span><br><span class="hljs-attr">image:</span> <span class="hljs-string">mycentos:nginx</span><br><span class="hljs-attr">network_mode:</span> <span class="hljs-string">&quot;host&quot;</span><br><span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/home:/usr/local/nginx/html</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/var/logs/nginx/logs:/usr/local/nginx/logs</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">/usr/local/nginx/sbin/nginx</span> <span class="hljs-string">-g</span> <span class="hljs-string">&quot;daemon off;&quot;</span><br><span class="hljs-attr">redis:</span><br><span class="hljs-attr">image:</span> <span class="hljs-string">mycentos:redis</span><br><span class="hljs-attr">ports:</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">&quot;6380:6379&quot;</span><br></code></pre></td></tr></table></figure><h1 id="阿里云镜像仓库"><a href="#阿里云镜像仓库" class="headerlink" title="阿里云镜像仓库"></a>阿里云镜像仓库</h1><p><a href="https://cr.console.aliyun.com/cn-shanghai/instances/repositories">https://cr.console.aliyun.com/cn-shanghai/instances/repositories</a></p><h1 id="harbor仓库"><a href="#harbor仓库" class="headerlink" title="harbor仓库"></a>harbor仓库</h1><h2 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h2><p>安装 yum -y install openssl</p><p>下载 <a href="https://github.com/goharbor/harbor/releases">https://github.com/goharbor/harbor/releases</a></p><p>上传对应安装包<br>修改配置：harbor.yml<br>修改主机名（注意空格）：hostname: 192.168.0.151<br>修改密码（注意空格）：harbor_admin_password: Harbor12345</p><p>执行脚本：sh prepare</p><p>执行安装命令：sh install.sh<br>执行命令：docker-compose ps<br>访问Harbor，默认用户名admin<br>关闭：docker-compose down<br>启动：docker-compose up -d</p><h2 id="配置与使用harbor仓库"><a href="#配置与使用harbor仓库" class="headerlink" title="配置与使用harbor仓库"></a>配置与使用harbor仓库</h2><p>Docker配置使用自建仓库<br>    默认docker只允许访问 https仓库<br>    如果要访问http仓库需要自己配置<br>配置允许访问http仓库：&#x2F;etc&#x2F;docker&#x2F;daemon.json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span> <br>  <span class="hljs-attr">&quot;insecure-registries&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">&quot;http://192.168.0.151&quot;</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>重启docker服务：systemctl restart docker.service<br>网页上创建项目名<br>登录：docker login –username&#x3D;admin 192.168.0.151<br>改名：docker tag mysql:5.7 192.168.0.151&#x2F;xx&#x2F;mysql:5.7<br>推送：docker push 192.168.0.151&#x2F;xx&#x2F;mysql:5.7<br>下载：docker pull 192.168.0.151&#x2F;xx&#x2F;mysql:5.7<br>docker login 后有一个登录凭证（可删除，下次需要密码）：<br>&#x2F;root&#x2F;.docker&#x2F;config.json （建议从安全角度出发，每次登录后进行删除）</p><h1 id="镜像的本地载入载出"><a href="#镜像的本地载入载出" class="headerlink" title="镜像的本地载入载出"></a>镜像的本地载入载出</h1><p>两种办法：</p><p>保存镜像<br>保存容器</p><p>保存镜像：<br>docker save cd3ed0dfff7e -o &#x2F;home&#x2F;mysql.tar<br>docker save mysql:5.7 &gt; &#x2F;home&#x2F;mysql.tar<br>载入镜像：<br>docker load -i mysql.tar<br>保存容器：<br>docker export 974b919e1fdd -o &#x2F;home&#x2F;mysql-export.tar<br>载入容器：<br>docker import mysql-export.tar</p>]]></content>
    
    
    <categories>
      
      <category>devops</category>
      
    </categories>
    
    
    <tags>
      
      <tag>devops</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>如何计算并发数</title>
    <link href="/2022/08/10/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E5%A6%82%E4%BD%95%E8%AE%A1%E7%AE%97%E5%B9%B6%E5%8F%91%E6%95%B0/"/>
    <url>/2022/08/10/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E5%A6%82%E4%BD%95%E8%AE%A1%E7%AE%97%E5%B9%B6%E5%8F%91%E6%95%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="一、经典公式"><a href="#一、经典公式" class="headerlink" title="一、经典公式"></a>一、经典公式</h1><p>一般来说，利用以下经验公式进行估算系统的平均并发用户数和峰值数据 </p><p> 1）平均并发用户数为 C &#x3D; nL&#x2F;T</p><p> 2）并发用户数峰值 C‘ &#x3D; C + 3*根号C</p><p>  C是平均并发用户数，n是login session的数量，L是login session的平均长度，T是值考察的时间长度</p><p>  C’是并发用户数峰值</p><h2 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h2><p>假设系统A，该系统有3000个用户，平均每天大概有400个用户要访问该系统（可以从系统日志从获得），对于一个典型用户来说，一天之内用户从登陆到退出的平均时间为4小时，而在一天之内，用户只有在8小时之内会使用该系统。</p><p> 那么，</p><p> 平均并发用户数为：C &#x3D; 400*4&#x2F;8 &#x3D; 200</p><p> 并发用户数峰值为：C‘ &#x3D; 200 + 3*根号200 &#x3D; 243</p><h1 id="二、通用公式："><a href="#二、通用公式：" class="headerlink" title="二、通用公式："></a>二、通用公式：</h1><p> 对绝大多数场景，我们用（用户总量&#x2F;统计时间）*影响因子（一般为3）来进行估算并发量。</p><h2 id="举例-1"><a href="#举例-1" class="headerlink" title="举例"></a>举例</h2><figure class="highlight text"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><pre><code class="hljs text">以乘坐地铁为例子，每天乘坐人数为5万人次，每天早高峰是7到9点，晚高峰是6到7点，<br><br>根据8/2原则，80%的乘客会在高峰期间乘坐地铁，<br>则每秒到达地铁检票口的人数为50000*80%/（3*60*60）=3.7，约4人/S，<br>考虑到安检，入口关闭等因素，实际堆积在检票口的人数肯定比这个要大，<br>假定每个人需要3秒才能进站，那实际并发应为4人/s*3s=12，当然影响因子可以根据实际情况增大！<br></code></pre></td></tr></table></figure><h1 id="三、根据PV计算公式："><a href="#三、根据PV计算公式：" class="headerlink" title="三、根据PV计算公式："></a>三、根据PV计算公式：</h1><p>Page Views一般指页面浏览量</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs text">比如一个网站，每天的PV大概1000w，根据2/8原则，<br>我们可以认为这1000w pv的80%是在一天的9个小时内完成的（人的精力有限），<br><br>那么TPS为： 1000w*80%/(9*3600)=246.92个/s,取经验因子3，<br><br>则并发量应为： 246.92*3=740<br></code></pre></td></tr></table></figure><h1 id="四、根据TPS估计："><a href="#四、根据TPS估计：" class="headerlink" title="四、根据TPS估计："></a>四、根据TPS估计：</h1><p>Transcation Per Second 每秒进行的事务的数目。（整体定义事务的 请求、操作、返回）。</p><p>Think Time是一个真实的用户动作之间的等待时间。</p><p>  公式为 C &#x3D; (Think time + 1)*TPS</p><h1 id="五、根据系统用户数计算："><a href="#五、根据系统用户数计算：" class="headerlink" title="五、根据系统用户数计算："></a>五、根据系统用户数计算：</h1><p>并发用户数 &#x3D; 系统最大在线用户数的5%到10%</p><h1 id="六、服务的调用方的数量"><a href="#六、服务的调用方的数量" class="headerlink" title="六、服务的调用方的数量"></a>六、服务的调用方的数量</h1><h2 id="拿什么来做为并发数"><a href="#拿什么来做为并发数" class="headerlink" title="拿什么来做为并发数"></a>拿什么来做为并发数</h2><ol><li>并发的用户数。有一部分用户使用业务，另外一部分用户 挂机，没有具体操作。</li><li>并发连接数。用户和服务器之间的连接。一部分连接在传输数据，一部分连接 仅仅连接而已。</li><li>并发请求数。有可能请求静态数据，有可能是写操作 这两者消耗性能不一样。</li><li>并发线程数。系统内，并发的线程数目。线程多不一定是用户造成的，有可能是系统复杂。</li></ol><p>以上都不能准确的表示。没有并发数的统一标准。</p><p>一般在公司使用：同时服务的调用方的数量。</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>以上都是预估的。所以都不准确，只能当做参考。真正的线上还是要做好扩容、限流等。</p><p>然后才能使用监控服务，对某个服务进行监控。比如淘宝的双11，商户详情服务、订单服务。才能知道峰值的并发数。</p>]]></content>
    
    
    <categories>
      
      <category>系统设计</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>如何从新手迅速成长为高手</title>
    <link href="/2022/08/08/%E6%96%B9%E6%B3%95%E8%AE%BA/%E5%A6%82%E4%BD%95%E4%BB%8E%E6%96%B0%E6%89%8B%E8%BF%85%E9%80%9F%E6%88%90%E9%95%BF%E4%B8%BA%E9%AB%98%E6%89%8B/"/>
    <url>/2022/08/08/%E6%96%B9%E6%B3%95%E8%AE%BA/%E5%A6%82%E4%BD%95%E4%BB%8E%E6%96%B0%E6%89%8B%E8%BF%85%E9%80%9F%E6%88%90%E9%95%BF%E4%B8%BA%E9%AB%98%E6%89%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="新手与高手的差距"><a href="#新手与高手的差距" class="headerlink" title="新手与高手的差距"></a>新手与高手的差距</h1><p>新手和高手的差距集中体现在解决问题上。</p><p>问题分为：常规问题、非常规问题、简单问题、复杂问题(由多个简单问题组合成的)</p><p>高手：</p><p>快速解决问题</p><p>识别细微的差异</p><p>识别情景</p><p>有效监控问题解决的策略和过程</p><p>准确性高</p><p>看问题的深度</p><h1 id="产生差距的原因是什么？"><a href="#产生差距的原因是什么？" class="headerlink" title="产生差距的原因是什么？"></a>产生差距的原因是什么？</h1><p>知识、经验、技巧</p><p>知识 + 经验 + 技巧  &#x3D; 模式</p><p>什么是模式：</p><p>以某个问题为核心，将与之相关的知识、经验及技巧组合在一起的块状或树状结构。</p><p>高手拥有模式库。</p><p>遇到问题找模式。</p><p>找不到模式：</p><p>​头脑中的模式进行调整</p><p>​多个模式整合</p><p>​吸收新知识，直到找到问题的解决办法。</p><p>​存储模式。</p><h1 id="成长为高手的三大途径"><a href="#成长为高手的三大途径" class="headerlink" title="成长为高手的三大途径"></a>成长为高手的三大途径</h1><h2 id="学习《最佳实践》"><a href="#学习《最佳实践》" class="headerlink" title="学习《最佳实践》"></a>学习《最佳实践》</h2><p>1.公司安排的师傅或导师</p><p>2.主动寻找高手，观察并模仿</p><p>3.研读高手的著作</p><h2 id="模拟"><a href="#模拟" class="headerlink" title="模拟"></a>模拟</h2><h3 id="角色扮演"><a href="#角色扮演" class="headerlink" title="角色扮演"></a>角色扮演</h3><h3 id="案例研究"><a href="#案例研究" class="headerlink" title="案例研究"></a>案例研究</h3><p>1.判断案例问题</p><p>2.运用知识分析案例</p><p>3.带着案例分析与人讨论</p><h3 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h3><p>并非一开始反思就能找到问题的本质和解决方法</p><p>从浅到深：</p><p>总结性反思：我做了什么？结果怎么样？我拜访了哪些客户，进展如何？</p><p>自我评价性反思：我做得怎么样？好还是坏？我有哪些地方做得不足？</p><p>对比性反思：我哪里做得好？哪里做得不好？该如何改善？</p><p>批判性反思：我为什么这么做？为什么做得好或者不好？哪些因素影响了我的行为？为什么客户会拒绝我？</p><h3 id="反思的三种方法"><a href="#反思的三种方法" class="headerlink" title="反思的三种方法"></a>反思的三种方法</h3><h4 id="自我对话"><a href="#自我对话" class="headerlink" title="自我对话"></a>自我对话</h4><p>我刚刚做了什么？</p><p>做得怎么样？</p><p>哪些地方需要改善？</p><p>为什么会导致现在的状态？</p><p>如果遇到类似的问题，应该采取什么样的措施？</p><h4 id="写反思日记"><a href="#写反思日记" class="headerlink" title="写反思日记"></a>写反思日记</h4><h4 id="和同事合作讨论"><a href="#和同事合作讨论" class="headerlink" title="和同事合作讨论"></a>和同事合作讨论</h4><h3 id="反思过后，一定要采取行动"><a href="#反思过后，一定要采取行动" class="headerlink" title="反思过后，一定要采取行动"></a>反思过后，一定要采取行动</h3>]]></content>
    
    
    <categories>
      
      <category>方法论</category>
      
    </categories>
    
    
    <tags>
      
      <tag>方法论</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>时间管理</title>
    <link href="/2022/08/08/%E6%96%B9%E6%B3%95%E8%AE%BA/%E6%97%B6%E9%97%B4%E7%AE%A1%E7%90%86/"/>
    <url>/2022/08/08/%E6%96%B9%E6%B3%95%E8%AE%BA/%E6%97%B6%E9%97%B4%E7%AE%A1%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="对不同的事务进行分类"><a href="#对不同的事务进行分类" class="headerlink" title="对不同的事务进行分类"></a>对不同的事务进行分类</h1><p>重要并紧迫的事务  A类</p><p>重要不紧迫的事务 B类</p><p>不重要但紧迫的事务 C类</p><p>不重要不紧迫的事务D类</p><p>A类事务 ：</p><p>危机事务、急迫问题</p><p>有期限压务的计划</p><p>B类事务：</p><p>建立人际关系</p><p>撰写使命宣言</p><p>规划长期目标</p><p>改进产能</p><p>防患于未然</p><p>发掘新机会</p><p>C类事务</p><p>不速之客的来访</p><p>处理某些电话、邮件和报告</p><p>某些没有议题的会议</p><p>D类事务</p><p>繁琐、浪费时间的事情</p><h1 id="提高时间效能的方法"><a href="#提高时间效能的方法" class="headerlink" title="提高时间效能的方法"></a>提高时间效能的方法</h1><p>A类  立即处理</p><p>B类  优先处理</p><p>C类  最后处理</p><p>D类 予以回避</p><p>避免B类事务转化A类事务。</p><p>A类  安排 20-25%的时间</p><p>B类  安排 65-80%的时间</p><p>C类安排 &lt; 15%的时间。</p>]]></content>
    
    
    <categories>
      
      <category>方法论</category>
      
    </categories>
    
    
    <tags>
      
      <tag>方法论</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>KJ法收集和分析信息</title>
    <link href="/2022/08/08/%E6%96%B9%E6%B3%95%E8%AE%BA/KJ%E6%B3%95%E6%94%B6%E9%9B%86%E5%92%8C%E5%88%86%E6%9E%90%E4%BF%A1%E6%81%AF/"/>
    <url>/2022/08/08/%E6%96%B9%E6%B3%95%E8%AE%BA/KJ%E6%B3%95%E6%94%B6%E9%9B%86%E5%92%8C%E5%88%86%E6%9E%90%E4%BF%A1%E6%81%AF/</url>
    
    <content type="html"><![CDATA[<h2 id="KJ法收集和分析信息"><a href="#KJ法收集和分析信息" class="headerlink" title="KJ法收集和分析信息"></a>KJ法收集和分析信息</h2><p>KJ分析法又叫亲和图法,为川喜田二郎所创。是将收集到的资料和信息，根据他们之间的相近性分类综合分析的一种方法，又称为卡片法。</p><h3 id="kj法的适用范围"><a href="#kj法的适用范围" class="headerlink" title="kj法的适用范围"></a>kj法的适用范围</h3><p>了解市场状况时</p><p>问题比较复杂，情况混淆不清，牵涉部门众多时</p><p>探索未知领域，比如研发新品时</p><h3 id="KJ法运用流程"><a href="#KJ法运用流程" class="headerlink" title="KJ法运用流程"></a>KJ法运用流程</h3><h4 id="组织团队"><a href="#组织团队" class="headerlink" title="组织团队"></a>组织团队</h4><p>组织团队进行讨论</p><h4 id="建立共识"><a href="#建立共识" class="headerlink" title="建立共识"></a>建立共识</h4><h4 id="定义挑战"><a href="#定义挑战" class="headerlink" title="定义挑战"></a>定义挑战</h4><h4 id="开展头脑风景"><a href="#开展头脑风景" class="headerlink" title="开展头脑风景"></a>开展头脑风景</h4><h4 id="汇集问题"><a href="#汇集问题" class="headerlink" title="汇集问题"></a>汇集问题</h4><h4 id="分类整理"><a href="#分类整理" class="headerlink" title="分类整理"></a>分类整理</h4><h4 id="编排卡片"><a href="#编排卡片" class="headerlink" title="编排卡片"></a>编排卡片</h4><h4 id="划分责任"><a href="#划分责任" class="headerlink" title="划分责任"></a>划分责任</h4><h4 id="构思方案"><a href="#构思方案" class="headerlink" title="构思方案"></a>构思方案</h4><h4 id="效果确认与跟进"><a href="#效果确认与跟进" class="headerlink" title="效果确认与跟进"></a>效果确认与跟进</h4><h4 id="标准化"><a href="#标准化" class="headerlink" title="标准化"></a>标准化</h4><h3 id="KJ法的优势与难点"><a href="#KJ法的优势与难点" class="headerlink" title="KJ法的优势与难点"></a>KJ法的优势与难点</h3>]]></content>
    
    
    <categories>
      
      <category>方法论</category>
      
    </categories>
    
    
    <tags>
      
      <tag>方法论</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用PLAN法提升执行力</title>
    <link href="/2022/08/08/%E6%96%B9%E6%B3%95%E8%AE%BA/%E4%BD%BF%E7%94%A8PLAN%E6%B3%95%E6%8F%90%E5%8D%87%E6%89%A7%E8%A1%8C%E5%8A%9B/"/>
    <url>/2022/08/08/%E6%96%B9%E6%B3%95%E8%AE%BA/%E4%BD%BF%E7%94%A8PLAN%E6%B3%95%E6%8F%90%E5%8D%87%E6%89%A7%E8%A1%8C%E5%8A%9B/</url>
    
    <content type="html"><![CDATA[<h2 id="什么是PLAN法"><a href="#什么是PLAN法" class="headerlink" title="什么是PLAN法"></a>什么是PLAN法</h2><p>P(plan)  : 制定执行计划</p><p>L(launch) : 快速行动</p><p>A(adjustment) : 及时调整</p><p>N(network) : 充分沟通</p><h3 id="制定执行计划"><a href="#制定执行计划" class="headerlink" title="制定执行计划"></a>制定执行计划</h3><p>计划模板：</p><p>时间 ： 执行计划的进度安排</p><p>事件： 将工作计划分为若干目标以及达到目标要做的事情</p><p>人力：计划执行人员、配合人员以及监督人员等</p><p>资源：为达到目标及事件所需财力、物力的情况</p><p>预案：遇到突然情况可实施的后备方案</p><h4 id="长期计划和短期计划"><a href="#长期计划和短期计划" class="headerlink" title="长期计划和短期计划"></a>长期计划和短期计划</h4><p>不要在制定计划上花太多的时间和精力</p><p>长期计划关注：主要工作及完成时间</p><p>短期计划关注：30天、60天或者90天的计划</p><h3 id="快速行动"><a href="#快速行动" class="headerlink" title="快速行动"></a>快速行动</h3><p>根据情况快速、果断地采取行动</p><h3 id="及时调整"><a href="#及时调整" class="headerlink" title="及时调整"></a>及时调整</h3><p>根据出现的问题进行调查、研究、分析并及时调整计划。</p><h3 id="充分沟通"><a href="#充分沟通" class="headerlink" title="充分沟通"></a>充分沟通</h3><table><thead><tr><th>沟通形式</th><th>由谁主持</th><th>频率</th><th>进行沟通的原因</th></tr></thead><tbody><tr><td>工程状况报告</td><td>核心团队以及主题专家</td><td>每周</td><td>告诉人们安排了什么工作，完成了什么工作，遇到的难题及其严重性，还有这些难题给工程带来的影响</td></tr><tr><td>团队的工程状况报告</td><td>团队领导者</td><td>每周</td><td>总结个人状况报告以及对工程状况的意见</td></tr><tr><td>项目工程报告</td><td>每个项目的项目经理</td><td>每月</td><td>财务细节以及向工程发起人、指导委员会和工程利益相关者报告项目工程进度状况</td></tr><tr><td>团队会议</td><td>工程核心团队</td><td>开始每周，以后待定</td><td>共同作出决策、提示问题、监控进展和改进过程</td></tr><tr><td>项目更新</td><td>每个项目经理</td><td>每周</td><td>保证项目负责人得到最新的信息</td></tr></tbody></table><h4 id="沟通过程的要点"><a href="#沟通过程的要点" class="headerlink" title="沟通过程的要点"></a>沟通过程的要点</h4><p>开头：简短回顾，为沟通设定出发点</p><p>具体：切忌浮夸，不做过度承诺，将行动和沟通结合起来</p><p>倾听：得到相应反馈</p>]]></content>
    
    
    <categories>
      
      <category>方法论</category>
      
    </categories>
    
    
    <tags>
      
      <tag>方法论</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java的IO</title>
    <link href="/2022/07/12/java/java%E7%9A%84IO/"/>
    <url>/2022/07/12/java/java%E7%9A%84IO/</url>
    
    <content type="html"><![CDATA[<h1 id="linux文件系统"><a href="#linux文件系统" class="headerlink" title="linux文件系统"></a>linux文件系统</h1><p>linux中常说的一句话  “ 一切皆文件”</p><p>数据块：</p><p>硬盘分成相同大小的单元，我们称为块（Block）。一块的大小是扇区大小的整数倍，默认是 4K。</p><p>Inode:</p><p>index  node,  linux中文件抽象出来的一个数据结构(class), index就是索引，就是去哪找组成文件的数据块。</p><p>文件描述符 fd（File Descriptor）:</p><p>当使用系统调用 open 打开一个文件时，操作系统会创建一些数据结构来表示这个被打开的文件。为了能够找到这些数据结构，在进程中，我们会为这个打开的文件分配一个文件描述符 fd（File Descriptor）。</p><p>pageCache：</p><p>内存比磁盘快，linux把热点数据放入内存中，这个块区域称为pageCache。</p><p>虚拟文件系统VFS:</p><p>Linux 可以支持多达数十种不同的文件系统（ext4、ext3、ntfs）。它们的实现各不相同，因此 Linux 内核向用户空间提供了虚拟文件系统这个统一的接口，来对文件系统进行操作。</p><p><img src="/.com//linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F.webp" alt="linux文件系统"></p><h1 id="DMA-Direct-Memory-Access，直接存储器访问"><a href="#DMA-Direct-Memory-Access，直接存储器访问" class="headerlink" title="DMA(Direct Memory Access，直接存储器访问)"></a>DMA(Direct Memory Access，直接存储器访问)</h1><p>是所有现代电脑的重要特色，它允许不同速度的硬件装置来沟通，而不需要依赖于CPU的大量中断负载。否则，CPU 需要从来源把每一片段的资料复制到寄存器，然后把它们再次写回到新的地方。在这个时间中，CPU 对于其他的工作来说就无法使用。</p><p><img src="/.com//DMA%E4%BC%A0%E8%BE%93%E6%96%B9%E5%BC%8F.webp" alt="DMA传输方式"></p><p>1）用户进程向 CPU 发起 read 系统调用读取数据，由用户态切换为内核态，然后一直阻塞等待数据的返回。</p><p>2）CPU 在接收到指令以后对 DMA 磁盘控制器发起调度指令。</p><p>3）DMA 磁盘控制器对磁盘发起 I&#x2F;O 请求，将磁盘数据先放入磁盘控制器缓冲区，CPU 全程不参与此过程。</p><p>4）数据读取完成后，DMA 磁盘控制器会接受到磁盘的通知，将数据从磁盘控制器缓冲区拷贝到内核缓冲区。</p><p>5）DMA 磁盘控制器向 CPU 发出数据读完的信号，由 CPU 负责将数据从内核缓冲区拷贝到用户缓冲区。</p><p>6）用户进程由内核态切换回用户态，解除阻塞状态，然后等待 CPU 的下一个执行时间钟。</p><h1 id="内核缓冲区与进程缓冲区"><a href="#内核缓冲区与进程缓冲区" class="headerlink" title="内核缓冲区与进程缓冲区"></a>内核缓冲区与进程缓冲区</h1><p>缓冲区的目的，是为了减少频繁的系统IO调用。大家都知道，系统调用需要保存之前的进程数据和状态等信息，而结束调用之后回来还需要恢复之前的信息，为了减少这种损耗时间、也损耗性能的系统调用，于是出现了缓冲区。</p><p>有了缓冲区，操作系统使用read函数把数据从内核缓冲区复制到进程缓冲区，write把数据从进程缓冲区复制到内核缓冲区中。等待缓冲区达到一定数量的时候，再进行IO的调用，提升性能。至于什么时候读取和存储则由内核来决定，用户程序不需要关心。</p><p>在linux系统中，系统内核也有个缓冲区叫做内核缓冲区。每个进程有自己独立的缓冲区，叫做进程缓冲区。</p><p>所以，用户程序的IO读写程序，大多数情况下，并没有进行实际的IO操作，而是在读写自己的进程缓冲区。 </p><h1 id="什么是IO"><a href="#什么是IO" class="headerlink" title="什么是IO"></a>什么是IO</h1><p>O，英文全称是Input&#x2F;Output，翻译过来就是<strong>输入&#x2F;输出</strong>。平时我们听得挺多，就是什么磁盘IO，网络IO。那IO到底是什么呢？是不是有种懵懵懂懂的感觉呀，好像大概知道它是什么，又好像说不清楚。</p><p><strong>IO，即输入&#x2F;输出</strong>，到底谁是输入？谁是输出呢？IO如果脱离了主体，就会让人疑惑。</p><h2 id="计算机角度的IO"><a href="#计算机角度的IO" class="headerlink" title="计算机角度的IO"></a>计算机角度的IO</h2><p>我们常说的输入输出，比较直观的意思就是<strong>计算机的输入输出</strong>，<strong>计算机就是主体</strong>。大家是否还记得，大学学<strong>计算机组成原理</strong>的时候，有个<strong>冯.诺依曼结构</strong>，它将计算机分成分为5个部分：运算器、控制器、存储器、输入设备、输出设备。</p><p><img src="/.com//%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%92%E5%BA%A6%E7%9A%84IO.png" alt="计算机角度的IO"></p><p>输入设备是向计算机输入数据和信息的设备，键盘，鼠标都属于输入设备；输出设备是计算机硬件系统的终端设备，用于接收计算机数据的输出显示，一般显示器、打印机属于输出设备。</p><blockquote><p> 例如你在鼠标键盘敲几下，它就会把你的指令数据，传给主机，主机通过运算后，把返回的数据信息，输出到显示器。 </p></blockquote><p>鼠标、显示器这只是直观表面的输入输出，回到计算机架构来说，<strong>涉及计算机核心与其他设备间数据迁移的过程，就是IO</strong>。如磁盘IO，就是从磁盘读取数据到内存，这算一次输入，对应的，将内存中的数据写入磁盘，就算输出。这就是IO的本质。</p><h2 id="操作系统的IO"><a href="#操作系统的IO" class="headerlink" title="操作系统的IO"></a>操作系统的IO</h2><p>我们要将内存中的数据写入到磁盘的话，主体会是什么呢？主体可能是一个应用程序，比如一个Java进程（假设网络传来二进制流，一个Java进程可以把它写入到磁盘）。</p><p><strong>操作系统</strong>负责计算机的资源管理和进程的调度。我们电脑上跑着的应用程序，其实是需要经过<strong>操作系统</strong>，才能做一些特殊操作，如<strong>磁盘文件读写、内存的读写</strong>等等。因为这些都是比较危险的操作，不可以由应用程序乱来，只能交给底层操作系统来。也就是说，你的应用程序要把数据写入磁盘，只能通过调用操作系统开放出来的API来操作。</p><blockquote></blockquote><blockquote><p>  什么是用户空间？什么是内核空间?  </p></blockquote><blockquote><p>  以32位操作系统为例，它为每一个进程都分配了4G(2的32次方)的内存空间。这4G可访问的内存空间分为二部分，一部分是用户空间，一部分是内核空间。内核空间是操作系统内核访问的区域，是受保护的内存空间，而用户空间是用户应用程序访问的内存区域。  </p></blockquote><blockquote></blockquote><p>我们应用程序是跑在用户空间的，它不存在实质的IO过程，真正的IO是在<strong>操作系统</strong>执行的。即应用程序的IO操作分为两种动作：<strong>IO调用和IO执行</strong>。IO调用是由进程（应用程序的运行态）发起，而IO执行是<strong>操作系统内核</strong>的工作。此时所说的IO是应用程序对操作系统IO功能的一次触发，即IO调用。</p><h1 id="操作系统的一次IO过程"><a href="#操作系统的一次IO过程" class="headerlink" title="操作系统的一次IO过程"></a>操作系统的一次IO过程</h1><p>应用程序发起的一次IO操作包含两个阶段：</p><ul><li><p>IO调用：应用程序进程向操作系统<strong>内核</strong>发起调用。  </p></li><li><p>IO执行：操作系统内核完成IO操作。</p></li></ul><p>操作系统内核完成IO操作还包括两个过程：</p><ul><li><p>准备数据阶段：内核等待I&#x2F;O设备准备好数据  </p></li><li><p>拷贝数据阶段：将数据从内核缓冲区拷贝到用户进程缓冲区</p></li></ul><p><img src="/.com//%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%B8%80%E6%AC%A1IO%E8%BF%87%E7%A8%8B.png" alt="操作系统的一次IO过程"></p><p>其实IO就是把进程的内部数据转移到外部设备，或者把外部设备的数据迁移到进程内部。外部设备一般指硬盘、socket通讯的网卡。一个完整的<strong>IO过程</strong>包括以下几个步骤：</p><ul><li><p>应用程序进程向操作系统发起<strong>IO调用请求</strong></p></li><li><p>操作系统<strong>准备数据</strong>，把IO外部设备的数据，加载到<strong>内核缓冲区</strong></p></li><li><p>操作系统拷贝数据，即将内核缓冲区的数据，拷贝到用户进程缓冲区</p></li></ul><h2 id="阻塞和非阻塞的区别"><a href="#阻塞和非阻塞的区别" class="headerlink" title="阻塞和非阻塞的区别"></a>阻塞和非阻塞的区别</h2><p>阻塞和非阻塞的区别就在于第一个阶段，如果数据没有就绪，在查看数据是否就绪的过程中是一直等待，还是直接返回一个标志信息。</p><p>同步和异步的区别是否会导致发起IO请求的线程暂停。</p><h2 id="同步与异步的区别"><a href="#同步与异步的区别" class="headerlink" title="同步与异步的区别"></a>同步与异步的区别</h2><p>同步需要通过用户线程或者内核不断地去轮询数据是否就绪。</p><p>异步是IO操作的两个阶段都是由内核自动完成，然后发送通知告知用户线程IO操作已经完成。</p><h1 id="阻塞IO模型"><a href="#阻塞IO模型" class="headerlink" title="阻塞IO模型"></a>阻塞IO模型</h1><p>我们已经知道IO是什么啦，那什么是<strong>阻塞IO</strong>呢？</p><p>假设应用程序的进程发起<strong>IO调用</strong>，但是如果<strong>内核的数据还没准备好</strong>的话，那应用程序进程就一直在<strong>阻塞等待</strong>，一直等到内核数据准备好了，从内核拷贝到用户空间，才返回成功提示，此次IO操作，称之为<strong>阻塞IO</strong>。</p><p><img src="/.com//%E9%98%BB%E5%A1%9EIO%E6%A8%A1%E5%9E%8B.png" alt="阻塞IO模型"></p><ul><li><p>阻塞IO比较经典的应用就是<strong>阻塞socket、Java BIO</strong>。  </p></li><li><p>阻塞IO的缺点就是：如果内核数据一直没准备好，那用户进程将一直阻塞，<strong>浪费性能</strong>，可以使用<strong>非阻塞IO</strong>优化。</p></li></ul><h1 id="非阻塞IO模型"><a href="#非阻塞IO模型" class="headerlink" title="非阻塞IO模型"></a>非阻塞IO模型</h1><p>如果内核数据还没准备好，可以先返回错误信息给用户进程，让它不需要等待，而是通过轮询的方式再来请求。这就是非阻塞IO，流程图如下：</p><p><img src="/.com//%E9%9D%9E%E9%98%BB%E5%A1%9EIO%E6%A8%A1%E5%9E%8B.png" alt="非阻塞IO模型"></p><p>非阻塞IO的流程如下：</p><ul><li><p>应用进程向操作系统内核，发起<code>recvfrom</code>读取数据。  </p></li><li><p>操作系统内核数据没有准备好，立即返回<code>EWOULDBLOCK</code>错误码。  </p></li><li><p>应用程序进程轮询调用，继续向操作系统内核发起<code>recvfrom</code>读取数据。  </p></li><li><p>操作系统内核数据准备好了，从内核缓冲区拷贝到用户空间。  </p></li><li><p>完成调用，返回成功提示。</p></li></ul><p>非阻塞IO模型，简称<strong>NIO</strong>，<code>Non-Blocking IO</code>。它相对于阻塞IO，虽然大幅提升了性能，但是它依然存在<strong>性能问题</strong>，即<strong>频繁的轮询</strong>，导致频繁的系统调用，同样会消耗大量的CPU资源。可以考虑<strong>IO复用模型</strong>，去解决这个问题。</p><h1 id="IO多路复用模型"><a href="#IO多路复用模型" class="headerlink" title="IO多路复用模型"></a>IO多路复用模型</h1><p>既然<strong>NIO</strong>无效的轮询会导致CPU资源消耗，我们等到内核数据准备好了，主动通知应用进程再去进行系统调用，那不就好了嘛？</p><p>当程序打开一个现有文件或者创建一个新文件时，内核向进程返回一个文件描述符。</p><p>IO复用模型核心思路：系统给我们提供<strong>一类函数</strong>（如我们耳濡目染的<strong>select、poll、epoll</strong>函数），它们可以同时监控多个<code>fd</code>的操作，任何一个返回内核数据就绪，应用进程再发起<code>recvfrom</code>系统调用。</p><h2 id="IO多路复用之select"><a href="#IO多路复用之select" class="headerlink" title="IO多路复用之select"></a>IO多路复用之select</h2><p>应用进程通过调用<strong>select</strong>函数，可以同时监控多个<code>fd</code>，在<code>select</code>函数监控的<code>fd</code>中，只要有任何一个数据状态准备就绪了，<code>select</code>函数就会返回可读状态，这时应用进程再发起<code>recvfrom</code>请求去读取数据。</p><p><img src="/.com//IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E4%B9%8Bselect.png" alt="IO多路复用之select"></p><p>非阻塞IO模型（NIO）中，需要<code>N</code>（N&gt;&#x3D;1）次轮询系统调用，然而借助<code>select</code>的IO多路复用模型，只需要发起一次询问就够了,大大优化了性能。</p><p>但是呢，<code>select</code>有几个缺点：</p><ul><li><p>监听的IO最大连接数有限，在Linux系统上一般为1024。  </p></li><li><p>select函数返回后，是通过<strong>遍历</strong><code>fdset</code>，找到就绪的描述符<code>fd</code>。（仅知道有I&#x2F;O事件发生，却不知是哪几个流，所以<strong>遍历所有流</strong>）</p></li></ul><p>因为<strong>存在连接数限制</strong>，所以后来又提出了<strong>poll</strong>。与select相比，<strong>poll</strong>解决了<strong>连接数限制问题</strong>。但是呢，select和poll一样，还是需要通过遍历文件描述符来获取已经就绪的<code>socket</code>。如果同时连接的大量客户端，在一时刻可能只有极少处于就绪状态，伴随着监视的描述符数量的增长，<strong>效率也会线性下降</strong>。</p><p>因此经典的多路复用模型<code>epoll</code>诞生。</p><h1 id="IO多路复用之epoll"><a href="#IO多路复用之epoll" class="headerlink" title="IO多路复用之epoll"></a>IO多路复用之epoll</h1><p>为了解决<code>select/poll</code>存在的问题，多路复用模型<code>epoll</code>诞生，它采用事件驱动来实现，流程图如下：</p><p><img src="/.com//IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E4%B9%8Bselect.png" alt="IO多路复用之select"></p><p><strong>epoll</strong>先通过<code>epoll_ctl()</code>来注册一个<code>fd</code>（文件描述符），一旦基于某个<code>fd</code>就绪时，内核会采用回调机制，迅速激活这个<code>fd</code>，当进程调用<code>epoll_wait()</code>时便得到通知。这里去掉了<strong>遍历文件描述符</strong>的坑爹操作，而是采用<strong>监听事件回调</strong>的机制。这就是epoll的亮点。</p><p><strong>我们一起来总结一下select、poll、epoll的区别</strong></p><table><thead><tr><th></th><th>select</th><th>poll</th><th>epoll</th></tr></thead><tbody><tr><td>底层数据结构</td><td>数组</td><td>链表</td><td>红黑树和双链表</td></tr><tr><td>获取就绪的fd</td><td>遍历</td><td>遍历</td><td>事件回调</td></tr><tr><td>事件复杂度</td><td>O(n)</td><td>O(n)</td><td>O(1)</td></tr><tr><td>最大连接数</td><td>1024</td><td>无限制</td><td>无限制</td></tr><tr><td>fd数据拷贝</td><td>每次调用select</td><td>需要将fd数据从用户空间拷贝到内核空间 每次调用poll，需要将fd数据从用户空间拷贝到内核空间</td><td>使用内存映射(mmap)，不需要从用户空间频繁拷贝fd数据到内核空间</td></tr></tbody></table><p><strong>epoll</strong>明显优化了IO的执行效率，但在进程调用<code>epoll_wait()</code>时，仍然可能被阻塞。能不能酱紫：不用我老是去问你数据是否准备就绪，等我发出请求后，你数据准备好了通知我就行了，这就诞生了<strong>信号驱动IO模型</strong>。</p><h1 id="IO模型之信号驱动模型"><a href="#IO模型之信号驱动模型" class="headerlink" title="IO模型之信号驱动模型"></a>IO模型之信号驱动模型</h1><p>信号驱动IO不再用主动询问的方式去确认数据是否就绪，而是向内核发送一个信号（调用<code>sigaction</code>的时候建立一个<code>SIGIO</code>的信号），然后应用用户进程可以去做别的事，不用阻塞。当内核数据准备好后，再通过<code>SIGIO</code>信号通知应用进程，数据准备好后的可读状态。应用用户进程收到信号之后，立即调用<code>recvfrom</code>，去读取数据。</p><p><img src="/.com//IO%E6%A8%A1%E5%9E%8B%E4%B9%8B%E4%BF%A1%E5%8F%B7%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9E%8B.png" alt="IO模型之信号驱动模型"></p><p>信号驱动IO模型，在应用进程发出信号后，是立即返回的，不会阻塞进程。它已经有异步操作的感觉了。但是你细看上面的流程图，<strong>发现数据复制到应用缓冲的时候</strong>，应用进程还是阻塞的。回过头来看下，不管是BIO，还是NIO，还是信号驱动，在数据从内核复制到应用缓冲的时候，都是阻塞的。还有没有优化方案呢？<strong>AIO</strong>（真正的异步IO）！</p><h1 id="IO-模型之异步IO-AIO"><a href="#IO-模型之异步IO-AIO" class="headerlink" title="IO 模型之异步IO(AIO)"></a>IO 模型之异步IO(AIO)</h1><p>前面讲的<code>BIO，NIO和信号驱动</code>，在数据从内核复制到应用缓冲的时候，都是<strong>阻塞</strong>的，因此都不算是真正的异步。<code>AIO</code>实现了IO全流程的非阻塞，就是应用进程发出系统调用后，是立即返回的，但是<strong>立即返回的不是处理结果，而是表示提交成功类似的意思</strong>。等内核数据准备好，将数据拷贝到用户进程缓冲区，发送信号通知用户进程IO操作执行完毕。</p><p>流程如下：</p><p>![IO 模型之异步IO(AIO)](img&#x2F;IO 模型之异步IO(AIO).png)</p><p>异步IO的优化思路很简单，只需要向内核发送一次请求，就可以完成数据状态询问和数据拷贝的所有操作，并且不用阻塞等待结果。日常开发中，有类似思想的业务场景：</p><blockquote></blockquote><blockquote><p>比如发起一笔批量转账，但是批量转账处理比较耗时，这时候后端可以先告知前端转账提交成功，等到结果处理完，再通知前端结果即可。</p></blockquote><blockquote></blockquote><h1 id="阻塞、非阻塞、同步、异步IO总结"><a href="#阻塞、非阻塞、同步、异步IO总结" class="headerlink" title="阻塞、非阻塞、同步、异步IO总结"></a>阻塞、非阻塞、同步、异步IO总结</h1><ul><li><p>同步阻塞(blocking-IO)简称BIO  </p></li><li><p>同步非阻塞(non-blocking-IO)简称NIO  </p></li><li><p>异步非阻塞(asynchronous-non-blocking-IO)简称AIO</p></li></ul><p>BIO：同步阻塞，在服务器中实现的模式为<strong>一个连接一个线程</strong>。也就是说，客户端有连接请求的时候，服务器就需要启动一个线程进行处理，如果这个连接不做任何事情会造成不必要的线程开销，当然这也可以通过线程池机制改善。BIO<strong>一般适用于连接数目小且固定的架构</strong>，这种方式对于服务器资源要求比较高，而且并发局限于应用中，是JDK1.4之前的唯一选择，但好在程序直观简单，易理解。</p><p>NIO：同步非阻塞，在服务器中实现的模式为<strong>一个请求一个线程</strong>，也就是说，客户端发送的连接请求都会注册到多路复用器上，多路复用器轮询到有连接IO请求时才会启动一个线程进行处理。<strong>NIO一般适用于连接数目多且连接比较短（轻操作）的架构</strong>，并发局限于应用中，编程比较复杂，从JDK1.4开始支持。</p><p>AIO：异步并非阻塞，在服务器中实现的模式为<strong>一个有效请求一个线程</strong>，也就是说，客户端的IO请求都是通过操作系统先完成之后，再通知服务器应用去启动线程进行处理。AIO一般适用于连接数目多且连接比较长（重操作）的架构，充分调用操作系统参与并发操作，编程比较复杂，从JDK1.7开始支持。</p><h1 id="编写java-IO代码及查看系统调用"><a href="#编写java-IO代码及查看系统调用" class="headerlink" title="编写java IO代码及查看系统调用"></a>编写java IO代码及查看系统调用</h1><p><a href="https://blog.csdn.net/weixin_43970890/article/details/118355800">https://blog.csdn.net/weixin_43970890/article/details/118355800</a></p><h2 id="查看系统调用的工具"><a href="#查看系统调用的工具" class="headerlink" title="查看系统调用的工具"></a>查看系统调用的工具</h2><p>strace -ff -o .&#x2F;out java Test.java</p><h2 id="文件IO"><a href="#文件IO" class="headerlink" title="文件IO"></a>文件IO</h2><h2 id="网络IO"><a href="#网络IO" class="headerlink" title="网络IO"></a>网络IO</h2><h3 id="BIO"><a href="#BIO" class="headerlink" title="BIO"></a>BIO</h3><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BIOSocket</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ServerSocket</span> <span class="hljs-variable">serverSocket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerSocket</span>(<span class="hljs-number">8090</span>);<br>        System.out.println(<span class="hljs-string">&quot;step1: new ServerSocket &quot;</span>);<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-type">Socket</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> serverSocket.accept();<br>            System.out.println(<span class="hljs-string">&quot;step2: client\t&quot;</span> + client.getPort());<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> client.getInputStream();<br>                    <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(in));<br>                    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                        System.out.println(reader.readLine());<br>                    &#125;<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;).start();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SocketClient</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Socket</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>(<span class="hljs-string">&quot;xxx&quot;</span>,<span class="hljs-number">8090</span>);<br><br>            client.setSendBufferSize(<span class="hljs-number">20</span>);<br>            client.setTcpNoDelay(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">OutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> client.getOutputStream();<br><br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> System.in;<br>            <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(in));<br><br>            <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> reader.readLine();<br>                <span class="hljs-keyword">if</span>(line != <span class="hljs-literal">null</span> )&#123;<br>                    <span class="hljs-type">byte</span>[] bb = line.getBytes();<br>                    <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span> b : bb) &#123;<br>                        out.write(b);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>启动时</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 5<br>bind(5, &#123;sa_family=AF_INET, sin_port=htons(8090), sin_addr=inet_addr(&quot;0.0.0.0&quot;)&#125;, 16) = 0<br>listen(5, 50)                           = 0<br>poll([&#123;fd=5, events=POLLIN|POLLERR&#125;], 1, -1) = 1 ([&#123;fd=5, revents=POLLIN&#125;])<br></code></pre></td></tr></table></figure><p>poll函数会阻塞直到其中任何一个fd发生事件。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">accept(5, &#123;sa_family=AF_INET, sin_port=htons(10253), sin_addr=inet_addr(&quot;42.120.74.252&quot;)&#125;, [16]) = 6<br>clone(child_stack=0x7f013e5c4fb0, flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID, parent_tidptr=0x7f013e5c59d0,         tls=0x7f013e5c5700, child_tidptr=0x7f013e5c59d0) = 13168<br>poll([&#123;fd=5, events=POLLIN|POLLERR&#125;], 1, -1<br></code></pre></td></tr></table></figure><p>抛出线程（即我们代码里的 new Thread() ）后，继续poll阻塞等待连接。</p><p><strong>clone出来的线程</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">recvfrom(6, &quot;hello,bio\n&quot;, 8192, 0, NULL, NULL) =<br></code></pre></td></tr></table></figure><p>关于对recvfrom函数的说明，其中第四个参数0 表示这是一个阻塞调用。</p><p><strong>客户端发送数据后</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">recvfrom(6, &quot;hello,bio\n&quot;, 8192, 0, NULL, NULL) = 10<br></code></pre></td></tr></table></figure><h3 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NIOSocket</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> LinkedList&lt; SocketChannel&gt; clients = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br> <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startClientChannelHandleThread</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>                <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocateDirect(<span class="hljs-number">4096</span>);<br> <br>                <span class="hljs-comment">//处理客户端连接</span><br>                <span class="hljs-keyword">for</span> (SocketChannel c : clients) &#123;<br>                    <span class="hljs-comment">// 非阻塞, &gt;0 表示读取到的字节数量, 0或-1表示未读取到或读取异常</span><br>                    <span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        num = c.read(buffer);<br>                    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                        e.printStackTrace();<br>                    &#125;<br> <br>                    <span class="hljs-keyword">if</span> (num &gt; <span class="hljs-number">0</span>) &#123;<br>                        buffer.flip();<br>                        <span class="hljs-type">byte</span>[] clientBytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[buffer.limit()];<br>                        <span class="hljs-comment">//从缓冲区 读取到内存中</span><br>                        buffer.get(clientBytes);<br> <br>                        System.out.println(c.socket().getPort() + <span class="hljs-string">&quot;:&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(clientBytes));<br> <br>                        <span class="hljs-comment">//清空缓冲区</span><br>                        buffer.clear();<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;).start();<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">//new socket,开启监听</span><br>        <span class="hljs-type">ServerSocketChannel</span> <span class="hljs-variable">socketChannel</span> <span class="hljs-operator">=</span> ServerSocketChannel.open();<br>        socketChannel.bind(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(<span class="hljs-number">9090</span>));<br>        <span class="hljs-comment">//设置阻塞接受客户端连接</span><br>        socketChannel.configureBlocking(<span class="hljs-literal">true</span>);<br> <br>        <span class="hljs-comment">//开始client处理线程</span><br>        startClientChannelHandleThread();<br> <br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-comment">//接受客户端连接; 非阻塞，无客户端返回null(操作系统返回-1)</span><br>            <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> socketChannel.accept();<br> <br>            <span class="hljs-keyword">if</span> (client == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">//System.out.println(&quot;no client&quot;);</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//设置读非阻塞</span><br>                client.configureBlocking(<span class="hljs-literal">false</span>);<br> <br>                <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> client.socket().getPort();<br>                System.out.println(<span class="hljs-string">&quot;client port :&quot;</span> + port);<br> <br>                clients.add(client);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>主线程</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 4<br>bind(4, &#123;sa_family=AF_INET, sin_port=htons(9090), sin_addr=inet_addr(&quot;0.0.0.0&quot;)&#125;, 16) = 0<br>listen(4, 50)                           = 0<br>fcntl(4, F_SETFL, O_RDWR|O_NONBLOCK)    = 0<br>accept(4, 0x7fe26414e680, 0x7fe26c376710) = -1 EAGAIN (Resource temporarily unavailable)<br></code></pre></td></tr></table></figure><p><strong>有连接后，子线程</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">read(6, 0x7f3f415b1c50, 4096)           = -1 EAGAIN (Resource temporarily unavailable)<br>read(6, 0x7f3f415b1c50, 4096)           = -1 EAGAIN (Resource temporarily unavailable)<br>...<br></code></pre></td></tr></table></figure><h3 id="多路复用器（select、poll、epoll）"><a href="#多路复用器（select、poll、epoll）" class="headerlink" title="多路复用器（select、poll、epoll）"></a>多路复用器（select、poll、epoll）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiplexingSocket</span> &#123;<br> <br>    <span class="hljs-keyword">static</span> <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocateDirect(<span class="hljs-number">4096</span>);<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br> <br>        LinkedList&lt; SocketChannel&gt; clients = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br> <br>        <span class="hljs-comment">//1.启动server</span><br>        <span class="hljs-comment">//new socket,开启监听</span><br>        <span class="hljs-type">ServerSocketChannel</span> <span class="hljs-variable">socketChannel</span> <span class="hljs-operator">=</span> ServerSocketChannel.open();<br>        socketChannel.bind(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(<span class="hljs-number">9090</span>));<br>        <span class="hljs-comment">//设置非阻塞，接受客户端</span><br>        socketChannel.configureBlocking(<span class="hljs-literal">false</span>);<br> <br>        <span class="hljs-comment">//多路复用器（JDK包装的代理，select /poll/epoll/kqueue）</span><br>        <span class="hljs-type">Selector</span> <span class="hljs-variable">selector</span> <span class="hljs-operator">=</span> Selector.open(); <span class="hljs-comment">//java自动代理，默认为epoll</span><br>        <span class="hljs-comment">//Selector selector = PollSelectorProvider.provider().openSelector();//指定为poll</span><br> <br>        <span class="hljs-comment">//将服务端socket 注册到 多路复用器</span><br>        socketChannel.register(selector, SelectionKey.OP_ACCEPT);<br> <br>        <span class="hljs-comment">//2. 轮训多路复用器</span><br>        <span class="hljs-comment">// 先询问有没有连接,如果有则返回数量以及对应的对象(fd)</span><br>        <span class="hljs-keyword">while</span> (selector.select() &gt; <span class="hljs-number">0</span>) &#123;<br>            System.out.println();<br>            Set&lt; SelectionKey&gt; selectionKeys = selector.selectedKeys();<br>            Iterator&lt; SelectionKey&gt; iter = selectionKeys.iterator();<br> <br>            <span class="hljs-keyword">while</span> (iter.hasNext()) &#123;<br>                <span class="hljs-type">SelectionKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> iter.next();<br>                iter.remove();<br> <br>                <span class="hljs-comment">//2.1 处理新的连接</span><br>                <span class="hljs-keyword">if</span> (key.isAcceptable()) &#123;<br>                    <span class="hljs-comment">//接受客户端连接; 非阻塞，无客户端返回null(操作系统返回-1)</span><br>                    <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> socketChannel.accept();<br>                    <span class="hljs-comment">//设置读非阻塞</span><br>                    client.configureBlocking(<span class="hljs-literal">false</span>);<br> <br>                    <span class="hljs-comment">//同样，把client也注册到selector</span><br>                    client.register(selector, SelectionKey.OP_READ);<br>                    System.out.println(<span class="hljs-string">&quot;new client : &quot;</span> + client.getRemoteAddress());<br>                &#125;<br>                <span class="hljs-comment">//2.2 处理读取数据</span><br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key.isReadable()) &#123;<br>                    readDataFromSocket(key);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br> <br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readDataFromSocket</span><span class="hljs-params">(SelectionKey key)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">socketChannel</span> <span class="hljs-operator">=</span> (SocketChannel) key.channel();<br>        <span class="hljs-comment">// 非阻塞, &gt;0 表示读取到的字节数量, 0或-1表示未读取到或读取异常</span><br>        <span class="hljs-comment">// 请注意：这个例子降低复杂度，不考虑报文大于buffer size的情况</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> socketChannel.read(buffer);<br> <br>        <span class="hljs-keyword">if</span> (num &gt; <span class="hljs-number">0</span>) &#123;<br>            buffer.flip();<br>            <span class="hljs-type">byte</span>[] clientBytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[buffer.limit()];<br>            <span class="hljs-comment">//从缓冲区 读取到内存中</span><br>            buffer.get(clientBytes);<br> <br>            System.out.println(socketChannel.socket().getPort() + <span class="hljs-string">&quot;:&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(clientBytes));<br> <br>            <span class="hljs-comment">//清空缓冲区</span><br>            buffer.clear();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>启动</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 4<br>bind(4, &#123;sa_family=AF_INET, sin_port=htons(9090), sin_addr=inet_addr(&quot;0.0.0.0&quot;)&#125;, 16) = 0<br>listen(4, 50)<br>fcntl(4, F_SETFL, O_RDWR|O_NONBLOCK)    = 0<br>epoll_create(256)                       = 7<br>epoll_ctl(7, EPOLL_CTL_ADD, 5, &#123;EPOLLIN, &#123;u32=5, u64=4324783852322029573&#125;&#125;) = 0<br>epoll_ctl(7, EPOLL_CTL_ADD, 4, &#123;EPOLLIN, &#123;u32=4, u64=158913789956&#125;&#125;) = 0<br>epoll_wait(7<br></code></pre></td></tr></table></figure><p>关于对epoll_create（对应着Java的 Selector selector &#x3D; Selector.open()） 的说明，本质上是在内存的操作系统保留区，创建一个epoll数据结构。用于后面当有client连接时，向该epoll区中添加监听。</p><p><strong>有连接</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">epoll_wait(7,[&#123;EPOLLIN, &#123;u32=4, u64=158913789956&#125;&#125;], 8192, -1) = 1<br>accept(4, &#123;sa_family=AF_INET, sin_port=htons(29597), sin_addr=inet_addr(&quot;42.120.74.252&quot;)&#125;, [16]) = 8<br>fcntl(8, F_SETFL, O_RDWR|O_NONBLOCK)    = 0<br>epoll_ctl(7, EPOLL_CTL_ADD, 8, &#123;EPOLLIN, &#123;u32=8, u64=3212844375897800712&#125;&#125;) = 0<br></code></pre></td></tr></table></figure><p>关于epoll_ctl （对应着Java的 client.register(selector, SelectionKey.OP_READ) ）。其中 EPOLLIN 恰好对应着Java的 SelectionKey.OP_READ 即监听数据到达读取事件。</p><p><strong>客户端发送数据</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">epoll_wait(7,[&#123;EPOLLIN, &#123;u32=8, u64=3212844375897800712&#125;&#125;], 8192, -1) = 1<br>read(8, &quot;hello,multiplex\n&quot;, 4096)      = 16<br>epoll_wait(7,<br></code></pre></td></tr></table></figure><p>epoll_wait第四个参数-1表示block。</p><h3 id="netty"><a href="#netty" class="headerlink" title="netty"></a>netty</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TelnetServer</span> &#123;<br> <br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">SSL</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;ssl&quot;</span>) != <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PORT</span> <span class="hljs-operator">=</span> Integer.parseInt(System.getProperty(<span class="hljs-string">&quot;port&quot;</span>, SSL? <span class="hljs-string">&quot;8992&quot;</span> : <span class="hljs-string">&quot;8023&quot;</span>));<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// Configure SSL.</span><br>        <span class="hljs-keyword">final</span> SslContext sslCtx;<br>        <span class="hljs-keyword">if</span> (SSL) &#123;<br>            <span class="hljs-type">SelfSignedCertificate</span> <span class="hljs-variable">ssc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SelfSignedCertificate</span>();<br>            sslCtx = SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey()).build();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            sslCtx = <span class="hljs-literal">null</span>;<br>        &#125;<br> <br>        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workerGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();<br>            b.group(bossGroup, workerGroup)<br>             .channel(NioServerSocketChannel.class)<br>             .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoggingHandler</span>(LogLevel.INFO))<br>             .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TelnetServerInitializer</span>(sslCtx));<br> <br>            b.bind(PORT).sync().channel().closeFuture().sync();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            bossGroup.shutdownGracefully();<br>            workerGroup.shutdownGracefully();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Sharable</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TelnetServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt; String&gt; &#123;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// Send greeting for a new connection.</span><br>        ctx.write(<span class="hljs-string">&quot;Welcome to &quot;</span> + InetAddress.getLocalHost().getHostName() + <span class="hljs-string">&quot;!\r\n&quot;</span>);<br>        ctx.write(<span class="hljs-string">&quot;It is &quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>() + <span class="hljs-string">&quot; now.\r\n&quot;</span>);<br>        ctx.flush();<br>    &#125;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, String request)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// Generate and write a response.</span><br>        String response;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">close</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span> (request.isEmpty()) &#123;<br>            response = <span class="hljs-string">&quot;Please type something.\r\n&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;bye&quot;</span>.equals(request.toLowerCase())) &#123;<br>            response = <span class="hljs-string">&quot;Have a good day!\r\n&quot;</span>;<br>            close = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            response = <span class="hljs-string">&quot;Did you say &#x27;&quot;</span> + request + <span class="hljs-string">&quot;&#x27;?\r\n&quot;</span>;<br>        &#125;<br> <br>        <span class="hljs-comment">// We do not need to write a ChannelBuffer here.</span><br>        <span class="hljs-comment">// We know the encoder inserted at TelnetPipelineFactory will do the conversion.</span><br>        <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">future</span> <span class="hljs-operator">=</span> ctx.write(response);<br> <br>        <span class="hljs-comment">// Close the connection after sending &#x27;Have a good day!&#x27;</span><br>        <span class="hljs-comment">// if the client has sent &#x27;bye&#x27;.</span><br>        <span class="hljs-keyword">if</span> (close) &#123;<br>            future.addListener(ChannelFutureListener.CLOSE);<br>        &#125;<br>    &#125;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelReadComplete</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> &#123;<br>        ctx.flush();<br>    &#125;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> &#123;<br>        cause.printStackTrace();<br>        ctx.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TelnetServerInitializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInitializer</span>&lt; SocketChannel&gt; &#123;<br> <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StringDecoder</span> <span class="hljs-variable">DECODER</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringDecoder</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StringEncoder</span> <span class="hljs-variable">ENCODER</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEncoder</span>();<br> <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">TelnetServerHandler</span> <span class="hljs-variable">SERVER_HANDLER</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TelnetServerHandler</span>();<br> <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SslContext sslCtx;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TelnetServerInitializer</span><span class="hljs-params">(SslContext sslCtx)</span> &#123;<br>        <span class="hljs-built_in">this</span>.sslCtx = sslCtx;<br>    &#125;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> ch.pipeline();<br> <br>        <span class="hljs-keyword">if</span> (sslCtx != <span class="hljs-literal">null</span>) &#123;<br>            pipeline.addLast(sslCtx.newHandler(ch.alloc()));<br>        &#125;<br> <br>        <span class="hljs-comment">// Add the text line codec combination first,</span><br>        pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DelimiterBasedFrameDecoder</span>(<span class="hljs-number">8192</span>, Delimiters.lineDelimiter()));<br>        <span class="hljs-comment">// the encoder and decoder are static as these are sharable</span><br>        pipeline.addLast(DECODER);<br>        pipeline.addLast(ENCODER);<br> <br>        <span class="hljs-comment">// and then business logic.</span><br>        pipeline.addLast(SERVER_HANDLER);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>主线程(23109)</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs text">## 256无实际作用，这里只为了兼容旧版kernel api<br>epoll_create(256)                       = 7epoll_ctl(7, EPOLL_CTL_ADD, 5, &#123;EPOLLIN, &#123;u32=5, u64=5477705356928876549&#125;&#125;) = 0<br> <br>epoll_create(256)                       = 10epoll_ctl(10, EPOLL_CTL_ADD, 8, &#123;EPOLLIN, &#123;u32=8, u64=17041805914081853448&#125;&#125;) = 0<br> <br>epoll_create(256)                       = 13<br>epoll_ctl(13, EPOLL_CTL_ADD, 11, &#123;EPOLLIN, &#123;u32=11, u64=17042151607409573899&#125;&#125;) = 0<br> <br>epoll_create(256)                       = 16<br>epoll_ctl(16, EPOLL_CTL_ADD, 14, &#123;EPOLLIN, &#123;u32=14, u64=17042497300737294350&#125;&#125;) = 0<br> <br>epoll_create(256)                       = 19<br>epoll_ctl(19, EPOLL_CTL_ADD, 17, &#123;EPOLLIN, &#123;u32=17, u64=17042561450368827409&#125;&#125;) = 0<br> <br>epoll_create(256)                       = 10<br>socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 20<br>clone(child_stack=0x7fc3c509afb0, flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID, parent_tidptr=0x7fc3c509b9d0, tls=0x7fc3c509b700, child_tidptr=0x7fc3c509b9d0) = 23130<br></code></pre></td></tr></table></figure><p>概括为：</p><p>向OS新建socket，并开启clone boss线程23130。<br>为BOSS创建了一个epoll（论证参见下面“boss”），每个worker创建一个epoll数据结构（本质上是在kernel内存区创建了一个数据结构，用于后续监听）。<br>创建boss线程监听的socket（本质上在kernel中创建一个数据结构）。</p><p><strong>boss（23130）</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">bind(20, &#123;sa_family=AF_INET, sin_port=htons(8023), sin_addr=inet_addr(&quot;0.0.0.0&quot;)&#125;, 16) = 0<br>listen(20, 128)                         = 0<br>getsockname(20, &#123;sa_family=AF_INET, sin_port=htons(8023), sin_addr=inet_addr(&quot;0.0.0.0&quot;)&#125;, [16]) = 0<br>getsockname(20, &#123;sa_family=AF_INET, sin_port=htons(8023), sin_addr=inet_addr(&quot;0.0.0.0&quot;)&#125;, [16]) = 0 <br> <br>##将fd为7号epoll和fd为20号的socket绑定，事件：epoll_ctl_add和epoll_ctl_mod<br>epoll_ctl(7, EPOLL_CTL_ADD, 20, &#123;EPOLLIN, &#123;u32=20, u64=14198059139132817428&#125;&#125;) = 0<br>epoll_ctl(7, EPOLL_CTL_MOD, 20, &#123;EPOLLIN, &#123;u32=20, u64=20&#125;&#125;) = 0<br>epoll_wait(7, [&#123;EPOLLIN, &#123;u32=5, u64=17295150779149058053&#125;&#125;], 8192, 1000) = 1<br>epoll_wait(7, [], 8192, 1000)           = 0(不断轮训，1S超时一次)<br></code></pre></td></tr></table></figure><p>概括为：</p><p>将上一步中main线程创建的fd：20绑定端口8023，并开启监听（网卡负责监听和接受连接和数据，kernel则负责路由到具体进程，具体参见：关于socket和bind和listen，TODO ）。<br>将7号socket对应的fd绑定到20号对应的epoll数据结构上去（都是操作kernel中的内存）。<br>开始1S中一次阻塞等待epoll有任何连接或数据到达。</p><p><strong>客户端连接</strong></p><p><strong>boss (23130)</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">accept(20, &#123;sa_family=AF_INET, sin_port=htons(11144), sin_addr=inet_addr(&quot;42.120.74.122&quot;)&#125;, [16]) = 24<br>getsockname(24, &#123;sa_family=AF_INET, sin_port=htons(8023), sin_addr=inet_addr(&quot;192.168.0.120&quot;)&#125;, [16]) = 0<br>getsockname(24, &#123;sa_family=AF_INET, sin_port=htons(8023), sin_addr=inet_addr(&quot;192.168.0.120&quot;)&#125;, [16]) = 0<br>setsockopt(24, SOL_TCP, TCP_NODELAY, [1], 4) = 0<br>getsockopt(24, SOL_SOCKET, SO_SNDBUF, [87040], [4]) = 0<br>getsockopt(24, SOL_SOCKET, SO_SNDBUF, [87040], [4]) = 0<br>##抛出 work线程<br>clone(child_stack=0x7fc3c4c98fb0, flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID, parent_tidptr=0x7fc3c4c999d0, tls=0x7fc3c4c99700, child_tidptr=0x7fc3c4c999d0) = 2301<br></code></pre></td></tr></table></figure><p><strong>worker (2301)</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">writev(24, [&#123;&quot;Welcome to iZbp14e1g9ztpshfrla9m&quot;..., 37&#125;, &#123;&quot;It is Sun Aug 23 15:44:14 CST 20&quot;..., 41&#125;], 2) = 78<br>epoll_ctl(13, EPOLL_CTL_ADD, 24, &#123;EPOLLIN, &#123;u32=24, u64=24&#125;&#125;) = 0<br>epoll_ctl(13, EPOLL_CTL_MOD, 24, &#123;EPOLLIN, &#123;u32=24, u64=14180008216221450264&#125;&#125;) = 0<br>epoll_wait(13, [&#123;EPOLLIN, &#123;u32=11, u64=17042151607409573899&#125;&#125;], 8192, 1000) = 1 <br>read(11, &quot;\1&quot;, 128)                     = 1<br>##开始无限loop<br>epoll_wait(13, [], 8192, 1000)          = 0<br>epoll_wait(13, [&#123;EPOLLIN, &#123;u32=24, u64=24&#125;&#125;], 8192, 1000) = 1<br></code></pre></td></tr></table></figure><p>概括：</p><p>当BOSS轮训epoll_wait等到了连接后，首先accept得到该socket对应的fd。<br>连接建立后 BOSS立马抛出一个线程（clone函数）。<br>worker（即新建的线程）写入了一段数据（这里是业务逻辑）。<br>worker将该client对应的fd绑定到了13号epoll上。<br>worker继续轮训监听13号epoll。</p><p><strong>客户端主动发送数据</strong></p><p><strong>worker（2301）</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">read(24, &quot;i am daojian\r\n&quot;, 1024)      = 14<br>write(24, &quot;Did you say &#x27;i am daojian&#x27;?\r\n&quot;, 29) = 29<br>##继续无限loop<br>epoll_wait(13, [], 8192, 1000)          = 0<br></code></pre></td></tr></table></figure><p>概括为：</p><ul><li>wait到数据后，立即read到用户控件内存中（读取1024个字节到 用户控件某个buff中）。</li><li>写入数据（业务逻辑，不必太关注）。</li><li>继续轮训等待13号epoll。</li></ul><p><strong>客户端发送bye报文，服务器断开TCP连接</strong></p><p><strong>worker（2301）</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">read(24, &quot;bye\r\n&quot;, 1024)               = 5<br>write(24, &quot;Have a good day!\r\n&quot;, 18)   = 18<br>getsockopt(24, SOL_SOCKET, SO_LINGER, &#123;onoff=0, linger=0&#125;, [8]) = 0<br>dup2(25, 24)                            = 24<br>##从epoll数据结构中（OS）中删除fd为24的socket<br>epoll_ctl(13, EPOLL_CTL_DEL, 24, 0x7f702dd531e0) = -1 ENOENT<br>##关闭24 socket<br>close(24)                               = 0<br>##继续等待13 epoll数据<br>epoll_wait(13, [], 8192, 1000)          = 0<br></code></pre></td></tr></table></figure><p>断开客户端连接概括为：</p><ul><li>从epoll中删除该客户端对应的fd（这里触发源头没找到，可能是boss）。</li><li>close关闭客户端24号fd。</li><li>继续轮训epoll。</li></ul><p><strong>五个客户端同时连接</strong></p><p><strong>boss线程（23130）</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">accept(20, &#123;sa_family=AF_INET, sin_port=htons(1846), sin_addr=inet_addr(&quot;42.120.74.122&quot;)&#125;, [16]) = 24<br>clone(child_stack=0x7f702cc51fb0, flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID, parent_tidptr=0x7f702cc529d0, tls=0x7f702cc52700, child_tidptr=0x7f702cc529d0) = 10035<br> <br>accept(20, &#123;sa_family=AF_INET, sin_port=htons(42067), sin_addr=inet_addr(&quot;42.120.74.122&quot;)&#125;, [16]) = 26<br>clone(child_stack=0x7f702cb50fb0, flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID, parent_tidptr=0x7f702cb519d0, tls=0x7f702cb51700, child_tidptr=0x7f702cb519d0) = 10067<br> <br>...<br></code></pre></td></tr></table></figure><p><strong>woker线程（10035，第一个连接）</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">epoll_ctl(13, EPOLL_CTL_ADD, 24, &#123;EPOLLIN, &#123;u32=24, u64=24&#125;&#125;) = 0<br>epoll_ctl(13, EPOLL_CTL_MOD, 24, &#123;EPOLLIN, &#123;u32=24, u64=3226004877247250456&#125;&#125;) = 0<br>epoll_wait(13, [&#123;EPOLLIN, &#123;u32=11, u64=17042151607409573899&#125;&#125;], 8192, 1000) = 1                  = 1<br>epoll_wait(13, [], 8192, 1000)          = 0<br></code></pre></td></tr></table></figure><p><strong>worker线程（10067，第二个连接）</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">epoll_ctl(16, EPOLL_CTL_ADD, 26, &#123;EPOLLIN, &#123;u32=26, u64=26&#125;&#125;) = 0<br>epoll_ctl(16, EPOLL_CTL_MOD, 26, &#123;EPOLLIN, &#123;u32=26, u64=3221483685433835546&#125;&#125;) = 0<br>epoll_wait(16, [&#123;EPOLLIN, &#123;u32=14, u64=17042497300737294350&#125;&#125;], 8192, 1000) = 1<br>epoll_wait(16, [], 8192, 1000)          = 0<br>epoll_wait(16, [], 8192, 1000)          = 0<br></code></pre></td></tr></table></figure><p><strong>worker线程（10067，第二个连接）</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">epoll_ctl(19, EPOLL_CTL_ADD, 27, &#123;EPOLLIN, &#123;u32=27, u64=27&#125;&#125;) = 0<br>epoll_ctl(19, EPOLL_CTL_MOD, 27, &#123;EPOLLIN, &#123;u32=27, u64=3216966479350071323&#125;&#125;) = 0<br></code></pre></td></tr></table></figure><p><strong>worker线程(8055，第四个连接)</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">epoll_ctl(10, EPOLL_CTL_ADD, 28, &#123;EPOLLIN, &#123;u32=28, u64=28&#125;&#125;) = 0<br>epoll_ctl(10, EPOLL_CTL_MOD, 28, &#123;EPOLLIN, &#123;u32=28, u64=3302604828697427996&#125;&#125;) = 0<br></code></pre></td></tr></table></figure><p><strong>worker线程（10035，第五个连接，不在clone线程，而是复用了第一个epoll对应的worker）</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">epoll_ctl(13, EPOLL_CTL_ADD, 29, &#123;EPOLLIN, &#123;u32=29, u64=29&#125;&#125;) = 0<br>epoll_ctl(13, EPOLL_CTL_MOD, 29, &#123;EPOLLIN, &#123;u32=29, u64=29&#125;&#125;) = 0<br></code></pre></td></tr></table></figure><p>概括为：</p><ul><li>epoll和boss、worker之间的关系：一共有4个worker对应着4个epoll对象，boss和每个worker都有对应自己的epoll。</li><li>boss根据epoll数量，平衡分配连接到每个worker对应的epoll中。</li></ul>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java集合</title>
    <link href="/2022/07/11/java/java%E9%9B%86%E5%90%88/"/>
    <url>/2022/07/11/java/java%E9%9B%86%E5%90%88/</url>
    
    <content type="html"><![CDATA[<h1 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h1><p>集合类存放于 Java.util 包中，主要有 3 种：set(集）、list(列表包含 Queue）和 map(映射)。</p><ol><li>Collection：Collection 是集合 List、Set、Queue 的最基本的接口。 </li><li>Iterator：迭代器，可以通过迭代器遍历集合中的数据</li><li>Map：是映射表的基础接口</li></ol><h1 id="list"><a href="#list" class="headerlink" title="list"></a>list</h1><h2 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h2><p>排列有序，可重复</p><p>底层使用数组</p><p>查询速度快，增删慢，getter()和setter()方法快</p><p>线程不安全</p><p>当容量不够时，ArrayList是当前容量 * 1.5 + 1</p><h2 id="Vector"><a href="#Vector" class="headerlink" title="Vector"></a>Vector</h2><p>排列有序，可重复</p><p>底层使用数组</p><p>查询速度快，增删慢</p><p>线程安全，效率低</p><p>当容量不够时，Vector默认扩展一倍容量</p><h2 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList"></a>LinkedList</h2><p>排列有序，可重复</p><p>底层使用双向循环链表数据结构</p><p>查询速度慢，增删快，add() 和 remove()方法快</p><p>线程不安全</p><h1 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h1><h2 id="HashSet"><a href="#HashSet" class="headerlink" title="HashSet"></a>HashSet</h2><p>排序无序，不可重复</p><p>底层使用Hash表实现</p><p>存取速度快</p><p>内部是HashMap</p><h2 id="TreeSet"><a href="#TreeSet" class="headerlink" title="TreeSet"></a>TreeSet</h2><p>排序无序，不可重复</p><p>底层使用二叉树实现</p><p>排序存储</p><p>内部是TreeMap的SortedSet</p><h2 id="LinkedHashSet"><a href="#LinkedHashSet" class="headerlink" title="LinkedHashSet"></a>LinkedHashSet</h2><p>采用hash表存储，并用双向链表记录插入顺序</p><p>内部是LinkedHashMap</p><h1 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h1><p>在两端出入的List,所以也可以用数组或链表来实现</p><h1 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h1><h2 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h2><p>键不可重复，值可重复</p><p>底层哈希表</p><p>线程不安全</p><p>允许Key值为null,value也可以为null</p><h2 id="HashTable"><a href="#HashTable" class="headerlink" title="HashTable"></a>HashTable</h2><p>键不可重复，值可重复</p><p>底层哈希表</p><p>线程安全</p><p>Key、value都不允许为null</p><h2 id="TreeMap"><a href="#TreeMap" class="headerlink" title="TreeMap"></a>TreeMap</h2><p>键不可重复，值可重复</p><p>底层二叉树</p><h1 id="HashMap源码分析"><a href="#HashMap源码分析" class="headerlink" title="HashMap源码分析"></a>HashMap源码分析</h1><p>Jdk 7  使用头插法    数据结构使用 数组  + 链表</p><p>Jdk 8 使用尾插法数据结构使用 数组 + 链表 + 红黑树</p><figure class="highlight text"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><pre><code class="hljs text">1. initialCapacity：当前数组容量，始终保持 2^n，可以扩容，扩容后数组大小为当前的 2 倍。 <br>2. loadFactor：负载因子，默认为 0.75。 <br>3. threshold：扩容的阈值，等于 capacity * loadFactor <br></code></pre></td></tr></table></figure><h2 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">HashMap</span><span class="hljs-params">(<span class="hljs-type">int</span> initialCapacity, <span class="hljs-type">float</span> loadFactor)</span> &#123;<br>    <span class="hljs-keyword">if</span> (initialCapacity &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Illegal initial capacity: &quot;</span> +<br>                                           initialCapacity);<br>    <span class="hljs-keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)<br>        initialCapacity = MAXIMUM_CAPACITY;<br>    <span class="hljs-keyword">if</span> (loadFactor &lt;= <span class="hljs-number">0</span> || Float.isNaN(loadFactor))<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Illegal load factor: &quot;</span> +<br>                                           loadFactor);<br>    <span class="hljs-built_in">this</span>.loadFactor = loadFactor;<br>    <span class="hljs-built_in">this</span>.threshold = tableSizeFor(initialCapacity);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tableSizeFor</span><span class="hljs-params">(<span class="hljs-type">int</span> cap)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> cap - <span class="hljs-number">1</span>;<br>    n |= n &gt;&gt;&gt; <span class="hljs-number">1</span>;<br>    n |= n &gt;&gt;&gt; <span class="hljs-number">2</span>;<br>    n |= n &gt;&gt;&gt; <span class="hljs-number">4</span>;<br>    n |= n &gt;&gt;&gt; <span class="hljs-number">8</span>;<br>    n |= n &gt;&gt;&gt; <span class="hljs-number">16</span>;<br>    <span class="hljs-keyword">return</span> (n &lt; <span class="hljs-number">0</span>) ? <span class="hljs-number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>把tableSizeFor 复制到你的类中，执行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tableSizeFor</span><span class="hljs-params">(<span class="hljs-type">int</span> cap)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">MAXIMUM_CAPACITY</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">30</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> cap - <span class="hljs-number">1</span>;<br>    n |= n &gt;&gt;&gt; <span class="hljs-number">1</span>;<br>    n |= n &gt;&gt;&gt; <span class="hljs-number">2</span>;<br>    n |= n &gt;&gt;&gt; <span class="hljs-number">4</span>;<br>    n |= n &gt;&gt;&gt; <span class="hljs-number">8</span>;<br>    n |= n &gt;&gt;&gt; <span class="hljs-number">16</span>;<br>    <span class="hljs-keyword">return</span> (n &lt; <span class="hljs-number">0</span>) ? <span class="hljs-number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>发现这个方法会返回 1  2  4 8 16 32，结合注释，输入一个数，返回一个能包含输入数的2次方的一个数。</p><p>int 32位4个字节</p><p><strong>&gt;&gt;&gt;右移</strong></p><p>最高位无论是0还是1都补0，空位补0</p><p><strong>|按位或</strong></p><p>两个位置上任一位置上是1，结果就是1，两个位置上都是0，结果才是0</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 走  n&lt;0</span><br>System.out.println(tableSizeFor(<span class="hljs-number">0</span>));<br><span class="hljs-comment">// 走 n + 1</span><br>System.out.println(tableSizeFor(<span class="hljs-number">1</span>));<br><span class="hljs-comment">// 走 MAXIMUM_CAPACITY</span><br>System.out.println(tableSizeFor(<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">30</span>));<br><span class="hljs-comment">// 走 MAXIMUM_CAPACITY</span><br>System.out.println(tableSizeFor(Integer.MAX_VALUE));<br></code></pre></td></tr></table></figure><p>输入一个非2的次方的数，如33</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> cap - <span class="hljs-number">1</span>;<br><span class="hljs-comment">// n &gt;&gt;&gt; 1 0010 0000----&gt; 0001 0000  16   </span><br><span class="hljs-comment">// n =  32 | 16   0010 0000  ----&gt; 0011 0000  48</span><br>n |= n &gt;&gt;&gt; <span class="hljs-number">1</span>;<br><span class="hljs-comment">// n &gt;&gt;&gt; 2 0011 0000 ----&gt; 0000 1100  12   </span><br><span class="hljs-comment">// n =  48 | 12   0011 0000  ----&gt; 0011 1100  60</span><br>n |= n &gt;&gt;&gt; <span class="hljs-number">2</span>;<br>n |= n &gt;&gt;&gt; <span class="hljs-number">4</span>;<br>n |= n &gt;&gt;&gt; <span class="hljs-number">8</span>;<br>n |= n &gt;&gt;&gt; <span class="hljs-number">16</span>;<br><br>&gt;&gt;&gt; 取高位的值 补 低位  如果 高位值没有了就为<span class="hljs-number">0</span>了<br>| 是增大数<br>  <br><span class="hljs-number">0000</span> <span class="hljs-number">0000</span><span class="hljs-number">0</span><br><span class="hljs-number">0000</span> <span class="hljs-number">0001</span><span class="hljs-number">1</span><br><span class="hljs-number">0000</span> <span class="hljs-number">0011</span><span class="hljs-number">3</span><br><span class="hljs-number">0000</span> <span class="hljs-number">0111</span><span class="hljs-number">7</span><br><span class="hljs-number">0000</span> <span class="hljs-number">1111</span><span class="hljs-number">15</span><br><span class="hljs-number">0001</span> <span class="hljs-number">1111</span><span class="hljs-number">31</span><br><span class="hljs-number">0011</span> <span class="hljs-number">1111</span>   <span class="hljs-number">63</span><br><span class="hljs-number">0111</span> <span class="hljs-number">1111</span><span class="hljs-number">127</span><br></code></pre></td></tr></table></figure><h2 id="PUT方法"><a href="#PUT方法" class="headerlink" title="PUT方法"></a>PUT方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> &#123;<br>    <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-type">int</span> h;<br>    <span class="hljs-keyword">return</span> (key == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>^按位异或</strong></p><p>两个位置上值相同，结果就是0，两个位置上值不相同，结果才是1</p><p>当key &#x3D;&#x3D; null 时  hash值为0；</p><p>当key不为空时，hash值为 对象的hashcode 异或  对象的hashcode的高16位。</p><h3 id="hashMap的存储"><a href="#hashMap的存储" class="headerlink" title="hashMap的存储"></a>hashMap的存储</h3><p>节点定义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>.Entry&lt;K,V&gt; &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> hash;<br>    <span class="hljs-keyword">final</span> K key;<br>    V value;<br>    Node&lt;K,V&gt; next;<br>&#125;<br></code></pre></td></tr></table></figure><p>数组</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">transient</span> Node&lt;K,V&gt;[] table;<br></code></pre></td></tr></table></figure><p>节点定义中Node&lt;K,V&gt; next;表示为单向链表。</p><p>put方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java">onlyIfAbsent 不存在时设置value<br><br><span class="hljs-keyword">final</span> V <span class="hljs-title function_">putVal</span><span class="hljs-params">(<span class="hljs-type">int</span> hash, K key, V value, <span class="hljs-type">boolean</span> onlyIfAbsent,</span><br><span class="hljs-params">                   <span class="hljs-type">boolean</span> evict)</span> &#123;<br>        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="hljs-type">int</span> n, i;<br>        <span class="hljs-keyword">if</span> ((tab = table) == <span class="hljs-literal">null</span> || (n = tab.length) == <span class="hljs-number">0</span>)<br>          <span class="hljs-comment">// 如果数组为空，调用扩容方法。</span><br>            n = (tab = resize()).length;<br>  <span class="hljs-comment">// 存储数组位置 由（数组长度-1）&amp; hash(key)的值</span><br>        <span class="hljs-keyword">if</span> ((p = tab[i = (n - <span class="hljs-number">1</span>) &amp; hash]) == <span class="hljs-literal">null</span>)<br>          <span class="hljs-comment">// 如果数组位置上是空才放上</span><br>            tab[i] = newNode(hash, key, value, <span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// 如果数组位置上不为空</span><br>            Node&lt;K,V&gt; e; K k;<br>          <span class="hljs-comment">// 这一行就是对象为什么要重写hashCode()和equals()方法</span><br>            <span class="hljs-keyword">if</span> (p.hash == hash &amp;&amp;<br>                ((k = p.key) == key || (key != <span class="hljs-literal">null</span> &amp;&amp; key.equals(k))))<br>                e = p;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (p <span class="hljs-keyword">instanceof</span> TreeNode)<br>              <span class="hljs-comment">// 如果数组索引位置上的节点为树节点，按照树的方式插入</span><br>                e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="hljs-built_in">this</span>, tab, hash, key, value);<br>            <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">binCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; ; ++binCount) &#123;<br>                    <span class="hljs-keyword">if</span> ((e = p.next) == <span class="hljs-literal">null</span>) &#123;<br>                      <span class="hljs-comment">// 如果数组索引位置上的节点的next为空，插入链表节点</span><br>                        p.next = newNode(hash, key, value, <span class="hljs-literal">null</span>);<br>                      <span class="hljs-comment">// TREEIFY_THRESHOLD 树形阈值 默认 8   就是链表长度等于8时 转为红黑树插入。</span><br>                        <span class="hljs-keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="hljs-number">1</span>) <span class="hljs-comment">// -1 for 1st</span><br>                          <span class="hljs-comment">// 扩容(扩容后hash有可能就不一样了)  或  转成红黑树</span><br>                            treeifyBin(tab, hash);<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                  <span class="hljs-comment">// 找到已经存在的节点</span><br>                    <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp;<br>                        ((k = e.key) == key || (key != <span class="hljs-literal">null</span> &amp;&amp; key.equals(k))))<br>                        <span class="hljs-keyword">break</span>;<br>                    p = e;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">// existing mapping for key</span><br>              <span class="hljs-comment">// 存在映射修改</span><br>                <span class="hljs-type">V</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> e.value;<br>                <span class="hljs-keyword">if</span> (!onlyIfAbsent || oldValue == <span class="hljs-literal">null</span>)<br>                    e.value = value;<br>                afterNodeAccess(e);<br>                <span class="hljs-keyword">return</span> oldValue;<br>            &#125;<br>        &#125;<br>        ++modCount;<br>  <span class="hljs-comment">// 如果容量大于阈值，扩容</span><br>        <span class="hljs-keyword">if</span> (++size &gt; threshold)<br>            resize();<br>        afterNodeInsertion(evict);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p><strong>&amp; 按位与</strong></p><p>两个位置上任一位置上是0，结果就是0，两个位置上都是1，结果才是1</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">红黑树的<span class="hljs-type">put</span><br><span class="hljs-variable">e</span> <span class="hljs-operator">=</span> ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="hljs-built_in">this</span>, tab, hash, key, value);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">treeifyBin</span><span class="hljs-params">(Node&lt;K,V&gt;[] tab, <span class="hljs-type">int</span> hash)</span> &#123;<br>    <span class="hljs-type">int</span> n, index; Node&lt;K,V&gt; e;<br>  <span class="hljs-comment">// 树化的最小表容量  64</span><br>    <span class="hljs-keyword">if</span> (tab == <span class="hljs-literal">null</span> || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY)<br>        resize();<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((e = tab[index = (n - <span class="hljs-number">1</span>) &amp; hash]) != <span class="hljs-literal">null</span>) &#123;<br>        TreeNode&lt;K,V&gt; hd = <span class="hljs-literal">null</span>, tl = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>          <span class="hljs-comment">// 把链表节点转为 树节点</span><br>            TreeNode&lt;K,V&gt; p = replacementTreeNode(e, <span class="hljs-literal">null</span>);<br>            <span class="hljs-keyword">if</span> (tl == <span class="hljs-literal">null</span>)<br>                hd = p;<br>            <span class="hljs-keyword">else</span> &#123;<br>                p.prev = tl;<br>                tl.next = p;<br>            &#125;<br>            tl = p;<br>          <span class="hljs-comment">// 循环转换</span><br>        &#125; <span class="hljs-keyword">while</span> ((e = e.next) != <span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">if</span> ((tab[index] = hd) != <span class="hljs-literal">null</span>)<br>            hd.treeify(tab);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="头插和尾插："><a href="#头插和尾插：" class="headerlink" title="头插和尾插："></a>头插和尾插：</h3><p>hashmap是线程非安全的，jdk1.7多线程情况下，会出现get()方法死循环，是因为扩容时会调整节点的位置，以前是数组的元素，现在变成链表中的一个元素，节点A与节点B,以前AB都是数组索引位置上，A的下一个节点指向B,别一个线程进行扩容后，B经过哈希函数算出位置在A之后，这时A的下一个节点指向B,B的下一个节点是A,这时就造成了死循环。</p><h3 id="jdk1-7与1-8中hashmap的区别"><a href="#jdk1-7与1-8中hashmap的区别" class="headerlink" title="jdk1.7与1.8中hashmap的区别"></a>jdk1.7与1.8中hashmap的区别</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">1. 最重要的一点是底层结构不一样，1.7是数组+链表，1.8则是数组+链表+红黑树结构;<br>2. jdk1.7中当哈希表为空时，会先调用inflateTable()初始化一个数组；而1.8则是直接调用resize()扩容;<br>3. 插入键值对的put方法的区别，1.8中会将节点插入到链表尾部，而1.7中是采用头插；<br>4. jdk1.7中的hash函数对哈希值的计算直接使用key的hashCode值，而1.8中则是采用key的hashCode异或上key的hashCode进行无符号右移16位的结果，避免了只靠低位数据来计算哈希时导致的冲突，计算结果由高低位结合决定，使元素分布更均匀；<br>5. 扩容时1.8会保持原链表的顺序，而1.7会颠倒链表的顺序；而且1.8是在元素插入后检测是否需要扩容，1.7则是在元素插入前；<br>6. jdk1.8是扩容时通过hash&amp;cap==0将链表分散，无需改变hash值，而1.7是通过更新hashSeed来修改hash值达到分散的目的；<br>7. 扩容策略：1.7中是只要不小于阈值就直接扩容2倍；而1.8的扩容策略会更优化，当数组容量未达到64时，以2倍进行扩容，超过64之后若桶中元素个数不小于7就将链表转换为红黑树，但如果红黑树中的元素个数小于6就会还原为链表，当红黑树中元素不小于32的时候才会再次扩容。<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>获取hash值：</p><p>​当key &#x3D;&#x3D; null 时  hash值为0；</p><p>​当key不为空时，hash值为 对象的hashcode 异或  对象的hashcode的高16位。</p><p>如果数组为空，调用扩容方法初始化。</p><p>算出存储数组位置 由（数组长度-1）&amp; hash值</p><p>如果数组位置上是空才放上</p><p>如果数组位置上不为空</p><p>​数组上的节点就是要修改的节点，走后续的修改</p><p>​如果数组上的节点是树节点，走树的查找或插入或修改</p><p>​如果不是树节点，就循环，到最后一个节点插入</p><p>​如果循环次数超过8位，走树化，如果数组容量不足64，走扩容，如果满足则把链表转为红黑树</p><p>如果是修改节点的value，则修改并返回。</p><p>如果容量大于阈值则扩容。</p><h2 id="扩容-resize-方法"><a href="#扩容-resize-方法" class="headerlink" title="扩容(resize)方法"></a>扩容(resize)方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;<br>        Node&lt;K,V&gt;[] oldTab = table;<br>  <span class="hljs-comment">// 老的容量</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">oldCap</span> <span class="hljs-operator">=</span> (oldTab == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : oldTab.length;<br>  <span class="hljs-comment">// 老的扩容阈值</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">oldThr</span> <span class="hljs-operator">=</span> threshold;<br>        <span class="hljs-type">int</span> newCap, newThr = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (oldCap &gt; <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-comment">// 当老的容量大于  1 &gt;&gt; 30 时  </span><br>            <span class="hljs-keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;<br>              <span class="hljs-comment">// 扩容阈值  =  int最大值  结束扩容</span><br>                threshold = Integer.MAX_VALUE;<br>                <span class="hljs-keyword">return</span> oldTab;<br>            &#125;  <span class="hljs-comment">// 当老的容量扩容 2 倍  小于  最大容量，并且 老的容量 大于 默认容量时 </span><br>          <span class="hljs-comment">// newCap = oldCap &lt;&lt; 1  这个是个赋值操作，把新的容量扩容2倍</span><br>          <span class="hljs-comment">// 扩容阈值扩容2倍</span><br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="hljs-number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;<br>                     oldCap &gt;= DEFAULT_INITIAL_CAPACITY)<br>                newThr = oldThr &lt;&lt; <span class="hljs-number">1</span>; <span class="hljs-comment">// double threshold</span><br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldThr &gt; <span class="hljs-number">0</span>) <span class="hljs-comment">// initial capacity was placed in threshold</span><br>          <span class="hljs-comment">// 当扩容阈值大于0  新的容量 = 老的扩容阈值</span><br>            newCap = oldThr;<br>        <span class="hljs-keyword">else</span> &#123;               <span class="hljs-comment">// zero initial threshold signifies using defaults</span><br>          <span class="hljs-comment">// 0 容量 或 0扩容阈值  时使用默认值 初始化 16  0.75 * 16</span><br>            newCap = DEFAULT_INITIAL_CAPACITY;<br>            newThr = (<span class="hljs-type">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);<br>        &#125;<br>  <span class="hljs-comment">// 上面未重新赋值新的扩容阈值</span><br>        <span class="hljs-keyword">if</span> (newThr == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-type">float</span> <span class="hljs-variable">ft</span> <span class="hljs-operator">=</span> (<span class="hljs-type">float</span>)newCap * loadFactor;<br>          <span class="hljs-comment">// 如果 新的容量  和  新的扩容阈值不超过最大容量，设置为 新容量 * 负载因子；</span><br>          <span class="hljs-comment">// 否则设置 Int最大值</span><br>            newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="hljs-type">float</span>)MAXIMUM_CAPACITY ?<br>                      (<span class="hljs-type">int</span>)ft : Integer.MAX_VALUE);<br>        &#125;<br>        threshold = newThr;<br>  <span class="hljs-comment">// 新数组</span><br>        <span class="hljs-meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span><br>        Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>[newCap];<br>        table = newTab;<br>        <span class="hljs-keyword">if</span> (oldTab != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; oldCap; ++j) &#123;<br>                Node&lt;K,V&gt; e;<br>                <span class="hljs-keyword">if</span> ((e = oldTab[j]) != <span class="hljs-literal">null</span>) &#123;<br>                    oldTab[j] = <span class="hljs-literal">null</span>;<br>                    <span class="hljs-keyword">if</span> (e.next == <span class="hljs-literal">null</span>)<br>                      <span class="hljs-comment">// 节点无链表直接设置</span><br>                        newTab[e.hash &amp; (newCap - <span class="hljs-number">1</span>)] = e;<br>                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> TreeNode)<br>                      <span class="hljs-comment">// 树节点设置</span><br>                        ((TreeNode&lt;K,V&gt;)e).split(<span class="hljs-built_in">this</span>, newTab, j, oldCap);<br>                    <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// preserve order</span><br>                      <span class="hljs-comment">// 这里都是使用的尾插法</span><br>                        Node&lt;K,V&gt; loHead = <span class="hljs-literal">null</span>, loTail = <span class="hljs-literal">null</span>;<br>                        Node&lt;K,V&gt; hiHead = <span class="hljs-literal">null</span>, hiTail = <span class="hljs-literal">null</span>;<br>                        Node&lt;K,V&gt; next;<br>                        <span class="hljs-keyword">do</span> &#123;<br>                            next = e.next;<br>                            <span class="hljs-keyword">if</span> ((e.hash &amp; oldCap) == <span class="hljs-number">0</span>) &#123;<br>                                <span class="hljs-keyword">if</span> (loTail == <span class="hljs-literal">null</span>)<br>                                    loHead = e;<br>                                <span class="hljs-keyword">else</span><br>                                    loTail.next = e;<br>                                loTail = e;<br>                            &#125;<br>                            <span class="hljs-keyword">else</span> &#123;<br>                                <span class="hljs-keyword">if</span> (hiTail == <span class="hljs-literal">null</span>)<br>                                    hiHead = e;<br>                                <span class="hljs-keyword">else</span><br>                                    hiTail.next = e;<br>                                hiTail = e;<br>                            &#125;<br>                        &#125; <span class="hljs-keyword">while</span> ((e = next) != <span class="hljs-literal">null</span>);<br>                        <span class="hljs-keyword">if</span> (loTail != <span class="hljs-literal">null</span>) &#123;<br>                            loTail.next = <span class="hljs-literal">null</span>;<br>                            newTab[j] = loHead;<br>                        &#125;<br>                        <span class="hljs-keyword">if</span> (hiTail != <span class="hljs-literal">null</span>) &#123;<br>                            hiTail.next = <span class="hljs-literal">null</span>;<br>                            newTab[j + oldCap] = hiHead;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> newTab;<br>    &#125;<br></code></pre></td></tr></table></figure><h2 id="GET方法"><a href="#GET方法" class="headerlink" title="GET方法"></a>GET方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>    Node&lt;K,V&gt; e;<br>    <span class="hljs-keyword">return</span> (e = getNode(hash(key), key)) == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : e.value;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> Node&lt;K,V&gt; <span class="hljs-title function_">getNode</span><span class="hljs-params">(<span class="hljs-type">int</span> hash, Object key)</span> &#123;<br>        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class="hljs-type">int</span> n; K k;<br>  <span class="hljs-comment">// 数组不为空，数组索引位置上的节点不为空</span><br>        <span class="hljs-keyword">if</span> ((tab = table) != <span class="hljs-literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="hljs-number">0</span> &amp;&amp;<br>            (first = tab[(n - <span class="hljs-number">1</span>) &amp; hash]) != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (first.hash == hash &amp;&amp; <span class="hljs-comment">// always check first node</span><br>                ((k = first.key) == key || (key != <span class="hljs-literal">null</span> &amp;&amp; key.equals(k))))<br>              <span class="hljs-comment">// 数组索引位置上的节点就是要找的元素</span><br>                <span class="hljs-keyword">return</span> first;<br>            <span class="hljs-keyword">if</span> ((e = first.next) != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (first <span class="hljs-keyword">instanceof</span> TreeNode)<br>                  <span class="hljs-comment">// 如果是树，走树的查找</span><br>                    <span class="hljs-keyword">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);<br>              <span class="hljs-comment">// 链表查找</span><br>                <span class="hljs-keyword">do</span> &#123;<br>                    <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp;<br>                        ((k = e.key) == key || (key != <span class="hljs-literal">null</span> &amp;&amp; key.equals(k))))<br>                        <span class="hljs-keyword">return</span> e;<br>                &#125; <span class="hljs-keyword">while</span> ((e = e.next) != <span class="hljs-literal">null</span>);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java并发编程</title>
    <link href="/2022/07/11/java/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
    <url>/2022/07/11/java/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="并发编程目的："><a href="#并发编程目的：" class="headerlink" title="并发编程目的："></a>并发编程目的：</h1><p>让程序充分利用计算机资源<br>加快程序响应速度（耗时任务、web服务器）<br>简化异步事件的处理</p><h2 id="什么时候适合使用并发编程"><a href="#什么时候适合使用并发编程" class="headerlink" title="什么时候适合使用并发编程"></a>什么时候适合使用并发编程</h2><p>任务会阻塞线程，导致之后的代码不能执行：比如一边从文件中读取，一边进行大量计算的情况<br>任务执行时间过长，可以划分为分工明确的子任务：比如分段下载<br>任务间断性执行：日志打印<br>任务本身需要协作执行：比如生产者消费者问题</p><h1 id="串行、并发和并行的区别"><a href="#串行、并发和并行的区别" class="headerlink" title="串行、并发和并行的区别"></a>串行、并发和并行的区别</h1><p>你吃饭吃到一半，电话来了，你一直到吃完了以后才去接，这就说明你不支持并发也不支持并行。<br>你吃饭吃到一半，电话来了，你停了下来接了电话，接完后继续吃饭，这说明你支持并发。<br>你吃饭吃到一半，电话来了，你一边打电话一边吃饭，这说明你支持并行。</p><p>串行就是第一种。</p><p>并发的关键是你有处理多个任务的能力，不一定要同时。<br>并行的关键是你有同时处理多个任务的能力。</p><p>所以我认为它们最关键的点就是：是否是『同时』。</p><p>如果任务可拆分成并发、并行，可以缩短整个流程的时间。</p><h1 id="并发编程带来的问题"><a href="#并发编程带来的问题" class="headerlink" title="并发编程带来的问题"></a>并发编程带来的问题</h1><h2 id="频繁的上下文切换的问题："><a href="#频繁的上下文切换的问题：" class="headerlink" title="频繁的上下文切换的问题："></a>频繁的上下文切换的问题：</h2><p>cpu为线程分配时间片，时间片非常短（毫秒级别），cpu不停的切换线程执行，在切换前会保存上一个任务的状态，以便下次切换回这个任务时，可以再加载这个任务的状态，让我们感觉是多个程序同时运行的。上下文的频繁切换，会带来一定的性能开销<br>如何减少上下文切换？</p><p>1.无锁并发编程<br>无锁并发编程。多线程竞争锁时，会引起上下文切换，所以多线程处理数据时，可以用一些办法来避免使用锁，如将数据的ID按照Hash算法取模分段，不同的线程处理不同段的数据<br>2.CAS<br>Java的Atomic包使用CAS算法来更新数据，而不需要加锁。<br>3.使用最少线程。<br>避免创建不需要的线程，比如任务很少，但是创建了很多线程来处理，这样会造成大量线程都处于等待状态。<br>4.协程<br>在单线程里实现多任务的调度，并在单线程里维持多个任务间的切换。</p><h2 id="并发编程死锁问题："><a href="#并发编程死锁问题：" class="headerlink" title="并发编程死锁问题："></a>并发编程死锁问题：</h2><p>是指多个进程在运行过程中因争夺资源而造成的一种僵局，当进程处于这种僵持状态时，若无外力作用，它们都将无法再向前推进。 </p><p>例如：有一个线程A，按照先锁a再获得锁b的的顺序获得锁，而在此同时又有另外一个线程B，按照先锁b再锁a的顺序获得锁。</p><p>如何解决死锁：</p><p>1、以确定的顺序获得锁</p><p>2、超时放弃</p><p>3、死锁检测</p><p>java中死锁检测工具：</p><p>jstack、jconsole、visual VM</p><h2 id="并发编程资源限制问题"><a href="#并发编程资源限制问题" class="headerlink" title="并发编程资源限制问题"></a>并发编程资源限制问题</h2><p>硬件资源<br>  服务器： 1m<br>  本机：2m<br>  带宽的上传&#x2F;下载速度、硬盘读写速度和CPU的处理速度。</p><p>软件资源<br>  数据库连接 500个连接 1000个线程查询 并不会因此而加快<br>  socket</p><h1 id="进程与线程的区别"><a href="#进程与线程的区别" class="headerlink" title="进程与线程的区别"></a>进程与线程的区别</h1><p>进程：是系统进行分配和管理资源的基本单位<br>线程：进程的一个执行单元，是进程内调度的实体、是CPU调度和分派的基本单位，是比进程更小的独立运行的基本单位。线程也被称为轻量级进程,线程是程序执行的最小单位。<br>一个程序至少一个进程，一个进程至少一个线程。<br>进程有自己的独立地址空间，每启动一个进程，系统就会为它分配地址空间，建立数据表来维护代码段、堆栈段和数据段，这种操作非常昂贵。<br>而线程是共享进程中的数据的，使用相同的地址空间，因此CPU切换一个线程的花费远比进程要小很多，同时创建一个线程的开销也比进程要小很多。<br>线程之间的通信更方便，同一进程下的线程共享全局变量、静态变量等数据，而进程之间的通信需要以通信的方式进行。<br>如何处理好同步与互斥是编写多线程程序的难点。<br>多进程程序更健壮，进程有独立的地址空间，一个进程崩溃后，在保护模式下不会对其它进程产生影响，<br>而线程只是一个进程中的不同执行路径。线程有自己的堆栈和局部变量，但线程之间没有单独的地址空间，所以可能一个线程出现问题，进而导致整个程序出现问题</p><h1 id="创建线程的方式"><a href="#创建线程的方式" class="headerlink" title="创建线程的方式"></a>创建线程的方式</h1><p>thread、runable、callable和futureTask配合、线程池</p><p>Callable与Runable功能相似，Callable的call有返回值，可以返回给客户端，而Runable没有返回值，一般情况下，Callable与FutureTask一起使用，或者通过线程池的submit方法返回相应的Future</p><p>Future就是对于具体的Runnable或者Callable任务的执行结果进行取消、查询是否完成、获取结果、设置结果操作。get方法会阻塞，直到任务返回结果。</p><p>FutureTask则是一个RunnableFuture，而RunnableFuture实现了Runnbale又实现了Futrue这两个接口</p><h1 id="线程的状态及其相互转换"><a href="#线程的状态及其相互转换" class="headerlink" title="线程的状态及其相互转换"></a>线程的状态及其相互转换</h1><p>查看源码Thread类中的内部枚举类state</p><p>新建(NEW)：新创建了一个线程对象，但还没有调用start()方法。<br>就绪状态(RUNNABLE):   处于可运行状态的线程正在JVM中执行，但它可能正在等待来自操作系统的其他资源，例如处理器。<br>阻塞(BLOCKED)：线程阻塞于synchronized锁，等待获取synchronized锁的状态。也有可能是自旋锁。<br>等待(WAITING)：Object.wait()、join()、 LockSupport.park(),进入该状态的线程需要等待其他线程做出一些特定动作（通知或中断）。<br>超时等待(TIME_WAITING)：Thread.sleep()、Object.wait(long)、Thread.join()、LockSupport.parkNanos()、LockSupport.parkUntil，该状态不同于WAITING，它可以在指定的时间内自行返回。<br>终止(TERMINATED)：表示该线程已经执行完毕。</p><p><img src="/.com//%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81.jpg" alt="线程状态"></p><p>图中的阻塞包括 BLOCKED、WAITING、TIME_WAITING。</p><p>一般不占用CPU。</p><h2 id="终止线程的-4种方式"><a href="#终止线程的-4种方式" class="headerlink" title="终止线程的 4种方式"></a>终止线程的 4种方式</h2><p><strong>正常运行结束</strong></p><p>程序运行结束，线程自动结束。 </p><p><strong>使用退出标志退出线程</strong></p><p>一般 run()方法执行完，线程就会正常结束，然而，常常有些线程是伺服线程。它们需要长时间的</p><p>运行，只有在外部某些条件满足的情况下，才能关闭这些线程。使用一个变量来控制循环，例如：</p><p>最直接的方法就是设一个 boolean 类型的标志，并通过设置这个标志为 true 或 false 来控制 while循环是否退出，代码示例：</p><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadSafe</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">exit</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>  <br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">while</span> (!exit)&#123;<br>    <span class="hljs-comment">//do something</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义了一个退出标志 exit，当 exit 为 true 时，while 循环退出，exit 的默认值为 false.在定义 exit时，使用了一个 Java 关键字 volatile，这个关键字的目的是使 exit 同步，也就是说在同一时刻只能由一个线程来修改 exit 的值。</p><p><strong>Interrupt</strong> <strong>方法结束线程</strong></p><p>使用 interrupt()方法来中断线程有两种情况：</p><ol><li><p>线程处于阻塞状态：如使用了 sleep,同步锁的 wait,socket 中的 receiver,accept 等方法时，会使线程处于阻塞状态。当调用线程的 interrupt()方法时，会抛出 InterruptException 异常。阻塞中的那个方法抛出这个异常，通过代码捕获该异常，然后 break 跳出循环状态，从而让我们有机会结束这个线程的执行。通常很多人认为只要调用 interrupt 方法线程就会结束，实际上是错的， 一定要先捕获 InterruptedException 异常之后通过 break 来跳出循环，才能正常结束 run 方法。</p></li><li><p>线程未处于阻塞状态：使用 isInterrupted()判断线程的中断标志来退出循环。当使用interrupt()方法时，中断标志就会置 true，和使用自定义的标志来控制循环是一样的道理。</p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadSafe</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">while</span> (!isInterrupted())&#123; <span class="hljs-comment">//非阻塞过程中通过判断中断标志来退出</span><br>      <span class="hljs-keyword">try</span>&#123;<br>      Thread.sleep(<span class="hljs-number">5</span>*<span class="hljs-number">1000</span>);<span class="hljs-comment">//阻塞过程捕获中断异常来退出</span><br>      &#125;<span class="hljs-keyword">catch</span>(InterruptedException e)&#123;<br>      e.printStackTrace();<br>      <span class="hljs-keyword">break</span>;<span class="hljs-comment">//捕获到异常之后，执行 break 跳出循环</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>stop</strong> <strong>方法终止线程（线程不安全）</strong></p><p>程序中可以直接使用 thread.stop()来强行终止线程，但是 stop 方法是很危险的，就象突然关闭计算机电源，而不是按正常程序关机一样，可能会产生不可预料的结果，不安全主要是：thread.stop()调用之后，创建子线程的线程就会抛出 ThreadDeatherror 的错误，并且会释放子线程所持有的所有锁。一般任何进行加锁的代码块，都是为了保护数据的一致性，如果在调用thread.stop()后导致了该线程所持有的所有锁的突然释放(不可控制)，那么被保护数据就有可能呈现不一致性，其他线程在使用这些被破坏的数据时，有可能导致一些很奇怪的应用程序错误。因此，并不推荐使用 stop 方法来终止线程。</p><h1 id="线程的常见方法："><a href="#线程的常见方法：" class="headerlink" title="线程的常见方法："></a>线程的常见方法：</h1><p>Sleep(), 意思就是睡眠，当前线程暂停一段时间让给别的线程去运行。由你的睡眠时间而定，等睡眠到规定的时间自动变为运行状态。</p><p>Yield(), 就是当前线程正在执行的时候停止下来进入等待队列（就绪状态，CPU依然有可能把这个线程拿出来运行），回到等待队列里在系统的调度算法里还是依然有可能把你刚回去的这个线程拿回来继续执行，当然，更大的可能性是把原来等待的那些拿出一个来执行，所以yield的意思是我让出一下CPU，后面你们能不能抢到那我不管。</p><p>join()， 意思就是在自己当前线程加入你调用Join的线程，本线程等待。等调用的线程运行完了，自己再去执行。t1和t2两个线程，在t1的某个点上调用了t2.join,它会跑到t2去运行，t1等待t2运行完毕继续t1运行（自己join自己没有意义）。</p><p>Thread.interrupt方法自行定义一个标志，用来判断是否继续执行  interrupt()不能打断正在竞争锁的线程synchronized()。</p><p>t.isInterrupted() 查询打断标志位是否被设置（是不是曾经被打断过）。</p><p>Thread.interrupted() 查看“当前”线程是否被打断，如果被打断，恢复标志位。</p><p>使用ReentrantLock加锁的线程，可以使用ReentrantLock的lockInterruptibly()打断。</p><p>在多线程环境下，有时候一个线程的执行，依赖于另外一个线程的某种状态的改变，这个时候，我们就可以使用wait与notify或者notifyAll。</p><h2 id="notify跟notifyAll的区别："><a href="#notify跟notifyAll的区别：" class="headerlink" title="notify跟notifyAll的区别："></a>notify跟notifyAll的区别：</h2><p>nofity随机唤醒一个等待的线程<br>notifyAll唤醒所有在该对象上等待的线程</p><h2 id="sleep与wait的区别"><a href="#sleep与wait的区别" class="headerlink" title="sleep与wait的区别"></a>sleep与wait的区别</h2><ol><li>对于 sleep()方法，我们首先要知道该方法是属于 Thread 类中的。而 wait()方法，则是属于 Object 类中的。</li><li>sleep()方法导致了程序暂停执行指定的时间，让出 cpu 给其他线程，但是他的监控状态依然保持着，当指定的时间到了又会自动恢复运行状态。 </li><li>在调用 sleep()方法的过程中，线程不会释放对象锁。</li><li>而当调用 wait()方法的时候，线程会放弃对象锁，进入等待此对象的等待锁定池，只有针对此对象调用 notify()方法后本线程才进入对象锁定池准备获取对象锁进入运行状态。</li><li>wait notify必须放在同步代码块中, 且必须拥有当前对象的锁，即不能取得A对象的锁，而调用B对象的wait，哪个对象wait，就得调哪个对象的notify</li></ol><h2 id="start与run的区别"><a href="#start与run的区别" class="headerlink" title="start与run的区别"></a>start与run的区别</h2><ol><li><p>start()方法来启动线程，真正实现了多线程运行。这时无需等待 run 方法体代码执行完毕，可以直接继续执行下面的代码。</p></li><li><p>通过调用 Thread 类的 start()方法来启动一个线程， 这时此线程是处于就绪状态， 并没有运行。</p></li><li><p>方法 run()称为线程体，它包含了要执行的这个线程的内容，线程就进入了运行状态，开始运行 run 函数当中的代码。 Run 方法运行结束， 此线程终止。然后 CPU 再调度其它线程。</p></li></ol><h1 id="线程分类"><a href="#线程分类" class="headerlink" title="线程分类"></a>线程分类</h1><p>用户线程、守护线程<br>守护线程：任何一个守护线程都是整个程序中所有用户线程的守护者，只要有活着的用户线程，守护线程就活着。当JVM实例中最后一个非守护线程结束时，也随JVM一起退出。<br>守护线程的用处：jvm垃圾清理线程<br>建议： 尽量少使用守护线程，因其不可控，不要在守护线程里去进行读写操作、执行计算逻辑</p><h1 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h1><p>什么是线程安全性？<br>当多个线程访问某个类,不管运行时环境采用何种调度方式或者这些线程如何交替执行,并且在主调代码中不需要任何额外的同步或协同,这个类都能表现出正确的行为,那么就称这个类为线程安全的。—-《并发编程实战》</p><p>什么是线程不安全？<br>多线程并发访问时，得不到正确的结果。例如num++ 非原子操作</p><h2 id="如何避免线程安全性问题"><a href="#如何避免线程安全性问题" class="headerlink" title="如何避免线程安全性问题"></a>如何避免线程安全性问题</h2><p>线程安全性问题成因<br>1：多线程环境<br>2：多个线程操作同一共享资源<br>3：对该共享资源进行了非原子性操作</p><p>如何避免<br>(打破成因中三点任意一点)<br>1：多线程环境–将多线程改单线程（必要的代码，加锁访问）<br>2：多个线程操作同一共享资源–不共享资源（ThreadLocal、不共享、操作无状态化、不可变）<br>3：对该共享资源进行了非原子性操作– 将非原子性操作改成原子性操作（加锁、使用JDK自带的原子性操作的类、JUC提供的相应的并发工具类）</p><h1 id="多线程debug"><a href="#多线程debug" class="headerlink" title="多线程debug"></a>多线程debug</h1><p>idea-&gt;断点-&gt;右健-&gt;suspend-&gt;thread</p><h1 id="Java中用到的线程调度"><a href="#Java中用到的线程调度" class="headerlink" title="Java中用到的线程调度"></a>Java中用到的线程调度</h1><h2 id="抢占式调度："><a href="#抢占式调度：" class="headerlink" title="抢占式调度："></a>抢占式调度：</h2><p>抢占式调度指的是每条线程执行的时间、线程的切换都由系统控制，系统控制指的是在系统某种运行机制下，可能每条线程都分同样的执行时间片，也可能是某些线程执行的时间片较长，甚至某些线程得不到执行的时间片。在这种机制下，一个线程的堵塞不会导致整个进程堵塞。</p><h2 id="协同式调度："><a href="#协同式调度：" class="headerlink" title="协同式调度："></a>协同式调度：</h2><p>协同式调度指某一线程执行完后主动通知系统切换到另一线程上执行，这种模式就像接力赛一样，一个人跑完自己的路程就把接力棒交接给下一个人，下个人继续往下跑。线程的执行时间由线程本身控制，线程切换可以预知，不存在多线程同步问题，但它有一个致命弱点：如果一个线程编写有问题，运行到一半就一直堵塞，那么可能导致整个系统崩溃。</p><h2 id="JVM-的线程调度实现（抢占式调度）"><a href="#JVM-的线程调度实现（抢占式调度）" class="headerlink" title="JVM 的线程调度实现（抢占式调度）"></a>JVM 的线程调度实现（抢占式调度）</h2><p>java 使用的线程调使用抢占式调度，Java 中线程会按优先级分配 CPU 时间片运行，且优先级越高越优先执行，但优先级高并不代表能独自占用执行时间片，可能是优先级高得到越多的执行时间片，反之，优先级低的分到的执行时间少但不会分配不到执行时间。</p><p><strong>线程让出 cpu 的情况：</strong> </p><ol><li>当前运行线程主动放弃 CPU，JVM 暂时放弃 CPU 操作（基于时间片轮转调度的 JVM 操作系统不会让线程永久放弃 CPU，或者说放弃本次时间片的执行权），例如调用 yield()方法。 </li><li>当前运行线程因为某些原因进入阻塞状态，例如阻塞在 I&#x2F;O 上。 </li><li>当前运行线程结束，即运行完 run()方法里面的任务。</li></ol><h1 id="ThreadLocalMap（线程的一个属性）"><a href="#ThreadLocalMap（线程的一个属性）" class="headerlink" title="ThreadLocalMap（线程的一个属性）"></a>ThreadLocalMap（线程的一个属性）</h1><ol><li><p>每个线程中都有一个自己的 ThreadLocalMap 类对象，可以将线程自己的对象保持到其中，各管各的，线程可以正确的访问到自己的对象。 </p></li><li><p>将一个共用的 ThreadLocal 静态实例作为 key，将不同对象的引用保存到不同线程的ThreadLocalMap 中，然后在线程执行的各处通过这个静态 ThreadLocal 实例的 get()方法取得自己线程保存的那个对象，避免了将这个对象作为参数传递的麻烦。 </p></li><li><p>ThreadLocalMap 其实就是线程里面的一个属性，它在 Thread 类中定义</p></li></ol><p>ThreadLocal.ThreadLocalMap threadLocals &#x3D; null; </p><p>最常见的 ThreadLocal 使用场景为 用来解决 数据库连接、Session 管理等。 </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ThreadLocal</span> <span class="hljs-variable">threadSession</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>();  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Session <span class="hljs-title function_">getSession</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InfrastructureException &#123;      <br>  <span class="hljs-type">Session</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> (Session) threadSession.get();     <br>  <span class="hljs-keyword">try</span> &#123;        <br>      <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span>) &#123;          <br>        s = getSessionFactory().openSession();               <br>        threadSession.set(s);   <br>      &#125;   <br>    &#125; <span class="hljs-keyword">catch</span> (HibernateException ex) &#123;     <br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InfrastructureException</span>(ex);   <br>    &#125;   <br>    <span class="hljs-keyword">return</span> s;   <br>&#125; <br></code></pre></td></tr></table></figure><h1 id="线程池及Executor框架"><a href="#线程池及Executor框架" class="headerlink" title="线程池及Executor框架"></a>线程池及Executor框架</h1><h2 id="为什么要使用线程池？"><a href="#为什么要使用线程池？" class="headerlink" title="为什么要使用线程池？"></a>为什么要使用线程池？</h2><p>每当一个请求到达就创建一个新线程，然后在新线程中为请求服务，但是频繁的创建线程，销毁线程所带来的系统开销其实是非常大的。</p><h2 id="线程池参数说明"><a href="#线程池参数说明" class="headerlink" title="线程池参数说明"></a>线程池参数说明</h2><p>corePoolSize：核心线程池大小 cSize<br>maximumPoolSize：线程池最大容量 mSize<br>keepAliveTime：当线程数量大于核心时，多余的空闲线程在终止之前等待新任务的最大时间。<br>unit：时间单位<br>workQueue:工作队列 nWorks<br>ThreadFactory：线程工厂<br>handler：拒绝策略</p><p>默认线程池拒绝策略及自定义拒绝策略：<br>AbortPolicy：该策略直接抛出异常，阻止系统正常工作<br>CallerRunsPolicy：只要线程池没有关闭，该策略直接在调用者线程中，执行当前被丢弃的任务（叫老板帮你干活）<br>DiscardPolicy：直接啥事都不干，直接把任务丢弃<br>DiscardOldestPolicy：丢弃最老的一个请求（任务队列里面的第一个），再尝试提交任务</p><p>通过new创建线程池时，除非调用prestartAllCoreThreads方法初始化核心线程，否则此时线程池中有0个线程，即使工作队列中存在多个任务，同样不会执行</p><h2 id="会启动多少线程执行任务"><a href="#会启动多少线程执行任务" class="headerlink" title="会启动多少线程执行任务"></a>会启动多少线程执行任务</h2><p>任务数X<br>x &lt;&#x3D; cSize —》只启动x个线程<br>x &gt;&#x3D; cSize &amp;&amp; x &lt; nWorks + cSize—》 会启动 &lt;&#x3D; cSize 个线程 其他的任务就放到工作队列里<br>x &gt; cSize &amp;&amp; x &gt; nWorks + cSize–》<br>    x-(nWorks) &lt;&#x3D; mSize 会启动x-(nWorks)个线程<br>    x-(nWorks) &gt; mSize 会启动mSize个线程来执行任务，其余的执行相应的拒绝策略</p><h2 id="线程池的组成结构："><a href="#线程池的组成结构：" class="headerlink" title="线程池的组成结构："></a>线程池的组成结构：</h2><p>一个线程池包括四个基本部分<br>1.线程管理池（ThreadPool)：用于创建并管理线程池，有创建，销毁，添加新任务；<br>2.工作线程（PoolWorker）：线程池中的线程在没有任务的时候处于等待状态，可以循环的执行任务；<br>3.任务接口（Task）：每个任务必须实现接口，用来提供工作线程调度任务的执行，规定了任务的入口以及执行结束的收尾工作和任务的执行状态等；<br>4.任务队列：用于存放没有处理的任务，提供一种缓存机制。</p><p><img src="/.com//%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%BB%93%E6%9E%84%E5%9B%BE.png" alt="线程池结构图"></p><p><img src="/.com//%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="线程池流程图"></p><h2 id="线程池运行的任务异常后，没日志"><a href="#线程池运行的任务异常后，没日志" class="headerlink" title="线程池运行的任务异常后，没日志"></a>线程池运行的任务异常后，没日志</h2><p>线程池未提供打印日志的功能。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">1.修改runable方法，加入try catch<br>2. 自定义线程池，继承ThreadPoolExecutor并复写其afterExecute(Runnable r, Throwable t)方法。 <br>3. 实现Thread.UncaughtExceptionHandler接口，实现void uncaughtException(Thread t, Throwable e);方法，并将该handler传递给线程池的ThreadFactory <br>4. 采用Future模式，将返回结果以及异常放到Future中，在Future中处理 <br>5. 继承ThreadGroup，覆盖其uncaughtException方法。（与第二种方式类似，因为ThreadGroup类本身就实现了Thread.UncaughtExceptionHandler接口)<br></code></pre></td></tr></table></figure><h2 id="java提供的几种默认线程池"><a href="#java提供的几种默认线程池" class="headerlink" title="java提供的几种默认线程池"></a>java提供的几种默认线程池</h2><p> Java 里面线程池的顶级接口是 Executors，但是严格意义上讲 Executor 并不是一个线程池，而只是一个执行线程的工具。真正的线程池接口是 ExecutorService。 使用Executors创建线程池很简单，但是便捷不仅隐藏了复杂性，也为我们埋下了潜在的隐患（OOM，线程耗尽）。</p><p>newFixedThreadPool：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">使用的构造方式为new ThreadPoolExecutor(var0, var0, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue())，设置了corePoolSize=maxPoolSize，keepAliveTime=0(此时该参数没作用)，无界队列，任务可以无限放入，当请求过多时(任务处理速度跟不上任务提交速度造成请求堆积)可能导致占用过多内存或直接导致OOM异常<br></code></pre></td></tr></table></figure><p>newSingleThreadExector：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">使用的构造方式为new ThreadPoolExecutor(1, 1, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue(), var0)，基本同newFixedThreadPool，但是将线程数设置为了1，单线程，弊端和newFixedThreadPool一致<br></code></pre></td></tr></table></figure><p>newCachedThreadPool：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">使用的构造方式为new ThreadPoolExecutor(0, 2147483647, 60L, TimeUnit.SECONDS, new SynchronousQueue())，corePoolSize=0，maxPoolSize为很大的数，同步移交队列，也就是说不维护常驻线程(核心线程)，每次来请求直接创建新线程来处理任务，也不使用队列缓冲，会自动回收多余线程，由于将maxPoolSize设置成Integer.MAX_VALUE，当请求很多时就可能创建过多的线程，导致资源耗尽OOM<br></code></pre></td></tr></table></figure><p>newScheduledThreadPool：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">使用的构造方式为new ThreadPoolExecutor(var1, 2147483647, 0L, TimeUnit.NANOSECONDS, new ScheduledThreadPoolExecutor.DelayedWorkQueue())，支持定时周期性执行，注意一下使用的是延迟队列，弊端同newCachedThreadPool一致<br></code></pre></td></tr></table></figure><h2 id="线程复用与源码解析"><a href="#线程复用与源码解析" class="headerlink" title="线程复用与源码解析"></a>线程复用与源码解析</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Runnable command)</span> &#123;<br>    <span class="hljs-keyword">if</span> (command == <span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Proceed in 3 steps:</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * 1. If fewer than corePoolSize threads are running, try to</span><br><span class="hljs-comment">     * start a new thread with the given command as its first</span><br><span class="hljs-comment">     * task.  The call to addWorker atomically checks runState and</span><br><span class="hljs-comment">     * workerCount, and so prevents false alarms that would add</span><br><span class="hljs-comment">     * threads when it shouldn&#x27;t, by returning false.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * 2. If a task can be successfully queued, then we still need</span><br><span class="hljs-comment">     * to double-check whether we should have added a thread</span><br><span class="hljs-comment">     * (because existing ones died since last checking) or that</span><br><span class="hljs-comment">     * the pool shut down since entry into this method. So we</span><br><span class="hljs-comment">     * recheck state and if necessary roll back the enqueuing if</span><br><span class="hljs-comment">     * stopped, or start a new thread if there are none.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * 3. If we cannot queue task, then we try to add a new</span><br><span class="hljs-comment">     * thread.  If it fails, we know we are shut down or saturated</span><br><span class="hljs-comment">     * and so reject the task.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> ctl.get();<br>    <span class="hljs-keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;<br>        <span class="hljs-keyword">if</span> (addWorker(command, <span class="hljs-literal">true</span>))<br>            <span class="hljs-keyword">return</span>;<br>        c = ctl.get();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">recheck</span> <span class="hljs-operator">=</span> ctl.get();<br>        <span class="hljs-keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))<br>            reject(command);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (workerCountOf(recheck) == <span class="hljs-number">0</span>)<br>            addWorker(<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!addWorker(command, <span class="hljs-literal">false</span>))<br>        reject(command);<br>&#125;<br></code></pre></td></tr></table></figure><p>1.线程池里执行的是任务,核心逻辑在ThreadPoolExecutor类的execute方法中,同时ThreadPoolExecutor中维护了HashSet<Worker> workers;<br>2.addWorker()方法来创建线程执行任务,如果是核心线程的任务,会赋值给Worker的firstTask属性;<br>3.Worker实现了Runnable,本质上也是任务,核心在run()方法里;<br>4.run()方法的执行核心runWorker(),自旋拿任务while (task !&#x3D; null || (task &#x3D; getTask()) !&#x3D; null)),task是核心线程Worker的firstTask或者getTask();<br>5.getTask()的核心逻辑:<br>        1.若当前工作线程数量大于核心线程数-&gt;说明此线程是非核心工作线程,通过poll()拿任务,未拿到任务即getTask()返回null,然后会在processWorkerExit(w, completedAbruptly)方法释放掉这个非核心工作线程的引用;<br>        2.若当前工作线程数量小于核心线程数-&gt;说明此时线程是核心工作线程,通过take()拿任务<br>        3.take()方式取任务,如果队列中没有任务了会调用await()阻塞当前线程,直到新任务到来,所以核心工作线程不会被回收; 当执行execute方法里的workQueue.offer(command)时会调用Condition.singal()方法唤醒一个之前阻塞的线程,这样核心线程即可复用</Worker></p><h2 id="execute与submit的区别"><a href="#execute与submit的区别" class="headerlink" title="execute与submit的区别"></a>execute与submit的区别</h2><ol><li>execute是Executor接口的方法，而submit是ExecutorService的方法，并且ExecutorService接口继承了Executor接口。</li><li>execute只接受Runnable参数，没有返回值；而submit可以接受Runnable参数和Callable参数，并且返回了Future对象，可以进行任务取消、获取任务结果、判断任务是否执行完毕&#x2F;取消等操作。其中，submit会对Runnable或Callable入参封装成RunnableFuture对象，调用execute方法并返回。</li><li>通过execute方法提交的任务如果出现异常则直接抛出原异常，是在线程池中的线程中；而submit方法是捕获了异常的，只有当调用Future的get方法时，才会抛出ExecutionException异常，且是在调用get方法的线程。</li></ol><h1 id="JAVA锁"><a href="#JAVA锁" class="headerlink" title="JAVA锁"></a>JAVA锁</h1><h2 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h2><p>乐观锁是一种乐观思想，即认为读多写少，遇到并发写的可能性低，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，采取在写时先读出当前版本号，然后加锁操作（比较跟上一次的版本号，如果一样则更新），如果失败则要重复读-比较-写的操作。 </p><p>java 中的乐观锁基本都是通过 CAS 操作实现的，CAS 是一种更新的原子操作，比较当前值跟传入值是否一样，一样则更新，否则失败。 </p><h2 id="悲观锁"><a href="#悲观锁" class="headerlink" title="悲观锁"></a>悲观锁</h2><p>悲观锁是就是悲观思想，即认为写多，遇到并发写的可能性高，每次去拿数据的时候都认为别人会修改，所以每次在读写数据的时候都会上锁，这样别人想读写这个数据就会block直到拿到锁。 java中的悲观锁就是Synchronized,AQS框架下的锁则是先尝试cas乐观锁去获取锁，获取不到，才会转换为悲观锁，如 RetreenLock。 </p><h2 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h2><p>自旋锁原理非常简单，如果持有锁的线程能在很短时间内释放锁资源，那么那些等待竞争锁的线程就不需要做内核态和用户态之间的切换进入阻塞挂起状态，它们只需要等一等（自旋），等持有锁的线程释放锁后即可立即获取锁，这样就避免用户线程和内核的切换的消耗。 </p><p>线程自旋是需要消耗 cup 的，说白了就是让 cup 在做无用功，如果一直获取不到锁，那线程也不能一直占用 cup 自旋做无用功，所以需要设定一个自旋等待的最大时间。</p><p>如果持有锁的线程执行的时间超过自旋等待的最大时间扔没有释放锁，就会导致其它争用锁的线程在最大等待时间内还是获取不到锁，这时争用线程会停止自旋进入阻塞状态。</p><p>自旋锁的优缺点 </p><p>自旋锁尽可能的减少线程的阻塞，这对于锁的竞争不激烈，且占用锁时间非常短的代码块来说性能能大幅度的提升，因为自旋的消耗会小于线程阻塞挂起再唤醒的操作的消耗，这些操作会导致线程发生两次上下文切换！</p><p>但是如果锁的竞争激烈，或者持有锁的线程需要长时间占用锁执行同步块，这时候就不适合使用自旋锁了，因为自旋锁在获取锁前一直都是占用 cpu 做无用功，占着 XX 不 XX，同时有大量线程在竞争一个锁，会导致获取锁的时间很长，线程自旋的消耗大于线程阻塞挂起操作的消耗，其它需要 cup 的线程又不能获取到 cpu，造成 cpu 的浪费。所以这种情况下我们要关闭自旋锁； </p><p>自旋锁时间阈值（1.6引入了适应性自旋锁） </p><p>自旋锁的目的是为了占着 CPU 的资源不释放，等到获取到锁立即进行处理。但是如何去选择自旋的执行时间呢？如果自旋执行时间太长，会有大量的线程处于自旋状态占用 CPU 资源，进而会影响整体系统的性能。因此自旋的周期选的额外重要！ </p><p>JVM 对于自旋周期的选择，jdk1.5 这个限度是一定的写死的，在 1.6 引入了适应性自旋锁，适应性自旋锁意味着自旋的时间不在是固定的了，而是由前一次在同一个锁上的自旋时间以及锁的拥有者的状态来决定，基本认为一个线程上下文切换的时间是最佳的一个时间，同时 JVM 还针对当前 CPU 的负荷情况做了较多的优化，如果平均负载小于 CPUs 则一直自旋，如果有超过(CPUs&#x2F;2) 个线程正在自旋，则后来线程直接阻塞，如果正在自旋的线程发现 Owner 发生了变化则延迟自旋时间（自旋计数）或进入阻塞，如果 CPU 处于节电模式则停止自旋，自旋时间的最坏情况是 CPU 的存储延迟（CPU A 存储了一个数据，到 CPU B 得知这个数据直接的时间差），自旋时会适当放弃线程优先级之间的差异。 </p><p>自旋锁的开启 </p><p>JDK1.6 中-XX:+UseSpinning 开启； </p><p>-XX:PreBlockSpin&#x3D;10 为自旋次数； </p><p>JDK1.7 后，去掉此参数，由 jvm 控制； </p><h2 id="可重入锁（递归锁）"><a href="#可重入锁（递归锁）" class="headerlink" title="可重入锁（递归锁）"></a>可重入锁（递归锁）</h2><p>这里面讲的是广义上的可重入锁，而不是单指JAVA 下的ReentrantLock。可重入锁，也叫做递归锁，指的是同一线程 外层函数获得锁之后 ，内层递归函数仍然有获取该锁的代码，但不受影响。在 JAVA 环境下 ReentrantLock 和 synchronized 都是 可重入锁。 </p><h2 id="公平锁与非公平锁"><a href="#公平锁与非公平锁" class="headerlink" title="公平锁与非公平锁"></a>公平锁与非公平锁</h2><p>公平锁（Fair） </p><p>加锁前检查是否有排队等待的线程，优先排队等待的线程，先来先得 </p><p>非公平锁（Nonfair） </p><p>加锁时不考虑排队等待问题，直接尝试获取锁，获取不到自动到队尾等待 </p><ol><li>非公平锁性能比公平锁高 5~10 倍，因为公平锁需要在多核的情况下维护一个队列 </li><li>Java 中的 synchronized 是非公平锁，ReentrantLock 默认的 lock()方法采用的是非公平锁。</li></ol><h2 id="共享锁和独占锁-java"><a href="#共享锁和独占锁-java" class="headerlink" title="共享锁和独占锁 java"></a>共享锁和独占锁 java</h2><p>并发包提供的加锁模式分为独占锁和共享锁。</p><p>独占锁 </p><p>独占锁模式下，每次只能有一个线程能持有锁，ReentrantLock 就是以独占方式实现的互斥锁。独占锁是一种悲观保守的加锁策略，它避免了读&#x2F;读冲突，如果某个只读线程获取锁，则其他读线程都只能等待，这种情况下就限制了不必要的并发性，因为读操作并不会影响数据的一致性。</p><p>共享锁 </p><p>共享锁则允许多个线程同时获取锁，并发访问 共享资源，如：ReadWriteLock。共享锁则是一种乐观锁，它放宽了加锁策略，允许多个执行读操作的线程同时访问共享资源。</p><ol><li><p>AQS 的内部类 Node 定义了两个常量 SHARED 和 EXCLUSIVE，他们分别标识 AQS 队列中等待线程的锁获取模式。 </p></li><li><p>java 的并发包中提供了 ReadWriteLock，读-写锁。它允许一个资源可以被多个读操作访问，或者被一个 写操作访问，但两者不能同时进行。</p></li></ol><h2 id="重量级锁（Mutex-Lock）"><a href="#重量级锁（Mutex-Lock）" class="headerlink" title="重量级锁（Mutex Lock）"></a>重量级锁（<strong>Mutex Lock</strong>）</h2><p>Synchronized 是通过对象内部的一个叫做监视器锁（monitor）来实现的。但是监视器锁本质又是依赖于底层的操作系统的 Mutex Lock 来实现的。而操作系统实现线程之间的切换这就需要从用户态转换到核心态，这个成本非常高，状态之间的转换需要相对比较长的时间，这就是为什么 Synchronized 效率低的原因。因此，这种依赖于操作系统 Mutex Lock 所实现的锁我们称之为</p><p>“重量级锁”。JDK 中对 Synchronized 做的种种优化，其核心都是为了减少这种重量级锁的使用。</p><p>JDK1.6 以后，为了减少获得锁和释放锁所带来的性能消耗，提高性能，引入了“轻量级锁”和</p><p>“偏向锁”。 </p><h2 id="轻量级锁"><a href="#轻量级锁" class="headerlink" title="轻量级锁"></a>轻量级锁</h2><p>锁的状态总共有四种：无锁状态、偏向锁、轻量级锁和重量级锁。 </p><p>锁升级 </p><p>随着锁的竞争，锁可以从偏向锁升级到轻量级锁，再升级的重量级锁（但是锁的升级是单向的，也就是说只能从低到高升级，不会出现锁的降级）。</p><p>“轻量级”是相对于使用操作系统互斥量来实现的传统锁而言的。但是，首先需要强调一点的是，轻量级锁并不是用来代替重量级锁的，它的本意是在没有多线程竞争的前提下，减少传统的重量级锁使用产生的性能消耗。在解释轻量级锁的执行过程之前，先明白一点，轻量级锁所适应的场景是线程交替执行同步块的情况，如果存在同一时间访问同一锁的情况，就会导致轻量级锁膨胀为重量级锁。 </p><h2 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h2><p>Hotspot 的作者经过以往的研究发现大多数情况下锁不仅不存在多线程竞争，而且总是由同一线程多次获得。偏向锁的目的是在某个线程获得锁之后，消除这个线程锁重入（CAS）的开销，看起来让这个线程得到了偏护。引入偏向锁是为了在无多线程竞争的情况下尽量减少不必要的轻量级锁执行路径，因为轻量级锁的获取及释放依赖多次 CAS 原子指令，而偏向锁只需要在置换 ThreadID的时候依赖一次 CAS 原子指令（由于一旦出现多线程竞争的情况就必须撤销偏向锁，所以偏向锁的撤销操作的性能损耗必须小于节省下来的 CAS 原子指令的性能消耗）。上面说过，轻量级锁是为了在线程交替执行同步块时提高性能，而偏向锁则是在只有一个线程执行同步块时进一步提高性能。 </p><h2 id="分段锁"><a href="#分段锁" class="headerlink" title="分段锁"></a>分段锁</h2><p>分段锁也并非一种实际的锁，而是一种思想 ConcurrentHashMap 是学习分段锁的最好实践</p><h2 id="锁优化"><a href="#锁优化" class="headerlink" title="锁优化"></a>锁优化</h2><h3 id="减少锁持有时间"><a href="#减少锁持有时间" class="headerlink" title="减少锁持有时间"></a>减少锁持有时间</h3><p>只用在有线程安全要求的程序上加锁 </p><h3 id="减小锁粒度"><a href="#减小锁粒度" class="headerlink" title="减小锁粒度"></a>减小锁粒度</h3><p>将大对象（这个对象可能会被很多线程访问），拆成小对象，大大增加并行度，降低锁竞争。</p><p>降低了锁的竞争，偏向锁，轻量级锁成功率才会提高。最最典型的减小锁粒度的案例就是</p><p>ConcurrentHashMap。 </p><h3 id="锁分离"><a href="#锁分离" class="headerlink" title="锁分离"></a>锁分离</h3><p>最常见的锁分离就是读写锁 ReadWriteLock，根据功能进行分离成读锁和写锁，这样读读不互斥，读写互斥，写写互斥，即保证了线程安全，又提高了性能，具体也请查看[高并发 Java 五【图灵、马士兵、慕课网、极客时间等更多架构师课程，请加微信642620018】] </p><p>JDK 并发包 1。读写分离思想可以延伸，只要操作互不影响，锁就可以分离。比如</p><p>LinkedBlockingQueue 从头部取出，从尾部放数据。</p><h3 id="锁粗化"><a href="#锁粗化" class="headerlink" title="锁粗化"></a>锁粗化</h3><p>通常情况下，为了保证多线程间的有效并发，会要求每个线程持有锁的时间尽量短，即在使用完公共资源后，应该立即释放锁。但是，凡事都有一个度，如果对同一个锁不停的进行请求、同步和释放，其本身也会消耗系统宝贵的资源，反而不利于性能的优化 。 </p><h3 id="锁消除"><a href="#锁消除" class="headerlink" title="锁消除"></a>锁消除</h3><p>锁消除是在编译器级别的事情。在即时编译器时，如果发现不可能被共享的对象，则可以消除这些对象的锁操作，多数是因为程序员编码不规范引起。</p><h2 id="Synchronized-同步锁"><a href="#Synchronized-同步锁" class="headerlink" title="Synchronized 同步锁"></a>Synchronized 同步锁</h2><p>synchronized 它可以把任意一个非 NULL 的对象当作锁。他属于独占式的悲观锁，同时属于可重入锁。 </p><h3 id="Synchronized作用范围"><a href="#Synchronized作用范围" class="headerlink" title="Synchronized作用范围"></a>Synchronized作用范围</h3><ol><li><p>作用于方法时，锁住的是对象的实例(this)； </p></li><li><p>当作用于静态方法时，锁住的是Class实例，又因为Class的相关数据存储在永久带PermGen</p></li></ol><p>（jdk1.8 则是 metaspace），永久带是全局共享的，因此静态方法锁相当于类的一个全局锁，会锁所有调用该方法的线程； </p><ol start="3"><li>synchronized 作用于一个对象实例时，锁住的是所有以该对象为锁的代码块。它有多个队列，</li></ol><p>当多个线程一起访问某个对象监视器的时候，对象监视器会将这些线程存储在不同的容器中。 </p><h3 id="Synchronized核心组件"><a href="#Synchronized核心组件" class="headerlink" title="Synchronized核心组件"></a>Synchronized核心组件</h3><ol><li><p>Wait Set：哪些调用 wait 方法被阻塞的线程被放置在这里； </p></li><li><p>Contention List：竞争队列，所有请求锁的线程首先被放在这个竞争队列中； </p></li><li><p>Entry List：Contention List 中那些有资格成为候选资源的线程被移动到 Entry List 中； </p></li><li><p>OnDeck：任意时刻，最多只有一个线程正在竞争锁资源，该线程被成为 OnDeck； </p></li><li><p>Owner：当前已经获取到所资源的线程被称为 Owner； </p></li><li><p>!Owner：当前释放锁的线程。</p></li></ol><h3 id="Synchronized-实现"><a href="#Synchronized-实现" class="headerlink" title="Synchronized 实现"></a>Synchronized 实现</h3><p><img src="/.com//synchronized%E5%AE%9E%E7%8E%B0.png" alt="synchronized实现"></p><ol><li><p>JVM 每次从队列的尾部取出一个数据用于锁竞争候选者（OnDeck），但是并发情况下，ContentionList 会被大量的并发线程进行 CAS 访问，为了降低对尾部元素的竞争，JVM 会将一部分线程移动到 EntryList 中作为候选竞争线程。 </p></li><li><p>Owner 线程会在 unlock 时，将 ContentionList 中的部分线程迁移到 EntryList 中，并指定EntryList 中的某个线程为 OnDeck 线程（一般是最先进去的那个线程）。 </p></li><li><p>Owner 线程并不直接把锁传递给 OnDeck 线程，而是把锁竞争的权利交给 OnDeck，OnDeck需要重新竞争锁。这样虽然牺牲了一些公平性，但是能极大的提升系统的吞吐量，在JVM 中，也把这种选择行为称之为“竞争切换”。 </p></li><li><p>OnDeck 线程获取到锁资源后会变为 Owner 线程，而没有得到锁资源的仍然停留在 EntryList 中。如果Owner线程被wait方法阻塞，则转移到WaitSet队列中，直到某个时刻通过notify 或者 notifyAll 唤醒，会重新进去 EntryList 中。 </p></li><li><p>处于 ContentionList、EntryList、WaitSet 中的线程都处于阻塞状态，该阻塞是由操作系统来完成的（Linux 内核下采用pthread_mutex_lock 内核函数实现的）。 </p></li><li><p>Synchronized 是非公平锁。 Synchronized 在线程进入 ContentionList 时，等待的线程会先尝试自旋获取锁，如果获取不到就进入 ContentionList，这明显对于已经进入队列的线程是不公平的，还有一个不公平的事情就是自旋获取锁的线程还可能直接抢占 OnDeck 线程的锁资源。</p></li><li><p>每个对象都有个 monitor 对象，加锁就是在竞争 monitor 对象，代码块加锁是在前后分别加上 monitorenter 和 monitorexit 指令来实现的，方法加锁是通过一个标记位来判断的</p></li><li><p>synchronized 是一个重量级操作，需要调用操作系统相关接口，性能是低效的，有可能给线程加锁消耗的时间比有用操作消耗的时间更多。 </p></li><li><p>Java1.6，synchronized进行了很多的优化，有适应自旋、锁消除、锁粗化、轻量级锁及偏向锁等，效率有了本质上的提高。在之后推出的 Java1.7 与 1.8 中，均对该关键字的实现机理做了优化。引入了偏向锁和轻量级锁。都是在对象头中有标记位，不需要经过操作系统加锁。 </p></li><li><p>锁可以从偏向锁升级到轻量级锁，再升级到重量级锁。这种升级过程叫做锁膨胀； </p></li><li><p>JDK 1.6 中默认是开启偏向锁和轻量级锁，可以通过-XX:-UseBiasedLocking 来禁用偏向锁。</p></li></ol><h2 id="什么是-AQS（抽象的队列同步器）"><a href="#什么是-AQS（抽象的队列同步器）" class="headerlink" title="什么是 AQS（抽象的队列同步器）"></a>什么是 <strong>AQS</strong>（<strong>抽象的队列同步器</strong>）</h2><p>AbstractQueuedSynchronizer 类如其名，抽象的队列式的同步器，AQS 定义了一套多线程访问共享资源的同步器框架，许多同步类实现都依赖于它，如常用的ReentrantLock&#x2F;Semaphore&#x2F;CountDownLatch。 </p><p><img src="/.com//AQS%E7%BB%93%E6%9E%84.png" alt="AQS结构"></p><p>它维护了一个 volatile int state（代表共享资源）和一个 FIFO 线程等待队列（多线程争用资源被阻塞时会进入此队列）。state 的访问方式有三种: getState()、 setState() 、compareAndSetState() 。</p><p>AQS 定义两种资源共享方式 </p><p>Exclusive独占资源-ReentrantLock</p><p>Exclusive（独占，只有一个线程能执行，如 ReentrantLock） </p><p>Share共享资源-Semaphore&#x2F;CountDownLatch</p><p>Share（共享，多个线程可同时执行，如 Semaphore&#x2F;CountDownLatch）。</p><p>AQS只是一个框架，具体资源的获取&#x2F;释放方式交由自定义同步器去实现，AQS这里只定义了一个接口，具体资源的获取交由自定义同步器去实现了（通过state的get&#x2F;set&#x2F;CAS)之所以没有定义成 abstract，是因为独占模式下只用实现 tryAcquire-tryRelease，而共享模式下只用实现 tryAcquireShared-tryReleaseShared。如果都定义成abstract，那么每个模式也要去实现另一模式下的接口。不同的自定义同步器争用共享资源的方式也不同。自定义同步器在实现时只需要实现共享资源 state 的获取与释放方式即可，至于具体线程等待队列的维护（如获取资源失败入队&#x2F; 唤醒出队等），AQS 已经在顶层实现好了。自定义同步器实现时主要实现以下几种方法： </p><p>1． isHeldExclusively()：该线程是否正在独占资源。只有用到 condition 才需要去实现它。 </p><p>2． tryAcquire(int)：独占方式。尝试获取资源，成功则返回 true，失败则返回 false。 </p><p>3． tryRelease(int)：独占方式。尝试释放资源，成功则返回 true，失败则返回 false。 </p><p>4． tryAcquireShared(int)：共享方式。尝试获取资源。负数表示失败；0 表示成功，但没有剩余可用资源；正数表示成功，且有剩余资源。 </p><p>5． tryReleaseShared(int)：共享方式。尝试释放资源，如果释放后允许唤醒后续等待结点返回 true，否则返回 false。 </p><p>同步器的实现是ABS核心（state资源状态计数） </p><p>同步器的实现是 ABS 核心，以 ReentrantLock 为例，state 初始化为 0，表示未锁定状态。A 线程 lock()时，会调用 tryAcquire()独占该锁并将 state+1。此后，其他线程再 tryAcquire()时就会失败，直到A线程unlock()到state&#x3D;0（即释放锁）为止，其它线程才有机会获取该锁。当然，释放锁之前，A 线程自己是可以重复获取此锁的（state 会累加），这就是可重入的概念。但要注意，获取多少次就要释放多么次，这样才能保证 state 是能回到零态的。 </p><p>以 CountDownLatch 以例，任务分为 N 个子线程去执行，state 也初始化为 N（注意 N 要与线程个数一致）。这 N 个子线程是并行执行的，每个子线程执行完后 countDown()一次，state 会 CAS 减1。等到所有子线程都执行完后(即state&#x3D;0)，会 unpark()主调用线程，然后主调用线程就会从 await()函数返回，继续后余动作。 </p><p>ReentrantReadWriteLock 实现独占和共享两种方式 </p><p> 一般来说，自定义同步器要么是独占方法，要么是共享方式，他们也只需实现 tryAcquiretryRelease、tryAcquireShared-tryReleaseShared 中的一种即可。但 AQS 也支持自定义同步器同时实现独占和共享两种方式，如 ReentrantReadWriteLock。 </p><h2 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h2><p> ReentantLock 继承接口 Lock 并实现了接口中定义的方法，他是一种可重入锁，除了能完成 synchronized 所能完成的所有工作外，还提供了诸如可响应中断锁、可轮询锁请求、定时锁等避免多线程死锁的方法。 </p><p>Lock接口的主要方法 </p><ol><li><p>void lock(): 执行此方法时, 如果锁处于空闲状态, 当前线程将获取到锁. 相反, 如果锁已经被其他线程持有, 将禁用当前线程, 直到当前线程获取到锁. </p></li><li><p>boolean tryLock()：如果锁可用, 则获取锁, 并立即返回 true, 否则返回 false. 该方法和 lock()的区别在于, tryLock()只是”试图”获取锁, 如果锁不可用, 不会导致当前线程被禁用, 当前线程仍然继续往下执行代码. 而 lock()方法则是一定要获取到锁, 如果锁不可用, 就一直等待, 在未获得锁之前,当前线程并不继续向下执行. </p></li><li><p>void unlock()：执行此方法时, 当前线程将释放持有的锁. 锁只能由持有者释放, 如果线程并不持有锁, 却执行该方法, 可能导致异常的发生.</p></li><li><p>Condition newCondition()：条件对象，获取等待通知组件。该组件和当前的锁绑定，</p></li></ol><p>当前线程只有获取了锁，才能调用该组件的 await()方法，而调用后，当前线程将缩放锁。</p><ol start="5"><li><p>getHoldCount() ：查询当前线程保持此锁的次数，也就是执行此线程执行lock方法的次数。 </p></li><li><p>getQueueLength（）：返回正等待获取此锁的线程估计数，比如启动 10 个线程，1 个线程获得锁，此时返回的是 9 </p></li><li><p>getWaitQueueLength：（Condition condition）返回等待与此锁相关的给定条件的线程估计数。比如 10 个线程，用同一个 condition 对象，并且此时这 10 个线程都执行了 condition 对象的 await 方法，那么此时执行此方法返回 10 </p></li><li><p>hasWaiters(Condition condition)：查询是否有线程等待与此锁有关的给定条件</p></li></ol><p>(condition)，对于指定 contidion 对象，有多少线程执行了 condition.await 方法 </p><ol start="9"><li><p>hasQueuedThread(Thread thread)：查询给定线程是否等待获取此锁 </p></li><li><p>hasQueuedThreads()：是否有线程等待此锁</p></li><li><p>isFair()：该锁是否公平锁</p></li><li><p>isHeldByCurrentThread()： 当前线程是否保持锁锁定，线程的执行 lock 方法的前后分别是 false 和 true </p></li><li><p>isLock()：此锁是否有任意线程占用</p></li><li><p>lockInterruptibly（）：如果当前线程未被中断，获取锁</p></li><li><p>tryLock（）：尝试获得锁，仅在调用时锁未被线程占用，获得锁</p></li><li><p>tryLock(long timeout TimeUnit unit)：如果锁在给定等待时间内没有被另一个线程保持，则获取该锁。</p></li></ol><h3 id="非公平锁"><a href="#非公平锁" class="headerlink" title="非公平锁"></a>非公平锁</h3><p>JVM 按随机、就近原则分配锁的机制则称为不公平锁，ReentrantLock 在构造函数中提供了是否公平锁的初始化方式，默认为非公平锁。非公平锁实际执行的效率要远远超出公平锁，除非程序有特殊需要，否则最常用非公平锁的分配机制。</p><h3 id="公平锁"><a href="#公平锁" class="headerlink" title="公平锁"></a>公平锁</h3><p>公平锁指的是锁的分配机制是公平的，通常先对锁提出获取请求的线程会先被分配到锁，</p><p>ReentrantLock 在构造函数中提供了是否公平锁的初始化方式来定义公平锁。 </p><h3 id="ReentrantLock与synchronized"><a href="#ReentrantLock与synchronized" class="headerlink" title="ReentrantLock与synchronized"></a>ReentrantLock与synchronized</h3><ol><li><p>ReentrantLock 通过方法 lock()与 unlock()来进行加锁与解锁操作，与 synchronized 会被 JVM 自动解锁机制不同，ReentrantLock 加锁后需要手动进行解锁。为了避免程序出现异常而无法正常解锁的情况，使用 ReentrantLock 必须在 finally 控制块中进行解锁操作。</p></li><li><p>ReentrantLock 相比 synchronized 的优势是可中断、公平锁、多个锁。这种情况下需要使用 ReentrantLock。</p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.locks.Condition;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();<br>        <span class="hljs-comment">// Lock lock=new ReentrantLock(true);//公平锁</span><br>        <span class="hljs-comment">// Lock lock=new ReentrantLock(false);//非公平锁</span><br>        <span class="hljs-comment">//Condition condition = lock.newCondition();</span><br>        <span class="hljs-comment">// 创建 Condition     public void testMethod() &#123;</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            lock.lock();<span class="hljs-comment">//lock 加锁</span><br>            <span class="hljs-comment">//1：wait 方法等待：</span><br>            <span class="hljs-comment">//System.out.println(&quot;开始 wait&quot;);</span><br>            <span class="hljs-comment">// condition.await();</span><br>            <span class="hljs-comment">//通过创建 Condition 对象来使线程 wait，必须先执行 lock.lock 方法获得锁</span><br>            <span class="hljs-comment">//:2：signal 方法唤醒</span><br>            <span class="hljs-comment">//condition.signal();//condition 对象的 signal 方法可以唤醒 wait 线程</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>                System.out.println(<span class="hljs-string">&quot;ThreadName=&quot;</span> + Thread.currentThread().getName()+ (<span class="hljs-string">&quot; &quot;</span> + (i + <span class="hljs-number">1</span>)));<br>            &#125;<br><span class="hljs-comment">//        &#125; catch (InterruptedException e) &#123;</span><br><span class="hljs-comment">//            e.printStackTrace();</span><br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">MyService</span> <span class="hljs-variable">myService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyService</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                    myService.test();<br>                &#125;<br>            &#125;);<br>            thread.start();<br>        &#125;<br>    &#125;<br><br>&#125; <br></code></pre></td></tr></table></figure><h3 id="Condition类和Object类锁方法区别区别"><a href="#Condition类和Object类锁方法区别区别" class="headerlink" title="Condition类和Object类锁方法区别区别"></a>Condition类和Object类锁方法区别区别</h3><ol><li><p>Condition 类的 awiat 方法和 Object 类的 wait 方法等效 </p></li><li><p>Condition 类的 signal 方法和 Object 类的 notify 方法等效 </p></li><li><p>Condition 类的 signalAll 方法和 Object 类的 notifyAll 方法等效 </p></li><li><p>ReentrantLock 类可以唤醒指定条件的线程，而 object 的唤醒是随机的</p></li></ol><h3 id="tryLock和lock和lockInterruptibly的区别"><a href="#tryLock和lock和lockInterruptibly的区别" class="headerlink" title="tryLock和lock和lockInterruptibly的区别"></a>tryLock和lock和lockInterruptibly的区别</h3><ol><li>tryLock 能获得锁就返回 true，不能就立即返回 false，tryLock(long timeout,TimeUnit unit)，可以增加时间限制，如果超过该时间段还没获得锁，返回 false </li><li>lock 能获得锁就返回 true，不能的话一直等待获得锁 </li><li>lock 和 lockInterruptibly，如果两个线程分别执行这两个方法，但此时中断这两个线程， lock 不会抛出异常，而 lockInterruptibly 会抛出异常。</li></ol><h2 id="synchronized和-ReentrantLock-的区别"><a href="#synchronized和-ReentrantLock-的区别" class="headerlink" title="synchronized和 ReentrantLock 的区别"></a>synchronized和 <strong>ReentrantLock</strong> 的区别</h2><p>两者的共同点：</p><ol><li><p>都是用来协调多线程对共享对象、变量的访问</p></li><li><p>都是可重入锁，同一线程可以多次获得同一个锁</p></li><li><p>都保证了可见性和互斥性</p></li></ol><p>两者的不同点：</p><ol><li><p>ReentrantLock 显示的获得、释放锁，synchronized 隐式获得释放锁 </p></li><li><p>ReentrantLock 可响应中断、可轮回，synchronized 是不可以响应中断的，为处理锁的不可用性提供了更高的灵活性 </p></li><li><p>ReentrantLock 是 API 级别的，synchronized 是 JVM 级别的 </p></li><li><p>ReentrantLock 可以实现公平锁</p></li><li><p>ReentrantLock 通过 Condition 可以绑定多个条件 </p></li><li><p>底层实现不一样， synchronized 是同步阻塞，使用的是悲观并发策略，lock 是同步非阻塞，采用的是乐观并发策略 </p></li><li><p>Lock 是一个接口，而 synchronized 是 Java 中的关键字，synchronized 是内置的语言实现。 </p></li><li><p>synchronized 在发生异常时，会自动释放线程占有的锁，因此不会导致死锁现象发生；而 Lock 在发生异常时，如果没有主动通过 unLock()去释放锁，则很可能造成死锁现象，因此使用 Lock 时需要在 finally 块中释放锁。 </p></li><li><p>Lock 可以让等待锁的线程响应中断，而 synchronized 却不行，使用 synchronized 时，等待的线程会一直等待下去，不能够响应中断。 </p></li><li><p>通过 Lock 可以知道有没有成功获取锁，而 synchronized 却无法办到。</p></li><li><p>Lock 可以提高多个线程进行读操作的效率，既就是实现读写锁等。</p></li></ol><h2 id="ReadWriteLock读写锁"><a href="#ReadWriteLock读写锁" class="headerlink" title="ReadWriteLock读写锁"></a>ReadWriteLock读写锁</h2><p>为了提高性能，Java 提供了读写锁，在读的地方使用读锁，在写的地方使用写锁，灵活控制，如果没有写锁的情况下，读是无阻塞的,在一定程度上提高了程序的执行效率。读写锁分为读锁和写锁，多个读锁不互斥，读锁与写锁互斥，这是由 jvm 自己控制的，你只要上好相应的锁即可。 </p><p>读锁 </p><p>如果你的代码只读数据，可以很多人同时读，但不能同时写，那就上读锁 </p><p>写锁 </p><p>如果你的代码修改数据，只能有一个人在写，且不能同时读取，那就上写锁。总之，读的时候上读锁，写的时候上写锁！ </p><p>Java 中 读 写 锁 有 个 接 口 java.util.concurrent.locks.ReadWriteLock ， 也 有 具 体 的 实 现ReentrantReadWriteLock。 </p><h2 id="Semaphore信号量"><a href="#Semaphore信号量" class="headerlink" title="Semaphore信号量"></a>Semaphore信号量</h2><p> Semaphore 是一种基于计数的信号量。它可以设定一个阈值，基于此，多个线程竞争获取许可信号，做完自己的申请后归还，超过阈值后，线程申请许可信号将会被阻塞。Semaphore 可以用来构建一些对象池，资源池之类的，比如数据库连接池实现互斥锁（计数器为1） </p><p>我们也可以创建计数为 1 的 Semaphore，将其作为一种类似互斥锁的机制，这也叫二元信号量，表示两种互斥状态。 </p><p>代码实现它的用法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 创建一个计数阈值为 5 的信号量对象 </span><br> <span class="hljs-comment">// 只能 5 个线程同时访问 </span><br> <span class="hljs-type">Semaphore</span> <span class="hljs-variable">semp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-number">5</span>); <br> <span class="hljs-keyword">try</span> &#123; <br>  <span class="hljs-comment">// 申请许可    </span><br>    semp.acquire(); <br>   <span class="hljs-comment">// 业务逻辑 </span><br>&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123; <br> &#125; <span class="hljs-keyword">finally</span> &#123; <br>   <span class="hljs-comment">// 释放许可 </span><br>   semp.release(); <br> &#125; <br></code></pre></td></tr></table></figure><p>Semaphore 与ReentrantLock</p><p>Semaphore 基本能完成 ReentrantLock 的所有工作，使用方法也与之类似，通过 acquire()与 release()方法来获得和释放临界资源。经实测，Semaphone.acquire()方法默认为可响应中断锁，与 ReentrantLock.lockInterruptibly()作用效果一致，也就是说在等待临界资源的过程中可以被Thread.interrupt()方法中断。</p><p>此外，Semaphore 也实现了可轮询的锁请求与定时锁的功能，除了方法名 tryAcquire 与 tryLock 不同，其使用方法与ReentrantLock几乎一致。Semaphore也提供了公平与非公平锁的机制，也可在构造函数中进行设定。</p><p>Semaphore的锁释放操作也由手动进行，因此与ReentrantLock 一样，为避免线程因抛出异常而无法正常释放锁的情况发生，释放锁的操作也必须在 finally 代码块中完成。 </p><h3 id="Semaphore-类中比较重要的几个方法："><a href="#Semaphore-类中比较重要的几个方法：" class="headerlink" title="Semaphore 类中比较重要的几个方法："></a>Semaphore 类中比较重要的几个方法：</h3><ol><li><p>public void acquire(): 用来获取一个许可，若无许可能够获得，则会一直等待，直到获得许可。 </p></li><li><p>public void acquire(int permits):获取 permits 个许可 </p></li><li><p>public void release() { } :释放许可。注意，在释放许可之前，必须先获获得许可。 </p></li><li><p>public void release(int permits) { }:释放 permits 个许可</p></li></ol><p>上面 4 个方法都会被阻塞，如果想立即得到执行结果，可以使用下面几个方法</p><ol><li><p>public boolean tryAcquire():尝试获取一个许可，若获取成功，则立即返回 true，若获取失败，则立即返回 false </p></li><li><p>public boolean tryAcquire(long timeout, TimeUnit unit):尝试获取一个许可，若在指定的时间内获取成功，则立即返回 true，否则则立即返回 false </p></li><li><p>public boolean tryAcquire(int permits):尝试获取 permits 个许可，若获取成功，则立即返回 true，若获取失败，则立即返回 false </p></li><li><p>public boolean tryAcquire(int permits, long timeout, TimeUnit unit): 尝试获取 permits 个许可，若在指定的时间内获取成功，则立即返回 true，否则则立即返回 false </p></li><li><p>还可以通过 availablePermits()方法得到可用的许可数目。</p></li></ol><h2 id="CyclicBarrier、CountDownLatch的用法"><a href="#CyclicBarrier、CountDownLatch的用法" class="headerlink" title="CyclicBarrier、CountDownLatch的用法"></a>CyclicBarrier、CountDownLatch的用法</h2><p>CountDownLatch（线程计数器 ）</p><p>CountDownLatch类位于java.util.concurrent包下，利用它可以实现类似计数器的功能。比如有一个任务 A，它要等待其他 4 个任务执行完毕之后才能执行，此时就可以利用 CountDownLatch 来实现这种功能了。 </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>    <span class="hljs-keyword">final</span> <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">2</span>);           <br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>()&#123;<br>      <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123; <br>        System.out.println(<span class="hljs-string">&quot;子线程&quot;</span>+Thread.currentThread().getName()+<span class="hljs-string">&quot;正在执行&quot;</span>); <br>        Thread.sleep(<span class="hljs-number">3000</span>); <br>        System.out.println(<span class="hljs-string">&quot;子线程&quot;</span>+Thread.currentThread().getName()+<span class="hljs-string">&quot;执行完毕&quot;</span>); <br>        latch.countDown(); <br>      &#125;<br>    &#125;.start(); <br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>()&#123; <br>      <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123; <br>        System.out.println(<span class="hljs-string">&quot;子线程&quot;</span>+Thread.currentThread().getName()+<span class="hljs-string">&quot;正在执行&quot;</span>); <br>        Thread.sleep(<span class="hljs-number">3000</span>); <br>        System.out.println(<span class="hljs-string">&quot;子线程&quot;</span>+Thread.currentThread().getName()+<span class="hljs-string">&quot;执行完毕&quot;</span>); <br>        latch.countDown(); <br>     &#125;<br>    &#125;.start();   <br>    System.out.println(<span class="hljs-string">&quot;等待 2 个子线程执行完毕...&quot;</span>); <br>    latch.await(); <br>    System.out.println(<span class="hljs-string">&quot;2 个子线程已经执行完毕&quot;</span>); <br>    System.out.println(<span class="hljs-string">&quot;继续执行主线程&quot;</span>); <br>&#125; <br></code></pre></td></tr></table></figure><p> CyclicBarrier（回环栅栏-等待至 barrier 状态再全部同时执行）</p><p>字面意思回环栅栏，通过它可以实现让一组线程等待至某个状态之后再全部同时执行。叫做回环是因为当所有等待线程都被释放以后，CyclicBarrier 可以被重用。我们暂且把这个状态就叫做 barrier，当调用 await()方法之后，线程就处于 barrier 了。 </p><p>CyclicBarrier 中最重要的方法就是 await 方法，它有 2 个重载版本： </p><ol><li><p>public int await()：用来挂起当前线程，直至所有线程都到达 barrier 状态再同时执行后续任务；</p></li><li><p>public int await(long timeout, TimeUnit unit)：让这些线程等待至一定的时间，如果还有线程没有到达 barrier 状态就直接让到达 barrier 的线程执行后续任务。</p></li></ol><p>具体使用如下，另外 CyclicBarrier 是可以重用的。 </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>       <span class="hljs-type">int</span> <span class="hljs-variable">N</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;<br>       <span class="hljs-type">CyclicBarrier</span> <span class="hljs-variable">barrier</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CyclicBarrier</span>(N);<br>       <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; N; i++) <span class="hljs-keyword">new</span> <span class="hljs-title class_">Writer</span>(barrier).start();<br>   &#125;<br><br>   <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Writer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>       <span class="hljs-keyword">private</span> CyclicBarrier cyclicBarrier;<br><br>       <span class="hljs-keyword">public</span> <span class="hljs-title function_">Writer</span><span class="hljs-params">(CyclicBarrier cyclicBarrier)</span> &#123;<br>           <span class="hljs-built_in">this</span>.cyclicBarrier = cyclicBarrier;<br>       &#125;<br><br>       <span class="hljs-meta">@Override</span><br>       <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>           <span class="hljs-keyword">try</span> &#123;<br>               Thread.sleep(<span class="hljs-number">5000</span>);      <span class="hljs-comment">//以睡眠来模拟线程需要预定写入数据操作 System.out.println(&quot;线程&quot;+Thread.currentThread().getName()+&quot;写入数据完毕，等待其他线程写入完毕&quot;);</span><br>               cyclicBarrier.await();<br>           &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>               e.printStackTrace();<br>           &#125; <span class="hljs-keyword">catch</span> (BrokenBarrierException e) &#123;<br>               e.printStackTrace();<br>           &#125;<br>           System.out.println(<span class="hljs-string">&quot;所有线程写入完毕，继续处理其他任务，比如数据操作&quot;</span>);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><h2 id="ConcurrentHashMap-并发集合"><a href="#ConcurrentHashMap-并发集合" class="headerlink" title="ConcurrentHashMap 并发集合"></a>ConcurrentHashMap 并发集合</h2><h3 id="减小锁粒度-1"><a href="#减小锁粒度-1" class="headerlink" title="减小锁粒度"></a>减小锁粒度</h3><p>减小锁粒度是指缩小锁定对象的范围，从而减小锁冲突的可能性，从而提高系统的并发能力。减小锁粒度是一种削弱多线程锁竞争的有效手段，这种技术典型的应用是 ConcurrentHashMap(高性能的 HashMap)类的实现。对于 HashMap 而言，最重要的两个方法是 get 与 set 方法，如果我们对整个 HashMap 加锁，可以得到线程安全的对象，但是加锁粒度太大。Segment 的大小也被称为 ConcurrentHashMap 的并发度。 </p><h3 id="ConcurrentHashMap分段锁"><a href="#ConcurrentHashMap分段锁" class="headerlink" title="ConcurrentHashMap分段锁"></a>ConcurrentHashMap分段锁</h3><p>ConcurrentHashMap，它内部细分了若干个小的 HashMap，称之为段(Segment)。默认情况下一个 ConcurrentHashMap 被进一步细分为 16 个段，既就是锁的并发度。 </p><p>如果需要在 ConcurrentHashMap 中添加一个新的表项，并不是将整个 HashMap 加锁，而是首先根据hashcode得到该表项应该存放在哪个段中，然后对该段加锁，并完成put操作。在多线程环境中，如果多个线程同时进行put操作，只要被加入的表项不存放在同一个段中，则线程间可以做到真正的并行。 </p><p>ConcurrentHashMap 是由Segment数组结构和HashEntry数组结构组成 </p><p>ConcurrentHashMap 是由 Segment 数组结构和 HashEntry 数组结构组成。Segment 是一种可重入锁 ReentrantLock，在 ConcurrentHashMap 里扮演锁的角色，HashEntry 则用于存储键值对数据。一个 ConcurrentHashMap 里包含一个 Segment 数组，Segment 的结构和 HashMap 类似，是一种数组和链表结构， 一个 Segment 里包含一个 HashEntry 数组，每个 HashEntry 是一个链表结构的元素， 每个 Segment 守护一个 HashEntry 数组里的元素,当对 HashEntry 数组的数据进行修改时，必须首先获得它对应的 Segment 锁。 </p><h2 id="什么是CAS（比较并交换-乐观锁机制-锁自旋）"><a href="#什么是CAS（比较并交换-乐观锁机制-锁自旋）" class="headerlink" title="什么是CAS（比较并交换-乐观锁机制-锁自旋）"></a>什么是CAS（比较并交换-乐观锁机制-锁自旋）</h2><h3 id="概念及特性"><a href="#概念及特性" class="headerlink" title="概念及特性"></a>概念及特性</h3><p>CAS（Compare And Swap&#x2F;Set）比较并交换，CAS过程是这样：它包含 3 个参数 CAS(V,E,N)。V 表示要更新的变量(内存值)，E 表示预期值(旧的)，N 表示新值。当且仅当 V 值等于 E 值时，才会将 V 的值设为 N，如果 V 值和 E 值不同，则说明已经有其他线程做了更新，则当前线程什么都不做。最后，CAS 返回当前 V 的真实值。 </p><p>CAS 操作是抱着乐观的态度进行的(乐观锁)，它总是认为自己可以成功完成操作。当多个线程同时使用 CAS 操作一个变量时，只有一个会胜出，并成功更新，其余均会失败。失败的线程不会被挂起，仅是被告知失败，并且允许再次尝试，当然也允许失败的线程放弃操作。基于这样的原理，</p><p>CAS 操作即使没有锁，也可以发现其他线程对当前线程的干扰，并进行恰当的处理。 </p><p>原子包 java.util.concurrent.atomic（锁自旋）</p><p>JDK1.5 的原子包：java.util.concurrent.atomic 这个包里面提供了一组原子类。其基本的特性就是在多线程环境下，当有多个线程同时执行这些类的实例包含的方法时，具有排他性，即当某个线程进入方法，执行其中的指令时，不会被其他线程打断，而别的线程就像自旋锁一样，一直等</p><p>到该方法执行完成，才由 JVM 从等待队列中选择一个另一个线程进入，这只是一种逻辑上的理解。</p><p>相对于对于 synchronized 这种阻塞算法，CAS 是非阻塞算法的一种常见实现。由于一般 CPU 切换时间比 CPU 指令集操作更加长， 所以 J.U.C 在性能上有了很大的提升。如下代码： </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicInteger</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Number</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">java</span>.io.Serializable &#123;   <br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> value;  <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;           <br>        <span class="hljs-keyword">return</span> value;   <br>     &#125;   <br>     <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAndIncrement</span><span class="hljs-params">()</span> &#123;   <br>        <span class="hljs-keyword">for</span> (;;) &#123;  <br>        <span class="hljs-comment">//CAS 自旋，一直尝试，直达成功 </span><br>           <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> get();           <br>           <span class="hljs-type">int</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> current + <span class="hljs-number">1</span>;          <br>           <span class="hljs-keyword">if</span> (compareAndSet(current, next))   <span class="hljs-keyword">return</span> current;   <br>        &#125;   <br>    &#125;   <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSet</span><span class="hljs-params">(<span class="hljs-type">int</span> expect, <span class="hljs-type">int</span> update)</span> &#123;         <br>    <span class="hljs-keyword">return</span> unsafe.compareAndSwapInt(<span class="hljs-built_in">this</span>, valueOffset, expect, update);   <br>    &#125;   <br>&#125; <br></code></pre></td></tr></table></figure><p>getAndIncrement 采用了 CAS 操作，每次从内存中读取数据然后将此数据和+1 后的结果进行 CAS 操作，如果成功就返回结果，否则重试直到成功为止。而 compareAndSet 利用 JNI 来完成。</p><p>CPU 指令的操作：</p><p><img src="/.com//CAS%E6%8C%87%E4%BB%A4.png" alt="CAS指令"></p><h3 id="ABA问题"><a href="#ABA问题" class="headerlink" title="ABA问题"></a>ABA问题</h3><p>CAS 会导致“ABA 问题”。CAS 算法实现一个重要前提需要取出内存中某时刻的数据，而在下时刻比较并替换，那么在这个时间差类会导致数据的变化。 </p><p>比如说一个线程 one 从内存位置 V 中取出 A，这时候另一个线程 two 也从内存中取出 A，并且 two 进行了一些操作变成了 B，然后 two 又将 V 位置的数据变成 A，这时候线程 one 进行 CAS 操作发现内存中仍然是 A，然后 one 操作成功。尽管线程 one 的 CAS 操作成功，但是不代表这个过程就是没有问题的。 </p><p>部分乐观锁的实现是通过版本号（version）的方式来解决 ABA 问题，乐观锁每次在执行数据的修改操作时，都会带上一个版本号，一旦版本号和数据的版本号一致就可以执行修改操作并对版本号执行+1 操作，否则就执行失败。因为每次操作的版本号都会随之增加，所以不会出现 ABA 问题，因为版本号只会增加不会减少。</p><h3 id="AtomicInteger"><a href="#AtomicInteger" class="headerlink" title="AtomicInteger"></a>AtomicInteger</h3><p>首先说明，此处 AtomicInteger，一个提供原子操作的 Integer 的类，常见的还有AtomicBoolean、AtomicInteger、AtomicLong、AtomicReference 等，他们的实现原理相同，区别在与运算对象类型的不同。令人兴奋地，还可以通过 AtomicReference<V>将一个对象的所有操作转化成原子操作。 </V></p><p>我们知道，在多线程程序中，诸如++i 或 i++等运算不具有原子性，是不安全的线程操作之一。通常我们会使用 synchronized 将该操作变成一个原子操作，但 JVM 为此类操作特意提供了一些同步类，使得使用更方便，且使程序运行效率变得更高。通过相关资料显示，通常AtomicInteger 的性能是 ReentantLock 的好几倍。 </p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring_boot_config实践</title>
    <link href="/2022/06/30/spring_cloud/spring_cloud_config%E5%AE%9E%E8%B7%B5/"/>
    <url>/2022/06/30/spring_cloud/spring_cloud_config%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>官网:  <a href="https://docs.spring.io/spring-cloud-config/docs/current/reference/html/">https://docs.spring.io/spring-cloud-config/docs/current/reference/html/</a></p><p>springcloud config 项目是一个解决分布式系统的配置管理方案。</p><p>服务多、环境多、改配置不停服。</p><p><img src="/.com//spring_cloud_config%E4%B8%9A%E5%8A%A1%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="spring_cloud_config业务架构图"></p><p>springcloud config 分为服务端和客户端，服务端负责将本地 git 或者 svn 中存储的配置文件发布成 REST 风格的接口，客户端可以从服务端 REST 接口获取配置。但客户端并不能主动感知到配置的变化，从而主动去获取新的配置，这需要每个客户端通过 POST 方法触发各自的 &#x2F;refresh 接口。</p><h1 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h1><p>匹配规则</p><figure class="highlight dts"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><pre><code class="hljs dts"><span class="hljs-title class_">/</span><span class="hljs-punctuation">&#123;</span>application<span class="hljs-punctuation">&#125;</span>/<span class="hljs-punctuation">&#123;</span>profile<span class="hljs-punctuation">&#125;</span>[/<span class="hljs-punctuation">&#123;</span>label<span class="hljs-punctuation">&#125;</span>]<br><span class="hljs-title class_">/</span><span class="hljs-punctuation">&#123;</span>application<span class="hljs-punctuation">&#125;</span>-<span class="hljs-punctuation">&#123;</span>profile<span class="hljs-punctuation">&#125;</span>.yml<br><span class="hljs-title class_">/</span><span class="hljs-punctuation">&#123;</span>label<span class="hljs-punctuation">&#125;</span>/<span class="hljs-punctuation">&#123;</span>application<span class="hljs-punctuation">&#125;</span>-<span class="hljs-punctuation">&#123;</span>profile<span class="hljs-punctuation">&#125;</span>.yml<br><span class="hljs-title class_">/</span><span class="hljs-punctuation">&#123;</span>application<span class="hljs-punctuation">&#125;</span>-<span class="hljs-punctuation">&#123;</span>profile<span class="hljs-punctuation">&#125;</span>.properties<br><span class="hljs-title class_">/</span><span class="hljs-punctuation">&#123;</span>label<span class="hljs-punctuation">&#125;</span>/<span class="hljs-punctuation">&#123;</span>application<span class="hljs-punctuation">&#125;</span>-<span class="hljs-punctuation">&#123;</span>profile<span class="hljs-punctuation">&#125;</span>.properties<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">curl localhost:8888/foo/development<br>curl localhost:8888/foo/development/master<br>curl localhost:8888/foo/development,db/master<br>curl localhost:8888/foo-development.yml<br>curl localhost:8888/foo-db.properties<br>curl localhost:8888/master/foo-db.properties<br></code></pre></td></tr></table></figure><p>application 服务名称<br>profile 环境名称，开发、测试、生产：dev qa prd<br>lable 仓库分支、默认master分支</p><p>匹配原则：从前缀开始。</p><h2 id="创建git仓库"><a href="#创建git仓库" class="headerlink" title="创建git仓库"></a>创建git仓库</h2><p>创建仓库config_center</p><p>创建配置文件 eureka-dev.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">eureka</span><br><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8761</span><br><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">localhost</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-comment">#设置服务注册中心的URL</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span><br><br><span class="hljs-attr">management:</span><br>  <span class="hljs-attr">endpoints:</span><br>    <span class="hljs-attr">web:</span><br>      <span class="hljs-attr">exposure:</span><br>        <span class="hljs-attr">include:</span> <span class="hljs-string">&#x27;*&#x27;</span><br></code></pre></td></tr></table></figure><p>创建配置文件 eureka-test.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">eureka</span><br><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8762</span><br><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">localhost</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-comment">#设置服务注册中心的URL</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span><br><br><span class="hljs-attr">management:</span><br>  <span class="hljs-attr">endpoints:</span><br>    <span class="hljs-attr">web:</span><br>      <span class="hljs-attr">exposure:</span><br>        <span class="hljs-attr">include:</span> <span class="hljs-string">&#x27;*&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="创建config-server"><a href="#创建config-server" class="headerlink" title="创建config-server"></a>创建config-server</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9001</span><br><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">config-server</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">server:</span><br>        <span class="hljs-attr">git:</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">https://gitee.com/doufengle/config_center.git</span><br>          <span class="hljs-attr">username:</span> <span class="hljs-string">xxxx</span><br>          <span class="hljs-attr">password:</span> <span class="hljs-string">xxxx</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-comment"># 刷新注册表的间隔时间</span><br>    <span class="hljs-attr">registry-fetch-interval-seconds:</span> <span class="hljs-number">5</span><br>    <span class="hljs-attr">serviceUrl:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:8761/eureka/</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-comment"># 心跳续约间隔</span><br>    <span class="hljs-attr">lease-renewal-interval-in-seconds:</span> <span class="hljs-number">10</span><br>    <span class="hljs-comment"># 告诉server在接收到实例的最后一次发出的心跳后，需要等待多久才可以将此实例删除,默认90秒</span><br>    <span class="hljs-attr">lease-expiration-duration-in-seconds:</span> <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableConfigServer</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigServerApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(ConfigServerApplication.class, args);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>测试接口：</p><p><a href="http://localhost:9001/eureka-dev.yml">http://localhost:9001/eureka-dev.yml</a></p><p><a href="http://localhost:9001/eureka-test.yml">http://localhost:9001/eureka-test.yml</a></p><h2 id="创建config-client（固定地址）"><a href="#创建config-client（固定地址）" class="headerlink" title="创建config-client（固定地址）"></a>创建config-client（固定地址）</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-config-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>修改 application配置文件为bootstrap配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">eureka</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:9001/</span><br>      <span class="hljs-attr">profile:</span> <span class="hljs-string">$&#123;spring.profiles.active&#125;</span><br>      <span class="hljs-attr">label:</span> <span class="hljs-string">master</span><br></code></pre></td></tr></table></figure><p>这时启动着 config-server、 再启动eureka-server。</p><p>发现启动端口为8761。</p><p>更改 active: dev 为 test时启动端口为8762。</p><h2 id="创建config-client-（eureka）"><a href="#创建config-client-（eureka）" class="headerlink" title="创建config-client （eureka）"></a>创建config-client （eureka）</h2><p>创建service-b-dev.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-comment">#zipkin</span><br>  <span class="hljs-attr">zipkin:</span><br>    <span class="hljs-attr">base-url:</span> <span class="hljs-string">http://localhost:9411/</span><br>    <span class="hljs-comment">#采样比例1</span><br>  <span class="hljs-attr">sleuth:</span><br>    <span class="hljs-attr">sampler:</span><br>      <span class="hljs-attr">rate:</span> <span class="hljs-number">1</span><br><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8763</span><br><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">serviceUrl:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:8761/eureka/</span><br><br><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">level:</span><br>    <span class="hljs-attr">root:</span> <span class="hljs-string">DEBUG</span><br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-config-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Service-b 项目修改 application配置文件为bootstrap配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">service-b</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">profile:</span> <span class="hljs-string">$&#123;spring.profiles.active&#125;</span><br>      <span class="hljs-attr">label:</span> <span class="hljs-string">master</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">service-id:</span> <span class="hljs-string">config-server</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-string">on</span><br></code></pre></td></tr></table></figure><p>启动service-b服务。</p><h2 id="刷新"><a href="#刷新" class="headerlink" title="刷新"></a>刷新</h2><h3 id="手动刷新"><a href="#手动刷新" class="headerlink" title="手动刷新"></a>手动刷新</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>service-b-dev.yml 添加  开启actuator中的refresh端点</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-comment">#zipkin</span><br>  <span class="hljs-attr">zipkin:</span><br>    <span class="hljs-attr">base-url:</span> <span class="hljs-string">http://localhost:9411/</span><br>    <span class="hljs-comment">#采样比例1</span><br>  <span class="hljs-attr">sleuth:</span><br>    <span class="hljs-attr">sampler:</span><br>      <span class="hljs-attr">rate:</span> <span class="hljs-number">1</span><br><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8763</span><br><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">serviceUrl:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:8761/eureka/</span><br><br><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">level:</span><br>    <span class="hljs-attr">root:</span> <span class="hljs-string">DEBUG</span><br><br><span class="hljs-attr">management:</span><br>  <span class="hljs-attr">endpoints:</span><br>    <span class="hljs-attr">web:</span><br>      <span class="hljs-attr">exposure:</span><br>        <span class="hljs-attr">include:</span> <span class="hljs-string">&#x27;*&#x27;</span><br></code></pre></td></tr></table></figure><p>Controller中添加@RefreshScope注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RefreshScope</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span><br>    String port;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ServiceaClient serviceaClient;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/test1&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;i am service b from port:&quot;</span> + port;<br>    &#125;<br><br><br>    <span class="hljs-meta">@RequestMapping(&quot;/test3&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test3</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;i am service b from port:&quot;</span> + port;<br>    &#125;<br><br><br>    <span class="hljs-meta">@RequestMapping(&quot;/test2&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;调用:&quot;</span> + serviceaClient.test();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>调用接口  <a href="http://localhost:8763/test/test1">http://localhost:8763/test/test1</a></p><p>显示 8763端口</p><p>修改 git仓库中的端口 8764。</p><p>刷新接口调用：<a href="http://localhost:8764/actuator/refresh">http://localhost:8764/actuator/refresh</a>   post</p><p><a href="http://localhost:8763/test/test1">http://localhost:8763/test/test1</a></p><p>显示8764端口。</p><h3 id="自动刷新"><a href="#自动刷新" class="headerlink" title="自动刷新"></a>自动刷新</h3><h4 id="erlang安装"><a href="#erlang安装" class="headerlink" title="erlang安装"></a>erlang安装</h4><p><a href="http://www.erlang.org/downloads">http://www.erlang.org/downloads</a></p><h4 id="RabbitMQ安装"><a href="#RabbitMQ安装" class="headerlink" title="RabbitMQ安装"></a>RabbitMQ安装</h4><p><a href="https://www.rabbitmq.com/install-generic-unix.html">https://www.rabbitmq.com/install-generic-unix.html</a></p><h4 id="mac-安装"><a href="#mac-安装" class="headerlink" title="mac 安装"></a>mac 安装</h4><p>安装</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">brew install rabbitmq<br></code></pre></td></tr></table></figure><p>启动</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">brew services start rabbitmq;<br></code></pre></td></tr></table></figure><p>管理界面</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">rabbitmq-plugins <span class="hljs-built_in">enable</span> rabbitmq_management<br></code></pre></td></tr></table></figure><p>相关端口</p><p>端口说明<br>5672RabbitMQ的通讯端口<br>25672RabbitMQ的节点间的CLI通讯端口<br>15672RabbitMQ HTTP_API的端口，管理员用户才能访问，用于管理RabbitMQ,需要启动Management插件<br>1883，8883MQTT插件启动时的端口<br>61613、61614STOMP客户端插件启用的时候的端口<br>15674、15675基于webscoket的STOMP端口和MOTT端口</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#新建用户</span><br>rabbitmqctl add_user 账号 密码<br><span class="hljs-comment">#给用户分配操作权限</span><br>rabbitmqctl set_user_tags 账号 administrator<br><span class="hljs-comment">#修改密码</span><br>rabbitmqctl change_password Username Newpassword 修改密码<br><span class="hljs-comment">#删除用户</span><br>rabbitmqctl delete_user Username 删除用户<br><span class="hljs-comment">#查看所有用户</span><br>rabbitmqctl list_users 查看用户清单<br><span class="hljs-comment">#为用户设置访问权限</span><br>rabbitmqctl set_permissions -p / 用户名 <span class="hljs-string">&quot;.*&quot;</span> <span class="hljs-string">&quot;.*&quot;</span> <span class="hljs-string">&quot;.*&quot;</span> <br>rabbitmqctl set_permissions -p / root <span class="hljs-string">&quot;.*&quot;</span> <span class="hljs-string">&quot;.*&quot;</span> <span class="hljs-string">&quot;.*&quot;</span><br></code></pre></td></tr></table></figure><p><strong>用户权限</strong></p><table><thead><tr><th>角色</th><th>权限</th></tr></thead><tbody><tr><td>administrator</td><td>可以登录控制台、查看所有信息、可以对rabbitmq进行管理</td></tr><tr><td>monitoring</td><td>监控者，登录控制台，查看所有信息</td></tr><tr><td>policymaker</td><td>策略制定者，登录控制台，指定策略</td></tr><tr><td>managment</td><td>普通管理员，登录控制台</td></tr></tbody></table><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>Config-server</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9001</span><br><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">config-server</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">server:</span><br>        <span class="hljs-attr">git:</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">https://gitee.com/doufengle/config_center.git</span><br>          <span class="hljs-attr">username:</span> <span class="hljs-string">xxxx</span><br>          <span class="hljs-attr">password:</span> <span class="hljs-string">xxxx</span><br>  <span class="hljs-comment"># rabbitmq 地址配置</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-comment"># 刷新注册表的间隔时间</span><br>    <span class="hljs-attr">registry-fetch-interval-seconds:</span> <span class="hljs-number">5</span><br>    <span class="hljs-attr">serviceUrl:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:8761/eureka/</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-comment"># 心跳续约间隔</span><br>    <span class="hljs-attr">lease-renewal-interval-in-seconds:</span> <span class="hljs-number">10</span><br>    <span class="hljs-comment"># 告诉server在接收到实例的最后一次发出的心跳后，需要等待多久才可以将此实例删除,默认90秒</span><br>    <span class="hljs-attr">lease-expiration-duration-in-seconds:</span> <span class="hljs-number">10</span><br><br><span class="hljs-attr">management:</span><br>  <span class="hljs-attr">endpoints:</span><br>    <span class="hljs-attr">web:</span><br>      <span class="hljs-attr">exposure:</span><br>        <span class="hljs-attr">include:</span> <span class="hljs-string">&quot;*&quot;</span><br></code></pre></td></tr></table></figure><p>启动config-server服务。</p><p>访问<a href="http://localhost:15672/#/queues">http://localhost:15672/#/queues</a>  ,mq会有一条临时队列。</p><p>客户端配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>bootstrapyaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">service-b</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">profile:</span> <span class="hljs-string">$&#123;spring.profiles.active&#125;</span><br>      <span class="hljs-attr">label:</span> <span class="hljs-string">master</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">service-id:</span> <span class="hljs-string">config-server</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-string">on</span><br></code></pre></td></tr></table></figure><p>service-b-dev.yml  添加rabbitmq</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-comment">#zipkin</span><br>  <span class="hljs-attr">zipkin:</span><br>    <span class="hljs-attr">base-url:</span> <span class="hljs-string">http://localhost:9411/</span><br>    <span class="hljs-comment">#采样比例1</span><br>  <span class="hljs-attr">sleuth:</span><br>    <span class="hljs-attr">sampler:</span><br>      <span class="hljs-attr">rate:</span> <span class="hljs-number">1</span><br>  <span class="hljs-comment"># rabbitmq 地址配置</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8763</span><br><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">serviceUrl:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:8761/eureka/</span><br><br><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">level:</span><br>    <span class="hljs-attr">root:</span> <span class="hljs-string">DEBUG</span><br><br><span class="hljs-attr">management:</span><br>  <span class="hljs-attr">endpoints:</span><br>    <span class="hljs-attr">web:</span><br>      <span class="hljs-attr">exposure:</span><br>        <span class="hljs-attr">include:</span> <span class="hljs-string">&#x27;*&#x27;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RefreshScope</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span><br>    String port;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ServiceaClient serviceaClient;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/test1&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;i am service b from port:&quot;</span> + port;<br>    &#125;<br><br><br>    <span class="hljs-meta">@RequestMapping(&quot;/test3&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test3</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;i am service b from port:&quot;</span> + port;<br>    &#125;<br><br><br>    <span class="hljs-meta">@RequestMapping(&quot;/test2&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;调用:&quot;</span> + serviceaClient.test();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="webhooks实现自动刷新配置"><a href="#webhooks实现自动刷新配置" class="headerlink" title="webhooks实现自动刷新配置"></a>webhooks实现自动刷新配置</h4><p>在git 的webhooks配置自动刷新的地址。(配置config-server的<a href="http://localhost:9001/actuator/bus-refresh">http://localhost:9001/actuator/bus-refresh</a>)</p><h4 id="单个服务通知"><a href="#单个服务通知" class="headerlink" title="单个服务通知"></a>单个服务通知</h4><p>发送 post请求  <a href="http://localhost:8763/actuator/bus-refresh">http://localhost:8763/actuator/bus-refresh</a>  至单个服务的端点。</p>]]></content>
    
    
    <categories>
      
      <category>spring_cloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring_cloud</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring_boot_sleuth实践</title>
    <link href="/2022/06/30/spring_cloud/spring_cloud_sleuth%E5%AE%9E%E8%B7%B5/"/>
    <url>/2022/06/30/spring_cloud/spring_cloud_sleuth%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>官网: <a href="https://docs.spring.io/spring-cloud-sleuth/docs/current/reference/html/">https://docs.spring.io/spring-cloud-sleuth/docs/current/reference/html/</a></p><p>Sleuth是Spring cloud的分布式跟踪解决方案。</p><p>提供链路追踪:  通过sleuth可以很清楚的看出一个请求经过了哪些服务，可以方便的理清服务局的调用关系。<br>性能分析:  通过sleuth可以很方便的看出每个采集请求的耗时，分析出哪些服务调用比较耗时，当服务调用的耗时。随着请求量的增大而增大时，也可以对服务的扩容提供一定的提醒作用。<br>数据分析、优化链路：对于频繁地调用一个服务，或者并行地调用等，可以针对业务做一些优化措施。<br>可视化：对于程序未捕获的异常，可以在zipkpin界面上看到。</p><h1 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h1><ol><li><p>span(跨度)，基本工作单元。一次链路调用，创建一个span，</p><p>span用一个64位id唯一标识。包括：id，描述，时间戳事件，spanId,span父id。</p><p>span被启动和停止时，记录了时间信息，初始化span叫：root span，它的span id和trace id相等。</p></li><li><p>trace(跟踪)，一组共享“root span”的span组成的树状结构 称为 trace，trace也有一个64位ID，trace中所有span共享一个trace id。类似于一颗 span 树。</p></li><li><p>annotation（标签），annotation用来记录事件的存在，其中，核心annotation用来定义请求的开始和结束。</p><ul><li>CS(Client Send客户端发起请求)。客户端发起请求描述了span开始。</li><li>SR(Server Received服务端接到请求)。服务端获得请求并准备处理它。SR-CS&#x3D;网络延迟。</li><li>SS（Server Send服务器端处理完成，并将结果发送给客户端）。表示服务器完成请求处理，响应客户端时。SS-SR&#x3D;服务器处理请求的时间。</li><li>CR（Client Received 客户端接受服务端信息）。span结束的标识。客户端接收到服务器的响应。CR-CS&#x3D;客户端发出请求到服务器响应的总时间。</li></ul></li></ol><p>其实数据结构是一颗树，从root span 开始</p><p><img src="/.com//spring_cloud_sleuth%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B.jpeg" alt="spring_cloud_sleuth调用流程"></p><h1 id="搭建sleuth"><a href="#搭建sleuth" class="headerlink" title="搭建sleuth"></a>搭建sleuth</h1><p>Gateway、sevice-a、service-b添加以下依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>启动eureka、service-a、service-b、gateway</p><p>调用<a href="http://localhost:9000/service-a/test2">http://localhost:9000/service-a/test2</a></p><p>gateway服务</p><p>TRACE [gateway,4c3632900494bee6,4c3632900494bee6,true]</p><p>service-a服务</p><p>DEBUG [service-a,4c3632900494bee6,3cbbc2dd6e73f7c4,true]</p><p>service-b服务</p><p>DEBUG [service-b,4c3632900494bee6,f0fcaca12060dc88,true]</p><p>[服务名称，traceId（一条请求调用链中 唯一ID），spanID（基本的工作单元，获取数据等），是否让zipkin收集和展示此信息]</p><h2 id="添加zipkin"><a href="#添加zipkin" class="headerlink" title="添加zipkin"></a>添加zipkin</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-comment">#zipkin</span><br>  <span class="hljs-attr">zipkin:</span><br>    <span class="hljs-attr">base-url:</span> <span class="hljs-string">http://localhost:9411/</span><br>    <span class="hljs-comment">#采样比例1</span><br>  <span class="hljs-attr">sleuth:</span><br>    <span class="hljs-attr">sampler:</span><br>      <span class="hljs-attr">rate:</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h2 id="下载zipkin-server"><a href="#下载zipkin-server" class="headerlink" title="下载zipkin server"></a>下载zipkin server</h2><p>官网 <a href="https://zipkin.io/">https://zipkin.io/</a></p><p>入门：<a href="https://zipkin.io/pages/quickstart">https://zipkin.io/pages/quickstart</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">curl -sSL https://zipkin.io/quickstart.sh | bash -s<br>java -jar zipkin.jar<br></code></pre></td></tr></table></figure><p>这时访问：<a href="http://localhost:9000/service-a/test2">http://localhost:9000/service-a/test2</a></p><p>再访问<a href="http://localhost:9411/">http://localhost:9411/</a></p><p>点击：找到一个痕迹。再点击 run query。发现一个trace。点击show。</p><h1 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h1><p>sleuth收集跟踪信息通过http请求发送给zipkin server，zipkin将跟踪信息存储，以及提供RESTful API接口，zipkin ui通过调用api进行数据展示。</p><p>默认内存存储，可以用mysql，ES等存储。</p>]]></content>
    
    
    <categories>
      
      <category>spring_cloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring_cloud</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring_boot_admin实践</title>
    <link href="/2022/06/28/spring_cloud/spring_boot_admin%E5%AE%9E%E8%B7%B5/"/>
    <url>/2022/06/28/spring_cloud/spring_boot_admin%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>官网: <a href="https://github.com/codecentric/spring-boot-admin">https://github.com/codecentric/spring-boot-admin</a></p><p>官网入门: <a href="https://codecentric.github.io/spring-boot-admin/2.5.1/#getting-started">https://codecentric.github.io/spring-boot-admin/2.5.1/#getting-started</a></p><p>spring boot admin是一个非常好用的监控和管理的开源软件。该软件能够将 Actuator 中的信息进行界面化的展示，也可以监控所有 Spring Boot 应用的健康状况，提供实时警报功能。</p><p><strong>主要的功能点有：</strong></p><ul><li>显示应用程序的监控状态</li><li>应用程序上下线监控</li><li>查看 JVM，线程信息</li><li>可视化的查看日志以及下载日志文件</li><li>动态切换日志级别</li><li>Http 请求信息跟踪</li><li>其他功能点……</li></ul><h1 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h1><h2 id="搭建server"><a href="#搭建server" class="headerlink" title="搭建server"></a>搭建server</h2><p>使用spring init工具添加依赖  admin-server</p><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>de.codecentric<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-admin-starter-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.netty<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>netty-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>spring boot 启动类添加  @EnableAdminServer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableAdminServer</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdminApplication</span> &#123;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>SpringApplication.run(AdminApplication.class, args);<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br></code></pre></td></tr></table></figure><h2 id="搭建client"><a href="#搭建client" class="headerlink" title="搭建client"></a>搭建client</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>de.codecentric<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-admin-starter-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 修改Admin Server的地址</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">boot:</span><br>    <span class="hljs-attr">admin:</span><br>      <span class="hljs-attr">client:</span><br>        <span class="hljs-attr">url:</span> <span class="hljs-string">http://localhost:8080</span><br><br><span class="hljs-comment"># 打开客户端Actuator的监控</span><br><span class="hljs-attr">management:</span><br>  <span class="hljs-attr">endpoints:</span><br>    <span class="hljs-attr">web:</span><br>      <span class="hljs-attr">exposure:</span><br>        <span class="hljs-attr">include:</span> <span class="hljs-string">&#x27;*&#x27;</span><br></code></pre></td></tr></table></figure><p>启动server、 client后访问<a href="http://localhost:8080/">http://localhost:8080/</a></p><h2 id="搭建从eureka-server获取的server"><a href="#搭建从eureka-server获取的server" class="headerlink" title="搭建从eureka-server获取的server"></a>搭建从eureka-server获取的server</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>de.codecentric<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-admin-starter-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.netty<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>netty-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableAdminServer</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdminApplication</span> &#123;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>SpringApplication.run(AdminApplication.class, args);<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br><br><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">admin</span><br><span class="hljs-comment"># eureka 客户端配置</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">leaseRenewalIntervalInSeconds:</span> <span class="hljs-number">10</span><br>    <span class="hljs-attr">health-check-url-path:</span> <span class="hljs-string">/actuator/health</span><br>    <span class="hljs-attr">metadata-map:</span><br>      <span class="hljs-attr">startup:</span> <span class="hljs-string">$&#123;random.int&#125;</span>    <span class="hljs-comment">#needed to trigger info and endpoint update after restart</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">registryFetchIntervalSeconds:</span> <span class="hljs-number">5</span><br>    <span class="hljs-attr">serviceUrl:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">$&#123;EUREKA_SERVICE_URL:http://localhost:8761&#125;/eureka/</span><br><br><span class="hljs-comment"># actuator 端点开启</span><br><span class="hljs-attr">management:</span><br>  <span class="hljs-attr">endpoints:</span><br>    <span class="hljs-attr">web:</span><br>      <span class="hljs-attr">exposure:</span><br>        <span class="hljs-attr">include:</span> <span class="hljs-string">&quot;*&quot;</span><br>  <span class="hljs-attr">endpoint:</span><br>    <span class="hljs-attr">health:</span><br>      <span class="hljs-attr">show-details:</span> <span class="hljs-string">ALWAYS</span><br></code></pre></td></tr></table></figure><p>这时admin项目是一个eureka-client并且是一个admin-server。</p><p>其他的需要监控的项目不需要引入admin-client，只需要引入actuator并开启端点。</p><h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><h2 id="首页"><a href="#首页" class="headerlink" title="首页"></a>首页</h2><p>首页显示了应用数、实例数、实例状态，还有应用列表。</p><h2 id="Insights"><a href="#Insights" class="headerlink" title="Insights"></a>Insights</h2><h3 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h3><p>包含了实例的信息、健康情况、元数据、进程信息、线程信息、垃圾回收情况、堆内存情况、非堆内存情况。</p><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>包含了实例的启动端口、系统属性、系统环境变量、springCloudClientHostInfo、application.yml信息</p><h3 id="类"><a href="#类" class="headerlink" title="类"></a>类</h3><p>可以查看类的信息，比如是否单例。</p><h3 id="配置属性"><a href="#配置属性" class="headerlink" title="配置属性"></a>配置属性</h3><p>可以查看一些配置类的配置信息。比如eurekaClientConfigBean</p><h3 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h3><p>可以看到我们配置的定时器</p><h2 id="日志配置"><a href="#日志配置" class="headerlink" title="日志配置"></a>日志配置</h2><p>可以动态调整一个包的日志级别</p><h2 id="JVM"><a href="#JVM" class="headerlink" title="JVM"></a>JVM</h2><p>线程转储：可以查看线程的情况。可以下载线程快照。类似jstack</p><p>内存转储：可以下载内存快照。</p><h2 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h2><p>http请求地址与处理程序的映射。</p><h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p>可以看到我们使用到的缓存空间。</p><h2 id="服务上下线通知"><a href="#服务上下线通知" class="headerlink" title="服务上下线通知"></a>服务上下线通知</h2><p>通知支持邮件、钉钉、微信等</p><h2 id="可以引入spring-Security实现安全"><a href="#可以引入spring-Security实现安全" class="headerlink" title="可以引入spring Security实现安全"></a>可以引入spring Security实现安全</h2><p>引入spring Security 并配置用户名、密码</p><h2 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h2><p>当client配置了logging.file.path or logging.file.name后，admin-server会开启查看日志的视图</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">file:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">/Users/qichuanhan/logs/service-a.log</span><br>  <span class="hljs-attr">pattern:</span><br>    <span class="hljs-attr">file:</span> <span class="hljs-string">&#x27;%clr(%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;)&#123;faint&#125; %clr(%5p) %clr($&#123;PID&#125;)&#123;magenta&#125; %clr(---)&#123;faint&#125; %clr([%15.15t])&#123;faint&#125; %clr(%-40.40logger&#123;39&#125;)&#123;cyan&#125; %clr(:)&#123;faint&#125; %m%n%wEx&#x27;</span><br></code></pre></td></tr></table></figure><p>启动service-a服务，会发现admin的控制台菜单出现了变化，日志配置变为了二级菜单，日志变为一级菜单，日志中包含日志文件、日志配置两个子菜单。点击日志文件就可以看到日志打印了。</p><h2 id="httptrace-怎么没了"><a href="#httptrace-怎么没了" class="headerlink" title="httptrace 怎么没了"></a>httptrace 怎么没了</h2><p>Spring boot 2.2.x 正式版开始，不再默认开启 InMemoryHttpTraceRepository，所以导致了这个问题。</p><p>对于此问题，官方建议采用第三方组件来进行 httptrace 的收集，详见：鼓励使用第三方跟踪和可观察性解决方案，而不是实现自己的HttpTraceRepositroy[2] <a href="https://github.com/spring-projects/spring-boot/issues/17047%E3%80%82">https://github.com/spring-projects/spring-boot/issues/17047。</a></p><p>可以使用 prometheus 来实现httptrace的功能。</p>]]></content>
    
    
    <categories>
      
      <category>spring boot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring boot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring_boot_actuator实践</title>
    <link href="/2022/06/28/spring_cloud/spring_boot_actuator%E5%AE%9E%E8%B7%B5/"/>
    <url>/2022/06/28/spring_cloud/spring_boot_actuator%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>进入spring.io </p><p>选择spring boot</p><p>点击learn</p><p>点击Reference Doc</p><p>点击<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator">Production-ready Features</a></p><p>Spring Boot 包含许多附加功能，可帮助您在将应用程序推送到生产环境时对其进行监控和管理。您可以选择使用 HTTP 端点或 JMX 来管理和监视您的应用程序。审计、健康和指标收集也可以自动应用于您的应用程序。</p><h2 id="1-启用生产就绪功能"><a href="#1-启用生产就绪功能" class="headerlink" title="1. 启用生产就绪功能"></a>1. 启用生产就绪功能</h2><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="2-端点"><a href="#2-端点" class="headerlink" title="2. 端点"></a>2. 端点</h2><p>执行器端点使您可以监视应用程序并与之交互。Spring Boot 包含许多内置端点，并允许您添加自己的端点。例如，<code>health</code>端点提供基本的应用程序健康信息。</p><p>您可以<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.enabling">启用或禁用</a>每个单独的端点并<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.exposing">通过 HTTP 或 JMX 公开它们（使它们可以远程访问）</a>。当端点被启用和公开时，它被认为是可用的。内置端点仅在可用时才会自动配置。大多数应用程序选择通过 HTTP 公开，其中端点的 ID 和前缀<code>/actuator</code>映射到 URL。例如，默认情况下，<code>health</code>端点映射到<code>/actuator/health</code>.</p><table><thead><tr><th align="left">ID</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><code>auditevents</code></td><td align="left">公开当前应用程序的审计事件信息。需要一个<code>AuditEventRepository</code>豆子。</td></tr><tr><td align="left"><code>beans</code></td><td align="left">显示应用程序中所有 Spring bean 的完整列表。</td></tr><tr><td align="left"><code>caches</code></td><td align="left">公开可用的缓存。</td></tr><tr><td align="left"><code>conditions</code></td><td align="left">显示在配置和自动配置类上评估的条件以及它们匹配或不匹配的原因。</td></tr><tr><td align="left"><code>configprops</code></td><td align="left">显示所有<code>@ConfigurationProperties</code>.</td></tr><tr><td align="left"><code>env</code></td><td align="left">公开 Spring 的<code>ConfigurableEnvironment</code>.</td></tr><tr><td align="left"><code>flyway</code></td><td align="left">显示已应用的任何 Flyway 数据库迁移。需要一个或多个<code>Flyway</code>豆子。</td></tr><tr><td align="left"><code>health</code></td><td align="left">显示应用程序运行状况信息。</td></tr><tr><td align="left"><code>httptrace</code></td><td align="left">显示 HTTP 跟踪信息（默认情况下，最近 100 个 HTTP 请求-响应交换）。需要一个<code>HttpTraceRepository</code>豆子。</td></tr><tr><td align="left"><code>info</code></td><td align="left">显示任意应用程序信息。</td></tr><tr><td align="left"><code>integrationgraph</code></td><td align="left">显示 Spring 集成图。需要依赖<code>spring-integration-core</code>.</td></tr><tr><td align="left"><code>loggers</code></td><td align="left">显示和修改应用程序中记录器的配置。</td></tr><tr><td align="left"><code>liquibase</code></td><td align="left">显示已应用的任何 Liquibase 数据库迁移。需要一个或多个<code>Liquibase</code>豆子。</td></tr><tr><td align="left"><code>metrics</code></td><td align="left">显示当前应用程序的“指标”信息。</td></tr><tr><td align="left"><code>mappings</code></td><td align="left">显示所有<code>@RequestMapping</code>路径的整理列表。</td></tr><tr><td align="left"><code>quartz</code></td><td align="left">显示有关 Quartz 调度程序作业的信息。</td></tr><tr><td align="left"><code>scheduledtasks</code></td><td align="left">显示应用程序中的计划任务。</td></tr><tr><td align="left"><code>sessions</code></td><td align="left">允许从 Spring Session 支持的会话存储中检索和删除用户会话。需要使用 Spring Session 的基于 servlet 的 Web 应用程序。</td></tr><tr><td align="left"><code>shutdown</code></td><td align="left">让应用程序正常关闭。默认禁用。</td></tr><tr><td align="left"><code>startup</code></td><td align="left">显示由. <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.spring-application.startup-tracking">_ </a><code>ApplicationStartup</code>需要<code>SpringApplication</code>配置<code>BufferingApplicationStartup</code>.</td></tr><tr><td align="left"><code>threaddump</code></td><td align="left">执行线程转储。</td></tr></tbody></table><p>如果您的应用程序是 Web 应用程序（Spring MVC、Spring WebFlux 或 Jersey），您可以使用以下附加端点：</p><table><thead><tr><th align="left">ID</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><code>heapdump</code></td><td align="left">返回一个堆转储文件。在 HotSpot JVM 上，<code>HPROF</code>返回一个 -format 文件。在 OpenJ9 JVM 上，<code>PHD</code>返回一个 -format 文件。</td></tr><tr><td align="left"><code>jolokia</code></td><td align="left">当 Jolokia 在类路径上时，通过 HTTP 公开 JMX bean（不适用于 WebFlux）。需要依赖<code>jolokia-core</code>.</td></tr><tr><td align="left"><code>logfile</code></td><td align="left">返回日志文件的内容（如果已设置<code>logging.file.name</code>或属性）。<code>logging.file.path</code>支持使用 HTTP<code>Range</code>标头检索部分日志文件内容。</td></tr><tr><td align="left"><code>prometheus</code></td><td align="left">以 Prometheus 服务器可以抓取的格式公开指标。需要依赖<code>micrometer-registry-prometheus</code>.</td></tr></tbody></table><h2 id="端点控制"><a href="#端点控制" class="headerlink" title="端点控制"></a>端点控制</h2><p>开启所有端点</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">management:</span><br>  <span class="hljs-attr">endpoints:</span><br>    <span class="hljs-attr">web:</span><br>      <span class="hljs-attr">exposure:</span><br>        <span class="hljs-attr">include:</span> <span class="hljs-string">&#x27;*&#x27;</span><br></code></pre></td></tr></table></figure><p>个别开启</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">management:</span><br>  <span class="hljs-attr">endpoints:</span><br>    <span class="hljs-attr">web:</span><br>      <span class="hljs-attr">exposure:</span><br>        <span class="hljs-attr">include:</span> <span class="hljs-string">health,info</span><br></code></pre></td></tr></table></figure><p>个别禁用</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">management:</span><br>  <span class="hljs-attr">endpoints:</span><br>    <span class="hljs-attr">web:</span><br>      <span class="hljs-attr">exposure:</span><br>      <span class="hljs-attr">include:</span> <span class="hljs-string">&#x27;*&#x27;</span><br>        <span class="hljs-attr">exclude:</span> <span class="hljs-string">env,beans</span><br></code></pre></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>actuator 提供一些端点，用于指标的查询，可以配合监控软件，实现对应用服务的监控。</p>]]></content>
    
    
    <categories>
      
      <category>spring boot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring boot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring_cloud_gateway源码分析</title>
    <link href="/2022/06/28/spring_cloud/spring_cloud_gateway%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <url>/2022/06/28/spring_cloud/spring_cloud_gateway%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="网关启动源码"><a href="#网关启动源码" class="headerlink" title="网关启动源码"></a>网关启动源码</h1><h2 id="自动装配AutoConfiguration"><a href="#自动装配AutoConfiguration" class="headerlink" title="自动装配AutoConfiguration"></a>自动装配AutoConfiguration</h2><p>使用时加入jar包，spring-cloud-starter-gateway -&gt; pom.xml -&gt; spring-cloud-gateway-server -&gt; spring.factories -&gt;  GatewayAutoConfiguration.java</p><h2 id="配置信息映射"><a href="#配置信息映射" class="headerlink" title="配置信息映射"></a>配置信息映射</h2><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> GatewayProperties <span class="hljs-title function_">gatewayProperties</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GatewayProperties</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>这个类对应着yml文件中的参数。</p><h2 id="Locator-定位器"><a href="#Locator-定位器" class="headerlink" title="Locator  定位器"></a>Locator  定位器</h2><p>发现各种Locator：</p><ul><li>PropertiesRouteDefinitionLocator：从Properties中读取</li><li>InMemoryRouteDefinitionRepository：对RouteDefinition进行增、删、查操作，基于内存存储</li><li>CompositeRouteDefinitionLocator：组合的Locator，在构造函数中设置委托，将PropertiesRouteDefinitionLocator和InMemoryRouteDefinitionRepository组合。</li></ul><h2 id="初始化GlobalFilters【FilteringWebHandler】"><a href="#初始化GlobalFilters【FilteringWebHandler】" class="headerlink" title="初始化GlobalFilters【FilteringWebHandler】"></a>初始化GlobalFilters【FilteringWebHandler】</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> FilteringWebHandler <span class="hljs-title function_">filteringWebHandler</span><span class="hljs-params">(List&lt;GlobalFilter&gt; globalFilters)</span> &#123;<br>   <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilteringWebHandler</span>(globalFilters);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilteringWebHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebHandler</span> &#123;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;GatewayFilter&gt; globalFilters;<br><span class="hljs-comment">//构造函数中设置globalFiltersglobalFilters</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">FilteringWebHandler</span><span class="hljs-params">(List&lt;GlobalFilter&gt; globalFilters)</span> &#123;<br><span class="hljs-built_in">this</span>.globalFilters = loadFilters(globalFilters);<br>&#125;<br><span class="hljs-comment">//设置globalFilters</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;GatewayFilter&gt; <span class="hljs-title function_">loadFilters</span><span class="hljs-params">(List&lt;GlobalFilter&gt; filters)</span> &#123;<br><span class="hljs-keyword">return</span> filters.stream().map(filter -&gt; &#123;<br><span class="hljs-type">GatewayFilterAdapter</span> <span class="hljs-variable">gatewayFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GatewayFilterAdapter</span>(filter);<br><span class="hljs-keyword">if</span> (filter <span class="hljs-keyword">instanceof</span> Ordered) &#123;<br><span class="hljs-type">int</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> ((Ordered) filter).getOrder();<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderedGatewayFilter</span>(gatewayFilter, order);<br>&#125;<br><span class="hljs-keyword">return</span> gatewayFilter;<br>&#125;).collect(Collectors.toList());<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="初始化predicates，gatewayFilters，getRoutes【GatewayAutoConfiguration–-gt-RouteDefinitionRouteLocator】"><a href="#初始化predicates，gatewayFilters，getRoutes【GatewayAutoConfiguration–-gt-RouteDefinitionRouteLocator】" class="headerlink" title="初始化predicates，gatewayFilters，getRoutes【GatewayAutoConfiguration–&gt;RouteDefinitionRouteLocator】"></a>初始化predicates，gatewayFilters，getRoutes【GatewayAutoConfiguration–&gt;RouteDefinitionRouteLocator】</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RouteDefinitionRouteLocator</span><br><span class="hljs-keyword">implements</span> <span class="hljs-title class_">RouteLocator</span>, BeanFactoryAware, ApplicationEventPublisherAware &#123;<br><span class="hljs-comment">//构造函数中初始化</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">RouteDefinitionRouteLocator</span><span class="hljs-params">(RouteDefinitionLocator routeDefinitionLocator,</span><br><span class="hljs-params">List&lt;RoutePredicateFactory&gt; predicates,</span><br><span class="hljs-params">List&lt;GatewayFilterFactory&gt; gatewayFilterFactories,</span><br><span class="hljs-params">GatewayProperties gatewayProperties, ConversionService conversionService)</span> &#123;<br><span class="hljs-built_in">this</span>.routeDefinitionLocator = routeDefinitionLocator;<br><span class="hljs-built_in">this</span>.conversionService = conversionService;<br>initFactories(predicates);<br>gatewayFilterFactories.forEach(<br>factory -&gt; <span class="hljs-built_in">this</span>.gatewayFilterFactories.put(factory.name(), factory));<br><span class="hljs-built_in">this</span>.gatewayProperties = gatewayProperties;<br>&#125;<br><br><span class="hljs-comment">//设置predicate工厂</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initFactories</span><span class="hljs-params">(List&lt;RoutePredicateFactory&gt; predicates)</span> &#123;<br>predicates.forEach(factory -&gt; &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> factory.name();<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.predicates.containsKey(key)) &#123;<br><span class="hljs-built_in">this</span>.logger.warn(<span class="hljs-string">&quot;A RoutePredicateFactory named &quot;</span> + key<br>+ <span class="hljs-string">&quot; already exists, class: &quot;</span> + <span class="hljs-built_in">this</span>.predicates.get(key)<br>+ <span class="hljs-string">&quot;. It will be overwritten.&quot;</span>);<br>&#125;<br><span class="hljs-built_in">this</span>.predicates.put(key, factory);<br><span class="hljs-keyword">if</span> (logger.isInfoEnabled()) &#123;<br>logger.info(<span class="hljs-string">&quot;Loaded RoutePredicateFactory [&quot;</span> + key + <span class="hljs-string">&quot;]&quot;</span>);<br>&#125;<br>&#125;);<br>&#125;<br><br><span class="hljs-keyword">public</span> Flux&lt;Route&gt; <span class="hljs-title function_">getRoutes</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-comment">//从RouteDefinitions转换为Route，转换过程在convertToRoute方法中实现</span><br><span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.routeDefinitionLocator.getRouteDefinitions().map(<span class="hljs-built_in">this</span>::convertToRoute)<br>.map(route -&gt; &#123;<br><span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>logger.debug(<span class="hljs-string">&quot;RouteDefinition matched: &quot;</span> + route.getId());<br>&#125;<br><span class="hljs-keyword">return</span> route;<br>&#125;);<br>&#125;<br><br><span class="hljs-comment">//RouteDefinition到Route的转换</span><br><span class="hljs-keyword">private</span> Route <span class="hljs-title function_">convertToRoute</span><span class="hljs-params">(RouteDefinition routeDefinition)</span> &#123;<br><span class="hljs-comment">//从routeDefinition获取predicate</span><br>AsyncPredicate&lt;ServerWebExchange&gt; predicate = combinePredicates(routeDefinition);<br><span class="hljs-comment">//从routeDefinition获取gatewayFilters</span><br>List&lt;GatewayFilter&gt; gatewayFilters = getFilters(routeDefinition);<br><span class="hljs-comment">//构造Route</span><br><span class="hljs-keyword">return</span> Route.async(routeDefinition).asyncPredicate(predicate)<br>.replaceFilters(gatewayFilters).build();<br>&#125;<br><br><span class="hljs-comment">//获取GatewayFilters</span><br><span class="hljs-keyword">private</span> List&lt;GatewayFilter&gt; <span class="hljs-title function_">getFilters</span><span class="hljs-params">(RouteDefinition routeDefinition)</span> &#123;<br>List&lt;GatewayFilter&gt; filters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><span class="hljs-comment">//如果默认filter不为空，则去加载</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.gatewayProperties.getDefaultFilters().isEmpty()) &#123;<br>filters.addAll(loadGatewayFilters(DEFAULT_FILTERS,<br><span class="hljs-built_in">this</span>.gatewayProperties.getDefaultFilters()));<br>&#125;<br><span class="hljs-comment">//如果Filter不为空，则</span><br><span class="hljs-keyword">if</span> (!routeDefinition.getFilters().isEmpty()) &#123;<br>filters.addAll(loadGatewayFilters(routeDefinition.getId(),<br>routeDefinition.getFilters()));<br>&#125;<br><br>AnnotationAwareOrderComparator.sort(filters);<br><span class="hljs-keyword">return</span> filters;<br>&#125;<br><br><span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="hljs-keyword">private</span> List&lt;GatewayFilter&gt; <span class="hljs-title function_">loadGatewayFilters</span><span class="hljs-params">(String id,</span><br><span class="hljs-params">List&lt;FilterDefinition&gt; filterDefinitions)</span> &#123;<br>List&lt;GatewayFilter&gt; filters = filterDefinitions.stream().map(definition -&gt; &#123;<br><span class="hljs-comment">//从gatewayFilterFactories中根据key获取factory</span><br><span class="hljs-type">GatewayFilterFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.gatewayFilterFactories<br>.get(definition.getName());<br><span class="hljs-keyword">if</span> (factory == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<br><span class="hljs-string">&quot;Unable to find GatewayFilterFactory with name &quot;</span><br>+ definition.getName());<br>&#125;<br><span class="hljs-comment">//获取definition设置的Filter值</span><br>Map&lt;String, String&gt; args = definition.getArgs();<br><span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>logger.debug(<span class="hljs-string">&quot;RouteDefinition &quot;</span> + id + <span class="hljs-string">&quot; applying filter &quot;</span> + args + <span class="hljs-string">&quot; to &quot;</span><br>+ definition.getName());<br>&#125;<br><br>Map&lt;String, Object&gt; properties = factory.shortcutType().normalize(args,<br>factory, <span class="hljs-built_in">this</span>.parser, <span class="hljs-built_in">this</span>.beanFactory);<br><span class="hljs-comment">//每一个工厂中都有一个静态内部类Config，目的是存储我们设置的Filter值</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> factory.newConfig();<br><span class="hljs-comment">//将后几个参数的信息绑定到configuration</span><br>ConfigurationUtils.bind(configuration, properties,<br>factory.shortcutFieldPrefix(), definition.getName(), validator,<br>conversionService);<br><span class="hljs-comment">//获得GatewayFilter</span><br><span class="hljs-type">GatewayFilter</span> <span class="hljs-variable">gatewayFilter</span> <span class="hljs-operator">=</span> factory.apply(configuration);<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.publisher != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-built_in">this</span>.publisher.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterArgsEvent</span>(<span class="hljs-built_in">this</span>, id, properties));<br>&#125;<br><span class="hljs-keyword">return</span> gatewayFilter;<br>&#125;).collect(Collectors.toList());<br><br>ArrayList&lt;GatewayFilter&gt; ordered = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(filters.size());<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; filters.size(); i++) &#123;<br><span class="hljs-type">GatewayFilter</span> <span class="hljs-variable">gatewayFilter</span> <span class="hljs-operator">=</span> filters.get(i);<br><span class="hljs-keyword">if</span> (gatewayFilter <span class="hljs-keyword">instanceof</span> Ordered) &#123;<br>ordered.add(gatewayFilter);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>ordered.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderedGatewayFilter</span>(gatewayFilter, i + <span class="hljs-number">1</span>));<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> ordered;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="请求处理源码"><a href="#请求处理源码" class="headerlink" title="请求处理源码"></a>请求处理源码</h1><p><img src="/.com//gateway%E8%AF%B7%E6%B1%82%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B.png" alt="gateway请求源码流程"></p><p>①ReactorHttpHandlerAdapter#apply方法是请求到网关执行的入口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactorHttpHandlerAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BiFunction</span>&lt;HttpServerRequest, HttpServerResponse, Mono&lt;Void&gt;&gt; &#123;<br><span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">apply</span><span class="hljs-params">(HttpServerRequest reactorRequest, HttpServerResponse reactorResponse)</span> &#123;<br><span class="hljs-type">NettyDataBufferFactory</span> <span class="hljs-variable">bufferFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NettyDataBufferFactory</span>(reactorResponse.alloc());<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//获取请求的request和response</span><br><span class="hljs-type">ReactorServerHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReactorServerHttpRequest</span>(reactorRequest, bufferFactory);<br><span class="hljs-type">ServerHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReactorServerHttpResponse</span>(reactorResponse, bufferFactory);<br><br><span class="hljs-keyword">if</span> (request.getMethod() == HttpMethod.HEAD) &#123;<br>response = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpHeadResponseDecorator</span>(response);<br>&#125;<br><span class="hljs-comment">//给到HttpWebHandlerAdapter执行构建</span><br><span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.httpHandler.handle(request, response)<br>.doOnError(ex -&gt; logger.trace(request.getLogPrefix() + <span class="hljs-string">&quot;Failed to complete: &quot;</span> + ex.getMessage()))<br>.doOnSuccess(aVoid -&gt; logger.trace(request.getLogPrefix() + <span class="hljs-string">&quot;Handling completed&quot;</span>));<br>&#125;<br><span class="hljs-keyword">catch</span> (URISyntaxException ex) &#123;<br><span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>logger.debug(<span class="hljs-string">&quot;Failed to get request URI: &quot;</span> + ex.getMessage());<br>&#125;<br>reactorResponse.status(HttpResponseStatus.BAD_REQUEST);<br><span class="hljs-keyword">return</span> Mono.empty();<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>②HttpWebHandlerAdapter#handle构建网关上下文ServerWebExchange</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpWebHandlerAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebHandlerDecorator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HttpHandler</span> &#123;<br><span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">handle</span><span class="hljs-params">(ServerHttpRequest request, ServerHttpResponse response)</span> &#123;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.forwardedHeaderTransformer != <span class="hljs-literal">null</span>) &#123;<br>request = <span class="hljs-built_in">this</span>.forwardedHeaderTransformer.apply(request);<br>&#125;<br><span class="hljs-comment">//根据请求的request、response构建网关上下文</span><br><span class="hljs-type">ServerWebExchange</span> <span class="hljs-variable">exchange</span> <span class="hljs-operator">=</span> createExchange(request, response);<br><br>LogFormatUtils.traceDebug(logger, traceOn -&gt;<br>exchange.getLogPrefix() + formatRequest(exchange.getRequest()) +<br>(traceOn ? <span class="hljs-string">&quot;, headers=&quot;</span> + formatHeaders(exchange.getRequest().getHeaders()) : <span class="hljs-string">&quot;&quot;</span>));<br><br><span class="hljs-keyword">return</span> getDelegate().handle(exchange)<br>.doOnSuccess(aVoid -&gt; logResponse(exchange))<br>.onErrorResume(ex -&gt; handleUnresolvedError(exchange, ex))<br>.then(Mono.defer(response::setComplete));<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>③DispatcherHandler用于Http请求处理器&#x2F;控制器的中央分发处理器，把请求分发给已经注册的处理程序处理，DispatcherHandler遍历Mapping获取对应的handler，网关一共有6个handlerMapping【此处会找到RoutePredicateHandlerMapping，通过RoutePredicateHandlerMapping获取FilteringWebHandler，通过FilteringWebHandler获取】</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DispatcherHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebHandler</span>, ApplicationContextAware &#123;<br><span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">handle</span><span class="hljs-params">(ServerWebExchange exchange)</span> &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.handlerMappings == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span> createNotFoundError();<br>&#125;<br><span class="hljs-comment">//遍历mapping获取handler</span><br><span class="hljs-keyword">return</span> Flux.fromIterable(<span class="hljs-built_in">this</span>.handlerMappings)<br>.concatMap(mapping -&gt; mapping.getHandler(exchange))<br>.next()<br>.switchIfEmpty(createNotFoundError())<br>.flatMap(handler -&gt; invokeHandler(exchange, handler))<br>.flatMap(result -&gt; handleResult(exchange, result));<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoutePredicateHandlerMapping</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractHandlerMapping</span> &#123;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> FilteringWebHandler webHandler;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RouteLocator routeLocator;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer managementPort;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ManagementPortType managementPortType;<br><span class="hljs-comment">//网关启动时进行了初始化</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">RoutePredicateHandlerMapping</span><span class="hljs-params">(FilteringWebHandler webHandler,</span><br><span class="hljs-params">RouteLocator routeLocator, GlobalCorsProperties globalCorsProperties,</span><br><span class="hljs-params">Environment environment)</span> &#123;<br><span class="hljs-built_in">this</span>.webHandler = webHandler;<br><span class="hljs-built_in">this</span>.routeLocator = routeLocator;<br><br><span class="hljs-built_in">this</span>.managementPort = getPortProperty(environment, <span class="hljs-string">&quot;management.server.&quot;</span>);<br><span class="hljs-built_in">this</span>.managementPortType = getManagementPortType(environment);<br>setOrder(<span class="hljs-number">1</span>);<br>setCorsConfigurations(globalCorsProperties.getCorsConfigurations());<br>&#125;<br><br><span class="hljs-keyword">protected</span> Mono&lt;?&gt; getHandlerInternal(ServerWebExchange exchange) &#123;<br><span class="hljs-comment">// don&#x27;t handle requests on management port if set and different than server port</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.managementPortType == DIFFERENT &amp;&amp; <span class="hljs-built_in">this</span>.managementPort != <span class="hljs-literal">null</span><br>&amp;&amp; exchange.getRequest().getURI().getPort() == <span class="hljs-built_in">this</span>.managementPort) &#123;<br><span class="hljs-keyword">return</span> Mono.empty();<br>&#125;<br>exchange.getAttributes().put(GATEWAY_HANDLER_MAPPER_ATTR, getSimpleName());<br><br><span class="hljs-keyword">return</span> lookupRoute(exchange)<br><span class="hljs-comment">// .log(&quot;route-predicate-handler-mapping&quot;, Level.FINER) //name this</span><br>.flatMap((Function&lt;Route, Mono&lt;?&gt;&gt;) r -&gt; &#123;<br>exchange.getAttributes().remove(GATEWAY_PREDICATE_ROUTE_ATTR);<br><span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>logger.debug(<br><span class="hljs-string">&quot;Mapping [&quot;</span> + getExchangeDesc(exchange) + <span class="hljs-string">&quot;] to &quot;</span> + r);<br>&#125;<br><br>exchange.getAttributes().put(GATEWAY_ROUTE_ATTR, r);<br><span class="hljs-comment">//返回FilteringWebHandler</span><br><span class="hljs-keyword">return</span> Mono.just(webHandler);<br>&#125;).switchIfEmpty(Mono.empty().then(Mono.fromRunnable(() -&gt; &#123;<br>exchange.getAttributes().remove(GATEWAY_PREDICATE_ROUTE_ATTR);<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;No RouteDefinition found for [&quot;</span><br>+ getExchangeDesc(exchange) + <span class="hljs-string">&quot;]&quot;</span>);<br>&#125;<br>&#125;)));<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>④ RoutePredicateHandlerMapping#lookupRoute匹配路由，根据routeLocator获取我们在配置我文件中配置的Route，和当前请求的路由做匹配</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoutePredicateHandlerMapping</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractHandlerMapping</span> &#123;<br><span class="hljs-keyword">protected</span> Mono&lt;Route&gt; <span class="hljs-title function_">lookupRoute</span><span class="hljs-params">(ServerWebExchange exchange)</span> &#123;<br><span class="hljs-comment">//routeLocator获取我们在配置我文件中配置的Route</span><br><span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.routeLocator.getRoutes()<br>.concatMap(route -&gt; Mono.just(route).filterWhen(r -&gt; &#123;<br>exchange.getAttributes().put(GATEWAY_PREDICATE_ROUTE_ATTR, r.getId());<br><span class="hljs-comment">//当前请求的路由做匹配</span><br><span class="hljs-keyword">return</span> r.getPredicate().apply(exchange);<br>&#125;)<br>.doOnError(e -&gt; logger.error(<br><span class="hljs-string">&quot;Error applying predicate for route: &quot;</span> + route.getId(),<br>e))<br>.onErrorResume(e -&gt; Mono.empty()))<br>.next()<br>.map(route -&gt; &#123;<br><span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>logger.debug(<span class="hljs-string">&quot;Route matched: &quot;</span> + route.getId());<br>&#125;<br>validateRoute(route, exchange);<br><span class="hljs-keyword">return</span> route;<br>&#125;);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>⑤FilteringWebHandler创建过滤器链，执行过滤器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilteringWebHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebHandler</span> &#123;<br><span class="hljs-comment">//创建过滤器链</span><br><span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">handle</span><span class="hljs-params">(ServerWebExchange exchange)</span> &#123;<br><span class="hljs-type">Route</span> <span class="hljs-variable">route</span> <span class="hljs-operator">=</span> exchange.getRequiredAttribute(GATEWAY_ROUTE_ATTR);<br>List&lt;GatewayFilter&gt; gatewayFilters = route.getFilters();<br><br>List&lt;GatewayFilter&gt; combined = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-built_in">this</span>.globalFilters);<br>combined.addAll(gatewayFilters);<br>AnnotationAwareOrderComparator.sort(combined);<br><br><span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>logger.debug(<span class="hljs-string">&quot;Sorted gatewayFilterFactories: &quot;</span> + combined);<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultGatewayFilterChain</span>(combined).filter(exchange);<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultGatewayFilterChain</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GatewayFilterChain</span> &#123;<br><span class="hljs-comment">//调用过滤器</span><br><span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange)</span> &#123;<br><span class="hljs-keyword">return</span> Mono.defer(() -&gt; &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.index &lt; filters.size()) &#123;<br><span class="hljs-type">GatewayFilter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> filters.get(<span class="hljs-built_in">this</span>.index);<br><span class="hljs-type">DefaultGatewayFilterChain</span> <span class="hljs-variable">chain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultGatewayFilterChain</span>(<span class="hljs-built_in">this</span>,<br><span class="hljs-built_in">this</span>.index + <span class="hljs-number">1</span>);<br><span class="hljs-comment">//执行调用</span><br><span class="hljs-keyword">return</span> filter.filter(exchange, chain);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">return</span> Mono.empty(); <span class="hljs-comment">// complete</span><br>&#125;<br>&#125;);<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="限流和熔断"><a href="#限流和熔断" class="headerlink" title="限流和熔断"></a>限流和熔断</h1><p>限流和熔断都是加入相应的过滤器实现的。</p><h1 id="ribbon"><a href="#ribbon" class="headerlink" title="ribbon"></a>ribbon</h1><p>LoadBalancerClientFilter</p><h1 id="请求的filter是哪个"><a href="#请求的filter是哪个" class="headerlink" title="请求的filter是哪个"></a>请求的filter是哪个</h1><p>NettyRoutingFilter</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>spring cloud gateway 是由netty + webflux  + filter组成</p><p>Filter ：Filter是一个Servlet规范组件；一个请求可以在Http请求到达Servlet前被一个或多个Filter处理，Servlet处理完后返回给Filter,最后返回给用户。</p><p>WebFlux：它是一个异步非阻塞式的web框架，它的作用不是提升接口请求时间，而是在一些阻塞的场景【例如请求DB，等待DB响应数据、打开大文件等】，可以把线程给其它请求使用，从而提升系统吞吐量。Gateway属于网络IO密集型【网关转发请求到下游服务】，通过WebFlux有效的提升网关转发的吞吐量。</p>]]></content>
    
    
    <categories>
      
      <category>spring_cloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring_cloud</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring_cloud_gateway实践</title>
    <link href="/2022/06/23/spring_cloud/spring_cloud_gateway%E5%AE%9E%E8%B7%B5/"/>
    <url>/2022/06/23/spring_cloud/spring_cloud_gateway%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>网关作为系统的唯一流量入口。</p><p>1.跟客户端交互只有一个地址</p><p>2.路由转发</p><p>3.认证安全</p><p>4.限流熔断</p><p>5.日志监控</p><h1 id="Spring-Cloud-Gateway-配置项的说明"><a href="#Spring-Cloud-Gateway-配置项的说明" class="headerlink" title="Spring Cloud Gateway 配置项的说明"></a>Spring Cloud Gateway 配置项的说明</h1><p>断言（Predicate）：参照 Java8 的新特性Predicate，允许开发人员匹配 HTTP 请求中的任何内容，比如请求头或请求参数，最后根据匹配结果返回一个布尔值。<br>路由（route）：由ID、目标URI、断言集合和过滤器集合组成。如果聚合断言结果为真，则转发到该路由。<br>过滤器（filter）：可以在返回请求之前或之后修改请求和响应的内容。</p><h2 id="路由-Route："><a href="#路由-Route：" class="headerlink" title="路由 Route："></a>路由 Route：</h2><p>​        Route 主要由 路由id、目标uri、断言集合和过滤器集合组成，那我们简单看看这些属性到底有什么作用。</p><p>（1）id：路由标识，要求唯一，名称任意（默认值 uuid，一般不用，需要自定义）</p><p>（2）uri：请求最终被转发到的目标地址</p><p>（3）order： 路由优先级，数字越小，优先级越高</p><p>（4）predicates：断言数组，即判断条件，如果返回值是boolean，则转发请求到 uri 属性指定的服务中</p><p>（5）filters：过滤器数组，在请求传递过程中，对请求做一些修改</p><h2 id="断言-Predicate："><a href="#断言-Predicate：" class="headerlink" title="断言 Predicate："></a>断言 Predicate：</h2><p>​        Predicate 来自于 Java8 的接口。Predicate 接受一个输入参数，返回一个布尔值结果。该接口包含多种默认方法来将 Predicate 组合成其他复杂的逻辑（比如：与，或，非）。</p><p>​Predicate 可以用于接口请求参数校验、判断新老数据是否有变化需要进行更新操作。Spring Cloud Gateway 内置了许多 Predict，这些 Predict 的源码在 org.springframework.cloud.gateway.handler.predicate 包中。</p><h2 id="过滤器-filter："><a href="#过滤器-filter：" class="headerlink" title="过滤器 filter："></a>过滤器 filter：</h2><p>Gateway 过滤器的生命周期：</p><p>PRE：这种过滤器在请求被路由之前调用。我们可利用这种过滤器实现身份验证、在集群中选择请求的微服务、记录调试信息等。<br>POST：这种过滤器在路由到微服务以后执行。这种过滤器可用来为响应添加标准的 HTTP Header、收集统计信息和指标、将响应从微服务发送给客户端等。<br>Gateway 过滤器从作用范围可分为两种:</p><p>GatewayFilter：应用到单个路由或者一个分组的路由上（需要在配置文件中配置）<br>GlobalFilter：应用到所有的路由上（无需配置，全局生效）</p><p>在org.springframework.cloud.gateway.filter中</p><h1 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h1><p>使用spring init工具加入gateway、 eureka-client</p><p>pom.xml配置</p><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>service-a<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>service-a<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Demo project for Spring Boot<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-boot.version</span>&gt;</span>2.3.7.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring-boot.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud.version</span>&gt;</span>Hoxton.SR9<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.vintage<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-vintage-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.testng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>testng<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">encoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">encoding</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.7.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>com.example.service_a.ServiceAApplication<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gateway</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-comment"># 路由数组：指当请求满足什么样的断言时，转发到哪个服务上</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-comment"># 路由标识，要求唯一，名称任意</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">service_a</span><br>          <span class="hljs-comment"># 请求最终被转发到的目标地址</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:8762</span><br>          <span class="hljs-comment"># 设置断言</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-comment"># Path Route Predicate Factory 断言，满足 /gateway/servicea/** 路径的请求都会被路由到 http://localhost:8762 这个uri中</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/gateway/servicea/**</span><br>            <span class="hljs-comment"># Weight Route Predicate Factory 断言，同一分组按照权重进行分配流量，这里分配了80%</span><br>            <span class="hljs-comment"># 第一个group1是分组名，第二个参数是权重</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Weight=group1,</span> <span class="hljs-number">8</span><br>          <span class="hljs-comment"># 配置过滤器（局部）</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-comment"># StripPrefix：去除原始请求路径中的前1级路径，即/gateway/servicea</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=2</span><br><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9000</span><br>  <span class="hljs-attr">servlet:</span><br>    <span class="hljs-attr">context-path:</span> <span class="hljs-string">/$&#123;spring.application.name&#125;</span><br></code></pre></td></tr></table></figure><p>启动 eureka、gateway、service-a项目</p><p>这里eureka只是让gateway注册到eureka-server上不报错。</p><p>访问<a href="http://localhost:9000/gateway/servicea/test2">http://localhost:9000/gateway/servicea/test2</a> 可以收到请求返回</p><h1 id="整合eureka"><a href="#整合eureka" class="headerlink" title="整合eureka"></a>整合eureka</h1><p>Eureka-client 早加进来了</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gateway</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">locator:</span><br>          <span class="hljs-comment">#开启从eureka 拉取服务列表  并自动映射</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">lower-case-service-id:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9000</span><br><br><br><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:8761/eureka/</span><br></code></pre></td></tr></table></figure><p>这里去掉了网关项目的根路径。</p><p>至此惟一地址、路由转发已完成了。</p><h1 id="权限安全"><a href="#权限安全" class="headerlink" title="权限安全"></a>权限安全</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenGatewayFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GlobalFilter</span>, Ordered &#123;<br><br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> &#123;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;<br><br><span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-comment">//从header取</span><br>token = exchange.getRequest().getHeaders().getFirst(<span class="hljs-string">&quot;Authorization&quot;</span>);<br><span class="hljs-keyword">if</span>(StringUtils.isEmpty(token))&#123;<br><span class="hljs-comment">//尝试从param取</span><br>token = exchange.getRequest().getQueryParams().getFirst(<span class="hljs-string">&quot;token&quot;</span>);<br>&#125;<br><span class="hljs-comment">//尝试从cookies取</span><br><span class="hljs-keyword">if</span>(StringUtils.isEmpty(token))&#123;<br><span class="hljs-type">HttpCookie</span> <span class="hljs-variable">cookies</span> <span class="hljs-operator">=</span> exchange.getRequest().getCookies().getFirst(<span class="hljs-string">&quot;token&quot;</span>);<br><span class="hljs-keyword">if</span>(cookies!=<span class="hljs-literal">null</span>)&#123;<br>token  = cookies.getValue();<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>(StringUtils.isEmpty(token))&#123;<br><br><br><span class="hljs-keyword">return</span> responseFailRs(exchange, <span class="hljs-string">&quot;token参数未传入&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">//TODO 校验jwt token</span><br><br><span class="hljs-keyword">return</span> chain.filter(exchange);<br>&#125;<br><br> <span class="hljs-keyword">private</span> Mono&lt;Void&gt; <span class="hljs-title function_">responseFailRs</span><span class="hljs-params">(ServerWebExchange exchange, String str)</span> &#123;<br>        <span class="hljs-type">ServerHttpResponse</span> <span class="hljs-variable">serverHttpResponse</span> <span class="hljs-operator">=</span> exchange.getResponse();<br>        serverHttpResponse.setStatusCode(HttpStatus.UNAUTHORIZED);<br>        serverHttpResponse.getHeaders().setContentType(MediaType.APPLICATION_JSON_UTF8);<br>        <span class="hljs-type">byte</span>[] bytes = str.getBytes(StandardCharsets.UTF_8);<br>        <span class="hljs-type">DataBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> exchange.getResponse().bufferFactory().wrap(bytes);<br>        <span class="hljs-keyword">return</span> serverHttpResponse.writeWith(Flux.just(buffer));<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>这里使用的全局的过滤器。</p><h1 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h1><p>1.可以使用自带的限流，RequestRateLimiterGatewayFilterFactory</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis-reactive<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>  <span class="hljs-attr">gateway:</span><br>  <span class="hljs-attr">default-filters:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">RequestRateLimiter</span><br>            <span class="hljs-attr">args:</span><br>              <span class="hljs-attr">key-resolver:</span> <span class="hljs-string">&quot;#&#123;@hostAddrKeyResolver&#125;&quot;</span><br>              <span class="hljs-attr">redis-rate-limiter.replenishRate:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># 令牌桶填充的速率 秒为单位</span><br>              <span class="hljs-attr">redis-rate-limiter.burstCapacity:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># 令牌桶总容量</span><br>              <span class="hljs-attr">redis-rate-limiter.requestedTokens:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># 每次请求获取的令牌数</span><br></code></pre></td></tr></table></figure><p>2.自定义局部限流</p><p>3.全局限流</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义过滤器</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Order(-1)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestRateLimitFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GlobalFilter</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Cache&lt;String, RateLimiter&gt; RATE_LIMITER_CACHE = CacheBuilder<br>            .newBuilder()<br>            .maximumSize(<span class="hljs-number">1000</span>)<br>            .expireAfterAccess(<span class="hljs-number">1</span>, TimeUnit.HOURS)<br>            .build();<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> <span class="hljs-variable">DEFAULT_PERMITS_PER_SECOND</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// 令牌桶每秒填充速率</span><br><br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">remoteAddr</span> <span class="hljs-operator">=</span> Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();<br>        <span class="hljs-type">RateLimiter</span> <span class="hljs-variable">rateLimiter</span> <span class="hljs-operator">=</span> RATE_LIMITER_CACHE.get(remoteAddr, () -&gt; RateLimiter.create(DEFAULT_PERMITS_PER_SECOND));<br>        <span class="hljs-keyword">if</span> (rateLimiter.tryAcquire()) &#123;<br>            <span class="hljs-keyword">return</span> chain.filter(exchange);<br>        &#125;<br>        <span class="hljs-type">ServerHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> exchange.getResponse();<br>        response.setStatusCode(HttpStatus.TOO_MANY_REQUESTS);<br>        response.getHeaders().add(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>        <span class="hljs-type">DataBuffer</span> <span class="hljs-variable">dataBuffer</span> <span class="hljs-operator">=</span> response.bufferFactory().wrap(<span class="hljs-string">&quot;Too Many Request!!!&quot;</span>.getBytes(StandardCharsets.UTF_8));<br>        <span class="hljs-keyword">return</span> response.writeWith(Mono.just(dataBuffer));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>计数器算法、固定窗口算法、滑动窗口算法、漏桶算法、令牌桶算法</p><h1 id="熔断"><a href="#熔断" class="headerlink" title="熔断"></a>熔断</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>  <span class="hljs-attr">gateway:</span><br>  <span class="hljs-attr">default-filters:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Hystrix</span><br>            <span class="hljs-attr">args:</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">fallback</span><br>              <span class="hljs-attr">fallbackUri:</span> <span class="hljs-string">forward:/fallback</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FallBackController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/fallback&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">fallback</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Error:fallback&quot;</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>启动 eureka、service-a、gateway，这时gateway已经获取到service-a服务，</p><p>这时关闭service-a服务，访问<a href="http://localhost:9000/service-a/test2">http://localhost:9000/service-a/test2</a>  时返回Error:fallback</p><h1 id="日志监控"><a href="#日志监控" class="headerlink" title="日志监控"></a>日志监控</h1><p>可以调整日志级别，</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">level:</span><br>    <span class="hljs-attr">org.springframework.cloud.gateway:</span> <span class="hljs-string">trace</span><br></code></pre></td></tr></table></figure><p>可以使用elk收集日志。</p><p>可以加入actuator监控</p>]]></content>
    
    
    <categories>
      
      <category>spring_cloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring_cloud</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring_boot查找配置文件源码分析</title>
    <link href="/2022/06/22/spring/spring_boot%E6%9F%A5%E6%89%BE%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <url>/2022/06/22/spring/spring_boot%E6%9F%A5%E6%89%BE%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>1.找到配置文件</p><p>2.根据profile加载对应的文件或属性</p><p>3.把加载后的属性放到spring 容器中</p><p>spring boot项目的入口为main方法</p><p>加载配置的入口是有设计的。是观察者设计模式。</p><figure class="highlight reasonml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SpringApplication</span>.</span></span>run(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SpringLogbackApplication</span>.</span></span><span class="hljs-keyword">class</span>, args);<br><span class="hljs-keyword">new</span> <span class="hljs-constructor">SpringApplication(<span class="hljs-params">primarySources</span>)</span><br>set<span class="hljs-constructor">Listeners((Collection)</span> get<span class="hljs-constructor">SpringFactoriesInstances(ApplicationListener.<span class="hljs-params">class</span>)</span>);<br>spring.factories<br>ConfigFileApplicationListener<br><br><br>public ConfigurableApplicationContext run(String... args)<br>ConfigurableEnvironment environment = prepare<span class="hljs-constructor">Environment(<span class="hljs-params">listeners</span>, <span class="hljs-params">applicationArguments</span>)</span>;<br>listeners.environment<span class="hljs-constructor">Prepared(<span class="hljs-params">environment</span>)</span>;<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConfigFileApplicationListener</span>.</span></span>on<span class="hljs-constructor">ApplicationEvent(ApplicationEvent <span class="hljs-params">event</span>)</span> <br><span class="hljs-keyword">private</span> void on<span class="hljs-constructor">ApplicationEnvironmentPreparedEvent(ApplicationEnvironmentPreparedEvent <span class="hljs-params">event</span>)</span><br>public void post<span class="hljs-constructor">ProcessEnvironment(ConfigurableEnvironment <span class="hljs-params">environment</span>, SpringApplication <span class="hljs-params">application</span>)</span><br>protected void add<span class="hljs-constructor">PropertySources(ConfigurableEnvironment <span class="hljs-params">environment</span>, ResourceLoader <span class="hljs-params">resourceLoader</span>)</span><br><span class="hljs-keyword">new</span> <span class="hljs-constructor">Loader(<span class="hljs-params">environment</span>, <span class="hljs-params">resourceLoader</span>)</span>.load<span class="hljs-literal">()</span>;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">()</span> &#123;<br>FilteredPropertySource.apply(<span class="hljs-built_in">this</span>.environment, DEFAULT_PROPERTIES, LOAD_FILTERED_PROPERTY,<br>(defaultProperties) -&gt; &#123;<br><span class="hljs-built_in">this</span>.profiles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br><span class="hljs-built_in">this</span>.processedProfiles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br><span class="hljs-built_in">this</span>.activatedProfiles = <span class="hljs-literal">false</span>;<br><span class="hljs-built_in">this</span>.loaded = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();<br>initializeProfiles();<br><span class="hljs-keyword">while</span> (!<span class="hljs-built_in">this</span>.profiles.isEmpty()) &#123;<br><span class="hljs-type">Profile</span> <span class="hljs-variable">profile</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.profiles.poll();<br><span class="hljs-keyword">if</span> (isDefaultProfile(profile)) &#123;<br>addProfileToEnvironment(profile.getName());<br>&#125;<br>            <span class="hljs-comment">// 加载配置文件</span><br>load(profile, <span class="hljs-built_in">this</span>::getPositiveProfileFilter,<br>addToLoaded(MutablePropertySources::addLast, <span class="hljs-literal">false</span>));<br><span class="hljs-built_in">this</span>.processedProfiles.add(profile);<br>&#125;<br>load(<span class="hljs-literal">null</span>, <span class="hljs-built_in">this</span>::getNegativeProfileFilter, addToLoaded(MutablePropertySources::addFirst, <span class="hljs-literal">true</span>));<br><span class="hljs-comment">// 添加到spring 环境</span><br>          addLoadedPropertySources();<br>          <span class="hljs-comment">// 设置启用的profile</span><br>applyActiveProfiles(defaultProperties);<br>&#125;);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">(Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)</span> &#123;<br>getSearchLocations().forEach((location) -&gt; &#123;<br><span class="hljs-type">boolean</span> <span class="hljs-variable">isDirectory</span> <span class="hljs-operator">=</span> location.endsWith(<span class="hljs-string">&quot;/&quot;</span>);<br>Set&lt;String&gt; names = isDirectory ? getSearchNames() : NO_SEARCH_NAMES;<br>names.forEach((name) -&gt; load(location, name, profile, filterFactory, consumer));<br>&#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>这里涉及到3个值：去哪里找配置文件(location)、配置文件的名称是什么(getSearchNames)、不同环境(profile)</p><p>location位置： classpath:&#x2F;, classpath:&#x2F;config&#x2F;, file:.&#x2F;, file:.&#x2F;config&#x2F; 优先级从低到高，最先加载file:.&#x2F;config&#x2F; 位置的配置文件；如果配置了spring.config.location属性则取这个属性的值。</p><p>配置文件的名字：默认值为：application;如果配置了spring.config.name属性则取改属性值。</p><p>环境为上面传进来的：自定义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">(String location, String name, Profile profile, DocumentFilterFactory filterFactory,</span><br><span class="hljs-params">DocumentConsumer consumer)</span> &#123;<br><span class="hljs-keyword">if</span> (!StringUtils.hasText(name)) &#123;<br><span class="hljs-keyword">for</span> (PropertySourceLoader loader : <span class="hljs-built_in">this</span>.propertySourceLoaders) &#123;<br><span class="hljs-keyword">if</span> (canLoadFileExtension(loader, location)) &#123;<br>load(loader, location, profile, filterFactory.getDocumentFilter(profile), consumer);<br><span class="hljs-keyword">return</span>;<br>&#125;<br>&#125;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;File extension of config file location &#x27;&quot;</span> + location<br>+ <span class="hljs-string">&quot;&#x27; is not known to any PropertySourceLoader. If the location is meant to reference &quot;</span><br>+ <span class="hljs-string">&quot;a directory, it must end in &#x27;/&#x27;&quot;</span>);<br>&#125;<br>Set&lt;String&gt; processed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br><span class="hljs-keyword">for</span> (PropertySourceLoader loader : <span class="hljs-built_in">this</span>.propertySourceLoaders) &#123;<br><span class="hljs-keyword">for</span> (String fileExtension : loader.getFileExtensions()) &#123;<br><span class="hljs-keyword">if</span> (processed.add(fileExtension)) &#123;<br>loadForFileExtension(loader, location + name, <span class="hljs-string">&quot;.&quot;</span> + fileExtension, profile, filterFactory,<br>consumer);<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>到这里就根据不同的文件名后缀来获取了。</p><p>所有的扩展名： properties xml yml yaml</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>Application   ConfigFileApplicationListener</p><p><a href="https://blog.csdn.net/weixin_43732955/article/details/106600869">https://blog.csdn.net/weixin_43732955/article/details/106600869</a></p><p>bootstrap    BootstrapApplicationListener</p><p><a href="https://baijiahao.baidu.com/s?id=1720638939882107917&amp;wfr=spider&amp;for=pc">https://baijiahao.baidu.com/s?id=1720638939882107917&amp;wfr=spider&amp;for=pc</a></p>]]></content>
    
    
    <categories>
      
      <category>spring boot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring boot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hystrix怎么做的</title>
    <link href="/2022/06/16/spring_cloud/hystrix%E6%80%8E%E4%B9%88%E5%81%9A%E7%9A%84/"/>
    <url>/2022/06/16/spring_cloud/hystrix%E6%80%8E%E4%B9%88%E5%81%9A%E7%9A%84/</url>
    
    <content type="html"><![CDATA[<h2 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h2><p>下图显示了当您通过 Hystrix 向服务依赖项发出请求时会发生什么：</p><p><img src="/.com//hystrix10.png" alt="hystrix10"></p><p>以下部分将更详细地解释此流程：</p><ol><li><a href="https://github.com/Netflix/Hystrix/wiki/How-it-Works#flow1">构造一个<code>HystrixCommand</code>或<code>HystrixObservableCommand</code>对象</a></li><li><a href="https://github.com/Netflix/Hystrix/wiki/How-it-Works#flow2">执行命令</a></li><li><a href="https://github.com/Netflix/Hystrix/wiki/How-it-Works#flow3">响应是否缓存？</a></li><li><a href="https://github.com/Netflix/Hystrix/wiki/How-it-Works#flow4">电路是否打开？</a></li><li><a href="https://github.com/Netflix/Hystrix/wiki/How-it-Works#flow5">线程池&#x2F;队列&#x2F;信号量是否已满？</a></li><li><a href="https://github.com/Netflix/Hystrix/wiki/How-it-Works#flow6"><code>HystrixObservableCommand.construct()</code>或者<code>HystrixCommand.run()</code></a></li><li><a href="https://github.com/Netflix/Hystrix/wiki/How-it-Works#flow7">计算电路健康</a></li><li><a href="https://github.com/Netflix/Hystrix/wiki/How-it-Works#flow8">获取后备</a></li><li><a href="https://github.com/Netflix/Hystrix/wiki/How-it-Works#flow9">返回成功的响应</a></li></ol><h3 id="1-构造一个HystrixCommand或HystrixObservableCommand对象"><a href="#1-构造一个HystrixCommand或HystrixObservableCommand对象" class="headerlink" title="1.构造一个HystrixCommand或HystrixObservableCommand对象"></a>1.构造一个<code>HystrixCommand</code>或<code>HystrixObservableCommand</code>对象</h3><p>第一步是构造一个<code>HystrixCommand</code>或<code>HystrixObservableCommand</code>对象来表示您对依赖项发出的请求。向构造函数传递发出请求时需要的任何参数。</p><p><a href="http://netflix.github.com/Hystrix/javadoc/index.html?com/netflix/hystrix/HystrixCommand.html"><code>HystrixCommand</code></a>如果期望依赖项返回单个响应，则构造一个对象。例如：</p><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">HystrixCommand</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HystrixCommand</span>(arg1, arg2);<br></code></pre></td></tr></table></figure><p><a href="http://netflix.github.com/Hystrix/javadoc/index.html?com/netflix/hystrix/HystrixObservableCommand.html"><code>HystrixObservableCommand</code></a>如果期望依赖项返回一个发出响应的 Observable，则构造一个对象。例如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">HystrixObservableCommand</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HystrixObservableCommand</span>(arg1, arg2);<br></code></pre></td></tr></table></figure><h3 id="2-执行命令"><a href="#2-执行命令" class="headerlink" title="2.执行命令"></a>2.执行命令</h3><p>有四种方法可以执行命令，通过使用 Hystrix 命令对象的以下四种方法之一（前两种仅适用于简单<code>HystrixCommand</code>对象，不适用于<code>HystrixObservableCommand</code>）：</p><ul><li><a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixCommand.html#execute()"><code>execute()</code></a>— 阻塞，然后返回从依赖项接收到的单个响应（或在发生错误时抛出异常）</li><li><a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixCommand.html#queue()"><code>queue()</code></a>— 返回 a <code>Future</code>，您可以使用它从依赖项中获取单个响应</li><li><a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixObservableCommand.html#observe()"><code>observe()</code></a>— 订阅<code>Observable</code>表示来自依赖项的响应的 ，并返回一个<code>Observable</code>复制该源的<code>Observable</code></li><li><a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixObservableCommand.html#toObservable()"><code>toObservable()</code></a>— 返回一个<code>Observable</code>，当您订阅它时，将执行 Hystrix 命令并发出它的响应</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">K</span>             <span class="hljs-variable">value</span>   <span class="hljs-operator">=</span> command.execute();<br>Future&lt;K&gt;     fValue  = command.queue();<br>Observable&lt;K&gt; ohValue = command.observe();         <span class="hljs-comment">//hot observable</span><br>Observable&lt;K&gt; ocValue = command.toObservable();    <span class="hljs-comment">//cold observable</span><br></code></pre></td></tr></table></figure><p>同步调用<code>execute()</code>调用<code>queue().get()</code>. <code>queue()</code>反过来调用<code>toObservable().toBlocking().toFuture()</code>. 也就是说，最终每个<code>HystrixCommand</code>都由一个<a href="http://reactivex.io/documentation/observable.html"><code>Observable</code></a>实现支持，即使是那些旨在返回单个简单值的命令。</p><h3 id="3-响应是否被缓存？"><a href="#3-响应是否被缓存？" class="headerlink" title="3. 响应是否被缓存？"></a>3. 响应是否被缓存？</h3><p>如果该命令启用了请求缓存，并且缓存中有对请求的响应，则缓存的响应将立即以<code>Observable</code>. （请参阅下面的<a href="https://github.com/Netflix/Hystrix/wiki/How-it-Works#RequestCaching">“请求缓存”</a>。）</p><h3 id="4-电路是否开路？"><a href="#4-电路是否开路？" class="headerlink" title="4. 电路是否开路？"></a>4. 电路是否开路？</h3><p>当您执行命令时，Hystrix 会检查断路器以查看电路是否打开。</p><p>如果电路打开（或“跳闸”），则 Hystrix 不会执行命令，但会将流程路由到 (8) Get the Fallback。</p><p>如果电路闭合，则流程进行到 (5) 以检查是否有容量可用于运行命令。</p><h3 id="5-线程池-x2F-队列-x2F-信号量是否已满？"><a href="#5-线程池-x2F-队列-x2F-信号量是否已满？" class="headerlink" title="5. 线程池&#x2F;队列&#x2F;信号量是否已满？"></a>5. 线程池&#x2F;队列&#x2F;信号量是否已满？</h3><p>如果与命令关联的线程池和队列（或信号量，如果未在线程中运行）已满，则 Hystrix 将不执行命令，但会立即将流路由到 (8) Get the Fallback。</p><h3 id="6-HystrixObservableCommand-construct-或HystrixCommand-run"><a href="#6-HystrixObservableCommand-construct-或HystrixCommand-run" class="headerlink" title="6.HystrixObservableCommand.construct()或HystrixCommand.run()"></a>6.<code>HystrixObservableCommand.construct()</code>或<code>HystrixCommand.run()</code></h3><p>在这里，Hystrix 通过您为此目的编写的方法调用对依赖项的请求，以下方法之一：</p><ul><li><a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixCommand.html#run()"><code>HystrixCommand.run()</code></a>— 返回单个响应或抛出异常</li><li><a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixObservableCommand.html#construct()"><code>HystrixObservableCommand.construct()</code></a>— 返回一个发出响应或发送<code>onError</code>通知的 Observable</li></ul><p>如果<code>run()</code>or<code>construct()</code>方法超过了命令的超时值，线程将抛出一个<code>TimeoutException</code>（或者一个单独的计时器线程，如果命令本身没有在它自己的线程中运行）。在这种情况下，Hystrix 通过 8 路由响应。获取 Fallback，如果该方法没有取消&#x2F;中断，它会丢弃最终的返回值<code>run()</code>或方法。<code>construct()</code></p><p>请注意，没有办法强制潜在线程停止工作——Hystrix 在 JVM 上可以做的最好的事情就是抛出一个 InterruptedException。如果 Hystrix 包裹的工作不考虑 InterruptedExceptions，Hystrix 线程池中的线程将继续工作，尽管客户端已经收到了 TimeoutException。这种行为可能会使 Hystrix 线程池饱和，尽管负载是“正确卸载”的。大多数 Java HTTP 客户端库不解释 InterruptedExceptions。因此，请确保在 HTTP 客户端上正确配置连接和读&#x2F;写超时。</p><p>如果该命令没有抛出任何异常并且它返回了响应，Hystrix 会在执行一些日志记录和指标报告后返回此响应。在 的情况下<code>run()</code>，Hystrix 返回一个<code>Observable</code>发出单个响应然后发出<code>onCompleted</code>通知的 在<code>construct()</code>Hystrix的情况下，<code>Observable</code>返回由<code>construct()</code>.</p><h3 id="7-计算电路健康"><a href="#7-计算电路健康" class="headerlink" title="7.计算电路健康"></a>7.计算电路健康</h3><p>Hystrix 向断路器报告成功、失败、拒绝和超时，断路器维护一组滚动的计数器来计算统计信息。</p><p>它使用这些统计数据来确定电路何时应该“跳闸”，此时它会短路任何后续请求，直到经过恢复期，然后在首先检查某些健康检查后再次关闭电路。</p><h3 id="8-获得后备"><a href="#8-获得后备" class="headerlink" title="8. 获得后备"></a>8. 获得后备</h3><p><code>construct()</code>每当命令执行失败时，Hystrix 都会尝试恢复到您的回退：当or (6.)抛出异常<code>run()</code>时，当由于电路打开 (4.) 而导致命令短路时，当命令的线程池和队列或信号量达到容量 (5.)，或者当命令超过其超时长度时。</p><p>编写您的回退以从内存缓存或其他静态逻辑提供通用响应，而无需任何网络依赖。<em>如果您必须在回退中使用网络调用，您应该通过另一个<code>HystrixCommand</code>或<code>HystrixObservableCommand</code>.</em></p><p>在 a 的情况下<code>HystrixCommand</code>，提供您实现的回退逻辑，<a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixCommand.html#getFallback()"><code>HystrixCommand.getFallback()</code></a>该逻辑返回单个回退值。</p><p>在 a 的情况下<code>HystrixObservableCommand</code>，提供您实现的回退逻辑，<a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixObservableCommand.html#resumeWithFallback()"><code>HystrixObservableCommand.resumeWithFallback()</code></a>该逻辑返回一个可能发出一个或多个回退值的 Observable。</p><p>如果 fallback 方法返回一个响应，那么 Hystrix 将这个响应返回给调用者。对于 a <code>HystrixCommand.getFallback()</code>，它将返回一个 Observable ，该 Observable 发出从该方法返回的值。在这种情况下，<code>HystrixObservableCommand.resumeWithFallback()</code>它将返回从方法返回的相同 Observable。</p><p>如果你没有为你的 Hystrix 命令实现一个回退方法，或者如果回退本身抛出一个异常，Hystrix 仍然返回一个 Observable，但它什么都不发出并立即终止并发出<code>onError</code>通知。正是通过这个<code>onError</code>通知，导致命令失败的异常被传回给调用者。（实施可能失败的回退实现是一种糟糕的做法。您应该实施回退，使其不执行任何可能失败的逻辑。）</p><p>失败或不存在的回退的结果将根据您调用 Hystrix 命令的方式而有所不同：</p><ul><li><code>execute()</code>— 抛出异常</li><li><code>queue()</code>— 成功返回 a <code>Future</code>，但是如果调用它的方法<code>Future</code>会抛出异常<code>get()</code></li><li><code>observe()</code>— 返回一个<code>Observable</code>，当您订阅它时，将通过调用订阅者的<code>onError</code>方法立即终止</li><li><code>toObservable()</code>— 返回一个<code>Observable</code>，当您订阅它时，将通过调用订阅者的<code>onError</code>方法终止</li></ul><h3 id="9-返回成功响应"><a href="#9-返回成功响应" class="headerlink" title="9. 返回成功响应"></a>9. 返回成功响应</h3><p>如果 Hystrix 命令成功，它将以<code>Observable</code>. 根据您在上述步骤 2 中调用命令的方式，<code>Observable</code>在返回给您之前可能会对其进行转换：</p><p><img src="/.com//hystrix11.png" alt="hystrix11"></p><ul><li><code>execute()``Future</code>— 以与 dos相同的方式获得 a ，<code>.queue()</code>然后调用<code>get()</code>它<code>Future</code>以获取由 the 发出的单个值<code>Observable</code></li><li><code>queue()</code>— 将 the<code>Observable</code>转换为 a<code>BlockingObservable</code>以便可以将其转换为 a <code>Future</code>，然后返回 this<code>Future</code></li><li><code>observe()</code>— 立即订阅<code>Observable</code>并开始执行命令的流程；返回一个<code>Observable</code>，当您<code>subscribe</code>访问它时，会重放排放和通知</li><li><code>toObservable()</code>— 返回未<code>Observable</code>更改的；您必须<code>subscribe</code>这样做才能真正开始导致执行命令的流程</li></ul><h2 id="断路器"><a href="#断路器" class="headerlink" title="断路器"></a>断路器</h2><p>下图显示了 a <code>HystrixCommand</code>or<code>HystrixObservableCommand</code>与 a 的交互方式<a href="http://netflix.github.io/Hystrix/javadoc/index.html?com/netflix/hystrix/HystrixCircuitBreaker.html"><code>HystrixCircuitBreaker</code></a>及其逻辑和决策流程，包括计数器在断路器中的行为方式。</p><p><img src="/.com//hystrix12.png" alt="hystrix12"></p><p>电路开闭发生的具体方式如下：</p><ol><li>假设整个电路的音量满足某个阈值 ( <code>HystrixCommandProperties.circuitBreakerRequestVolumeThreshold()</code>)…</li><li>并假设错误百分比超过阈值错误百分比（<code>HystrixCommandProperties.circuitBreakerErrorThresholdPercentage()</code>）……</li><li>然后断路器从 转变<code>CLOSED</code>为<code>OPEN</code>。</li><li>当它打开时，它会将针对该断路器的所有请求短路。</li><li>一段时间后（<code>HystrixCommandProperties.circuitBreakerSleepWindowInMilliseconds()</code>），下一个请求被允许通过（这是<code>HALF-OPEN</code>状态）。如果请求失败，断路器将<code>OPEN</code>在睡眠窗口期间返回状态。如果请求成功，断路器转换到<strong>1.</strong><code>CLOSED</code>中的逻辑再次接管。</li></ol><h2 id="隔离"><a href="#隔离" class="headerlink" title="隔离"></a>隔离</h2><p>Hystrix 使用隔板模式来隔离彼此的依赖关系并限制对其中任何一个的并发访问。</p><p><img src="/.com//hystrix13.png" alt="hystrix13"></p><h3 id="线程和线程池"><a href="#线程和线程池" class="headerlink" title="线程和线程池"></a>线程和线程池</h3><p>客户端（库、网络调用等）在不同的线程上执行。这将它们与调用线程（Tomcat 线程池）隔离开来，以便调用者可以“离开”耗时过长的依赖调用。</p><p>Hystrix 使用单独的、每个依赖项的线程池作为约束任何给定依赖项的一种方式，因此底层执行的延迟将仅使该池中的可用线程饱和。</p><p><img src="/.com//hystrix14.png" alt="hystrix14"></p><p>您可以在不使用线程池的情况下防止失败，但这需要受信任的客户端非常快速地失败（网络连接&#x2F;读取超时和重试配置）并始终表现良好。</p><p>Netflix 在其 Hystrix 的设计中，出于多种原因选择使用线程和线程池来实现隔离，包括：</p><ul><li>许多应用程序针对由许多不同团队开发的数十种不同服务执行数十种（有时甚至超过 100 次）不同的后端服务调用。</li><li>每个服务都提供自己的客户端库。</li><li>客户端库一直在变化。</li><li>客户端库逻辑可以更改以添加新的网络调用。</li><li>客户端库可以包含诸如重试、数据解析、缓存（内存中或跨网络）和其他此类行为之类的逻辑。</li><li>客户端库往往是“黑匣子”——对于用户来说，实现细节、网络访问模式、配置默认值等都是不透明的。</li><li>在几次实际的生产中断中，决定是“哦，有些东西发生了变化，应该调整属性”或“客户端库改变了它的行为”。</li><li>即使客户端本身没有变化，服务本身也会发生变化，这会影响性能特征，进而导致客户端配置无效。</li><li>传递依赖可能会引入其他未预期且可能未正确配置的客户端库。</li><li>大多数网络访问是同步执行的。</li><li>失败和延迟也可能发生在客户端代码中，而不仅仅是网络调用。</li></ul><p><img src="/.com//hystrix15.png" alt="hystrix15"></p><h4 id="线程池的好处"><a href="#线程池的好处" class="headerlink" title="线程池的好处"></a>线程池的好处</h4><p>通过自己的线程池中的线程进行隔离的好处是：</p><ul><li>该应用程序完全不受失控客户端库的影响。给定依赖库的池可以填满，而不会影响应用程序的其余部分。</li><li>该应用程序可以接受风险低得多的新客户端库。如果出现问题，它会与库隔离，不会影响其他所有内容。</li><li>当失败的客户端再次恢复健康时，线程池将清理干净，应用程序立即恢复健康的性能，而不是整个 Tomcat 容器不堪重负时的长时间恢复。</li><li>如果客户端库配置错误，线程池的健康状况将很快证明这一点（通过增加的错误、延迟、超时、拒绝等），您可以在不影响应用程序功能的情况下处理它（通常通过动态属性实时处理） .</li><li>如果客户端服务更改了性能特征（这种情况经常发生，足以成为一个问题），进而导致需要调整属性（增加&#x2F;减少超时、更改重试等），这再次通过线程池指标（错误、延迟）变得可见、超时、拒绝），并且可以在不影响其他客户端、请求或用户的情况下进行处理。</li><li>除了隔离优势之外，拥有专用线程池还提供了内置的并发性，可用于在同步客户端库之上构建异步外观（类似于 Netflix API 如何在 Hystrix 命令之上构建反应式、完全异步的 Java API） .</li></ul><p>简而言之，线程池提供的隔离允许客户端库和子系统性能特征的不断变化和动态组合得到妥善处理，而不会导致中断。</p><p><strong>注意：</strong>尽管单独的线程提供了隔离，但您的底层客户端代码也应该有超时和&#x2F;或响应线程中断，因此它不会无限期地阻塞并使 Hystrix 线程池饱和。</p><h4 id="线程池的缺点"><a href="#线程池的缺点" class="headerlink" title="线程池的缺点"></a>线程池的缺点</h4><p>线程池的主要缺点是它们增加了计算开销。每个命令执行都涉及在单独线程上运行命令所涉及的排队、调度和上下文切换。</p><p>Netflix 在设计这个系统时，决定接受这种开销的成本以换取它提供的好处，并认为它足够小，不会对成本或性能产生重大影响。</p><h4 id="线程成本"><a href="#线程成本" class="headerlink" title="线程成本"></a>线程成本</h4><p>Hystrix 测量在子线程上执行<code>construct()</code>or<code>run()</code>方法时的延迟以及在父线程上的总端到端时间。通过这种方式，您可以看到 Hystrix 开销（线程、指标、日志记录、断路器等）的成本。</p><p>Netflix API 每天使用线程隔离处理 10+ 亿次 Hystrix 命令执行。每个 API 实例有 40 多个线程池，每个线程池有 5-20 个线程（大多数设置为 10）。</p><p>下图表示<code>HystrixCommand</code>在单个 API 实例上以每秒 60 个请求的速度执行（每台服务器每秒大约 350 个总线程执行）：</p><p><img src="/.com//hystrix16.png" alt="hystrix16"></p><p>在中位数（或更低），拥有一个单独的线程是没有成本的。</p><p>在第 90个百分位，有一个单独的线程需要 3 毫秒的成本。</p><p>在第 99个百分位，有一个单独的线程需要 9 毫秒。但是请注意，成本的增加远小于单独线程（网络请求）的执行时间增加，后者从 2 跳到 28，而成本从 0 跳到 9。</p><p>对于大多数Netflix用例而言，此类电路的 90% 或更高的开销已被认为是可以接受的，因为可以实现弹性优势。</p><p>对于包装非常低延迟请求的电路（例如那些主要命中内存缓存的请求），开销可能太高，在这些情况下，您可以使用另一种方法，例如可尝试的信号量，虽然它们不允许超时，无需开销即可提供大部分弹性优势。然而，一般来说，开销足够小，以至于 Netflix 在实践中通常更喜欢单独线程的隔离优势而不是此类技术。</p><h3 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h3><p>您可以使用信号量（或计数器）来限制对任何给定依赖项的并发调用数，而不是使用线程池&#x2F;队列大小。这允许 Hystrix 在不使用线程池的情况下减轻负载，但它不允许超时和走开。如果您信任客户端并且只想要减载，则可以使用这种方法。</p><p><code>HystrixCommand</code>并<code>HystrixObservableCommand</code>在两个地方支持信号量：</p><ul><li><strong>后备：</strong>当 Hystrix 检索后备时，它总是在调用 Tomcat 线程上这样做。</li><li><strong>执行：</strong>如果你设置这个属性<code>execution.isolation.strategy</code>，<code>SEMAPHORE</code>那么 Hystrix 将使用信号量而不是线程来限制调用命令的并发父线程的数量。</li></ul><p>您可以通过定义可以执行多少并发线程的动态属性来配置信号量的这两种用途。您应该使用与调整线程池大小时使用的类似计算来调整它们的大小（在亚毫秒时间内返回的内存调用可以在信号量仅为 1 或 2 的情况下执行超过 5000rps ……但默认值为 10）。</p><p><strong>注意：</strong>如果一个依赖被信号量隔离然后变成潜在的，父线程将保持阻塞，直到底层网络调用超时。</p><p>一旦达到限制，信号量拒绝将开始，但填充信号量的线程不能走开。</p><h2 id="请求折叠"><a href="#请求折叠" class="headerlink" title="请求折叠"></a>请求折叠</h2><p>您可以在 a 前面<code>HystrixCommand</code>加上一个请求折叠器（<a href="http://netflix.github.io/Hystrix/javadoc/index.html?com/netflix/hystrix/HystrixCollapser.html"><code>HystrixCollapser</code></a>是抽象父级），您可以使用它将多个请求折叠到一个后端依赖调用中。</p><p>下图显示了两种情况下的线程数和网络连接数：首先没有请求折叠，然后请求折叠（假设所有连接在很短的时间窗口内“并发”，在本例中为 10 毫秒）。</p><p><img src="/.com//hystrix17.png" alt="hystrix17"></p><h3 id="为什么使用请求折叠？"><a href="#为什么使用请求折叠？" class="headerlink" title="为什么使用请求折叠？"></a>为什么使用请求折叠？</h3><p>使用请求折叠来减少执行并发<code>HystrixCommand</code>执行所需的线程数和网络连接数。请求折叠以自动方式执行此操作，不会强制代码库的所有开发人员协调手动批处理请求。</p><h4 id="全局上下文（跨所有-Tomcat-线程）"><a href="#全局上下文（跨所有-Tomcat-线程）" class="headerlink" title="全局上下文（跨所有 Tomcat 线程）"></a>全局上下文（跨所有 Tomcat 线程）</h4><p>理想的折叠类型是在全局应用程序级别完成的，因此来自任何 Tomcat 线程上的<em>任何用户</em>的请求都可以折叠在一起。</p><p>例如，如果您将 a 配置<code>HystrixCommand</code>为支持任何用户对检索电影评级的依赖项的请求进行批处理，那么当同一 JVM 中的任何用户线程发出此类请求时，Hystrix 会将其请求与任何其他请求一起添加到同一个折叠的网络通话。</p><p>请注意，折叠器会将单个 HystrixRequestContext 对象传递给折叠的网络调用，因此下游系统必须处理这种情况才能成为有效的选项。</p><h4 id="用户请求上下文（单个-Tomcat-线程）"><a href="#用户请求上下文（单个-Tomcat-线程）" class="headerlink" title="用户请求上下文（单个 Tomcat 线程）"></a>用户请求上下文（单个 Tomcat 线程）</h4><p>如果您将 a 配置<code>HystrixCommand</code>为仅处理<em>单个用户的</em>批处理请求，则 Hystrix 可以折叠来自单个 Tomcat 线程（请求）的请求。</p><p>例如，如果用户想要为 300 个视频对象加载书签，而不是执行 300 个网络调用，Hystrix 可以将它们全部合并为一个。</p><h4 id="对象建模和代码复杂性"><a href="#对象建模和代码复杂性" class="headerlink" title="对象建模和代码复杂性"></a>对象建模和代码复杂性</h4><p>有时，当您创建对对象的消费者具有逻辑意义的对象模型时，这与对象生产者的有效资源利用不匹配。</p><p>例如，给定一个包含 300 个视频对象的列表，遍历它们并调用<code>getSomeAttribute()</code>每个对象是一个明显的对象模型，但如果实施得天真，可能会导致 300 个网络调用都在几毫秒内进行（并且很可能会导致资源饱和）。</p><p>您可以通过手动方式处理此问题，例如在允许用户调用之前<code>getSomeAttribute()</code>，要求他们声明他们想要获取哪些视频对象的属性，以便它们都可以被预取。</p><p>或者，您可以划分对象模型，以便用户必须从一个地方获取视频列表，然后从其他地方请求该视频列表的属性。</p><p>这些方法可能会导致笨拙的 API 和对象模型与心智模型和使用模式不匹配。当多个开发人员在代码库上工作时，它们还可能导致简单的错误和效率低下，因为为一个用例完成的优化可能会被另一个用例的实现和代码中的新路径破坏。</p><p>通过将折叠逻辑下推到 Hystrix 层，您如何创建对象模型、以什么顺序进行调用、或者不同的开发人员是否知道正在完成甚至需要完成的优化都无关紧要。</p><p>该<code>getSomeAttribute()</code>方法可以放在最适合的地方，并以适合使用模式的任何方式调用，并且折叠器将自动将调用批处理到时间窗口中。</p><h4 id="请求崩溃的成本是多少？"><a href="#请求崩溃的成本是多少？" class="headerlink" title="请求崩溃的成本是多少？"></a>请求崩溃的成本是多少？</h4><p>启用请求折叠的代价是在执行实际命令之前增加了延迟。最大成本是批处理窗口的大小。</p><p>如果您有一个执行中位数为 5 毫秒的命令，以及一个 10 毫秒的批处理窗口，那么在最坏的情况下执行时间可能会变为 15 毫秒。通常，请求不会恰好在窗口打开时被提交到窗口，因此中值惩罚是窗口时间的一半，在本例中为 5 毫秒。</p><p>该成本是否值得的确定取决于正在执行的命令。高延迟命令不会因少量额外的平均延迟而受到太大影响。此外，给定命令的并发量是关键：如果要批处理的请求很少超过 1 或 2 个，那么付出代价是没有意义的。事实上，在单线程顺序迭代中，崩溃将是一个主要的性能瓶颈，因为每次迭代都会等待 10 毫秒的批处理窗口时间。</p><p>然而，如果一个特定的命令被大量并发使用并且可以同时批处理数十甚至数百个调用，那么成本通常远远超过所获得的吞吐量增加，因为 Hystrix 减少了它所需的线程数和网络连接数依赖关系。</p><h4 id="折叠器流"><a href="#折叠器流" class="headerlink" title="折叠器流"></a>折叠器流</h4><p><img src="/.com//hystrix18.png" alt="hystrix18"></p><h2 id="请求缓存"><a href="#请求缓存" class="headerlink" title="请求缓存"></a>请求缓存</h2><p><code>HystrixCommand</code>并且<code>HystrixObservableCommand</code>实现可以定义一个缓存键，然后用于以并发感知的方式在请求上下文中对调用进行重复数据删除。</p><p>这是一个示例流程，涉及 HTTP 请求生命周期和在该请求中工作的两个线程：</p><p><img src="/.com//hystrix19.png" alt="hystrix19"></p><p>请求缓存的好处是：</p><ul><li>不同的代码路径可以执行 Hystrix 命令，而不用担心重复工作。</li></ul><p>这在许多开发人员正在实现不同功能的大型代码库中特别有用。</p><p>例如，所有需要获取用户<code>Account</code>对象的代码的多个路径都可以像这样请求它：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserGetAccount</span>(accountId).execute();<br><br><span class="hljs-comment">//or</span><br><br>Observable&lt;Account&gt; accountObservable = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserGetAccount</span>(accountId).observe();<br></code></pre></td></tr></table></figure><p>Hystrix<code>RequestCache</code>将执行底层<code>run()</code>方法一次且仅一次，并且执行该方法的两个线程<code>HystrixCommand</code>将接收相同的数据，尽管实例化了不同的实例。</p><ul><li>数据检索在整个请求中是一致的。</li></ul><p>不是每次执行命令时都可能返回不同的值（或回退），而是缓存第一个响应并为同一请求中的所有后续调用返回。</p><ul><li>消除重复的线程执行。</li></ul><p>由于请求缓存位于<code>construct()</code>or<code>run()</code>方法调用之前，Hystrix 可以在调用导致线程执行之前对其进行重复数据删除。</p><p>如果 Hystrix 没有实现请求缓存功能，那么每个命令都需要在<code>construct</code>or<code>run</code>方法中自己实现它，这将把它放在线程排队并执行之后。</p>]]></content>
    
    
    <categories>
      
      <category>hystrix</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hystrix</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hystrix学习</title>
    <link href="/2022/06/15/spring_cloud/hystrix%E5%AD%A6%E4%B9%A0/"/>
    <url>/2022/06/15/spring_cloud/hystrix%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h1 id="官网"><a href="#官网" class="headerlink" title="官网"></a>官网</h1><p><a href="https://github.com/Netflix/Hystrix">https://github.com/Netflix/Hystrix</a>  源码</p><p><a href="https://github.com/Netflix/Hystrix/wiki/">https://github.com/Netflix/Hystrix/wiki/</a>   wiki</p><ul><li><p><a href="https://github.com/Netflix/Hystrix/wiki/Getting-Started">Getting Started</a>  入门</p></li><li><p><a href="https://github.com/Netflix/Hystrix/wiki/How-it-Works">How it Works</a>  架构设计</p></li><li><p><a href="https://github.com/Netflix/Hystrix/wiki/How-To-Use">How To Use</a>  如何用</p></li></ul><h1 id="Hystrix-是什么"><a href="#Hystrix-是什么" class="headerlink" title="Hystrix 是什么"></a>Hystrix 是什么</h1><p>  在分布式环境下，难免出现许多服务之间调用失败的场景， Hystrix 是一个通过添加延迟容忍和容错逻辑帮助您控制这些分布式服务之间交互的库。 Hystrix 通过隔离服务之间的访问点来实现应用之间连锁故障（因下游服务失败，导致上游服务不可用），出现故障提供备选方案来提高应用整体的可用性。</p><p>  举例：抢购活动中，由于库存服务超时或者崩掉，可以通过提示抢购失败，请稍后重试等预防抢购应用不可用</p><h1 id="Hystrix-用来做什么"><a href="#Hystrix-用来做什么" class="headerlink" title="Hystrix 用来做什么"></a>Hystrix 用来做什么</h1><p> Hystrix 可以做一些事情：</p><ol><li>通过第三方客户端库，为控制延迟和依赖之间调用失败提供保护。</li><li>在复杂的分布式系统中阻止连锁故障</li><li>快速故障恢复</li><li>在可能的情况下，做到服务隔离和优雅降级</li><li>尽可能的实时监控、报警、运维控制</li></ol><h1 id="Hystrix-解决什么问题"><a href="#Hystrix-解决什么问题" class="headerlink" title="Hystrix 解决什么问题"></a>Hystrix 解决什么问题</h1><p>复杂的分布式应用有许多依赖调用，在某一时刻它们之间必然会出现失败，这就是导致应用整体故障的风险。</p><p>   例如，对于一个依赖于 30 个服务的应用程序，每个服务的正常运行时间为 99.99%，下面是您可以预期的结果。</p><p>   99.99 的 30 次方 &#x3D; 99.7% （意味着有 0.3% 的失败）</p><p>   10 亿 * 0.3% &#x3D; 300 万（10 亿次请求会有 300 万次请求失败）</p><p>   即使每个月在很好的正常运行的时间，也会有 2 个小时的停机。通常情况会被这个更糟糕。</p><p>当所有请求都很正常的情况下，请求流就会像下图一样：</p><p><img src="/.com//hystrix01.png" alt="hystrix01"></p><p>当很多后端系统有一个不稳定时，就会阻塞整个请求，如下图：</p><p><img src="/.com//hystrix02.png" alt="hystrix02"></p><p>在大量请求下，一个后端不理想的依赖都会成为阻塞整个应用请求的潜在风险</p><p>应用中任何一个通过网络或者客户端发出的请求都有可能成为网络请求失败的潜在风险，比请求失败更糟糕的是，应用调用依赖之间的延迟增加，更甚应用中的队列、线程池、其他系统资源造成的连锁故障</p><p><img src="/.com//hystrix03.png" alt="hystrix03"></p><p> 当通过第三方客户端进行网络访问，就是一个不清楚实现细节以及随时可能发生改变的黑盒执行，对于每个客户端，网络和资源配置都是不一样的，所以很难监控和更改。</p><p>  更糟糕的是，依赖调用之间，在不被应用显示调用的情况下，执行昂贵和容易出错的网络调用</p><p>  网络连接失败或者降级、服务与服务之间调用失败或者延迟，新库或服务部署改变方式或者性能特性</p><p>所有这些失败和延迟的情况都需要被隔离或者管理，这样就不会因为单个依赖的失败摧毁整个应用和系统。</p><h1 id="Hystrix-设计原则"><a href="#Hystrix-设计原则" class="headerlink" title="Hystrix 设计原则"></a>Hystrix 设计原则</h1><ol><li>防止单个应用耗尽服务器（比如 tomcat）所有可用线程</li><li>丢弃重负载、快速失败代替排队</li><li>为任何情况失败提供保护</li><li>使用隔离技术 (如隔板、泳道和断路器模式) 来限制任何一个依赖的影响</li><li>通过接近实时的度量、监视和警报来优化快速发现故障</li><li>Hystrix 在大部分方面依靠低延迟配置和动态配置优化恢复时间， 允许使用快速返回结果进行实时操作调整</li><li>保护整个依赖客户端执行中的失败，不仅仅是 网络流量中</li></ol><h1 id="Hystrix-如何实现目标"><a href="#Hystrix-如何实现目标" class="headerlink" title="Hystrix 如何实现目标"></a>Hystrix 如何实现目标</h1><ul><li><p>在 HystrixCommand 或 HystrixObservableCommand 对象中封装所有对外部系统 (或 “依赖项”) 的调用，该对象通常在单独的线程中执行 (这是命令模式的示例)</p></li><li><p>Hystrix 有一个默认值，如果调用时长超过这个默认值，认定为超时调用，大部分依赖可以通过配置自定义这个值，因此他们略高于依赖项的 99.5% 的性能</p></li><li><p>为每个依赖维护一个小的线程池 (或信号量); 如果它已满，将立即拒绝为该依赖指定的请求，而不是排队。</p></li><li><p>衡量成功、失败 (客户抛出的异常)、超时和线程拒绝</p></li><li><p>触发断路器，在一段时间内停止所有对某个服务的请求，如果服务的错误百分比超过阈值，则手动或自动停止</p></li><li><p>当一个请求失败、被拒绝、超时或短路时，执行备选逻辑</p></li><li><p>近实时的监控度量和配置的变化</p><p>当您使用 Hystrix 来包装每个基础依赖项时，图中所示的架构会发生变化，如下图所示。每个依赖项都是相互隔离的，当延迟发生时，它可能会被限制在资源中，并且在熔断器中覆盖，当任何类型的故障发生在依赖项中时，它决定了要做出什么响应</p></li></ul><p><img src="/.com//hystrix04.png" alt="hystrix04"></p><h1 id="hello-world"><a href="#hello-world" class="headerlink" title="hello world"></a>hello world</h1><p><a href="https://github.com/Netflix/Hystrix/blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandHelloWorld.java">查看源代码</a></p><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.netflix.hystrix<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hystrix-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.18<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommandHelloWorld01</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixCommand</span>&lt;String&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CommandHelloWorld01</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;ExampleGroup&quot;</span>));<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// a real example would do work like a network call here</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello &quot;</span> + name + <span class="hljs-string">&quot;!&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnitTest</span> &#123;<br><br>        <span class="hljs-meta">@Test</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSynchronous</span><span class="hljs-params">()</span> &#123; <span class="hljs-comment">//测试同步</span><br>            assertEquals(<span class="hljs-string">&quot;Hello World!&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandHelloWorld01</span>(<span class="hljs-string">&quot;World&quot;</span>).execute());<br>            assertEquals(<span class="hljs-string">&quot;Hello Bob!&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandHelloWorld01</span>(<span class="hljs-string">&quot;Bob&quot;</span>).execute());<br>        &#125;<br><br>        <span class="hljs-meta">@Test</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAsynchronous1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123; <span class="hljs-comment">//测试异步</span><br>            assertEquals(<span class="hljs-string">&quot;Hello World!&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandHelloWorld01</span>(<span class="hljs-string">&quot;World&quot;</span>).queue().get());<br>            assertEquals(<span class="hljs-string">&quot;Hello Bob!&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandHelloWorld01</span>(<span class="hljs-string">&quot;Bob&quot;</span>).queue().get());<br>        &#125;<br><br>        <span class="hljs-meta">@Test</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAsynchronous2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123; <span class="hljs-comment">//测试异步</span><br><br>            Future&lt;String&gt; fWorld = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandHelloWorld01</span>(<span class="hljs-string">&quot;World&quot;</span>).queue();<br>            Future&lt;String&gt; fBob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandHelloWorld01</span>(<span class="hljs-string">&quot;Bob&quot;</span>).queue();<br><br>            assertEquals(<span class="hljs-string">&quot;Hello World!&quot;</span>, fWorld.get());<br>            assertEquals(<span class="hljs-string">&quot;Hello Bob!&quot;</span>, fBob.get());<br>        &#125;<br><br>        <span class="hljs-meta">@Test</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testObservable</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>            Observable&lt;String&gt; fWorld = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandHelloWorld01</span>(<span class="hljs-string">&quot;World&quot;</span>).observe();<br>            Observable&lt;String&gt; fBob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandHelloWorld01</span>(<span class="hljs-string">&quot;Bob&quot;</span>).observe();<br><br>            <span class="hljs-comment">// blocking</span><br>            assertEquals(<span class="hljs-string">&quot;Hello World!&quot;</span>, fWorld.toBlocking().single());<br>            assertEquals(<span class="hljs-string">&quot;Hello Bob!&quot;</span>, fBob.toBlocking().single());<br><br>            fWorld.subscribe(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>&lt;String&gt;() &#123;<br><br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCompleted</span><span class="hljs-params">()</span> &#123;<br>                    <span class="hljs-comment">// 这里可以什么都不做</span><br>                &#125;<br><br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">(Throwable e)</span> &#123;<br>                    e.printStackTrace();<br>                &#125;<br><br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onNext</span><span class="hljs-params">(String v)</span> &#123;<br>                    System.out.println(<span class="hljs-string">&quot;onNext: &quot;</span> + v);<br>                &#125;<br><br>            &#125;);<br>            fBob.subscribe(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Action1</span>&lt;String&gt;() &#123;<br><br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">call</span><span class="hljs-params">(String v)</span> &#123;<br>                    System.out.println(<span class="hljs-string">&quot;onNext: &quot;</span> + v);<br>                &#125;<br><br>            &#125;);<br>        &#125;<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommandHelloWorld</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixObservableCommand</span>&lt;String&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CommandHelloWorld</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;ExampleGroup&quot;</span>));<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Observable&lt;String&gt; <span class="hljs-title function_">construct</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Observable.create(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Observable</span>.OnSubscribe&lt;String&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">call</span><span class="hljs-params">(Subscriber&lt;? <span class="hljs-built_in">super</span> String&gt; observer)</span> &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-keyword">if</span> (!observer.isUnsubscribed()) &#123;<br>                        <span class="hljs-comment">// a real example would do work like a network call here</span><br>                        <span class="hljs-comment">// observer.onNext(&quot;hello&quot;);  如果多个值下面observe.toBlocking().toFuture().get()会报错</span><br>                        observer.onNext(name + <span class="hljs-string">&quot;!&quot;</span>);<br>                        observer.onCompleted();<br>                    &#125;<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    observer.onError(e);<br>                &#125;<br>            &#125;<br>         &#125; ).subscribeOn(Schedulers.io());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>        <span class="hljs-type">CommandHelloWorld</span> <span class="hljs-variable">observableCommand</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandHelloWorld</span>(<span class="hljs-string">&quot;World&quot;</span>);<br>        Observable&lt;String&gt; observe = observableCommand.observe();<br>        System.out.println(observe.toBlocking().toFuture().get());<br>        observe.subscribe(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>&lt;String&gt;() &#123;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCompleted</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-comment">// 这里可以什么都不做</span><br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">(Throwable e)</span> &#123;<br>                e.printStackTrace();<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onNext</span><span class="hljs-params">(String v)</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;onNext: &quot;</span> + v);<br>            &#125;<br><br>        &#125;);<br>        observe.subscribe(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Action1</span>&lt;String&gt;() &#123;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">call</span><span class="hljs-params">(String v)</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;onNext: &quot;</span> + v);<br>            &#125;<br><br>        &#125;);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="同步执行"><a href="#同步执行" class="headerlink" title="同步执行"></a>同步执行</h2><p>通过 execute()方法同步调用 HystrixCommand的实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandHelloWorld01</span>(<span class="hljs-string">&quot;World&quot;</span>).execute();<br></code></pre></td></tr></table></figure><p>HystrixObservableCommand没有execute方法调用，如果清楚通过一个命令产生的 Observable必定仅仅产生一个单一的值，则可以对 Observable应用 RXjava 的操作 .toBlocking().toFuture().get()模拟 execute方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">CommandHelloWorld</span> <span class="hljs-variable">observableCommand</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandHelloWorld</span>(<span class="hljs-string">&quot;World&quot;</span>);<br>Observable&lt;String&gt; observe = observableCommand.observe();<br>System.out.println(observe.toBlocking().toFuture().get());<br></code></pre></td></tr></table></figure><h2 id="异步执行"><a href="#异步执行" class="headerlink" title="异步执行"></a>异步执行</h2><p>我们可以通过使用 queue() 方法异步执行 HystrixCommand ，示例如下： </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Future&lt;String&gt; fWorld = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandHelloWorld01</span>(<span class="hljs-string">&quot;World&quot;</span>).queue();<br></code></pre></td></tr></table></figure><p>我们可以通过 Future 获取到命令的结果集</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">String fw=fWorld.get()；<br></code></pre></td></tr></table></figure><p>HystrixObservableCommand没有简单的queuefor a等价物HystrixObservableCommand，但是如果您知道Observable这样的命令生成的 必须始终只生成一个值，您可以queue通过将 RxJava 运算符.toBlocking().toFuture()应用于Observable.</p><h2 id="响应式执行"><a href="#响应式执行" class="headerlink" title="响应式执行"></a>响应式执行</h2><p>可以通过一下任意方法监听 HystrixCommand 的结果：</p><ul><li>observe()  : 执行这个命令会返回一个热 Observable 立刻执行 hystrix 的命令 ，因为这个 Observable 通过 ReplaySubject 过滤，咱们不会有丢失订阅之前的任何东西的危险。</li><li>toObservable(): 执行这个命令会返回一个 “冷 “ Observable，直到订阅 Observable 才会开始执行命令和发送结果 。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Observable&lt;String&gt; fWorld = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandHelloWorld01</span>(<span class="hljs-string">&quot;World&quot;</span>).observe();<br></code></pre></td></tr></table></figure><p>执行完上面的代码，我们可以通过订阅 Observable 获取到它的值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">fWorld.subscribe(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Action1</span>&lt;String&gt;() &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">call</span><span class="hljs-params">(String v)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;onNext: &quot;</span> + v);<br>    &#125;<br><br>&#125;);<br></code></pre></td></tr></table></figure><h1 id="Fallback-降级"><a href="#Fallback-降级" class="headerlink" title="Fallback (降级)"></a>Fallback (降级)</h1><p><a href="https://github.com/Netflix/Hystrix/blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandHelloFailure.java">查看源代码</a></p><p>我们可以通过增加一个 fallback (回退) 方法在 hystrix 命令实现优雅降级，如果主命令失败，hystrix 可以获取一个默认值或者值集合。我们可能想为更多的可能失败的 hrstrix 命令实现一个回退方法，但是会有以下几种例外：</p><ul><li>执行写操作的命令</li></ul><p>​      如果设计的 hrstrix 命令是执行一个写操作而不是返回一个结果（这个写操作在 HystrixCommand通常返回 void，在 HystrixObservableCommand 返回一个空的可观察者），此场景下执行回退方法没有什么意义，如果写操作失败，服务方应该是希望告知调用方，让调用方再进一步处理。</p><ul><li>批处理系统 &#x2F; 离线分析</li></ul><p>​       如果 Hystrix 命令正在填充一个缓存，或者生成一个报告，或者做任何离线计算。如果发生错误，通常应该将错误告知调用方，让调用方做进一步处理，而不应该发送一个默认的响应。</p><p>​    如果命令执行异常，无论 Hystrix 命令是否有回退方法，hystrix 命令状态、断路器 &#x2F; 度量器都会更新为此条命令失败。</p><h2 id="HystrixCommand"><a href="#HystrixCommand" class="headerlink" title="HystrixCommand"></a>HystrixCommand</h2><p>​    在一个普通的HystrixCommand 中通过重写 getFallback() 方法实现一个回退方法，比如 run() 方法有异常， hystrix 会为所有类型的异常执行回退方法，比如 超时、线程池或信号量拒绝，以及断路器短路。 包含回退方法的示例如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HystrixHelloWorldFallback</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixCommand</span>&lt;String&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HystrixHelloWorldFallback</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;ExampleGroup&quot;</span>));<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;模拟异常!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">getFallback</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello Failure &quot;</span> + name + <span class="hljs-string">&quot;!&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">HystrixHelloWorldFallback</span> <span class="hljs-variable">hystrixHelloWorldFallback</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HystrixHelloWorldFallback</span>(<span class="hljs-string">&quot;word&quot;</span>);<br>        System.out.println(hystrixHelloWorldFallback.execute());<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>以上代码中 run（）方法永远会出现异常，调用者永远接收到的是 getFallback（）方法返回的值，不会接收到异常</p><h2 id="HystrixObservableCommand"><a href="#HystrixObservableCommand" class="headerlink" title="HystrixObservableCommand"></a>HystrixObservableCommand</h2><p> 对于 HystrixObservableCommand，需要通过重写 resumeWithFallback 方法，如果执行失败了，它就会从主观察者接管失败返回第二可观察者。这里需要注意的是，已经发送的一个或多个数据项之后，可观察者可能会失败，所以回退方法不应该假设它会发送观察者看到的唯一值。</p><p>在内部，Hystrix 使用 RxJava 的 onerrorerrorenext 操作符，在发生错误时，在主观察者和回退之间无缝切换。</p><h2 id="错误传播"><a href="#错误传播" class="headerlink" title="错误传播"></a>错误传播</h2><h3 id="HystrixCommand-1"><a href="#HystrixCommand-1" class="headerlink" title="HystrixCommand"></a>HystrixCommand</h3><p>  从 run（）方法抛出的除 HystrixBadRequestException异常外的所有异常，会统计异常次数、触发回退方法和短路逻辑。</p><p>  可以将想抛出的异常包装到 HystrixBadRequestException通过 getCause()方法查询它 ，HystrixBadRequestException适用于报告非法参数或非系统故障的场景，这些错误不应该与失败的指标相违背，也不应该触发回退逻辑。</p><h3 id="HystrixObservableCommand-1"><a href="#HystrixObservableCommand-1" class="headerlink" title="HystrixObservableCommand"></a>HystrixObservableCommand</h3><p>在 a 的情况下HystrixObservableCommand，不可恢复的错误会通过onError来自结果的通知返回Observable，并且回退是通过回退到 Hystrix 通过resumeWithFallback您实现的方法获得的第二个 Observable 来完成的。</p><h3 id="执行异常类型列表"><a href="#执行异常类型列表" class="headerlink" title="执行异常类型列表"></a>执行异常类型列表</h3><table><thead><tr><th>失败类型</th><th>异常类</th><th>异常原因</th><th>是否执行回退</th></tr></thead><tbody><tr><td>失败</td><td>HystrixRuntimeException</td><td>潜在异常（用户控制）</td><td>执行</td></tr><tr><td>超时</td><td>HystrixRuntimeException</td><td>j.u.c.TimeoutException</td><td>执行</td></tr><tr><td>短路</td><td>HystrixRuntimeException</td><td>j.l.RuntimeException</td><td>执行</td></tr><tr><td>线程池异常</td><td>HystrixRuntimeException</td><td>j.u.c.RejectedExecutionException</td><td>执行</td></tr><tr><td>信号量拒绝</td><td>HystrixRuntimeException</td><td>j.l.RuntimeException</td><td>执行</td></tr><tr><td>失败请求</td><td>HystrixBadRequestException</td><td>underlying exception (user-controlled)</td><td>不执行</td></tr></tbody></table><h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>HystrixCommand</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HystrixHelloWorldFallback</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixCommand</span>&lt;String&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HystrixHelloWorldFallback</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;ExampleGroup&quot;</span>));<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;hello&quot;</span>.equals(name)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;模拟异常!&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HystrixBadRequestException</span>(<span class="hljs-string">&quot;忽略异常!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">getFallback</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello Failure &quot;</span> + name + <span class="hljs-string">&quot;!&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">HystrixHelloWorldFallback</span> <span class="hljs-variable">hystrixHelloWorldFallback</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HystrixHelloWorldFallback</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>        System.out.println(hystrixHelloWorldFallback.execute());<br>        hystrixHelloWorldFallback = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HystrixHelloWorldFallback</span>(<span class="hljs-string">&quot;world&quot;</span>);<br>        System.out.println(hystrixHelloWorldFallback.execute());<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>发现hello 走了降级方法，world没有。</p><h1 id="命令名称"><a href="#命令名称" class="headerlink" title="命令名称"></a>命令名称</h1><p> 默认情况下，命令名称来源于类名。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">getClass().getSimpleName();<br></code></pre></td></tr></table></figure><p>如果要显示定义名称的话，可以通过 HystrixCommand 或者 HystrixObservableCommand 的构造函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">HystrixHelloWorldCommand</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-built_in">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;Command Group: Hello World&quot;</span>))<br>            .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="hljs-string">&quot;Command Name: Hello World&quot;</span>)));<br>    <span class="hljs-built_in">this</span>.name = name;<br>&#125;<br></code></pre></td></tr></table></figure><p> 为了给每个命令集合保存 Setter 配置，可以缓存 Setter，示例如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Setter</span> <span class="hljs-variable">cachedSetter</span> <span class="hljs-operator">=</span><br>        Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;ExampleGroup&quot;</span>))<br>                .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="hljs-string">&quot;Cache Setter: Hello World&quot;</span>));<br><span class="hljs-keyword">public</span> <span class="hljs-title function_">HystrixHelloWorldCommand</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-built_in">super</span>(cachedSetter);<br>    <span class="hljs-built_in">this</span>.name = name;<br>&#125;<br></code></pre></td></tr></table></figure><p>HystrixCommandKey 是一个接口，可以作为枚举或者普通类实现。其实它有一个辅助工厂类，示例如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">HystrixCommandKey.Factory.asKey(<span class="hljs-string">&quot;Command Name: Hello World&quot;</span>)<br></code></pre></td></tr></table></figure><p>HystrixCommandKey源码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HystrixCommandKey</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixKey</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Factory</span> &#123;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> InternMap&lt;String, HystrixCommandKey.Factory.HystrixCommandKeyDefault&gt; intern = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternMap</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueConstructor</span>&lt;String, HystrixCommandKey.Factory.HystrixCommandKeyDefault&gt;() &#123;<br>            <span class="hljs-keyword">public</span> HystrixCommandKey.Factory.HystrixCommandKeyDefault <span class="hljs-title function_">create</span><span class="hljs-params">(String key)</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HystrixCommandKey</span>.Factory.HystrixCommandKeyDefault(key);<br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-title function_">Factory</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HystrixCommandKey <span class="hljs-title function_">asKey</span><span class="hljs-params">(String name)</span> &#123;<br>            <span class="hljs-keyword">return</span> (HystrixCommandKey)intern.interned(name);<br>        &#125;<br><br>        <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCommandCount</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> intern.size();<br>        &#125;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HystrixCommandKeyDefault</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixKeyDefault</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HystrixCommandKey</span> &#123;<br>            <span class="hljs-keyword">public</span> <span class="hljs-title function_">HystrixCommandKeyDefault</span><span class="hljs-params">(String name)</span> &#123;<br>                <span class="hljs-built_in">super</span>(name);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="命令分组"><a href="#命令分组" class="headerlink" title="命令分组"></a>命令分组</h1><p>Hystrix 使用命令分组将一起的命令进行管理，比如报告、警报、仪表盘或组 &#x2F; 库。默认情况下，Hystrix 使用 HystrixCommandGroupKey来定义命令线程池，除非单独定义线程池。</p><p>HystrixCommandGroupKey是一个接口，可以作为枚举或者普通类实现。其实它有一个辅助工厂类，示例如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;Command Group: Hello World&quot;</span>)<br></code></pre></td></tr></table></figure><p>HystrixCommandGroupKey源码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HystrixCommandGroupKey</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixKey</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Factory</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> InternMap&lt;String, HystrixCommandGroupKey.Factory.HystrixCommandGroupDefault&gt; intern = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternMap</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueConstructor</span>&lt;String, HystrixCommandGroupKey.Factory.HystrixCommandGroupDefault&gt;() &#123;<br>            <span class="hljs-keyword">public</span> HystrixCommandGroupKey.Factory.HystrixCommandGroupDefault <span class="hljs-title function_">create</span><span class="hljs-params">(String key)</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HystrixCommandGroupKey</span>.Factory.HystrixCommandGroupDefault(key);<br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-title function_">Factory</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HystrixCommandGroupKey <span class="hljs-title function_">asKey</span><span class="hljs-params">(String name)</span> &#123;<br>            <span class="hljs-keyword">return</span> (HystrixCommandGroupKey)intern.interned(name);<br>        &#125;<br><br>        <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getGroupCount</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> intern.size();<br>        &#125;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HystrixCommandGroupDefault</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixKeyDefault</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HystrixCommandGroupKey</span> &#123;<br>            <span class="hljs-keyword">public</span> <span class="hljs-title function_">HystrixCommandGroupDefault</span><span class="hljs-params">(String name)</span> &#123;<br>                <span class="hljs-built_in">super</span>(name);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="命令线程池"><a href="#命令线程池" class="headerlink" title="命令线程池"></a>命令线程池</h1><p> 线程池主要体现是用于监测、指标发布、缓存和其他此类用途的 HystrixThreadPool。 一个 HystrixCommand 与一个单独注入到它的 HystrixThreadPoolKey 所检索到的 HystrixThreadPool 相关联， 或者默认为使用 HystrixCommandGroupKey 的创建一个 。</p><p>如果要显示定义名称的话，可以通过 HystrixCommand或者 HystrixObservableCommand的构造函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">HystrixHelloWorldCommand</span><span class="hljs-params">(String name)</span> &#123;<br>       <span class="hljs-built_in">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;Command Group: Hello World&quot;</span>))<br>               .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="hljs-string">&quot;Command Name: Hello World&quot;</span>))<br>               .andThreadPoolKey(HystrixThreadPoolKey.Factory.asKey(<span class="hljs-string">&quot;Command ThreadPool: Hello World&quot;</span>)));<br>       <span class="hljs-built_in">this</span>.name = name;<br>   &#125;<br></code></pre></td></tr></table></figure><p>HystrixThreadPoolKey 是一个接口，可以作为枚举或者普通类实现。其实它有一个辅助工厂类，示例如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">HystrixThreadPoolKey.Factory.asKey(<span class="hljs-string">&quot;Command ThreadPool: Hello World&quot;</span>)<br></code></pre></td></tr></table></figure><p>HystrixThreadPoolKey源码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HystrixThreadPoolKey</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixKey</span> &#123;<br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Factory</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-title function_">Factory</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> InternMap&lt;String, HystrixThreadPoolKey&gt; intern<br>                = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternMap</span>&lt;String, HystrixThreadPoolKey&gt;(<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternMap</span>.ValueConstructor&lt;String, HystrixThreadPoolKey&gt;() &#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> HystrixThreadPoolKey <span class="hljs-title function_">create</span><span class="hljs-params">(String key)</span> &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HystrixThreadPoolKeyDefault</span>(key);<br>                    &#125;<br>                &#125;);<br>     <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HystrixThreadPoolKey <span class="hljs-title function_">asKey</span><span class="hljs-params">(String name)</span> &#123;<br>           <span class="hljs-keyword">return</span> intern.interned(name);<br>        &#125;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HystrixThreadPoolKeyDefault</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixKeyDefault</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HystrixThreadPoolKey</span> &#123;<br>            <span class="hljs-keyword">public</span> <span class="hljs-title function_">HystrixThreadPoolKeyDefault</span><span class="hljs-params">(String name)</span> &#123;<br>                <span class="hljs-built_in">super</span>(name);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getThreadPoolCount</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> intern.size();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>可能使用 HystrixThreadPoolKey 而不仅仅是不同的 HystrixCommandGroupKey 的原因是多个命令可能属于相同的所有权或逻辑功能的 “组”，但是某些命令可能需要彼此隔离。</p><p> 简单示例如下:</p><ul><li>访问视频元数据的两个命令</li><li>两个命令拥有同一个组名称 “VideoMetadata”</li><li>命令 A 与资源 #1 互斥</li><li>命令 B 与资源 #2 互斥</li></ul><p>如果命令 A 的线程池潜在并且饱和，它就不应该阻止命令 B 访问资源，因为他们互相命中不同的后端资源。因此，我们在逻辑上希望这些命令组合在一起，但希望它们以不同的方式隔离，并使用 <code>HystrixThreadPoolKey</code> 来给它们每个线程池提供一个不同的线程池。</p><h1 id="请求缓存"><a href="#请求缓存" class="headerlink" title="请求缓存"></a>请求缓存</h1><p><a href="https://github.com/Netflix/Hystrix/blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandUsingRequestCache.java">查看源代码</a></p><p>您可以通过在or对象上实现getCacheKey()方法来启用请求缓存，如下所示：HystrixCommand、HystrixObservableCommand</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommandUsingRequestCache</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixCommand</span>&lt;Boolean&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> value;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">CommandUsingRequestCache</span><span class="hljs-params">(<span class="hljs-type">int</span> value)</span> &#123;<br>        <span class="hljs-built_in">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;ExampleGroup&quot;</span>));<br>        <span class="hljs-built_in">this</span>.value = value;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Boolean <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">return</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span>= <span class="hljs-number">0</span> || value % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">getCacheKey</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> String.valueOf(value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>由于这取决于请求上下文，我们必须初始化HystrixRequestContext</p><p>在一个简单的单元测试中，您可以这样做：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testWithoutCacheHits</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">HystrixRequestContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> HystrixRequestContext.initializeContext();<br>        <span class="hljs-keyword">try</span> &#123;<br>            assertTrue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandUsingRequestCache</span>(<span class="hljs-number">2</span>).execute());<br>            assertFalse(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandUsingRequestCache</span>(<span class="hljs-number">1</span>).execute());<br>            assertTrue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandUsingRequestCache</span>(<span class="hljs-number">0</span>).execute());<br>            assertTrue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandUsingRequestCache</span>(<span class="hljs-number">58672</span>).execute());<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            context.shutdown();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>ServletFilter通常，此上下文将通过包装用户请求或其他一些生命周期挂钩来初始化和关闭。</p><p>以下示例显示了命令如何在请求上下文中从缓存中检索其值（以及如何查询对象以了解其值是否来自缓存）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testWithCacheHits</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">HystrixRequestContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> HystrixRequestContext.initializeContext();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">CommandUsingRequestCache</span> <span class="hljs-variable">command2a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandUsingRequestCache</span>(<span class="hljs-number">2</span>);<br>            <span class="hljs-type">CommandUsingRequestCache</span> <span class="hljs-variable">command2b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandUsingRequestCache</span>(<span class="hljs-number">2</span>);<br><br>            assertTrue(command2a.execute());<br>            <span class="hljs-comment">// this is the first time we&#x27;ve executed this command with</span><br>            <span class="hljs-comment">// the value of &quot;2&quot; so it should not be from cache</span><br>            assertFalse(command2a.isResponseFromCache());<br><br>            assertTrue(command2b.execute());<br>            <span class="hljs-comment">// this is the second time we&#x27;ve executed this command with</span><br>            <span class="hljs-comment">// the same value so it should return from cache</span><br>            assertTrue(command2b.isResponseFromCache());<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            context.shutdown();<br>        &#125;<br><br>        <span class="hljs-comment">// start a new request context</span><br>        context = HystrixRequestContext.initializeContext();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">CommandUsingRequestCache</span> <span class="hljs-variable">command3b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandUsingRequestCache</span>(<span class="hljs-number">2</span>);<br>            assertTrue(command3b.execute());<br>            <span class="hljs-comment">// this is a new request context so this </span><br>            <span class="hljs-comment">// should not come from cache</span><br>            assertFalse(command3b.isResponseFromCache());<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            context.shutdown();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><h1 id="请求折叠"><a href="#请求折叠" class="headerlink" title="请求折叠"></a>请求折叠</h1><p><a href="https://github.com/Netflix/Hystrix/blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandCollapserGetValueForKey.java">查看源代码</a></p><p>请求折叠允许将多个请求批处理到单个HystrixCommand实例执行中。</p><p>折叠器可以使用批次大小和自批次创建以来经过的时间作为执行批次的触发器。</p><p>Hystrix 支持 2 种请求折叠样式：请求范围和全局范围。这是在折叠器构造时配置的，默认为请求范围。</p><p>一个请求范围的折叠器收集一个批次 per HystrixRequestContext，而一个全局范围的折叠器跨多个HystrixRequestContexts 收集一个批次。因此，如果您的下游依赖项无法HystrixRequestContext在单个命令调用中处理多个 s，则请求范围的折叠是正确的选择。</p><p>HystrixRequestContext在 Netflix，我们专门使用请求范围的折叠器，因为所有当前系统都是建立在每个命令中使用一个单一的假设之上的。由于批处理仅针对每个请求，因此当命令与同一请求中的不同参数并行发生时，折叠是有效的。</p><p>以下是如何实现请求范围的简单示例HystrixCollapser：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommandCollapserGetValueForKey</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixCollapser</span>&lt;List&lt;String&gt;, String, Integer&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer key;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CommandCollapserGetValueForKey</span><span class="hljs-params">(Integer key)</span> &#123;<br>        <span class="hljs-built_in">this</span>.key = key;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getRequestArgument</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> key;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> HystrixCommand&lt;List&lt;String&gt;&gt; <span class="hljs-title function_">createCommand</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Collection&lt;CollapsedRequest&lt;String, Integer&gt;&gt; requests)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BatchCommand</span>(requests);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mapResponseToRequests</span><span class="hljs-params">(List&lt;String&gt; batchResponse, Collection&lt;CollapsedRequest&lt;String, Integer&gt;&gt; requests)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (CollapsedRequest&lt;String, Integer&gt; request : requests) &#123;<br>            request.setResponse(batchResponse.get(count++));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchCommand</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixCommand</span>&lt;List&lt;String&gt;&gt; &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Collection&lt;CollapsedRequest&lt;String, Integer&gt;&gt; requests;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-title function_">BatchCommand</span><span class="hljs-params">(Collection&lt;CollapsedRequest&lt;String, Integer&gt;&gt; requests)</span> &#123;<br>                <span class="hljs-built_in">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;ExampleGroup&quot;</span>))<br>                    .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="hljs-string">&quot;GetValueForKey&quot;</span>)));<br>            <span class="hljs-built_in">this</span>.requests = requests;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> List&lt;String&gt; <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            ArrayList&lt;String&gt; response = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>            <span class="hljs-keyword">for</span> (CollapsedRequest&lt;String, Integer&gt; request : requests) &#123;<br>                <span class="hljs-comment">// artificial response for each argument received in the batch</span><br>                response.add(<span class="hljs-string">&quot;ValueForKey: &quot;</span> + request.getArgument());<br>            &#125;<br>            <span class="hljs-keyword">return</span> response;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>以下单元测试展示了如何使用折叠器将四个执行自动批处理CommandCollapserGetValueForKey为单个HystrixCommand执行：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCollapser</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">HystrixRequestContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> HystrixRequestContext.initializeContext();<br>    <span class="hljs-keyword">try</span> &#123;<br>        Future&lt;String&gt; f1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandCollapserGetValueForKey</span>(<span class="hljs-number">1</span>).queue();<br>        Future&lt;String&gt; f2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandCollapserGetValueForKey</span>(<span class="hljs-number">2</span>).queue();<br>        Future&lt;String&gt; f3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandCollapserGetValueForKey</span>(<span class="hljs-number">3</span>).queue();<br>        Future&lt;String&gt; f4 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandCollapserGetValueForKey</span>(<span class="hljs-number">4</span>).queue();<br><br>        assertEquals(<span class="hljs-string">&quot;ValueForKey: 1&quot;</span>, f1.get());<br>        assertEquals(<span class="hljs-string">&quot;ValueForKey: 2&quot;</span>, f2.get());<br>        assertEquals(<span class="hljs-string">&quot;ValueForKey: 3&quot;</span>, f3.get());<br>        assertEquals(<span class="hljs-string">&quot;ValueForKey: 4&quot;</span>, f4.get());<br><br>        <span class="hljs-comment">// assert that the batch command &#x27;GetValueForKey&#x27; was in fact</span><br>        <span class="hljs-comment">// executed and that it executed only once</span><br>        assertEquals(<span class="hljs-number">1</span>, HystrixRequestLog.getCurrentRequest().getExecutedCommands().size());<br>        HystrixCommand&lt;?&gt; command = HystrixRequestLog.getCurrentRequest().getExecutedCommands().toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HystrixCommand</span>&lt;?&gt;[<span class="hljs-number">1</span>])[<span class="hljs-number">0</span>];<br>        <span class="hljs-comment">// assert the command is the one we&#x27;re expecting</span><br>        assertEquals(<span class="hljs-string">&quot;GetValueForKey&quot;</span>, command.getCommandKey().name());<br>        <span class="hljs-comment">// confirm that it was a COLLAPSED command execution</span><br>        assertTrue(command.getExecutionEvents().contains(HystrixEventType.COLLAPSED));<br>        <span class="hljs-comment">// and that it was successful</span><br>        assertTrue(command.getExecutionEvents().contains(HystrixEventType.SUCCESS));<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        context.shutdown();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="请求上下文设置"><a href="#请求上下文设置" class="headerlink" title="请求上下文设置"></a>请求上下文设置</h1><p>要使用请求范围的功能（请求缓存、请求折叠、请求日志），您必须管理HystrixRequestContext生命周期（或实施替代方案HystrixConcurrencyStrategy）。</p><p>这意味着您必须在请求之前执行以下操作：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">HystrixRequestContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> HystrixRequestContext.initializeContext();<br></code></pre></td></tr></table></figure><p>然后在请求结束时：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jav">context.shutdown();<br></code></pre></td></tr></table></figure><p>在标准的 Java Web 应用程序中，您可以使用 Servlet 过滤器通过实现类似于以下的过滤器来初始化此生命周期：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HystrixRequestContextServletFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <br>     <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-type">HystrixRequestContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> HystrixRequestContext.initializeContext();<br>        <span class="hljs-keyword">try</span> &#123;<br>            chain.doFilter(request, response);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            context.shutdown();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>您可以通过向以下内容添加一个部分来为所有传入流量启用过滤器web.xml：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"> <span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">display-name</span>&gt;</span>HystrixRequestContextServletFilter<span class="hljs-tag">&lt;/<span class="hljs-name">display-name</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>HystrixRequestContextServletFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>com.netflix.hystrix.contrib.requestservlet.HystrixRequestContextServletFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>HystrixRequestContextServletFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="常见模式"><a href="#常见模式" class="headerlink" title="常见模式"></a>常见模式</h1><p>以下部分是 和 的常见用途和使用<code>HystrixCommand</code>模式<code>HystrixObservableCommand</code>。</p><h2 id="快速失败"><a href="#快速失败" class="headerlink" title="快速失败"></a>快速失败</h2><p><a href="https://github.com/Netflix/Hystrix/blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandThatFailsFast.java">查看源代码</a></p><p>最基本的执行是只做一件事情并且没有回退行为。如果发生任何类型的故障，它将抛出异常。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommandThatFailsFast</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixCommand</span>&lt;String&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> throwException;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CommandThatFailsFast</span><span class="hljs-params">(<span class="hljs-type">boolean</span> throwException)</span> &#123;<br>        <span class="hljs-built_in">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;ExampleGroup&quot;</span>));<br>        <span class="hljs-built_in">this</span>.throwException = throwException;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (throwException) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;failure from CommandThatFailsFast&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>        &#125;<br>    &#125;<br> &#125;<br></code></pre></td></tr></table></figure><p>这些单元测试显示了它的行为方式：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSuccess</span><span class="hljs-params">()</span> &#123;<br>    assertEquals(<span class="hljs-string">&quot;success&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandThatFailsFast</span>(<span class="hljs-literal">false</span>).execute());<br>&#125;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFailure</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandThatFailsFast</span>(<span class="hljs-literal">true</span>).execute();<br>        fail(<span class="hljs-string">&quot;we should have thrown an exception&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (HystrixRuntimeException e) &#123;<br>        assertEquals(<span class="hljs-string">&quot;failure from CommandThatFailsFast&quot;</span>, e.getCause().getMessage());<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>HystrixObservableCommand相等的</p><p>a 的等效 Fail-Fast 解决方案HystrixObservableCommand将涉及覆盖该resumeWithFallback方法，如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> Observable&lt;String&gt; <span class="hljs-title function_">resumeWithFallback</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (throwException) &#123;<br>        <span class="hljs-keyword">return</span> Observable.error(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Throwable</span>(<span class="hljs-string">&quot;failure from CommandThatFailsFast&quot;</span>));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> Observable.just(<span class="hljs-string">&quot;success&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="静默失败"><a href="#静默失败" class="headerlink" title="静默失败"></a>静默失败</h2><p><a href="https://github.com/Netflix/Hystrix/blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandThatFailsSilently.java">查看源代码</a></p><p>静默失败相当于返回空响应或删除功能。可以通过返回null、空 Map、空 List 或其他此类响应来完成。</p><p>您可以通过在实例上实现一个getFallback()方法来做到这一点：HystrixCommand</p><p><img src="/.com//hystrix05.png" alt="hystrix05"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommandThatFailsSilently</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixCommand</span>&lt;String&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> throwException;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CommandThatFailsSilently</span><span class="hljs-params">(<span class="hljs-type">boolean</span> throwException)</span> &#123;<br>        <span class="hljs-built_in">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;ExampleGroup&quot;</span>));<br>        <span class="hljs-built_in">this</span>.throwException = throwException;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (throwException) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;failure from CommandThatFailsFast&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">getFallback</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSuccess</span><span class="hljs-params">()</span> &#123;<br>    assertEquals(<span class="hljs-string">&quot;success&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandThatFailsSilently</span>(<span class="hljs-literal">false</span>).execute());<br>&#125;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFailure</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        assertEquals(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandThatFailsSilently</span>(<span class="hljs-literal">true</span>).execute());<br>    &#125; <span class="hljs-keyword">catch</span> (HystrixRuntimeException e) &#123;<br>        fail(<span class="hljs-string">&quot;we should not get an exception as we fail silently with a fallback&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>另一个返回空列表的实现如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> List&lt;String&gt; <span class="hljs-title function_">getFallback</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> Collections.emptyList();<br>&#125;<br></code></pre></td></tr></table></figure><p>HystrixObservableCommand相等的</p><p>a 的等效 Fail-Silently 解决方案HystrixObservableCommand将涉及覆盖该resumeWithFallback()方法，如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> Observable&lt;String&gt; <span class="hljs-title function_">resumeWithFallback</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> Observable.empty();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="后备：静态"><a href="#后备：静态" class="headerlink" title="后备：静态"></a>后备：静态</h2><p>回退可以返回静态嵌入在代码中的默认值。这不会像“失败静默”通常那样导致功能或服务被删除，而是会导致默认行为发生。</p><p>例如，如果命令根据用户凭据返回真&#x2F;假，但命令执行失败，它可以默认为真：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> Boolean <span class="hljs-title function_">getFallback</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="后备：存根"><a href="#后备：存根" class="headerlink" title="后备：存根"></a>后备：存根</h2><p><a href="https://github.com/Netflix/Hystrix/blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandWithStubbedFallback.java">查看源代码</a></p><p>当您的命令返回包含多个字段的复合对象时，您通常使用存根回退，其中一些字段可以从其他请求状态确定，而其他字段设置为默认值。</p><p>您可能会发现适合在这些存根值中使用的状态的示例如下：</p><ul><li>饼干</li><li>请求参数和标头</li><li>在当前服务请求失败之前对先前服务请求的响应</li></ul><p>您的后备可以从请求范围内静态检索存根值，但通常建议在命令实例化时注入它们以供需要时使用，例如以下示例以处理countryCodeFromGeoLookup字段的方式演示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommandWithStubbedFallback</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixCommand</span>&lt;UserAccount&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> customerId;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String countryCodeFromGeoLookup;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> customerId</span><br><span class="hljs-comment">     *            The customerID to retrieve UserAccount for</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> countryCodeFromGeoLookup</span><br><span class="hljs-comment">     *            The default country code from the HTTP request geo code lookup used for fallback.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">CommandWithStubbedFallback</span><span class="hljs-params">(<span class="hljs-type">int</span> customerId, String countryCodeFromGeoLookup)</span> &#123;<br>        <span class="hljs-built_in">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;ExampleGroup&quot;</span>));<br>        <span class="hljs-built_in">this</span>.customerId = customerId;<br>        <span class="hljs-built_in">this</span>.countryCodeFromGeoLookup = countryCodeFromGeoLookup;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> UserAccount <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// fetch UserAccount from remote service</span><br>        <span class="hljs-comment">//        return UserAccountClient.getAccount(customerId);</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;forcing failure for example&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> UserAccount <span class="hljs-title function_">getFallback</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Return stubbed fallback with some static defaults, placeholders,</span><br><span class="hljs-comment">         * and an injected value &#x27;countryCodeFromGeoLookup&#x27; that we&#x27;ll use</span><br><span class="hljs-comment">         * instead of what we would have retrieved from the remote service.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserAccount</span>(customerId, <span class="hljs-string">&quot;Unknown Name&quot;</span>,<br>                countryCodeFromGeoLookup, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserAccount</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> customerId;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String countryCode;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> isFeatureXPermitted;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> isFeatureYPermitted;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> isFeatureZPermitted;<br><br>        UserAccount(<span class="hljs-type">int</span> customerId, String name, String countryCode,<br>                <span class="hljs-type">boolean</span> isFeatureXPermitted,<br>                <span class="hljs-type">boolean</span> isFeatureYPermitted,<br>                <span class="hljs-type">boolean</span> isFeatureZPermitted) &#123;<br>            <span class="hljs-built_in">this</span>.customerId = customerId;<br>            <span class="hljs-built_in">this</span>.name = name;<br>            <span class="hljs-built_in">this</span>.countryCode = countryCode;<br>            <span class="hljs-built_in">this</span>.isFeatureXPermitted = isFeatureXPermitted;<br>            <span class="hljs-built_in">this</span>.isFeatureYPermitted = isFeatureYPermitted;<br>            <span class="hljs-built_in">this</span>.isFeatureZPermitted = isFeatureZPermitted;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>以下单元测试演示了它的行为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-type">CommandWithStubbedFallback</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandWithStubbedFallback</span>(<span class="hljs-number">1234</span>, <span class="hljs-string">&quot;ca&quot;</span>);<br>      <span class="hljs-type">UserAccount</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> command.execute();<br>      assertTrue(command.isFailedExecution());<br>      assertTrue(command.isResponseFromFallback());<br>      assertEquals(<span class="hljs-number">1234</span>, account.customerId);<br>      assertEquals(<span class="hljs-string">&quot;ca&quot;</span>, account.countryCode);<br>      assertEquals(<span class="hljs-literal">true</span>, account.isFeatureXPermitted);<br>      assertEquals(<span class="hljs-literal">true</span>, account.isFeatureYPermitted);<br>      assertEquals(<span class="hljs-literal">false</span>, account.isFeatureZPermitted);<br>  &#125;<br></code></pre></td></tr></table></figure><p>HystrixObservableCommand相等的</p><p>a 的等效 Stubbed 解决方案HystrixObservableCommand将涉及重写resumeWithFallback方法以返回Observable发出存根响应的 an。与上一个示例等效的版本如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> Observable&lt;Boolean&gt; <span class="hljs-title function_">resumeWithFallback</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> Observable.just( <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserAccount</span>(customerId, <span class="hljs-string">&quot;Unknown Name&quot;</span>,<br>                                            countryCodeFromGeoLookup, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>) );<br>&#125;<br></code></pre></td></tr></table></figure><p>但是，如果您期望从您Observable的Observable. 这是一个简单的例子来展示你如何完成这个 - 它跟踪从 main 发出的最后一个 item，Observable以便 fallback 知道从哪里拾取以继续序列：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> Observable&lt;Integer&gt; <span class="hljs-title function_">construct</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> Observable.just(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)<br>            .concatWith(Observable.&lt;Integer&gt; error(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;forced error&quot;</span>)))<br>            .doOnNext(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Action1</span>&lt;Integer&gt;() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">call</span><span class="hljs-params">(Integer t1)</span> &#123;<br>                    lastSeen = t1;<br>                &#125;<br>                <br>            &#125;)<br>            .subscribeOn(Schedulers.computation());<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> Observable&lt;Integer&gt; <span class="hljs-title function_">resumeWithFallback</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (lastSeen &lt; <span class="hljs-number">4</span>) &#123;<br>        <span class="hljs-keyword">return</span> Observable.range(lastSeen + <span class="hljs-number">1</span>, <span class="hljs-number">4</span> - lastSeen);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> Observable.empty();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="回退：通过网络缓存"><a href="#回退：通过网络缓存" class="headerlink" title="回退：通过网络缓存"></a>回退：通过网络缓存</h2><p><a href="https://github.com/Netflix/Hystrix/blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandWithFallbackViaNetwork.java">查看源代码</a></p><p>有时，如果后端服务失败，可以从缓存服务（如 memcached）中检索过时的数据版本。</p><p>由于回退将通过网络，这是另一个可能的故障点，因此它也需要用HystrixCommand  or包裹HystrixObservableCommand。</p><p><img src="/.com//hystrix06.png" alt="hystrix06"></p><p>在单独的线程池上执行回退命令很重要，否则如果主命令成为潜在命令并填充线程池，如果两个命令共享同一个池，这将阻止回退运行。</p><p>以下代码显示了如何在其方法中CommandWithFallbackViaNetwork执行。FallbackViaNetwork  getFallback()</p><p>请注意，如果回退失败，它<em>还有</em>一个回退，它执行“失败静默”的返回方法null。</p><p>要将命令配置为在与从 派生FallbackViaNetwork的默认线程池不同的线程池上运行，它会注入到构造函数中。RemoteServiceX   HystrixCommandGroupKey HystrixThreadPoolKey.Factory.asKey(“RemoteServiceXFallback”)</p><p>这意味着CommandWithFallbackViaNetwork将在名为的线程池上运行，并将在名为RemoteServiceX的FallbackViaNetwork线程池上运行RemoteServiceXFallback。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommandWithFallbackViaNetwork</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixCommand</span>&lt;String&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> id;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">CommandWithFallbackViaNetwork</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>        <span class="hljs-built_in">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;RemoteServiceX&quot;</span>))<br>                .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="hljs-string">&quot;GetValueCommand&quot;</span>)));<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//        RemoteServiceXClient.getValue(id);</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;force failure for example&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">getFallback</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FallbackViaNetwork</span>(id).execute();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FallbackViaNetwork</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixCommand</span>&lt;String&gt; &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> id;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">FallbackViaNetwork</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>            <span class="hljs-built_in">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;RemoteServiceX&quot;</span>))<br>                    .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="hljs-string">&quot;GetValueFallbackCommand&quot;</span>))<br>                    <span class="hljs-comment">// use a different threadpool for the fallback command</span><br>                    <span class="hljs-comment">// so saturating the RemoteServiceX pool won&#x27;t prevent</span><br>                    <span class="hljs-comment">// fallbacks from executing</span><br>                    .andThreadPoolKey(HystrixThreadPoolKey.Factory.asKey(<span class="hljs-string">&quot;RemoteServiceXFallback&quot;</span>)));<br>            <span class="hljs-built_in">this</span>.id = id;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            MemCacheClient.getValue(id);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">getFallback</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-comment">// the fallback also failed</span><br>            <span class="hljs-comment">// so this fallback-of-a-fallback will </span><br>            <span class="hljs-comment">// fail silently and return null</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="主要-次要与后备"><a href="#主要-次要与后备" class="headerlink" title="主要 + 次要与后备"></a>主要 + 次要与后备</h2><p><a href="https://github.com/Netflix/Hystrix/blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandFacadeWithPrimarySecondary.java">查看源代码</a></p><p>一些系统具有双模式行为——主要和次要，或主要和故障转移。</p><p>有时，辅助或故障转移被视为故障状态，仅用于回退；在这些场景中，它与上述“通过网络缓存”的模式相同。</p><p>但是，如果切换到辅助系统很常见，例如推出新代码的正常部分（有时这是有状态系统处理代码推送的一部分），那么每次使用辅助系统时，主系统都会处于故障状态，跳闸断路器和触发警报。</p><p>这不是期望的行为，如果没有其他原因，只是为了避免“狼来了”的疲劳，当真正的问题发生时，会导致警报被忽略。</p><p>因此，在这种情况下，策略是将主要和次要之间的切换视为正常、健康的模式，并在它们面前放置一个外观。</p><p><img src="/.com//hystrix07.png" alt="hystrix07"></p><p>主要和次要HystrixCommand实现是线程隔离的，因为它们正在处理网络流量和业务逻辑。它们可能每个都具有非常不同的性能特征（通常辅助系统是静态缓存），因此每个单独命令的另一个好处是它们可以单独调整。</p><p>您不会公开这两个命令，而是将它们隐藏在另一个HystrixCommand信号量隔离的命令后面，该命令实现了关于是调用主要命令还是次要命令的条件逻辑。如果主要和次要都失败，则控制切换到外观命令本身的后备。</p><p>外观HystrixCommand可以使用信号量隔离，因为它所做的所有工作都经过另外两个HystrixCommand已经线程隔离的 s。只要run()外观的方法不执行任何其他网络调用、重试逻辑或其他“容易出错”的事情，就没有必要再有另一层线程。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommandFacadeWithPrimarySecondary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixCommand</span>&lt;String&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">DynamicBooleanProperty</span> <span class="hljs-variable">usePrimary</span> <span class="hljs-operator">=</span> DynamicPropertyFactory.getInstance().getBooleanProperty(<span class="hljs-string">&quot;primarySecondary.usePrimary&quot;</span>, <span class="hljs-literal">true</span>);<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> id;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CommandFacadeWithPrimarySecondary</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>        <span class="hljs-built_in">super</span>(Setter<br>                .withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;SystemX&quot;</span>))<br>                .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="hljs-string">&quot;PrimarySecondaryCommand&quot;</span>))<br>                .andCommandPropertiesDefaults(<br>                        <span class="hljs-comment">// we want to default to semaphore-isolation since this wraps</span><br>                        <span class="hljs-comment">// 2 others commands that are already thread isolated</span><br>                        HystrixCommandProperties.Setter()<br>                                .withExecutionIsolationStrategy(ExecutionIsolationStrategy.SEMAPHORE)));<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (usePrimary.get()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrimaryCommand</span>(id).execute();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecondaryCommand</span>(id).execute();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">getFallback</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;static-fallback-&quot;</span> + id;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">getCacheKey</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> String.valueOf(id);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrimaryCommand</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixCommand</span>&lt;String&gt; &#123;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> id;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-title function_">PrimaryCommand</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>            <span class="hljs-built_in">super</span>(Setter<br>                    .withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;SystemX&quot;</span>))<br>                    .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="hljs-string">&quot;PrimaryCommand&quot;</span>))<br>                    .andThreadPoolKey(HystrixThreadPoolKey.Factory.asKey(<span class="hljs-string">&quot;PrimaryCommand&quot;</span>))<br>                    .andCommandPropertiesDefaults(<br>                            <span class="hljs-comment">// we default to a 600ms timeout for primary</span><br>                            HystrixCommandProperties.Setter().withExecutionTimeoutInMilliseconds(<span class="hljs-number">600</span>)));<br>            <span class="hljs-built_in">this</span>.id = id;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-comment">// perform expensive &#x27;primary&#x27; service call</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;responseFromPrimary-&quot;</span> + id;<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecondaryCommand</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixCommand</span>&lt;String&gt; &#123;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> id;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-title function_">SecondaryCommand</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>            <span class="hljs-built_in">super</span>(Setter<br>                    .withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;SystemX&quot;</span>))<br>                    .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="hljs-string">&quot;SecondaryCommand&quot;</span>))<br>                    .andThreadPoolKey(HystrixThreadPoolKey.Factory.asKey(<span class="hljs-string">&quot;SecondaryCommand&quot;</span>))<br>                    .andCommandPropertiesDefaults(<br>                            <span class="hljs-comment">// we default to a 100ms timeout for secondary</span><br>                            HystrixCommandProperties.Setter().withExecutionTimeoutInMilliseconds(<span class="hljs-number">100</span>)));<br>            <span class="hljs-built_in">this</span>.id = id;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-comment">// perform fast &#x27;secondary&#x27; service call</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;responseFromSecondary-&quot;</span> + id;<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnitTest</span> &#123;<br><br>        <span class="hljs-meta">@Test</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPrimary</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">HystrixRequestContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> HystrixRequestContext.initializeContext();<br>            <span class="hljs-keyword">try</span> &#123;<br>                ConfigurationManager.getConfigInstance().setProperty(<span class="hljs-string">&quot;primarySecondary.usePrimary&quot;</span>, <span class="hljs-literal">true</span>);<br>                assertEquals(<span class="hljs-string">&quot;responseFromPrimary-20&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandFacadeWithPrimarySecondary</span>(<span class="hljs-number">20</span>).execute());<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                context.shutdown();<br>                ConfigurationManager.getConfigInstance().clear();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-meta">@Test</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSecondary</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">HystrixRequestContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> HystrixRequestContext.initializeContext();<br>            <span class="hljs-keyword">try</span> &#123;<br>                ConfigurationManager.getConfigInstance().setProperty(<span class="hljs-string">&quot;primarySecondary.usePrimary&quot;</span>, <span class="hljs-literal">false</span>);<br>                assertEquals(<span class="hljs-string">&quot;responseFromSecondary-20&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandFacadeWithPrimarySecondary</span>(<span class="hljs-number">20</span>).execute());<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                context.shutdown();<br>                ConfigurationManager.getConfigInstance().clear();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="客户端不执行网络访问"><a href="#客户端不执行网络访问" class="headerlink" title="客户端不执行网络访问"></a>客户端不执行网络访问</h2><p><a href="https://github.com/Netflix/Hystrix/blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandUsingSemaphoreIsolation.java">查看源代码</a></p><p>当你包装不执行网络访问的行为时，但延迟是一个问题或线程开销是不可接受的，你可以将executionIsolationStrategy属性设置为，Hystrix 将使用信号量隔离。ExecutionIsolationStrategy.SEMAPHORE</p><p>下面展示了如何通过代码将此属性设置为命令的默认值（您也可以在运行时通过动态属性覆盖它）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommandUsingSemaphoreIsolation</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixCommand</span>&lt;String&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> id;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CommandUsingSemaphoreIsolation</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>        <span class="hljs-built_in">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;ExampleGroup&quot;</span>))<br>                <span class="hljs-comment">// since we&#x27;re doing an in-memory cache lookup we choose SEMAPHORE isolation</span><br>                .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()<br>                        .withExecutionIsolationStrategy(ExecutionIsolationStrategy.SEMAPHORE)));<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// a real implementation would retrieve data from in memory data structure</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ValueFromHashMap_&quot;</span> + id;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Get-Set-Get-与请求缓存失效"><a href="#Get-Set-Get-与请求缓存失效" class="headerlink" title="Get-Set-Get 与请求缓存失效"></a>Get-Set-Get 与请求缓存失效</h2><p><a href="https://github.com/Netflix/Hystrix/blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandUsingRequestCacheInvalidation.java">查看源代码</a></p><p>如果您正在实现 Get-Set-Get 用例，其中 Get 接收到需要请求缓存的足够流量，但有时 Set 发生在另一个应该使同一请求中的缓存无效的命令上，您可以通过调用HystrixRequestCache.clear().</p><p>这是一个示例实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommandUsingRequestCacheInvalidation</span> &#123;<br><br>    <span class="hljs-comment">/* represents a remote data store */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">String</span> <span class="hljs-variable">prefixStoredOnRemoteDataStore</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ValueBeforeSet_&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GetterCommand</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixCommand</span>&lt;String&gt; &#123;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">HystrixCommandKey</span> <span class="hljs-variable">GETTER_KEY</span> <span class="hljs-operator">=</span> HystrixCommandKey.Factory.asKey(<span class="hljs-string">&quot;GetterCommand&quot;</span>);<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> id;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">GetterCommand</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>            <span class="hljs-built_in">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;GetSetGet&quot;</span>))<br>                    .andCommandKey(GETTER_KEY));<br>            <span class="hljs-built_in">this</span>.id = id;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> prefixStoredOnRemoteDataStore + id;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">getCacheKey</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> String.valueOf(id);<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Allow the cache to be flushed for this object.</span><br><span class="hljs-comment">         * </span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">         *            argument that would normally be passed to the command</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">flushCache</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>            HystrixRequestCache.getInstance(GETTER_KEY,<br>                    HystrixConcurrencyStrategyDefault.getInstance()).clear(String.valueOf(id));<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SetterCommand</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HystrixCommand</span>&lt;Void&gt; &#123;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> id;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String prefix;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">SetterCommand</span><span class="hljs-params">(<span class="hljs-type">int</span> id, String prefix)</span> &#123;<br>            <span class="hljs-built_in">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="hljs-string">&quot;GetSetGet&quot;</span>));<br>            <span class="hljs-built_in">this</span>.id = id;<br>            <span class="hljs-built_in">this</span>.prefix = prefix;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> Void <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-comment">// persist the value against the datastore</span><br>            prefixStoredOnRemoteDataStore = prefix;<br>            <span class="hljs-comment">// flush the cache</span><br>            GetterCommand.flushCache(id);<br>            <span class="hljs-comment">// no return value</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>确认行为的单元测试是：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getGetSetGet</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">HystrixRequestContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> HystrixRequestContext.initializeContext();<br>        <span class="hljs-keyword">try</span> &#123;<br>            assertEquals(<span class="hljs-string">&quot;ValueBeforeSet_1&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">GetterCommand</span>(<span class="hljs-number">1</span>).execute());<br>            <span class="hljs-type">GetterCommand</span> <span class="hljs-variable">commandAgainstCache</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GetterCommand</span>(<span class="hljs-number">1</span>);<br>            assertEquals(<span class="hljs-string">&quot;ValueBeforeSet_1&quot;</span>, commandAgainstCache.execute());<br>            <span class="hljs-comment">// confirm it executed against cache the second time</span><br>            assertTrue(commandAgainstCache.isResponseFromCache());<br>            <span class="hljs-comment">// set the new value</span><br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SetterCommand</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;ValueAfterSet_&quot;</span>).execute();<br>            <span class="hljs-comment">// fetch it again</span><br>            <span class="hljs-type">GetterCommand</span> <span class="hljs-variable">commandAfterSet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GetterCommand</span>(<span class="hljs-number">1</span>);<br>            <span class="hljs-comment">// the getter should return with the new prefix, not the value from cache</span><br>            assertFalse(commandAfterSet.isResponseFromCache());<br>            assertEquals(<span class="hljs-string">&quot;ValueAfterSet_1&quot;</span>, commandAfterSet.execute());<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            context.shutdown();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="将库迁移到-Hystrix"><a href="#将库迁移到-Hystrix" class="headerlink" title="将库迁移到 Hystrix"></a>将库迁移到 Hystrix</h2><p>当您迁移现有客户端库以使用 Hystrix 时，您应该将每个“服务方法”替换为HystrixCommand.</p><p>然后，服务方法应该将调用转发到HystrixCommand并且其中没有任何额外的业务逻辑。</p><p>因此，在迁移之前，服务库可能如下所示：</p><p><img src="/.com//hystrix08.png" alt="hystrix08"></p><p>迁移后，库的用户将能够HystrixCommand通过委托给 s 的服务外观直接或间接访问HystrixCommands。</p><p><img src="/.com//hystrix09.png" alt="hystrix09"></p>]]></content>
    
    
    <categories>
      
      <category>hystrix</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hystrix</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring_cloud_feign_ribbon_hystrix源码分析</title>
    <link href="/2022/06/14/spring_cloud/spring_cloud_feign_ribbon_hystrix%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <url>/2022/06/14/spring_cloud/spring_cloud_feign_ribbon_hystrix%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h1><p><img src="/.com//openfeign%E6%B5%81%E7%A8%8B%E5%9B%BE.jpeg" alt="openfeign流程图"></p><h1 id="EnableFeignClients开启Feign功能"><a href="#EnableFeignClients开启Feign功能" class="headerlink" title="@EnableFeignClients开启Feign功能"></a>@EnableFeignClients开启Feign功能</h1><p>使用时都是在spring boot 启动类加上@EnableFeignClients注解。</p><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Import(FeignClientsRegistrar.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableFeignClients &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>注解上有FeignClientsRegistrar类</p><p>FeignClientsRegistrar实现了ImportBeanDefinitionRegistrar接口</p><p>spring 启动时会调用registerBeanDefinitions方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(AnnotationMetadata metadata,</span><br><span class="hljs-params">BeanDefinitionRegistry registry)</span> &#123;<br>   <span class="hljs-comment">//注册@EnableFeignClients上定义的defaultConfiguration默认配置类</span><br>registerDefaultConfiguration(metadata, registry);<br>   <span class="hljs-comment">//扫描所有的@FeignClient注解</span><br>registerFeignClients(metadata, registry);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="注册默认配置类"><a href="#注册默认配置类" class="headerlink" title="注册默认配置类"></a>注册默认配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java">#FeignClientsRegistrar<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerDefaultConfiguration</span><span class="hljs-params">(AnnotationMetadata metadata,</span><br><span class="hljs-params">BeanDefinitionRegistry registry)</span> &#123;<br>    <span class="hljs-comment">//获取@EnableFeignClients配置的信息</span><br>Map&lt;String, Object&gt; defaultAttrs = metadata<br>.getAnnotationAttributes(EnableFeignClients.class.getName(), <span class="hljs-literal">true</span>);<br>    <span class="hljs-comment">//判断是否配置了defaultConfiguration</span><br><span class="hljs-keyword">if</span> (defaultAttrs != <span class="hljs-literal">null</span> &amp;&amp; defaultAttrs.containsKey(<span class="hljs-string">&quot;defaultConfiguration&quot;</span>)) &#123;<br>String name;<br>        <span class="hljs-comment">//判断配置在defaultConfiguration是否为内部类，拼接对应的类名</span><br><span class="hljs-keyword">if</span> (metadata.hasEnclosingClass()) &#123;<br>name = <span class="hljs-string">&quot;default.&quot;</span> + metadata.getEnclosingClassName();<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>name = <span class="hljs-string">&quot;default.&quot;</span> + metadata.getClassName();<br>&#125;<br>        <span class="hljs-comment">//跟进去</span><br>registerClientConfiguration(registry, name,<br>defaultAttrs.get(<span class="hljs-string">&quot;defaultConfiguration&quot;</span>));<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">#FeignClientsRegistrar<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerClientConfiguration</span><span class="hljs-params">(BeanDefinitionRegistry registry, Object name,</span><br><span class="hljs-params">Object configuration)</span> &#123;<br><span class="hljs-type">BeanDefinitionBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> BeanDefinitionBuilder<br>.genericBeanDefinition(FeignClientSpecification.class);<br>builder.addConstructorArgValue(name);<br>builder.addConstructorArgValue(configuration);<br>    <span class="hljs-comment">//将@EnableFeignClients中的配置信息注册到容器中</span><br>registry.registerBeanDefinition(<br>name + <span class="hljs-string">&quot;.&quot;</span> + FeignClientSpecification.class.getSimpleName(),<br>builder.getBeanDefinition());<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="扫描-FeignClient注解"><a href="#扫描-FeignClient注解" class="headerlink" title="扫描@FeignClient注解"></a>扫描@FeignClient注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java">#FeignClientsRegistrar<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerFeignClients</span><span class="hljs-params">(AnnotationMetadata metadata,</span><br><span class="hljs-params">BeanDefinitionRegistry registry)</span> &#123;<br>    <span class="hljs-comment">//获取类路径扫描器</span><br><span class="hljs-type">ClassPathScanningCandidateComponentProvider</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> getScanner();<br>    <span class="hljs-comment">//设置资源加载器</span><br>scanner.setResourceLoader(<span class="hljs-built_in">this</span>.resourceLoader);<br>Set&lt;String&gt; basePackages;<br>    <span class="hljs-comment">//获取@EnableFeignClients的注解信息</span><br>Map&lt;String, Object&gt; attrs = metadata<br>.getAnnotationAttributes(EnableFeignClients.class.getName());<br>    <span class="hljs-comment">//创建@FeignClient类型的过滤器</span><br><span class="hljs-type">AnnotationTypeFilter</span> <span class="hljs-variable">annotationTypeFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeFilter</span>(<br>FeignClient.class);<br><span class="hljs-keyword">final</span> Class&lt;?&gt;[] clients = attrs == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span><br>: (Class&lt;?&gt;[]) attrs.get(<span class="hljs-string">&quot;clients&quot;</span>);<br><span class="hljs-keyword">if</span> (clients == <span class="hljs-literal">null</span> || clients.length == <span class="hljs-number">0</span>) &#123;<br>scanner.addIncludeFilter(annotationTypeFilter);<br>        <span class="hljs-comment">//获取包路径</span><br>basePackages = getBasePackages(metadata);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">for</span> (Class&lt;?&gt; clazz : clients) &#123;<br>candidateComponents.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotatedGenericBeanDefinition</span>(clazz));<br>&#125;<br>&#125;<br>    <span class="hljs-comment">//遍历包路径</span><br><span class="hljs-keyword">for</span> (String basePackage : basePackages) &#123;<br>        <span class="hljs-comment">//获取该包路径下带@FeignClient的BD信息</span><br>Set&lt;BeanDefinition&gt; candidateComponents = scanner<br>.findCandidateComponents(basePackage);<br><span class="hljs-keyword">for</span> (BeanDefinition candidateComponent : candidateComponents) &#123;<br><span class="hljs-keyword">if</span> (candidateComponent <span class="hljs-keyword">instanceof</span> AnnotatedBeanDefinition) &#123;<br><span class="hljs-type">AnnotatedBeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> (AnnotatedBeanDefinition) candidateComponent;<br><span class="hljs-type">AnnotationMetadata</span> <span class="hljs-variable">annotationMetadata</span> <span class="hljs-operator">=</span> beanDefinition.getMetadata();<br>Assert.isTrue(annotationMetadata.isInterface(),<br><span class="hljs-string">&quot;@FeignClient can only be specified on an interface&quot;</span>);<br>                <span class="hljs-comment">//获取@FeignClient的注解信息</span><br>Map&lt;String, Object&gt; attributes = annotationMetadata<br>.getAnnotationAttributes(<br>FeignClient.class.getCanonicalName());<br>                <span class="hljs-comment">//获取@FeignClient上配置的名称，优先级为contextId&gt;value&gt;name&gt;serviceId</span><br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> getClientName(attributes);<br>                <span class="hljs-comment">//注册@FeignClient的配置信息</span><br>registerClientConfiguration(registry, name,<br>attributes.get(<span class="hljs-string">&quot;configuration&quot;</span>));<br>                <span class="hljs-comment">//注册加了@FeignClient的类到容器中</span><br>registerFeignClient(registry, annotationMetadata, attributes);<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java">#FeignClientsRegistrar<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerFeignClient</span><span class="hljs-params">(BeanDefinitionRegistry registry,</span><br><span class="hljs-params">AnnotationMetadata annotationMetadata, Map&lt;String, Object&gt; attributes)</span> &#123;<br>    <span class="hljs-comment">//返回添加了@FeignClient注解的Class的全限定名，  包名.类名</span><br><span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> annotationMetadata.getClassName();<br>    <span class="hljs-comment">//FeignClientFactoryBean是一个FactoryBean，用它来创建具体的FeignClient</span><br><span class="hljs-type">BeanDefinitionBuilder</span> <span class="hljs-variable">definition</span> <span class="hljs-operator">=</span> BeanDefinitionBuilder<br>.genericBeanDefinition(FeignClientFactoryBean.class);<br>validate(attributes);<br>    <span class="hljs-comment">//向FeignClientFactoryBean添加@FeignClient中配置的一些注解信息</span><br>definition.addPropertyValue(<span class="hljs-string">&quot;url&quot;</span>, getUrl(attributes));<br>definition.addPropertyValue(<span class="hljs-string">&quot;path&quot;</span>, getPath(attributes));<br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> getName(attributes);<br>definition.addPropertyValue(<span class="hljs-string">&quot;name&quot;</span>, name);<br><span class="hljs-type">String</span> <span class="hljs-variable">contextId</span> <span class="hljs-operator">=</span> getContextId(attributes);<br>definition.addPropertyValue(<span class="hljs-string">&quot;contextId&quot;</span>, contextId);<br>definition.addPropertyValue(<span class="hljs-string">&quot;type&quot;</span>, className);<br>definition.addPropertyValue(<span class="hljs-string">&quot;decode404&quot;</span>, attributes.get(<span class="hljs-string">&quot;decode404&quot;</span>));<br>definition.addPropertyValue(<span class="hljs-string">&quot;fallback&quot;</span>, attributes.get(<span class="hljs-string">&quot;fallback&quot;</span>));<br>definition.addPropertyValue(<span class="hljs-string">&quot;fallbackFactory&quot;</span>, attributes.get(<span class="hljs-string">&quot;fallbackFactory&quot;</span>));<br>definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);<br><span class="hljs-type">String</span> <span class="hljs-variable">alias</span> <span class="hljs-operator">=</span> contextId + <span class="hljs-string">&quot;FeignClient&quot;</span>;<br><span class="hljs-type">AbstractBeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> definition.getBeanDefinition();<br><span class="hljs-type">boolean</span> <span class="hljs-variable">primary</span> <span class="hljs-operator">=</span> (Boolean) attributes.get(<span class="hljs-string">&quot;primary&quot;</span>);<br>beanDefinition.setPrimary(primary);<br><span class="hljs-type">String</span> <span class="hljs-variable">qualifier</span> <span class="hljs-operator">=</span> getQualifier(attributes);<br><span class="hljs-keyword">if</span> (StringUtils.hasText(qualifier)) &#123;<br>alias = qualifier;<br>&#125;<br><span class="hljs-type">BeanDefinitionHolder</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionHolder</span>(beanDefinition, className,<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; alias &#125;);<br>    <span class="hljs-comment">//将FeignClientFactoryBean注册到容器中</span><br>BeanDefinitionReaderUtils.registerBeanDefinition(holder, registry);<br>&#125;<br></code></pre></td></tr></table></figure><p>这一步完成后，所有的加了@FeignClient的类就会被解析成FeignClientFactoryBean类型的BeanDefinition加入到容器中，FeignClientFactoryBean包含了@FeignClient上配置的信息，以及保存了当前添加@FeignClient注解的Class名称。之后就是Spring容器在refresh()内会去实例化该FeignClient，而FeignClientFactoryBean是FactoryBean类型，所以会调用它的getObject()进行实例化。</p><h1 id="FeignClient实例化"><a href="#FeignClient实例化" class="headerlink" title="FeignClient实例化"></a>FeignClient实例化</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">#FeignClientFactoryBean<br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><span class="hljs-keyword">return</span> getTarget();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java">#FeignClientFactoryBean<br>&lt;T&gt; T <span class="hljs-title function_">getTarget</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//获取FeignContext，在FeignAutoConfiguration自动装配进来</span><br><span class="hljs-type">FeignContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.applicationContext.getBean(FeignContext.class);<br>    <span class="hljs-comment">//创建builder对象，用来生成Feign</span><br>Feign.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> feign(context);<br>    <span class="hljs-comment">//如果没有在@FeignClient配置了url，说明要负载均衡</span><br><span class="hljs-keyword">if</span> (!StringUtils.hasText(<span class="hljs-built_in">this</span>.url)) &#123;<br>       <span class="hljs-comment">//构造url</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.name.startsWith(<span class="hljs-string">&quot;http&quot;</span>)) &#123;<br><span class="hljs-built_in">this</span>.url = <span class="hljs-string">&quot;http://&quot;</span> + <span class="hljs-built_in">this</span>.name;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-built_in">this</span>.url = <span class="hljs-built_in">this</span>.name;<br>&#125;<br>        <span class="hljs-comment">//http://服务名</span><br><span class="hljs-built_in">this</span>.url += cleanPath();<br>        <span class="hljs-comment">//创建负载均衡代理类</span><br><span class="hljs-keyword">return</span> (T) loadBalance(builder, context,<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">HardCodedTarget</span>&lt;&gt;(<span class="hljs-built_in">this</span>.type, <span class="hljs-built_in">this</span>.name, <span class="hljs-built_in">this</span>.url));<br>&#125;<br>    <br>    <span class="hljs-comment">//说明url存在，使用硬编码的方式</span><br><span class="hljs-keyword">if</span> (StringUtils.hasText(<span class="hljs-built_in">this</span>.url) &amp;&amp; !<span class="hljs-built_in">this</span>.url.startsWith(<span class="hljs-string">&quot;http&quot;</span>)) &#123;<br>        <span class="hljs-comment">//直接拼接url</span><br><span class="hljs-built_in">this</span>.url = <span class="hljs-string">&quot;http://&quot;</span> + <span class="hljs-built_in">this</span>.url;<br>&#125;<br><span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.url + cleanPath();<br>    <span class="hljs-comment">//获取客户端对象</span><br><span class="hljs-type">Client</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> getOptional(context, Client.class);<br><span class="hljs-keyword">if</span> (client != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">//Ribbon客户端对象LoadBalancerFeignClient</span><br><span class="hljs-keyword">if</span> (client <span class="hljs-keyword">instanceof</span> LoadBalancerFeignClient) &#123;<br>client = ((LoadBalancerFeignClient) client).getDelegate();<br>&#125;<br>builder.client(client);<br>&#125;<br>    <span class="hljs-comment">//在FeignAutoConfiguration自动装配进来</span><br><span class="hljs-type">Targeter</span> <span class="hljs-variable">targeter</span> <span class="hljs-operator">=</span> get(context, Targeter.class);<br>    <span class="hljs-comment">//生成动态代理对象</span><br><span class="hljs-keyword">return</span> (T) targeter.target(<span class="hljs-built_in">this</span>, builder, context,<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">HardCodedTarget</span>&lt;&gt;(<span class="hljs-built_in">this</span>.type, <span class="hljs-built_in">this</span>.name, url));<br>&#125;<br></code></pre></td></tr></table></figure><p>FeignContext在哪注入到spring容器的呢？在FeignAutoConfiguration中</p><h2 id="FeignAutoConfiguration自动装配"><a href="#FeignAutoConfiguration自动装配" class="headerlink" title="FeignAutoConfiguration自动装配"></a>FeignAutoConfiguration自动装配</h2><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">spring</span>-cloud-starter-openfeign pom.xml  -&gt;</span> <span class="hljs-function"><span class="hljs-title">spring</span>-cloud-openfeign-core -&gt;</span> <span class="hljs-function"><span class="hljs-title">spring</span>.factories -&gt;</span> org.springframework.cloud.openfeign.FeignAutoConfiguration<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ConditionalOnClass(Feign.class)</span><br><span class="hljs-meta">@EnableConfigurationProperties(&#123; FeignClientProperties.class,</span><br><span class="hljs-meta">FeignHttpClientProperties.class &#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignAutoConfiguration</span> &#123;<br><br>    <span class="hljs-comment">//FeignContext，内部保存了创建FeignClient所需的组件</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> FeignContext <span class="hljs-title function_">feignContext</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-type">FeignContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FeignContext</span>();<br>context.setConfigurations(<span class="hljs-built_in">this</span>.configurations);<br><span class="hljs-keyword">return</span> context;<br>&#125;<br><br>    <span class="hljs-comment">//以下是两个相对的条件</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ConditionalOnClass(name = &quot;feign.hystrix.HystrixFeign&quot;)</span><span class="hljs-comment">//引入hystrix</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HystrixFeignTargeterConfiguration</span> &#123;<br><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@ConditionalOnMissingBean</span><br><span class="hljs-keyword">public</span> Targeter <span class="hljs-title function_">feignTargeter</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-comment">//创建Hystrix类型</span><br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HystrixTargeter</span>();<br>&#125;<br>&#125;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ConditionalOnMissingClass(&quot;feign.hystrix.HystrixFeign&quot;)</span><span class="hljs-comment">//未引入hystrix</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultFeignTargeterConfiguration</span> &#123;<br><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@ConditionalOnMissingBean</span><br><span class="hljs-keyword">public</span> Targeter <span class="hljs-title function_">feignTargeter</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-comment">//创建默认类型</span><br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultTargeter</span>();<br>&#125;<br><br>&#125;<br>    <br>    <span class="hljs-comment">//下面还有HttpClient,Okhttp的配置</span><br>&#125;<br></code></pre></td></tr></table></figure><p>FeignAutoConfiguration配置类会自动装配一些用来创建FeignClient实例的Bean信息。</p><h2 id="创建生成Feign的Builder对象"><a href="#创建生成Feign的Builder对象" class="headerlink" title="创建生成Feign的Builder对象"></a>创建生成Feign的Builder对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">#FeignClientFactoryBean#getTarget() <br><span class="hljs-comment">//创建builder对象，用来生成Feign</span><br>Feign.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> feign(context);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">#FeignClientFactoryBean<br><span class="hljs-keyword">protected</span> Feign.Builder <span class="hljs-title function_">feign</span><span class="hljs-params">(FeignContext context)</span> &#123;<br><span class="hljs-type">FeignLoggerFactory</span> <span class="hljs-variable">loggerFactory</span> <span class="hljs-operator">=</span> get(context, FeignLoggerFactory.class);<br><span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> loggerFactory.create(<span class="hljs-built_in">this</span>.type);<br>    <span class="hljs-comment">//设置Logger、Encoder、Decoder等组件</span><br>Feign.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> get(context, Feign.Builder.class)<br>.logger(logger)<br>.encoder(get(context, Encoder.class))<br>.decoder(get(context, Decoder.class))<br>.contract(get(context, Contract.class));<br>    <span class="hljs-comment">//配置builder</span><br>configureFeign(context, builder);<br><span class="hljs-keyword">return</span> builder;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java">#FeignClientFactoryBean<br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureFeign</span><span class="hljs-params">(FeignContext context, Feign.Builder builder)</span> &#123;<br><span class="hljs-type">FeignClientProperties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.applicationContext<br>.getBean(FeignClientProperties.class);<br>    <span class="hljs-comment">//从.properties配置文件中加载配置</span><br><span class="hljs-keyword">if</span> (properties != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (properties.isDefaultToProperties()) &#123;<br>configureUsingConfiguration(context, builder);<br>configureUsingProperties(<br>properties.getConfig().get(properties.getDefaultConfig()),<br>builder);<br>configureUsingProperties(properties.getConfig().get(<span class="hljs-built_in">this</span>.contextId),<br>builder);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>configureUsingProperties(<br>properties.getConfig().get(properties.getDefaultConfig()),<br>builder);<br>configureUsingProperties(properties.getConfig().get(<span class="hljs-built_in">this</span>.contextId),<br>builder);<br>configureUsingConfiguration(context, builder);<br>&#125;<br>&#125;<br>    <span class="hljs-comment">//配置类@Bean加载配置</span><br><span class="hljs-keyword">else</span> &#123;<br>configureUsingConfiguration(context, builder);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在加载配置到builder对象中后，就是去生成代理对象的逻辑。</p><h2 id="创建Feign代理对象"><a href="#创建Feign代理对象" class="headerlink" title="创建Feign代理对象"></a>创建Feign代理对象</h2><p>首先来看看创建负载均衡代理对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">#FeignClientFactoryBean#getTarget() <br><span class="hljs-comment">//创建负载均衡代理类</span><br><span class="hljs-keyword">return</span> (T) loadBalance(builder, context,<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">HardCodedTarget</span>&lt;&gt;(<span class="hljs-built_in">this</span>.type, <span class="hljs-built_in">this</span>.name, <span class="hljs-built_in">this</span>.url));<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">#FeignClientFactoryBean<br><span class="hljs-keyword">protected</span> &lt;T&gt; T <span class="hljs-title function_">loadBalance</span><span class="hljs-params">(Feign.Builder builder, FeignContext context,</span><br><span class="hljs-params">HardCodedTarget&lt;T&gt; target)</span> &#123;<br>    <span class="hljs-comment">//获取客户端对象</span><br><span class="hljs-type">Client</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> getOptional(context, Client.class);<br><span class="hljs-keyword">if</span> (client != <span class="hljs-literal">null</span>) &#123;<br>builder.client(client);<br>        <span class="hljs-comment">//获取Targeter，分别有HystrixTargeter和DefaultTargeter类型</span><br><span class="hljs-type">Targeter</span> <span class="hljs-variable">targeter</span> <span class="hljs-operator">=</span> get(context, Targeter.class);<br>        <span class="hljs-comment">//创建代理对象，跟进去，是一个接口方法，分别对应上面两种类型的实现</span><br><span class="hljs-keyword">return</span> targeter.target(<span class="hljs-built_in">this</span>, builder, context, target);<br>&#125;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<br><span class="hljs-string">&quot;No Feign Client for loadBalancing defined. Did you forget to include spring-cloud-starter-netflix-ribbon?&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="DefaultTargeter创建代理对象"><a href="#DefaultTargeter创建代理对象" class="headerlink" title="DefaultTargeter创建代理对象"></a>DefaultTargeter创建代理对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">#FeignClientFactoryBean<br><span class="hljs-comment">//获取Targeter，分别有HystrixTargeter和DefaultTargeter类型</span><br><span class="hljs-type">Targeter</span> <span class="hljs-variable">targeter</span> <span class="hljs-operator">=</span> get(context, Targeter.class);<br>        <span class="hljs-comment">//创建代理对象，跟进去，是一个接口方法，分别对应上面两种类型的实现</span><br><span class="hljs-keyword">return</span> targeter.target(<span class="hljs-built_in">this</span>, builder, context, target);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">#DefaultTargeter<br><span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">target</span><span class="hljs-params">(FeignClientFactoryBean factory, Feign.Builder feign,</span><br><span class="hljs-params">      FeignContext context, Target.HardCodedTarget&lt;T&gt; target)</span> &#123;<br>   <span class="hljs-keyword">return</span> feign.target(target);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">#Feign<br><span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">target</span><span class="hljs-params">(Target&lt;T&gt; target)</span> &#123;<br>    <span class="hljs-comment">//跟进去</span><br>   <span class="hljs-keyword">return</span> build().newInstance(target);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">#Feign.Builder<br><span class="hljs-keyword">public</span> Feign <span class="hljs-title function_">build</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-comment">//构建SynchronousMethodHandler工厂</span><br>  SynchronousMethodHandler.<span class="hljs-type">Factory</span> <span class="hljs-variable">synchronousMethodHandlerFactory</span> <span class="hljs-operator">=</span><br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronousMethodHandler</span>.Factory(client, retryer, requestInterceptors, logger,<br>          logLevel, decode404, closeAfterDecode, propagationPolicy);<br>  <span class="hljs-comment">//设置组件对象</span><br>  <span class="hljs-type">ParseHandlersByName</span> <span class="hljs-variable">handlersByName</span> <span class="hljs-operator">=</span><br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParseHandlersByName</span>(contract, options, encoder, decoder, queryMapEncoder,<br>          errorDecoder, synchronousMethodHandlerFactory);<br>  <span class="hljs-comment">//创建ReflectiveFeign实例，invocationHandlerFactory是InvocationHandlerFactory.Default类型</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectiveFeign</span>(handlersByName, invocationHandlerFactory, queryMapEncoder);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java">#ReflectiveFeign  是Feign的实现类<br><span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">newInstance</span><span class="hljs-params">(Target&lt;T&gt; target)</span> &#123;<br>  <span class="hljs-comment">//target内部保存了当前加了@FeignClient的接口Class，apply()会解析出接口中的方法和方法上的注解</span><br>  <span class="hljs-comment">//key是方法名，value是SynchronousMethodHandler类型，内部持有这个方法和注解的所有信息</span><br>  Map&lt;String, MethodHandler&gt; nameToHandler = targetToHandlersByName.apply(target);<br>  Map&lt;Method, MethodHandler&gt; methodToHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;Method, MethodHandler&gt;();<br>  List&lt;DefaultMethodHandler&gt; defaultMethodHandlers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;DefaultMethodHandler&gt;();<br>  <span class="hljs-comment">//target.type()就是获取接口的Class</span><br>  <span class="hljs-comment">//遍历所有的接口方法</span><br>  <span class="hljs-keyword">for</span> (Method method : target.type().getMethods()) &#123;<br>    <span class="hljs-keyword">if</span> (method.getDeclaringClass() == Object.class) &#123;<br>      <span class="hljs-comment">//Object的方法不管</span><br>      <span class="hljs-keyword">continue</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Util.isDefault(method)) &#123;<br>      <span class="hljs-comment">//default 类型的方法，要加入到defaultMethodHandlers集合</span><br>      <span class="hljs-type">DefaultMethodHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMethodHandler</span>(method);<br>      defaultMethodHandlers.add(handler);<br>      methodToHandler.put(method, handler);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">//非Object，default的方法，从nameToHandler中取出添加到methodToHandler集合</span><br>      methodToHandler.put(method, nameToHandler.get(Feign.configKey(target.type(), method)));<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">//InvocationHandler工厂创建InvocationHandler对象</span><br>  <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> factory.create(target, methodToHandler);<br>  <span class="hljs-comment">//创建代理对象</span><br>  <span class="hljs-type">T</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (T) Proxy.newProxyInstance(target.type().getClassLoader(),<br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>&lt;?&gt;[] &#123;target.type()&#125;, handler);<br>  <span class="hljs-keyword">for</span> (DefaultMethodHandler defaultMethodHandler : defaultMethodHandlers) &#123;<br>    <span class="hljs-comment">//将default方法绑定在代理对象上</span><br>    defaultMethodHandler.bindTo(proxy);<br>  &#125;<br>  <span class="hljs-comment">//返回代理对象</span><br>  <span class="hljs-keyword">return</span> proxy;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="InvocationHandler对象调用invoke"><a href="#InvocationHandler对象调用invoke" class="headerlink" title="InvocationHandler对象调用invoke()"></a>InvocationHandler对象调用invoke()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">#InvocationHandlerFactory.Default<br><span class="hljs-keyword">public</span> InvocationHandler <span class="hljs-title function_">create</span><span class="hljs-params">(Target target, Map&lt;Method, MethodHandler&gt; dispatch)</span> &#123;<br>  <span class="hljs-comment">//创建了FeignInvocationHandler类型的InvocationHandler，直接看它的invoke方法</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectiveFeign</span>.FeignInvocationHandler(target, dispatch);<br>&#125;<br></code></pre></td></tr></table></figure><p>当feignClient中的方法被调用后会执行FeignInvocationHandler的invoke方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java">#FeignInvocationHandler<br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;equals&quot;</span>.equals(method.getName())) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">otherHandler</span> <span class="hljs-operator">=</span><br>          args.length &gt; <span class="hljs-number">0</span> &amp;&amp; args[<span class="hljs-number">0</span>] != <span class="hljs-literal">null</span> ? Proxy.getInvocationHandler(args[<span class="hljs-number">0</span>]) : <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">return</span> equals(otherHandler);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;hashCode&quot;</span>.equals(method.getName())) &#123;<br>    <span class="hljs-keyword">return</span> hashCode();<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;toString&quot;</span>.equals(method.getName())) &#123;<br>    <span class="hljs-keyword">return</span> toString();<br>  &#125;<br>  <span class="hljs-comment">//dispatch就是在构造中赋值的，在#ReflectiveFeign的newInstance()方法中的methodToHandler</span><br>  <span class="hljs-comment">//key为接口中的方法，value为SynchronousMethodHandler和DefaultMethodHandler类型</span><br>  <span class="hljs-comment">//所以接下来就去看这两个类型的invoke方法</span><br>  <span class="hljs-keyword">return</span> dispatch.get(method).invoke(args);<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="DefaultMethodHandler的invoke"><a href="#DefaultMethodHandler的invoke" class="headerlink" title="DefaultMethodHandler的invoke()"></a>DefaultMethodHandler的invoke()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object[] argv)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>  <span class="hljs-keyword">if</span> (handle == <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<br>        <span class="hljs-string">&quot;Default method handler invoked before proxy has been bound.&quot;</span>);<br>  &#125;<br>  <span class="hljs-comment">//default修饰的方法就直接执行</span><br>  <span class="hljs-keyword">return</span> handle.invokeWithArguments(argv);<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="SynchronousMethodHandler的invoke"><a href="#SynchronousMethodHandler的invoke" class="headerlink" title="SynchronousMethodHandler的invoke()"></a>SynchronousMethodHandler的invoke()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object[] argv)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>  <span class="hljs-comment">//将方法参数构建成RequestTemplate，这个对象相信大家都很熟悉</span><br>  <span class="hljs-type">RequestTemplate</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> buildTemplateFromArgs.create(argv);<br>  <span class="hljs-type">Options</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> findOptions(argv);<br>  <span class="hljs-type">Retryer</span> <span class="hljs-variable">retryer</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.retryer.clone();<br>  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">//执行请求</span><br>      <span class="hljs-keyword">return</span> executeAndDecode(template, options);<br>    &#125; <span class="hljs-keyword">catch</span> (RetryableException e) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//重试机制</span><br>        retryer.continueOrPropagate(e);<br>      &#125; <br>      <span class="hljs-comment">//......</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java">#SynchronousMethodHandler<br>Object <span class="hljs-title function_">executeAndDecode</span><span class="hljs-params">(RequestTemplate template, Options options)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>  <span class="hljs-comment">//调用RequestInterceptor，根据template生成Request对象</span><br>  <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> targetRequest(template);<br>  <span class="hljs-comment">//......</span><br>  <span class="hljs-comment">//响应对象</span><br>  Response response;<br>  <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.nanoTime();<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">//调用客户端的execute执行请求</span><br>    response = client.execute(request, options);<br>  &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>    <span class="hljs-comment">//......</span><br>  &#125;<br>  <span class="hljs-type">long</span> <span class="hljs-variable">elapsedTime</span> <span class="hljs-operator">=</span> TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - start);<br>  <span class="hljs-type">boolean</span> <span class="hljs-variable">shouldClose</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">//......</span><br>    <span class="hljs-comment">//对response进行解码</span><br>    <span class="hljs-keyword">if</span> (Response.class == metadata.returnType()) &#123;<br>      <span class="hljs-keyword">if</span> (response.body() == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> response;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (response.body().length() == <span class="hljs-literal">null</span> ||<br>          response.body().length() &gt; MAX_RESPONSE_BUFFER_SIZE) &#123;<br>        shouldClose = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">return</span> response;<br>      &#125;<br>      <span class="hljs-type">byte</span>[] bodyData = Util.toByteArray(response.body().asInputStream());<br>      <span class="hljs-keyword">return</span> response.toBuilder().body(bodyData).build();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (response.status() &gt;= <span class="hljs-number">200</span> &amp;&amp; response.status() &lt; <span class="hljs-number">300</span>) &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">void</span>.class == metadata.returnType()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> decode(response);<br>        shouldClose = closeAfterDecode;<br>        <span class="hljs-keyword">return</span> result;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (decode404 &amp;&amp; response.status() == <span class="hljs-number">404</span> &amp;&amp; <span class="hljs-keyword">void</span>.class != metadata.returnType()) &#123;<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> decode(response);<br>      shouldClose = closeAfterDecode;<br>      <span class="hljs-keyword">return</span> result;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">throw</span> errorDecoder.decode(metadata.configKey(), response);<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">//......</span><br>&#125;<br></code></pre></td></tr></table></figure><p>真正执行请求的client.execute(request, options)是一个接口方法，是由不同的客户端工具进行实现。如果没有导入Ribbon，那么就用feign自带的Client.Default内部进行实现。Client是一个接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">#Client.Default<br><span class="hljs-keyword">public</span> Response <span class="hljs-title function_">execute</span><span class="hljs-params">(Request request, Options options)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>  <span class="hljs-comment">//convertAndSend()发送请求</span><br>  <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> convertAndSend(request, options);<br>  <span class="hljs-comment">//convertResponse()响应解码</span><br>  <span class="hljs-keyword">return</span> convertResponse(connection, request);<br>&#125;<br></code></pre></td></tr></table></figure><p>如果导入了Ribbon，那么就是LoadBalancerFeignClient实现，内部使用Ribbon进行负载均衡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">#LoadBalancerFeignClient<br><span class="hljs-keyword">public</span> Response <span class="hljs-title function_">execute</span><span class="hljs-params">(Request request, Request.Options options)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-type">URI</span> <span class="hljs-variable">asUri</span> <span class="hljs-operator">=</span> URI.create(request.url());<br><span class="hljs-type">String</span> <span class="hljs-variable">clientName</span> <span class="hljs-operator">=</span> asUri.getHost();<br><span class="hljs-type">URI</span> <span class="hljs-variable">uriWithoutHost</span> <span class="hljs-operator">=</span> cleanUrl(request.url(), clientName);<br>FeignLoadBalancer.<span class="hljs-type">RibbonRequest</span> <span class="hljs-variable">ribbonRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FeignLoadBalancer</span>.RibbonRequest(<br><span class="hljs-built_in">this</span>.delegate, request, uriWithoutHost);<br><span class="hljs-type">IClientConfig</span> <span class="hljs-variable">requestConfig</span> <span class="hljs-operator">=</span> getClientConfig(options, clientName);<br><span class="hljs-keyword">return</span> lbClient(clientName)<br>.executeWithLoadBalancer(ribbonRequest, requestConfig).toResponse();<br>&#125;<br><span class="hljs-comment">//......</span><br>&#125;<br></code></pre></td></tr></table></figure><p>到这里，没有导入Hystrix创建代理对象的流程就分析完了，一些具体解析的方法并没有去详细分析，因为我们主要是理解openfeign的执行流程，所以分析创建代理对象，然后到真正执行请求的地方就行了。接下来是去分析引入了Hystrix后是如何创建代理。</p><h1 id="HystrixTargeter创建代理对象"><a href="#HystrixTargeter创建代理对象" class="headerlink" title="HystrixTargeter创建代理对象"></a>HystrixTargeter创建代理对象</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java">#HystrixTargeter<br><span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">target</span><span class="hljs-params">(FeignClientFactoryBean factory, Feign.Builder feign,</span><br><span class="hljs-params">FeignContext context, Target.HardCodedTarget&lt;T&gt; target)</span> &#123;<br>    <span class="hljs-comment">//判断是否为HystrixFeign类型</span><br><span class="hljs-keyword">if</span> (!(feign <span class="hljs-keyword">instanceof</span> feign.hystrix.HystrixFeign.Builder)) &#123;<br>        <span class="hljs-comment">//这里会调用ReflectiveFeign的那段逻辑</span><br><span class="hljs-keyword">return</span> feign.target(target);<br>&#125;<br>feign.hystrix.HystrixFeign.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> (feign.hystrix.HystrixFeign.Builder) feign;<br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> StringUtils.isEmpty(factory.getContextId()) ? factory.getName()<br>: factory.getContextId();<br><span class="hljs-type">SetterFactory</span> <span class="hljs-variable">setterFactory</span> <span class="hljs-operator">=</span> getOptional(name, context, SetterFactory.class);<br><span class="hljs-keyword">if</span> (setterFactory != <span class="hljs-literal">null</span>) &#123;<br>builder.setterFactory(setterFactory);<br>&#125;<br>    <span class="hljs-comment">//是否设置降级</span><br>Class&lt;?&gt; fallback = factory.getFallback();<br><span class="hljs-keyword">if</span> (fallback != <span class="hljs-keyword">void</span>.class) &#123;<br><span class="hljs-keyword">return</span> targetWithFallback(name, context, target, builder, fallback);<br>&#125;<br>Class&lt;?&gt; fallbackFactory = factory.getFallbackFactory();<br><span class="hljs-keyword">if</span> (fallbackFactory != <span class="hljs-keyword">void</span>.class) &#123;<br><span class="hljs-keyword">return</span> targetWithFallbackFactory(name, context, target, builder,<br>fallbackFactory);<br>&#125;<br>    <span class="hljs-comment">//执行到这说明没有设置降级，又会回到ReflectiveFeign</span><br><span class="hljs-keyword">return</span> feign.target(target);<br>&#125;<br></code></pre></td></tr></table></figure><p>虽然导入了Hystrix，但是内部还是会判断是否设置过降级，如果没有，会回到普通的调用链路。上面的降级分支最终都会合并到一起，所以分析一个方法就行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">#HystrixTargeter<br><span class="hljs-keyword">private</span> &lt;T&gt; T <span class="hljs-title function_">targetWithFallback</span><span class="hljs-params">(String feignClientName, FeignContext context,</span><br><span class="hljs-params">Target.HardCodedTarget&lt;T&gt; target, HystrixFeign.Builder builder,</span><br><span class="hljs-params">Class&lt;?&gt; fallback)</span> &#123;<br><span class="hljs-type">T</span> <span class="hljs-variable">fallbackInstance</span> <span class="hljs-operator">=</span> getFromContext(<span class="hljs-string">&quot;fallback&quot;</span>, feignClientName, context,<br>fallback, target.type());<br>    <span class="hljs-comment">//创建代理对象，跟进去</span><br><span class="hljs-keyword">return</span> builder.target(target, fallbackInstance);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">#HystrixFeign.Builder<br><span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">target</span><span class="hljs-params">(Target&lt;T&gt; target, T fallback)</span> &#123;<br>  <span class="hljs-comment">//newInstance会回到ReflectiveFeign逻辑，我们关心的是引入hystrix后，InvocationHandler的类型</span><br>  <span class="hljs-comment">//在build中会设置InvocationHandlerFactory的类型</span><br>  <span class="hljs-keyword">return</span> build(fallback != <span class="hljs-literal">null</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">FallbackFactory</span>.Default&lt;T&gt;(fallback) : <span class="hljs-literal">null</span>)<br>      .newInstance(target);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">#HystrixFeign.Builder<br>Feign <span class="hljs-title function_">build</span><span class="hljs-params">(<span class="hljs-keyword">final</span> FallbackFactory&lt;?&gt; nullableFallbackFactory)</span> &#123;<br>  <span class="hljs-built_in">super</span>.invocationHandlerFactory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvocationHandlerFactory</span>() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> InvocationHandler <span class="hljs-title function_">create</span><span class="hljs-params">(Target target,</span><br><span class="hljs-params">                                    Map&lt;Method, MethodHandler&gt; dispatch)</span> &#123;<br>      <span class="hljs-comment">//最终返回了HystrixInvocationHandler实例，所以去看它的invoke方法</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HystrixInvocationHandler</span>(target, dispatch, setterFactory,<br>          nullableFallbackFactory);<br>    &#125;<br>  &#125;);<br>  <span class="hljs-built_in">super</span>.contract(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HystrixDelegatingContract</span>(contract));<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.build();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java">#HystrixInvocationHandler<br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object proxy, <span class="hljs-keyword">final</span> Method method, <span class="hljs-keyword">final</span> Object[] args)</span><br>    <span class="hljs-keyword">throws</span> Throwable &#123;<br>  <span class="hljs-comment">//......</span><br>  HystrixCommand&lt;Object&gt; hystrixCommand =<br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">HystrixCommand</span>&lt;Object&gt;(setterMethodMap.get(method))&#123;<br>      <span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">run</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//在这里回到SynchronousMethodHandler和DefaultMethodHandler的invoke逻辑</span><br>    <span class="hljs-keyword">return</span> HystrixInvocationHandler.<span class="hljs-built_in">this</span>.dispatch.get(method).invoke(args);<br>  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    <span class="hljs-keyword">throw</span> e;<br>  &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>    <span class="hljs-keyword">throw</span> (Error) t;<br>  &#125;<br>&#125;<br>      <span class="hljs-comment">//......</span><br>  &#125;;<br>  <span class="hljs-comment">//最终调用到Hystrix处理逻辑</span><br>  <span class="hljs-keyword">return</span> hystrixCommand.execute();<br>&#125;<br></code></pre></td></tr></table></figure><p>到这里Hystrix的代理逻辑也分析完了，它和默认创建代理对象的逻辑就是invoke()的实现不同，它只是对请求加了熔断降级的处理，其他的流程基本一致。</p><p>以上就是openfeign源码分析的整体流程，首先从feign的功能是如何开启的开始分析，然后到FeignClient是如何添加到容器当中，接着分析FeignClient是如何被代理创建，最后分析了默认方式和引入Hystrix的方式分别是如何执行的。</p><h1 id="hystrix配置"><a href="#hystrix配置" class="headerlink" title="hystrix配置"></a>hystrix配置</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-title function_">HystrixCommand</span><span class="hljs-params">(Setter setter)</span> &#123;<br>    <span class="hljs-comment">// use &#x27;null&#x27; to specify use the default</span><br>    <span class="hljs-built_in">this</span>(setter.groupKey, setter.commandKey, setter.threadPoolKey, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, setter.commandPropertiesDefaults, setter.threadPoolPropertiesDefaults, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>发现commandPropertiesDefaults  和  threadPoolPropertiesDefaults </p><p>commandPropertiesDefaults  是命令相关参数、断路器相关参数</p><p>threadPoolPropertiesDefaults 是线程池相关参数</p><h1 id="ribbon源码"><a href="#ribbon源码" class="headerlink" title="ribbon源码"></a>ribbon源码</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">#HystrixInvocationHandler# invoke方法<br><span class="hljs-keyword">return</span> HystrixInvocationHandler.<span class="hljs-built_in">this</span>.dispatch.get(method).invoke(args);<br># SynchronousMethodHandler<br><span class="hljs-keyword">return</span> executeAndDecode(template, options);<br>#<span class="hljs-type">SynchronousMethodHandler</span><br><span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.execute(request, options);<br># 这时要看是哪个client<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java">#LoadBalancerFeignClient<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Response <span class="hljs-title function_">execute</span><span class="hljs-params">(Request request, Request.Options options)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-type">URI</span> <span class="hljs-variable">asUri</span> <span class="hljs-operator">=</span> URI.create(request.url());<br><span class="hljs-type">String</span> <span class="hljs-variable">clientName</span> <span class="hljs-operator">=</span> asUri.getHost();<br><span class="hljs-type">URI</span> <span class="hljs-variable">uriWithoutHost</span> <span class="hljs-operator">=</span> cleanUrl(request.url(), clientName);<br>FeignLoadBalancer.<span class="hljs-type">RibbonRequest</span> <span class="hljs-variable">ribbonRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FeignLoadBalancer</span>.RibbonRequest(<br><span class="hljs-built_in">this</span>.delegate, request, uriWithoutHost);<br><br><span class="hljs-type">IClientConfig</span> <span class="hljs-variable">requestConfig</span> <span class="hljs-operator">=</span> getClientConfig(options, clientName);<br><span class="hljs-keyword">return</span> lbClient(clientName)<br>.executeWithLoadBalancer(ribbonRequest, requestConfig).toResponse();<br>&#125;<br><span class="hljs-keyword">catch</span> (ClientException e) &#123;<br><span class="hljs-type">IOException</span> <span class="hljs-variable">io</span> <span class="hljs-operator">=</span> findIOException(e);<br><span class="hljs-keyword">if</span> (io != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> io;<br>&#125;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">#AbstractLoadBalancerAwareClient<br><span class="hljs-keyword">public</span> T <span class="hljs-title function_">executeWithLoadBalancer</span><span class="hljs-params">(<span class="hljs-keyword">final</span> S request, <span class="hljs-keyword">final</span> IClientConfig requestConfig)</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">#AbstractLoadBalancerAwareClient<br>LoadBalancerCommand&lt;T&gt; command = buildLoadBalancerCommand(request, requestConfig);<br><span class="hljs-keyword">return</span> command.submit(....)<br>#LoadBalancerCommand<br>Observable&lt;T&gt; o = <br>                (server == <span class="hljs-literal">null</span> ? selectServer() : Observable.just(server))<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">#LoadBalancerCommand<br><span class="hljs-keyword">private</span> Observable&lt;Server&gt; <span class="hljs-title function_">selectServer</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Observable.create(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OnSubscribe</span>&lt;Server&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">call</span><span class="hljs-params">(Subscriber&lt;? <span class="hljs-built_in">super</span> Server&gt; next)</span> &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">Server</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> loadBalancerContext.getServerFromLoadBalancer(loadBalancerURI, loadBalancerKey);   <br>                    next.onNext(server);<br>                    next.onCompleted();<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    next.onError(e);<br>                &#125;<br>            &#125;<br>        &#125;);<br>    &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">#LoadBalancerCommand<br><span class="hljs-type">Server</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> loadBalancerContext.getServerFromLoadBalancer(loadBalancerURI, loadBalancerKey);  <br>#LoadBalancerContext<br><span class="hljs-type">Server</span> <span class="hljs-variable">svc</span> <span class="hljs-operator">=</span> lb.chooseServer(loadBalancerKey);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Server <span class="hljs-title function_">chooseServer</span><span class="hljs-params">(Object key)</span> &#123;<br>        <span class="hljs-keyword">if</span> (counter == <span class="hljs-literal">null</span>) &#123;<br>            counter = createCounter();<br>        &#125;<br>        counter.increment();<br>        <span class="hljs-keyword">if</span> (rule == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">return</span> rule.choose(key);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                logger.warn(<span class="hljs-string">&quot;LoadBalancer [&#123;&#125;]:  Error choosing server for key &#123;&#125;&quot;</span>, name, key, e);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">IRule (com.netflix.loadbalancer)<br>  AbstractLoadBalancerRule (com.netflix.loadbalancer)<br>    ClientConfigEnabledRoundRobinRule (com.netflix.loadbalancer)<br>      BestAvailableRule (com.netflix.loadbalancer)<br>      PredicateBasedRule (com.netflix.loadbalancer)<br>        ZoneAvoidanceRule (com.netflix.loadbalancer)<br>        AvailabilityFilteringRule (com.netflix.loadbalancer)<br>    RoundRobinRule (com.netflix.loadbalancer)<br>      WeightedResponseTimeRule (com.netflix.loadbalancer)<br>      ResponseTimeWeightedRule (com.netflix.loadbalancer)<br>    RandomRule (com.netflix.loadbalancer)<br>    RetryRule (com.netflix.loadbalancer)<br></code></pre></td></tr></table></figure><p>ZoneAvoidanceRule（区域权衡策略）：复合判断Server所在区域的性能和Server的可用性，轮询选择服务器。</p><p>其他规则：</p><p>BestAvailableRule（最低并发策略）：会先过滤掉由于多次访问故障而处于断路器跳闸状态的服务，然后选择一个并发量最小的服务。逐个找服务，如果断路器打开，则忽略。</p><p>RoundRobinRule（轮询策略）：以简单轮询选择一个服务器。按顺序循环选择一个server。</p><p>RandomRule（随机策略）：随机选择一个服务器。</p><p>AvailabilityFilteringRule（可用过滤策略）：会先过滤掉多次访问故障而处于断路器跳闸状态的服务和过滤并发的连接数量超过阀值得服务，然后对剩余的服务列表安装轮询策略进行访问。</p><p>WeightedResponseTimeRule（响应时间加权策略）：据平均响应时间计算所有的服务的权重，响应时间越快服务权重越大，容易被选中的概率就越高。刚启动时，如果统计信息不中，则使用RoundRobinRule(轮询)策略，等统计的信息足够了会自动的切换到WeightedResponseTimeRule。响应时间长，权重低，被选择的概率低。反之，同样道理。此策略综合了各种因素（网络，磁盘，IO等），这些因素直接影响响应时间。</p><p>RetryRule（重试策略）：先按照RoundRobinRule(轮询)的策略获取服务，如果获取的服务失败则在指定的时间会进行重试，进行获取可用的服务。如多次获取某个服务失败，就不会再次获取该服务。主要是在一个时间段内，如果选择一个服务不成功，就继续找可用的服务，直到超时。</p>]]></content>
    
    
    <categories>
      
      <category>spring_cloud</category>
      
      <category>feign</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring_cloud</tag>
      
      <tag>feign</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring_cloud_feign实践</title>
    <link href="/2022/06/11/spring_cloud/spring_cloud_feign%E5%AE%9E%E8%B7%B5/"/>
    <url>/2022/06/11/spring_cloud/spring_cloud_feign%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h2 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h2><p><a href="https://docs.spring.io/spring-cloud-openfeign/docs/current/reference/html/">https://docs.spring.io/spring-cloud-openfeign/docs/current/reference/html/</a>  官网</p><p>在eureka的实践中，service-a的基础上。</p><p>pom.xml添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>在springboot启动类上</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@EnableEurekaClient</span><br><span class="hljs-variable">@EnableFeignClients</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-meta">@EnableFeignClients</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceAApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(ServiceAApplication.class, args);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>创建serviceb 服务</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>service-b<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>service-b<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Demo project for Spring Boot<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-boot.version</span>&gt;</span>2.3.7.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring-boot.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud.version</span>&gt;</span>Hoxton.SR9<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.vintage<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-vintage-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">encoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">encoding</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.7.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>com.example.serviceb.ServiceBApplication<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">service-b</span><br><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8763</span><br><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">serviceUrl:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:8761/eureka/</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-meta">@EnableFeignClients</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceBApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(ServiceBApplication.class, args);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span><br>    String port;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ServiceaClient serviceaClient;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/test1&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;i am service b from port:&quot;</span> + port;<br>    &#125;<br><br><br>    <span class="hljs-meta">@RequestMapping(&quot;/test2&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;调用:&quot;</span> + serviceaClient.test();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>定义一个feign接口，通过@ FeignClient（“服务名”），来指定调用哪个服务。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(&quot;servic-a&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ServiceaClient</span> &#123;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br>    String <span class="hljs-title function_">test</span><span class="hljs-params">()</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>servicea 服务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span><br>    String port;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ServicebClient servicebClient;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;i am from port:&quot;</span> + port;<br>    &#125;<br><br><br>    <span class="hljs-meta">@RequestMapping(&quot;/test2&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;调用:&quot;</span> + servicebClient.test();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(&quot;servic-b&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ServicebClient</span> &#123;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/test/test1&quot;)</span><br>    String <span class="hljs-title function_">test</span><span class="hljs-params">()</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>启动 eureka-server、service-a、service-b。</p><p>调用servicea的test2  和  调用 serviceb的test2</p><p>根据eureka的源码那章的阅读，可知，获取注册表接口是有时间间隔的最好等一会儿再调用</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">8762</span>/test2<br>调用:i am service b from port:<span class="hljs-number">8763</span><br><br>http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">8763</span><span class="hljs-regexp">/test/</span>test2<br>调用:i am from port:<span class="hljs-number">8762</span><br></code></pre></td></tr></table></figure><h2 id="覆盖feign默认值（自定义配置）"><a href="#覆盖feign默认值（自定义配置）" class="headerlink" title="覆盖feign默认值（自定义配置）"></a>覆盖feign默认值（自定义配置）</h2><p>以记录日志为例</p><p>feign打印日志的级别为debug。所以打日志开启到debug就是可以看到日志了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">logging:<br>  level:<br>    com.example: debug<br></code></pre></td></tr></table></figure><h3 id="java类方式配置"><a href="#java类方式配置" class="headerlink" title="java类方式配置"></a>java类方式配置</h3><p>单一个FeignClient使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignConfig</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 打印请求日志</span><br><span class="hljs-comment">     * &lt;p&gt;</span><br><span class="hljs-comment">     * NONE: 不记录任何信息</span><br><span class="hljs-comment">     * BASIE:仅记录请求方法，URL以及响应状态码和执行时间</span><br><span class="hljs-comment">     * HEADERS:除了记录BASIE级别得信息之外，还会记录请求和响应得头信息</span><br><span class="hljs-comment">     * FULL：记录所有请求与响应得明细，包括头信息，请求体，元数据等。</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> feign.Logger.Level <span class="hljs-title function_">multipartLoggerLevel</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> feign.Logger.Level.FULL;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;SERVICE-B&quot;, configuration = FeignConfig.class)</span><br></code></pre></td></tr></table></figure><p>所有feignclient生效：</p><p>在<strong>FeignConfig</strong>上加上注解@Configuration</p><p>也可以在@EnableFeignClients(defaultConfiguration &#x3D; GlobalFeignConfiguration.class)</p><h3 id="yml配置"><a href="#yml配置" class="headerlink" title="yml配置"></a>yml配置</h3><p>单个feignClient使用</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">SERVICE-B:</span><br>        <span class="hljs-attr">loggerLevel:</span> <span class="hljs-string">full</span><br></code></pre></td></tr></table></figure><p>所有feignclient生效：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">default:</span><br>        <span class="hljs-attr">loggerLevel:</span> <span class="hljs-string">full</span><br></code></pre></td></tr></table></figure><h3 id="所有类似配置都如上"><a href="#所有类似配置都如上" class="headerlink" title="所有类似配置都如上"></a>所有类似配置都如上</h3><p>Spring Cloud OpenFeign 默认为 feign ( <code>BeanType</code>beanName: <code>ClassName</code>) 提供以下 bean：</p><ul><li><code>Decoder</code>feignDecoder: <code>ResponseEntityDecoder</code>（包装 a <code>SpringDecoder</code>）</li><li><code>Encoder</code>伪装编码器：<code>SpringEncoder</code></li><li><code>Logger</code>伪装记录器：<code>Slf4jLogger</code></li><li><code>MicrometerCapability</code>micrometerCapability：如果<code>feign-micrometer</code>在类路径上并且<code>MeterRegistry</code>可用</li><li><code>CachingCapability</code>cacheCapability：如果<code>@EnableCaching</code>使用了注解。可以通过 禁用<code>feign.cache.enabled</code>。</li><li><code>Contract</code>假装合同：<code>SpringMvcContract</code></li><li><code>Feign.Builder</code>feignBuilder：<code>FeignCircuitBreaker.Builder</code></li><li><code>Client</code>feignClient：如果 Spring Cloud LoadBalancer 在类路径上，<code>FeignBlockingLoadBalancerClient</code>则使用。如果它们都不在类路径上，则使用默认的 feign 客户端。</li></ul><p>OkHttpClient 和 ApacheHttpClient 和 ApacheHC5 feign 客户端可以通过分别设置<code>feign.okhttp.enabled</code>or<code>feign.httpclient.enabled</code>或<code>feign.httpclient.hc5.enabled</code>to来使用<code>true</code>，并将它们放在类路径中。<code>org.apache.http.impl.client.CloseableHttpClient</code>您可以通过在使用 Apache 或<code>okhttp3.OkHttpClient</code>使用 OK HTTP 或<code>org.apache.hc.client5.http.impl.classic.CloseableHttpClient</code>使用 Apache HC5 时提供 bean 来自定义使用的 HTTP 客户端。</p><p>Spring Cloud OpenFeign默认<em>不</em>为 feign提供以下 bean，但仍会从应用上下文中查找这些类型的 bean 来创建 feign 客户端：</p><ul><li><code>Logger.Level</code></li><li><code>Retryer</code></li><li><code>ErrorDecoder</code></li><li><code>Request.Options</code></li><li><code>Collection&lt;RequestInterceptor&gt;</code></li><li><code>SetterFactory</code></li><li><code>QueryMapEncoder</code></li><li><code>Capability</code>（<code>MicrometerCapability</code>并且<code>CachingCapability</code>默认提供）</li></ul><p><code>Retryer.NEVER_RETRY</code>默认情况下会创建一个具有该类型的 bean <code>Retryer</code>，这将禁用重试。请注意，这种重试行为与 Feign 默认的行为不同，它会自动重试 IOException，将它们视为瞬态网络相关异常，以及从 ErrorDecoder 抛出的任何 RetryableException。</p><h2 id="超时配置"><a href="#超时配置" class="headerlink" title="超时配置"></a>超时配置</h2><p>OpenFeign 使用两个超时参数：</p><ul><li><code>connectTimeout</code>防止由于服务器处理时间长而阻塞调用者。</li><li><code>readTimeout</code>从连接建立时开始应用，在返回响应时间过长时触发。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">feign:<br>  client:<br>    config:<br>      <span class="hljs-keyword">default</span>:<br>        loggerLevel: full<br>        connectTimeout: <span class="hljs-number">5000</span><br>        readTimeout: <span class="hljs-number">5000</span><br></code></pre></td></tr></table></figure><p>以毫秒为单位。这里设置为5秒，按情况设置。</p><h2 id="断路器"><a href="#断路器" class="headerlink" title="断路器"></a>断路器</h2><p>未开启时，启动 eureka-server、service-a</p><p>这时调用a的test2接口：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tex">http://localhost:8762/test2<br><br>&#123;&quot;timestamp&quot;:&quot;2022-06-13T10:04:55.536+00:00&quot;,&quot;status&quot;:500,&quot;error&quot;:&quot;Internal Server Error&quot;,&quot;message&quot;:&quot;&quot;,&quot;path&quot;:&quot;/test2&quot;&#125;<br></code></pre></td></tr></table></figure><p>feign的jar包中包含了Hystrix的包。</p><h3 id="开启"><a href="#开启" class="headerlink" title="开启"></a>开启</h3><h4 id="方式一："><a href="#方式一：" class="headerlink" title="方式一："></a>方式一：</h4><p>在spring boot 启动类加上@EnableHystrix 或者@EnableCircuitBreaker</p><h4 id="方式二："><a href="#方式二：" class="headerlink" title="方式二："></a>方式二：</h4><p>旧版本：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-string">ture</span><br></code></pre></td></tr></table></figure><p>新版本:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">circuitbreaker:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-string">ture</span><br></code></pre></td></tr></table></figure><p>这时访问是一样的，因为没有配置断路器的回调方法</p><h3 id="超时"><a href="#超时" class="headerlink" title="超时"></a>超时</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">command:</span><br>    <span class="hljs-attr">default:</span><br>      <span class="hljs-attr">execution:</span><br>        <span class="hljs-attr">isolation:</span><br>          <span class="hljs-attr">thread:</span><br>            <span class="hljs-attr">timeoutInMilliseconds:</span> <span class="hljs-number">8000</span><br></code></pre></td></tr></table></figure><p>如果feign超时会返回，如果未超feign的超时，断路器超时会调用下面的降级方法。</p><h3 id="fallback"><a href="#fallback" class="headerlink" title="fallback"></a>fallback</h3><h4 id="直接写到-FeignClient的fallback："><a href="#直接写到-FeignClient的fallback：" class="headerlink" title="直接写到@FeignClient的fallback："></a>直接写到@FeignClient的fallback：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServicebClientFallBack</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServicebClient</span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;test2fallback 方法执行&quot;</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;SERVICE-B&quot;, fallback = ServicebClientFallBack.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ServicebClient</span> &#123;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/test/test1&quot;)</span><br>    String <span class="hljs-title function_">test</span><span class="hljs-params">()</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tex">http://localhost:8762/test2<br><br>调用:test2fallback 方法执行<br></code></pre></td></tr></table></figure><h4 id="写到-FeignClient的fallbackFactory"><a href="#写到-FeignClient的fallbackFactory" class="headerlink" title="写到@FeignClient的fallbackFactory"></a>写到@FeignClient的fallbackFactory</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServicebClientFallBack</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServicebClient</span>&#123;<br><br>    <span class="hljs-keyword">private</span> Throwable throwable;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ServicebClientFallBack</span><span class="hljs-params">(Throwable throwable)</span> &#123;<br>        <span class="hljs-built_in">this</span>.throwable = throwable;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;test2fallback 方法执行&quot;</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServicebClientFallBackFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FallbackFactory</span>&lt;ServicebClientFallBack&gt; &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ServicebClientFallBack <span class="hljs-title function_">create</span><span class="hljs-params">(Throwable throwable)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServicebClientFallBack</span>(throwable);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;SERVICE-B&quot;, fallbackFactory = ServicebClientFallBackFactory.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ServicebClient</span> &#123;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/test/test1&quot;)</span><br>    String <span class="hljs-title function_">test</span><span class="hljs-params">()</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>可以根据Throwable cause  返回不同的信息</p><h2 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">default:</span><br>        <span class="hljs-attr">loggerLevel:</span> <span class="hljs-string">full</span><br>        <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">5000</span><br>        <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">5000</span><br>  <span class="hljs-attr">compression:</span><br>    <span class="hljs-attr">request:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">response:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><p>执行后发现日志：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">Accept-Encoding: gzip<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">default:</span><br>        <span class="hljs-attr">loggerLevel:</span> <span class="hljs-string">full</span><br>        <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">5000</span><br>        <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">5000</span><br>  <span class="hljs-attr">compression:</span><br>    <span class="hljs-attr">request:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">mime-types:</span> <span class="hljs-string">text/xml,application/xml,application/json</span><br>      <span class="hljs-attr">min-request-size:</span> <span class="hljs-number">2048</span><br>    <span class="hljs-attr">response:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><h2 id="断路器监控面板"><a href="#断路器监控面板" class="headerlink" title="断路器监控面板"></a>断路器监控面板</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">dashboard:</span><br>  <span class="hljs-attr">proxy-stream-allow-list:</span> <span class="hljs-string">&quot;*&quot;</span><br><br><span class="hljs-attr">management:</span><br>  <span class="hljs-attr">endpoints:</span><br>    <span class="hljs-attr">web:</span><br>      <span class="hljs-attr">exposure:</span><br>        <span class="hljs-attr">include:</span> <span class="hljs-string">&#x27;*&#x27;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-meta">@EnableFeignClients</span><br><span class="hljs-meta">@EnableHystrixDashboard</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceAApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(ServiceAApplication.class, args);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> ServletRegistrationBean <span class="hljs-title function_">getServlet</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">HystrixMetricsStreamServlet</span> <span class="hljs-variable">streamServlet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HystrixMetricsStreamServlet</span>();<br>        <span class="hljs-type">ServletRegistrationBean</span> <span class="hljs-variable">registrationBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletRegistrationBean</span>(streamServlet);<br>        registrationBean.setLoadOnStartup(<span class="hljs-number">1</span>);<br>        registrationBean.addUrlMappings(<span class="hljs-string">&quot;/actuator/hystrix.stream&quot;</span>);<span class="hljs-comment">//访问路径</span><br>        registrationBean.setName(<span class="hljs-string">&quot;hystrix.stream&quot;</span>);<br>        <span class="hljs-keyword">return</span> registrationBean;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>访问：<a href="http://localhost:8762/actuator/hystrix.stream">http://localhost:8762/actuator/hystrix.stream</a>  一直ping，但是没有信息</p><p>访问：<a href="http://localhost:8762/test2">http://localhost:8762/test2</a> 接口后</p><p>再访问 <a href="http://localhost:8762/actuator/hystrix.stream">http://localhost:8762/actuator/hystrix.stream</a>  会出现data信息</p><p>访问：<a href="http://localhost:8762/hystrix">http://localhost:8762/hystrix</a></p><p>输入 <a href="http://localhost:8762/actuator/hystrix.stream">http://localhost:8762/actuator/hystrix.stream</a> 点击 Monitor Stream</p><p>可以看到图形界面。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>熔断：熔断机制是赌赢雪崩效应的一种微服务链路保护机制。</p><ul><li>凡是依赖都有可能会失败。</li><li>凡是资源都有限制，比如 CPU、Memory、Threads、Queue。</li><li>网络并不可靠，可能存在网络抖动等其他问题。</li><li>延迟是应用稳定的杀手，延迟会占据大量的资源。</li></ul><p>当请求失败率达到一定的阈值时，会打开断路器开关，直接拒绝后续的请求，并且具有弹性机制，在后端服务恢复后，会自动关闭断路器开关。</p><p>降级： 服务分优先级，牺牲非核心服务（不可用），保证核心服务稳定；从整体负荷考虑；</p><p>限流：限制并发的请求访问量，超过阈值则拒绝；</p><p>Hystrix是Netflix公司开源的一款容错框架。 它可以完成以下几件事情：</p><p>熔断器：当请求失败率达到一定的阈值时，会打开断路器开关，直接拒绝后续的请求，并且具有弹性机制，在后端服务恢复后，会自动关闭断路器开关。<br>资源隔离：包括线程池隔离和信号量隔离，避免某个依赖出现问题会影响到其他依赖。<br>降级回退：当断路器开关被打开，服务调用超时&#x2F;异常，或者资源不足（线程、信号量）会进入指定的fallback降级方法。<br>请求合并：可以实现将一段时间内的请求合并，然后只对后端服务发送一次请求。<br>请求结果缓存：hystrix实现了一个内部缓存机制，可以将请求结果进行缓存，那么对于相同的请求则会直接走缓存而不用请求后端服务。</p>]]></content>
    
    
    <categories>
      
      <category>spring_cloud</category>
      
      <category>feign</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring_cloud</tag>
      
      <tag>feign</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>exception不打印堆栈信息</title>
    <link href="/2022/06/08/java/exception%E4%B8%8D%E6%89%93%E5%8D%B0%E5%A0%86%E6%A0%88%E4%BF%A1%E6%81%AF/"/>
    <url>/2022/06/08/java/exception%E4%B8%8D%E6%89%93%E5%8D%B0%E5%A0%86%E6%A0%88%E4%BF%A1%E6%81%AF/</url>
    
    <content type="html"><![CDATA[<h2 id="不出现堆栈信息情况"><a href="#不出现堆栈信息情况" class="headerlink" title="不出现堆栈信息情况"></a>不出现堆栈信息情况</h2><p>1.使用问题</p><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs java">log.error(<span class="hljs-string">&quot;xxxxx&#123;&#125;&quot;</span>, e.message());<br></code></pre></td></tr></table></figure><p>应使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">log.error(<span class="hljs-string">&quot;xxxx&quot;</span>, e);<br></code></pre></td></tr></table></figure><ol start="2"><li>jvm的优化（fast throw）</li></ol><p>白话一点来说，就是：当一些异常类型（空指针、下标越界、算术运算等…）在代码里的固定位置被抛出多次，虚拟机（HotSpot VM）会直接 <strong>抛出一个事先分配好、类型匹配的异常对象</strong>。此异常对象的 <strong>message 和 stack trace 都为空</strong></p><p>就是因为某一个异常在同一个地方多次被抛出，JVM 抛出一个预分配异常，那么 <strong>message、stack trace 相当于被吞掉了</strong>。</p><p>JDK 1.5 的发布文档介绍中描述了此情况，出现这种优化方案的原因是 <strong>为了提高性能</strong>。当同一种异常在相同的位置被抛出多次，<strong>编译器就会重新编译此方法</strong>。重编译后，编译器可能会 <strong>使用不提供堆栈跟踪的预分配异常</strong> 来选择更快的策略。</p><p>可以使用 <strong>-XX:-OmitStackTraceInFastThrow</strong>关闭这种预分配异常的机制。</p><p>Fast throw 机制支持的五种异常情况：</p><p>空指针异常</p><p>算术异常</p><p>数组下标越界异常</p><p>arrayStoreException</p><p>classCastException</p><p>验证：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">10000</span>; j++) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        list.get(-<span class="hljs-number">1</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> ex.getStackTrace().length;<br>        System.out.println(String.format(<span class="hljs-string">&quot;报错异常 :: %s, 堆栈长度 :: %s&quot;</span>, ex, length));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring_cloud_eureka源码分析</title>
    <link href="/2022/06/07/spring_cloud/spring_cloud_eureka%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <url>/2022/06/07/spring_cloud/spring_cloud_eureka%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="服务端入口"><a href="#服务端入口" class="headerlink" title="服务端入口"></a>服务端入口</h2><p>从使用上来说：</p><p>需要在pom.xml中添加eureka-server的依赖。</p><p>根据spring boot的自动配置机制。</p><p>在eureka-server的jar包中spring.factories中包含org.springframework.cloud.netflix.eureka.server.EurekaServerAutoConfiguration</p><p>查看类：</p><figure class="highlight python"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@ConditionalOnBean(<span class="hljs-params">EurekaServerMarkerConfiguration.Marker.<span class="hljs-keyword">class</span></span>)</span><br></code></pre></td></tr></table></figure><p>意思是只有EurekaServerMarkerConfiguration.Marker这个实例才生效。</p><p>这就对应：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableEurekaServer</span><br></code></pre></td></tr></table></figure><p>注解里</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Import(EurekaServerMarkerConfiguration.class)</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">EurekaServerMarkerConfiguration中有实例Marker的bean<br></code></pre></td></tr></table></figure><p>这个Marker是个开关类。就是实例化后才启用eureka-server相关的配置。</p><h2 id="eureka使用架构图"><a href="#eureka使用架构图" class="headerlink" title="eureka使用架构图"></a>eureka使用架构图</h2><p><img src="/.com//eureka%E4%BD%BF%E7%94%A8%E6%9E%B6%E6%9E%84%E5%9B%BE.jpg" alt="eureka使用架构图"><img src="/.com//" alt="eureka使用架构图"></p><h2 id="客户端入口源码"><a href="#客户端入口源码" class="headerlink" title="客户端入口源码"></a>客户端入口源码</h2><p>Eureka-client的jar包中org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">RefreshableEurekaClientConfiguration类<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean(destroyMethod = &quot;shutdown&quot;)</span><br><span class="hljs-meta">@ConditionalOnMissingBean(value = EurekaClient.class,</span><br><span class="hljs-meta">search = SearchStrategy.CURRENT)</span><br><span class="hljs-meta">@org</span>.springframework.cloud.context.config.annotation.RefreshScope<br><span class="hljs-meta">@Lazy</span><br><span class="hljs-keyword">public</span> EurekaClient <span class="hljs-title function_">eurekaClient</span><span class="hljs-params">(ApplicationInfoManager manager,</span><br><span class="hljs-params">EurekaClientConfig config, EurekaInstanceConfig instance,</span><br><span class="hljs-params"><span class="hljs-meta">@Autowired(required = false)</span> HealthCheckHandler healthCheckHandler)</span> &#123;<br><span class="hljs-comment">// If we use the proxy of the ApplicationInfoManager we could run into a</span><br><span class="hljs-comment">// problem</span><br><span class="hljs-comment">// when shutdown is called on the CloudEurekaClient where the</span><br><span class="hljs-comment">// ApplicationInfoManager bean is</span><br><span class="hljs-comment">// requested but wont be allowed because we are shutting down. To avoid this</span><br><span class="hljs-comment">// we use the</span><br><span class="hljs-comment">// object directly.</span><br>ApplicationInfoManager appManager;<br><span class="hljs-keyword">if</span> (AopUtils.isAopProxy(manager)) &#123;<br>appManager = ProxyUtils.getTargetObject(manager);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>appManager = manager;<br>&#125;<br><span class="hljs-type">CloudEurekaClient</span> <span class="hljs-variable">cloudEurekaClient</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CloudEurekaClient</span>(appManager,<br>config, <span class="hljs-built_in">this</span>.optionalArgs, <span class="hljs-built_in">this</span>.context);<br>cloudEurekaClient.registerHealthCheck(healthCheckHandler);<br><span class="hljs-keyword">return</span> cloudEurekaClient;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">CloudEurekaClient</span> <span class="hljs-variable">cloudEurekaClient</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CloudEurekaClient</span>(appManager,<br>config, <span class="hljs-built_in">this</span>.optionalArgs, <span class="hljs-built_in">this</span>.context);<br><span class="hljs-built_in">super</span>(applicationInfoManager, config, args);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Inject</span><br>   DiscoveryClient(ApplicationInfoManager applicationInfoManager, EurekaClientConfig config, AbstractDiscoveryClientOptionalArgs args,<br>                   Provider&lt;BackupRegistry&gt; backupRegistryProvider, EndpointRandomizer endpointRandomizer)<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">initScheduledTasks();<br></code></pre></td></tr></table></figure><h2 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h2><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">InstanceInfoReplicator类<br></code></pre></td></tr></table></figure><p>最终调用注册接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">discoveryClient.register();<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="hljs-title function_">register</span><span class="hljs-params">(InstanceInfo info)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">urlPath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;apps/&quot;</span> + info.getAppName();<br>        <span class="hljs-type">ClientResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Builder</span> <span class="hljs-variable">resourceBuilder</span> <span class="hljs-operator">=</span> jerseyClient.resource(serviceUrl).path(urlPath).getRequestBuilder();<br>            addExtraHeaders(resourceBuilder);<br>            response = resourceBuilder<br>                    .header(<span class="hljs-string">&quot;Accept-Encoding&quot;</span>, <span class="hljs-string">&quot;gzip&quot;</span>)<br>                    .type(MediaType.APPLICATION_JSON_TYPE)<br>                    .accept(MediaType.APPLICATION_JSON)<br>                    .post(ClientResponse.class, info);<br>            <span class="hljs-keyword">return</span> anEurekaHttpResponse(response.getStatus()).headers(headersOf(response)).build();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>                logger.debug(<span class="hljs-string">&quot;Jersey HTTP POST &#123;&#125;/&#123;&#125; with instance &#123;&#125;; statusCode=&#123;&#125;&quot;</span>, serviceUrl, urlPath, info.getId(),<br>                        response == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;N/A&quot;</span> : response.getStatus());<br>            &#125;<br>            <span class="hljs-keyword">if</span> (response != <span class="hljs-literal">null</span>) &#123;<br>                response.close();<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>这时发现类里大量的使用的线程池执行。</p><p><img src="/.com//eureka-client%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg" alt="eureka-client请求流程图"></p><p>注册定时任务是有条件的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">InstanceInfoReplicator类<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        discoveryClient.refreshInstanceInfo();<br><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">dirtyTimestamp</span> <span class="hljs-operator">=</span> instanceInfo.isDirtyWithTime();<br>        <span class="hljs-keyword">if</span> (dirtyTimestamp != <span class="hljs-literal">null</span>) &#123;<br>            discoveryClient.register();<br>            instanceInfo.unsetIsDirty(dirtyTimestamp);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>        logger.warn(<span class="hljs-string">&quot;There was a problem with the instance info replicator&quot;</span>, t);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-type">Future</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> scheduler.schedule(<span class="hljs-built_in">this</span>, replicationIntervalSeconds, TimeUnit.SECONDS);<br>        scheduledPeriodicRef.set(next);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>就是只有dirtyTimestamp时间戳不等于null时才去注册。就是变成脏的了需要去注册。</p><h3 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h3><p>构建jersey server</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> javax.ws.rs.core.Application <span class="hljs-title function_">jerseyApplication</span><span class="hljs-params">(Environment environment,</span><br><span class="hljs-params">ResourceLoader resourceLoader)</span><br></code></pre></td></tr></table></figure><p>相当于加载了这个类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationsResource</span><br></code></pre></td></tr></table></figure><p>看上图可知，客户端注册调用的是applicationResource的addInstance方法</p><p>服务抽象为InstanceInfo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">registry.register(info, <span class="hljs-string">&quot;true&quot;</span>.equals(isReplication));<br></code></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">InstanceRegistry类<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(<span class="hljs-keyword">final</span> InstanceInfo info, <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> isReplication)</span> &#123;<br>handleRegistration(info, resolveInstanceLeaseDuration(info), isReplication);<br><span class="hljs-built_in">super</span>.register(info, isReplication);<br>&#125;<br></code></pre></td></tr></table></figure><p>super.register(info, isReplication);</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">AbstractInstanceRegistry类<br></code></pre></td></tr></table></figure><p>容器：内存存储的服务实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; registry<br>            = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt;();<br></code></pre></td></tr></table></figure><p>AbstractInstanceRegistry类register方法最后一行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">invalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());<br></code></pre></td></tr></table></figure><p>发现 readWriteCacheMap, 这相当于一个缓存,调用了缓存删除</p><h2 id="获取单个接口"><a href="#获取单个接口" class="headerlink" title="获取单个接口"></a>获取单个接口</h2><p>服务器端源码</p><p>同注册，可以获取到applicationResource</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Path(&quot;&#123;appId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> ApplicationResource <span class="hljs-title function_">getApplicationResource</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-meta">@PathParam(&quot;version&quot;)</span> String version,</span><br><span class="hljs-params">        <span class="hljs-meta">@PathParam(&quot;appId&quot;)</span> String appId)</span> &#123;<br>    CurrentRequestVersion.set(Version.toEnum(version));<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationResource</span>(appId, serverConfig, registry);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        CurrentRequestVersion.remove();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">applicationResource.getApplication()<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">ResponseCacheImpl类<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Key key)</span> &#123;<br>        <span class="hljs-keyword">return</span> get(key, shouldUseReadOnlyResponseCache);<br>    &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">String <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Key key, <span class="hljs-type">boolean</span> useReadOnlyCache)</span> &#123;<br>    <span class="hljs-type">Value</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> getValue(key, useReadOnlyCache);<br>    <span class="hljs-keyword">if</span> (payload == <span class="hljs-literal">null</span> || payload.getPayload().equals(EMPTY_PAYLOAD)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> payload.getPayload();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java">Value <span class="hljs-title function_">getValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Key key, <span class="hljs-type">boolean</span> useReadOnlyCache)</span> &#123;<br>    <span class="hljs-type">Value</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (useReadOnlyCache) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">Value</span> <span class="hljs-variable">currentPayload</span> <span class="hljs-operator">=</span> readOnlyCacheMap.get(key);<br>            <span class="hljs-keyword">if</span> (currentPayload != <span class="hljs-literal">null</span>) &#123;<br>                payload = currentPayload;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                payload = readWriteCacheMap.get(key);<br>                readOnlyCacheMap.put(key, payload);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            payload = readWriteCacheMap.get(key);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>        logger.error(<span class="hljs-string">&quot;Cannot get value for key : &#123;&#125;&quot;</span>, key, t);<br>    &#125;<br>    <span class="hljs-keyword">return</span> payload;<br>&#125;<br></code></pre></td></tr></table></figure><p>发现是去从缓存中取。readOnlyCacheMap 和  readWriteCacheMap。</p><h3 id="readWriteCacheMap"><a href="#readWriteCacheMap" class="headerlink" title="readWriteCacheMap"></a>readWriteCacheMap</h3><p>初始化：在new ResponseCacheImpl时进行初始化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-built_in">this</span>.readWriteCacheMap =<br>                CacheBuilder.newBuilder().initialCapacity(serverConfig.getInitialCapacityOfResponseCache())<br>                        .expireAfterWrite(serverConfig.getResponseCacheAutoExpirationInSeconds(), TimeUnit.SECONDS)<br>                        .removalListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RemovalListener</span>&lt;Key, Value&gt;() &#123;<br>                            <span class="hljs-meta">@Override</span><br>                            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onRemoval</span><span class="hljs-params">(RemovalNotification&lt;Key, Value&gt; notification)</span> &#123;<br>                                <span class="hljs-type">Key</span> <span class="hljs-variable">removedKey</span> <span class="hljs-operator">=</span> notification.getKey();<br>                                <span class="hljs-keyword">if</span> (removedKey.hasRegions()) &#123;<br>                                    <span class="hljs-type">Key</span> <span class="hljs-variable">cloneWithNoRegions</span> <span class="hljs-operator">=</span> removedKey.cloneWithoutRegions();<br>                                    regionSpecificKeys.remove(cloneWithNoRegions, removedKey);<br>                                &#125;<br>                            &#125;<br>                        &#125;)<br>                        .build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;Key, Value&gt;() &#123;<br>                            <span class="hljs-meta">@Override</span><br>                            <span class="hljs-keyword">public</span> Value <span class="hljs-title function_">load</span><span class="hljs-params">(Key key)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                                <span class="hljs-keyword">if</span> (key.hasRegions()) &#123;<br>                                    <span class="hljs-type">Key</span> <span class="hljs-variable">cloneWithNoRegions</span> <span class="hljs-operator">=</span> key.cloneWithoutRegions();<br>                                    regionSpecificKeys.put(cloneWithNoRegions, key);<br>                                &#125;<br>                                <span class="hljs-type">Value</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> generatePayload(key);<br>                                <span class="hljs-keyword">return</span> value;<br>                            &#125;<br>                        &#125;);<br></code></pre></td></tr></table></figure><p>初始化容量：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">CacheBuilder.newBuilder().initialCapacity(serverConfig.getInitialCapacityOfResponseCache())<br></code></pre></td></tr></table></figure><p>过期：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">.expireAfterWrite(serverConfig.getResponseCacheAutoExpirationInSeconds(), TimeUnit.SECONDS)<br></code></pre></td></tr></table></figure><p>删除监听器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">.removalListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RemovalListener</span>&lt;Key, Value&gt;() &#123;<br>                            <span class="hljs-meta">@Override</span><br>                            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onRemoval</span><span class="hljs-params">(RemovalNotification&lt;Key, Value&gt; notification)</span> &#123;<br>                                <span class="hljs-type">Key</span> <span class="hljs-variable">removedKey</span> <span class="hljs-operator">=</span> notification.getKey();<br>                                <span class="hljs-keyword">if</span> (removedKey.hasRegions()) &#123;<br>                                    <span class="hljs-type">Key</span> <span class="hljs-variable">cloneWithNoRegions</span> <span class="hljs-operator">=</span> removedKey.cloneWithoutRegions();<br>                                    regionSpecificKeys.remove(cloneWithNoRegions, removedKey);<br>                                &#125;<br>                            &#125;<br>                        &#125;)<br></code></pre></td></tr></table></figure><p>加载：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">.build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;Key, Value&gt;() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Value <span class="hljs-title function_">load</span><span class="hljs-params">(Key key)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (key.hasRegions()) &#123;<br>            <span class="hljs-type">Key</span> <span class="hljs-variable">cloneWithNoRegions</span> <span class="hljs-operator">=</span> key.cloneWithoutRegions();<br>            regionSpecificKeys.put(cloneWithNoRegions, key);<br>        &#125;<br>        <span class="hljs-type">Value</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> generatePayload(key);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Value</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> generatePayload(key);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">payload = getPayLoad(key, registry.getApplication(key.getName()));<br></code></pre></td></tr></table></figure><p>发现如果readWriteCacheMap没有会去 </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; registry<br>            = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt;();<br></code></pre></td></tr></table></figure><p>里取。</p><h3 id="readOnlyCacheMap"><a href="#readOnlyCacheMap" class="headerlink" title="readOnlyCacheMap"></a>readOnlyCacheMap</h3><p>选中readOnlyCacheMap，查找用法。发现readOnlyCacheMap是在ResponseCacheImpl实例化的成员变量初始化的。</p><p>同样查找用法，发现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> TimerTask <span class="hljs-title function_">getCacheUpdateTask</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimerTask</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                logger.debug(<span class="hljs-string">&quot;Updating the client cache from response cache&quot;</span>);<br>                <span class="hljs-keyword">for</span> (Key key : readOnlyCacheMap.keySet()) &#123;<br>                    <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>                        logger.debug(<span class="hljs-string">&quot;Updating the client cache from response cache for key : &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;&quot;</span>,<br>                                key.getEntityType(), key.getName(), key.getVersion(), key.getType());<br>                    &#125;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        CurrentRequestVersion.set(key.getVersion());<br>                        <span class="hljs-type">Value</span> <span class="hljs-variable">cacheValue</span> <span class="hljs-operator">=</span> readWriteCacheMap.get(key);<br>                        <span class="hljs-type">Value</span> <span class="hljs-variable">currentCacheValue</span> <span class="hljs-operator">=</span> readOnlyCacheMap.get(key);<br>                        <span class="hljs-keyword">if</span> (cacheValue != currentCacheValue) &#123;<br>                            readOnlyCacheMap.put(key, cacheValue);<br>                        &#125;<br>                    &#125; <span class="hljs-keyword">catch</span> (Throwable th) &#123;<br>                        logger.error(<span class="hljs-string">&quot;Error while updating the client cache from response cache for key &#123;&#125;&quot;</span>, key.toStringCompact(), th);<br>                    &#125; <span class="hljs-keyword">finally</span> &#123;<br>                        CurrentRequestVersion.remove();<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;;<br>    &#125;<br></code></pre></td></tr></table></figure><p>上面的定时任务也是new ResponseCacheImpl时初始化的定时任务。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (shouldUseReadOnlyResponseCache) &#123;<br>    timer.schedule(getCacheUpdateTask(),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(((System.currentTimeMillis() / responseCacheUpdateIntervalMs) * responseCacheUpdateIntervalMs)<br>                    + responseCacheUpdateIntervalMs),<br>            responseCacheUpdateIntervalMs);<br>&#125;<br></code></pre></td></tr></table></figure><p>间隔responseCacheUpdateIntervalMs时间从readWriteCacheMap同步一次。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><img src="/.com//eureka%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98.png" alt="eureka服务端三级缓存"></p><p>一级缓存是实时变化的，多个服务的多个实例向eureka-server发送。有并发等问题。</p><p>二级缓存是对一级缓存的冷热key缓存，而且提供了缓存失效的方法。当注册表或者增量列表发生变化时，就会缓存失效。</p><p>三级缓存是对读写缓存的缓存。它主要解决读写缓存频繁失效而导致拉取注册表和增量注册表时，请求直击eureka server 本地缓存注册表的情况。</p><p>因为eureka server本地注册表是一个频繁读写的ConcurrentHashMap，为了减轻它的压力，才引入了读写缓存。</p><p>而读写缓存为了保持和eureka server本地缓存的一次性，在修改本地缓存的同时会让读写缓存失效。</p><p>只读缓存的存在目的：</p><p>1.针对短期重启行为和短期网络波动行为进行一个客户端注册表保护。</p><p>2.在二级缓存被删除时，继续给eureka-client提供服务，不然直接使用二级缓存，会出现client获取无可用服务。</p><h2 id="获取注册表接口"><a href="#获取注册表接口" class="headerlink" title="获取注册表接口"></a>获取注册表接口</h2><h3 id="客户端源码"><a href="#客户端源码" class="headerlink" title="客户端源码"></a>客户端源码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">cacheRefreshTask = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimedSupervisorTask</span>(<br>        <span class="hljs-string">&quot;cacheRefresh&quot;</span>,<br>        scheduler,<br>        cacheRefreshExecutor,<br>        registryFetchIntervalSeconds,<br>        TimeUnit.SECONDS,<br>        expBackOffBound,<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheRefreshThread</span>()<br>);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheRefreshThread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        refreshRegistry();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> fetchRegistry(remoteRegionsModified);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">getAndStoreFullRegistry();<br>或者<br>getAndUpdateDelta(applications);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> EurekaHttpResponse&lt;Applications&gt; <span class="hljs-title function_">getApplications</span><span class="hljs-params">(String... regions)</span> &#123;<br>    <span class="hljs-keyword">return</span> getApplicationsInternal(<span class="hljs-string">&quot;apps/&quot;</span>, regions);<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> EurekaHttpResponse&lt;Applications&gt; <span class="hljs-title function_">getDelta</span><span class="hljs-params">(String... regions)</span> &#123;<br>    <span class="hljs-keyword">return</span> getApplicationsInternal(<span class="hljs-string">&quot;apps/delta&quot;</span>, regions);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="服务器端-1"><a href="#服务器端-1" class="headerlink" title="服务器端"></a>服务器端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">ApplicationsResource类<br></code></pre></td></tr></table></figure><p>获取全部：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GET</span><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">getContainers</span><span class="hljs-params">(<span class="hljs-meta">@PathParam(&quot;version&quot;)</span> String version,</span><br><span class="hljs-params">                                  <span class="hljs-meta">@HeaderParam(HEADER_ACCEPT)</span> String acceptHeader,</span><br><span class="hljs-params">                                  <span class="hljs-meta">@HeaderParam(HEADER_ACCEPT_ENCODING)</span> String acceptEncoding,</span><br><span class="hljs-params">                                  <span class="hljs-meta">@HeaderParam(EurekaAccept.HTTP_X_EUREKA_ACCEPT)</span> String eurekaAccept,</span><br><span class="hljs-params">                                  <span class="hljs-meta">@Context</span> UriInfo uriInfo,</span><br><span class="hljs-params">                                  <span class="hljs-meta">@Nullable</span> <span class="hljs-meta">@QueryParam(&quot;regions&quot;)</span> String regionsStr)</span> &#123;<br><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isRemoteRegionRequested</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span> != regionsStr &amp;&amp; !regionsStr.isEmpty();<br>        String[] regions = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (!isRemoteRegionRequested) &#123;<br>            EurekaMonitors.GET_ALL.increment();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            regions = regionsStr.toLowerCase().split(<span class="hljs-string">&quot;,&quot;</span>);<br>            Arrays.sort(regions); <span class="hljs-comment">// So we don&#x27;t have different caches for same regions queried in different order.</span><br>            EurekaMonitors.GET_ALL_WITH_REMOTE_REGIONS.increment();<br>        &#125;<br><br>        <span class="hljs-comment">// Check if the server allows the access to the registry. The server can</span><br>        <span class="hljs-comment">// restrict access if it is not</span><br>        <span class="hljs-comment">// ready to serve traffic depending on various reasons.</span><br>        <span class="hljs-keyword">if</span> (!registry.shouldAllowAccess(isRemoteRegionRequested)) &#123;<br>            <span class="hljs-keyword">return</span> Response.status(Status.FORBIDDEN).build();<br>        &#125;<br>        CurrentRequestVersion.set(Version.toEnum(version));<br>        <span class="hljs-type">KeyType</span> <span class="hljs-variable">keyType</span> <span class="hljs-operator">=</span> Key.KeyType.JSON;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">returnMediaType</span> <span class="hljs-operator">=</span> MediaType.APPLICATION_JSON;<br>        <span class="hljs-keyword">if</span> (acceptHeader == <span class="hljs-literal">null</span> || !acceptHeader.contains(HEADER_JSON_VALUE)) &#123;<br>            keyType = Key.KeyType.XML;<br>            returnMediaType = MediaType.APPLICATION_XML;<br>        &#125;<br><br>        <span class="hljs-type">Key</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Key</span>(Key.EntityType.Application,<br>                ResponseCacheImpl.ALL_APPS,<br>                keyType, CurrentRequestVersion.get(), EurekaAccept.fromString(eurekaAccept), regions<br>        );<br><br>        Response response;<br>        <span class="hljs-keyword">if</span> (acceptEncoding != <span class="hljs-literal">null</span> &amp;&amp; acceptEncoding.contains(HEADER_GZIP_VALUE)) &#123;<br>            response = Response.ok(responseCache.getGZIP(cacheKey))<br>                    .header(HEADER_CONTENT_ENCODING, HEADER_GZIP_VALUE)<br>                    .header(HEADER_CONTENT_TYPE, returnMediaType)<br>                    .build();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            response = Response.ok(responseCache.get(cacheKey))<br>                    .build();<br>        &#125;<br>        CurrentRequestVersion.remove();<br>        <span class="hljs-keyword">return</span> response;<br>    &#125;<br></code></pre></td></tr></table></figure><p>增量获取</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Path(&quot;delta&quot;)</span><br>    <span class="hljs-meta">@GET</span><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">getContainerDifferential</span><span class="hljs-params">(</span><br><span class="hljs-params">            <span class="hljs-meta">@PathParam(&quot;version&quot;)</span> String version,</span><br><span class="hljs-params">            <span class="hljs-meta">@HeaderParam(HEADER_ACCEPT)</span> String acceptHeader,</span><br><span class="hljs-params">            <span class="hljs-meta">@HeaderParam(HEADER_ACCEPT_ENCODING)</span> String acceptEncoding,</span><br><span class="hljs-params">            <span class="hljs-meta">@HeaderParam(EurekaAccept.HTTP_X_EUREKA_ACCEPT)</span> String eurekaAccept,</span><br><span class="hljs-params">            <span class="hljs-meta">@Context</span> UriInfo uriInfo, <span class="hljs-meta">@Nullable</span> <span class="hljs-meta">@QueryParam(&quot;regions&quot;)</span> String regionsStr)</span> &#123;<br><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isRemoteRegionRequested</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span> != regionsStr &amp;&amp; !regionsStr.isEmpty();<br><br>        <span class="hljs-comment">// If the delta flag is disabled in discovery or if the lease expiration</span><br>        <span class="hljs-comment">// has been disabled, redirect clients to get all instances</span><br>        <span class="hljs-keyword">if</span> ((serverConfig.shouldDisableDelta()) || (!registry.shouldAllowAccess(isRemoteRegionRequested))) &#123;<br>            <span class="hljs-keyword">return</span> Response.status(Status.FORBIDDEN).build();<br>        &#125;<br><br>        String[] regions = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (!isRemoteRegionRequested) &#123;<br>            EurekaMonitors.GET_ALL_DELTA.increment();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            regions = regionsStr.toLowerCase().split(<span class="hljs-string">&quot;,&quot;</span>);<br>            Arrays.sort(regions); <span class="hljs-comment">// So we don&#x27;t have different caches for same regions queried in different order.</span><br>            EurekaMonitors.GET_ALL_DELTA_WITH_REMOTE_REGIONS.increment();<br>        &#125;<br><br>        CurrentRequestVersion.set(Version.toEnum(version));<br>        <span class="hljs-type">KeyType</span> <span class="hljs-variable">keyType</span> <span class="hljs-operator">=</span> Key.KeyType.JSON;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">returnMediaType</span> <span class="hljs-operator">=</span> MediaType.APPLICATION_JSON;<br>        <span class="hljs-keyword">if</span> (acceptHeader == <span class="hljs-literal">null</span> || !acceptHeader.contains(HEADER_JSON_VALUE)) &#123;<br>            keyType = Key.KeyType.XML;<br>            returnMediaType = MediaType.APPLICATION_XML;<br>        &#125;<br><br>        <span class="hljs-type">Key</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Key</span>(Key.EntityType.Application,<br>                ResponseCacheImpl.ALL_APPS_DELTA,<br>                keyType, CurrentRequestVersion.get(), EurekaAccept.fromString(eurekaAccept), regions<br>        );<br><br>        <span class="hljs-keyword">final</span> Response response;<br><br>        <span class="hljs-keyword">if</span> (acceptEncoding != <span class="hljs-literal">null</span> &amp;&amp; acceptEncoding.contains(HEADER_GZIP_VALUE)) &#123;<br>             response = Response.ok(responseCache.getGZIP(cacheKey))<br>                    .header(HEADER_CONTENT_ENCODING, HEADER_GZIP_VALUE)<br>                    .header(HEADER_CONTENT_TYPE, returnMediaType)<br>                    .build();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            response = Response.ok(responseCache.get(cacheKey)).build();<br>        &#125;<br><br>        CurrentRequestVersion.remove();<br>        <span class="hljs-keyword">return</span> response;<br>    &#125;<br></code></pre></td></tr></table></figure><h2 id="心跳"><a href="#心跳" class="headerlink" title="心跳"></a>心跳</h2><p>心跳的客户端代码与注册类似，这里就不再看了。他们也是在一起的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-title function_">renew</span><span class="hljs-params">()</span> &#123;<br>    EurekaHttpResponse&lt;InstanceInfo&gt; httpResponse;<br>    <span class="hljs-keyword">try</span> &#123;<br>        httpResponse = eurekaTransport.registrationClient.sendHeartBeat(instanceInfo.getAppName(), instanceInfo.getId(), instanceInfo, <span class="hljs-literal">null</span>);<br>        logger.debug(PREFIX + <span class="hljs-string">&quot;&#123;&#125; - Heartbeat status: &#123;&#125;&quot;</span>, appPathIdentifier, httpResponse.getStatusCode());<br>        <span class="hljs-keyword">if</span> (httpResponse.getStatusCode() == Status.NOT_FOUND.getStatusCode()) &#123;<br>            REREGISTER_COUNTER.increment();<br>            logger.info(PREFIX + <span class="hljs-string">&quot;&#123;&#125; - Re-registering apps/&#123;&#125;&quot;</span>, appPathIdentifier, instanceInfo.getAppName());<br>            <span class="hljs-type">long</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> instanceInfo.setIsDirtyWithTime();<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> register();<br>            <span class="hljs-keyword">if</span> (success) &#123;<br>                instanceInfo.unsetIsDirty(timestamp);<br>            &#125;<br>            <span class="hljs-keyword">return</span> success;<br>        &#125;<br>        <span class="hljs-keyword">return</span> httpResponse.getStatusCode() == Status.OK.getStatusCode();<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>        logger.error(PREFIX + <span class="hljs-string">&quot;&#123;&#125; - was unable to send heartbeat!&quot;</span>, appPathIdentifier, e);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>服务器端：</p><p><img src="/.com//eureka-server%E5%BF%83%E8%B7%B3%E6%8E%A5%E6%94%B6%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg" alt="eureka-server心跳接收流程图"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">InstanceResource类renewLease方法<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> registry.renew(app.getName(), id, isFromReplicaNode);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">InstanceRegistry类renew方法<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.renew(appName, serverId, isReplication);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">PeerAwareInstanceRegistryImpl类renew方法<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">renew</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String appName, <span class="hljs-keyword">final</span> String id, <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> isReplication)</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">super</span>.renew(appName, id, isReplication)) &#123;<br>        replicateToPeers(Action.Heartbeat, appName, id, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, isReplication);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">renew</span><span class="hljs-params">(String appName, String id, <span class="hljs-type">boolean</span> isReplication)</span> &#123;<br>        RENEW.increment(isReplication);<br>        Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(appName);<br>        Lease&lt;InstanceInfo&gt; leaseToRenew = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (gMap != <span class="hljs-literal">null</span>) &#123;<br>            leaseToRenew = gMap.get(id);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (leaseToRenew == <span class="hljs-literal">null</span>) &#123;<br>            RENEW_NOT_FOUND.increment(isReplication);<br>            logger.warn(<span class="hljs-string">&quot;DS: Registry: lease doesn&#x27;t exist, registering resource: &#123;&#125; - &#123;&#125;&quot;</span>, appName, id);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">InstanceInfo</span> <span class="hljs-variable">instanceInfo</span> <span class="hljs-operator">=</span> leaseToRenew.getHolder();<br>            <span class="hljs-keyword">if</span> (instanceInfo != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// touchASGCache(instanceInfo.getASGName());</span><br>                <span class="hljs-type">InstanceStatus</span> <span class="hljs-variable">overriddenInstanceStatus</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getOverriddenInstanceStatus(<br>                        instanceInfo, leaseToRenew, isReplication);<br>                <span class="hljs-keyword">if</span> (overriddenInstanceStatus == InstanceStatus.UNKNOWN) &#123;<br>                    logger.info(<span class="hljs-string">&quot;Instance status UNKNOWN possibly due to deleted override for instance &#123;&#125;&quot;</span><br>                            + <span class="hljs-string">&quot;; re-register required&quot;</span>, instanceInfo.getId());<br>                    RENEW_NOT_FOUND.increment(isReplication);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (!instanceInfo.getStatus().equals(overriddenInstanceStatus)) &#123;<br>                    logger.info(<br>                            <span class="hljs-string">&quot;The instance status &#123;&#125; is different from overridden instance status &#123;&#125; for instance &#123;&#125;. &quot;</span><br>                                    + <span class="hljs-string">&quot;Hence setting the status to overridden status&quot;</span>, instanceInfo.getStatus().name(),<br>                                    overriddenInstanceStatus.name(),<br>                                    instanceInfo.getId());<br>                    instanceInfo.setStatusWithoutDirty(overriddenInstanceStatus);<br><br>                &#125;<br>            &#125;<br>            renewsLastMin.increment();<br>            leaseToRenew.renew();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 最后一分钟续约次数            </span><br>renewsLastMin.increment();<br><span class="hljs-comment">// 租约增加</span><br>            leaseToRenew.renew();<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 同步至其他server的方法</span><br>replicateToPeers(Action.Heartbeat, appName, id, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, isReplication);<br></code></pre></td></tr></table></figure><h2 id="下线"><a href="#下线" class="headerlink" title="下线"></a>下线</h2><p>客户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">DiscoveryClient类shutdown方法是在实例销毁前执行的方法<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">unregister();<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">EurekaHttpResponse&lt;Void&gt; httpResponse = eurekaTransport.registrationClient.cancel(instanceInfo.getAppName(), instanceInfo.getId());<br></code></pre></td></tr></table></figure><p>服务器端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">InstanceResource类<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DELETE</span><br><span class="hljs-keyword">public</span> Response <span class="hljs-title function_">cancelLease</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-meta">@HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> registry.cancel(app.getName(), id,<br>            <span class="hljs-string">&quot;true&quot;</span>.equals(isReplication));<br><br>        <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>            logger.debug(<span class="hljs-string">&quot;Found (Cancel): &#123;&#125; - &#123;&#125;&quot;</span>, app.getName(), id);<br>            <span class="hljs-keyword">return</span> Response.ok().build();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            logger.info(<span class="hljs-string">&quot;Not Found (Cancel): &#123;&#125; - &#123;&#125;&quot;</span>, app.getName(), id);<br>            <span class="hljs-keyword">return</span> Response.status(Status.NOT_FOUND).build();<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>        logger.error(<span class="hljs-string">&quot;Error (cancel): &#123;&#125; - &#123;&#125;&quot;</span>, app.getName(), id, e);<br>        <span class="hljs-keyword">return</span> Response.serverError().build();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">internalCancel</span><span class="hljs-params">(String appName, String id, <span class="hljs-type">boolean</span> isReplication)</span> &#123;<br>        read.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            CANCEL.increment(isReplication);<br>            Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(appName);<br>            Lease&lt;InstanceInfo&gt; leaseToCancel = <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">if</span> (gMap != <span class="hljs-literal">null</span>) &#123;<br>                leaseToCancel = gMap.remove(id);<br>            &#125;<br>            recentCanceledQueue.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Pair</span>&lt;Long, String&gt;(System.currentTimeMillis(), appName + <span class="hljs-string">&quot;(&quot;</span> + id + <span class="hljs-string">&quot;)&quot;</span>));<br>            <span class="hljs-type">InstanceStatus</span> <span class="hljs-variable">instanceStatus</span> <span class="hljs-operator">=</span> overriddenInstanceStatusMap.remove(id);<br>            <span class="hljs-keyword">if</span> (instanceStatus != <span class="hljs-literal">null</span>) &#123;<br>                logger.debug(<span class="hljs-string">&quot;Removed instance id &#123;&#125; from the overridden map which has value &#123;&#125;&quot;</span>, id, instanceStatus.name());<br>            &#125;<br>            <span class="hljs-keyword">if</span> (leaseToCancel == <span class="hljs-literal">null</span>) &#123;<br>                CANCEL_NOT_FOUND.increment(isReplication);<br>                logger.warn(<span class="hljs-string">&quot;DS: Registry: cancel failed because Lease is not registered for: &#123;&#125;/&#123;&#125;&quot;</span>, appName, id);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                leaseToCancel.cancel();<br>                <span class="hljs-type">InstanceInfo</span> <span class="hljs-variable">instanceInfo</span> <span class="hljs-operator">=</span> leaseToCancel.getHolder();<br>                <span class="hljs-type">String</span> <span class="hljs-variable">vip</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">svip</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">if</span> (instanceInfo != <span class="hljs-literal">null</span>) &#123;<br>                    instanceInfo.setActionType(ActionType.DELETED);<br>                    recentlyChangedQueue.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RecentlyChangedItem</span>(leaseToCancel));<br>                    instanceInfo.setLastUpdatedTimestamp();<br>                    vip = instanceInfo.getVIPAddress();<br>                    svip = instanceInfo.getSecureVipAddress();<br>                &#125;<br>                invalidateCache(appName, vip, svip);<br>                logger.info(<span class="hljs-string">&quot;Cancelled instance &#123;&#125;/&#123;&#125; (replication=&#123;&#125;)&quot;</span>, appName, id, isReplication);<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            read.unlock();<br>        &#125;<br><br>        <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.expectedNumberOfClientsSendingRenews &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// Since the client wants to cancel it, reduce the number of clients to send renews.</span><br>                <span class="hljs-built_in">this</span>.expectedNumberOfClientsSendingRenews = <span class="hljs-built_in">this</span>.expectedNumberOfClientsSendingRenews - <span class="hljs-number">1</span>;<br>                updateRenewsPerMinThreshold();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><h2 id="客户端如何选择server"><a href="#客户端如何选择server" class="headerlink" title="客户端如何选择server"></a>客户端如何选择server</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">RetryableEurekaHttpClient类<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//重试次数 也是 eureka-server的个数</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DEFAULT_NUMBER_OF_RETRIES</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> &lt;R&gt; EurekaHttpResponse&lt;R&gt; <span class="hljs-title function_">execute</span><span class="hljs-params">(RequestExecutor&lt;R&gt; requestExecutor)</span> &#123;<br>        List&lt;EurekaEndpoint&gt; candidateHosts = <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">endpointIdx</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">retry</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; retry &lt; numberOfRetries; retry++) &#123;<br>            <span class="hljs-type">EurekaHttpClient</span> <span class="hljs-variable">currentHttpClient</span> <span class="hljs-operator">=</span> delegate.get();<br>            <span class="hljs-type">EurekaEndpoint</span> <span class="hljs-variable">currentEndpoint</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">if</span> (currentHttpClient == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (candidateHosts == <span class="hljs-literal">null</span>) &#123;<br>                    candidateHosts = getHostCandidates();<br>                    <span class="hljs-keyword">if</span> (candidateHosts.isEmpty()) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransportException</span>(<span class="hljs-string">&quot;There is no known eureka server; cluster server list is empty&quot;</span>);<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (endpointIdx &gt;= candidateHosts.size()) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransportException</span>(<span class="hljs-string">&quot;Cannot execute request on any known server&quot;</span>);<br>                &#125;<br><br>                currentEndpoint = candidateHosts.get(endpointIdx++);<br>                currentHttpClient = clientFactory.newClient(currentEndpoint);<br>            &#125;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                EurekaHttpResponse&lt;R&gt; response = requestExecutor.execute(currentHttpClient);<br>                <span class="hljs-keyword">if</span> (serverStatusEvaluator.accept(response.getStatusCode(), requestExecutor.getRequestType())) &#123;<br>                    delegate.set(currentHttpClient);<br>                    <span class="hljs-keyword">if</span> (retry &gt; <span class="hljs-number">0</span>) &#123;<br>                        logger.info(<span class="hljs-string">&quot;Request execution succeeded on retry #&#123;&#125;&quot;</span>, retry);<br>                    &#125;<br>                    <span class="hljs-keyword">return</span> response;<br>                &#125;<br>                logger.warn(<span class="hljs-string">&quot;Request execution failure with status code &#123;&#125;; retrying on another server if available&quot;</span>, response.getStatusCode());<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                logger.warn(<span class="hljs-string">&quot;Request execution failed with message: &#123;&#125;&quot;</span>, e.getMessage());  <span class="hljs-comment">// just log message as the underlying client should log the stacktrace</span><br>            &#125;<br><br>            <span class="hljs-comment">// Connection error or 5xx from the server that must be retried on another server</span><br>            delegate.compareAndSet(currentHttpClient, <span class="hljs-literal">null</span>);<br>            <span class="hljs-keyword">if</span> (currentEndpoint != <span class="hljs-literal">null</span>) &#123;<br>                quarantineSet.add(currentEndpoint);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransportException</span>(<span class="hljs-string">&quot;Retry limit reached; giving up on completing the request&quot;</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><p>发现，这个方法是根据重试次数来获取server的地址的。从0开始到3，所以说eureka-server默认是3，如果第一个已经成功了直接return了。</p><h2 id="自我保护"><a href="#自我保护" class="headerlink" title="自我保护"></a>自我保护</h2><h3 id="什么是自我保护机制"><a href="#什么是自我保护机制" class="headerlink" title="什么是自我保护机制"></a>什么是自我保护机制</h3><p>当Eureka Server节点在短时间内丢失过多客户端时（可能发生了网络分区故障，服务实例与Eureka Server之间无法正常通信），那么这个server节点就会进入自我保护模式（eureka.server.enable-self-preservation&#x3D;true，默认开启自我保护模式）。一旦进入该模式，Eureka Server就会保护服务注册表中的信息，不再删除服务注册表中的数据（也就是不会注销任何微服务）。当网络故障恢复后，该Eureka Server节点会自动退出自我保护模式</p><h3 id="开启条件"><a href="#开启条件" class="headerlink" title="开启条件"></a>开启条件</h3><p><strong>Renews threshold</strong>：Eureka Server期望每分钟收到客户端实例续约的阈值</p><p>**Renews (last min)**：Eureka Server最后1分钟收到客户端实例续约的总数</p><p>自我保护模式开启的条件是：<strong>1分钟后，若Renews (last min) &lt; Renews threshold，那么开启自我保护机制</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">AbstractInstanceRegistry类<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateRenewsPerMinThreshold</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">this</span>.numberOfRenewsPerMinThreshold = (<span class="hljs-type">int</span>) (<span class="hljs-built_in">this</span>.expectedNumberOfClientsSendingRenews<br>            * (<span class="hljs-number">60.0</span> / serverConfig.getExpectedClientRenewalIntervalSeconds())<br>            * serverConfig.getRenewalPercentThreshold());<br>&#125;<br></code></pre></td></tr></table></figure><p>numberOfRenewsPerMinThreshold就是Dashboard中的Renews threshold<br>expectedNumberOfClientsSendingRenews期望收到客户端续约的总数（实际为服务实例的总数）<br>getExpectedClientRenewalIntervalSeconds()获取客户端续约间隔（秒为单位）的方法，（默认30s）<br>getRenewalPercentThreshold()获取自我保护续约百分比阈值因子（默认85%）</p><p>那么：</p><p>Renews threshold &#x3D; 服务实例总数 * (60 &#x2F; 续约间隔) * 自我保护续约百分比阈值因子</p><p>Renews (last min) &#x3D; 服务实例总数 * (60 &#x2F; 续约间隔)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">PeerAwareInstanceRegistryImpl类<br></code></pre></td></tr></table></figure><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isLeaseExpirationEnabled</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isSelfPreservationModeEnabled</span>()) &#123;<br>        <span class="hljs-comment">// The self preservation mode is disabled, hence allowing the instances to expire.</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> numberOfRenewsPerMinThreshold &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-title function_">getNumOfRenewsInLastMin</span>() &gt; numberOfRenewsPerMinThreshold;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>isLeaseExpirationEnabled()</code>是Eureka Server失效剔除时调用，判断是否需要清理。如果自我保护模式没开启，那就可以清理。<strong>如果自我保护模式开启了，且当续约阈值 &gt; 0，上一分钟的续约数 &gt; 阈值，那么可以清理；当上一分钟续约数 &lt; 阈值，那么就不清理</strong></p><h3 id="Renews-threshold重置"><a href="#Renews-threshold重置" class="headerlink" title="Renews threshold重置"></a>Renews threshold重置</h3><p>应用注册时重置、应用下线时重置：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">PeerAwareInstanceRegistryImpl.updateRenewsPerMinThreshold();<br></code></pre></td></tr></table></figure><p>定时任务重置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">PeerAwareInstanceRegistryImpl.scheduleRenewalThresholdUpdateTask();<br></code></pre></td></tr></table></figure><h2 id="应用实例失效剔除"><a href="#应用实例失效剔除" class="headerlink" title="应用实例失效剔除"></a>应用实例失效剔除</h2><p>spring 的生命周期管理</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">EurekaServerInitializerConfiguration类实现了SmartLifecycle<br></code></pre></td></tr></table></figure><p>spring 会在启动后调用start()方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">eurekaServerBootstrap.contextInitialized(<br>EurekaServerInitializerConfiguration.<span class="hljs-built_in">this</span>.servletContext);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-built_in">this</span>.registry.openForTraffic(<span class="hljs-built_in">this</span>.applicationInfoManager, registryCount);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-built_in">super</span>.openForTraffic(applicationInfoManager,<br>count == <span class="hljs-number">0</span> ? <span class="hljs-built_in">this</span>.defaultOpenForTrafficCount : count);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-built_in">super</span>.postInit();<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">evictionTaskRef.set(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EvictionTask</span>());<br></code></pre></td></tr></table></figure><p>这里发现EvictionTask类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EvictionTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TimerTask</span> &#123;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">lastExecutionNanosRef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0l</span>);<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">compensationTimeMs</span> <span class="hljs-operator">=</span> getCompensationTimeMs();<br>                logger.info(<span class="hljs-string">&quot;Running the evict task with compensationTime &#123;&#125;ms&quot;</span>, compensationTimeMs);<br>                evict(compensationTimeMs);<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>                logger.error(<span class="hljs-string">&quot;Could not run the evict task&quot;</span>, e);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * compute a compensation time defined as the actual time this task was executed since the prev iteration,</span><br><span class="hljs-comment">         * vs the configured amount of time for execution. This is useful for cases where changes in time (due to</span><br><span class="hljs-comment">         * clock skew or gc for example) causes the actual eviction task to execute later than the desired time</span><br><span class="hljs-comment">         * according to the configured cycle.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">long</span> <span class="hljs-title function_">getCompensationTimeMs</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">currNanos</span> <span class="hljs-operator">=</span> getCurrentTimeNano();<br>            <span class="hljs-type">long</span> <span class="hljs-variable">lastNanos</span> <span class="hljs-operator">=</span> lastExecutionNanosRef.getAndSet(currNanos);<br>            <span class="hljs-keyword">if</span> (lastNanos == <span class="hljs-number">0l</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">0l</span>;<br>            &#125;<br><br>            <span class="hljs-type">long</span> <span class="hljs-variable">elapsedMs</span> <span class="hljs-operator">=</span> TimeUnit.NANOSECONDS.toMillis(currNanos - lastNanos);<br>            <span class="hljs-type">long</span> <span class="hljs-variable">compensationTime</span> <span class="hljs-operator">=</span> elapsedMs - serverConfig.getEvictionIntervalTimerInMs();<br>            <span class="hljs-keyword">return</span> compensationTime &lt;= <span class="hljs-number">0l</span> ? <span class="hljs-number">0l</span> : compensationTime;<br>        &#125;<br><br>        <span class="hljs-type">long</span> <span class="hljs-title function_">getCurrentTimeNano</span><span class="hljs-params">()</span> &#123;  <span class="hljs-comment">// for testing</span><br>            <span class="hljs-keyword">return</span> System.nanoTime();<br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">evict</span><span class="hljs-params">(<span class="hljs-type">long</span> additionalLeaseMs)</span> &#123;<br>        logger.debug(<span class="hljs-string">&quot;Running the evict task&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (!isLeaseExpirationEnabled()) &#123;<br>            logger.debug(<span class="hljs-string">&quot;DS: lease expiration is currently disabled.&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// We collect first all expired items, to evict them in random order. For large eviction sets,</span><br>        <span class="hljs-comment">// if we do not that, we might wipe out whole apps before self preservation kicks in. By randomizing it,</span><br>        <span class="hljs-comment">// the impact should be evenly distributed across all applications.</span><br>        List&lt;Lease&lt;InstanceInfo&gt;&gt; expiredLeases = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (Entry&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; groupEntry : registry.entrySet()) &#123;<br>            Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; leaseMap = groupEntry.getValue();<br>            <span class="hljs-keyword">if</span> (leaseMap != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">for</span> (Entry&lt;String, Lease&lt;InstanceInfo&gt;&gt; leaseEntry : leaseMap.entrySet()) &#123;<br>                    Lease&lt;InstanceInfo&gt; lease = leaseEntry.getValue();<br>                    <span class="hljs-keyword">if</span> (lease.isExpired(additionalLeaseMs) &amp;&amp; lease.getHolder() != <span class="hljs-literal">null</span>) &#123;<br>                        expiredLeases.add(lease);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// To compensate for GC pauses or drifting local time, we need to use current registry size as a base for</span><br>        <span class="hljs-comment">// triggering self-preservation. Without that we would wipe out full registry.</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">registrySize</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) getLocalRegistrySize();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">registrySizeThreshold</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (registrySize * serverConfig.getRenewalPercentThreshold());<br>        <span class="hljs-type">int</span> <span class="hljs-variable">evictionLimit</span> <span class="hljs-operator">=</span> registrySize - registrySizeThreshold;<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">toEvict</span> <span class="hljs-operator">=</span> Math.min(expiredLeases.size(), evictionLimit);<br>        <span class="hljs-keyword">if</span> (toEvict &gt; <span class="hljs-number">0</span>) &#123;<br>            logger.info(<span class="hljs-string">&quot;Evicting &#123;&#125; items (expired=&#123;&#125;, evictionLimit=&#123;&#125;)&quot;</span>, toEvict, expiredLeases.size(), evictionLimit);<br><br>            <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>(System.currentTimeMillis());<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; toEvict; i++) &#123;<br>                <span class="hljs-comment">// Pick a random item (Knuth shuffle algorithm)</span><br>                <span class="hljs-type">int</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> i + random.nextInt(expiredLeases.size() - i);<br>                Collections.swap(expiredLeases, i, next);<br>                Lease&lt;InstanceInfo&gt; lease = expiredLeases.get(i);<br><br>                <span class="hljs-type">String</span> <span class="hljs-variable">appName</span> <span class="hljs-operator">=</span> lease.getHolder().getAppName();<br>                <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> lease.getHolder().getId();<br>                EXPIRED.increment();<br>                logger.warn(<span class="hljs-string">&quot;DS: Registry: expired lease for &#123;&#125;/&#123;&#125;&quot;</span>, appName, id);<br>                internalCancel(appName, id, <span class="hljs-literal">false</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><h2 id="eureka服务器间的复制"><a href="#eureka服务器间的复制" class="headerlink" title="eureka服务器间的复制"></a>eureka服务器间的复制</h2><p>spring 的生命周期管理</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">EurekaServerInitializerConfiguration类实现了SmartLifecycle<br></code></pre></td></tr></table></figure><p>spring 会在启动后调用start()方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">eurekaServerBootstrap.contextInitialized(<br>EurekaServerInitializerConfiguration.<span class="hljs-built_in">this</span>.servletContext);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">initEurekaServerContext();<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">registryCount</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.registry.syncUp();<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">syncUp</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// Copy entire entry from neighboring DS node</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; ((i &lt; serverConfig.getRegistrySyncRetries()) &amp;&amp; (count == <span class="hljs-number">0</span>)); i++) &#123;<br>            <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(serverConfig.getRegistrySyncRetryWaitMs());<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    logger.warn(<span class="hljs-string">&quot;Interrupted during registry transfer..&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-type">Applications</span> <span class="hljs-variable">apps</span> <span class="hljs-operator">=</span> eurekaClient.getApplications();<br>            <span class="hljs-keyword">for</span> (Application app : apps.getRegisteredApplications()) &#123;<br>                <span class="hljs-keyword">for</span> (InstanceInfo instance : app.getInstances()) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-keyword">if</span> (isRegisterable(instance)) &#123;<br>                            register(instance, instance.getLeaseInfo().getDurationInSecs(), <span class="hljs-literal">true</span>);<br>                            count++;<br>                        &#125;<br>                    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>                        logger.error(<span class="hljs-string">&quot;During DS init copy&quot;</span>, t);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> count;<br>    &#125;<br></code></pre></td></tr></table></figure><p>Eureka Server接收到Eureka Client的注册、续约、下线等操作，固定间隔（默认，500毫秒）向Eureka Server集群内其他节点同步</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">replicateToPeers(Action.Register, info.getAppName(), info.getId(), info, <span class="hljs-literal">null</span>, isReplication);<br>replicateToPeers(Action.Cancel, appName, id, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, isReplication);<br>replicateToPeers(Action.Heartbeat, appName, id, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, isReplication);<br>replicateToPeers(Action.StatusUpdate, appName, id, <span class="hljs-literal">null</span>, newStatus, isReplication);<br>replicateToPeers(Action.DeleteStatusOverride, appName, id, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, isReplication);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">replicateInstanceActionsToPeers</span><span class="hljs-params">(Action action, String appName,</span><br><span class="hljs-params">                                                 String id, InstanceInfo info, InstanceStatus newStatus,</span><br><span class="hljs-params">                                                 PeerEurekaNode node)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            InstanceInfo infoFromRegistry;<br>            CurrentRequestVersion.set(Version.V2);<br>            <span class="hljs-keyword">switch</span> (action) &#123;<br>                <span class="hljs-keyword">case</span> Cancel:<br>                    node.cancel(appName, id);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> Heartbeat:<br>                    <span class="hljs-type">InstanceStatus</span> <span class="hljs-variable">overriddenStatus</span> <span class="hljs-operator">=</span> overriddenInstanceStatusMap.get(id);<br>                    infoFromRegistry = getInstanceByAppAndId(appName, id, <span class="hljs-literal">false</span>);<br>                    node.heartbeat(appName, id, infoFromRegistry, overriddenStatus, <span class="hljs-literal">false</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> Register:<br>                    node.register(info);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> StatusUpdate:<br>                    infoFromRegistry = getInstanceByAppAndId(appName, id, <span class="hljs-literal">false</span>);<br>                    node.statusUpdate(appName, id, newStatus, infoFromRegistry);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> DeleteStatusOverride:<br>                    infoFromRegistry = getInstanceByAppAndId(appName, id, <span class="hljs-literal">false</span>);<br>                    node.deleteStatusOverride(appName, id, infoFromRegistry);<br>                    <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>            logger.error(<span class="hljs-string">&quot;Cannot replicate information to &#123;&#125; for action &#123;&#125;&quot;</span>, node.getServiceUrl(), action.name(), t);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            CurrentRequestVersion.remove();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>注册、下线、续约等请求处理程序都判断了isReplication的值，该值是来源于Request Header的x-netflix-discovery-replication，Eureka Client的注册请求isReplication为false，接收注册请求的Eureka Server节点会将该注册信息同步到其他Eureka Server节点，同步请求的isReplication为true，表示该注册信息是由其他Eureka Server节点复制过来的，这时候就不会继续往下传递了，避免了复制死循环的问题。</p><h2 id="CAP"><a href="#CAP" class="headerlink" title="CAP"></a>CAP</h2><p>C  consistency 一致性</p><p>A Availability 可用性</p><p>P Partition Tolerance 分区容错性</p><p>P 在集群系统中是必须的，不然就是单点服务。</p><table><thead><tr><th></th><th>Zookeeper</th><th>Eureka</th></tr></thead><tbody><tr><td>设计原则</td><td>CP</td><td>AP</td></tr><tr><td>优点</td><td>数据强一致</td><td>服务高可用</td></tr><tr><td>缺点</td><td>网络分区会影响Leader选举，超过阈值后集群不可用</td><td>服务节点间的数据可能不一致；Client-Server间的数据可能不一致；</td></tr><tr><td>适用场景</td><td>单机房集群，对数据一致性要求较高</td><td>云机房集群，跨越多机房部署；对注册中心服务可用性要求较高</td></tr></tbody></table><h2 id="优化或参数设置"><a href="#优化或参数设置" class="headerlink" title="优化或参数设置"></a>优化或参数设置</h2><h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><p>根据自我保护的源码分析可以根据项目情况设置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br><span class="hljs-comment"># 自我保护，看服务多少。</span><br>  <span class="hljs-attr">enable-self-preservation:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-comment"># 自我保护阈值</span><br>  <span class="hljs-attr">renewal-percent-threshold:</span> <span class="hljs-number">0.85</span><br>  <span class="hljs-comment"># 剔除服务时间间隔</span><br>  <span class="hljs-attr">eviction-interval-timer-in-ms:</span> <span class="hljs-number">1000</span><br></code></pre></td></tr></table></figure><p>根据获取注册表的源码：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br><span class="hljs-comment"># 关闭从readOnly读注册表</span><br>  <span class="hljs-attr">use-read-only-response-cache:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-comment"># readWrite 和 readOnly 同步时间间隔。</span><br>  <span class="hljs-attr">response-cache-update-interval-ms:</span> <span class="hljs-number">1000</span><br></code></pre></td></tr></table></figure><h3 id="客户端-1"><a href="#客户端-1" class="headerlink" title="客户端"></a>客户端</h3><p>根据客户端如何选择server的源码：</p><p>客户端可以如下配置</p><p>客户端A</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">serviceUrl:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:8761/eureka/,http://localhost:8762/eureka/</span><br></code></pre></td></tr></table></figure><p>客户端B</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">serviceUrl:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:8762/eureka/,http://localhost:8761/eureka/</span><br></code></pre></td></tr></table></figure><p>但是没啥必要，看下文，一个server可以支撑多少。</p><p>拉取注册表和心跳等客户端配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-comment"># 刷新注册表的间隔时间</span><br>    <span class="hljs-attr">registry-fetch-interval-seconds:</span> <span class="hljs-number">5</span><br>    <span class="hljs-attr">serviceUrl:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:8761/eureka/,http://localhost:8761/eureka/</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-comment"># 心跳续约间隔</span><br>    <span class="hljs-attr">lease-renewal-interval-in-seconds:</span> <span class="hljs-number">10</span><br>    <span class="hljs-comment"># 告诉server在接收到实例的最后一次发出的心跳后，需要等待多久才可以将此实例删除,默认90秒</span><br>    <span class="hljs-attr">lease-expiration-duration-in-seconds:</span> <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><h3 id="知道这些参数后："><a href="#知道这些参数后：" class="headerlink" title="知道这些参数后："></a>知道这些参数后：</h3><p>1.可以减少服务上下线的延时</p><p>2.自我保护的选择：看网络和服务情况是否开启</p><p>3.服务如何上线：先停client服务，再发送下线请求。</p><h2 id="eureka-server可支撑client测算"><a href="#eureka-server可支撑client测算" class="headerlink" title="eureka-server可支撑client测算"></a>eureka-server可支撑client测算</h2><p>现在咱们假设手头有一套大型的分布式系统，一共100个服务，每个服务部署在20台机器上，机器是4核8G的标准配置。</p><p>也就是说，相当于你一共部署了100 * 20 &#x3D; 2000个服务实例，有2000台机器。</p><p>每台机器上的服务实例内部都有一个Eureka Client组件，它会每隔30秒请求一次Eureka Server，拉取变化的注册表。</p><p>此外，每个服务实例上的Eureka Client都会每隔30秒发送一次心跳请求给Eureka Server。</p><p>那么大家算算，Eureka Server作为一个微服务注册中心，每秒钟要被请求多少次？一天要被请求多少次？</p><p>​按标准的算法，每个服务实例每分钟请求2次拉取注册表，每分钟请求2次发送心跳</p><p>​这样一个服务实例每分钟会请求4次，2000个服务实例每分钟请求8000次</p><p>​换算到每秒，则是8000 &#x2F; 60 &#x3D; 133次左右，我们就大概估算为Eureka Server每秒会被请求150次</p><p>​那一天的话，就是8000 * 60 * 24 &#x3D; 1152万，也就是每天千万级访问量</p><p>可以对上面的注册、续约接口进行压测，发现10000万请求，server只用了0.1秒就可以返回。说明server的承受能力。</p>]]></content>
    
    
    <categories>
      
      <category>spring_cloud</category>
      
      <category>spring_cloud_eureka</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring_cloud</tag>
      
      <tag>spring_cloud_eureka</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring_cloud_eureka实践</title>
    <link href="/2022/06/06/spring_cloud/spring_cloud_eureka%E5%AE%9E%E8%B7%B5/"/>
    <url>/2022/06/06/spring_cloud/spring_cloud_eureka%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h2 id="创建eureka-server"><a href="#创建eureka-server" class="headerlink" title="创建eureka-server"></a>创建eureka-server</h2><p>1.官网生成</p><p><a href="https://start.spring.io/">https://start.spring.io/</a></p><p>添加依赖 eureka-server</p><p>2.使用idea的spring initializr</p><p>添加依赖eureka-server</p><p>生成后的pom.xml为</p><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>eureka<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>eureka<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Demo project for Spring Boot<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-boot.version</span>&gt;</span>2.3.7.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring-boot.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud.version</span>&gt;</span>Hoxton.SR9<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.vintage<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-vintage-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">encoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">encoding</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.7.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>com.example.eureka.EurekaApplication<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p>添加@EnableEurekaServer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaServer</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EurekaApplication</span> &#123;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>SpringApplication.run(EurekaApplication.class, args);<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>这时启动，发现会一直报错</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"> <span class="hljs-selector-attr">[nfoReplicator-0]</span> com<span class="hljs-selector-class">.netflix</span><span class="hljs-selector-class">.discovery</span><span class="hljs-selector-class">.DiscoveryClient</span>    : DiscoveryClient_UNKNOWN/<span class="hljs-number">192.168</span>.<span class="hljs-number">1.106</span>: registering service...<br><span class="hljs-number">2022</span>-<span class="hljs-number">06</span>-<span class="hljs-number">06</span> <span class="hljs-number">19</span>:<span class="hljs-number">09</span>:<span class="hljs-number">50.806</span>  INFO <span class="hljs-number">3394</span> --- <span class="hljs-selector-attr">[nfoReplicator-0]</span> c<span class="hljs-selector-class">.n</span><span class="hljs-selector-class">.d</span><span class="hljs-selector-class">.s</span><span class="hljs-selector-class">.t</span><span class="hljs-selector-class">.d</span><span class="hljs-selector-class">.RedirectingEurekaHttpClient</span>  : Request execution error. endpoint=DefaultEndpoint&#123; serviceUrl=<span class="hljs-string">&#x27;http://localhost:8761/eureka/&#125;, exception=java.net.ConnectException: Connection refused (Connection refused) stacktrace=com.sun.jersey.api.client.ClientHandlerException: java.net.ConnectException: Connection refused (Connection refused)</span><br></code></pre></td></tr></table></figure><p>访问<a href="http://localhost:8080/%E6%98%AF%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0eureka-server%E7%9A%84%E9%A1%B5%E9%9D%A2%E7%9A%84%E3%80%82">http://localhost:8080/是可以看到eureka-server的页面的。</a></p><p>这是因为默认配置是使用8761端口，这个服务也向eureka-server注册。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8761</span><br><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">localhost</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">registerWithEureka:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">fetchRegistry:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">serviceUrl:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span><br></code></pre></td></tr></table></figure><p>Eureka instance的配置对应EurekaInstanceConfigBean</p><p>eureka client的配置对应EurekaClientConfigBean</p><p>registerWithEureka 默认为ture，意思是不注册到eureka</p><p>fetchRegistry 默认为ture,意思是不获取服务注册表</p><p>再启动后，不会报错，访问页面，发现Instances currently registered with Eureka 什么都没有。</p><h2 id="创建eureka-client"><a href="#创建eureka-client" class="headerlink" title="创建eureka-client"></a>创建eureka-client</h2><p>同server创建方式，不添加server了，添加client和spring web</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>service-a<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>service-a<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Demo project for Spring Boot<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-boot.version</span>&gt;</span>2.3.7.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring-boot.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud.version</span>&gt;</span>Hoxton.SR9<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.vintage<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-vintage-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">encoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">encoding</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.7.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>com.example.service_a.ServiceAApplication<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">service-a</span><br></code></pre></td></tr></table></figure><p>启动后，访问<a href="http://localhost:8761/%EF%BC%8C%E5%8F%91%E7%8E%B0">http://localhost:8761/，发现</a> service-a的服务实例。</p><p>添加测试controller</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">service-a</span><br><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8762</span><br><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">serviceUrl:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:8761/eureka/</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span><br>    String port;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;i am from port:&quot;</span> + port;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>访问<a href="http://localhost:8762/test">http://localhost:8762/test</a></p><h2 id="使用密码访问eureka"><a href="#使用密码访问eureka" class="headerlink" title="使用密码访问eureka"></a>使用密码访问eureka</h2><p>Eureka-server添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableWebSecurity</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><span class="hljs-comment">// 关闭csrf</span><br><span class="hljs-comment">//http.csrf().disable(); </span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 默认情况下添加SpringSecurity依赖的应用每个请求都需要添加CSRF token才能访问，Eureka客户端注册时并不会添加，所以需要配置/eureka/**路径不需要CSRF token。</span><br><span class="hljs-comment"> */</span><br>http.csrf().ignoringAntMatchers(<span class="hljs-string">&quot;/eureka/**&quot;</span>);<br><span class="hljs-comment">// 开启认证支持HttpBasic</span><br>http.authorizeRequests().anyRequest().authenticated().and().httpBasic(); <br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">eureka</span><br><br>  <span class="hljs-attr">security:</span><br>    <span class="hljs-attr">user:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">root</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8761</span><br><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">localhost</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-comment">#设置服务注册中心的URL</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://$&#123;spring.security.user.name&#125;:$&#123;spring.security.user.password&#125;@$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span><br></code></pre></td></tr></table></figure><p>这时访问<a href="http://localhost:8761/%EF%BC%8C%E9%9C%80%E8%A6%81%E7%94%A8%E6%88%B7%E5%90%8D%E5%AF%86%E7%A0%81">http://localhost:8761/，需要用户名密码</a></p><h2 id="高可用，2个节点"><a href="#高可用，2个节点" class="headerlink" title="高可用，2个节点"></a>高可用，2个节点</h2><p>创建application-8762.yml、application-8763.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">eureka</span><br><br>  <span class="hljs-attr">security:</span><br>    <span class="hljs-attr">user:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">root</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8762</span><br><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">localhost</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-comment">#设置服务注册中心的URL</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://$&#123;spring.security.user.name&#125;:$&#123;spring.security.user.password&#125;@$&#123;eureka.instance.hostname&#125;:8763/eureka/</span><br></code></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">eureka</span><br><br>  <span class="hljs-attr">security:</span><br>    <span class="hljs-attr">user:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">root</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8763</span><br><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">localhost</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-comment">#设置服务注册中心的URL</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://$&#123;spring.security.user.name&#125;:$&#123;spring.security.user.password&#125;@$&#123;eureka.instance.hostname&#125;:8762/eureka/</span><br><br></code></pre></td></tr></table></figure><p>互相注册，8762写8763的地址，8763写8762的地址。</p><p>在idea中运行配置中，添加修改选项  vm选项， 填入 -Dspring.profiles.active&#x3D;8763</p><p>修改选项 选择允许多个实例。</p><p>访问<a href="http://localhost:8762/">http://localhost:8762/</a>   <a href="http://localhost:8763/">http://localhost:8763/</a></p><p>发现有对方的实例。</p><h2 id="高可用，3节点"><a href="#高可用，3节点" class="headerlink" title="高可用，3节点"></a>高可用，3节点</h2><p>创建application-8764.yml、application-8765.yml、application-8766.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">eureka</span><br><br>  <span class="hljs-attr">security:</span><br>    <span class="hljs-attr">user:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">root</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8764</span><br><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">localhost</span><br>  <span class="hljs-attr">server:</span><br>    <span class="hljs-comment"># 设置 eureka server同步失败的等待时间 默认 5分 , 在这期间，它不向客户端提供服务注册信息</span><br>    <span class="hljs-attr">wait-time-in-ms-when-sync-empty:</span> <span class="hljs-number">0</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-comment">#设置服务注册中心的URL</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">&quot;http://root:root@$&#123;eureka.instance.hostname&#125;:8764/eureka/,\</span><br><span class="hljs-string">      http://root:root@$&#123;eureka.instance.hostname&#125;:8765/eureka/,\</span><br><span class="hljs-string">      http://root:root@$&#123;eureka.instance.hostname&#125;:8766/eureka/&quot;</span><br></code></pre></td></tr></table></figure><p>访问 <a href="http://localhost:8764/">http://localhost:8764/</a> <a href="http://localhost:8765/">http://localhost:8765/</a> <a href="http://localhost:8766/">http://localhost:8766/</a></p>]]></content>
    
    
    <categories>
      
      <category>spring_cloud</category>
      
      <category>spring_cloud_eureka</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring_cloud</tag>
      
      <tag>spring_cloud_eureka</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>maven聚合工程</title>
    <link href="/2022/06/06/maven/maven%E8%81%9A%E5%90%88%E5%B7%A5%E7%A8%8B/"/>
    <url>/2022/06/06/maven/maven%E8%81%9A%E5%90%88%E5%B7%A5%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h2 id="为什么要使用聚合工程"><a href="#为什么要使用聚合工程" class="headerlink" title="为什么要使用聚合工程"></a>为什么要使用聚合工程</h2><p>在项目初期，人员较少，但是还是需要协作开发。这时如果使用一个整体项目。会有冲突等问题。</p><h2 id="dependencies与dependencyManagement的区别"><a href="#dependencies与dependencyManagement的区别" class="headerlink" title="dependencies与dependencyManagement的区别"></a>dependencies与dependencyManagement的区别</h2><p>在我们项⽬顶层的POM⽂件中，我们会看到dependencyManagement元素。通过它来管理jar包的版本，让⼦项⽬中引⽤⼀个依赖⽽不⽤显⽰的列出版本号。Maven会沿着⽗⼦层次向上⾛，直到找到⼀个拥有dependencyManagement元素的项⽬，然后它就会使⽤在这个dependencyManagement元素中指定的版本号。</p><p>这样做的好处：统⼀管理项⽬的版本号，确保应⽤的各个项⽬的依赖和版本⼀致，才能保证测试的和发布的是相同的成果，因此，在<br>顶层pom中定义共同的依赖关系。同时可以避免在每个使⽤的⼦项⽬中都声明⼀个版本号，这样想升级或者切换到另⼀个版本时，只需要在<br>⽗类容器⾥更新，不需要任何⼀个⼦项⽬的修改；如果某个⼦项⽬需要另外⼀个版本号时，只需要在dependencies中声明⼀个版本号即</p><p>可。⼦类就会使⽤⼦类声明的版本号，不继承于⽗类版本号。</p><p>相对于dependencyManagement，所有⽣命在dependencies⾥的依赖都会⾃动引⼊，并默认被所有的⼦项⽬继承。</p><p>dependencies即使在⼦项⽬中不写该依赖项，那么⼦项⽬仍然会从⽗项⽬中继承该依赖项（全部继承）<br>         dependencyManagement⾥只是声明依赖，并不实现引⼊，因此⼦项⽬需要显⽰的声明需要⽤的依赖。如果不在⼦项⽬中声明依赖，是不会从⽗项⽬中继承下来的；只有在⼦项⽬中写了该依赖项，并且没有指定具体版本，才会从⽗项⽬中继承该项，并且version和scope都读取⾃⽗pom;另外如果⼦项⽬中指定了版本号，那么会使⽤⼦项⽬中指定的jar版本。</p><h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><p>创建父工程</p><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-polymerization<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>maven-polymerization<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>父工程<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-boot.version</span>&gt;</span>2.3.7.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring-boot.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">druid.version</span>&gt;</span>1.2.9<span class="hljs-tag">&lt;/<span class="hljs-name">druid.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">commons.io.version</span>&gt;</span>2.11.0<span class="hljs-tag">&lt;/<span class="hljs-name">commons.io.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven-compiler-plugin.version</span>&gt;</span>3.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">maven-compiler-plugin.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- io常用工具类 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;commons.io.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span> <span class="hljs-comment">&lt;!-- 表示依赖不会传递 --&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>            <span class="hljs-comment">&lt;!-- 阿里数据库连接池 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;maven-compiler-plugin.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>$&#123;java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>$&#123;java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">encoding</span>&gt;</span>$&#123;project.build.sourceEncoding&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">encoding</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">includeSystemScope</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">includeSystemScope</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>public<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>aliyun nexus<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">pluginRepositories</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">pluginRepository</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>public<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>aliyun nexus<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">pluginRepository</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">pluginRepositories</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p>新建common项目</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-polymerization<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span> <span class="hljs-comment">&lt;!-- 表示依赖不会传递 --&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p>如果使用idea创建的common模块会自动向父pom中添加</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>common<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="创建模块分歧"><a href="#创建模块分歧" class="headerlink" title="创建模块分歧"></a>创建模块分歧</h3><p>1.使用分层进行模块划分</p><p>​比如api层、service层、dao层、domain层</p><p>2.使用功能进玍模块划分</p><p>​比如  功能A、功能B、功能C</p><p>我比较倾向于第二种</p><p>第一种：需要在父pom的dependencyManagement中添加各个模块，api依赖service,service依赖dao,dao依赖domain。</p><p>第二种：</p><p>创建user、store功能</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-polymerization<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-polymerization<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>store<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p>添加启动模块</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-polymerization<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>store<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p>父工程修改</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-polymerization<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>common<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>store<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>maven-polymerization<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>父工程<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-boot.version</span>&gt;</span>2.3.7.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring-boot.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">druid.version</span>&gt;</span>1.2.9<span class="hljs-tag">&lt;/<span class="hljs-name">druid.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">commons.io.version</span>&gt;</span>2.11.0<span class="hljs-tag">&lt;/<span class="hljs-name">commons.io.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven-compiler-plugin.version</span>&gt;</span>3.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">maven-compiler-plugin.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- io常用工具类 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;commons.io.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;project.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>            <span class="hljs-comment">&lt;!-- 阿里数据库连接池 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;project.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>store<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;project.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;maven-compiler-plugin.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>$&#123;java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>$&#123;java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">encoding</span>&gt;</span>$&#123;project.build.sourceEncoding&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">encoding</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">includeSystemScope</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">includeSystemScope</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>public<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>aliyun nexus<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">pluginRepositories</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">pluginRepository</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>public<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>aliyun nexus<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">pluginRepository</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">pluginRepositories</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>在admin模块添加com.example.admin包</p><p>创建spring boot启动类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdminApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(AdminApplication.class, args);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>maven</category>
      
      <category>spring boot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>maven</tag>
      
      <tag>spring boot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring_boot_logback详解</title>
    <link href="/2022/05/30/spring/spring_boot_logback%E8%AF%A6%E8%A7%A3/"/>
    <url>/2022/05/30/spring/spring_boot_logback%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h2 id="Spring-boot官网"><a href="#Spring-boot官网" class="headerlink" title="Spring boot官网"></a>Spring boot官网</h2><p><a href="https://spring.io/">https://spring.io/</a></p><p>点击projects中的spring boot</p><p>点击learn中Reference Doc</p><p>点击Core Features</p><p>点击logging</p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>spring boot 默认是使用Logback日志记录。</p><p>输出日志：配置方式、输出位置、输出格式、级别控制</p><h3 id="配置方式"><a href="#配置方式" class="headerlink" title="配置方式"></a>配置方式</h3><p>1.使用spring boot 的配置文件 如application.properties  application.yml</p><p>2.指定logback的配置文件</p><h3 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h3><p>指定文件名或文件路径，文件名&gt;文件路径，两属性应该不可以一起使用。</p><figure class="highlight properties"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">logging.file.name</span>=<span class="hljs-string">my.log</span><br></code></pre></td></tr></table></figure><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">logging.file.path</span>=<span class="hljs-string">/Users/qichuanhan/logs/</span><br></code></pre></td></tr></table></figure><p>滚动：</p><table><thead><tr><th><code>logging.logback.rollingpolicy.file-name-pattern</code></th><th>用于创建日志存档的文件名模式。</th></tr></thead><tbody><tr><td><code>logging.logback.rollingpolicy.clean-history-on-start</code></td><td>如果应在应用程序启动时进行日志归档清理。</td></tr><tr><td><code>logging.logback.rollingpolicy.max-file-size</code></td><td>归档前日志文件的最大大小。</td></tr><tr><td><code>logging.logback.rollingpolicy.total-size-cap</code></td><td>在被删除之前可以占用的最大大小的日志档案。</td></tr><tr><td><code>logging.logback.rollingpolicy.max-history</code></td><td>要保留的存档日志文件的最大数量（默认为 7）。</td></tr></tbody></table><h3 id="方式二"><a href="#方式二" class="headerlink" title="方式二"></a>方式二</h3><p>创建logback.xml在classpath</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 日志存放路径 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;log.path&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/home/trans/logs&quot;</span> /&gt;</span><br>    <span class="hljs-comment">&lt;!-- 日志输出格式 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;log.pattern&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;%d&#123;HH:mm:ss.SSS&#125; -[%X&#123;traceId&#125;]- [%thread] %-5level %logger&#123;20&#125; - [%method,%line] - %msg%n&quot;</span> /&gt;</span><br><br><span class="hljs-comment">&lt;!-- 控制台输出 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;console&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>$&#123;log.pattern&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- logstash --&gt;</span><br>    <span class="hljs-comment">&lt;!--&lt;appender name=&quot;stash&quot; class=&quot;net.logstash.logback.appender.LogstashTcpSocketAppender&quot;&gt;--&gt;</span><br>        <span class="hljs-comment">&lt;!--&lt;destination&gt;39.103.144.58:9250&lt;/destination&gt;--&gt;</span><br>        <span class="hljs-comment">&lt;!--&amp;lt;!&amp;ndash; encoder必须配置,有多种可选 &amp;ndash;&amp;gt;--&gt;</span><br>        <span class="hljs-comment">&lt;!--&lt;encoder charset=&quot;UTF-8&quot; class=&quot;net.logstash.logback.encoder.LogstashEncoder&quot; &gt;--&gt;</span><br>            <span class="hljs-comment">&lt;!--&amp;lt;!&amp;ndash; &quot;appname&quot;:&quot;trans-core&quot; 的作用是指定创建索引的名字时用，并且在生成的文档中会多了这个字段  &amp;ndash;&amp;gt;--&gt;</span><br>            <span class="hljs-comment">&lt;!--&lt;customFields&gt;&#123;&quot;appname&quot;:&quot;trans-core&quot;&#125;&lt;/customFields&gt;--&gt;</span><br>        <span class="hljs-comment">&lt;!--&lt;/encoder&gt;--&gt;</span><br>    <span class="hljs-comment">&lt;!--&lt;/appender&gt;--&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 系统日志输出 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;file_info&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>$&#123;log.path&#125;/sys-info.log<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 循环政策：基于时间创建日志文件 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">rollingPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 日志文件名格式 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/sys-info.%d&#123;yyyy-MM-dd&#125;.log<span class="hljs-tag">&lt;/<span class="hljs-name">fileNamePattern</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 日志最大的历史 60天 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">maxHistory</span>&gt;</span>60<span class="hljs-tag">&lt;/<span class="hljs-name">maxHistory</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">rollingPolicy</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>$&#123;log.pattern&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 过滤的级别 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>INFO<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 匹配时的操作：接收（记录） --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">onMatch</span>&gt;</span>ACCEPT<span class="hljs-tag">&lt;/<span class="hljs-name">onMatch</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 不匹配时的操作：拒绝（不记录） --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">onMismatch</span>&gt;</span>DENY<span class="hljs-tag">&lt;/<span class="hljs-name">onMismatch</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;file_error&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>$&#123;log.path&#125;/sys-error.log<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 循环政策：基于时间创建日志文件 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rollingPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 日志文件名格式 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/sys-error.%d&#123;yyyy-MM-dd&#125;.log<span class="hljs-tag">&lt;/<span class="hljs-name">fileNamePattern</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 日志最大的历史 60天 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">maxHistory</span>&gt;</span>60<span class="hljs-tag">&lt;/<span class="hljs-name">maxHistory</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">rollingPolicy</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>$&#123;log.pattern&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 过滤的级别 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>ERROR<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 匹配时的操作：接收（记录） --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">onMatch</span>&gt;</span>ACCEPT<span class="hljs-tag">&lt;/<span class="hljs-name">onMatch</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 不匹配时的操作：拒绝（不记录） --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">onMismatch</span>&gt;</span>DENY<span class="hljs-tag">&lt;/<span class="hljs-name">onMismatch</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 用户访问日志输出  --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sys-user&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>$&#123;log.path&#125;/sys-user.log<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rollingPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 按天回滚 daily --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/sys-user.%d&#123;yyyy-MM-dd&#125;.log<span class="hljs-tag">&lt;/<span class="hljs-name">fileNamePattern</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 日志最大的历史 60天 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">maxHistory</span>&gt;</span>60<span class="hljs-tag">&lt;/<span class="hljs-name">maxHistory</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">rollingPolicy</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>$&#123;log.pattern&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--输出到文件的Appender配置SQL执行日志--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span> = <span class="hljs-string">&quot;file_sql&quot;</span> <span class="hljs-attr">class</span> = <span class="hljs-string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>$&#123;log.path&#125;/sys-sql.log<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>$&#123;log.pattern&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--日志记录器的滚动策略,按日期,按大小记录--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rollingPolicy</span> <span class="hljs-attr">class</span> = <span class="hljs-string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/sys-sql.%d&#123;yyyy-MM-dd&#125;.%i.log.gz<span class="hljs-tag">&lt;/<span class="hljs-name">fileNamePattern</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">maxFileSize</span>&gt;</span>2048MB<span class="hljs-tag">&lt;/<span class="hljs-name">maxFileSize</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--日志文件保留天数--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">maxHistory</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">maxHistory</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--该滚动策略日志的总大小，超过的日志会被清除--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">totalSizeCap</span>&gt;</span>15GB<span class="hljs-tag">&lt;/<span class="hljs-name">totalSizeCap</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">rollingPolicy</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--此日志文件记录TRACE级别以上--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 过滤的级别 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>DEBUG<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 匹配时的操作：接收（记录） --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">onMatch</span>&gt;</span>ACCEPT<span class="hljs-tag">&lt;/<span class="hljs-name">onMatch</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 不匹配时的操作：拒绝（不记录） --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">onMismatch</span>&gt;</span>DENY<span class="hljs-tag">&lt;/<span class="hljs-name">onMismatch</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 系统模块日志级别控制  --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;com.trans&quot;</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;info&quot;</span> /&gt;</span><br><span class="hljs-comment">&lt;!-- Spring日志级别控制  --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;org.springframework&quot;</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;warn&quot;</span> /&gt;</span><br><br><span class="hljs-comment">&lt;!--系统用户操作日志--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sys-user&quot;</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;info&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;sys-user&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span><br><br><br>    <span class="hljs-comment">&lt;!-- &lt;logger&gt;用来设置某一个包或者具体的某一个类的日志打印级别。有name属性，可选的level和可选的addtivity属性，以及可指定appender。</span><br><span class="hljs-comment">    name:用来指定受此logger约束的菜一个包或者具体的某一个类。</span><br><span class="hljs-comment">    level:用来设置打印级别，大小写无关:TRACE,DEBUG, INFO,WARN,ERROR,ALL和OFF，如果未设置此属性，那么当前logger将会继承上级的级别。addtivity :是否向上级logger传递打印信息。默认是true。</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">    使用mybatis的时候， sql语句是debug下才会打印,spring默认日志级别是INFO，所以想要查看sql语句的话，有以下两种操作:第一种把&lt;root level=&quot;INFO&quot;&gt;改成&lt;root level=&quot;DEBUG&quot;&gt;这样就会打印sql，不过这样日志那边会出现很多其他消息</span><br><span class="hljs-comment">    第二种就是单独给mapper下目录配置DEBUG级别:</span><br><span class="hljs-comment">    例如: &lt;logger name=&quot;com.*.mapper&quot; level=&quot;DEBUG&quot;/&gt;</span><br><span class="hljs-comment">    或者在配置文件中配置: logging.level.com.*.mapper=DEBUG，这样配置sql语句会打印，其他还是正常INFO级别:</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">springProfile</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;!production&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- configuration to be enabled when the &quot;production&quot; profile is not active --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">springProfile</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--开发环境--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">springProfile</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dev|test&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--单独设置mapper包下的日志级别为TRACE，因为输出执行的sql需妥DEBUG级别，TRACE级别小于DEBUG，设置为TRACE级别同时将SQL执行结果输出--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;com.trans.*.mapper&quot;</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;TRACE&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;file_sql&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- root节点是必选节点，用来指定最基础的日志输出级别，只有一个level屡性</span><br><span class="hljs-comment">        level:指定打印级别，大小写无关: TRACE, DEBUG, INFO,WARN,ERROR,ALL 和OFF，默认是DEBUG可以包含零个或多个appender元素 --&gt;</span><br>        <span class="hljs-comment">&lt;!--系统操作日志--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;info&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;console&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;file_info&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;file_error&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;file_sql&quot;</span> /&gt;</span><br>            <span class="hljs-comment">&lt;!--&lt;appender-ref ref=&quot;stash&quot;/&gt;--&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">springProfile</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--生产环境--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">springProfile</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;prod&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--单独设置mapper包下的日志级别为DEBUG，因为输出执行的sql需要DEBUG级别--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;com.trans.*.mapper&quot;</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;DEBUG&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;file_sql&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;info&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;console&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;file_info&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;file_error&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;file_sql&quot;</span> /&gt;</span><br>            <span class="hljs-comment">&lt;!--&lt;appender-ref ref=&quot;stash&quot;/&gt;--&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">springProfile</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>spring boot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring boot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>logback源码及原理分析</title>
    <link href="/2022/05/28/java/logback%E6%BA%90%E7%A0%81%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"/>
    <url>/2022/05/28/java/logback%E6%BA%90%E7%A0%81%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="如何看源码及原理分析"><a href="#如何看源码及原理分析" class="headerlink" title="如何看源码及原理分析"></a>如何看源码及原理分析</h2><p>原理及源码查看是相辅相成。只能了解原理才能更好的了解源码；只有相应的了解源码才能知道是怎么原理实现。</p><p>原理：</p><p>​自已设计一个。配合源码查看，验证框架设计者是怎么设计的。</p><p>源码：</p><p>​只要知道入口。使用时分几步。分别查看。</p><h2 id="logback简单使用"><a href="#logback简单使用" class="headerlink" title="logback简单使用"></a>logback简单使用</h2><p>加入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.25<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ch.qos.logback<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>logback-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.11<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ch.qos.logback<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>logback-classic<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.11<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>使用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(Test.class);<br>        logger.debug(<span class="hljs-string">&quot;Hello world.&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>这时运行会在控制台打印日志。</p><p>程序在IO上会有标准输入、标准输出、错误输出。</p><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>logback.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;FILE&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.FileAppender&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>myApp.log<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>%msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;FILE&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></table></figure><p>如果添加这个文件到资源目录下，会把日志写入myApp.log文件。</p><h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>从使用上来看。如果没有配置文件，框架会使用默认配置。有配置文件加载配置文件。根据提供的LoggerFactory类获取Logger,Logger调用方法打印日志。</p><p>LoggerFactory 看名字就是一个工厂类。又是一个入口类。这个类肯定会有默认配置和加配置文件的功能。生成Logger。</p><p>Logger是提供打印日志的方法。</p><h3 id="加载配置文件源码"><a href="#加载配置文件源码" class="headerlink" title="加载配置文件源码"></a>加载配置文件源码</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">Logger logger = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LoggerFactory</span>.</span></span>get<span class="hljs-constructor">Logger(Test.<span class="hljs-params">class</span>)</span>;<br>Logger logger = get<span class="hljs-constructor">Logger(<span class="hljs-params">clazz</span>.<span class="hljs-params">getName</span>()</span>);<br>ILoggerFactory iLoggerFactory = get<span class="hljs-constructor">ILoggerFactory()</span>;<br>perform<span class="hljs-constructor">Initialization()</span>;<br>bind<span class="hljs-literal">()</span>;<br>staticLoggerBinderPathSet = find<span class="hljs-constructor">PossibleStaticLoggerBinderPathSet()</span>;  #这时会找到org/slf4j/impl/<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">StaticLoggerBinder</span>.</span></span><span class="hljs-keyword">class</span><br><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">StaticLoggerBinder</span>.</span></span>get<span class="hljs-constructor">Singleton()</span>;<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SINGLETON</span>.</span></span>init<span class="hljs-literal">()</span>;<br><span class="hljs-keyword">new</span> <span class="hljs-constructor">ContextInitializer(<span class="hljs-params">defaultLoggerContext</span>)</span>.auto<span class="hljs-constructor">Config()</span>; # 看到autoConfig了应该就到目标了。<br><br>URL url = find<span class="hljs-constructor">URLOfDefaultConfigurationFile(<span class="hljs-params">true</span>)</span>;<br><br># 看系统参数logback.configurationFile 是否有设置<br>URL url = find<span class="hljs-constructor">ConfigFileURLFromSystemProperties(<span class="hljs-params">myClassLoader</span>, <span class="hljs-params">updateStatus</span>)</span>;<br><br># logback.groovy 配置文件<br>url = get<span class="hljs-constructor">Resource(GROOVY_AUTOCONFIG_FILE, <span class="hljs-params">myClassLoader</span>, <span class="hljs-params">updateStatus</span>)</span>;<br># logback-test.xml 配置文件<br>url = get<span class="hljs-constructor">Resource(TEST_AUTOCONFIG_FILE, <span class="hljs-params">myClassLoader</span>, <span class="hljs-params">updateStatus</span>)</span>;<br># logback.xml 配置文件<br>return get<span class="hljs-constructor">Resource(AUTOCONFIG_FILE, <span class="hljs-params">myClassLoader</span>, <span class="hljs-params">updateStatus</span>)</span>;<br><br>最后url 是null时说明没有配置文件<br><br>BasicConfigurator basicConfigurator = <span class="hljs-keyword">new</span> <span class="hljs-constructor">BasicConfigurator()</span>;<br>basicConfigurator.set<span class="hljs-constructor">Context(<span class="hljs-params">loggerContext</span>)</span>;<br>basicConfigurator.configure(loggerContext);<br>#进入configure方法<br>这里配置了控制台输出的Appender、Encoder、Layout<br></code></pre></td></tr></table></figure><p>这时就有Appender、Encoder、Layout要知道是啥</p><p>Appender是输出到哪去。</p><p>Encoder是输出的编码。</p><p>Layout是打印日志的格式。</p><h3 id="Logger上下文"><a href="#Logger上下文" class="headerlink" title="Logger上下文"></a>Logger上下文</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">contextSelectorBinder.get<span class="hljs-constructor">ContextSelector()</span><br>return contextSelectorBinder.get<span class="hljs-constructor">ContextSelector()</span>.get<span class="hljs-constructor">LoggerContext()</span>;<br>ch.qos.logback.classic.LoggerContext<br></code></pre></td></tr></table></figure><h3 id="Logger"><a href="#Logger" class="headerlink" title="Logger"></a>Logger</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">return iLoggerFactory.get<span class="hljs-constructor">Logger(<span class="hljs-params">name</span>)</span>;<br>LoggerContext类<br>childLogger = logger.create<span class="hljs-constructor">ChildByName(<span class="hljs-params">childName</span>)</span>;<br>childLogger = <span class="hljs-keyword">new</span> <span class="hljs-constructor">Logger(<span class="hljs-params">childName</span>, <span class="hljs-params">this</span>, <span class="hljs-params">this</span>.<span class="hljs-params">loggerContext</span>)</span>;<br>loggerCache.put(childName, childLogger);<br></code></pre></td></tr></table></figure><p>logger的结构为:  比如有一个com.test.a的类，这时会生成如下logger的父子结构</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">root<br><span class="hljs-keyword">com</span><br><span class="hljs-keyword">com</span>.test<br><span class="hljs-keyword">com</span>.test.a<br></code></pre></td></tr></table></figure><h3 id="打印日志源码"><a href="#打印日志源码" class="headerlink" title="打印日志源码"></a>打印日志源码</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs csharp">logger.debug(<span class="hljs-string">&quot;Hello world.&quot;</span>);<br>filterAndLog_0_Or3Plus(FQCN, <span class="hljs-literal">null</span>, Level.DEBUG, msg, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>buildLoggingEventAndAppend(localFQCN, marker, level, msg, <span class="hljs-keyword">params</span>, t);<br>LoggingEvent le = <span class="hljs-keyword">new</span> LoggingEvent(localFQCN, <span class="hljs-keyword">this</span>, level, msg, t, <span class="hljs-keyword">params</span>);<br>callAppenders(le);<br>writes += l.appendLoopOnAppenders(<span class="hljs-keyword">event</span>);<br><span class="hljs-keyword">return</span> aai.appendLoopOnAppenders(<span class="hljs-keyword">event</span>);<br>final Appender&lt;E&gt;[] appenderArray = appenderList.asTypedArray();<br>appenderArray[i].doAppend(e);<br><span class="hljs-meta"># 这时会调用具体的Appender的实现类</span><br><span class="hljs-keyword">this</span>.append(eventObject);<br>UnsynchronizedAppenderBase.doAppend(E eventObject) <br><span class="hljs-keyword">this</span>.append(eventObject);<br>OutputStreamAppender.subAppend(E <span class="hljs-keyword">event</span>)<br><span class="hljs-keyword">lock</span>.<span class="hljs-keyword">lock</span>();<br><span class="hljs-keyword">try</span> &#123;<br>writeOut(<span class="hljs-keyword">event</span>);<br>&#125; <span class="hljs-keyword">finally</span> &#123;<br><span class="hljs-keyword">lock</span>.unlock();<br>&#125;<br><span class="hljs-keyword">this</span>.encoder.doEncode(<span class="hljs-keyword">event</span>);<br>String txt = layout.doLayout(<span class="hljs-keyword">event</span>);<br>outputStream.write(convertToBytes(txt));<br><span class="hljs-keyword">if</span> (immediateFlush)<br>outputStream.flush();<br><br>System.<span class="hljs-keyword">out</span>.write(b);<br></code></pre></td></tr></table></figure><p>这时发现consoleAppender使用ReentrantLock， system.out.write。</p><h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><p>Logger</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ch<span class="hljs-selector-class">.qos</span><span class="hljs-selector-class">.logback</span><span class="hljs-selector-class">.classic</span>.Logger<br></code></pre></td></tr></table></figure><p>Appender  在root的logger中AppenderAttachableImpl aai</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">Appender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core)<br>UnsynchronizedAppenderBase (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core)<br>AsyncAppenderBase (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core)<br>#异步写日志<br>    AsyncAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>classic)<br>    OutputStreamAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core)<br>    # 同步写控制台<br>    ConsoleAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core)<br>    # 同步写文件<br>    FileAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core)<br>    # 滚动同步写文件<br>    RollingFileAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core<span class="hljs-number">.</span>rolling)<br>    DBAppenderBase (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core<span class="hljs-number">.</span><span class="hljs-built_in">db</span>)<br>    DBAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>classic<span class="hljs-number">.</span><span class="hljs-built_in">db</span>)<br>AppenderBase (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core)<br>    NOPAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core<span class="hljs-number">.</span>helpers)<br>    AbstractServerSocketAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core<span class="hljs-number">.</span>net<span class="hljs-number">.</span>server)<br>    SSLServerSocketAppenderBase (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core<span class="hljs-number">.</span>net<span class="hljs-number">.</span>server)<br>    SSLServerSocketAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>classic<span class="hljs-number">.</span>net<span class="hljs-number">.</span>server)<br>    ServerSocketAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>classic<span class="hljs-number">.</span>net<span class="hljs-number">.</span>server)<br>    JMSAppenderBase (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core<span class="hljs-number">.</span>net)<br>    JMSTopicAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>classic<span class="hljs-number">.</span>net)<br>    JMSQueueAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>classic<span class="hljs-number">.</span>net)<br>    SyslogAppenderBase (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core<span class="hljs-number">.</span>net)<br>    SyslogAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>classic<span class="hljs-number">.</span>net)<br>    SMTPAppenderBase (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core<span class="hljs-number">.</span>net)<br>    SMTPAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>classic<span class="hljs-number">.</span>net)<br>    SiftingAppenderBase (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core<span class="hljs-number">.</span>sift)<br>    SiftingAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>classic<span class="hljs-number">.</span>sift)<br>    CyclicBufferAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core<span class="hljs-number">.</span>read)<br>    ListAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core<span class="hljs-number">.</span>read)<br>    AbstractSocketAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core<span class="hljs-number">.</span>net)<br>    AbstractSSLSocketAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>core<span class="hljs-number">.</span>net)<br>    SSLSocketAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>classic<span class="hljs-number">.</span>net)<br>    SocketAppender (<span class="hljs-number">ch</span><span class="hljs-number">.</span>qos<span class="hljs-number">.</span>logback<span class="hljs-number">.</span>classic<span class="hljs-number">.</span>net)<br></code></pre></td></tr></table></figure><p>常用的 ConsoleAppender、FileAppender、RollingFileAppender、AsyncAppender</p><p>Encoder</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs scss">Encoder (ch.qos.logback.core.encoder)<br>EncoderBase (ch.qos.logback.core.encoder)<br># 输出不变只加换行符<br>    EchoEncoder (ch.qos.logback.core.encoder)<br>    # 布局包装<br>    LayoutWrappingEncoder (ch.qos.logback.core.encoder)<br>    PatternLayoutEncoderBase (ch.qos.logback.core.pattern)<br>    # 图案布局<br>    PatternLayoutEncoder (ch.qos.logback.classic.encoder)<br>    ObjectStreamEncoder (ch.qos.logback.core.encoder)<br></code></pre></td></tr></table></figure><p>一般使用LayoutWrappingEncoder、PatternLayoutEncoder</p><p>Layout</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs scss">Layout (ch.qos.logback.core)<br>  LayoutBase (ch.qos.logback.core)<br>  # xml布局<br>    XMLLayout (ch.qos.logback.classic.log4j)<br>    # 固定格式的布局  %d&#123;HH:mm:ss.SSS&#125; <span class="hljs-selector-attr">[%thread]</span> %-<span class="hljs-number">5</span>level %logger&#123;<span class="hljs-number">36</span>&#125; - %msg%n<br>    TTLLLayout (ch.qos.logback.classic.layout)<br>    HTMLLayoutBase (ch.qos.logback.core.html)<br>      # <span class="hljs-selector-tag">html</span>布局<br>    HTMLLayout (ch.qos.logback.classic.html)<br>    EchoLayout (ch.qos.logback.core.layout)<br>    PatternLayoutBase (ch.qos.logback.core.pattern)<br>    # 使用模式字符串配置的灵活布局。<br>    PatternLayout (ch.qos.logback.classic)<br></code></pre></td></tr></table></figure><h3 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>  多个appender<br>  <span class="hljs-tag">&lt;<span class="hljs-name">appender</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br>  多个logger<br>  <span class="hljs-tag">&lt;<span class="hljs-name">logger</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span><br>  一个root<br>  <span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 日志存放路径 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;log.path&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/Users/qichuanhan/logs&quot;</span> /&gt;</span><br>    <span class="hljs-comment">&lt;!-- 日志输出格式 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;log.pattern&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;%d&#123;HH:mm:ss.SSS&#125; -[%X&#123;traceId&#125;]- [%thread] %-5level %logger&#123;20&#125; - [%method,%line] - %msg%n&quot;</span> /&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 控制台输出 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;console&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>$&#123;log.pattern&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 系统日志输出 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;file_info&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>$&#123;log.path&#125;/my-info.log<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 循环政策：基于时间创建日志文件 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rollingPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 日志文件名格式 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/sys-info.%d&#123;yyyy-MM-dd&#125;.log<span class="hljs-tag">&lt;/<span class="hljs-name">fileNamePattern</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 日志最大的历史 60天 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">maxHistory</span>&gt;</span>60<span class="hljs-tag">&lt;/<span class="hljs-name">maxHistory</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">rollingPolicy</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>$&#123;log.pattern&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 过滤的级别 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>INFO<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 匹配时的操作：接收（记录） --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">onMatch</span>&gt;</span>ACCEPT<span class="hljs-tag">&lt;/<span class="hljs-name">onMatch</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 不匹配时的操作：拒绝（不记录） --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">onMismatch</span>&gt;</span>DENY<span class="hljs-tag">&lt;/<span class="hljs-name">onMismatch</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;file_error&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>$&#123;log.path&#125;/my-error.log<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 循环政策：基于时间创建日志文件 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rollingPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 日志文件名格式 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/sys-error.%d&#123;yyyy-MM-dd&#125;.log<span class="hljs-tag">&lt;/<span class="hljs-name">fileNamePattern</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 日志最大的历史 60天 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">maxHistory</span>&gt;</span>60<span class="hljs-tag">&lt;/<span class="hljs-name">maxHistory</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">rollingPolicy</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>$&#123;log.pattern&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 过滤的级别 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>ERROR<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 匹配时的操作：接收（记录） --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">onMatch</span>&gt;</span>ACCEPT<span class="hljs-tag">&lt;/<span class="hljs-name">onMatch</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 不匹配时的操作：拒绝（不记录） --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">onMismatch</span>&gt;</span>DENY<span class="hljs-tag">&lt;/<span class="hljs-name">onMismatch</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;info&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;console&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;file_info&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;file_error&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="AsyncAppender"><a href="#AsyncAppender" class="headerlink" title="AsyncAppender"></a>AsyncAppender</h3><p>消费者：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Worker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            AsyncAppenderBase&lt;E&gt; parent = AsyncAppenderBase.<span class="hljs-built_in">this</span>;<br>            AppenderAttachableImpl&lt;E&gt; aai = parent.aai;<br><br>            <span class="hljs-comment">// loop while the parent is started</span><br>            <span class="hljs-keyword">while</span> (parent.isStarted()) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">E</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> parent.blockingQueue.take();<br>                    aai.appendLoopOnAppenders(e);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException ie) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br><br>            addInfo(<span class="hljs-string">&quot;Worker thread will flush remaining events before exiting. &quot;</span>);<br><br>            <span class="hljs-keyword">for</span> (E e : parent.blockingQueue) &#123;<br>                aai.appendLoopOnAppenders(e);<br>                parent.blockingQueue.remove(e);<br>            &#125;<br><br>            aai.detachAndStopAllAppenders();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">BlockingQueue&lt;E&gt; blockingQueue;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DEFAULT_QUEUE_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">256</span>;<br></code></pre></td></tr></table></figure><p>生产者：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java">UnsynchronizedAppenderBase.doAppend(E eventObject);<br><span class="hljs-built_in">this</span>.append(eventObject);<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">append</span><span class="hljs-params">(E eventObject)</span> &#123;<br>  <span class="hljs-keyword">if</span> (isQueueBelowDiscardingThreshold() &amp;&amp; isDiscardable(eventObject)) &#123;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  preprocess(eventObject);<br>  put(eventObject);<br>&#125;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(E eventObject)</span> &#123;<br>  <span class="hljs-keyword">if</span> (neverBlock) &#123;<br>    blockingQueue.offer(eventObject);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      blockingQueue.put(eventObject);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>      <span class="hljs-comment">// Interruption of current thread when in doAppend method should not be consumed</span><br>      <span class="hljs-comment">// by AsyncAppender</span><br>      Thread.currentThread().interrupt();<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux查看CPU或内存多的进程</title>
    <link href="/2022/05/23/linux/linux%E6%9F%A5%E7%9C%8BCPU%E6%88%96%E5%86%85%E5%AD%98%E5%A4%9A%E7%9A%84%E8%BF%9B%E7%A8%8B/"/>
    <url>/2022/05/23/linux/linux%E6%9F%A5%E7%9C%8BCPU%E6%88%96%E5%86%85%E5%AD%98%E5%A4%9A%E7%9A%84%E8%BF%9B%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h2 id="CPU占用最多的前10个进程"><a href="#CPU占用最多的前10个进程" class="headerlink" title="CPU占用最多的前10个进程"></a>CPU占用最多的前10个进程</h2><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">ps auxw|<span class="hljs-built_in">head</span> -1;ps auxw|<span class="hljs-built_in">sort</span> -rn -k3|<span class="hljs-built_in">head</span> -10<br></code></pre></td></tr></table></figure><h2 id="内存消耗最多的前10个进程"><a href="#内存消耗最多的前10个进程" class="headerlink" title="内存消耗最多的前10个进程"></a>内存消耗最多的前10个进程</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ps auxw|<span class="hljs-built_in">head</span> -1;ps auxw|<span class="hljs-built_in">sort</span> -rn -k4|<span class="hljs-built_in">head</span> -10<br></code></pre></td></tr></table></figure><h2 id="虚拟内存使用最多的前10个进程"><a href="#虚拟内存使用最多的前10个进程" class="headerlink" title="虚拟内存使用最多的前10个进程"></a>虚拟内存使用最多的前10个进程</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ps auxw|<span class="hljs-built_in">head</span> -1;ps auxw|<span class="hljs-built_in">sort</span> -rn -k5|<span class="hljs-built_in">head</span> -10<br></code></pre></td></tr></table></figure><h2 id="ps出显示参数含义"><a href="#ps出显示参数含义" class="headerlink" title="ps出显示参数含义"></a>ps出显示参数含义</h2><p>%MEM 进程的内存占用率</p><p>VSZ 进程所使用的虚存的大小</p><p>RSS 进程使用的驻留集大小或者是实际内存的大小(RSS is the “resident set size” meaning physical memory used)</p><p>TTY 与进程关联的终端（tty）</p>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring boot跨域</title>
    <link href="/2022/05/21/spring/spring%20boot%E8%B7%A8%E5%9F%9F/"/>
    <url>/2022/05/21/spring/spring%20boot%E8%B7%A8%E5%9F%9F/</url>
    
    <content type="html"><![CDATA[<h2 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h2><h3 id="同源策略是什么？"><a href="#同源策略是什么？" class="headerlink" title="同源策略是什么？"></a>同源策略是什么？</h3><p>同源策略是一种约定，它是浏览器最核心也最基本的安全功能<br>如果缺少了同源策略，则浏览器的正常功能可能都会受到影响。<br>可以说Web是构建在同源策略基础之上的，浏览器只是针对同源策略的一种实现。<br>它是一个安全策略。所有支持JavaScript的浏览器都会使用这个策略</p><p>满足同源的三个条件：<br>所谓同源是指，域名、协议、端口相同。</p><h3 id="为什么要同源限制？"><a href="#为什么要同源限制？" class="headerlink" title="为什么要同源限制？"></a>为什么要同源限制？</h3><p>同源策略存在的意义： </p><p>非同源下的 cookie 等隐私数据可以被随意获取。</p><p>非同源下的 DOM 可以的随意操作。</p><p>ajax 可以任意请求的话，用户的各种隐私肯定会泄露，对用户造成不同程度的损失。</p><h3 id="同源策略的限制范围？"><a href="#同源策略的限制范围？" class="headerlink" title="同源策略的限制范围？"></a>同源策略的限制范围？</h3><p>不能获取不同源的 cookie，LocalStorage 和 indexDB。</p><p>不能获取不同源的 DOM() 。</p><p>不能发送不同源的 ajax 请求 （可以向不同源的服务器发起请求，但是返回的数据会被浏览器拦截）。</p><h3 id="为什么会出现跨域"><a href="#为什么会出现跨域" class="headerlink" title="为什么会出现跨域"></a>为什么会出现跨域</h3><p>出于浏览器的同源策略限制。同源策略（Sameoriginpolicy）是一种约定，它是浏览器最核心也最基本的安全功能，如果缺少了同源策略，则浏览器的正常功能可能都会受到影响。可以说Web是构建在同源策略基础之上的，浏览器只是针对同源策略的一种实现。同源策略会阻止一个域的javascript脚本和另外一个域的内容进行交互。所谓同源（即指在同一个域）就是两个页面具有相同的协议（protocol），主机（host）和端口号（port）</p><h3 id="什么是跨域"><a href="#什么是跨域" class="headerlink" title="什么是跨域"></a>什么是跨域</h3><p>当一个请求url的<strong>协议、域名、端口</strong>三者之间任意一个与当前页面url不同即为跨域</p><h3 id="跨域不要重复配置"><a href="#跨域不要重复配置" class="headerlink" title="跨域不要重复配置"></a>跨域不要重复配置</h3><p>如果在网关配置了后续就不要配置了，比如在nginx或gateway配置了，后面的spring boot就不要配置了。</p><h2 id="SpringBoot解决跨域的三种方式"><a href="#SpringBoot解决跨域的三种方式" class="headerlink" title="SpringBoot解决跨域的三种方式"></a>SpringBoot解决跨域的三种方式</h2><h3 id="方法1：添加-CrossOrigin注解"><a href="#方法1：添加-CrossOrigin注解" class="headerlink" title="方法1：添加@CrossOrigin注解"></a>方法1：添加@CrossOrigin注解</h3><p>在Controller层对应的方法上添加@Controller</p><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;index&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/test&quot;)</span><br>    <span class="hljs-meta">@CrossOrigin</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">index</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello world&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="方法2：实现WebMvcConfigurer，重写addCorsMappings方法"><a href="#方法2：实现WebMvcConfigurer，重写addCorsMappings方法" class="headerlink" title="方法2：实现WebMvcConfigurer，重写addCorsMappings方法"></a>方法2：实现WebMvcConfigurer，重写addCorsMappings方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CorsConfiguration</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addCorsMappings</span><span class="hljs-params">(CorsRegistry registry)</span> &#123;<br>        registry.addMapping(<span class="hljs-string">&quot;/**&quot;</span>)<br>                .allowedOrigins(<span class="hljs-string">&quot;*&quot;</span>)<br>                .allowedMethods(<span class="hljs-string">&quot;*&quot;</span>)<br>                .allowedHeaders(<span class="hljs-string">&quot;*&quot;</span>)<br>                .allowCredentials(<span class="hljs-literal">true</span>)<br>                .maxAge(<span class="hljs-number">3600</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>根据spring boot 版本 调用 allowedOrigins 还是allowedOriginPatterns</p><h3 id="方法3：添加CORS过滤器"><a href="#方法3：添加CORS过滤器" class="headerlink" title="方法3：添加CORS过滤器"></a>方法3：添加CORS过滤器</h3><p>新建配置类CorsConfig，创建CorsFilter过滤器，允许跨域</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CorsConfig</span> &#123;<br>    <span class="hljs-comment">// 跨域请求处理</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> CorsFilter <span class="hljs-title function_">corsFilter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">CorsConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorsConfiguration</span>();<br>        <span class="hljs-comment">//允许所有域名进行跨域调用</span><br>        config.addAllowedOrigin(<span class="hljs-string">&quot;*&quot;</span>);<br>        <span class="hljs-comment">//允许所有请求头</span><br>        config.addAllowedHeader(<span class="hljs-string">&quot;*&quot;</span>);<br>        <span class="hljs-comment">//允许所有方法</span><br>        config.addAllowedMethod(<span class="hljs-string">&quot;*&quot;</span>);<br>        <span class="hljs-type">UrlBasedCorsConfigurationSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlBasedCorsConfigurationSource</span>();<br>        source.registerCorsConfiguration(<span class="hljs-string">&quot;/**&quot;</span>, config);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorsFilter</span>(source);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="有前置的filter，要把跨域的filter设置为最小"><a href="#有前置的filter，要把跨域的filter设置为最小" class="headerlink" title="有前置的filter，要把跨域的filter设置为最小"></a>有前置的filter，要把跨域的filter设置为最小</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CorsConfig</span> &#123;<br>    <span class="hljs-keyword">private</span> CorsConfiguration <span class="hljs-title function_">buildConfig</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">CorsConfiguration</span> <span class="hljs-variable">corsConfiguration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorsConfiguration</span>();<br>        <span class="hljs-comment">// 1 设置访问源地址</span><br>        corsConfiguration.addAllowedOrigin(<span class="hljs-string">&quot;*&quot;</span>);<br>        <span class="hljs-comment">// 2 设置访问源请求头</span><br>        corsConfiguration.addAllowedHeader(<span class="hljs-string">&quot;*&quot;</span>);<br>        <span class="hljs-comment">// 3 设置访问源请求方法</span><br>        corsConfiguration.addAllowedMethod(<span class="hljs-string">&quot;*&quot;</span>);<br>        <span class="hljs-keyword">return</span> corsConfiguration;<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> FilterRegistrationBean&lt;CorsFilter&gt; <span class="hljs-title function_">corsFilter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">UrlBasedCorsConfigurationSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlBasedCorsConfigurationSource</span>();<br>        <span class="hljs-comment">// 5 对接口配置跨域设置</span><br>        source.registerCorsConfiguration(<span class="hljs-string">&quot;/**&quot;</span>, buildConfig());<br>        <span class="hljs-comment">//有多个filter时此处设置改CorsFilter的优先执行顺序</span><br>        FilterRegistrationBean&lt;CorsFilter&gt; bean = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterRegistrationBean</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CorsFilter</span>(source));<br>        bean.setOrder(Ordered.HIGHEST_PRECEDENCE);<br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>spring boot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring boot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring security实践</title>
    <link href="/2022/05/20/%E6%9D%83%E9%99%90%E6%A1%86%E6%9E%B6/spring%20security%E5%AE%9E%E8%B7%B5/"/>
    <url>/2022/05/20/%E6%9D%83%E9%99%90%E6%A1%86%E6%9E%B6/spring%20security%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h2 id="官网操作及阅读"><a href="#官网操作及阅读" class="headerlink" title="官网操作及阅读"></a>官网操作及阅读</h2><p><a href="https://spring.io/">https://spring.io/</a></p><p>点击 projects 选择 spring security</p><p>首先看到的overview下有简介和特色或者功能还有快速开始。</p><p>Spring Security 是一个功能强大且高度可定制的身份验证和访问控制框架。它是保护基于 Spring 的应用程序的事实标准。</p><p>Spring Security 是一个专注于为 Java 应用程序提供身份验证和授权的框架。像所有 Spring 项目一样，Spring Security 的真正强大之处在于它可以轻松扩展以满足自定义需求。</p><p>特征：</p><p>​对身份验证和授权的全面且可扩展的支持</p><p>​防止会话固定、点击劫持、跨站点请求伪造等攻击</p><p>​Servlet API 集成</p><p>​与 Spring Web MVC 的可选集成</p><p>入门分为：</p><p>​<a href="https://docs.spring.io/spring-security/reference/servlet/getting-started.html">入门（Servlet）</a></p><p>​<a href="https://docs.spring.io/spring-security/reference/reactive/getting-started.html">入门 (WebFlux)</a></p><h2 id="入门-servlet"><a href="#入门-servlet" class="headerlink" title="入门(servlet)"></a>入门(servlet)</h2><p>可以点击下载最小的 Spring Boot + Spring Security 应用程序。</p><p>这个项目其实就是创建spring boot 添加 下面的依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><pre><code class="hljs xml">    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-boot.version</span>&gt;</span>2.3.7.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring-boot.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">index</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success.....&quot;</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>这时启动spring boot 项目</p><p>可以直接输入<a href="http://localhost:8080/login">http://localhost:8080/login</a>  会跳转到springsecurity提供的登录页。也可以直接访问<a href="http://localhost:8080/%E4%B9%9F%E4%BC%9A%E8%87%AA%E5%8A%A8%E8%B7%B3%E8%BD%AC%E3%80%82">http://localhost:8080/也会自动跳转。</a></p><p>根据官网提示，它会创建一个用户名为user的用户，密码在启动日志打印里。</p><p>登录成功后会自动跳转到<a href="http://localhost:8080/%E6%98%BE%E7%A4%BAsucess">http://localhost:8080/显示sucess</a></p><h3 id="读取用户名和密码的方式-表单、基本、摘要"><a href="#读取用户名和密码的方式-表单、基本、摘要" class="headerlink" title="读取用户名和密码的方式(表单、基本、摘要)"></a>读取用户名和密码的方式(表单、基本、摘要)</h3><h4 id="表单-（默认）"><a href="#表单-（默认）" class="headerlink" title="表单 （默认）"></a>表单 （默认）</h4><p>默认配置相当于下面的配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.formLogin(Customizer.withDefaults())<br>                .authorizeRequests().anyRequest().authenticated();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>测试表单同上。</p><h4 id="基本"><a href="#基本" class="headerlink" title="基本"></a>基本</h4><p>httpBasic是由http协议定义的最基础的认证方式。每次请求时，在请求头Authorization参数中附带用户&#x2F;密码的base64编码，参考base64。这个方式并不安全，不适合在web项目中使用。但它是一些现代主流认证的基础，而且在spring security的oauth中，内部认证默认就是用的httpBasic。</p><p>配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.httpBasic(Customizer.withDefaults())<br>                .authorizeRequests().anyRequest().authenticated();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>这时使用浏览器访问，不再会跳转到登录页，而会弹出浏览器的用户名密码窗口。</p><p>在调试窗口中查看该请求的响应头，其中有个WWW-Authenticate: Basic realm&#x3D;”Realm”。</p><p>WWW-Authenticate：服务器告知浏览器代理认证工作。</p><p>Basic：认证类型为Basic。</p><p>realm&#x3D;”Realm”：认证域名为Realm</p><p>realm<br>realm&#x3D;”Realm”：指认证域名为Realm。在未认证用户请求不同的接口时，后台根据给该接口分配的域，可以响应不同的realm名，并且用不同用户名&#x2F;密码进行认证。所以用户每请求一个新Realm的url，都会弹框要求用新Realm的用户名&#x2F;密码进行认证，就好比不同的角色登录只能请求属于该角色的url。httpBasic默认realm名为Realm，可以用以下方式配置。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">http.httpBasic().realmName(<span class="hljs-string">&quot;Realm&quot;</span>)<br></code></pre></td></tr></table></figure><p>此时的响应码为401，根据401和以上响应头，浏览器会接管工作，它会弹出上面那个框要求输入用户名&#x2F;密码，并将其拼接成“用户名:密码”格式，中间是一个冒号，再用base64编码成xxx，然后在请求头中附加Authorization:Basic xxx，发给后台认证。后台需要用base64解码xxx，再认证用户名&#x2F;密码。</p><p>认证错误：浏览器会保持弹框。</p><p>认证成功：浏览器会缓存有效的base64编码，在之后的请求中，浏览器都会在请求头中添加有效编码。<br>可以使用浏览器的清除 cookies及其他网站数据清除该用户名密码。</p><h4 id="摘要认证"><a href="#摘要认证" class="headerlink" title="摘要认证"></a>摘要认证</h4><p>您不应该在现代应用程序中使用摘要式身份验证，因为它不被认为是安全的。最明显的问题是您必须以明文、加密或 MD5 格式存储密码。所有这些存储格式都被认为是不安全的。相反，您应该使用 Digest Authentication 不支持的单向自适应密码散列（即 bCrypt、PBKDF2、SCrypt 等）存储凭据。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> NoOpPasswordEncoder.getInstance();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http<br>                .authorizeRequests()<br>                .anyRequest().authenticated().and()<br>                .addFilter(digestAuthenticationFilter())<span class="hljs-comment">//在过滤链中添加摘要认证过滤器</span><br>                .exceptionHandling().accessDeniedPage(<span class="hljs-string">&quot;/403&quot;</span>)<br>                .authenticationEntryPoint(digestAuthenticationEntryPoint())<span class="hljs-comment">//摘要认证入口端点</span><br>                .and()<br>                    .csrf().disable();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DigestAuthenticationFilter <span class="hljs-title function_">digestAuthenticationFilter</span><span class="hljs-params">()</span>&#123;<br>        DigestAuthenticationFilter filter= <span class="hljs-keyword">new</span> <span class="hljs-title class_">DigestAuthenticationFilter</span>();<br>        filter.setAuthenticationEntryPoint(digestAuthenticationEntryPoint());<span class="hljs-comment">//必须配置</span><br>        filter.setUserDetailsService(userDetailsService());<span class="hljs-comment">//必须配置</span><br>        <span class="hljs-keyword">return</span> filter;<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DigestAuthenticationEntryPoint <span class="hljs-title function_">digestAuthenticationEntryPoint</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">DigestAuthenticationEntryPoint</span> <span class="hljs-variable">point</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DigestAuthenticationEntryPoint</span>();<br>        point.setRealmName(<span class="hljs-string">&quot;realm&quot;</span>);<span class="hljs-comment">//realm名</span><br>        point.setKey(<span class="hljs-string">&quot;key&quot;</span>);<span class="hljs-comment">//密钥</span><br>        <span class="hljs-keyword">return</span> point;<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDetailsService</span>() &#123;<br>            <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>                <span class="hljs-comment">//省略从数据库查询过程</span><br>                List&lt;GrantedAuthority&gt; authorities = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;GrantedAuthority&gt;();<br>                authorities.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleGrantedAuthority</span>(<span class="hljs-string">&quot;auth&quot;</span>));<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(username, <span class="hljs-string">&quot;123&quot;</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, authorities);<br>            &#125;<br>        &#125;;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>测试同http基本认证</p><h3 id="自定义登录页面-认证还是默认的"><a href="#自定义登录页面-认证还是默认的" class="headerlink" title="自定义登录页面(认证还是默认的)"></a>自定义登录页面(认证还是默认的)</h3><p>formLogin自动配置了一些url和页面：</p><p>&#x2F;login (get)：登录页面，任意没有登录的请求都会跳转到这里，就是上面看到的那个页面。<br>&#x2F;login (post)：登录接口，在登录页面点击登录，会请求这个接口。<br>&#x2F;login?error：用户名或密码错误，跳转到该页面。<br>&#x2F;：登录成功后，默认跳转的页面，&#x2F;会重定向到index.html，这个页面要你自己实现。<br>&#x2F;logout：注销页面。<br>&#x2F;login?logout：注销成功跳转页面。</p><p>添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6.7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>添加templates&#x2F;login.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/xhtml&quot;</span> <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;https://www.thymeleaf.org&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Please Log In<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Please Log In<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:if</span>=<span class="hljs-string">&quot;$&#123;param.error&#125;&quot;</span>&gt;</span><br>    Invalid username and password.<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:if</span>=<span class="hljs-string">&quot;$&#123;param.logout&#125;&quot;</span>&gt;</span><br>    You have been logged out.<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">th:action</span>=<span class="hljs-string">&quot;@&#123;/login&#125;&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;Username&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;Password&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Log in&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>添加跳转的controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginController</span> &#123;<br><span class="hljs-meta">@GetMapping(&quot;/login&quot;)</span><br>String <span class="hljs-title function_">login</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;login&quot;</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>添加配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 设置为表单登录及登录页面</span><br>        http.formLogin().loginPage(<span class="hljs-string">&quot;/login&quot;</span>)<br>                .and().authorizeRequests()<br>                <span class="hljs-comment">// 登录页可以访问</span><br>                .antMatchers(<span class="hljs-string">&quot;/login&quot;</span>).permitAll()<br>                <span class="hljs-comment">// 其他都需要认证</span><br>                .anyRequest().authenticated();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="密码存储"><a href="#密码存储" class="headerlink" title="密码存储"></a>密码存储</h3><h4 id="密码编码器-PasswordEncoder"><a href="#密码编码器-PasswordEncoder" class="headerlink" title="密码编码器(PasswordEncoder)"></a>密码编码器(PasswordEncoder)</h4><p>不管密码存储到哪都需要密码编码器，因为明文密码是不安全的。</p><p>spring security提供了很多实现类</p><p>这些实现类都以算法名开头  XXXPasswordEncoder</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">BCryptPasswordEncoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> encoder.encode(<span class="hljs-string">&quot;123&quot;</span>);<span class="hljs-comment">//注册时，对密码123加密，结果将保存到数据库</span><br>    System.out.println(result);<br>    encoder.matches(<span class="hljs-string">&quot;123&quot;</span>, result);<span class="hljs-comment">//登录时，从数据库读取密文，验证密码是否是123</span><br>&#125;<br></code></pre></td></tr></table></figure><p>spring security 提供了四种方式</p><h4 id="把密码存储到内存中"><a href="#把密码存储到内存中" class="headerlink" title="把密码存储到内存中"></a>把密码存储到内存中</h4><p>这里使用的是默认页面，内存里存储用户名和密码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">users</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> User.builder()<br>                .username(<span class="hljs-string">&quot;user&quot;</span>)<br>                .password(<span class="hljs-string">&quot;$2a$10$euvsO7nBJjnyRgtgLG7EfurLQD2cql6lHPMewpDxp7v8p2i0NZDVy&quot;</span>)<br>                .roles(<span class="hljs-string">&quot;USER&quot;</span>)<br>                .build();<br>        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">admin</span> <span class="hljs-operator">=</span> User.builder()<br>                .username(<span class="hljs-string">&quot;admin&quot;</span>)<br>                .password(<span class="hljs-string">&quot;$2a$10$euvsO7nBJjnyRgtgLG7EfurLQD2cql6lHPMewpDxp7v8p2i0NZDVy&quot;</span>)<br>                .roles(<span class="hljs-string">&quot;USER&quot;</span>, <span class="hljs-string">&quot;ADMIN&quot;</span>)<br>                .build();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>(user, admin);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>测试访问  <a href="http://localhost:8080/">http://localhost:8080/</a>   自动跳转到登录页，输入用户名user  密码 123，发现跳转“&#x2F;页面。</p><p>兼容多种密码解码器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>auth.inMemoryAuthentication()<br>.withUser(<span class="hljs-string">&quot;user&quot;</span>).password(<span class="hljs-string">&quot;&#123;bcrypt&#125;$2a$10$89rbg/..2V1hoRzXtlDa9ejjIzsqeO.kQgmkQnAa//xDzJLoyJgAu&quot;</span>).authorities(<span class="hljs-string">&quot;auth&quot;</span>).and()<br>.withUser(<span class="hljs-string">&quot;old&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;123&quot;</span>).authorities(<span class="hljs-string">&quot;old&quot;</span>);<br></code></pre></td></tr></table></figure><p>此时不需要再设置passwordEncoder，而是在密码中加上前缀进行区分。如以前的用户old，给其密码加上前缀{noop}，表示未加密。新用户密码前缀为{bcrypt}，表示bcrypt加密。系统为根据前缀自动识别你的加密方式。在自认定认证中，同样可以根据前缀判断加密方式。</p><h4 id="把密码存储到jdbc关系数据库中"><a href="#把密码存储到jdbc关系数据库中" class="headerlink" title="把密码存储到jdbc关系数据库中"></a>把密码存储到jdbc关系数据库中</h4><p>为了简单演示，使用嵌入式数据库H2</p><p>添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.h2database/h2 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.h2database<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>h2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.212<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>复制ddl文件到你的resources目录中,这个文件是创建表的sql</p><p>目录在spring security的core包的org&#x2F;springframework&#x2F;security&#x2F;core&#x2F;userdetails&#x2F;jdbc&#x2F;users.ddl</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> users(username varchar_ignorecase(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">primary</span> key,password varchar_ignorecase(<span class="hljs-number">500</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,enabled <span class="hljs-type">boolean</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>);<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> authorities (username varchar_ignorecase(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,authority varchar_ignorecase(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,<span class="hljs-keyword">constraint</span> fk_authorities_users <span class="hljs-keyword">foreign</span> key(username) <span class="hljs-keyword">references</span> users(username));<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">unique</span> index ix_auth_username <span class="hljs-keyword">on</span> authorities (username,authority);<br></code></pre></td></tr></table></figure><p>配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs jav">@Configuration<br>public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;<br><br>    @Bean<br>    public PasswordEncoder passwordEncoder() &#123;<br>        return new BCryptPasswordEncoder();<br>    &#125;<br><br>    @Bean<br>    DataSource dataSource() &#123;<br>        return new EmbeddedDatabaseBuilder()<br>                .setType(H2)<br>                .addScript(&quot;users.ddl&quot;)<br>                .build();<br>    &#125;<br><br>    @Bean<br>    public UserDetailsService users(DataSource dataSource) &#123;<br>        UserDetails user = User.builder()<br>                .username(&quot;user&quot;)<br>                .password(&quot;$2a$10$euvsO7nBJjnyRgtgLG7EfurLQD2cql6lHPMewpDxp7v8p2i0NZDVy&quot;)<br>                .roles(&quot;USER&quot;)<br>                .build();<br>        UserDetails admin = User.builder()<br>                .username(&quot;admin&quot;)<br>                .password(&quot;$2a$10$euvsO7nBJjnyRgtgLG7EfurLQD2cql6lHPMewpDxp7v8p2i0NZDVy&quot;)<br>                .roles(&quot;USER&quot;, &quot;ADMIN&quot;)<br>                .build();<br>        JdbcUserDetailsManager users = new JdbcUserDetailsManager(dataSource);<br>        users.createUser(user);<br>        users.createUser(admin);<br>        return users;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>测试同理。</p><h4 id="LDAP存储"><a href="#LDAP存储" class="headerlink" title="LDAP存储"></a>LDAP存储</h4><p>使用嵌入式的ldap</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.unboundid<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>unboundid-ldapsdk<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.14<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.security<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-security-ldap<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>compile<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>添加配置文件users.ldif</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">dn</span>: <span class="hljs-string">ou=groups,dc=springframework,dc=org</span><br><span class="hljs-attr">objectclass</span>: <span class="hljs-string">top</span><br><span class="hljs-attr">objectclass</span>: <span class="hljs-string">organizationalUnit</span><br><span class="hljs-attr">ou</span>: <span class="hljs-string">groups</span><br><br><span class="hljs-attr">dn</span>: <span class="hljs-string">ou=people,dc=springframework,dc=org</span><br><span class="hljs-attr">objectclass</span>: <span class="hljs-string">top</span><br><span class="hljs-attr">objectclass</span>: <span class="hljs-string">organizationalUnit</span><br><span class="hljs-attr">ou</span>: <span class="hljs-string">people</span><br><br><span class="hljs-attr">dn</span>: <span class="hljs-string">uid=admin,ou=people,dc=springframework,dc=org</span><br><span class="hljs-attr">objectclass</span>: <span class="hljs-string">top</span><br><span class="hljs-attr">objectclass</span>: <span class="hljs-string">person</span><br><span class="hljs-attr">objectclass</span>: <span class="hljs-string">organizationalPerson</span><br><span class="hljs-attr">objectclass</span>: <span class="hljs-string">inetOrgPerson</span><br><span class="hljs-attr">cn</span>: <span class="hljs-string">Rod Johnson</span><br><span class="hljs-attr">sn</span>: <span class="hljs-string">Johnson</span><br><span class="hljs-attr">uid</span>: <span class="hljs-string">admin</span><br><span class="hljs-attr">userPassword</span>: <span class="hljs-string">$2a$10$euvsO7nBJjnyRgtgLG7EfurLQD2cql6lHPMewpDxp7v8p2i0NZDVy</span><br><br><span class="hljs-attr">dn</span>: <span class="hljs-string">uid=user,ou=people,dc=springframework,dc=org</span><br><span class="hljs-attr">objectclass</span>: <span class="hljs-string">top</span><br><span class="hljs-attr">objectclass</span>: <span class="hljs-string">person</span><br><span class="hljs-attr">objectclass</span>: <span class="hljs-string">organizationalPerson</span><br><span class="hljs-attr">objectclass</span>: <span class="hljs-string">inetOrgPerson</span><br><span class="hljs-attr">cn</span>: <span class="hljs-string">Dianne Emu</span><br><span class="hljs-attr">sn</span>: <span class="hljs-string">Emu</span><br><span class="hljs-attr">uid</span>: <span class="hljs-string">user</span><br><span class="hljs-attr">userPassword</span>: <span class="hljs-string">$2a$10$euvsO7nBJjnyRgtgLG7EfurLQD2cql6lHPMewpDxp7v8p2i0NZDVy</span><br><br><span class="hljs-attr">dn</span>: <span class="hljs-string">cn=user,ou=groups,dc=springframework,dc=org</span><br><span class="hljs-attr">objectclass</span>: <span class="hljs-string">top</span><br><span class="hljs-attr">objectclass</span>: <span class="hljs-string">groupOfNames</span><br><span class="hljs-attr">cn</span>: <span class="hljs-string">user</span><br><br><span class="hljs-attr">dn</span>: <span class="hljs-string">cn=admin,ou=groups,dc=springframework,dc=org</span><br><span class="hljs-attr">objectclass</span>: <span class="hljs-string">top</span><br><span class="hljs-attr">objectclass</span>: <span class="hljs-string">groupOfNames</span><br><span class="hljs-attr">cn</span>: <span class="hljs-string">admin</span><br></code></pre></td></tr></table></figure><p>配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    UnboundIdContainer <span class="hljs-title function_">ldapContainer</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnboundIdContainer</span>(<span class="hljs-string">&quot;dc=springframework,dc=org&quot;</span>,<br>                <span class="hljs-string">&quot;classpath:users.ldif&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        auth.ldapAuthentication()<br>                .userDnPatterns(<span class="hljs-string">&quot;uid=&#123;0&#125;,ou=people&quot;</span>)<br>                .groupSearchBase(<span class="hljs-string">&quot;ou=groups&quot;</span>)<br>                .contextSource()<br>                .url(<span class="hljs-string">&quot;ldap://localhost:53389/dc=springframework,dc=org&quot;</span>)<br>                .and()<br>                .passwordCompare()<br>                .passwordEncoder(passwordEncoder())<br>                .passwordAttribute(<span class="hljs-string">&quot;userPassword&quot;</span>)<br>                .and()<br>                .ldapAuthoritiesPopulator(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LdapAuthoritiesPopulator</span>() &#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getGrantedAuthorities(DirContextOperations userData, String username) &#123;<br>                        <span class="hljs-keyword">return</span> Collections.emptyList();<br>                    &#125;<br>                &#125;);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>测试同上。</p><h4 id="自定义数据存储-一般使用这个"><a href="#自定义数据存储-一般使用这个" class="headerlink" title="自定义数据存储(一般使用这个)"></a>自定义数据存储(一般使用这个)</h4><p>添加UserDetailsService实现类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomUserDetailsService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-comment">// 从数据库获取用户</span><br>        <span class="hljs-keyword">if</span> (!username.equals(<span class="hljs-string">&quot;admin&quot;</span>)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernameNotFoundException</span>(<span class="hljs-string">&quot;用户不存在&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(username, <span class="hljs-string">&quot;$2a$10$euvsO7nBJjnyRgtgLG7EfurLQD2cql6lHPMewpDxp7v8p2i0NZDVy&quot;</span>, AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="hljs-string">&quot;admin1, admin2&quot;</span>));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    CustomUserDetailsService <span class="hljs-title function_">customUserDetailsService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomUserDetailsService</span>();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="并发会话控制（只在一个账号登录只存在一台设备上）"><a href="#并发会话控制（只在一个账号登录只存在一台设备上）" class="headerlink" title="并发会话控制（只在一个账号登录只存在一台设备上）"></a>并发会话控制（只在一个账号登录只存在一台设备上）</h3><p>（1）踢掉前面的登录</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.formLogin(Customizer.withDefaults())<br>                .authorizeRequests().anyRequest().authenticated();<br>        http.sessionManagement().maximumSessions(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    CustomUserDetailsService <span class="hljs-title function_">customUserDetailsService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomUserDetailsService</span>();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>（2）禁止新的登录</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.formLogin(Customizer.withDefaults())<br>                .authorizeRequests().anyRequest().authenticated();<br>        http.sessionManagement().maximumSessions(<span class="hljs-number">1</span>).maxSessionsPreventsLogin(<span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    CustomUserDetailsService <span class="hljs-title function_">customUserDetailsService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomUserDetailsService</span>();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="记住我"><a href="#记住我" class="headerlink" title="记住我"></a>记住我</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CustomUserDetailsService customUserDetailsService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.formLogin(Customizer.withDefaults())<br>                .authorizeRequests().anyRequest().authenticated();<br><br>        http.rememberMe().userDetailsService(customUserDetailsService).tokenValiditySeconds(<span class="hljs-number">3600</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    CustomUserDetailsService <span class="hljs-title function_">customUserDetailsService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomUserDetailsService</span>();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>登录时选择remember me ，登录后查看cookies会有一个remember me 的cookies，这时关闭浏览器不用重新登录。</p><h3 id="登出"><a href="#登出" class="headerlink" title="登出"></a>登出</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CustomUserDetailsService customUserDetailsService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.formLogin().permitAll();<br>        http.logout().logoutUrl(<span class="hljs-string">&quot;/logout&quot;</span>).logoutSuccessHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LogoutSuccessHandler</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLogoutSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>                System.out.println(<span class="hljs-string">&quot;退出成功&quot;</span>);<br>            &#125;<br>        &#125;);<br>        http.authorizeRequests().anyRequest().authenticated();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    CustomUserDetailsService <span class="hljs-title function_">customUserDetailsService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomUserDetailsService</span>();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>还是不能自定义退出接口</p><h3 id="无权限403错误处理"><a href="#无权限403错误处理" class="headerlink" title="无权限403错误处理"></a>无权限403错误处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CustomUserDetailsService customUserDetailsService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.formLogin().permitAll();<br>        http.logout().logoutUrl(<span class="hljs-string">&quot;/logout&quot;</span>).logoutSuccessHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LogoutSuccessHandler</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLogoutSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>                System.out.println(<span class="hljs-string">&quot;退出成功&quot;</span>);<br>            &#125;<br>        &#125;);<br>        http.exceptionHandling().accessDeniedHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AccessDeniedHandler</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>                System.out.println(<span class="hljs-string">&quot;处理无权限错误返回JSON&quot;</span>);<br>                <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">printWriter</span> <span class="hljs-operator">=</span> response.getWriter();<br>                printWriter.println(<span class="hljs-string">&quot;处理无权限错误返回JSON&quot;</span>);<br>                printWriter.flush();<br>                printWriter.close();<br>            &#125;<br>        &#125;);<br>        http.authorizeRequests().antMatchers(<span class="hljs-string">&quot;/login/success&quot;</span>).hasAnyRole(<span class="hljs-string">&quot;admin&quot;</span>);<br>        http.authorizeRequests().anyRequest().authenticated();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    CustomUserDetailsService <span class="hljs-title function_">customUserDetailsService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomUserDetailsService</span>();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h3><p>http.authorizeRequests() 就是授权。</p><table><thead><tr><th><code>hasRole(String role)</code></th><th>返回<code>true</code>当前主体是否具有指定角色。例如，<code>hasRole(&#39;admin&#39;)</code>默认情况下，如果提供的角色不以“ROLE_”开头，它将被添加。这可以通过修改<code>defaultRolePrefix</code>on来定制<code>DefaultWebSecurityExpressionHandler</code>。</th></tr></thead><tbody><tr><td><code>hasAnyRole(String… roles)</code></td><td>返回<code>true</code>当前主体是否具有任何提供的角色（以逗号分隔的字符串列表形式给出）。例如，<code>hasAnyRole(&#39;admin&#39;, &#39;user&#39;)</code>默认情况下，如果提供的角色不以“ROLE_”开头，它将被添加。这可以通过修改<code>defaultRolePrefix</code>on来定制<code>DefaultWebSecurityExpressionHandler</code>。</td></tr><tr><td><code>hasAuthority(String authority)</code></td><td><code>true</code>如果当前委托人具有指定的权限，则返回。例如，<code>hasAuthority(&#39;read&#39;)</code></td></tr><tr><td><code>hasAnyAuthority(String… authorities)</code></td><td>返回<code>true</code>当前主体是否具有任何提供的权限（以逗号分隔的字符串列表形式给出）例如，<code>hasAnyAuthority(&#39;read&#39;, &#39;write&#39;)</code></td></tr><tr><td><code>principal</code></td><td>允许直接访问代表当前用户的主体对象</td></tr><tr><td><code>authentication</code></td><td>允许直接访问<code>Authentication</code>从<code>SecurityContext</code></td></tr><tr><td><code>permitAll</code></td><td>总是评估为<code>true</code></td></tr><tr><td><code>denyAll</code></td><td>总是评估为<code>false</code></td></tr><tr><td><code>isAnonymous()</code></td><td>返回<code>true</code>当前主体是否为匿名用户</td></tr><tr><td><code>isRememberMe()</code></td><td><code>true</code>如果当前主体是记住我的用户，则返回</td></tr><tr><td><code>isAuthenticated()</code></td><td><code>true</code>如果用户不是匿名的，则返回</td></tr><tr><td><code>isFullyAuthenticated()</code></td><td><code>true</code>如果用户不是匿名用户或记住我的用户，则返回</td></tr><tr><td><code>hasPermission(Object target, Object permission)</code></td><td>返回<code>true</code>用户是否有权访问给定权限的目标。例如，<code>hasPermission(domainObject, &#39;read&#39;)</code></td></tr><tr><td><code>hasPermission(Object targetId, String targetType, Object permission)</code></td><td>返回<code>true</code>用户是否有权访问给定权限的目标。例如，<code>hasPermission(1, &#39;com.example.domain.Message&#39;, &#39;read&#39;)</code></td></tr></tbody></table><p>有四个注释支持表达式属性，以允许调用前和调用后的授权检查，还支持过滤提交的集合参数或返回值。它们是@PreAuthorize、@PreFilter和@PostAuthorize、@PostFilter。</p><h4 id="自定义权限验证bean"><a href="#自定义权限验证bean" class="headerlink" title="自定义权限验证bean"></a>自定义权限验证bean</h4><p>自定义验证bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurity</span> &#123;<br><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">check</span><span class="hljs-params">(String permission)</span> &#123;<br><span class="hljs-comment">// 获取用户的权限</span><br>Set&lt;String&gt; permissions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br><span class="hljs-comment">// 自定义  模块  用户  添加功能</span><br>permissions.add(<span class="hljs-string">&quot;userManage:user:add&quot;</span>);<br><span class="hljs-keyword">if</span> (permissions.contains(permission)) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> &#123;<br><br>    <span class="hljs-meta">@PreAuthorize(&quot;@webSecurity.check(&#x27;userManage:user:add&#x27;)&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">index</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success.....&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@PreAuthorize(&quot;@webSecurity.check(&#x27;userManage:user:aa&#x27;)&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/index1&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">index1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;index1.....&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/error&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">error</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error.....&quot;</span>;<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CustomUserDetailsService customUserDetailsService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.formLogin().permitAll();<br>        http.logout().logoutUrl(<span class="hljs-string">&quot;/logout&quot;</span>).logoutSuccessHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LogoutSuccessHandler</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLogoutSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>                System.out.println(<span class="hljs-string">&quot;退出成功&quot;</span>);<br>            &#125;<br>        &#125;);<br>        http.exceptionHandling().accessDeniedHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AccessDeniedHandler</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>                System.out.println(<span class="hljs-string">&quot;处理无权限错误返回JSON&quot;</span>);<br>                <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">printWriter</span> <span class="hljs-operator">=</span> response.getWriter();<br>                printWriter.println(<span class="hljs-string">&quot;处理无权限错误返回JSON&quot;</span>);<br>                printWriter.flush();<br>                printWriter.close();<br>            &#125;<br>        &#125;);<br>        http.authorizeRequests().anyRequest().authenticated();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    CustomUserDetailsService <span class="hljs-title function_">customUserDetailsService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomUserDetailsService</span>();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="使用默认的"><a href="#使用默认的" class="headerlink" title="使用默认的"></a>使用默认的</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomUserDetailsService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-comment">// 从数据库获取用户</span><br>        <span class="hljs-keyword">if</span> (!username.equals(<span class="hljs-string">&quot;admin&quot;</span>)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernameNotFoundException</span>(<span class="hljs-string">&quot;用户不存在&quot;</span>);<br>        &#125;<br>        Set&lt;GrantedAuthority&gt; authoritySet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>        <span class="hljs-type">SimpleGrantedAuthority</span> <span class="hljs-variable">role</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleGrantedAuthority</span>(<span class="hljs-string">&quot;ROLE_admin1&quot;</span>);<br>        authoritySet.add(role);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(username, <span class="hljs-string">&quot;$2a$10$euvsO7nBJjnyRgtgLG7EfurLQD2cql6lHPMewpDxp7v8p2i0NZDVy&quot;</span>, authoritySet);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginController</span> &#123;<br><br><span class="hljs-meta">@PreAuthorize(&quot;hasRole(&#x27;admin1&#x27;)&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/login/&#123;status&#125;&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String status)</span> &#123;<br>System.out.println(status);<br><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;auth&quot;</span>.equals(status)) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;没有登录&quot;</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;fail&quot;</span>.equals(status)) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;登录失败&quot;</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;success&quot;</span>.equals(status)) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;登录成功&quot;</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;logout&quot;</span>.equals(status)) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;注销成功&quot;</span>;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="整合JWT"><a href="#整合JWT" class="headerlink" title="整合JWT"></a>整合JWT</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.auth0<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>java-jwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.19.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomUserDetailsService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-comment">// 从数据库获取用户</span><br>        <span class="hljs-keyword">if</span> (!username.equals(<span class="hljs-string">&quot;admin&quot;</span>)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernameNotFoundException</span>(<span class="hljs-string">&quot;用户不存在&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(username, <span class="hljs-string">&quot;$2a$10$euvsO7nBJjnyRgtgLG7EfurLQD2cql6lHPMewpDxp7v8p2i0NZDVy&quot;</span>, AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="hljs-string">&quot;admin1, admin2&quot;</span>));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginController</span> &#123;<br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> AuthenticationManager authenticationManager;<br><br><span class="hljs-meta">@GetMapping(value = &quot;/login&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">Login</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;username&quot;)</span> String username,</span><br><span class="hljs-params"><span class="hljs-meta">@RequestParam(&quot;password&quot;)</span> String password)</span> &#123;<br><span class="hljs-comment">// 用户验证</span><br><span class="hljs-type">Authentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">try</span><br>&#123;<br><span class="hljs-comment">// 该方法会去调用UserDetailsServiceImpl.loadUserByUsername</span><br>authentication = authenticationManager<br>.authenticate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(username, password));<br>&#125;<br><span class="hljs-keyword">catch</span> (Exception e)<br>&#123;<br><span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> BadCredentialsException)<br>&#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e.getMessage());<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e.getMessage());<br>&#125;<br>&#125;<br>Map&lt;String, String&gt; claimMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>claimMap.put(<span class="hljs-string">&quot;username&quot;</span>, <span class="hljs-string">&quot;abc&quot;</span>);<br><span class="hljs-keyword">return</span> TokenUtli.GenerateToken(claimMap);<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">index</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success.....&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/error&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">error</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error.....&quot;</span>;<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenUtli</span> &#123;<br><br>    <span class="hljs-comment">//Issuer</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ISSUER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;auth0&quot;</span>;<br>    <span class="hljs-comment">//Audience</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">AUDIENCE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Client&quot;</span>;<br>    <span class="hljs-comment">//密钥</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;123456&quot;</span>;<br>    <span class="hljs-comment">//算法</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Algorithm</span> <span class="hljs-variable">ALGORITHM</span> <span class="hljs-operator">=</span> Algorithm.HMAC256(TokenUtli.KEY);<br>    <span class="hljs-comment">//Header</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; HEADER_MAP = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;() &#123;<br>        &#123;<br>            put(<span class="hljs-string">&quot;alg&quot;</span>, <span class="hljs-string">&quot;HS256&quot;</span>);<br>            put(<span class="hljs-string">&quot;typ&quot;</span>, <span class="hljs-string">&quot;JWT&quot;</span>);<br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成 Token 字符串</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> claimMap claim 数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Token 字符串</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">GenerateToken</span><span class="hljs-params">(Map&lt;String, String&gt; claimMap)</span> &#123;<br>        <span class="hljs-type">Date</span> <span class="hljs-variable">nowDate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br>        <span class="hljs-comment">//120 分钟过期</span><br>        <span class="hljs-type">Date</span> <span class="hljs-variable">expireDate</span> <span class="hljs-operator">=</span> TokenUtli.AddDate(nowDate, <span class="hljs-number">2</span> * <span class="hljs-number">60</span>);<br><br>        <span class="hljs-comment">//Token 建造器</span><br>        JWTCreator.<span class="hljs-type">Builder</span> <span class="hljs-variable">tokenBuilder</span> <span class="hljs-operator">=</span> JWT.create();<br><br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : claimMap.entrySet()) &#123;<br>            <span class="hljs-comment">//Payload 部分，根据需求添加</span><br>            tokenBuilder.withClaim(entry.getKey(), entry.getValue());<br>        &#125;<br><br>        <span class="hljs-comment">//token 字符串</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> tokenBuilder.withHeader(TokenUtli.HEADER_MAP)<span class="hljs-comment">//Header 部分</span><br>                .withIssuer(TokenUtli.ISSUER)<span class="hljs-comment">//issuer</span><br>                .withAudience(TokenUtli.AUDIENCE)<span class="hljs-comment">//audience</span><br>                .withIssuedAt(nowDate)<span class="hljs-comment">//生效时间</span><br>                .withExpiresAt(expireDate)<span class="hljs-comment">//过期时间</span><br>                .sign(TokenUtli.ALGORITHM);<span class="hljs-comment">//签名，算法加密</span><br><br>        <span class="hljs-keyword">return</span> token;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 时间加法</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> date   当前时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> minute 持续时间（分钟）</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 时间加法结果</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Date <span class="hljs-title function_">AddDate</span><span class="hljs-params">(Date date, Integer minute)</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == date) &#123;<br>            date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br>        &#125;<br>        <span class="hljs-type">Calendar</span> <span class="hljs-variable">calendar</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GregorianCalendar</span>();<br>        calendar.setTime(date);<br>        calendar.add(Calendar.MINUTE, minute);<br><br>        <span class="hljs-keyword">return</span> calendar.getTime();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 验证 Token</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> webToken 前端传递的 Token 字符串</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Token 字符串是否正确</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception 异常信息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">VerifyJWTToken</span><span class="hljs-params">(String webToken)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(webToken)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        String[] token = webToken.split(<span class="hljs-string">&quot; &quot;</span>);<br>        <span class="hljs-keyword">if</span> (token.length &lt;= <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;token错误&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (token[<span class="hljs-number">1</span>].equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;token错误&quot;</span>);<br>        &#125;<br><br><br>        <span class="hljs-comment">//JWT验证器</span><br>        <span class="hljs-type">JWTVerifier</span> <span class="hljs-variable">verifier</span> <span class="hljs-operator">=</span> JWT.require(TokenUtli.ALGORITHM).withIssuer(TokenUtli.ISSUER).build();<br><br>        <span class="hljs-comment">//解码</span><br>        <span class="hljs-type">DecodedJWT</span> <span class="hljs-variable">jwt</span> <span class="hljs-operator">=</span> verifier.verify(token[<span class="hljs-number">1</span>]);<span class="hljs-comment">//如果 token 过期，此处就会抛出异常</span><br><br>        <span class="hljs-comment">//Audience</span><br>        List&lt;String&gt; audienceList = jwt.getAudience();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">audience</span> <span class="hljs-operator">=</span> audienceList.get(<span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">//Payload</span><br>        Map&lt;String, Claim&gt; claimMap = jwt.getClaims();<br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Claim&gt; entry : claimMap.entrySet()) &#123;<br><br>        &#125;<br><br>        <span class="hljs-comment">//生效时间</span><br>        <span class="hljs-type">Date</span> <span class="hljs-variable">issueTime</span> <span class="hljs-operator">=</span> jwt.getIssuedAt();<br>        <span class="hljs-comment">//过期时间</span><br>        <span class="hljs-type">Date</span> <span class="hljs-variable">expiresTime</span> <span class="hljs-operator">=</span> jwt.getExpiresAt();<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;String, Claim&gt; <span class="hljs-title function_">parseToken</span><span class="hljs-params">(String webToken)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(webToken)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        String[] token = webToken.split(<span class="hljs-string">&quot; &quot;</span>);<br>        <span class="hljs-keyword">if</span> (token.length &lt;= <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;token错误&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (token[<span class="hljs-number">1</span>].equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;token错误&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//JWT验证器</span><br>        <span class="hljs-type">JWTVerifier</span> <span class="hljs-variable">verifier</span> <span class="hljs-operator">=</span> JWT.require(TokenUtli.ALGORITHM).withIssuer(TokenUtli.ISSUER).build();<br><br>        <span class="hljs-comment">//解码</span><br>        <span class="hljs-type">DecodedJWT</span> <span class="hljs-variable">jwt</span> <span class="hljs-operator">=</span> verifier.verify(token[<span class="hljs-number">1</span>]);<span class="hljs-comment">//如果 token 过期，此处就会抛出异常</span><br>        <span class="hljs-keyword">return</span> jwt.getClaims();<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtAuthenticationTokenFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OncePerRequestFilter</span><br>&#123;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span><br>            <span class="hljs-keyword">throws</span> ServletException, IOException<br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> getToken(request);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Map&lt;String, Claim&gt; map = TokenUtli.parseToken(token);<br>            <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span> &amp;&amp;  map.get(<span class="hljs-string">&quot;username&quot;</span>) != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">&quot;username&quot;</span>).asString();<br>                <span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">authenticationToken</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(username, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>                authenticationToken.setDetails(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAuthenticationDetailsSource</span>().buildDetails(request));<br>                SecurityContextHolder.getContext().setAuthentication(authenticationToken);<br>            &#125;<br>            chain.doFilter(request, response);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            System.out.println(<span class="hljs-string">&quot;报错了&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getToken</span><span class="hljs-params">(HttpServletRequest request)</span><br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;Authorization&quot;</span>);<br>        <span class="hljs-keyword">return</span> token;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java">EnableGlobalMethodSecurity(prePostEnabled = <span class="hljs-literal">true</span>, securedEnabled = <span class="hljs-literal">true</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> JwtAuthenticationTokenFilter authenticationTokenFilter;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> PasswordEncoder passwordEncoder;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CustomUserDetailsService customUserDetailsService;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 解决 无法直接注入 AuthenticationManager</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">authenticationManagerBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.authenticationManagerBean();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// CSRF禁用，因为不使用session</span><br>        http.csrf().disable();<br>        <span class="hljs-comment">// 基于token，所以不需要session</span><br>        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);<br>        <span class="hljs-comment">// 对于登录login 注册register 验证码captchaImage 允许匿名访问</span><br>        http.authorizeRequests().antMatchers(<span class="hljs-string">&quot;/login&quot;</span>).permitAll();<br>        http.authorizeRequests().anyRequest().authenticated();<br>        http.addFilterBefore(authenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 身份认证接口</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        auth.userDetailsService(customUserDetailsService).passwordEncoder(passwordEncoder);<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="rouyi配置详解"><a href="#rouyi配置详解" class="headerlink" title="rouyi配置详解"></a>rouyi配置详解</h3><p>还是看rouyi项目吧</p>]]></content>
    
    
    <categories>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>oauth参考</title>
    <link href="/2022/05/19/%E6%9D%83%E9%99%90%E6%A1%86%E6%9E%B6/oauth/"/>
    <url>/2022/05/19/%E6%9D%83%E9%99%90%E6%A1%86%E6%9E%B6/oauth/</url>
    
    <content type="html"><![CDATA[<p><a href="https://oauth.net/">https://oauth.net/</a> 官网</p><p><a href="http://blog.csdn.net/dreamkid0924/article/details/53284863">http://blog.csdn.net/dreamkid0924/article/details/53284863</a> OAuth完全手册_国内篇</p><p><a href="https://huoding.com/2011/11/08/126">https://huoding.com/2011/11/08/126</a> OAuth的改变</p>]]></content>
    
    
    <categories>
      
      <category>oauth</category>
      
    </categories>
    
    
    <tags>
      
      <tag>oauth</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SSO单点登录</title>
    <link href="/2022/05/19/%E6%9D%83%E9%99%90%E6%A1%86%E6%9E%B6/SSO%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/"/>
    <url>/2022/05/19/%E6%9D%83%E9%99%90%E6%A1%86%E6%9E%B6/SSO%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<h2 id="SSO"><a href="#SSO" class="headerlink" title="SSO"></a>SSO</h2><p>Single Sign On,简称SSO，SSO使得在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>实现方式一：父域 Cookie</p><p>Cookie 的作用域由 domain 属性和 path 属性共同决定。domain 属性的有效值为当前域或其父域的域名&#x2F;IP地址，在 Tomcat 中，domain 属性默认为当前域的域名&#x2F;IP地址。path 属性的有效值是以“&#x2F;”开头的路径，在 Tomcat 中，path 属性默认为当前 Web 应用的上下文路径。</p><p>如果将 Cookie 的 domain 属性设置为当前域的父域，那么就认为它是父域 Cookie。Cookie 有一个特点，即父域中的 Cookie 被子域所共享，换言之，子域会自动继承父域中的Cookie。</p><p>利用 Cookie 的这个特点，不难想到，将 Session ID（或 Token）保存到父域中不就行了。没错，我们只需要将 Cookie 的 domain 属性设置为父域的域名（主域名），同时将 Cookie 的 path 属性设置为根路径，这样所有的子域应用就都可以访问到这个 Cookie 了。不过这要求应用系统的域名需建立在一个共同的主域名之下，如 tieba.baidu.com 和 map.baidu.com，它们都建立在 baidu.com 这个主域名之下，那么它们就可以通过这种方式来实现单点登录。</p><p>总结：此种实现方式比较简单，但不支持跨主域名。<br>实现方式二：认证中心</p><p>我们可以部署一个认证中心，认证中心就是一个专门负责处理登录请求的独立的 Web 服务。</p><p>用户统一在认证中心进行登录，登录成功后，认证中心记录用户的登录状态，并将 Token 写入 Cookie。（注意这个 Cookie 是认证中心的，应用系统是访问不到的。）</p><p>应用系统检查当前请求有没有 Token，如果没有，说明用户在当前系统中尚未登录，那么就将页面跳转至认证中心。由于这个操作会将认证中心的 Cookie 自动带过去，因此，认证中心能够根据 Cookie 知道用户是否已经登录过了。如果认证中心发现用户尚未登录，则返回登录页面，等待用户登录，如果发现用户已经登录过了，就不会让用户再次登录了，而是会跳转回目标 URL ，并在跳转前生成一个 Token，拼接在目标 URL 的后面，回传给目标应用系统。</p><p>应用系统拿到 Token 之后，还需要向认证中心确认下 Token 的合法性，防止用户伪造。确认无误后，应用系统记录用户的登录状态，并将 Token 写入 Cookie，然后给本次访问放行。（注意这个 Cookie 是当前应用系统的，其他应用系统是访问不到的。）当用户再次访问当前应用系统时，就会自动带上这个 Token，应用系统验证 Token 发现用户已登录，于是就不会有认证中心什么事了。</p><p>这里顺便介绍两款认证中心的开源实现：</p><p>Apereo CAS 是一个企业级单点登录系统，其中 CAS 的意思是”Central Authentication Service“。它最初是耶鲁大学实验室的项目，后来转让给了 JASIG 组织，项目更名为 JASIG CAS，后来该组织并入了Apereo 基金会，项目也随之更名为 Apereo CAS。</p><p>XXL-SSO 是一个简易的单点登录系统，由大众点评工程师许雪里个人开发，代码比较简单，没有做安全控制，因而不推荐直接应用在项目中，这里列出来仅供参考。</p><p>总结：此种实现方式相对复杂，支持跨域，扩展性好，是单点登录的标准做法。</p><p>LocalStorage 跨域<br>前面，我们说实现单点登录的关键在于，如何让 Session ID（或 Token）在多个域中共享。</p><p>父域 Cookie 确实是一种不错的解决方案，但是不支持跨域。那么有没有什么奇淫技巧能够让 Cookie 跨域传递呢？</p><p>很遗憾，浏览器对 Cookie 的跨域限制越来越严格。Chrome 浏览器还给 Cookie 新增了一个 SameSite 属性，此举几乎禁止了一切跨域请求的 Cookie 传递（超链接除外），并且只有当使用 HTTPs 协议时，才有可能被允许在 AJAX 跨域请求中接受服务器传来的 Cookie。</p><p>不过，在前后端分离的情况下，完全可以不使用 Cookie，我们可以选择将 Session ID （或 Token ）保存到浏览器的 LocalStorage 中，让前端在每次向后端发送请求时，主动将 LocalStorage 的数据传递给服务端。这些都是由前端来控制的，后端需要做的仅仅是在用户登录成功后，将 Session ID （或 Token ）放在响应体中传递给前端。</p><p>在这样的场景下，单点登录完全可以在前端实现。前端拿到 Session ID （或 Token ）后，除了将它写入自己的 LocalStorage 中之外，还可以通过特殊手段将它写入多个其他域下的 LocalStorage 中。</p><figure class="highlight js"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 获取 token</span><br><span class="hljs-keyword">var</span> token = result.<span class="hljs-property">data</span>.<span class="hljs-property">token</span>;<br> <br><span class="hljs-comment">// 动态创建一个不可见的iframe，在iframe中加载一个跨域HTML</span><br><span class="hljs-keyword">var</span> iframe = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&quot;iframe&quot;</span>);<br>iframe.<span class="hljs-property">src</span> = <span class="hljs-string">&quot;http://app1.com/localstorage.html&quot;</span>;<br><span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">append</span>(iframe);<br><span class="hljs-comment">// 使用postMessage()方法将token传递给iframe</span><br><span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    iframe.<span class="hljs-property">contentWindow</span>.<span class="hljs-title function_">postMessage</span>(token, <span class="hljs-string">&quot;http://app1.com&quot;</span>);<br>&#125;, <span class="hljs-number">4000</span>);<br><span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    iframe.<span class="hljs-title function_">remove</span>();<br>&#125;, <span class="hljs-number">6000</span>);<br> <br><span class="hljs-comment">// 在这个iframe所加载的HTML中绑定一个事件监听器，当事件被触发时，把接收到的token数据写入localStorage</span><br><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) &#123;<br>    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&#x27;token&#x27;</span>, event.<span class="hljs-property">data</span>)<br>&#125;, <span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></figure><p>前端通过 iframe+postMessage() 方式，将同一份 Token 写入到了多个域下的 LocalStorage 中，前端每次在向后端发送请求之前，都会主动从 LocalStorage 中读取 Token 并在请求中携带，这样就实现了同一份 Token 被多个域所共享。</p><p>总结：此种实现方式完全由前端控制，几乎不需要后端参与，同样支持跨域。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cnblogs.com/ywlaker/p/6113927.html">https://www.cnblogs.com/ywlaker/p/6113927.html</a> 单点登录原理与简单实现</p>]]></content>
    
    
    <categories>
      
      <category>SSO</category>
      
    </categories>
    
    
    <tags>
      
      <tag>SSO</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql查看死锁</title>
    <link href="/2022/05/18/mysql/mysql%E6%9F%A5%E7%9C%8B%E6%AD%BB%E9%94%81/"/>
    <url>/2022/05/18/mysql/mysql%E6%9F%A5%E7%9C%8B%E6%AD%BB%E9%94%81/</url>
    
    <content type="html"><![CDATA[<h2 id="查看死锁"><a href="#查看死锁" class="headerlink" title="查看死锁"></a>查看死锁</h2><p>查看innodb的状态</p><figure class="highlight sql"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> engine innodb status;<br></code></pre></td></tr></table></figure><p>这里可以看到mysql检测到的死锁。</p><p>查看正在进行中的事务</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> information_schema.INNODB_TRX;<br></code></pre></td></tr></table></figure><p>查看正在锁的事务</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> INFORMATION_SCHEMA.INNODB_LOCKS;<br></code></pre></td></tr></table></figure><p>查看等待锁的事务</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> INFORMATION_SCHEMA.INNODB_LOCK_WAITS;<br></code></pre></td></tr></table></figure><p>查看正在用的表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">OPEN</span> TABLES <span class="hljs-keyword">where</span> In_use <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><p>查看过程列表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> processlist;<br><span class="hljs-comment">-- 或者</span><br><span class="hljs-keyword">select</span><span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> information_schema.processlist;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql语句分析</title>
    <link href="/2022/05/18/mysql/mysql%E8%AF%AD%E5%8F%A5%E5%88%86%E6%9E%90/"/>
    <url>/2022/05/18/mysql/mysql%E8%AF%AD%E5%8F%A5%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="慢查询"><a href="#慢查询" class="headerlink" title="慢查询"></a>慢查询</h1><p>set long_query_time&#x3D;0;是将慢查询的阈值设置为0。表示这个线程接下来的的语句都会被记录到慢查询日志中。<br>show variables like ‘%datadir%’ 查看数据存储路径</p><p>show variables like ‘%slow_query_log%’ 查看慢查询日志存储路径</p><p>打开C:\ProgramData\MySQL\MySQL Server 8.0\Data\DESKTOP-80FPTP3-slow.log文件查看</p><h2 id="慢查询日志存储的格式："><a href="#慢查询日志存储的格式：" class="headerlink" title="慢查询日志存储的格式："></a>慢查询日志存储的格式：</h2><p>执行sql的主机信息</p><p># User@Host: root[root] @ localhost [::1] Id:   9</p><p>sql的执行信息</p><p># Query_time: 0.314725 Lock_time: 0.001232 Rows_sent: 1 Rows_examined: 0</p><p>sql的执行时间</p><p>SET timestamp&#x3D;1635296227;</p><p>sql的内容</p><p>select count(*) from t;</p><h2 id="慢查询："><a href="#慢查询：" class="headerlink" title="慢查询："></a>慢查询：</h2><p>1.直接查看show variables like ‘%slow_query_log%’ 查看慢查询日志存储路径</p><p>2.show global status like ‘%slow%’; 查看慢查询的记数器</p><p>3.show processlist展示的内容是从<code>information_schema.processlist</code>数据表查询得到。</p><p>  select* from information_schema.processlist where Host like ‘10.26.201.199%’;</p><h2 id="在-MySQL-中，会引发性能问题的慢查询"><a href="#在-MySQL-中，会引发性能问题的慢查询" class="headerlink" title="在 MySQL 中，会引发性能问题的慢查询"></a>在 MySQL 中，会引发性能问题的慢查询</h2><p>大体有以下三种可能：</p><p>索引没有设计好；</p><p>SQL 语句没写好；</p><p>MySQL 选错了索引。</p><h2 id="涉及参数"><a href="#涉及参数" class="headerlink" title="涉及参数"></a>涉及参数</h2><p>show variables like ‘%slow_query_log%’</p><p>show global status like ‘%slow%’;</p><h1 id="insert（P40）"><a href="#insert（P40）" class="headerlink" title="insert（P40）"></a>insert（P40）</h1><h2 id="insert-…-select-语句"><a href="#insert-…-select-语句" class="headerlink" title="insert … select 语句"></a>insert … select 语句</h2><figure class="highlight sql"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t` (<br>  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `c` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `d` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>  <span class="hljs-keyword">UNIQUE</span> KEY `c` (`c`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB;<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t <span class="hljs-keyword">values</span>(<span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t <span class="hljs-keyword">values</span>(<span class="hljs-keyword">null</span>, <span class="hljs-number">2</span>,<span class="hljs-number">2</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t <span class="hljs-keyword">values</span>(<span class="hljs-keyword">null</span>, <span class="hljs-number">3</span>,<span class="hljs-number">3</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t <span class="hljs-keyword">values</span>(<span class="hljs-keyword">null</span>, <span class="hljs-number">4</span>,<span class="hljs-number">4</span>);<br><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t2 <span class="hljs-keyword">like</span> t<br></code></pre></td></tr></table></figure><p>为什么在可重复读隔离级别下，binlog_format&#x3D;statement 时执行,</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t2(c,d) <span class="hljs-keyword">select</span> c,d <span class="hljs-keyword">from</span> t;<br></code></pre></td></tr></table></figure><p>需要对表 t 的所有行和间隙加锁呢?</p><p>如果没有锁的话，就可能出现 session B 的 insert 语句先执行，但是后写入 binlog 的情况。</p><p>![insertselect并发 insert 场景](mysqlimg&#x2F;insertselect并发 insert 场景.webp)</p><p>于是，在 binlog_format&#x3D;statement 的情况下，binlog 里面就记录了这样的语句序列：</p><p>insert into t values(-1,-1,-1);<br>insert into t2(c,d) select c,d from t;</p><p>这个语句到了备库执行，就会把 id&#x3D;-1 这一行也写到表 t2 中，出现主备不一致。</p><p>所以需要给表 t 的所有行和间隙加锁。</p><h2 id="insert-循环写入"><a href="#insert-循环写入" class="headerlink" title="insert 循环写入"></a>insert 循环写入</h2><p>扫描行数为1：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t2(c,d) (<span class="hljs-keyword">select</span> c<span class="hljs-operator">+</span><span class="hljs-number">1</span>, d <span class="hljs-keyword">from</span> t force index(c) <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> c <span class="hljs-keyword">desc</span> limit <span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p>扫描行数为5：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t(c,d) (<span class="hljs-keyword">select</span> c<span class="hljs-operator">+</span><span class="hljs-number">1</span>, d <span class="hljs-keyword">from</span> t force index(c) <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> c <span class="hljs-keyword">desc</span> limit <span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t(c,d) (<span class="hljs-keyword">select</span> c<span class="hljs-operator">+</span><span class="hljs-number">1</span>, d <span class="hljs-keyword">from</span> t force index(c) <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> c <span class="hljs-keyword">desc</span> limit <span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p>从 Extra 字段可以看到“Using temporary”字样，表示这个语句用到了临时表。</p><p>执行过程:</p><p>1.创建临时表，表里有两个字段 c 和 d。</p><p>2.按照索引 c 扫描表 t，依次取 c&#x3D;4、3、2、1，然后回表，读到 c 和 d 的值写入临时表。</p><p>3.这时，Rows_examined&#x3D;4。</p><p>4.由于语义里面有 limit 1，所以只取了临时表的第一行，再插入到表 t 中。这时，Rows_examined 的值加 1，变成了 5。</p><p>这个语句的执行为什么需要临时表，原因是这类一边遍历数据，一边更新数据的情况，如果读出来的数据直接写回原表，就可能在遍历过程中，读到刚刚插入的记录，新插入的记录如果参与计算逻辑，就跟语义不符。</p><p>由于实现上这个语句没有在子查询中就直接使用 limit 1，从而导致了这个语句的执行需要遍历整个表 t。它的优化方法也比较简单，就是用前面介绍的方法，先 insert into 到临时表 temp_t，这样就只需要扫描一行；然后再从表 temp_t 里面取出这行数据插入表 t1。</p><p>create temporary table temp_t(c int,d int) engine&#x3D;memory;<br>insert into temp_t (select c+1, d from t force index(c) order by c desc limit 1);<br>insert into t select * from temp_t;<br>drop table temp_t;</p><h2 id="insert-唯一键冲突"><a href="#insert-唯一键冲突" class="headerlink" title="insert 唯一键冲突"></a>insert 唯一键冲突</h2><p><img src="/.com//insert%E5%94%AF%E4%B8%80%E9%94%AE%E5%8A%A0%E9%94%81.webp" alt="insert唯一键加锁"></p><p>这个例子也是在可重复读（repeatable read）隔离级别下执行的。可以看到，session B 要执行的 insert 语句进入了锁等待状态。</p><p>已经得到修复 <a href="https://bugs.mysql.com/bug.php?id=93806">https://bugs.mysql.com/bug.php?id=93806</a></p><h2 id="惟一键冲突导致死锁"><a href="#惟一键冲突导致死锁" class="headerlink" title="惟一键冲突导致死锁"></a>惟一键冲突导致死锁</h2><p><img src="/.com//insert%E5%94%AF%E4%B8%80%E9%94%AE%E5%86%B2%E7%AA%81%E6%AD%BB%E9%94%81.webp" alt="insert唯一键冲突死锁"></p><p>在 session A 执行 rollback 语句回滚的时候，session C 几乎同时发现死锁并返回。</p><p>这个死锁产生的逻辑是这样的：</p><p>1.在 T1 时刻，启动 session A，并执行 insert 语句，此时在索引 c 的 c&#x3D;5 上加了记录锁。注意，这个索引是唯一索引，因此退化为记录锁.</p><p>2.在 T2 时刻，session B 要执行相同的 insert 语句，发现了唯一键冲突，加上读锁；同样地，session C 也在索引 c 上，c&#x3D;5 这一个记录上，加了读锁。</p><p>3.T3 时刻，session A 回滚。这时候，session B 和 session C 都试图继续执行插入操作，都要加上写锁。两个 session 都要等待对方的行锁，所以就出现了死锁。</p><p>insert into … on duplicate key update</p><p>上面这个例子是主键冲突后直接报错，如果是改写成</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t <span class="hljs-keyword">values</span>(<span class="hljs-number">11</span>,<span class="hljs-number">10</span>,<span class="hljs-number">10</span>) <span class="hljs-keyword">on</span> duplicate key <span class="hljs-keyword">update</span> d<span class="hljs-operator">=</span><span class="hljs-number">100</span>; <br></code></pre></td></tr></table></figure><p>的话，就会给索引 c 上 (5,10] 加一个排他的 next-key lock（写锁）。</p><p>insert into … on duplicate key update 这个语义的逻辑是，插入一行数据，如果碰到唯一键约束，就执行后面的更新语句。</p><p>注意，如果有多个列违反了唯一性约束，就会按照索引的顺序，修改跟第一个索引冲突的行。</p><p>需要注意的是，执行这条语句的 affected rows 返回的是 2，很容易造成误解。实际上，真正更新的只有一行，只是在代码实现上，insert 和 update 都认为自己成功了，update 计数加了 1， insert 计数也加了 1。</p><p>insert … select 是很常见的在两个表之间拷贝数据的方法。你需要注意，在可重复读隔离级别下，这个语句会给 select 的表里扫描到的记录和间隙加读锁。</p><p>而如果 insert 和 select 的对象是同一个表，则有可能会造成循环写入。这种情况下，我们需要引入用户临时表来做优化。</p><p>insert 语句如果出现唯一键冲突，会在冲突的唯一值上加共享的 next-key lock(S 锁)。因此，碰到由于唯一键约束导致报错后，要尽快提交或回滚事务，避免加锁时间过长。</p><h1 id="select"><a href="#select" class="headerlink" title="select"></a>select</h1><p>select * from T where ID&#x3D;10;</p><p>1.调用 InnoDB 引擎接口取这个表的第一行，判断 ID 值是不是 10，如果不是则跳过，如果是则将这行存在结果集中；</p><p>2.调用引擎接口取“下一行”，重复相同的判断逻辑，直到取到这个表的最后一行。</p><p>3.执行器将上述遍历过程中所有满足条件的行组成的记录集作为结果集返回给客户端。</p><h2 id="MySQL-什么时候会使用内部临时表？"><a href="#MySQL-什么时候会使用内部临时表？" class="headerlink" title="MySQL 什么时候会使用内部临时表？"></a>MySQL 什么时候会使用内部临时表？</h2><p>1.如果语句执行过程可以一边读数据，一边直接得到结果，是不需要额外内存的，否则就需要额外的内存，来保存中间结果；</p><p>2.join_buffer 是无序数组，sort_buffer 是有序数组，临时表是二维表结构；</p><p>3.如果执行逻辑需要用到二维表特性，就会优先考虑使用临时表。比如我们的例子中，union 需要用到唯一索引约束， group by 还需要用到另外一个字段来存累积计数。</p><h2 id="count-P14"><a href="#count-P14" class="headerlink" title="count(P14)"></a>count(P14)</h2><p>count() 是一个聚合函数，对于返回的结果集，一行行地判断，如果 count 函数的参数不是 NULL，累计值就加 1，否则不加。最后返回累计值。</p><h3 id="count-的实现方式"><a href="#count-的实现方式" class="headerlink" title="count(*) 的实现方式"></a>count(*) 的实现方式</h3><p>MyISAM 引擎把一个表的总行数存在了磁盘上，因此执行 count(*) 的时候会直接返回这个数，效率很高；</p><p>而 InnoDB 引擎就麻烦了，它执行 count(*) 的时候，需要把数据一行一行地从引擎里面读出来，然后累积计数。</p><p>MyISAM 表虽然 count(*) 很快，但是不支持事务；</p><p>show table status 命令虽然返回很快，但是不准确；</p><p>InnoDB 表直接 count(*) 会遍历全表，虽然结果准确，但会导致性能问题。</p><h3 id="mysql-count-慢怎么解决？"><a href="#mysql-count-慢怎么解决？" class="headerlink" title="mysql count(*)慢怎么解决？"></a>mysql count(*)慢怎么解决？</h3><p>MyISAM 引擎把一个表的总行数存在了磁盘上，因此执行 count(*) 的时候会直接返回这个数，效率很高；</p><p>而 InnoDB 引擎就麻烦了，它执行 count(*) 的时候，需要把数据一行一行地从引擎里面读出来，然后累积计数。</p><p>都是没有where的情况下，如果有where myISAM引擎也会慢。</p><p>可以自己计数，然后放到innodb引擎的表中。但是条件查询也不太好支持。</p><h3 id="mysql-count-count-主键ID-count-1-count-字段-的效率问题"><a href="#mysql-count-count-主键ID-count-1-count-字段-的效率问题" class="headerlink" title="mysql count(*) count(主键ID) count(1) count(字段) 的效率问题"></a>mysql count(*) count(主键ID) count(1) count(字段) 的效率问题</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs text">count() 是一个聚合函数，对于返回的结果集，一行行地判断，如果 count 函数的参数不是 NULL，累计值就加 1，否则不加。最后返回累计值。<br><br>对于 count(主键 id) 来说，InnoDB 引擎会遍历整张表，把每一行的 id 值都取出来，返回给 server 层。server 层拿到 id 后，判断是不可能为空的，就按行累加。<br><br>对于 count(1) 来说，InnoDB 引擎遍历整张表，但不取值。server 层对于返回的每一行，放一个数字“1”进去，判断是不可能为空的，按行累加。<br><br>单看这两个用法的差别的话，你能对比出来，count(1) 执行得要比 count(主键 id) 快。因为从引擎返回 id 会涉及到解析数据行，以及拷贝字段值的操作。<br><br>对于 count(字段) 来说：<br><br>如果这个“字段”是定义为 not null 的话，一行行地从记录里面读出这个字段，判断不能为 null，按行累加；<br><br>如果这个“字段”定义允许为 null，那么执行的时候，判断到有可能是 null，还要把值取出来再判断一下，不是 null 才累加。<br><br>但是 count(*) 是例外，并不会把全部字段取出来，而是专门做了优化，不取值。count(*) 肯定不是 null，按行累加。<br><br>按照效率排序的话，count(字段)&lt;count(主键 id)&lt;count(1)≈count(*)，所以我建议你，尽量使用 count(*)。<br></code></pre></td></tr></table></figure><h2 id="order-by-P16、P17"><a href="#order-by-P16、P17" class="headerlink" title="order by(P16、P17)"></a>order by(P16、P17)</h2><p>市民表为例，假设你要查询城市是“杭州”的所有人名字，并且按照姓名排序返回前 1000 个人的姓名、年龄。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t` (<br>  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `city` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `age` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `addr` <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>  KEY `city` (`city`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB;<br></code></pre></td></tr></table></figure><h3 id="全字段排序"><a href="#全字段排序" class="headerlink" title="全字段排序"></a>全字段排序</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> city,name,age <span class="hljs-keyword">from</span> t <span class="hljs-keyword">where</span> city<span class="hljs-operator">=</span><span class="hljs-string">&#x27;杭州&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> name limit <span class="hljs-number">1000</span>;<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> city,name,age <span class="hljs-keyword">from</span> t <span class="hljs-keyword">where</span> city<span class="hljs-operator">=</span><span class="hljs-string">&#x27;杭州&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> name limit <span class="hljs-number">1000</span>;<br></code></pre></td></tr></table></figure><p>Extra 这个字段中的“Using filesort”表示的就是需要排序。</p><p><img src="/.com//city%E5%AD%97%E6%AE%B5%E7%9A%84%E7%B4%A2%E5%BC%95%E7%A4%BA%E6%84%8F%E5%9B%BE.webp" alt="city字段的索引示意图"></p><p>MySQL 会给每个线程分配一块内存用于排序，称为 sort_buffer。</p><p>sort_buffer内存够时：使用全字段排序</p><p>全字段排序流程：</p><p>1.初始化 sort_buffer，确定放入 name、city、age 这三个字段；</p><p>2.从索引 city 找到第一个满足 city&#x3D;’杭州’条件的主键 id；</p><p>3.到主键 id 索引取出整行，取 name、city、age 三个字段的值，存入 sort_buffer 中；</p><p>4.从索引 city 取下一个记录的主键 id；</p><p>5.重复步骤 3、4 直到 city 的值不满足查询条件为止；</p><p>6.对 sort_buffer 中的数据按照字段 name 做快速排序；</p><p>7.按照排序结果取前 1000 行返回给客户端。</p><p><img src="/.com//%E5%85%A8%E5%AD%97%E6%AE%B5%E6%8E%92%E5%BA%8F.webp" alt="全字段排序"></p><p>sort_buffer_size参数设置sort_buffer的大小。</p><p>如果要排序的数据量小于 sort_buffer_size，排序就在内存中完成。但如果排序数据量太大，内存放不下，则不得不利用磁盘临时文件辅助排序。</p><p>你可以用下面介绍的方法，来确定一个排序语句是否使用了临时文件。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">/* 打开optimizer_trace，只对本线程有效 */</span><br><span class="hljs-keyword">SET</span> optimizer_trace<span class="hljs-operator">=</span><span class="hljs-string">&#x27;enabled=on&#x27;</span>; <br><br><span class="hljs-comment">/* @a保存Innodb_rows_read的初始值 */</span><br><span class="hljs-keyword">select</span> VARIABLE_VALUE <span class="hljs-keyword">into</span> <span class="hljs-variable">@a</span> <span class="hljs-keyword">from</span>  performance_schema.session_status <span class="hljs-keyword">where</span> variable_name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Innodb_rows_read&#x27;</span>;<br><br><span class="hljs-comment">/* 执行语句 */</span><br><span class="hljs-keyword">select</span> city, name,age <span class="hljs-keyword">from</span> t <span class="hljs-keyword">where</span> city<span class="hljs-operator">=</span><span class="hljs-string">&#x27;杭州&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> name limit <span class="hljs-number">1000</span>; <br><br><span class="hljs-comment">/* 查看 OPTIMIZER_TRACE 输出 */</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> `information_schema`.`OPTIMIZER_TRACE`\G<br><br><span class="hljs-comment">/* @b保存Innodb_rows_read的当前值 */</span><br><span class="hljs-keyword">select</span> VARIABLE_VALUE <span class="hljs-keyword">into</span> <span class="hljs-variable">@b</span> <span class="hljs-keyword">from</span> performance_schema.session_status <span class="hljs-keyword">where</span> variable_name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Innodb_rows_read&#x27;</span>;<br><br><span class="hljs-comment">/* 计算Innodb_rows_read差值 */</span><br><span class="hljs-keyword">select</span> <span class="hljs-variable">@b</span><span class="hljs-operator">-</span><span class="hljs-variable">@a</span>;<br></code></pre></td></tr></table></figure><p>number_of_tmp_files中看到是否使用了临时文件。</p><h4 id="归并排序算法"><a href="#归并排序算法" class="headerlink" title="归并排序算法"></a>归并排序算法</h4><p>内存放不下时，就需要使用外部排序，外部排序一般使用归并排序算法。可以这么简单理解，MySQL 将需要排序的数据分成 12 份，每一份单独排序后存在这些临时文件中。然后把这 12 个有序文件再合并成一个有序的大文件。</p><p>sort_mode 里面的 packed_additional_fields 的意思是，排序过程对字符串做了“紧凑”处理。即使 name 字段的定义是 varchar(16)，在排序过程中还是要按照实际长度来分配空间的。</p><h3 id="rowId排序"><a href="#rowId排序" class="headerlink" title="rowId排序"></a>rowId排序</h3><p>max_length_for_sort_data，是 MySQL 中专门控制用于排序的行数据的长度的一个参数。它的意思是，如果单行的长度超过这个值，MySQL 就认为单行太大，要换一个算法。</p><p>city、name、age 这三个字段的定义总长度是 36，我把 max_length_for_sort_data 设置为 16</p><p>新的算法放入 sort_buffer 的字段，只有要排序的列（即 name 字段）和主键 id。</p><p><img src="/.com//rowid%E6%8E%92%E5%BA%8F.webp" alt="rowid排序"></p><p>rowId排序流程</p><p>1.初始化 sort_buffer，确定放入两个字段，即 name 和 id；</p><p>2.从索引 city 找到第一个满足 city&#x3D;’杭州’条件的主键 id，也就是图中的 ID_X；</p><p>3.到主键 id 索引取出整行，取 name、id 这两个字段，存入 sort_buffer 中；</p><p>4.从索引 city 取下一个记录的主键 id；</p><p>5.重复步骤 3、4 直到不满足 city&#x3D;’杭州’条件为止，也就是图中的 ID_Y；</p><p>6.对 sort_buffer 中的数据按照字段 name 进行排序；</p><p>7.遍历排序结果，取前 1000 行，并按照 id 的值回到原表中取出 city、name 和 age 三个字段返回给客户端。</p><p>比全字段排序多了一个根据id获取city、age</p><p>sort_mode 变成了 &lt;sort_key, rowid&gt;</p><p>如果 MySQL 实在是担心排序内存太小，会影响排序效率，才会采用 rowid 排序算法，这样排序过程中一次可以排序更多行，但是需要再回到原表去取数据。</p><p>如果 MySQL 认为内存足够大，会优先选择全字段排序，把需要的字段都放到 sort_buffer 中，这样排序后就会直接从内存里面返回查询结果了，不用再回到原表去取数据。</p><p>这也就体现了 MySQL 的一个设计思想：如果内存够，就要多利用内存，尽量减少磁盘访问</p><h3 id="索引有序"><a href="#索引有序" class="headerlink" title="索引有序"></a>索引有序</h3><p>MySQL 之所以需要生成临时表，并且在临时表上做排序操作，其原因是原来的数据都是无序的。</p><p>你可以设想下，如果能够保证从 city 这个索引上取出来的行，天然就是按照 name 递增排序的话，是不是就可以不用再排序了呢？</p><p>创建一个 city 和 name 的联合索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> t <span class="hljs-keyword">add</span> index city_user(city, name);<br></code></pre></td></tr></table></figure><p>![city 和 name 联合索引示意图](mysqlimg&#x2F;city 和 name 联合索引示意图.webp)</p><p>整个查询过程的流程就变成了：</p><p>1.从索引 (city,name) 找到第一个满足 city&#x3D;’杭州’条件的主键 id；</p><p>2.到主键 id 索引取出整行，取 name、city、age 三个字段的值，作为结果集的一部分直接返回；</p><p>3.从索引 (city,name) 取下一个记录主键 id；</p><p>4.重复步骤 2、3，直到查到第 1000 条记录，或者是不满足 city&#x3D;’杭州’条件时循环结束。</p><p>explain中Extra 字段中没有 Using filesort 了，也就是不需要排序了。</p><h3 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h3><p>覆盖索引是指，索引上的信息足够满足查询请求，不需要再回到主键索引上去取数据。</p><p>创建一个 city、name 和 age 的联合索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> t <span class="hljs-keyword">add</span> index city_user_age(city, name, age);<br></code></pre></td></tr></table></figure><p>对于 city 字段的值相同的行来说，还是按照 name 字段的值递增排序的，此时的查询语句也就不再需要排序了。</p><p>执行流程就变成了：</p><p>1.从索引 (city,name,age) 找到第一个满足 city&#x3D;’杭州’条件的记录，取出其中的 city、name 和 age 这三个字段的值，作为结果集的一部分直接返回；</p><p>2.从索引 (city,name,age) 取下一个记录，同样取出这三个字段的值，作为结果集的一部分直接返回；</p><p>3.重复执行步骤 2，直到查到第 1000 条记录，或者是不满足 city&#x3D;’杭州’条件时循环结束。</p><p>![引入 (city,name,age) 联合索引后，查询语句的执行流程](mysqlimg&#x2F;引入 (city,name,age) 联合索引后，查询语句的执行流程.webp)</p><p>explain中Extra 字段里面多了“Using index”，表示的就是使用了覆盖索引，性能上会快很多。</p><p>并不是说要为了每个查询能用上覆盖索引，就要把语句中涉及的字段都建上联合索引，毕竟索引还是有维护代价的。这是一个需要权衡的决定。</p><h3 id="order-by-rand-P17"><a href="#order-by-rand-P17" class="headerlink" title="order by rand()(P17)"></a>order by rand()(P17)</h3><p>这个用户每次访问首页的时候，都会随机滚动显示三个单词。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `words` (<br>  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `word` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB;<br><br>delimiter ;;<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">procedure</span> idata()<br><span class="hljs-keyword">begin</span><br>  <span class="hljs-keyword">declare</span> i <span class="hljs-type">int</span>;<br>  <span class="hljs-keyword">set</span> i<span class="hljs-operator">=</span><span class="hljs-number">0</span>;<br>  while i<span class="hljs-operator">&lt;</span><span class="hljs-number">10000</span> do<br>    <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> words(word) <span class="hljs-keyword">values</span>(concat(<span class="hljs-type">char</span>(<span class="hljs-number">97</span><span class="hljs-operator">+</span>(i div <span class="hljs-number">1000</span>)), <span class="hljs-type">char</span>(<span class="hljs-number">97</span><span class="hljs-operator">+</span>(i <span class="hljs-operator">%</span> <span class="hljs-number">1000</span> div <span class="hljs-number">100</span>)), <span class="hljs-type">char</span>(<span class="hljs-number">97</span><span class="hljs-operator">+</span>(i <span class="hljs-operator">%</span> <span class="hljs-number">100</span> div <span class="hljs-number">10</span>)), <span class="hljs-type">char</span>(<span class="hljs-number">97</span><span class="hljs-operator">+</span>(i <span class="hljs-operator">%</span> <span class="hljs-number">10</span>))));<br>    <span class="hljs-keyword">set</span> i<span class="hljs-operator">=</span>i<span class="hljs-operator">+</span><span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">end</span> while;<br><span class="hljs-keyword">end</span>;;<br>delimiter ;<br><br><span class="hljs-keyword">call</span> idata();<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> word <span class="hljs-keyword">from</span> words <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> rand() limit <span class="hljs-number">3</span>;<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> word <span class="hljs-keyword">from</span> words <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> rand() limit <span class="hljs-number">3</span>;<br></code></pre></td></tr></table></figure><p>Extra 字段显示 Using temporary，表示的是需要使用临时表；Using filesort，表示的是需要执行排序操作。</p><p>执行流程：</p><p>1.创建一个临时表。这个临时表使用的是 memory 引擎，表里有两个字段，第一个字段是 double 类型，为了后面描述方便，记为字段 R，第二个字段是 varchar(64) 类型，记为字段 W。并且，这个表没有建索引。</p><p>2.从 words 表中，按主键顺序取出所有的 word 值。对于每一个 word 值，调用 rand() 函数生成一个大于 0 小于 1 的随机小数，并把这个随机小数和 word 分别存入临时表的 R 和 W 字段中，到此，扫描行数是 10000。</p><p>3.现在临时表有 10000 行数据了，接下来你要在这个没有索引的内存临时表上，按照字段 R 排序。</p><p>4.初始化 sort_buffer。sort_buffer 中有两个字段，一个是 double 类型，另一个是整型。</p><p>5.从内存临时表中一行一行地取出 R 值和位置信息（我后面会和你解释这里为什么是“位置信息”），分别存入 sort_buffer 中的两个字段里。这个过程要对内存临时表做全表扫描，此时扫描行数增加 10000，变成了 20000。</p><p>6.在 sort_buffer 中根据 R 的值进行排序。注意，这个过程没有涉及到表操作，所以不会增加扫描行数。</p><p>7.排序完成后，取出前三个结果的位置信息，依次到内存临时表中取出 word 值，返回给客户端。这个过程中，访问了表的三行数据，总扫描行数变成了 20003。</p><p>![随机排序完整流程图 1](mysqlimg&#x2F;随机排序完整流程图 1.webp)</p><h4 id="把一个-InnoDB-表的主键删掉，是不是就没有主键，就没办法回表了？"><a href="#把一个-InnoDB-表的主键删掉，是不是就没有主键，就没办法回表了？" class="headerlink" title="把一个 InnoDB 表的主键删掉，是不是就没有主键，就没办法回表了？"></a>把一个 InnoDB 表的主键删掉，是不是就没有主键，就没办法回表了？</h4><p>其实不是的。如果你创建的表没有主键，或者把一个表的主键删掉了，那么 InnoDB 会自己生成一个长度为 6 字节的 rowid 来作为主键。</p><p>这也就是排序模式里面，rowid 名字的来历。实际上它表示的是：每个引擎用来唯一标识数据行的信息。</p><p>对于有主键的 InnoDB 表来说，这个 rowid 就是主键 ID；</p><p>对于没有主键的 InnoDB 表来说，这个 rowid 就是由系统生成的；</p><p>MEMORY 引擎不是索引组织表。在这个例子里面，你可以认为它就是一个数组。因此，这个 rowid 其实就是数组的下标。</p><p>order by rand() 使用了内存临时表，内存临时表排序的时候使用了 rowid 排序方法。</p><h4 id="磁盘临时表"><a href="#磁盘临时表" class="headerlink" title="磁盘临时表"></a>磁盘临时表</h4><p>tmp_table_size 这个配置限制了内存临时表的大小，默认值是 16M。如果临时表大小超过了 tmp_table_size，那么内存临时表就会转成磁盘临时表。</p><p>磁盘临时表使用的引擎默认是 InnoDB，是由参数 internal_tmp_disk_storage_engine 控制的。</p><p>当使用磁盘临时表的时候，对应的就是一个没有显式索引的 InnoDB 表的排序过程。</p><p>为了复现这个过程，我把 tmp_table_size 设置成 1024，把 sort_buffer_size 设置成 32768, 把 max_length_for_sort_data 设置成 16。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql"><br><span class="hljs-keyword">set</span> tmp_table_size<span class="hljs-operator">=</span><span class="hljs-number">1024</span>;<br><span class="hljs-keyword">set</span> sort_buffer_size<span class="hljs-operator">=</span><span class="hljs-number">32768</span>;<br><span class="hljs-keyword">set</span> max_length_for_sort_data<span class="hljs-operator">=</span><span class="hljs-number">16</span>;<br><span class="hljs-comment">/* 打开 optimizer_trace，只对本线程有效 */</span><br><span class="hljs-keyword">SET</span> optimizer_trace<span class="hljs-operator">=</span><span class="hljs-string">&#x27;enabled=on&#x27;</span>; <br><br><span class="hljs-comment">/* 执行语句 */</span><br><span class="hljs-keyword">select</span> word <span class="hljs-keyword">from</span> words <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> rand() limit <span class="hljs-number">3</span>;<br><br><span class="hljs-comment">/* 查看 OPTIMIZER_TRACE 输出 */</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> `information_schema`.`OPTIMIZER_TRACE`\G<br></code></pre></td></tr></table></figure><p>因为将 max_length_for_sort_data 设置成 16，小于 word 字段的长度定义，所以我们看到 sort_mode 里面显示的是 rowid 排序，这个是符合预期的，参与排序的是随机值 R 字段和 rowid 字段组成的行。</p><p>这时候你可能心算了一下，发现不对。R 字段存放的随机值就 8 个字节，rowid 是 6 个字节（至于为什么是 6 字节，就留给你课后思考吧），数据总行数是 10000，这样算出来就有 140000 字节，超过了 sort_buffer_size 定义的 32768 字节了。但是，number_of_tmp_files 的值居然是 0，难道不需要用临时文件吗？</p><p>这个 SQL 语句的排序确实没有用到临时文件，采用是 MySQL 5.6 版本引入的一个新的排序算法，即：优先队列排序算法。接下来，我们就看看为什么没有使用临时文件的算法，也就是归并排序算法，而是采用了优先队列排序算法。</p><h4 id="优先队列算法"><a href="#优先队列算法" class="headerlink" title="优先队列算法"></a>优先队列算法</h4><p>而优先队列算法，就可以精确地只得到三个最小值，执行流程如下：</p><p>1.对于这 10000 个准备排序的 (R,rowid)，先取前三行，构造成一个堆；</p><p>2.取下一个行 (R’,rowid’)，跟当前堆里面最大的 R 比较，如果 R’小于 R，把这个 (R,rowid) 从堆中去掉，换成 (R’,rowid’)；</p><p>3.重复第 2 步，直到第 10000 个 (R’,rowid’) 完成比较。</p><p><img src="/.com//%E4%BC%98%E5%85%88%E9%98%9F%E5%88%97%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%E7%A4%BA%E4%BE%8B.webp" alt="优先队列排序算法示例"></p><p>整个排序过程中，为了最快地拿到当前堆的最大值，总是保持最大值在堆顶，因此这是一个最大堆。</p><p>OPTIMIZER_TRACE 结果中，filesort_priority_queue_optimization 这个部分的 chosen&#x3D;true，就表示使用了优先队列排序算法，这个过程不需要临时文件，因此对应的 number_of_tmp_files 是 0。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> city,name,age <span class="hljs-keyword">from</span> t <span class="hljs-keyword">where</span> city<span class="hljs-operator">=</span><span class="hljs-string">&#x27;杭州&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> name limit <span class="hljs-number">1000</span>  ;<br></code></pre></td></tr></table></figure><p>这里也用到了 limit，为什么没用优先队列排序算法呢？原因是，这条 SQL 语句是 limit 1000，如果使用优先队列算法的话，需要维护的堆的大小就是 1000 行的 (name,rowid)，超过了我设置的 sort_buffer_size 大小，所以只能使用归并排序算法。</p><h2 id="group-by-（P37）"><a href="#group-by-（P37）" class="headerlink" title="group by （P37）"></a>group by （P37）</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> id<span class="hljs-operator">%</span><span class="hljs-number">10</span> <span class="hljs-keyword">as</span> m, <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> c <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> m;<br></code></pre></td></tr></table></figure><p>这个语句的逻辑是把表 t1 里的数据，按照 id%10 进行分组统计，并按照 m 的结果排序后输出。</p><p>在 Extra 字段里面，我们可以看到三个信息：</p><p>Using index，表示这个语句使用了覆盖索引，选择了索引 a，不需要回表；</p><p>Using temporary，表示使用了临时表；</p><p>Using filesort，表示需要排序。</p><p>执行流程：</p><p>1.创建内存临时表，表里有两个字段 m 和 c，主键是 m；</p><p>2.扫描表 t1 的索引 a，依次取出叶子节点上的 id 值，计算 id%10 的结果，记为 x；</p><p>​如果临时表中没有主键为 x 的行，就插入一个记录 (x,1);</p><p>​如果表中有主键为 x 的行，就将 x 这一行的 c 值加 1；</p><p>3.遍历完成后，再根据字段 m 做排序，得到结果集返回给客户端。</p><p>![group by 执行流程](mysqlimg&#x2F;group by 执行流程.webp)</p><p>参数 tmp_table_size 就是控制这个内存大小的，默认是 16M。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">set</span> tmp_table_size<span class="hljs-operator">=</span><span class="hljs-number">1024</span>;<br><span class="hljs-keyword">select</span> id<span class="hljs-operator">%</span><span class="hljs-number">100</span> <span class="hljs-keyword">as</span> m, <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> c <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> m <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">null</span> limit <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><p>把内存临时表的大小限制为最大 1024 字节，并把语句改成 id % 100，这样返回结果里有 100 行数据。但是，这时的内存临时表大小不够存下这 100 行数据，也就是说，执行过程中会发现内存临时表大小到达了上限（1024 字节）。</p><p>那么，这时候就会把内存临时表转成磁盘临时表，磁盘临时表默认使用的引擎是 InnoDB。 </p><h3 id="group-by-优化方法-–-索引"><a href="#group-by-优化方法-–-索引" class="headerlink" title="group by 优化方法 – 索引"></a>group by 优化方法 – 索引</h3><p>group by 的语义逻辑，是统计不同的值出现的个数。但是，由于每一行的 id%100 的结果是无序的，所以我们就需要有一个临时表，来记录并统计结果。</p><p>如果可以确保输入的数据是有序的，那么计算 group by 的时候，就只需要从左到右，顺序扫描，依次累加。也就是下面这个过程：</p><p>当碰到第一个 1 的时候，已经知道累积了 X 个 0，结果集里的第一行就是 (0,X);</p><p>当碰到第一个 2 的时候，已经知道累积了 Y 个 1，结果集里的第二行就是 (1,Y);</p><p>按照这个逻辑执行的话，扫描到整个输入的数据结束，就可以拿到 group by 的结果，不需要临时表，也不需要再额外排序。</p><p>MySQL 5.7 版本支持了 generated column 机制，用来实现列数据的关联更新。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> t1 <span class="hljs-keyword">add</span> <span class="hljs-keyword">column</span> z <span class="hljs-type">int</span> generated always <span class="hljs-keyword">as</span>(id <span class="hljs-operator">%</span> <span class="hljs-number">100</span>), <span class="hljs-keyword">add</span> index(z);<br></code></pre></td></tr></table></figure><p>如果是 MySQL 5.6 及之前的版本，你也可以创建普通列和索引，来解决这个问题</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> z, <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> c <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> z;<br></code></pre></td></tr></table></figure><h3 id="group-by-优化方法-–-直接排序"><a href="#group-by-优化方法-–-直接排序" class="headerlink" title="group by 优化方法 – 直接排序"></a>group by 优化方法 – 直接排序</h3><p>如果碰上不适合创建索引的场景，我们还是要老老实实做排序的。</p><p>如果我们明明知道，一个 group by 语句中需要放到临时表上的数据量特别大，却还是要按照“先放到内存临时表，插入一部分数据后，发现内存临时表不够用了再转成磁盘临时表”，看上去就有点儿傻。</p><p>那么，我们就会想了，MySQL 有没有让我们直接走磁盘临时表的方法呢？</p><p>在 group by 语句中加入 SQL_BIG_RESULT 这个提示（hint），就可以告诉优化器：这个语句涉及的数据量很大，请直接用磁盘临时表。</p><p>MySQL 的优化器一看，磁盘临时表是 B+ 树存储，存储效率不如数组来得高。所以，既然你告诉我数据量很大，那从磁盘空间考虑，还是直接用数组来存吧。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> SQL_BIG_RESULT id<span class="hljs-operator">%</span><span class="hljs-number">100</span> <span class="hljs-keyword">as</span> m, <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> c <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> m;<br></code></pre></td></tr></table></figure><p>执行流程:</p><p>1.初始化 sort_buffer，确定放入一个整型字段，记为 m；</p><p>2.扫描表 t1 的索引 a，依次取出里面的 id 值, 将 id%100 的值存入 sort_buffer 中；</p><p>3.扫描完成后，对 sort_buffer 的字段 m 做排序（如果 sort_buffer 内存不够用，就会利用磁盘临时文件辅助排序）；</p><p>4.排序完成后，就得到了一个有序数组。</p><p>![使用 SQL_BIG_RESULT 的执行流程图](mysqlimg&#x2F;使用 SQL_BIG_RESULT 的执行流程图.webp)</p><h3 id="group-by指导原则"><a href="#group-by指导原则" class="headerlink" title="group by指导原则"></a>group by指导原则</h3><p>1.如果对 group by 语句的结果没有排序要求，要在语句后面加 order by null；</p><p>2.尽量让 group by 过程用上表的索引，确认方法是 explain 结果里没有 Using temporary 和 Using filesort；</p><p>3.如果 group by 需要统计的数据量不大，尽量只使用内存临时表；也可以通过适当调大 tmp_table_size 参数，来避免用到磁盘临时表；</p><p>4.如果数据量实在太大，使用 SQL_BIG_RESULT 这个提示，来告诉优化器直接使用排序算法得到 group by 的结果。</p><h2 id="distinct-和-group-by-的性能-p44"><a href="#distinct-和-group-by-的性能-p44" class="headerlink" title="distinct 和 group by 的性能(p44)"></a>distinct 和 group by 的性能(p44)</h2><p>select a from t group by a order by null;<br>select distinct a from t;</p><p>没有了 count(*) 以后，也就是不再需要执行“计算总数”的逻辑时，第一条语句的逻辑就变成是：按照字段 a 做分组，相同的 a 的值只返回一行。而这就是 distinct 的语义，所以不需要执行聚合函数时，distinct 和 group by 这两条语句的语义和执行流程是相同的，因此执行性能也相同。</p><p>这两条语句的执行流程:</p><p>1.创建一个临时表，临时表有一个字段 a，并且在这个字段 a 上创建一个唯一索引；</p><p>2.遍历表 t，依次取数据插入临时表中：</p><p>​如果发现唯一键冲突，就跳过；</p><p>​否则插入成功；</p><p>3.遍历完成后，将临时表作为结果集返回给客户端。</p><h2 id="limit-P17"><a href="#limit-P17" class="headerlink" title="limit(P17)"></a>limit(P17)</h2><p>MySQL 处理 limit Y,1 的做法就是按顺序一个一个地读出来，丢掉前 Y 个，然后把下一个记录作为返回结果，因此这一步需要扫描 Y+1 行。</p><p>limit 有限数时触发优先队列排序算法</p><p>归并排序算法会把所有的记录都排好序，优先队列排序算法会按照limit数量形成一个堆，然后再取数据跟堆里的数据进行比较。</p><p>优先队列排序算法也受sort_buffer_size的大小限制，如果超过这个内存，mysql还是会在磁盘上进行归并排序。</p><h2 id="join-P34、P35"><a href="#join-P34、P35" class="headerlink" title="join(P34、P35)"></a>join(P34、P35)</h2><p>在实际生产中，关于 join 语句使用的问题，一般会集中在以下两类：</p><p>1.我们 DBA 不让使用 join，使用 join 有什么问题呢？</p><p>2.如果有两个大小不同的表做 join，应该用哪个表做驱动表呢？</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t2` (<br>  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `a` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `b` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>  KEY `a` (`a`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB;<br><br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">procedure</span> idata;<br>delimiter ;;<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">procedure</span> idata()<br><span class="hljs-keyword">begin</span><br>  <span class="hljs-keyword">declare</span> i <span class="hljs-type">int</span>;<br>  <span class="hljs-keyword">set</span> i<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br>  while(i<span class="hljs-operator">&lt;=</span><span class="hljs-number">1000</span>)do<br>    <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t2 <span class="hljs-keyword">values</span>(i, i, i);<br>    <span class="hljs-keyword">set</span> i<span class="hljs-operator">=</span>i<span class="hljs-operator">+</span><span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">end</span> while;<br><span class="hljs-keyword">end</span>;;<br>delimiter ;<br><span class="hljs-keyword">call</span> idata();<br><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t1 <span class="hljs-keyword">like</span> t2;<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t1 (<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t2 <span class="hljs-keyword">where</span> id<span class="hljs-operator">&lt;=</span><span class="hljs-number">100</span>)<br></code></pre></td></tr></table></figure><p>可以看到，这两个表都有一个主键索引 id 和一个索引 a，字段 b 上无索引。存储过程 idata() 往表 t2 里插入了 1000 行数据，在表 t1 里插入的是 100 行数据。</p><h3 id="Index-Nested-Loop-Join-索引嵌套循环联接"><a href="#Index-Nested-Loop-Join-索引嵌套循环联接" class="headerlink" title="Index Nested-Loop Join(索引嵌套循环联接)"></a>Index Nested-Loop Join(索引嵌套循环联接)</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t1 straight_join t2 <span class="hljs-keyword">on</span> (t1.a<span class="hljs-operator">=</span>t2.a);<br></code></pre></td></tr></table></figure><p>如果直接使用 join 语句，MySQL 优化器可能会选择表 t1 或 t2 作为驱动表，这样会影响我们分析 SQL 语句的执行过程。所以，为了便于分析执行过程中的性能问题，我改用 straight_join 让 MySQL 使用固定的连接方式执行查询，这样优化器只会按照我们指定的方式去 join。在这个语句里，t1 是驱动表，t2 是被驱动表。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t1 straight_join t2 <span class="hljs-keyword">on</span> (t1.a<span class="hljs-operator">=</span>t2.a);<br></code></pre></td></tr></table></figure><p>在这条语句里，被驱动表 t2 的字段 a 上有索引，join 过程用上了这个索引，因此这个语句的执行流程是这样的：</p><p>1.从表 t1 中读入一行数据 R；</p><p>2.从数据行 R 中，取出 a 字段到表 t2 里去查找；</p><p>3.取出表 t2 中满足条件的行，跟 R 组成一行，作为结果集的一部分；</p><p>4.重复执行步骤 1 到 3，直到表 t1 的末尾循环结束。</p><p>这个过程是先遍历表 t1，然后根据从表 t1 中取出的每行数据中的 a 值，去表 t2 中查找满足条件的记录。在形式上，这个过程就跟我们写程序时的嵌套查询类似，并且可以用上被驱动表的索引，所以我们称之为“Index Nested-Loop Join”，简称 NLJ。</p><p>![Index Nested-Loop Join 算法的执行流程](mysqlimg&#x2F;Index Nested-Loop Join 算法的执行流程.webp)</p><p>在这个流程里：</p><p>1.对驱动表 t1 做了全表扫描，这个过程需要扫描 100 行；</p><p>2.而对于每一行 R，根据 a 字段去表 t2 查找，走的是树搜索过程。由于我们构造的数据都是一一对应的，因此每次的搜索过程都只扫描一行，也是总共扫描 100 行；</p><p>3.所以，整个执行流程，总扫描行数是 200。</p><h3 id="能不能使用-join"><a href="#能不能使用-join" class="headerlink" title="能不能使用 join?"></a>能不能使用 join?</h3><p>不使用join,拿程序做的步骤。</p><p>1.执行select * from t1，查出表 t1 的所有数据，这里有 100 行；</p><p>2.循环遍历这 100 行数据：</p><p>​从每一行 R 取出字段 a 的值 $R.a；</p><p>​执行select * from t2 where a&#x3D;$R.a；</p><p>​把返回的结果和 R 构成结果集的一行。</p><p>可以看到，在这个查询过程，也是扫描了 200 行，但是总共执行了 101 条语句，比直接 join 多了 100 次交互。除此之外，客户端还要自己拼接 SQL 语句和结果。显然，这么做还不如直接 join 好。</p><h3 id="怎么选择驱动表？"><a href="#怎么选择驱动表？" class="headerlink" title="怎么选择驱动表？"></a>怎么选择驱动表？</h3><p>在这个 join 语句执行过程中，驱动表是走全表扫描，而被驱动表是走树搜索。</p><p>假设被驱动表的行数是 M。每次在被驱动表查一行数据，要先搜索索引 a，再搜索主键索引。每次搜索一棵树近似复杂度是以 2 为底的 M 的对数，记为 log2M，所以在被驱动表上查一行的时间复杂度是 2*log2M。</p><p>假设驱动表的行数是 N，执行过程就要扫描驱动表 N 行，然后对于每一行，到被驱动表上匹配一次。</p><p>因此整个执行过程，近似复杂度是 N + N<em>2</em>log2M。</p><p>显然，N 对扫描行数的影响更大，因此应该让小表来做驱动表。</p><p>如果你没觉得这个影响有那么“显然”， 可以这么理解：N 扩大 1000 倍的话，扫描行数就会扩大 1000 倍；而 M 扩大 1000 倍，扫描行数扩大不到 10 倍。</p><p>通过上面的分析我们得到了两个结论：</p><p>1.使用 join 语句，性能比强行拆成多个单表执行 SQL 语句的性能要好；</p><p>2.如果使用 join 语句的话，需要让小表做驱动表。</p><p>但是，你需要注意，这个结论的前提是“可以使用被驱动表的索引”。</p><h3 id="Simple-Nested-Loop-Join-简单嵌套循环联接"><a href="#Simple-Nested-Loop-Join-简单嵌套循环联接" class="headerlink" title="Simple Nested-Loop Join(简单嵌套循环联接)"></a>Simple Nested-Loop Join(简单嵌套循环联接)</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t1 straight_join t2 <span class="hljs-keyword">on</span> (t1.a<span class="hljs-operator">=</span>t2.b);<br></code></pre></td></tr></table></figure><p>由于表 t2 的字段 b 上没有索引，因此再用图 2 的执行流程时，每次到 t2 去匹配的时候，就要做一次全表扫描。</p><p>你可以先设想一下这个问题，继续使用图 2 的算法，是不是可以得到正确的结果呢？如果只看结果的话，这个算法是正确的，而且这个算法也有一个名字，叫做“Simple Nested-Loop Join”。</p><p>但是，这样算来，这个 SQL 请求就要扫描表 t2 多达 100 次，总共扫描 100*1000&#x3D;10 万行。</p><p>这还只是两个小表，如果 t1 和 t2 都是 10 万行的表（当然了，这也还是属于小表的范围），就要扫描 100 亿行，这个算法看上去太“笨重”了。</p><p>当然，MySQL 也没有使用这个 Simple Nested-Loop Join 算法，而是使用了另一个叫作“Block Nested-Loop Join”的算法，简称 BNL。</p><h3 id="Block-Nested-Loop-Join-块嵌套循环联接"><a href="#Block-Nested-Loop-Join-块嵌套循环联接" class="headerlink" title="Block Nested-Loop Join(块嵌套循环联接)"></a>Block Nested-Loop Join(块嵌套循环联接)</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t1 straight_join t2 <span class="hljs-keyword">on</span> (t1.a<span class="hljs-operator">=</span>t2.b);<br></code></pre></td></tr></table></figure><p>显示使用use where; use join buffer(Block Nested Loop)</p><p>这时候，被驱动表上没有可用的索引，算法的流程是这样的</p><p>1.把表 t1 的数据读入线程内存 join_buffer 中，由于我们这个语句中写的是 select *，因此是把整个表 t1 放入了内存；</p><p>2.扫描表 t2，把表 t2 中的每一行取出来，跟 join_buffer 中的数据做对比，满足 join 条件的，作为结果集的一部分返回。</p><p>![Block Nested-Loop Join 算法的执行流程](mysqlimg&#x2F;Block Nested-Loop Join 算法的执行流程.webp)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t1 straight_join t2 <span class="hljs-keyword">on</span> (t1.a<span class="hljs-operator">=</span>t2.b);<br></code></pre></td></tr></table></figure><p>可以看到，在这个过程中，对表 t1 和 t2 都做了一次全表扫描，因此总的扫描行数是 1100。由于 join_buffer 是以无序数组的方式组织的，因此对表 t2 中的每一行，都要做 100 次判断，总共需要在内存中做的判断次数是：100*1000&#x3D;10 万次。</p><p>前面我们说过，如果使用 Simple Nested-Loop Join 算法进行查询，扫描行数也是 10 万行。因此，从时间复杂度上来说，这两个算法是一样的。但是，Block Nested-Loop Join 算法的这 10 万次判断是内存操作，速度上会快很多，性能也更好。</p><p>在这种情况下，应该选择哪个表做驱动表?</p><p>假设小表的行数是 N，大表的行数是 M，那么在这个算法里：</p><p>1.两个表都做一次全表扫描，所以总的扫描行数是 M+N；</p><p>2.内存中的判断次数是 M*N。</p><p>可以看到，调换这两个算式中的 M 和 N 没差别，因此这时候选择大表还是小表做驱动表，执行耗时是一样的。</p><p>然后，你可能马上就会问了，这个例子里表 t1 才 100 行，要是表 t1 是一个大表，join_buffer 放不下怎么办呢？</p><p>join_buffer 的大小是由参数 join_buffer_size 设定的，默认值是 256k。如果放不下表 t1 的所有数据话，策略很简单，就是分段放。我把 join_buffer_size 改成 1200，再执行：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t1 straight_join t2 <span class="hljs-keyword">on</span> (t1.a<span class="hljs-operator">=</span>t2.b);<br></code></pre></td></tr></table></figure><p>执行过程就变成了：</p><p>1.扫描表 t1，顺序读取数据行放入 join_buffer 中，放完第 88 行 join_buffer 满了，继续第 2 步；</p><p>2.扫描表 t2，把 t2 中的每一行取出来，跟 join_buffer 中的数据做对比，满足 join 条件的，作为结果集的一部分返回；</p><p>3.清空 join_buffer；</p><p>4.继续扫描表 t1，顺序读取最后的 12 行数据放入 join_buffer 中，继续执行第 2 步。</p><p>![Block Nested-Loop Join – 两段](mysqlimg&#x2F;Block Nested-Loop Join – 两段.webp)</p><p>图中的步骤 4 和 5，表示清空 join_buffer 再复用。</p><p>这个流程才体现出了这个算法名字中“Block”的由来，表示“分块去 join”。</p><p>可以看到，这时候由于表 t1 被分成了两次放入 join_buffer 中，导致表 t2 会被扫描两次。虽然分成两次放入 join_buffer，但是判断等值条件的次数还是不变的，依然是 (88+12)*1000&#x3D;10 万次。</p><p>假设，驱动表的数据行数是 N，需要分 K 段才能完成算法流程，被驱动表的数据行数是 M。</p><p>注意，这里的 K 不是常数，N 越大 K 就会越大，因此把 K 表示为λ*N，显然λ的取值范围是 (0,1)。</p><p>所以，在这个算法的执行过程中：</p><p>1.扫描行数是 N+λ<em>N</em>M；</p><p>2.内存判断 N*M 次。</p><p>显然，内存判断次数是不受选择哪个表作为驱动表影响的。而考虑到扫描行数，在 M 和 N 大小确定的情况下，N 小一些，整个算式的结果会更小。</p><p>所以结论是，应该让小表当驱动表。</p><p>刚刚我们说了 N 越大，分段数 K 越大。那么，N 固定的时候，什么参数会影响 K 的大小呢？（也就是λ的大小）答案是 join_buffer_size。join_buffer_size 越大，一次可以放入的行越多，分成的段数也就越少，对被驱动表的全表扫描次数就越少。</p><p>这就是为什么，你可能会看到一些建议告诉你，如果你的 join 语句很慢，就把 join_buffer_size 改大。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>第一个问题：能不能使用 join 语句？</p><p>1.如果可以使用 Index Nested-Loop Join 算法，也就是说可以用上被驱动表上的索引，其实是没问题的；</p><p>2.如果使用 Block Nested-Loop Join 算法，扫描行数就会过多。尤其是在大表上的 join 操作，这样可能要扫描被驱动表很多次，会占用大量的系统资源。所以这种 join 尽量不要用。</p><p>所以你在判断要不要使用 join 语句时，就是看 explain 结果里面，Extra 字段里面有没有出现“Block Nested Loop”字样。</p><p>第二个问题是：如果要使用 join，应该选择大表做驱动表还是选择小表做驱动表？</p><p>1.如果是 Index Nested-Loop Join 算法，应该选择小表做驱动表；</p><p>2.如果是 Block Nested-Loop Join 算法：</p><p>​在 join_buffer_size 足够大的时候，是一样的；</p><p>​在 join_buffer_size 不够大的时候（这种情况更常见），应该选择小表做驱动表。</p><p>所以，这个问题的结论就是，总是应该使用小表做驱动表。</p><p>什么叫作“小表”。</p><p>在决定哪个表做驱动表的时候，应该是两个表按照各自的条件过滤，过滤完成之后，计算参与 join 的各个字段的总数据量，数据量小的那个表，就是“小表”，应该作为驱动表。</p><h3 id="Multi-Range-Read-优化-索引多范围查找"><a href="#Multi-Range-Read-优化-索引多范围查找" class="headerlink" title="Multi-Range Read 优化(索引多范围查找)"></a>Multi-Range Read 优化(索引多范围查找)</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t1(id <span class="hljs-type">int</span> <span class="hljs-keyword">primary</span> key, a <span class="hljs-type">int</span>, b <span class="hljs-type">int</span>, index(a));<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t2 <span class="hljs-keyword">like</span> t1;<br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">procedure</span> idata;<br>delimiter ;;<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">procedure</span> idata()<br><span class="hljs-keyword">begin</span><br>  <span class="hljs-keyword">declare</span> i <span class="hljs-type">int</span>;<br>  <span class="hljs-keyword">set</span> i<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br>  while(i<span class="hljs-operator">&lt;=</span><span class="hljs-number">1000</span>)do<br>    <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t1 <span class="hljs-keyword">values</span>(i, <span class="hljs-number">1001</span><span class="hljs-operator">-</span>i, i);<br>    <span class="hljs-keyword">set</span> i<span class="hljs-operator">=</span>i<span class="hljs-operator">+</span><span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">end</span> while;<br>  <br>  <span class="hljs-keyword">set</span> i<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br>  while(i<span class="hljs-operator">&lt;=</span><span class="hljs-number">1000000</span>)do<br>    <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t2 <span class="hljs-keyword">values</span>(i, i, i);<br>    <span class="hljs-keyword">set</span> i<span class="hljs-operator">=</span>i<span class="hljs-operator">+</span><span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">end</span> while;<br><br><span class="hljs-keyword">end</span>;;<br>delimiter ;<br><span class="hljs-keyword">call</span> idata();<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">where</span> a<span class="hljs-operator">&gt;=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> a<span class="hljs-operator">&lt;=</span><span class="hljs-number">100</span>;<br></code></pre></td></tr></table></figure><p><img src="/.com//%E5%9F%BA%E6%9C%AC%E5%9B%9E%E8%A1%A8%E6%B5%81%E7%A8%8B.webp" alt="基本回表流程"></p><p>如果随着 a 的值递增顺序查询的话，id 的值就变成随机的，那么就会出现随机访问，性能相对较差。虽然“按行查”这个机制不能改，但是调整查询的顺序，还是能够加速的。</p><p>因为大多数的数据都是按照主键递增顺序插入得到的，所以我们可以认为，如果按照主键的递增顺序查询的话，对磁盘的读比较接近顺序读，能够提升读性能。</p><p>这就是 MRR 优化的设计思路。此时，语句的执行流程变成了这样：</p><p>1.根据索引 a，定位到满足条件的记录，将 id 值放入 read_rnd_buffer 中 ;</p><p>2.将 read_rnd_buffer 中的 id 进行递增排序；</p><p>3.排序后的 id 数组，依次到主键 id 索引中查记录，并作为结果返回。</p><p>这里，read_rnd_buffer 的大小是由 read_rnd_buffer_size 参数控制的。如果步骤 1 中，read_rnd_buffer 放满了，就会先执行完步骤 2 和 3，然后清空 read_rnd_buffer。之后继续找索引 a 的下个记录，并继续循环。</p><p>另外需要说明的是，如果你想要稳定地使用 MRR 优化的话，需要设置set optimizer_switch&#x3D;”mrr_cost_based&#x3D;off”。（官方文档的说法，是现在的优化器策略，判断消耗的时候，会更倾向于不使用 MRR，把 mrr_cost_based 设置为 off，就是固定使用 MRR 了。）</p><p> MRR 优化后的执行流程:</p><p>![MRR 执行流程](mysqlimg&#x2F;MRR 执行流程.webp)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">where</span> a<span class="hljs-operator">&gt;=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> a<span class="hljs-operator">&lt;=</span><span class="hljs-number">100</span>;<br></code></pre></td></tr></table></figure><p>explain 结果中，我们可以看到 Extra 字段多了 Using MRR，表示的是用上了 MRR 优化。而且，由于我们在 read_rnd_buffer 中按照 id 做了排序，所以最后得到的结果集也是按照主键 id 递增顺序的，也就是与上面结果集中行的顺序相反。</p><p>MRR 能够提升性能的核心在于，这条查询语句在索引 a 上做的是一个范围查询（也就是说，这是一个多值查询），可以得到足够多的主键 id。这样通过排序以后，再去主键索引查数据，才能体现出“顺序性”的优势。</p><h3 id="Batched-Key-Access-批量key访问"><a href="#Batched-Key-Access-批量key访问" class="headerlink" title="Batched Key Access(批量key访问)"></a>Batched Key Access(批量key访问)</h3><p>NLJ 算法执行的逻辑是：从驱动表 t1，一行行地取出 a 的值，再到被驱动表 t2 去做 join。</p><p>一行行去join慢，批量去join，这就是Batched Key Access。</p><p>批量存储的位置是join_buffer。</p><p>![Batched Key Access 流程](mysqlimg&#x2F;Batched Key Access 流程.webp)</p><p>如果要使用 BKA 优化算法的话，你需要在执行 SQL 语句之前，先设置</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">set</span> optimizer_switch<span class="hljs-operator">=</span><span class="hljs-string">&#x27;mrr=on,mrr_cost_based=off,batched_key_access=on&#x27;</span>;<br></code></pre></td></tr></table></figure><p>其中，前两个参数的作用是要启用 MRR。这么做的原因是，BKA 算法的优化要依赖于 MRR。</p><h3 id="BNL-算法的性能问题"><a href="#BNL-算法的性能问题" class="headerlink" title="BNL 算法的性能问题"></a>BNL 算法的性能问题</h3><p>大表 join 操作虽然对 IO 有影响，但是在语句执行结束后，对 IO 的影响也就结束了。但是，对 Buffer Pool 的影响就是持续性的，需要依靠后续的查询请求慢慢恢复内存命中率。</p><p>BNL 算法对系统的影响主要包括三个方面：</p><p>1.可能会多次扫描被驱动表，占用磁盘 IO 资源；</p><p>2.判断 join 条件需要执行 M*N 次对比（M、N 分别是两张表的行数），如果是大表就会占用非常多的 CPU 资源；</p><p>3.可能会导致 Buffer Pool 的热数据被淘汰，影响内存命中率。</p><h3 id="BNL-转-BKA"><a href="#BNL-转-BKA" class="headerlink" title="BNL 转 BKA"></a>BNL 转 BKA</h3><p>一些情况下，我们可以直接在被驱动表上建索引，这时就可以直接转成 BKA 算法了。</p><p>但是，有时候你确实会碰到一些不适合在被驱动表上建索引的情况。比如下面这个语句：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">join</span> t2 <span class="hljs-keyword">on</span> (t1.b<span class="hljs-operator">=</span>t2.b) <span class="hljs-keyword">where</span> t2.b<span class="hljs-operator">&gt;=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> t2.b<span class="hljs-operator">&lt;=</span><span class="hljs-number">2000</span>;<br></code></pre></td></tr></table></figure><p>我们在文章开始的时候，在表 t2 中插入了 100 万行数据，但是经过 where 条件过滤后，需要参与 join 的只有 2000 行数据。如果这条语句同时是一个低频的 SQL 语句，那么再为这个语句在表 t2 的字段 b 上创建一个索引就很浪费了。</p><p>但是，如果使用 BNL 算法来 join 的话，这个语句的执行流程是这样的：</p><p>1.把表 t1 的所有字段取出来，存入 join_buffer 中。这个表只有 1000 行，join_buffer_size 默认值是 256k，可以完全存入。</p><p>2.扫描表 t2，取出每一行数据跟 join_buffer 中的数据进行对比，</p><p>​如果不满足 t1.b&#x3D;t2.b，则跳过；</p><p>​如果满足 t1.b&#x3D;t2.b, 再判断其他条件，也就是是否满足 t2.b 处于[1,2000]的条件，如果是，就作为结果集的一部分返回，否则跳过。</p><h3 id="使用临时表优化"><a href="#使用临时表优化" class="headerlink" title="使用临时表优化"></a>使用临时表优化</h3><p>如果这条join语句同时是一个低频的 SQL 语句，那么再为这个语句在被驱动表的字段 b 上创建一个索引就很浪费了。</p><p>这时候，我们可以考虑使用临时表。使用临时表的大致思路是：</p><p>1.把表 t2 中满足条件的数据放在临时表 tmp_t 中；</p><p>2.为了让 join 使用 BKA 算法，给临时表 tmp_t 的字段 b 加上索引；</p><p>3.让表 t1 和 tmp_t 做 join 操作。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> temporary <span class="hljs-keyword">table</span> temp_t(id <span class="hljs-type">int</span> <span class="hljs-keyword">primary</span> key, a <span class="hljs-type">int</span>, b <span class="hljs-type">int</span>, index(b))engine<span class="hljs-operator">=</span>innodb;<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> temp_t <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t2 <span class="hljs-keyword">where</span> b<span class="hljs-operator">&gt;=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> b<span class="hljs-operator">&lt;=</span><span class="hljs-number">2000</span>;<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">join</span> temp_t <span class="hljs-keyword">on</span> (t1.b<span class="hljs-operator">=</span>temp_t.b);<br></code></pre></td></tr></table></figure><p>过程的消耗:</p><p>1.执行 insert 语句构造 temp_t 表并插入数据的过程中，对表 t2 做了全表扫描，这里扫描行数是 100 万。</p><p>2.之后的 join 语句，扫描表 t1，这里的扫描行数是 1000；join 比较过程中，做了 1000 次带索引的查询。相比于优化前的 join 语句需要做 10 亿次条件判断来说，这个优化效果还是很明显的。</p><p>总体来看，不论是在原表上加索引，还是用有索引的临时表，我们的思路都是让 join 语句能够用上被驱动表上的索引，来触发 BKA 算法，提升查询性能。</p><h3 id="扩展-hash-join"><a href="#扩展-hash-join" class="headerlink" title="扩展 -hash join"></a>扩展 -hash join</h3><p>看到这里你可能发现了，其实上面计算 10 亿次那个操作，看上去有点儿傻。如果 join_buffer 里面维护的不是一个无序数组，而是一个哈希表的话，那么就不是 10 亿次判断，而是 100 万次 hash 查找。这样的话，整条语句的执行速度就快多了吧？</p><p>这，也正是 MySQL 的优化器和执行器一直被诟病的一个原因：不支持哈希 join。并且，MySQL 官方的 roadmap，也是迟迟没有把这个优化排上议程。</p><p>实际上，这个优化思路，我们可以自己实现在业务端。实现流程大致如下：</p><p>1.select * from t1;取得表 t1 的全部 1000 行数据，在业务端存入一个 hash 结构，比如 C++ 里的 set、PHP 的数组这样的数据结构。</p><p>2.select * from t2 where b&gt;&#x3D;1 and b&lt;&#x3D;2000; 获取表 t2 中满足条件的 2000 行数据。把这 2000 行数据，一行一行地取到业务端，到 hash 结构的数据表中寻找匹配的数据。</p><p>3.满足匹配的条件的这行数据，就作为结果集的一行。</p><h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>在这些优化方法中：</p><p>1.BKA 优化是 MySQL 已经内置支持的，建议你默认使用；</p><p>2.BNL 算法效率低，建议你都尽量转成 BKA 算法。优化的方向就是给被驱动表的关联字段加上索引；</p><p>3.基于临时表的改进方案，对于能够提前过滤出小数据的 join 语句来说，效果还是很好的；</p><p>4.MySQL 目前的版本还不支持 hash join，但你可以配合应用端自己模拟出来，理论上效果要好于临时表的方案。</p><p>如果用 left join 的话，左边的表一定是驱动表吗？</p><p>使用 left join 时，左边的表不一定是驱动表。</p><p>如果两个表的 join 包含多个条件的等值匹配，是都要写到 on 里面呢，还是只把一个条件写到 on 里面，其他条件写到 where 部分？</p><p>如果需要 left join 的语义，就不能把被驱动表的字段放在 where 条件里面做等值判断或不等值判断，必须都写在 on 里面。</p><p> explain 和 show warnings 可以查看优化器，给你优化过后的sql。</p><h1 id="union-P37"><a href="#union-P37" class="headerlink" title="union(P37)"></a>union(P37)</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t1(id <span class="hljs-type">int</span> <span class="hljs-keyword">primary</span> key, a <span class="hljs-type">int</span>, b <span class="hljs-type">int</span>, index(a));<br>delimiter ;;<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">procedure</span> idata()<br><span class="hljs-keyword">begin</span><br>  <span class="hljs-keyword">declare</span> i <span class="hljs-type">int</span>;<br><br>  <span class="hljs-keyword">set</span> i<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br>  while(i<span class="hljs-operator">&lt;=</span><span class="hljs-number">1000</span>)do<br>    <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t1 <span class="hljs-keyword">values</span>(i, i, i);<br>    <span class="hljs-keyword">set</span> i<span class="hljs-operator">=</span>i<span class="hljs-operator">+</span><span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">end</span> while;<br><span class="hljs-keyword">end</span>;;<br>delimiter ;<br><span class="hljs-keyword">call</span> idata();<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">(<span class="hljs-keyword">select</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">as</span> f) <span class="hljs-keyword">union</span> (<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id <span class="hljs-keyword">desc</span> limit <span class="hljs-number">2</span>);<br></code></pre></td></tr></table></figure><p>这条语句用到了 union，它的语义是，取这两个子查询结果的并集。并集的意思就是这两个集合加起来，重复的行只保留一行。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain (<span class="hljs-keyword">select</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">as</span> f) <span class="hljs-keyword">union</span> (<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id <span class="hljs-keyword">desc</span> limit <span class="hljs-number">2</span>);<br></code></pre></td></tr></table></figure><p>第二行的 key&#x3D;PRIMARY，说明第二个子句用到了索引 id。</p><p>第三行的 Extra 字段，表示在对子查询的结果集做 union 的时候，使用了临时表 (Using temporary)。</p><p>这个语句的执行流程是这样的：</p><p>1.创建一个内存临时表，这个临时表只有一个整型字段 f，并且 f 是主键字段。</p><p>2.执行第一个子查询，得到 1000 这个值，并存入临时表中。</p><p>3.执行第二个子查询：</p><p>   拿到第一行 id&#x3D;1000，试图插入临时表中。但由于 1000 这个值已经存在于临时表了，违反了唯一性约束，所以插入失败，然后继续执行；</p><p>   取到第二行 id&#x3D;999，插入临时表成功。</p><p>4.从临时表中按行取出数据，返回结果，并删除临时表，结果中包含两行数据分别是 1000 和 999。</p><p>![union 执行流程](mysqlimg&#x2F;union 执行流程.webp)</p><p>可以看到，这里的内存临时表起到了暂存数据的作用，而且计算过程还用上了临时表主键 id 的唯一性约束，实现了 union 的语义。</p><p>顺便提一下，如果把上面这个语句中的 union 改成 union all 的话，就没有了“去重”的语义。这样执行的时候，就依次执行子查询，得到的结果直接作为结果集的一部分，发给客户端。因此也就不需要临时表了。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain (<span class="hljs-keyword">select</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">as</span> f) <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span> (<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id <span class="hljs-keyword">desc</span> limit <span class="hljs-number">2</span>);<br></code></pre></td></tr></table></figure><p>可以看到，第二行的 Extra 字段显示的是 Using index，表示只使用了覆盖索引，没有用临时表了。</p>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql架构</title>
    <link href="/2022/05/18/mysql/mysql%E6%9E%B6%E6%9E%84/"/>
    <url>/2022/05/18/mysql/mysql%E6%9E%B6%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<h1 id="极客时间mysql45讲总结"><a href="#极客时间mysql45讲总结" class="headerlink" title="极客时间mysql45讲总结"></a>极客时间mysql45讲总结</h1><p><a href="https://time.geekbang.org/">https://time.geekbang.org/</a></p><p><a href="https://blog.csdn.net/junmoxi/article/details/85044982">https://blog.csdn.net/junmoxi/article/details/85044982</a></p><p><a href="https://blog.csdn.net/cph691647465/article/details/118677935">https://blog.csdn.net/cph691647465/article/details/118677935</a></p><h1 id="mysql基础架构"><a href="#mysql基础架构" class="headerlink" title="mysql基础架构"></a>mysql基础架构</h1><p><img src="/.com//mysql%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84.webp" alt="mysql基础架构"></p><p>mysql的基本架构示意图</p><p>客户端—&gt;连接器—&gt;查询缓存</p><p>客户端—》连接器—》分析器—》优化器—》执行器—》存储引擎</p><p>连接器、缓存、分析器、优化器、执行器为server层</p><p>存储引擎为存储引擎层</p><p>连接器：管理连接，权限验证</p><p>分析器：词法分析，语法分析</p><p>优化器：执行计划生成，索引选择</p><p>执行器：操作引擎，返回结果（用户表权限的验证）</p><p>存储引擎：存储数据，提供读写接口</p><h2 id="连接器"><a href="#连接器" class="headerlink" title="连接器"></a>连接器</h2><p>连接器负责跟客户端建立连接、获取权限、维持和管理连接。</p><p>TCP连接，输入用户名与密码</p><p>​如果用户名或密码不对，你就会收到一个”Access denied for user”的错误，然后客户端程序结束执行。</p><p>​如果用户名密码认证通过，连接器会到权限表里面查出你拥有的权限。之后，这个连接里面的权限判断逻辑，都将依赖于此时读到的权限。</p><p>一个用户成功建立连接后，即使你用管理员账号对这个用户的权限做了修改，也不会影响已经存在连接的权限。修改完成后，只有再新建的连接才会使用新的权限设置。</p><p>连接完成后，如果你没有后续的动作，这个连接就处于空闲状态，你可以在 show processlist 命令中看到它。</p><p>客户端如果太长时间没动静，连接器就会自动将它断开。这个时间是由参数 wait_timeout 控制的，默认值是 8 小时。</p><p>如果在连接被断开之后，客户端再次发送请求的话，就会收到一个错误提醒： Lost connection to MySQL server during query。这时候如果你要继续，就需要重连，然后再执行请求了。</p><p>数据库里面，</p><p>长连接是指连接成功后，如果客户端持续有请求，则一直使用同一个连接。</p><p>短连接则是指每次执行完很少的几次查询就断开连接，下次查询再重新建立一个。</p><h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p>查询请求先访问缓存(key 是查询的语句，value 是查询的结果)。命中直接返回。</p><p>如果命中查询缓存，会在查询缓存返回结果的时候，做权限验证。</p><p>不推荐使用缓存，更新会把缓存清除(关闭缓存：参数 query_cache_type 设置成 DEMAND)。</p><p>你确定要使用查询缓存的语句，可以用 SQL_CACHE 显式指定，</p><figure class="highlight sql"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> SQL_CACHE <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> T <span class="hljs-keyword">where</span> ID<span class="hljs-operator">=</span><span class="hljs-number">10</span>；<br></code></pre></td></tr></table></figure><p>MYSQL 8.0 后不支持查询缓存</p><h2 id="分析器"><a href="#分析器" class="headerlink" title="分析器"></a>分析器</h2><p>对 SQL 语句做解析，判断sql是否正确。（先会做“词法分析”，再做“语法分析”。 ）</p><p>词法分析：有没有这个表，有没有这个字段</p><p>语法分析：select   写成  elect ,语法有没有错误</p><h2 id="优化器"><a href="#优化器" class="headerlink" title="优化器"></a>优化器</h2><p>在优化器之前调用 precheck 验证权限（你对这个表 T 有没有执行查询的权限）</p><p>决定使用哪个索引，多表关联（join）的时候，决定各个表的连接顺序。</p><h2 id="执行器"><a href="#执行器" class="headerlink" title="执行器"></a>执行器</h2><p>在执行之前，判断时候有执行的权限。（precheck是无法对运行时涉及到的表进行权限验证的，比如使用了触发器的情况。所以在执行器之前要再做权限验证）</p><p>select * from T where ID&#x3D;10;</p><p>操作存储引擎：</p><p>1.调用 InnoDB 引擎接口取这个表的第一行，判断 ID 值是不是 10，如果不是则跳过，如果是则将这行存在结果集中；</p><p>2.调用引擎接口取“下一行”，重复相同的判断逻辑，直到取到这个表的最后一行。</p><p>3.执行器将上述遍历过程中所有满足条件的行组成的记录集作为结果集返回给客户端。</p><h2 id="涉及参数"><a href="#涉及参数" class="headerlink" title="涉及参数"></a>涉及参数</h2><p>mysql8.0以前可以禁用缓存</p><p>query_cache_type 设置成 DEMAND</p><p>wait_timeout  连接超时时间  秒</p><h2 id="问与答"><a href="#问与答" class="headerlink" title="问与答"></a>问与答</h2><h3 id="使用mysql长连接后。内存涨得快；导致内存占用太大，被系统强行杀掉（OOM）-异常重启。"><a href="#使用mysql长连接后。内存涨得快；导致内存占用太大，被系统强行杀掉（OOM）-异常重启。" class="headerlink" title="使用mysql长连接后。内存涨得快；导致内存占用太大，被系统强行杀掉（OOM）,异常重启。"></a>使用mysql长连接后。内存涨得快；导致内存占用太大，被系统强行杀掉（OOM）,异常重启。</h3><p>因为 MySQL 在执行过程中临时使用的内存是管理在连接对象里面的。这些资源会在连接断开的时候才释放。</p><p>解决方案：</p><p>1.定期断开长连接。使用一段时间，或者程序里面判断执行过一个占用内存的大查询后，断开连接，之后要查询再重连。</p><p>2.如果你用的是 MySQL 5.7 或更新版本，可以在每次执行一个比较大的操作后，通过执行 mysql_reset_connection 来重新初始化连接资源。这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态。</p><h3 id="提示-you-have-an-error-in-your-sql-syntax-语法错误，在哪个阶段抛出。"><a href="#提示-you-have-an-error-in-your-sql-syntax-语法错误，在哪个阶段抛出。" class="headerlink" title="提示 you have an error in your sql syntax 语法错误，在哪个阶段抛出。"></a>提示 you have an error in your sql syntax 语法错误，在哪个阶段抛出。</h3><p>分析器抛出。</p><h3 id="提示表不存在、字段不存在，在哪个阶段抛出。"><a href="#提示表不存在、字段不存在，在哪个阶段抛出。" class="headerlink" title="提示表不存在、字段不存在，在哪个阶段抛出。"></a>提示表不存在、字段不存在，在哪个阶段抛出。</h3><p>分析器抛出。</p><h3 id="提示权限不足"><a href="#提示权限不足" class="headerlink" title="提示权限不足"></a>提示权限不足</h3><p>缓存、优化器之前、执行器。</p><h1 id="mysql日志系统"><a href="#mysql日志系统" class="headerlink" title="mysql日志系统"></a>mysql日志系统</h1><p>mysql不会每次更新都需要写磁盘，先找到磁盘上的那条记录，再更新，整个过程IO成本、查找时间成本都很高。</p><p>所以mysql会使用WAL技术（write Ahead logging）,先写日志，再写磁盘。</p><p>redo log（重做日志）和 binlog（归档日志）</p><p>有了 redo log，InnoDB 就可以保证即使数据库发生异常重启，之前提交的记录都不会丢失，这个能力称为 crash-safe。</p><h2 id="redo-log-与-binlog-如何联系起来的？"><a href="#redo-log-与-binlog-如何联系起来的？" class="headerlink" title="redo log 与 binlog 如何联系起来的？"></a>redo log 与 binlog 如何联系起来的？</h2><p>它们有一个共同的数据字段，叫 XID。</p><h2 id="binlog与redo-log的不同："><a href="#binlog与redo-log的不同：" class="headerlink" title="binlog与redo log的不同："></a>binlog与redo log的不同：</h2><p>1.redo log 是innoDB引擎特有的; binlog是mysql的server层实现的，所有引擎都可以使用。</p><p>2.redo log是物理日志，记录的是“在某个数据页上做了什么修改”; binlog是逻辑日志，记录的是这个语句的原始逻辑，比如“给ID&#x3D;2这一行的C字段加1”</p><p>3.redo log 是循环写的，空间固定会用完;binlog是可以追加写入的。“追加写”是指binlog文件写到一定大小后会切换到下一个，并不会覆盖以前的日志。</p><h2 id="redo-log-P02、P09、P12、P15、P23"><a href="#redo-log-P02、P09、P12、P15、P23" class="headerlink" title="redo log(P02、P09、P12、P15、P23)"></a>redo log(P02、P09、P12、P15、P23)</h2><p><img src="/.com//redolog%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%9B%BE.webp" alt="redolog数据结构图"></p><p>redo log 是实现了类似环形缓冲区，一个指针 write pos 是当前记录的位置，另一个指针 checkpoint 是当前要擦除的位置，write pos 和checkpoint 之间是空闲部分。如果 write pos 快追上 checkpoint 时，代表缓冲区快满了，需要暂停刷盘。</p><h3 id="redo-log-buffer"><a href="#redo-log-buffer" class="headerlink" title="redo log buffer"></a>redo log buffer</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t1 ...<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t2 ...<br><span class="hljs-keyword">commit</span>;<br></code></pre></td></tr></table></figure><p>插入数据的过程中，生成的日志都得先保存起来，但又不能在还没 commit 的时候就直接写到 redo log 文件里。</p><p>所以，redo log buffer 就是一块内存，用来先存 redo 日志的。也就是说，在执行第一个 insert 的时候，数据的内存被修改了，redo log buffer 也写入了日志。</p><h3 id="redolog-写入机制"><a href="#redolog-写入机制" class="headerlink" title="redolog 写入机制"></a>redolog 写入机制</h3><p>事务在执行过程中，生成的 redo log 是要先写到 redo log buffer 的。</p><p><img src="/.com//redolog%E7%8A%B6%E6%80%81%E5%9B%BE.webp" alt="redolog状态图"></p><p>这三种状态分别是：</p><p>1.存在 redo log buffer 中，物理上是在 MySQL 进程内存中，就是图中的红色部分；</p><p>2.写到磁盘 (write)，但是没有持久化（fsync)，物理上是在文件系统的 page cache 里面，也就是图中的黄色部分；</p><p>3.持久化到磁盘，对应的是 hard disk，也就是图中的绿色部分。</p><p>日志写到 redo log buffer 是很快的，wirte 到 page cache 也差不多，但是持久化到磁盘的速度就慢多了。</p><p>为了控制 redo log 的写入策略，InnoDB 提供了 innodb_flush_log_at_trx_commit 参数，它有三种可能取值：</p><p>1.设置为 0 的时候，表示每次事务提交时都只是把 redo log 留在 redo log buffer 中 ;</p><p>2.设置为 1 的时候，表示每次事务提交时都将 redo log 直接持久化到磁盘；</p><p>3.设置为 2 的时候，表示每次事务提交时都只是把 redo log 写到 page cache。</p><p>InnoDB 有一个后台线程，每隔 1 秒，就会把 redo log buffer 中的日志，调用 write 写到文件系统的 page cache，然后调用 fsync 持久化到磁盘。</p><p>事务执行中间过程的 redo log 也是直接写在 redo log buffer 中的，这些 redo log 也会被后台线程一起持久化到磁盘。也就是说，一个没有提交的事务的 redo log，也是可能已经持久化到磁盘的。</p><p>实际上，除了后台线程每秒一次的轮询操作外，还有两种场景会让一个没有提交的事务的 redo log 写入到磁盘中。</p><p>1.一种是，redo log buffer 占用的空间即将达到 innodb_log_buffer_size 一半的时候，后台线程会主动写盘。注意，由于这个事务并没有提交，所以这个写盘动作只是 write，而没有调用 fsync，也就是只留在了文件系统的 page cache。</p><p>2.另一种是，并行的事务提交的时候，顺带将这个事务的 redo log buffer 持久化到磁盘。假设一个事务 A 执行到一半，已经写了一些 redo log 到 buffer 中，这时候有另外一个线程的事务 B 提交，如果 innodb_flush_log_at_trx_commit 设置的是 1，那么按照这个参数的逻辑，事务 B 要把 redo log buffer 里的日志全部持久化到磁盘。这时候，就会带上事务 A 在 redo log buffer 里的日志一起持久化到磁盘。</p><p>如果把 innodb_flush_log_at_trx_commit 设置成 1，那么 redo log 在 prepare 阶段就要持久化一次，因为有一个崩溃恢复逻辑是要依赖于 prepare 的 redo log，再加上 binlog 来恢复的。</p><p>通常我们说 MySQL 的“双 1”配置，指的就是 sync_binlog 和 innodb_flush_log_at_trx_commit 都设置成 1。也就是说，一个事务完整提交前，需要等待两次刷盘，一次是 redo log（prepare 阶段），一次是 binlog。</p><h2 id="binlog-P02、P09、P12、P15、P23"><a href="#binlog-P02、P09、P12、P15、P23" class="headerlink" title="binlog(P02、P09、P12、P15、P23)"></a>binlog(P02、P09、P12、P15、P23)</h2><p>Server层日志。binlog 日志只能用于归档，没有crash-safe能力。</p><p>三个用途:</p><ol><li>恢复：利用binlog日志恢复数据库数据</li><li>复制：主从同步</li><li>审计：通过二进制日志中的信息来进行审计，判断是否有对数据库进行注入攻击</li></ol><p>格式：</p><table><thead><tr><th>format</th><th>定义</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>statement</td><td>记录的是修改SQL语句</td><td>日志文件小，节约IO，提高性能</td><td>准确性差，对一些系统函数不能准确复制或不能复制，如now()、uuid()等</td></tr><tr><td>row(推荐)</td><td>记录的是每行实际数据的变更，记两条，更新前和更新后</td><td>准确性强，能准确复制数据的变更</td><td>日志文件大，较大的网络IO和磁盘IO</td></tr><tr><td>mixed</td><td>statement和row模式的混合</td><td>准确性强，文件大小适中</td><td>有可能发生主从不一致问题</td></tr></tbody></table><p>binlog的三种格式对比：</p><p>一种是 statement，完整记录原sql,会因为主备库索引用的不一样，导至数据不一致（delete from t limit 3）</p><p>一种是 row。记录操作与操作记录详情，数据量会多（delete from t limit 100000）,但是易于恢复数据</p><p>可能你在其他资料上还会看到有第三种格式，叫作 mixed，其实它就是前两种格式的混合，如果msyql认为不会有歧义会用statement,会有用row</p><h3 id="binlog-的写入逻辑"><a href="#binlog-的写入逻辑" class="headerlink" title="binlog 的写入逻辑"></a>binlog 的写入逻辑</h3><p>事务执行过程中，先把日志写到 binlog cache，事务提交的时候，再把 binlog cache 写到 binlog 文件中。一个事务的 binlog 是不能被拆开的，因此不论这个事务多大，也要确保一次性写入。</p><p>参数 binlog_cache_size 用于控制单个线程内 binlog cache 所占内存的大小。如果超过了这个参数规定的大小，就要暂存到磁盘。</p><p>事务提交的时候，执行器把 binlog cache 里的完整事务写入到 binlog 中，并清空 binlog cache。</p><p><img src="/.com//binlog%E5%86%99%E5%85%A5%E9%80%BB%E8%BE%91.webp" alt="binlog写入逻辑"></p><p>每个线程有自己 binlog cache，但是共用同一份 binlog 文件。</p><p>图中的 write，指的就是指把日志写入到文件系统的 page cache，并没有把数据持久化到磁盘，所以速度比较快。</p><p>图中的 fsync，才是将数据持久化到磁盘的操作。一般情况下，我们认为 fsync 才占磁盘的 IOPS(（Input&#x2F;Output Operations Per Second)。</p><p>write 和 fsync 的时机，是由参数 sync_binlog 控制的：</p><p>1.sync_binlog&#x3D;0 的时候，表示每次提交事务都只 write，不 fsync；</p><p>2.sync_binlog&#x3D;1 的时候，表示每次提交事务都会执行 fsync；</p><p>3.sync_binlog&#x3D;N(N&gt;1) 的时候，表示每次提交事务都 write，但累积 N 个事务后才 fsync。</p><p>在出现 IO 瓶颈的场景里，将 sync_binlog 设置成一个比较大的值，可以提升性能。在实际的业务场景中，考虑到丢失日志量的可控性，一般不建议将这个参数设成 0，比较常见的是将其设置为 100~1000 中的某个数值。</p><p>将 sync_binlog 设置为 N，对应的风险是：如果主机发生异常重启，会丢失最近 N 个事务的 binlog 日志。</p><h2 id="组提交"><a href="#组提交" class="headerlink" title="组提交"></a>组提交</h2><p>因为redolog 和 binlog的写入机制，这意味着我从 MySQL 看到的 TPS 是每秒两万的话，每秒就会写四万次磁盘。但是，我用工具测试出来，磁盘能力也就两万左右，怎么能实现两万的 TPS？</p><p>mysql 使用了组提交（group commit）机制。</p><p>日志逻辑序列号（log sequence number，LSN）。LSN 是单调递增的，用来对应 redo log 的一个个写入点。每次写入长度为 length 的 redo log， LSN 的值就会加上 length。</p><p>LSN 也会写到 InnoDB 的数据页中，来确保数据页不会被多次执行重复的 redo log。</p><p><img src="/.com//redolog%E7%BB%84%E6%8F%90%E4%BA%A4.webp" alt="redolog组提交"></p><p>如图所示，是三个并发事务 (trx1, trx2, trx3) 在 prepare 阶段，都写完 redo log buffer，持久化到磁盘的过程，对应的 LSN 分别是 50、120 和 160。</p><p>从图中可以看到，</p><p>1.trx1 是第一个到达的，会被选为这组的 leader；</p><p>2.等 trx1 要开始写盘的时候，这个组里面已经有了三个事务，这时候 LSN 也变成了 160；</p><p>3.trx1 去写盘的时候，带的就是 LSN&#x3D;160，因此等 trx1 返回时，所有 LSN 小于等于 160 的 redo log，都已经被持久化到磁盘；</p><p>4.这时候 trx2 和 trx3 就可以直接返回了。</p><p>组提交可以减少磁盘IO。</p><p>在并发更新场景下，第一个事务写完 redo log buffer 以后，接下来这个 fsync 越晚调用，组员可能越多，节约 IOPS 的效果就越好。</p><p>写 binlog 是分成两步的：</p><p>1.先把 binlog 从 binlog cache 中写到磁盘上的 binlog 文件；</p><p>2.调用 fsync 持久化。</p><p>MySQL 为了让组提交的效果更好，把 redo log 做 fsync 的时间拖到了步骤 1 之后</p><p><img src="/.com//%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E7%BB%86%E5%8C%96.webp" alt="两阶段提交细化"></p><p>这么一来，binlog 也可以组提交了。在执行图 5 中第 4 步把 binlog fsync 到磁盘时，如果有多个事务的 binlog 已经写完了，也是一起持久化的，这样也可以减少 IOPS 的消耗。不过通常情况下第 3 步执行得会很快，所以 binlog 的 write 和 fsync 间的间隔时间短，导致能集合到一起持久化的 binlog 比较少，因此 binlog 的组提交的效果通常不如 redo log 的效果那么好。</p><p>如果你想提升 binlog 组提交的效果，可以通过设置 binlog_group_commit_sync_delay 和 binlog_group_commit_sync_no_delay_count 来实现。</p><p>binlog_group_commit_sync_delay 参数，表示延迟多少微秒后才调用 fsync;</p><p>binlog_group_commit_sync_no_delay_count 参数，表示累积多少次以后才调用 fsync。</p><p>这两个条件是或的关系，也就是说只要有一个满足条件就会调用 fsync。所以，当 binlog_group_commit_sync_delay 设置为 0 的时候，binlog_group_commit_sync_no_delay_count 也无效了。</p><p>WAL 机制是减少磁盘写，可是每次提交事务都要写 redo log 和 binlog，这磁盘读写次数也没变少呀？</p><p>WAL 机制主要得益于两个方面：</p><p>redo log 和 binlog 都是顺序写，磁盘的顺序写比随机写速度要快；</p><p>组提交机制，可以大幅度降低磁盘的 IOPS 消耗。</p><p>如果你的 MySQL 现在出现了性能瓶颈，而且瓶颈在 IO 上，可以通过哪些方法来提升性能呢？</p><p>1.设置 binlog_group_commit_sync_delay 和 binlog_group_commit_sync_no_delay_count 参数，减少 binlog 的写盘次数。这个方法是基于“额外的故意等待”来实现的，因此可能会增加语句的响应时间，但没有丢失数据的风险。</p><p>2.将 sync_binlog 设置为大于 1 的值（比较常见是 100~1000）。这样做的风险是，主机掉电时会丢 binlog 日志。</p><p>3.将 innodb_flush_log_at_trx_commit 设置为 2。这样做的风险是，主机掉电的时候会丢数据。</p><p>我不建议你把 innodb_flush_log_at_trx_commit 设置成 0。因为把这个参数设置成 0，表示 redo log 只保存在内存中，这样的话 MySQL 本身异常重启也会丢数据，风险太大。而 redo log 写到文件系统的 page cache 的速度也是很快的，所以将这个参数设置成 2 跟设置成 0 其实性能差不多，但这样做 MySQL 异常重启时就不会丢数据了，相比之下风险会更小。</p><h2 id="update-T-set-c-x3D-c-1-where-ID-x3D-2的执行过程"><a href="#update-T-set-c-x3D-c-1-where-ID-x3D-2的执行过程" class="headerlink" title="update T set c&#x3D;c+1 where ID&#x3D;2的执行过程"></a>update T set c&#x3D;c+1 where ID&#x3D;2的执行过程</h2><p><img src="/.com//update%E8%AF%AD%E5%8F%A5log%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B.webp" alt="update语句log执行过程"></p><p>取ID&#x3D;2这一行–》数据页在内存中？—》不在内存—》磁盘读入内存</p><p>取ID&#x3D;2这一行–》数据页在内存中？—》在内存中—》返回行数据—》将这行的C值加1—》写入新行—》新行更新到内存—》写入redolog处于prepare阶段—》写binlog—》提交事物处于commit状态</p><h2 id="两阶段提交"><a href="#两阶段提交" class="headerlink" title="两阶段提交"></a>两阶段提交</h2><p>1.redolog prepare阶段 </p><p>2.写binlog </p><p>3.redolog commit<br>当在2之前崩溃时<br>重启恢复：后发现没有commit，回滚。备份恢复：没有binlog 。<br>当在3之前崩溃<br>重启恢复：虽没有commit，但满足prepare和binlog完整，所以重启后会自动commit。备份：有binlog 。</p><h2 id="磁盘数据页"><a href="#磁盘数据页" class="headerlink" title="磁盘数据页"></a>磁盘数据页</h2><p>innodb引擎的数据都是按数据页读写的。也就是说，当需要读一条记录的时候，并不是将这个记录本身从磁盘读出来，而是以页为单位，将其整体读入内存。在 InnoDB 中，每个数据页的大小默认是 16KB。</p><h2 id="buffer-pool-内存缓冲池-（P12、P33）"><a href="#buffer-pool-内存缓冲池-（P12、P33）" class="headerlink" title="buffer pool(内存缓冲池)（P12、P33）"></a>buffer pool(内存缓冲池)（P12、P33）</h2><p>InnoDB 用缓冲池（buffer pool）管理内存，缓冲池中的内存页有三种状态：</p><p>第一种是，还没有使用的；</p><p>第二种是，使用了并且是干净页；</p><p>第三种是，使用了并且是脏页。</p><p>内存的数据页是在 Buffer Pool (BP) 中管理的，在 WAL 里 Buffer Pool 起到了加速更新的作用。而实际上，Buffer Pool 还有一个更重要的作用，就是加速查询。</p><p>执行 show engine innodb status ，可以看到“Buffer pool hit rate”字样，显示的就是当前的命中率。</p><p>InnoDB Buffer Pool 的大小是由参数 innodb_buffer_pool_size 确定的，一般建议设置成可用物理内存的 60%~80%。</p><p><img src="/.com//%E5%9F%BA%E6%9C%ACLRU%E7%AE%97%E6%B3%95.webp" alt="基本LRU算法"></p><p>mysql使用了改进的LRU算法：</p><p><img src="/.com//%E6%94%B9%E8%BF%9B%E7%9A%84LRU%E7%AE%97%E6%B3%95.webp" alt="改进的LRU算法"></p><p>改进后的 LRU 算法执行流程变成了下面这样。</p><p>1.状态 1，要访问数据页 P3，由于 P3 在 young 区域，因此和优化前的 LRU 算法一样，将其移到链表头部，变成状态 2。</p><p>2.之后要访问一个新的不存在于当前链表的数据页，这时候依然是淘汰掉数据页 Pm，但是新插入的数据页 Px，是放在 LRU_old 处。</p><p>3.处于 old 区域的数据页，每次被访问的时候都要做下面这个判断：</p><p>   若这个数据页在 LRU 链表中存在的时间超过了 1 秒，就把它移动到链表头部；</p><p>   如果这个数据页在 LRU 链表中存在的时间短于 1 秒，位置保持不变。1 秒这个时间，是由参数 innodb_old_blocks_time 控制的。其默认值是 1000，单位毫秒。</p><p>这个策略最大的收益，就是在扫描这个大表的过程中，虽然也用到了 Buffer Pool，但是对 young 区域完全没有影响，从而保证了 Buffer Pool 响应正常业务的查询命中率。</p><h2 id="change-buffer-P09"><a href="#change-buffer-P09" class="headerlink" title="change buffer(P09)"></a>change buffer(P09)</h2><p>当需要更新一个数据页时，如果数据页在内存中就直接更新，而如果这个数据页还没有在内存中的话，在不影响数据一致性的前提下，InnoDB 会将这些更新操作缓存在 change buffer 中，这样就不需要从磁盘中读入这个数据页了。在下次查询需要访问这个数据页的时候，将数据页读入内存，然后执行 change buffer 中与这个页有关的操作。</p><h3 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h3><p>将 change buffer 中的操作应用到原数据页，得到最新结果的过程称为 merge。除了访问这个数据页会触发 merge 外，系统有后台线程会定期 merge。在数据库正常关闭（shutdown）的过程中，也会执行 merge 操作。</p><p><img src="/.com//changebuffer.webp" alt="changebuffer"></p><p>change buffer 是优化修改用的。</p><p>redo log 是保证 crash safe的。redo log会记录 change buffer的内容。</p><h2 id="涉及参数-1"><a href="#涉及参数-1" class="headerlink" title="涉及参数"></a>涉及参数</h2><p>innodb_flush_log_at_trx_commit这个参数设置成1，表示每次事务的redo log都直接持久化到磁盘。 </p><p>sync_binlog这个参数设置成1的时候，表示每次事务的binlog都持久化到磁盘。</p><p>参数 binlog_cache_size 用于控制单个线程内 binlog cache 所占内存的大小。</p><p>binlog_group_commit_sync_delay 参数，表示延迟多少微秒后才调用 fsync;</p><p>binlog_group_commit_sync_no_delay_count 参数，表示累积多少次以后才调用 fsync。</p><p>binlog_format  binlog格式</p><p>innodb_log_buffer_size  log缓冲区大小</p><h1 id="磁盘存储（P13）"><a href="#磁盘存储（P13）" class="headerlink" title="磁盘存储（P13）"></a>磁盘存储（P13）</h1><p>一个 InnoDB 表包含两部分，即：表结构定义和数据。</p><p>在 MySQL 8.0 版本以前，表结构是存在以.frm 为后缀的文件里。</p><p>而 MySQL 8.0 版本，则已经允许把表结构定义放在系统数据表中了。</p><p>参数 innodb_file_per_table设置为OFF，表的数据放在系统共享表空间，也就是跟数据字典放在一起；</p><p>参数 innodb_file_per_table设置为ON,每个 InnoDB 表数据存储在一个以 .ibd 为后缀的文件中。</p><p>强烈建议使用on,如果drop一个表，磁盘上空间就可以使用了。</p><p>InnoDB 里的数据都是用 B+ 树的结构组织的。</p><h2 id="磁盘空间的空洞"><a href="#磁盘空间的空洞" class="headerlink" title="磁盘空间的空洞"></a>磁盘空间的空洞</h2><p>mysql删除一条记录，会这条记录标记为删除，然后如果有数据刚好符合这个位置的特性，就复用。如果删除的是整个数据页，就复用这个数据页，但数据页没有特性。总体来说mysql删除记录不会影响占用的磁盘空间。</p><p>mysql插入也会导导致磁盘空间的空洞，数据页与数据页。</p><p>如何去除这些已经删除了的数据的磁盘空间的空洞可以用重建表的方式。</p><p>如果要收缩一个表，只是 delete 掉表里面不用的数据的话，表文件的大小是不会变的，你还要通过 alter table 命令重建表，才能达到表文件变小的目的。我跟你介绍了重建表的两种实现方式，Online DDL 的方式是可以考虑在业务低峰期使用的，而 MySQL 5.5 及之前的版本，这个命令是会阻塞 DML 的，这个你需要特别小心。在重建表的时候，InnoDB 不会把整张表占满，每个页留了 1&#x2F;16 给后续的更新用。也就是说，其实重建表之后不是“最”紧凑的。</p><p> alter table A engine&#x3D;InnoDB </p><p>5.6以前执行流程</p><p><img src="/.com//5.6%E4%BB%A5%E5%89%8D%E9%87%8D%E5%BB%BA%E8%A1%A8.webp" alt="5.6以前重建表"></p><p>5.6以后 online DDL</p><p><img src="/.com//5.6%E4%BB%A5%E5%90%8E%E9%87%8D%E5%BB%BA%E8%A1%A8.webp" alt="5.6以后重建表"></p><p>1.建立一个临时文件，扫描表 A 主键的所有数据页；</p><p>2.用数据页中表 A 的记录生成 B+ 树，存储到临时文件中；</p><p>3.生成临时文件的过程中，将所有对 A 的操作记录在一个日志文件（row log）中，对应的是图中 state2 的状态；</p><p>4.临时文件生成后，将日志文件中的操作应用到临时文件，得到一个逻辑数据上与表 A 相同的数据文件，对应的就是图中 state3 的状态；</p><p>5.用临时文件替换表 A 的数据文件。</p><p>5.6以前花时间最多的步骤是往临时表插入数据的过程，如果在这个过程中，有新的数据要写入到表 A 的话，就会造成数据丢失。因此，在整个 DDL 过程中，表 A 中不能有更新。也就是说，这个 DDL 不是 Online 的。</p><p>5.6以后引入了Online DDL。</p><h2 id="Online（在线）-与-inplace（原地）"><a href="#Online（在线）-与-inplace（原地）" class="headerlink" title="Online（在线） 与  inplace（原地）"></a>Online（在线） 与  inplace（原地）</h2><p>对于 server 层来说，没有把数据挪动到临时表，是一个“原地”操作，这就是“inplace”名称的来源。</p><p>inplace 的 DDL是要占用临时空间的。</p><p>如果说这两个逻辑之间的关系是什么的话，可以概括为：</p><p>1.DDL 过程如果是 Online 的，就一定是 inplace 的；</p><p>2.反过来未必，也就是说 inplace 的 DDL，有可能不是 Online 的。截止到 MySQL 8.0，添加全文索引（FULLTEXT index）和空间索引 (SPATIAL index) 就属于这种情况。</p><h2 id="optimize-table、analyze-table-和-alter-table-这三种方式重建表的区别。"><a href="#optimize-table、analyze-table-和-alter-table-这三种方式重建表的区别。" class="headerlink" title="optimize table、analyze table 和 alter table 这三种方式重建表的区别。"></a>optimize table、analyze table 和 alter table 这三种方式重建表的区别。</h2><p>1.从 MySQL 5.6 版本开始，alter table t engine &#x3D; InnoDB（也就是 recreate）online；</p><p>2.analyze table t 其实不是重建表，只是对表的索引信息做重新统计，没有修改数据，这个过程中加了 MDL 读锁；</p><p>3.optimize table t 等于 recreate+analyze。</p><h2 id="涉及参数-2"><a href="#涉及参数-2" class="headerlink" title="涉及参数"></a>涉及参数</h2><p>参数 innodb_file_per_table设置为OFF，表的数据放在系统共享表空间，也就是跟数据字典放在一起；</p><p>参数 innodb_file_per_table设置为ON,每个 InnoDB 表数据存储在一个以 .ibd 为后缀的文件中。</p><h1 id="事务（P03、P08、P20、P21）"><a href="#事务（P03、P08、P20、P21）" class="headerlink" title="事务（P03、P08、P20、P21）"></a>事务（P03、P08、P20、P21）</h1><p>事务的特性：ACID(atomicity、consistency、isolation、durability),原子性、一致性、隔离性、持久性</p><table><thead><tr><th>事务隔离级别</th><th>脏读</th><th>不可重复读</th><th>幻读</th></tr></thead><tbody><tr><td>读未提交（read-uncommitted）</td><td>是</td><td>是</td><td>是</td></tr><tr><td>读提交（read-committed）</td><td>否</td><td>是</td><td>是</td></tr><tr><td>可重复读（repeatable-read）</td><td>否</td><td>否</td><td>是</td></tr><tr><td>串行化（serializable）</td><td>否</td><td>否</td><td>否</td></tr></tbody></table><p>mysql 5.6查看事务隔离级别：SELECT @@tx_isolation</p><p>mysql 8.0查看事务隔离级别：SELECT @@transaction_isolation </p><p>脏读：读到未提交的事务数据</p><p>不可重复读：一个事务执行过程中看到的数据，启动时和以后查询看到的不一致。（修改）</p><p>什么是幻读？</p><p>幻读指的是一个事务在前后两次查询同一个范围的时候，后一次查询看到了前一次查询没有看到的行。</p><p>幻读是针对insert导致的数据不一致，不可重复读是针对 delete、update导致的数据不一致。</p><p>如何解决幻读？</p><p>为了解决幻读问题，InnoDB 只好引入新的锁，也就是间隙锁 (Gap Lock)。</p><p>读未提交没有视图的概念，</p><p>串行化是加锁来避免并行访问，</p><p>可重复读是在事务启动时创建的视图，整个事务存在期间都用这个视图，</p><p>读提交是每个sql语句开始执行的时候创建的。</p><h2 id="事务隔离的实现"><a href="#事务隔离的实现" class="headerlink" title="事务隔离的实现"></a>事务隔离的实现</h2><h3 id="回滚段、undo-log"><a href="#回滚段、undo-log" class="headerlink" title="回滚段、undo log"></a>回滚段、undo log</h3><p>rollback segment称为回滚段，每个回滚段中有1024个undo log segment。每个undo操作在记录的时候占用一个undo log segment。<br>undo log有两个作用：提供回滚和多个行版本控制(MVCC)（Multi-Version Concurrency Control）。<br>在数据修改的时候，不仅记录了redo，还记录了相对应的undo，如果因为某些原因导致事务失败或回滚了，可以借助该undo进行回滚。<br>undo log和redo log记录物理日志不一样，undo log是逻辑日志。可以认为当delete一条记录时，undo log中会记录一条对应的insert记录，反之亦然，当update一条记录时，它记录一条对应相反的update记录。</p><h3 id="数据库的多版本并发控制（MVCC）"><a href="#数据库的多版本并发控制（MVCC）" class="headerlink" title="数据库的多版本并发控制（MVCC）"></a>数据库的多版本并发控制（MVCC）</h3><p>在 MySQL 中，实际上每条记录在更新的时候都会同时记录一条回滚操作。记录上的最新值，通过回滚操作，都可以得到前一个状态的值。</p><p>假设一个值从 1 被按顺序改成了 2、3、4，在回滚日志里面就会有类似下面的记录。</p><p><img src="/.com//%E5%9B%9E%E6%BB%9A%E6%AE%B5.webp" alt="回滚段"></p><p>当前值是 4，但是在查询这条记录的时候，不同时刻启动的事务会有不同的 read-view。如图中看到的，在视图 A、B、C 里面，这一个记录的值分别是 1、2、4，同一条记录在系统中可以存在多个版本，就是数据库的多版本并发控制（MVCC）。对于 read-view A，要得到 1，就必须将当前值依次执行图中所有的回滚操作得到。</p><p>同时你会发现，即使现在有另外一个事务正在将 4 改成 5，这个事务跟 read-view A、B、C 对应的事务是不会冲突的。</p><p>回滚段会一直保留吗？</p><p>不会，在不需要的时候才删除。</p><p>什么时候才不需要回滚段？</p><p>当系统里没有比这个回滚日志更早的read-view的时候。</p><p>为什么建议你尽量不要使用长事务？</p><p>mysql会保留它可能用到的回滚记录，会导致大量占用存储空间。</p><p>长事务占用锁资源，可能拖垮整个库。</p><p>你会有什么方案来避免系统中出现长事务，或者如何处理这种情况？</p><p>在应用开发端：</p><p>1.general_log开启</p><p>2.不需要用的事务的方法去掉事务</p><p>3.set_max_execution_time避免单个语句意外执行太长时间</p><p>从数据库：</p><p>1.监控information_schema.innodb_trx表，设置长事务阈值，超过就报警&#x2F;或者kill;</p><p>​用于查找持续时间超过 60s 的事务</p><p>​select * from information_schema.innodb_trx where TIME_TO_SEC(timediff(now(),trx_started))&gt;60</p><p>2.percona的pt-kill这个工具不错，推荐使用;</p><p>3.在业务功能测试阶段要求输出所有的general_log,分析日志行为提前发现问题;</p><p>4.如果使用的是mysql 5.6以后，把innodb_undo_tablespaces设置成2(或者更大的值)。如果真的出现大事务导致回滚段过大，这样设置后清理起来更方便。</p><h2 id="事务启动方式"><a href="#事务启动方式" class="headerlink" title="事务启动方式"></a>事务启动方式</h2><p>MySQL 的事务启动方式有以下几种：</p><p>1.显式启动事务语句， begin 或 start transaction。配套的提交语句是 commit，回滚语句是 rollback。</p><p>2.set autocommit&#x3D;0，这个命令会将这个线程的自动提交关掉。意味着如果你只执行一个 select 语句，这个事务就启动了，而且并不会自动提交。这个事务持续存在直到你主动执行 commit 或 rollback 语句，或者断开连接。</p><h2 id="一致性视图"><a href="#一致性视图" class="headerlink" title="一致性视图"></a>一致性视图</h2><h3 id="开启一致性视图"><a href="#开启一致性视图" class="headerlink" title="开启一致性视图"></a>开启一致性视图</h3><p>begin&#x2F;start transactioin命令并不是一个事务的起点，在执行到它们之后的第一个操作innodb表的语句，事务才真正启动。如果你想要马上启动一个事务，可以使用start transaction with consistent snapshot之个命令。</p><p>启动方式一，一致性视图是在执行第一个快照读语句时创建的;</p><p>启动方式二，一致性视图是在执行start transaction with consistent snapshot时创建的。</p><h3 id="一致性视图-1"><a href="#一致性视图-1" class="headerlink" title="一致性视图"></a>一致性视图</h3><p>在 MySQL 里，有两个“视图”的概念：</p><p>一个是 view。它是一个用查询语句定义的虚拟表，在调用的时候执行查询语句并生成结果。创建视图的语法是 create view … ，而它的查询方法与表一样。</p><p>另一个是 InnoDB 在实现 MVCC 时用到的一致性读视图，即 consistent read view，用于支持 RC（Read Committed，读提交）和 RR（Repeatable Read，可重复读）隔离级别的实现。</p><h2 id="“快照”在-MVCC-里是怎么工作的？"><a href="#“快照”在-MVCC-里是怎么工作的？" class="headerlink" title="“快照”在 MVCC 里是怎么工作的？"></a>“快照”在 MVCC 里是怎么工作的？</h2><p>innodb里面每个事务有一个惟一的事务ID，叫作transaction id.它是在事务开始的时候向innodb的事务系统申请的，是按申请顺序严格递增的。</p><p>每行数据也都是有多个版本的。每次事务更新数据的时候，都会生成一个新的数据版本，并把transaction id赋值给这个数据版本的事务ID,记为row trx_id。同时，旧的数据版本要保留，并且在新的数据版本中，能够有信息可以直接拿到它。也就是说，数据表中的一行记录，其实可能有多个版本（row）,每个版本有自己的row trx_id。</p><p><img src="/.com//innodb%E5%BF%AB%E7%85%A7.webp" alt="inodb快照"></p><p>上图中的三个虚线箭头就是undo log。</p><p>innodb为每个事务构造了一个数组，用来保存这个事务启动瞬间，当前正在“活跃”的所有事务ID。“活跃”指是启动了但还没提交。</p><p>数组里面事务ID的最小值记为低水位，当前系统里面已经创建过的事务ID的最大值加1记为高水位。这个视图数组和高水位，就组成了当前事务的一致性视图（read-view）。</p><p>而数据版本的可见性规则，就是基于数据的row trx_id和这个一致性视图的对比结果得到的。</p><p><img src="/.com//innodb%E5%BF%AB%E7%85%A7%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%81%E6%80%A7%E8%A7%84%E5%88%99.webp" alt="inodb快照数据可见性规则"></p><p>这样，对于当前事务的启动瞬间来说，一个数据版本的 row trx_id，有以下几种可能：</p><p>1.如果落在绿色部分，表示这个版本是已提交的事务或者是当前事务自己生成的，这个数据是可见的；</p><p>2.如果落在红色部分，表示这个版本是由将来启动的事务生成的，是肯定不可见的；</p><p>3.如果落在黄色部分，那就包括两种情况</p><p>a. 若 row trx_id 在数组中，表示这个版本是由还没提交的事务生成的，不可见；</p><p>b. 若 row trx_id 不在数组中，表示这个版本是已经提交了的事务生成的，可见。</p><p>innoDB 利用了“所有数据都有多个版本”的这个特性，实现了“秒级创建快照”的能力。</p><p>查询语句：</p><p>一个数据版本，对于一个事务视图来说，除了自己的更新总是可见以外，有三种情况：</p><p>1.版本未提交，不可见；</p><p>2.版本已提交，但是是在视图创建后提交的，不可见；</p><p>3.版本已提交，而且是在视图创建前提交的，可见。</p><p>更新语句：</p><p>更新数据都是先读后写的，而这个读，只能读当前的值，称为“当前读”（current read）。</p><p>除了 update 语句外，select 语句如果加锁，也是当前读。select加上 lock in share mode 或 for update也是当前读。就是分别加了读锁（S 锁，共享锁）和写锁（X 锁，排他锁）。</p><h2 id="涉及参数-3"><a href="#涉及参数-3" class="headerlink" title="涉及参数"></a>涉及参数</h2><p>mysql 5.6查看事务隔离级别：SELECT @@tx_isolation</p><p>mysql 8.0查看事务隔离级别：SELECT @@transaction_isolation </p><h1 id="索引（P04、P05、P09、P10、P11、P18）"><a href="#索引（P04、P05、P09、P10、P11、P18）" class="headerlink" title="索引（P04、P05、P09、P10、P11、P18）"></a>索引（P04、P05、P09、P10、P11、P18）</h1><p>索引的出现其实就是为了提高数据查询的效率。</p><p>索引的常见模型:哈希表、有序数组和搜索树</p><p>哈希表:</p><p>​hashmap 数组加链表，新增数据和查询等值数据会快，查询区间数据慢。</p><p>​使用Memory引擎时，使用的索引类型</p><p>有序数组：</p><p>​在等值查询和范围查询场景中的性能就都非常优秀。二分法查询，logn,新增会移动插入后的数据会很慢。有序数组索引只适用于静态存储引擎。</p><p>二叉树:</p><p>​因为数据是存储在磁盘中的，二叉树有可能会访问多个数据块，所以改进为b+树。</p><p>树可以有二叉，也可以有多叉。多叉树就是每个节点有多个儿子，儿子之间的大小保证从左到右递增。二叉树是搜索效率最高的，但是实际上大多数的数据库存储却并不使用二叉树。其原因是，索引不止存在内存中，还要写到磁盘上。</p><p>你可以想象一下一棵 100 万节点的平衡二叉树，树高 20。一次查询可能需要访问 20 个数据块。在机械硬盘时代，从磁盘随机读一个数据块需要 10 ms 左右的寻址时间。也就是说，对于一个 100 万行的表，如果使用二叉树来存储，单独访问一个行可能需要 20 个 10 ms 的时间，这个查询可真够慢的。</p><p>为了让一个查询尽量少地读磁盘，就必须让查询过程访问尽量少的数据块。那么，我们就不应该使用二叉树，而是要使用“N 叉”树。这里，“N 叉”树中的“N”取决于数据块的大小。</p><p>以 InnoDB 的一个整数字段索引为例，这个 N 差不多是 1200。这棵树高是 4 的时候，就可以存 1200 的 3 次方个值，这已经 17 亿了。考虑到树根的数据块总是在内存中的，一个 10 亿行的表上一个整数字段的索引，查找一个值最多只需要访问 3 次磁盘。其实，树的第二层也有很大概率在内存中，那么访问磁盘的平均次数就更少了。</p><p>N 叉树由于在读写上的性能优点，以及适配磁盘的访问模式，已经被广泛应用在数据库引擎中了。</p><h2 id="InnoDB-的索引模型b-树"><a href="#InnoDB-的索引模型b-树" class="headerlink" title="InnoDB 的索引模型b+树"></a>InnoDB 的索引模型b+树</h2><p>索引类型分为主键索引和非主键索引。</p><p>主键索引的叶子节点存的是整行数据。在 InnoDB 里，主键索引也被称为聚簇索引（clustered index）。</p><p>非主键索引的叶子节点内容是主键的值。在 InnoDB 里，非主键索引也被称为二级索引（secondary index）。</p><p>基于主键索引和普通索引的查询有什么区别？</p><p>普通索引需要回表，就是查一下主键索引。</p><h2 id="索引维护"><a href="#索引维护" class="headerlink" title="索引维护"></a>索引维护</h2><p>B+ 树为了维护索引有序性，在插入新值的时候需要做必要的维护。</p><p>一个数据页满了，按照B+Tree算法，新增加一个数据页，叫做页分裂，会导致性能下降。空间利用率降低大概50%。当相邻的两个数据页利用率很低的时候会做数据页合并，合并的过程是分裂过程的逆过程。</p><h2 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h2><p>select ID from T where k between 3 and 5，这时只需要查 ID 的值，而 ID 的值已经在 k 索引树上了，因此可以直接提供查询结果，不需要回表。也就是说，在这个查询里面，索引 k 已经“覆盖了”我们的查询需求，我们称为覆盖索引。</p><p>由于覆盖索引可以减少树的搜索次数，显著提升查询性能，所以使用覆盖索引是一个常用的性能优化手段。</p><h2 id="最左前缀原则"><a href="#最左前缀原则" class="headerlink" title="最左前缀原则"></a>最左前缀原则</h2><p>B+ 树这种索引结构，可以利用索引的“最左前缀”，来定位记录。</p><p>在建立联合索引的时候，如何安排索引内的字段顺序？</p><p>第一原则是，如果通过调整顺序，可以少维护一个索引，那么这个顺序往往就是需要优先考虑采用的。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `geek` (<br>  `a` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `b` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `c` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `d` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`a`,`b`),<br>  KEY `c` (`c`),<br>  KEY `ca` (`c`,`a`),<br>  KEY `cb` (`c`,`b`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB;<br></code></pre></td></tr></table></figure><p>索引ca可以去掉，如果查询条件中有C走C索引，如果有a会根据最左前缀原则走ab索引，如果查询条件c 和 b 会使用 c 和  cb</p><h2 id="索引下推"><a href="#索引下推" class="headerlink" title="索引下推"></a>索引下推</h2><p>可以在索引遍历过程中，对索引中包含的字段先做判断，直接过滤掉不满足条件的记录，减少回表次数。</p><p>优化器选择索引的目的，是找到一个最优的执行方案，并用最小的代价去执行语句。在数据库里面，扫描行数是影响执行代价的因素之一。扫描的行数越少，意味着访问磁盘数据的次数越少，消耗的 CPU 资源越少。优化器还会结合是否使用临时表、是否排序等因素进行综合判断。</p><h2 id="扫描行数是怎么判断的？"><a href="#扫描行数是怎么判断的？" class="headerlink" title="扫描行数是怎么判断的？"></a>扫描行数是怎么判断的？</h2><p>MySQL 在真正开始执行语句之前，并不能精确地知道满足这个条件的记录有多少条，而只能根据统计信息来估算记录数。这个统计信息就是索引的“区分度”。显然，一个索引上不同的值越多，这个索引的区分度就越好。而一个索引上不同的值的个数，我们称之为“基数”（cardinality）。也就是说，这个基数越大，索引的区分度越好。</p><p>show index from 表名  查看表的索引情况。</p><p>show slow query log 中的rows_examined 的行数。</p><p>explain 语句 查看rows字段，扫描行数。</p><p>show status like “%Innodb_rows_read%”; 执行语句; 再执行show status like “%Innodb_rows_read%”两数相减获得行数。</p><h3 id="MySQL-是怎样得到索引的基数的呢？"><a href="#MySQL-是怎样得到索引的基数的呢？" class="headerlink" title="MySQL 是怎样得到索引的基数的呢？"></a>MySQL 是怎样得到索引的基数的呢？</h3><p>采样统计：InnoDB 默认会选择 N 个数据页，统计这些页面上的不同值，得到一个平均值，然后乘以这个索引的页面数，就得到了这个索引的基数。而数据表是会持续更新的，索引统计信息也不会固定不变。所以，当变更的数据行数超过 1&#x2F;M 的时候，会自动触发重新做一次索引统计。</p><p>在 MySQL 中，有两种存储索引统计的方式，可以通过设置参数 innodb_stats_persistent 的值来选择：设置为 on 的时候，表示统计信息会持久化存储。这时，默认的 N 是 20，M 是 10。设置为 off 的时候，表示统计信息只存储在内存中。这时，默认的 N 是 8，M 是 16。</p><p>对于由于索引统计信息不准确导致的问题，你可以用 analyze table 来解决。</p><p>而对于其他优化器误判的情况，</p><p>​你可以在应用端用 force index 来强行指定索引，</p><p>​也可以通过修改语句来引导优化器，</p><p>​还可以通过增加或者删除索引来绕过这个问题。</p><h2 id="惟一索引与普通索引的选择"><a href="#惟一索引与普通索引的选择" class="headerlink" title="惟一索引与普通索引的选择"></a>惟一索引与普通索引的选择</h2><p><strong>查询：</strong></p><p> a、普通索引，查到满足条件的第一个记录后，继续查找下一个记录，知道第一个不满足条件的记录<br>​ b、唯一索引，由于索引唯一性，查到第一个满足条件的记录后，停止检索，但是，两者的性能差距微乎其微。因为InnoDB根据数据页来读写的。</p><p>更新：</p><p> a. 对于唯一索引来说，需要将数据页读入内存，判断到没有冲突，插入这个值，语句执行结束；<br> b. 对于普通索引来说，则是将更新记录在change buffer，语句执行就结束了。<br>更新这种情况，唯一索引会导致磁盘大量随机IO的访问（机械硬盘瓶颈）。<br>但这种情况不是绝对的，写多读少的场景change buffer记录的变更多，收益越大。常见业务模型账单类、日志类的系统。对于写完马上读取的情况，会立即触发merge，反而增加了维护change buffer的成本。<br>所以尽量选择普通索引。</p><h2 id="索引失效"><a href="#索引失效" class="headerlink" title="索引失效"></a>索引失效</h2><p>对索引字段做函数操作，可能会破坏索引值的有序性，因此优化器就决定放弃走树搜索功能。</p><p>1.直接对索引字段做函数操作</p><p>2.隐式类型转换(字符串与整数进行比较时，字符串会转换成整数，如果字段是字符串，相当于加了转换函数，这时不走索引，如果条件是字符串，条件会转换成整数，可以走索引)</p><p>3.隐式字符编码转换（同隐式类型转换，比如utf8mb4与utf8）</p><h2 id="虚拟列-P37"><a href="#虚拟列-P37" class="headerlink" title="虚拟列(P37)"></a>虚拟列(P37)</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> id<span class="hljs-operator">%</span><span class="hljs-number">10</span> <span class="hljs-keyword">as</span> m, <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> c <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> m;<br></code></pre></td></tr></table></figure><p>在 MySQL 5.7 版本支持了 generated column 机制，用来实现列数据的关联更新。你可以用下面的方法创建一个列 z，然后在 z 列上创建一个索引（如果是 MySQL 5.6 及之前的版本，你也可以创建普通列和索引，来解决这个问题）。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> t1 <span class="hljs-keyword">add</span> <span class="hljs-keyword">column</span> z <span class="hljs-type">int</span> generated always <span class="hljs-keyword">as</span>(id <span class="hljs-operator">%</span> <span class="hljs-number">100</span>), <span class="hljs-keyword">add</span> index(z);<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> z, <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> c <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> z;<br></code></pre></td></tr></table></figure><h2 id="涉及参数-4"><a href="#涉及参数-4" class="headerlink" title="涉及参数"></a>涉及参数</h2><p>在 MySQL 中，有两种存储索引统计的方式，可以通过设置参数 innodb_stats_persistent 的值来选择：设置为 on 的时候，表示统计信息会持久化存储。这时，默认的 N 是 20，M 是 10。设置为 off 的时候，表示统计信息只存储在内存中。这时，默认的 N 是 8，M 是 16。</p><h1 id="锁（P06、P07、P19）"><a href="#锁（P06、P07、P19）" class="headerlink" title="锁（P06、P07、P19）"></a>锁（P06、P07、P19）</h1><p>数据库锁设计的初衷是处理并发问题。作为多用户共享的资源，当出现并发访问的时候，数据库需要合理地控制资源的访问规则。而锁就是用来实现这些访问规则的重要数据结构。</p><p>全局锁、表级锁和行锁三类</p><p>全局锁和表级锁是在server层实现的，而行级锁是在引擎层实现。</p><h2 id="全局锁"><a href="#全局锁" class="headerlink" title="全局锁"></a>全局锁</h2><p>全局锁就是对整个数据库实例加锁。MySQL 提供了一个加全局读锁的方法，命令是 (FTWRL)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">Flush tables <span class="hljs-keyword">with</span> read lock <br></code></pre></td></tr></table></figure><p>当你需要让整个库处于只读状态的时候，可以使用这个命令，之后其他线程的以下语句会被阻塞：数据更新语句（数据的增删改）、数据定义语句（包括建表、修改表结构等）和更新类事务的提交语句。</p><p>全局锁的典型使用场景是，做全库逻辑备份。</p><p>在备份过程中整个库完全处于只读状态。</p><p>如果你在主库上备份，那么在备份期间都不能执行更新，业务基本上就得停摆；</p><p>如果你在从库上备份，那么备份期间从库不能执行主库同步过来的 binlog，会导致主从延迟。</p><p>官方自带的逻辑备份工具是 mysqldump。当 mysqldump 使用参数–single-transaction 的时候，导数据之前就会启动一个事务，来确保拿到一致性视图。而由于 MVCC 的支持，这个过程中数据是可以正常更新的。</p><p>一致性读是好，但前提是引擎要支持这个隔离级别。single-transaction 方法只适用于所有的表使用事务引擎的库。</p><p>但当引擎不支持事务时，只能使用FTWRL 命令了。</p><p>既然要全库只读，为什么不使用 set global readonly&#x3D;true 的方式呢？</p><p>1.其他业务上的判断，比如主从</p><p>2.没有回滚机制，一直是readonly&#x3D;true</p><h3 id="如何查看flush"><a href="#如何查看flush" class="headerlink" title="如何查看flush"></a>如何查看flush</h3><p>使用 show processlist 命令查看 state列为Waiting for table flush，现在有一个线程正要对表 t 做 flush 操作。MySQL 里面对表做 flush 操作的用法，一般有以下两个：<br>flush tables t with read lock;<br>flush tables with read lock;</p><p>但是正常这两个语句执行起来都很快，除非它们也被别的线程堵住了，所以，出现 Waiting for table flush 状态的可能情况是：有一个 flush tables 命令被别的语句堵住了，然后它又堵住了我们的 select 语句。</p><h2 id="表级锁"><a href="#表级锁" class="headerlink" title="表级锁"></a>表级锁</h2><p>MySQL 里面表级别的锁有两种：一种是表锁，一种是元数据锁（meta data lock，MDL)。</p><h3 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h3><p>表锁的语法是 lock tables … read&#x2F;write。与 FTWRL 类似，可以用 unlock tables 主动释放锁，也可以在客户端断开的时候自动释放。需要注意，lock tables 语法除了会限制别的线程的读写外，也限定了本线程接下来的操作对象。</p><h3 id="元数据锁-MDL"><a href="#元数据锁-MDL" class="headerlink" title="元数据锁(MDL)"></a>元数据锁(MDL)</h3><p>另一类表级的锁是 MDL（metadata lock)。MDL 不需要显式使用，在访问一个表的时候会被自动加上。MDL 的作用是，保证读写的正确性。你可以想象一下，如果一个查询正在遍历一个表中的数据，而执行期间另一个线程对这个表结构做变更，删了一列，那么查询线程拿到的结果跟表结构对不上，肯定是不行的。</p><p>当对一个表做增删改查操作的时候，加 MDL 读锁；当要对表做结构变更操作的时候，加 MDL 写锁。</p><p>读锁之间不互斥，因此你可以有多个线程同时对一张表增删改查。</p><p>读写锁之间、写锁之间是互斥的，用来保证变更表结构操作的安全性。因此，如果有两个线程要同时给一个表加字段，其中一个要等另一个执行完才能开始执行。</p><h4 id="如何查看MDL写锁，MDL写锁会阻塞sql语句的执行"><a href="#如何查看MDL写锁，MDL写锁会阻塞sql语句的执行" class="headerlink" title="如何查看MDL写锁，MDL写锁会阻塞sql语句的执行"></a>如何查看MDL写锁，MDL写锁会阻塞sql语句的执行</h4><p>使用 show processlist 命令查看 state列为Waiting for table metadata lock，说明有mdl写锁</p><h4 id="给一个小表加个字段，导致整个库挂了。"><a href="#给一个小表加个字段，导致整个库挂了。" class="headerlink" title="给一个小表加个字段，导致整个库挂了。"></a>给一个小表加个字段，导致整个库挂了。</h4><p>给一个表加字段，或者修改字段，或者加索引，需要扫描全表的数据。在对大表操作的时候，你肯定会特别小心，以免对线上服务造成影响。</p><p><img src="/.com//%E5%B0%8F%E8%A1%A8%E5%8A%A0%E5%AD%97%E6%AE%B5%E8%A2%AB%E9%94%81.webp" alt="小表加字段被锁"></p><p>我们可以看到 session A 先启动，这时候会对表 t 加一个 MDL 读锁。</p><p>由于 session B 需要的也是 MDL 读锁，因此可以正常执行。</p><p>之后 session C 会被 blocked，是因为 session A 的 MDL 读锁还没有释放，而 session C 需要 MDL 写锁，因此只能被阻塞。</p><p>如果只有 session C 自己被阻塞还没什么关系，但是之后所有要在表 t 上新申请 MDL 读锁的请求也会被 session C 阻塞。</p><p>前面我们说了，所有对表的增删改查操作都需要先申请 MDL 读锁，就都被锁住，等于这个表现在完全不可读写了。</p><p>如果某个表上的查询语句频繁，而且客户端有重试机制，也就是说超时后会再起一个新 session 再请求的话，这个库的线程很快就会爆满。</p><p>你现在应该知道了，事务中的 MDL 锁，在语句执行开始时申请，但是语句结束后并不会马上释放，而会等到整个事务提交后再释放。</p><p>mdl读锁（select）执行的时间长点，mdl写锁（修改结构）被阻塞，mdl读锁（select）因为读写互斥，以后的mdl读都被阻塞，整个库挂掉。</p><h5 id="如何安全地给小表加字段？"><a href="#如何安全地给小表加字段？" class="headerlink" title="如何安全地给小表加字段？"></a>如何安全地给小表加字段？</h5><p>首先我们要解决长事务，事务不提交，就会一直占着 MDL 锁。在 MySQL 的 information_schema 库的 innodb_trx 表中，你可以查到当前执行中的事务。如果你要做 DDL 变更的表刚好有长事务在执行，要考虑先暂停 DDL，或者 kill 掉这个长事务。</p><h5 id="如果你要变更的表是一个热点表，虽然数据量不大，但是上面的请求很频繁，而你不得不加个字段，你该怎么做呢？"><a href="#如果你要变更的表是一个热点表，虽然数据量不大，但是上面的请求很频繁，而你不得不加个字段，你该怎么做呢？" class="headerlink" title="如果你要变更的表是一个热点表，虽然数据量不大，但是上面的请求很频繁，而你不得不加个字段，你该怎么做呢？"></a>如果你要变更的表是一个热点表，虽然数据量不大，但是上面的请求很频繁，而你不得不加个字段，你该怎么做呢？</h5><p>在 alter table 语句里面设定等待时间，如果在这个指定的等待时间里面能够拿到 MDL 写锁最好，拿不到也不要阻塞后面的业务语句，先放弃。之后开发人员或者 DBA 再通过重试命令重复这个过程。</p><p>MariaDB 已经合并了 AliSQL 的这个功能，所以这两个开源分支目前都支持 DDL NOWAIT&#x2F;WAIT n 这个语法。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> tbl_name NOWAIT <span class="hljs-keyword">add</span> <span class="hljs-keyword">column</span> ...<br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> tbl_name WAIT N <span class="hljs-keyword">add</span> <span class="hljs-keyword">column</span> ... <br></code></pre></td></tr></table></figure><h2 id="行锁"><a href="#行锁" class="headerlink" title="行锁"></a>行锁</h2><p>行锁就是针对数据表中行记录的锁。</p><p>在innodb事务中，行锁是在需要的时候才加上的，但并不是不需要了就立刻释放，而是要等到事务结束时才释放。这个就是两阶段锁协议。</p><p>如果你的事务中需要锁多个行，要把最可能造成锁冲突、最可能影响并发度的锁尽量往后放。</p><p>顾客A要在影院B购买电影票。</p><p>1.从顾客A账户余额中扣除电影票价;</p><p>2.给影院B的账户余额增加这张电影票价;</p><p>3.记录一条交易日志;</p><p>因为影院B的账户会对应多个顾客所以会影响并发度。</p><p>3 1 2的编写顺序是比较好的。3是新增，1是个人账户，2是并发度高的账户。这样的顺序提升了并发度。</p><h4 id="如何查看行锁"><a href="#如何查看行锁" class="headerlink" title="如何查看行锁"></a>如何查看行锁</h4><p>使用show processlist命令查看state列值为statistics  ID字段为thread_id</p><p>或使select * from information_schema.innodb_trx where trx_mysql_thread_id &#x3D; </p><p>例如</p><p>sessionA 执行update t set c&#x3D;c+1 where id &#x3D; 1;</p><p>sessionB执行select * from t where id &#x3D; 1 lock in share mode;</p><p>怎么查出是谁占着这个写锁？</p><p>可以通过 sys.innodb_lock_waits 表查到。<br>select * from t sys.innodb_lock_waits where locked_table&#x3D;’<code>test</code>.<code>t</code>‘\G</p><p>查看blocking_pid:4就是哪个线程的ID,执行kill 4</p><h3 id="间隙锁（P20、P21）"><a href="#间隙锁（P20、P21）" class="headerlink" title="间隙锁（P20、P21）"></a>间隙锁（P20、P21）</h3><p>跟间隙锁存在冲突关系的，是“往这个间隙中插入一个记录”这个操作。间隙锁之间都不存在冲突关系。</p><p>间隙锁和行锁合称 next-key lock，每个 next-key lock 是前开后闭区间。就是(0,5],(5,10],锁(0,5]是不包含0，包含5的锁。行锁为5，间隙锁为（0，5）</p><p>开区间  不包含 由（）表示； 闭区间 包含 由[] 表示</p><p>间隙锁的引入，可能会导致同样的语句锁住更大的范围，这其实是影响了并发度的。</p><p>比如sessionA与sessionB同时执行select * for update语句，同时插入同一条数据，这时就形成了死锁。两个间隙锁同时要插入数据，但是都被对方拿着锁。</p><p>间隙锁是在可重复读隔离级别下才会生效的。所以，你如果把隔离级别设置为读提交的话，就没有间隙锁了，但同时，你要解决可能出现的数据和日志不一致问题，需要把 binlog 格式设置为 row。为了解决binlog一致性问题。</p><p>如果binlog为statmen,会出现一致性问题：</p><p><img src="/.com//binlog%E6%A0%BC%E5%BC%8Fstatment%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98.webp" alt="binlog格式statment数据一致性问题"></p><p> binlog 里面的内容。</p><p>T2 时刻，session B 事务提交，写入了两条语句；</p><p>T4 时刻，session C 事务提交，写入了两条语句；</p><p>T6 时刻，session A 事务提交，写入了 update t set d&#x3D;100 where d&#x3D;5 这条语句。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><br><span class="hljs-keyword">update</span> t <span class="hljs-keyword">set</span> d<span class="hljs-operator">=</span><span class="hljs-number">5</span> <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">0</span>; <span class="hljs-comment">/*(0,0,5)*/</span><br><span class="hljs-keyword">update</span> t <span class="hljs-keyword">set</span> c<span class="hljs-operator">=</span><span class="hljs-number">5</span> <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">0</span>; <span class="hljs-comment">/*(0,5,5)*/</span><br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t <span class="hljs-keyword">values</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">5</span>); <span class="hljs-comment">/*(1,1,5)*/</span><br><span class="hljs-keyword">update</span> t <span class="hljs-keyword">set</span> c<span class="hljs-operator">=</span><span class="hljs-number">5</span> <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>; <span class="hljs-comment">/*(1,5,5)*/</span><br><br><span class="hljs-keyword">update</span> t <span class="hljs-keyword">set</span> d<span class="hljs-operator">=</span><span class="hljs-number">100</span> <span class="hljs-keyword">where</span> d<span class="hljs-operator">=</span><span class="hljs-number">5</span>;<span class="hljs-comment">/*所有d=5的行，d改成100*/</span><br></code></pre></td></tr></table></figure><p>这个语句序列，不论是拿到备库去执行，还是以后用 binlog 来克隆一个库，这三行的结果，都变成了 (0,5,100)、(1,5,100) 和 (5,5,100)。</p><p>出现了数据一致性问题。</p><h4 id="mysql-可重复读的隔离级别下加锁规则："><a href="#mysql-可重复读的隔离级别下加锁规则：" class="headerlink" title="mysql 可重复读的隔离级别下加锁规则："></a>mysql 可重复读的隔离级别下加锁规则：</h4><p>包含了两个“原则”、两个“优化”和一个“bug”。</p><p>1.原则 1：加锁的基本单位是 next-key lock。希望你还记得，next-key lock 是前开后闭区间。</p><p>2.原则 2：查找过程中访问到的对象才会加锁。</p><p>3.优化 1：索引上的等值查询，给唯一索引加锁的时候，next-key lock 退化为行锁。只有记录存在时才会优化，不存在时会按普通索引处理。</p><p>4.优化 2：索引上的等值查询，向右遍历时且最后一个值不满足等值条件的时候，next-key lock 退化为间隙锁。范围查询不会退化。</p><p>5.一个 bug：唯一索引上的范围查询会访问到不满足条件的第一个值为止。(8.0版本已经不是这样了)</p><h3 id="锁与索引关系"><a href="#锁与索引关系" class="headerlink" title="锁与索引关系"></a>锁与索引关系</h3><p>锁是加在索引上的.</p><p>lock in share mode 只锁覆盖索引，但是如果是 for update 就不一样了。 执行 for update 时，系统会认为你接下来要更新数据，因此会顺便给主键索引上满足条件的行加上行锁。</p><p>在惟一索引上做范围查询，左侧有等于时，会按照等值查询，后面按照范围查询。例如id&gt;&#x3D;10 and id &lt;15</p><p>间隙锁是可重入锁，我们在分析加锁规则的时候可以用 next-key lock 来分析。但是要知道，具体执行的时候，是要分成间隙锁和行锁两段来执行的。</p><h2 id="死锁和死锁检测"><a href="#死锁和死锁检测" class="headerlink" title="死锁和死锁检测"></a>死锁和死锁检测</h2><p>当并发系统中不同线程出现循环资源依赖，涉及的线程都在等待别的线程释放资源时，就会导致这几个线程进入无限等待的状态，称为死锁。</p><p>出现死锁后的两种策略：</p><p>策略1.直接进入等待，直到超时。这个超时时间可以通过参数innodb_lock_wait_timeout来设置。默认是50秒。</p><p>策略2.发起死锁检测，发现死锁后，主动回滚死锁链条中的某一个事务，让其他事务得以断续执行。将参数innodb_deadlock_detect设置为on,表示开启这个逻辑。</p><p>减少死锁的主要方向就是控制访问相同资源的并发事务量。</p><h2 id="涉及参数-5"><a href="#涉及参数-5" class="headerlink" title="涉及参数"></a>涉及参数</h2><p>锁等待超时innodb_lock_wait_timeout来设置。默认是50秒。</p><h2 id="问与答-1"><a href="#问与答-1" class="headerlink" title="问与答"></a>问与答</h2><h3 id="你要删除一个表里面的前10000行数据。以下三个方法哪个好，为什么？"><a href="#你要删除一个表里面的前10000行数据。以下三个方法哪个好，为什么？" class="headerlink" title="你要删除一个表里面的前10000行数据。以下三个方法哪个好，为什么？"></a>你要删除一个表里面的前10000行数据。以下三个方法哪个好，为什么？</h3><p>1.直接执行delete from T limit 10000;</p><p>2.在一个连接中循环执行20次delete from T limit 500;</p><p>3.在20个连接中同时执行delete from T limit 500;</p><p>方法一 长事务，造成锁等待，锁等待时间长。</p><p>方法三 人为造成锁竞争。</p><p>方法二比较好，短事务，锁时间短。</p><h3 id="怎么解决由这种热点更新导致的性能问题呢？（cpu100-每秒执行不到100个事务，因为开启了死锁检测，cpu一直在死锁检测）"><a href="#怎么解决由这种热点更新导致的性能问题呢？（cpu100-每秒执行不到100个事务，因为开启了死锁检测，cpu一直在死锁检测）" class="headerlink" title="怎么解决由这种热点更新导致的性能问题呢？（cpu100%,每秒执行不到100个事务，因为开启了死锁检测，cpu一直在死锁检测）"></a>怎么解决由这种热点更新导致的性能问题呢？（cpu100%,每秒执行不到100个事务，因为开启了死锁检测，cpu一直在死锁检测）</h3><p>方案1.如果你能确保这个业务一定不会出现死锁，可以临时把死锁检测关掉。关掉死锁检测意味着可能会出现大量的超时，这是业务有损的。</p><p>方案2.控制并发度。有中间件，可以考虑在中间件实现;有能改mysql源码的人，可以在mysql里面做。基本思路：对于相同行的更新，在进入引擎之前排队。</p><p>把一行并发资源改为多行资源，减少锁等待个数，也就减少了死锁检测的cpu消耗。（业务上有特殊处理）</p><p>1、业务不会出现死锁时，可以临时关闭</p><p>2、在客户端控制并发</p><p>3、修改MYSQL源码，并发引入引擎之前排队</p><p>4、将一行数据改为多行，如将一个余额账户分为多个，但在数据减少操作时需考虑小于0的情况。</p><h1 id="自增主键（P39、P45）"><a href="#自增主键（P39、P45）" class="headerlink" title="自增主键（P39、P45）"></a>自增主键（P39、P45）</h1><h2 id="主键是选自增主键还是业务主键"><a href="#主键是选自增主键还是业务主键" class="headerlink" title="主键是选自增主键还是业务主键"></a>主键是选自增主键还是业务主键</h2><p>要求建表语句里一定要有自增主键。为什么？</p><p>自增主键，每次插入一条新记录，都是追加操作，都不涉及到挪动其他记录，也不会触发叶子节点的分裂。</p><p>而有业务逻辑的字段做主键，则往往不容易保证有序插入，这样写数据成本相对较高。</p><p>由于每个非主键索引的叶子节点上都是主键的值。如果用身份证号做主键，那么每个二级索引的叶子节点占用约 20 个字节，而如果用整型做主键，则只要 4 个字节，如果是长整型（bigint）则是 8 个字节。</p><p>主键长度越小，普通索引的叶子节点就越小，普通索引占用的空间也就越小。</p><p>从性能和存储空间方面考量，自增主键往往是更合理的选择。</p><p>有没有什么场景适合用业务字段直接做主键的呢？</p><p>还是有的。比如，有些业务的场景需求是这样的：</p><p>只有一个索引；</p><p>该索引必须是唯一索引。</p><p>你一定看出来了，这就是典型的 KV 场景。</p><p>由于没有其他索引，所以也就不用考虑其他索引的叶子节点大小的问题。</p><h2 id="自增值保存在哪儿？"><a href="#自增值保存在哪儿？" class="headerlink" title="自增值保存在哪儿？"></a>自增值保存在哪儿？</h2><p>表的结构定义存放在后缀名为.frm 的文件中，但是并不会保存自增值。</p><p>不同的引擎对于自增值的保存策略不同:</p><p>MyISAM 引擎的自增值保存在数据文件中。</p><p>InnoDB 引擎的自增值，其实是保存在了内存里，并且到了 MySQL 8.0 版本后，才有了“自增值持久化”的能力，也就是才实现了“如果发生重启，表的自增值可以恢复为 MySQL 重启前的值”，具体情况是：</p><p>1.在 MySQL 5.7 及之前的版本，自增值保存在内存里，并没有持久化。每次重启后，第一次打开表的时候，都会去找自增值的最大值 max(id)，然后将 max(id)+1 作为这个表当前的自增值。﻿举例来说，如果一个表当前数据行里最大的 id 是 10，AUTO_INCREMENT&#x3D;11。这时候，我们删除 id&#x3D;10 的行，AUTO_INCREMENT 还是 11。但如果马上重启实例，重启后这个表的 AUTO_INCREMENT 就会变成 10。﻿也就是说，MySQL 重启可能会修改一个表的 AUTO_INCREMENT 的值。</p><p>2.在 MySQL 8.0 版本，将自增值的变更记录在了 redo log 中，重启的时候依靠 redo log 恢复重启之前的值。</p><h2 id="自增值修改机制"><a href="#自增值修改机制" class="headerlink" title="自增值修改机制"></a>自增值修改机制</h2><p>1.如果插入数据时 id 字段指定为 0、null 或未指定值，那么就把这个表当前的 AUTO_INCREMENT 值填到自增字段；</p><p>2.如果插入数据时 id 字段指定了具体的值，就直接使用语句里指定的值。</p><p>新的自增值生成算法是：从 auto_increment_offset 开始，以 auto_increment_increment 为步长，持续叠加，直到找到第一个大于 X 的值，作为新的自增值。其中，auto_increment_offset 和 auto_increment_increment 是两个系统参数，分别用来表示自增的初始值和步长，默认值都是 1。</p><p>在一些场景下，使用的就不全是默认值。比如，双 M 的主备结构里要求双写的时候，我们就可能会设置成 auto_increment_increment&#x3D;2，让一个库的自增 id 都是奇数，另一个库的自增 id 都是偶数，避免两个库生成的主键发生冲突。</p><h2 id="自增值的修改时机"><a href="#自增值的修改时机" class="headerlink" title="自增值的修改时机"></a>自增值的修改时机</h2><p>1.执行器调用 InnoDB 引擎接口写入一行，传入的这一行的值是 (0,1,1);</p><p>2.InnoDB 发现用户没有指定自增 id 的值，获取表 t 当前的自增值 2；</p><p>3.将传入的行的值改成 (2,1,1);</p><p>4.将表的自增值改成 3；</p><p>5.继续执行插入数据操作，由于已经存在 c&#x3D;1 的记录，所以报 Duplicate key error，语句返回。</p><h2 id="自增锁的优化"><a href="#自增锁的优化" class="headerlink" title="自增锁的优化"></a>自增锁的优化</h2><p>在 MySQL 5.0 版本的时候，自增锁的范围是语句级别。也就是说，如果一个语句申请了一个表自增锁，这个锁会等语句执行结束以后才释放。显然，这样设计会影响并发度。</p><p>MySQL 5.1.22 版本引入了一个新策略，新增参数 innodb_autoinc_lock_mode，默认值是 1。</p><p>这个参数的值被设置为 0 时，表示采用之前 MySQL 5.0 版本的策略，即语句执行结束后才释放锁；</p><p>这个参数的值被设置为 1 时：普通 insert 语句，自增锁在申请之后就马上释放；类似 insert … select 这样的批量插入数据的语句，自增锁还是要等语句结束后才被释放；</p><p>这个参数的值被设置为 2 时，所有的申请自增主键的动作都是申请后就释放锁。</p><h2 id="生产有insert-…-select-这种批量插入数据的场景时优化"><a href="#生产有insert-…-select-这种批量插入数据的场景时优化" class="headerlink" title="生产有insert … select 这种批量插入数据的场景时优化"></a>生产有insert … select 这种批量插入数据的场景时优化</h2><p>在生产上，尤其是有 insert … select 这种批量插入数据的场景时，从并发插入数据性能的角度考虑，我建议你这样设置：innodb_autoinc_lock_mode&#x3D;2 ，并且 binlog_format&#x3D;row. 这样做，既能提升并发性，又不会出现数据一致性问题。</p><p>批量插入数据，包含的语句类型是 insert … select、replace … select 和 load data 语句。</p><h2 id="MySQL-有一个批量申请自增-id-的策略："><a href="#MySQL-有一个批量申请自增-id-的策略：" class="headerlink" title="MySQL 有一个批量申请自增 id 的策略："></a>MySQL 有一个批量申请自增 id 的策略：</h2><ol><li><p>语句执行过程中，第一次申请自增 id，会分配 1 个；</p></li><li><p>1 个用完以后，这个语句第二次申请自增 id，会分配 2 个；</p></li><li><p>2 个用完以后，还是这个语句，第三次申请自增 id，会分配 4 个；</p></li><li><p>依此类推，同一个语句去申请自增 id，每次申请到的自增 id 个数都是上一次的两倍。</p></li></ol><p>在 binlog_format&#x3D;statement 时， binlog里会有SET INSERT_ID&#x3D;ID值的行，主从同步时不会出现问题。</p><h2 id="MySQL-不同的自增-id-达到上限以后的行为-P45"><a href="#MySQL-不同的自增-id-达到上限以后的行为-P45" class="headerlink" title="MySQL 不同的自增 id 达到上限以后的行为(P45)"></a>MySQL 不同的自增 id 达到上限以后的行为(P45)</h2><p>1.表的自增 id 达到上限后，再申请时它的值就不会改变，进而导致继续插入数据时报主键冲突的错误。</p><p>2.row_id 达到上限后，则会归 0 再重新递增，如果出现相同的 row_id，后写的数据会覆盖之前的数据。</p><p>3.Xid 只需要不在同一个 binlog 文件中出现重复值即可。虽然理论上会出现重复值，但是概率极小，可以忽略不计。</p><p>4.InnoDB 的 max_trx_id 递增值每次 MySQL 重启都会被保存起来，所以我们文章中提到的脏读的例子就是一个必现的 bug，好在留给我们的时间还很充裕。</p><p>5.thread_id 是我们使用中最常见的，而且也是处理得最好的一个自增 id 逻辑了。</p><h2 id="问与答-2"><a href="#问与答-2" class="headerlink" title="问与答"></a>问与答</h2><h3 id="自增值为什么不能回退？"><a href="#自增值为什么不能回退？" class="headerlink" title="自增值为什么不能回退？"></a>自增值为什么不能回退？</h3><p>导致性能问题</p><h3 id="自增主键为什么不是连续的？"><a href="#自增主键为什么不是连续的？" class="headerlink" title="自增主键为什么不是连续的？"></a>自增主键为什么不是连续的？</h3><p>第一种原因: 惟一索引插入失败。</p><p>第二种原因：回滚也会产生类似的现象。</p><p>第三种原因：批量申请自增 id 的策略。</p><h1 id="客户端-P32"><a href="#客户端-P32" class="headerlink" title="客户端(P32)"></a>客户端(P32)</h1><p>两个关于客户端的误解</p><h2 id="第一个误解是：如果库里面的表特别多，连接就会很慢。"><a href="#第一个误解是：如果库里面的表特别多，连接就会很慢。" class="headerlink" title="第一个误解是：如果库里面的表特别多，连接就会很慢。"></a>第一个误解是：如果库里面的表特别多，连接就会很慢。</h2><p>MySQL 客户端会提供一个本地库名和表名补全的功能。为了实现这个功能，客户端在连接成功后，需要多做一些操作：</p><p>1.执行 show databases；</p><p>2.切到 db1 库，执行 show tables；</p><p>3.把这两个命令的结果用于构建一个本地的哈希表。</p><p>我们感知到的连接过程慢，其实并不是连接慢，也不是服务端慢，而是客户端慢。</p><h2 id="quick-是一个更容易引起误会的参数，也是关于客户端常见的一个误解。"><a href="#quick-是一个更容易引起误会的参数，也是关于客户端常见的一个误解。" class="headerlink" title="quick 是一个更容易引起误会的参数，也是关于客户端常见的一个误解。"></a>quick 是一个更容易引起误会的参数，也是关于客户端常见的一个误解。</h2><p>MySQL 客户端发送请求后，接收服务端返回结果的方式有两种：</p><p>一种是本地缓存，也就是在本地开一片内存，先把结果存起来。如果你用 API 开发，对应的就是 mysql_store_result 方法。</p><p>另一种是不缓存，读一个处理一个。如果你用 API 开发，对应的就是 mysql_use_result 方法。</p><p>第一点，就是前面提到的，跳过表名自动补全功能。</p><p>第二点，mysql_store_result 需要申请本地内存来缓存查询结果，如果查询结果太大，会耗费较多的本地内存，可能会影响客户端本地机器的性能；</p><p>第三点，是不会把执行命令记录到本地的命令历史文件。</p><p>–quick 参数的意思，是让客户端变得更快。</p><h1 id="查询从客户端到服务器的过程-P33"><a href="#查询从客户端到服务器的过程-P33" class="headerlink" title="查询从客户端到服务器的过程(P33)"></a>查询从客户端到服务器的过程(P33)</h1><p><img src="/.com//%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C%E5%8F%91%E9%80%81%E6%B5%81%E7%A8%8B.webp" alt="查询结果发送流程"></p><p>取数据和发数据的流程是这样的：</p><p>1.获取一行，写到 net_buffer 中。这块内存的大小是由参数 net_buffer_length 定义的，默认是 16k。</p><p>2.重复获取行，直到 net_buffer 写满，调用网络接口发出去。</p><p>3.如果发送成功，就清空 net_buffer，然后继续取下一行，并写入 net_buffer。</p><p>4.如果发送函数返回 EAGAIN 或 WSAEWOULDBLOCK，就表示本地网络栈（socket send buffer）写满了，进入等待。直到网络栈重新可写，再继续发送。</p><p>MySQL 是“边读边发的”，这就意味着，如果客户端接收得慢，会导致 MySQL 服务端由于结果发不出去，这个事务的执行时间变长。</p><p>Sending to client就表示服务器端的网络栈写满了</p><p>对于正常的线上业务来说，如果一个查询的返回结果不会很多的话，我都建议你使用 mysql_store_result 这个接口，直接把查询结果保存到本地内存。</p><p>Sending data表示正在执行</p><p>一个查询语句的状态变化是这样的（注意：这里，我略去了其他无关的状态）：</p><p>1.MySQL 查询语句进入执行阶段后，首先把状态设置成“Sending data”；</p><p>2.然后，发送执行结果的列相关的信息（meta data) 给客户端；</p><p>3.再继续执行语句的流程；</p><p>4.执行完成后，把状态设置成空字符串。</p><h1 id="临时表（P36、P37）"><a href="#临时表（P36、P37）" class="headerlink" title="临时表（P36、P37）"></a>临时表（P36、P37）</h1><h2 id="用户临时表："><a href="#用户临时表：" class="headerlink" title="用户临时表："></a>用户临时表：</h2><p>内存表和临时表的区别：</p><p>内存表，指的是使用 Memory 引擎的表，建表语法是 create table … engine&#x3D;memory。这种表的数据都保存在内存里，系统重启的时候会被清空，但是表结构还在。除了这两个特性看上去比较“奇怪”外，从其他的特征上看，它就是一个正常的表。</p><p>而临时表，可以使用各种引擎类型 。如果是使用 InnoDB 引擎或者 MyISAM 引擎的临时表，写数据的时候是写到磁盘上的。当然，临时表也可以使用 Memory 引擎。</p><h3 id="临时表的特性："><a href="#临时表的特性：" class="headerlink" title="临时表的特性："></a>临时表的特性：</h3><p>建表语法是 create temporary table …。</p><p>一个临时表只能被创建它的 session 访问，对其他线程不可见。</p><p>临时表可以与普通表同名。session A 内有同名的临时表和普通表的时候，show create 语句，以及增删改查语句访问的是临时表。show tables 命令不显示临时表。</p><p>临时表就特别适合 join 优化这种场景:</p><p>不同 session 的临时表是可以重名的，如果有多个 session 同时执行 join 优化，不需要担心表名重复导致建表失败的问题。</p><p>不需要担心数据删除问题。如果使用普通表，在流程执行过程中客户端发生了异常断开，或者数据库发生异常重启，还需要专门来清理中间过程中生成的数据表。而临时表由于会自动回收，所以不需要这个额外的操作。</p><h3 id="临时表的应用："><a href="#临时表的应用：" class="headerlink" title="临时表的应用："></a>临时表的应用：</h3><p>分库分表时，select * from t where k&lt;&#x3D;n limit 100时，可以把所有库的limit 100条数据放到一个库上创建临时表，对临时表进行查询。</p><p>为什么临时表可以重名？</p><p>临时表frm 文件（保存表结构）存储位置：这个 frm 文件放在临时文件目录下，文件名的后缀是.frm，前缀是“#sql{进程 id}<em>{线程 id}</em> 序列号”</p><h3 id="数据的存放方式："><a href="#数据的存放方式：" class="headerlink" title="数据的存放方式："></a>数据的存放方式：</h3><p>在 5.6 以及之前的版本里，MySQL 会在临时文件目录下创建一个相同前缀、以.ibd 为后缀的文件，用来存放数据文件；</p><p>而从 5.7 版本开始，MySQL 引入了一个临时文件表空间，专门用来存放临时文件的数据。因此，我们就不需要再创建 ibd 文件了。</p><p>主从同步在非binlog_format&#x3D;’row的时候也会同步过去。在 binlog_format&#x3D;’row’的时候，临时表的操作不记录到 binlog 中，也省去了不少麻烦，这也可以成为你选择 binlog_format 时的一个考虑因素。需要注意的是，我们上面说到的这种临时表，</p><h2 id="内部临时表："><a href="#内部临时表：" class="headerlink" title="内部临时表："></a>内部临时表：</h2><p>分为内存临时表和磁盘临时表。</p><h3 id="MySQL-什么时候会使用内部临时表？"><a href="#MySQL-什么时候会使用内部临时表？" class="headerlink" title="MySQL 什么时候会使用内部临时表？"></a>MySQL 什么时候会使用内部临时表？</h3><p>1.如果语句执行过程可以一边读数据，一边直接得到结果，是不需要额外内存的，否则就需要额外的内存，来保存中间结果；</p><p>2.join_buffer 是无序数组，sort_buffer 是有序数组，临时表是二维表结构；</p><p>3.如果执行逻辑需要用到二维表特性，就会优先考虑使用临时表。比如我们的例子中，union 需要用到唯一索引约束， group by 还需要用到另外一个字段来存累积计数。</p><h1 id="Memory引擎-内存表-（P38）"><a href="#Memory引擎-内存表-（P38）" class="headerlink" title="Memory引擎(内存表)（P38）"></a>Memory引擎(内存表)（P38）</h1><p>InnoDB 和 Memory 引擎的数据组织方式是不同的：</p><p>InnoDB 引擎把数据放在主键索引上，其他索引上保存的是主键 id。这种方式，我们称之为索引组织表（Index Organizied Table）。</p><p>而 Memory 引擎采用的是把数据单独存放，索引上保存数据位置的数据组织形式，我们称之为堆组织表（Heap Organizied Table）。</p><p>InnoDB 和 Memory 引擎的一些典型不同：</p><p>1.InnoDB 表的数据总是有序存放的，而内存表的数据就是按照写入顺序存放的；</p><p>2.当数据文件有空洞的时候，InnoDB 表在插入新数据的时候，为了保证数据有序性，只能在固定的位置写入新值，而内存表找到空位就可以插入新值；</p><p>3.数据位置发生变化的时候，InnoDB 表只需要修改主键索引，而内存表需要修改所有索引；</p><p>4.InnoDB 表用主键索引查询时需要走一次索引查找，用普通索引查询的时候，需要走两次索引查找。而内存表没有这个区别，所有索引的“地位”都是相同的。</p><p>5.InnoDB 支持变长数据类型，不同记录的长度可能不同；内存表不支持 Blob 和 Text 字段，并且即使定义了 varchar(N)，实际也当作 char(N)，也就是固定长度字符串来存储，因此内存表的每行数据长度相同。</p><p>内存表支hash索引和b+树索引</p><h2 id="为什么不建议在生产环境上使用内存表："><a href="#为什么不建议在生产环境上使用内存表：" class="headerlink" title="为什么不建议在生产环境上使用内存表："></a>为什么不建议在生产环境上使用内存表：</h2><p>1.锁粒度问题；</p><p>没有行锁，只有表锁</p><p>2.数据持久化问题。</p><p>在分布式布署情况下，会因为内存表出主从同步问题;会因为内存表出现业务上数据不见，表不见了等问题</p><h2 id="有一个场景却是例外的：（使用内存临时表时，用于优化）"><a href="#有一个场景却是例外的：（使用内存临时表时，用于优化）" class="headerlink" title="有一个场景却是例外的：（使用内存临时表时，用于优化）"></a>有一个场景却是例外的：（使用内存临时表时，用于优化）</h2><p>1.临时表不会被其他线程访问，没有并发性的问题；</p><p>2.临时表重启后也是需要删除的，清空数据这个问题不存在；</p><p>3.备库的临时表也不会影响主库的用户线程。</p><h1 id="分区表（P43）"><a href="#分区表（P43）" class="headerlink" title="分区表（P43）"></a>分区表（P43）</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t` (<br>  `ftime` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `c` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  KEY (`ftime`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>latin1<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> (<span class="hljs-keyword">YEAR</span>(ftime))<br>(<span class="hljs-keyword">PARTITION</span> p_2017 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">2017</span>) ENGINE <span class="hljs-operator">=</span> InnoDB,<br> <span class="hljs-keyword">PARTITION</span> p_2018 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">2018</span>) ENGINE <span class="hljs-operator">=</span> InnoDB,<br> <span class="hljs-keyword">PARTITION</span> p_2019 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">2019</span>) ENGINE <span class="hljs-operator">=</span> InnoDB,<br><span class="hljs-keyword">PARTITION</span> p_others <span class="hljs-keyword">VALUES</span> LESS THAN MAXVALUE ENGINE <span class="hljs-operator">=</span> InnoDB);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;2017-4-1&#x27;</span>,<span class="hljs-number">1</span>),(<span class="hljs-string">&#x27;2018-4-1&#x27;</span>,<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p>这个表包含了一个.frm 文件和 4 个.ibd 文件，每个分区对应一个.ibd 文件。也就是说：对于引擎层来说，这是 4 个表；对于 Server 层来说，这是 1 个表。</p><h2 id="分区表的引擎层行为："><a href="#分区表的引擎层行为：" class="headerlink" title="分区表的引擎层行为："></a>分区表的引擎层行为：</h2><p><img src="/.com//%E5%88%86%E5%8C%BA%E8%A1%A8%E9%97%B4%E9%9A%99%E9%94%81%E7%A4%BA%E4%BE%8B.webp" alt="分区表间隙锁示例"></p><p>session A 的 select 语句其实只操作了分区 p_2018，所以，session B 要写入一行 ftime 是 2018-2-1 的时候是可以成功的，而要写入 2017-12-1 这个记录，就要等 session A 的间隙锁。</p><h2 id="分区策略"><a href="#分区策略" class="headerlink" title="分区策略"></a>分区策略</h2><p>每当第一次访问一个分区表的时候，MySQL 需要把所有的分区都访问一遍。一个典型的报错情况是这样的：如果一个分区表的分区很多，比如超过了 1000 个，而 MySQL 启动的时候，open_files_limit 参数使用的是默认值 1024，那么就会在访问这个表的时候，由于需要打开所有的文件，导致打开表文件的个数超过了上限而报错。</p><p>MyISAM 分区表使用的分区策略，我们称为通用分区策略（generic partitioning），每次访问分区都由 server 层控制。通用分区策略，是 MySQL 一开始支持分区表的时候就存在的代码，在文件管理、表管理的实现上很粗糙，因此有比较严重的性能问题。</p><p>从 MySQL 5.7.9 开始，InnoDB 引擎引入了本地分区策略（native partitioning）。这个策略是在 InnoDB 内部自己管理打开分区的行为。</p><p>MySQL 从 5.7.17 开始，将 MyISAM 分区表标记为即将弃用 (deprecated)，意思是“从这个版本开始不建议这么使用，请使用替代方案。在将来的版本中会废弃这个功能”。</p><p>从 MySQL 8.0 版本开始，就不允许创建 MyISAM 分区表了，只允许创建已经实现了本地分区策略的引擎。目前来看，只有 InnoDB 和 NDB 这两个引擎支持了本地分区策略。</p><h2 id="分区表的-server-层行为"><a href="#分区表的-server-层行为" class="headerlink" title="分区表的 server 层行为"></a>分区表的 server 层行为</h2><p>如果从 server 层看的话，一个分区表就只是一个表。</p><p>可以看到，虽然 session B 只需要操作 p_2017 这个分区，但是由于 session A 持有整个表 t 的 MDL 锁，就导致了 session B 的 alter 语句被堵住。</p><p>MySQL 在第一次打开分区表的时候，需要访问所有的分区；</p><p>在 server 层，认为这是同一张表，因此所有分区共用同一个 MDL 锁；</p><p>在引擎层，认为这是不同的表，因此 MDL 锁之后的执行过程，会根据分区表规则，只访问必要的分区。</p><h2 id="分区表的应用场景"><a href="#分区表的应用场景" class="headerlink" title="分区表的应用场景"></a>分区表的应用场景</h2><p>分区表的一个显而易见的优势是对业务透明，相对于用户分表来说，使用分区表的业务代码更简洁。还有，分区表可以很方便的清理历史数据。如果一项业务跑的时间足够长，往往就会有根据时间删除历史数据的需求。这时候，按照时间分区的分区表，就可以直接通过 alter table t drop partition … 这个语法删掉分区，从而删掉过期的历史数据。这个 alter table t drop partition … 操作是直接删除分区文件，效果跟 drop 普通表类似。与使用 delete 语句删除数据相比，优势是速度快、对系统影响小。</p><h1 id="权限（P42）"><a href="#权限（P42）" class="headerlink" title="权限（P42）"></a>权限（P42）</h1><p>MySQL 用户权限在数据表和内存中的存在形式;grant 和 revoke 命令的执行逻辑。flush privileges 语句.</p><p>create user ‘ua‘@’%’ identified by ‘pa’;</p><p>这条命令做了两个动作：</p><p>1.磁盘上，往 mysql.user 表里插入一行，由于没有指定权限，所以这行数据上所有表示权限的字段的值都是 N；</p><p>2.内存里，往数组 acl_users 里插入一个 acl_user 对象，这个对象的 access 字段值为 0。</p><p>revoke all privileges on <em>.</em> from ‘ua‘@’%’;</p><p>这条 revoke 命令的用法与 grant 类似，做了如下两个动作：</p><p>1.磁盘上，将 mysql.user 表里，用户’ua’@’%’这一行的所有表示权限的字段的值都修改为“N”；</p><p>2.内存里，从数组 acl_users 中找到这个用户对应的对象，将 access 的值修改为 0。</p><h2 id="全局权限"><a href="#全局权限" class="headerlink" title="全局权限"></a>全局权限</h2><p>全局权限，作用于整个 MySQL 实例，这些权限信息保存在 mysql 库的 user 表里。</p><p>grant all privileges on <em>.</em> to ‘ua‘@’%’ with grant option;</p><p>这个 grant 命令做了两个动作：</p><p>1.磁盘上，将 mysql.user 表里，用户’ua’@’%’这一行的所有表示权限的字段的值都修改为‘Y’；</p><p>2.内存里，从数组 acl_users 中找到这个用户对应的对象，将 access 值（权限位）修改为二进制的“全 1”。</p><p>在这个 grant 命令执行完成后，如果有新的客户端使用用户名 ua 登录成功，MySQL 会为新连接维护一个线程对象，然后从 acl_users 数组里查到这个用户的权限，并将权限值拷贝到这个线程对象中。之后在这个连接中执行的语句，所有关于全局权限的判断，都直接使用线程对象内部保存的权限位。</p><p>基于上面的分析我们可以知道：</p><p>1.grant 命令对于全局权限，同时更新了磁盘和内存。命令完成后即时生效，接下来新创建的连接会使用新的权限。</p><p>2.对于一个已经存在的连接，它的全局权限不受 grant 命令的影响。</p><h2 id="db-权限"><a href="#db-权限" class="headerlink" title="db 权限"></a>db 权限</h2><p>MySQL 也支持库级别的权限定义。如果要让用户 ua 拥有库 db1 的所有权限，可以执行下面这条命令：</p><p>grant all privileges on db1.* to ‘ua‘@’%’ with grant option;</p><p>基于库的权限记录保存在 mysql.db 表中，在内存里则保存在数组 acl_dbs 中。这条 grant 命令做了如下两个动作：</p><p>1.磁盘上，往 mysql.db 表中插入了一行记录，所有权限位字段设置为“Y”；</p><p>2.内存里，增加一个对象到数组 acl_dbs 中，这个对象的权限位为“全 1”。</p><p>db grant 操作对于已经存在的连接的影响,对use 库名的没有效果，对库名.表名的有效果。</p><h2 id="表权限和列权限"><a href="#表权限和列权限" class="headerlink" title="表权限和列权限"></a>表权限和列权限</h2><p>MySQL 支持更细粒度的表权限和列权限。其中，表权限定义存放在表 mysql.tables_priv 中，列权限定义存放在表 mysql.columns_priv 中。这两类权限，组合起来存放在内存的 hash 结构 column_priv_hash 中。</p><p>create table db1.t1(id int, a int);<br>grant all privileges on db1.t1 to ‘ua‘@’%’ with grant option;<br>GRANT SELECT(id), INSERT (id,a) ON mydb.mytbl TO ‘ua‘@’%’ with grant option;</p><p>跟 db 权限类似，这两个权限每次 grant 的时候都会修改数据表，也会同步修改内存中的 hash 结构。因此，对这两类权限的操作，也会马上影响到已经存在的连接。</p><p>因此，正常情况下，grant 命令之后，没有必要跟着执行 flush privileges 命令。</p><h2 id="flush-privileges-命令。"><a href="#flush-privileges-命令。" class="headerlink" title="flush privileges 命令。"></a>flush privileges 命令。</h2><p>flush privileges 命令会清空 acl_users 数组，然后从 mysql.user 表中读取数据重新加载，重新构造一个 acl_users 数组。也就是说，以数据表中的数据为准，会将全局权限内存数组重新加载一遍。同样地，对于 db 权限、表权限和列权限，MySQL 也做了这样的处理。</p><p>flush privileges 是在什么时候使用呢？显然，当数据表中的权限数据跟内存中的权限数据不一致的时候，flush privileges 语句可以用来重建内存数据，达到一致状态。</p><p>这种不一致往往是由不规范的操作导致的，比如直接用 DML 语句操作系统权限表。</p><h1 id="高可用（P07、P24、P25、P26、P27、P28、P29）"><a href="#高可用（P07、P24、P25、P26、P27、P28、P29）" class="headerlink" title="高可用（P07、P24、P25、P26、P27、P28、P29）"></a>高可用（P07、P24、P25、P26、P27、P28、P29）</h1><h2 id="当备库用–single-transaction-做逻辑备份的时候，如果从主库的-binlog-传来一个-DDL-语句会怎么样？"><a href="#当备库用–single-transaction-做逻辑备份的时候，如果从主库的-binlog-传来一个-DDL-语句会怎么样？" class="headerlink" title="当备库用–single-transaction 做逻辑备份的时候，如果从主库的 binlog 传来一个 DDL 语句会怎么样？"></a>当备库用–single-transaction 做逻辑备份的时候，如果从主库的 binlog 传来一个 DDL 语句会怎么样？</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"><br>Q1:<span class="hljs-keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;<br>Q2:<span class="hljs-keyword">START</span> TRANSACTION  <span class="hljs-keyword">WITH</span> CONSISTENT SNAPSHOT；<br><span class="hljs-comment">/* other tables */</span><br>Q3:<span class="hljs-keyword">SAVEPOINT</span> sp;<br><span class="hljs-comment">/* 时刻 1 */</span><br>Q4:<span class="hljs-keyword">show</span> <span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> `t1`;<br><span class="hljs-comment">/* 时刻 2 */</span><br>Q5:<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> `t1`;<br><span class="hljs-comment">/* 时刻 3 */</span><br>Q6:<span class="hljs-keyword">ROLLBACK</span> <span class="hljs-keyword">TO</span> <span class="hljs-keyword">SAVEPOINT</span> sp;<br><span class="hljs-comment">/* 时刻 4 */</span><br><span class="hljs-comment">/* other tables */</span><br></code></pre></td></tr></table></figure><p>在备份开始的时候，为了确保 RR（可重复读）隔离级别，再设置一次 RR 隔离级别 (Q1);</p><p>启动事务，这里用 WITH CONSISTENT SNAPSHOT 确保这个语句执行完就可以得到一个一致性视图（Q2)；</p><p>设置一个保存点，这个很重要（Q3）；</p><p>show create 是为了拿到表结构 (Q4)，然后正式导数据 （Q5），回滚到 SAVEPOINT sp，在这里的作用是释放 t1 的 MDL 锁 （Q6）。</p><p>DDL 从主库传过来的时间按照效果不同，我打了四个时刻。题目设定为小表，我们假定到达后，如果开始执行，则很快能够执行完成。</p><p>1.如果在 Q4 语句执行之前到达，现象：没有影响，备份拿到的是 DDL 后的表结构。</p><p>2.如果在“时刻 2”到达，则表结构被改过，Q5 执行的时候，报 Table definition has changed, please retry transaction，现象：mysqldump 终止；</p><p>3.如果在“时刻 2”和“时刻 3”之间到达，mysqldump 占着 t1 的 MDL 读锁，binlog 被阻塞，现象：主从延迟，直到 Q6 执行完成。</p><p>4.从“时刻 4”开始，mysqldump 释放了 MDL 读锁，现象：没有影响，备份拿到的是 DDL 前的表结构。</p><h2 id="主备"><a href="#主备" class="headerlink" title="主备"></a>主备</h2><p>主备：节点A主库、节点B备库</p><p>我依然建议你把节点 B（也就是备库）设置成只读（readonly）模式。这样做，有以下几个考虑：</p><p>1.有时候一些运营类的查询语句会被放到备库上去查，设置为只读可以防止误操作；</p><p>2.防止切换逻辑有 bug，比如切换过程中出现双写，造成主备不一致；</p><p>3.可以用 readonly 状态，来判断节点的角色。</p><p>因为 readonly 设置对超级 (super) 权限用户是无效的，而用于同步更新的线程，就拥有超级权限。</p><h2 id="主从同步过程"><a href="#主从同步过程" class="headerlink" title="主从同步过程"></a>主从同步过程</h2><p>在备库 B 上通过 change master 命令，设置主库 A 的 IP、端口、用户名、密码，以及要从哪个位置开始请求 binlog，这个位置包含文件名和日志偏移量。</p><p>在备库 B 上执行 start slave 命令，这时候备库会启动两个线程，就是图中的 io_thread 和 sql_thread。其中 io_thread 负责与主库建立连接。</p><p>主库 A 校验完用户名、密码后，开始按照备库 B 传过来的位置，从本地读取 binlog，发给 B。</p><p>备库 B 拿到 binlog 后，写到本地文件，称为中转日志（relay log）。sql_thread 读取中转日志，解析出日志里的命令，并执行。</p><p>![ 主备流程图](mysqlimg&#x2F; 主备流程图.webp)</p><h2 id="主备延迟"><a href="#主备延迟" class="headerlink" title="主备延迟"></a>主备延迟</h2><p>主备切换可能是一个主动运维动作，比如软件升级、主库所在机器按计划下线等，也可能是被动操作，比如主库所在机器掉电。</p><p>1.主库 A 执行完成一个事务，写入 binlog，我们把这个时刻记为 T1;</p><p>2.之后传给备库 B，我们把备库 B 接收完这个 binlog 的时刻记为 T2;</p><p>3.备库 B 执行完成这个事务，我们把这个时刻记为 T3</p><p>你可以在备库上执行 show slave status 命令，它的返回结果里面会显示 seconds_behind_master，用于表示当前备库延迟了多少秒。</p><h3 id="主备延迟的来源"><a href="#主备延迟的来源" class="headerlink" title="主备延迟的来源"></a>主备延迟的来源</h3><p>有些部署条件下，备库所在机器的性能要比主库所在的机器性能差。</p><p>备库的压力大（由于主库直接影响业务，大家使用起来会比较克制，反而忽视了备库的压力控制。结果就是，备库上的查询耗费了大量的 CPU 资源，影响了同步速度，造成主备延迟。）</p><p>  备库压力大解决方案：</p><p>   1.一主多从。除了备库外，可以多接几个从库，让这些从库来分担读的压力。</p><p>   2.通过 binlog 输出到外部系统，比如 Hadoop 这类系统，让外部系统提供统计类查询的能力。</p><p>大事务（例如delete多行或者大表的数据结构修改）</p><p>由于主备延迟的存在，所以在主备切换的时候，就相应的有不同的策略。</p><p>可靠性优先策略：</p><p>1.判断备库 B 现在的 seconds_behind_master，如果小于某个值（比如 5 秒）继续下一步，否则持续重试这一步；</p><p>2.把主库 A 改成只读状态，即把 readonly 设置为 true；</p><p>3.判断备库 B 的 seconds_behind_master 的值，直到这个值变成 0 为止；</p><p>4.把备库 B 改成可读写状态，也就是把 readonly 设置为 false；</p><p>5.把业务请求切到备库 B。</p><p>会有一段时间不可用。</p><p>可用性优先策略：</p><p>1.把备库 B 改成可读写状态，也就是把 readonly 设置为 false；</p><p>2.把业务请求切到备库 B。</p><p>3.判断备库 B 现在的 seconds_behind_master，如果小于某个值（比如 5 秒）继续下一步，否则持续重试这一步；</p><p>4.把主库 A 改成只读状态，即把 readonly 设置为 true；</p><p>5.判断备库 B 的 seconds_behind_master 的值，直到这个值变成 0 为止；</p><p>会有数据不一致情况需要处理</p><p>主备切换的可用性优先策略会导致数据不一致。因此，大多数情况下，我都建议你使用可靠性优先策略。毕竟对数据服务来说的话，数据的可靠性一般还是要优于可用性的。</p><p>在满足数据可靠性的前提下，MySQL 高可用系统的可用性，是依赖于主备延迟的。延迟的时间越小，在主库故障的时候，服务恢复需要的时间就越短，可用性就越高。</p><h3 id="过期读（在从库上会读到系统的一个过期状态）"><a href="#过期读（在从库上会读到系统的一个过期状态）" class="headerlink" title="过期读（在从库上会读到系统的一个过期状态）"></a>过期读（在从库上会读到系统的一个过期状态）</h3><p>强制走主库方案；</p><p>   将查询请求做分类，必须拿到最新数据的走主库，可以读到旧数据的走从库</p><p>sleep 方案；</p><p>  select sleep(1) </p><p>   如果这个查询请求本来 0.5 秒就可以在从库上拿到正确结果，也会等 1 秒；</p><p>   如果延迟超过 1 秒，还是会出现过期读。</p><p>判断主备无延迟方案；</p><p>   方案1：show slave status 结果里的 seconds_behind_master </p><p>   方案2：对比位点确保主备无延迟：Master_Log_File 和 Read_Master_Log_Pos，表示的是读到的主库的最新位点；              Relay_Master_Log_File 和 Exec_Master_Log_Pos，表示的是备库执行的最新位点。</p><p>   方案3：对比 GTID 集合确保主备无延迟：Auto_Position&#x3D;1 ，表示这对主备关系使用了 GTID 协议。Retrieved_Gtid_Set，是备库收到的所有日志的 GTID 集合；Executed_Gtid_Set，是备库所有已经执行完成的 GTID 集合。</p><p>配合 semi-sync 方案；（一主一备）</p><p>  事务提交的时候，主库把 binlog 发给从库；</p><p>   从库收到 binlog 以后，发回给主库一个 ack，表示收到了；</p><p>   主库收到这个 ack 以后，才能给客户端返回“事务完成”的确认。</p><p>  当一主多从时：</p><p>   如果查询是落在这个响应了 ack 的从库上，是能够确保读到最新数据；</p><p>   但如果是查询落到其他从库上，它们可能还没有收到最新的日志，就会产生过期读的问题。</p><p>等主库位点方案；</p><p>   select master_pos_wait(file, pos[, timeout]);</p><p>   trx1 事务更新完成后，马上执行 show master status 得到当前主库执行到的 File 和 Position；</p><p>   选定一个从库执行查询语句；</p><p>   在从库上执行 select master_pos_wait(File, Position, 1)；</p><p>   如果返回值是 &gt;&#x3D;0 的正整数，则在这个从库执行查询语句；</p><p>   否则，到主库执行查询语句。</p><p>等 GTID 方案。</p><p>  select wait_for_executed_gtid_set(gtid_set, 1);</p><p>   trx1 事务更新完成后，从返回包直接获取这个事务的 GTID，记为 gtid1；</p><p>   选定一个从库执行查询语句；</p><p>   在从库上执行 select wait_for_executed_gtid_set(gtid1, 1)；</p><p>   如果返回值是 0，则在这个从库执行查询语句；</p><p>   否则，到主库执行查询语句</p><h2 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h2><p>读写分离，以及怎么处理主备延迟导致的读写分离问题。</p><p>两种架构：</p><p>1.客户端直连方案，因为少了一层 proxy 转发，所以查询性能稍微好一点儿，并且整体架构简单，排查问题更方便。但是这种方案，由于要了解后端部署细节，所以在出现主备切换、库迁移等操作的时候，客户端都会感知到，并且需要调整数据库连接信息。你可能会觉得这样客户端也太麻烦了，信息大量冗余，架构很丑。其实也未必，一般采用这样的架构，一定会伴随一个负责管理后端的组件，比如 Zookeeper，尽量让业务端只专注于业务逻辑开发。</p><p>2.带 proxy 的架构，对客户端比较友好。客户端不需要关注后端细节，连接维护、后端信息维护等工作，都是由 proxy 完成的。但这样的话，对后端维护团队的要求会更高。而且，proxy 也需要有高可用架构。因此，带 proxy 架构的整体就相对比较复杂。</p><h2 id="双主库的情况下会有什么问题？"><a href="#双主库的情况下会有什么问题？" class="headerlink" title="双主库的情况下会有什么问题？"></a>双主库的情况下会有什么问题？</h2><p>会有循环复制问题。</p><p>业务逻辑在节点 A 上更新了一条语句，然后再把生成的 binlog 发给节点 B，节点 B 执行完这条更新语句后也会生成 binlog。（我建议你把参数 log_slave_updates 设置为 on，表示备库执行 relay log 后生成 binlog）。</p><p>1.规定两个库的 server id 必须不同，如果相同，则它们之间不能设定为主备关系；</p><p>2.一个备库接到 binlog 并在重放的过程中，生成与原 binlog 的 server id 相同的新的 binlog；</p><p>3.每个库在收到从自己的主库发过来的日志后，先判断 server id，如果跟自己的相同，表示这个日志是自己生成的，就直接丢弃这个日志。</p><h2 id="如何判断一个数据库是不是出问题了？"><a href="#如何判断一个数据库是不是出问题了？" class="headerlink" title="如何判断一个数据库是不是出问题了？"></a>如何判断一个数据库是不是出问题了？</h2><p>1.select 1判断</p><p>   innodb_thread_concurrency 参数的目的是，控制 InnoDB 的并发线程上限。</p><p>   select 1 是能执行成功的，但是查询表 t 的语句会被堵住</p><p>   建议把 innodb_thread_concurrency 设置为 64~128 之间的值。</p><p>   并发连接和并发查询，并不是同一个概念。你在 show processlist 的结果里，看到的几千个连接，指的就是并发连接。而“当前正在执行”的语句，才是我们所说的并发查询。</p><p>   在线程进入锁等待以后，并发线程的计数会减一</p><p>2.查表判断</p><p> select * from mysql.health_check;</p><p>   空间满了以后，这种方法又会变得不好使。</p><p>3.更新判断</p><p>update mysql.health_check set t_modified&#x3D;now();</p><p>为了让主备之间的更新不产生冲突，我们可以在 mysql.health_check 表上存入多行数据，并用 A、B 的 server_id 做主键。</p><p>因为，外部检测都需要定时轮询，所以系统可能已经出问题了，但是却需要等到下一个检测发起执行语句的时候，我们才有可能发现问题。而且，如果你的运气不够好的话，可能第一次轮询还不能发现，这就会导致切换慢的问题。</p><p>4.内部统计</p><p>其实，MySQL 5.6 版本以后提供的 performance_schema 库，就在 file_summary_by_event_name 表里统计了每次 IO 请求的时间。</p><p>update setup_instruments set ENABLED&#x3D;’YES’, Timed&#x3D;’YES’ where name like ‘%wait&#x2F;io&#x2F;file&#x2F;innodb&#x2F;innodb_log_file%’;</p><p>比如，你可以设定阈值，单次 IO 请求时间超过 200 毫秒属于异常，然后使用类似下面这条语句作为检测逻辑。</p><p>select event_name,MAX_TIMER_WAIT FROM performance_schema.file_summary_by_event_name where event_name in (‘wait&#x2F;io&#x2F;file&#x2F;innodb&#x2F;innodb_log_file’,’wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;binlog’) and MAX_TIMER_WAIT&gt;200*1000000000;</p><p>发现异常后，取到你需要的信息，再通过下面这条语句，把之前的统计信息清空。</p><p>truncate table performance_schema.file_summary_by_event_name;</p><h2 id="备库从主库获取的binlog并行策略"><a href="#备库从主库获取的binlog并行策略" class="headerlink" title="备库从主库获取的binlog并行策略"></a>备库从主库获取的binlog并行策略</h2><p>看26讲</p><h2 id="一主多从时，主库出问题，如何切换？"><a href="#一主多从时，主库出问题，如何切换？" class="headerlink" title="一主多从时，主库出问题，如何切换？"></a>一主多从时，主库出问题，如何切换？</h2><p>看27讲</p><h1 id="误删数据-P31"><a href="#误删数据-P31" class="headerlink" title="误删数据(P31)"></a>误删数据(P31)</h1><p>我们需要先对和 MySQL 相关的误删数据，做下分类：</p><p>1.使用 delete 语句误删数据行；</p><p>2.使用 drop table 或者 truncate table 语句误删数据表；</p><p>3.使用 drop database 语句误删数据库；</p><p>4.使用 rm 命令误删整个 MySQL 实例。</p><h2 id="误删行"><a href="#误删行" class="headerlink" title="误删行"></a>误删行</h2><p>可以用 Flashback 工具通过闪回把数据恢复回来。</p><p>我不建议你直接在主库上执行这些操作。</p><p>这是因为，一个在执行线上逻辑的主库，数据状态的变更往往是有关联的。可能由于发现数据问题的时间晚了一点儿，就导致已经在之前误操作的基础上，业务代码逻辑又继续修改了其他数据。所以，如果这时候单独恢复这几行数据，而又未经确认的话，就可能会出现对数据的二次破坏。</p><p>我们不止要说误删数据的事后处理办法，更重要是要做到事前预防：</p><p>1.把 sql_safe_updates 参数设置为 on。这样一来，如果我们忘记在 delete 或者 update 语句中写 where 条件，或者 where 条件里面没有包含索引字段的话，这条语句的执行就会报错。</p><p>2.代码上线前，必须经过 SQL 审计。</p><h2 id="误删库-x2F-表"><a href="#误删库-x2F-表" class="headerlink" title="误删库 &#x2F; 表"></a>误删库 &#x2F; 表</h2><p>这种情况下，要想恢复数据，就需要使用全量备份，加增量日志的方式了。这个方案要求线上有定期的全量备份，并且实时备份 binlog。</p><p>在这两个条件都具备的情况下，假如有人中午 12 点误删了一个库，恢复数据的流程如下：</p><p>1.取最近一次全量备份，假设这个库是一天一备，上次备份是当天 0 点；</p><p>2.用备份恢复出一个临时库；</p><p>3.从日志备份里面，取出凌晨 0 点之后的日志；</p><p>4.把这些日志，除了误删除数据的语句外，全部应用到临时库。</p><p>预防误删库 &#x2F; 表的方法：</p><p>第一条建议是，账号分离。这样做的目的是，避免写错命令。</p><p>比如：我们只给业务开发同学 DML 权限，而不给 truncate&#x2F;drop 权限。而如果业务开发人员有 DDL 需求的话，也可以通过开发管理系统得到支持。即使是 DBA 团队成员，日常也都规定只使用只读账号，必要的时候才使用有更新权限的账号。</p><p>第二条建议是，制定操作规范。这样做的目的，是避免写错要删除的表名。</p><p>比如：在删除数据表之前，必须先对表做改名操作。然后，观察一段时间，确保对业务无影响以后再删除这张表。改表名的时候，要求给表名加固定的后缀（比如加 _to_be_deleted)，然后删除表的动作必须通过管理系统执行。并且，管理系删除表的时候，只能删除固定后缀的表。</p><h2 id="rm-删除数据"><a href="#rm-删除数据" class="headerlink" title="rm 删除数据"></a>rm 删除数据</h2><p>其实，对于一个有高可用机制的 MySQL 集群来说，最不怕的就是 rm 删除数据了。只要不是恶意地把整个集群删除，而只是删掉了其中某一个节点的数据的话，HA 系统就会开始工作，选出一个新的主库，从而保证整个集群的正常工作。这时，你要做的就是在这个节点上把数据恢复回来，再接入整个集群。</p><h1 id="kill-P32"><a href="#kill-P32" class="headerlink" title="kill(P32)"></a>kill(P32)</h1><p>在 MySQL 中有两个 kill 命令：一个是 kill query + 线程 id，表示终止这个线程中正在执行的语句；一个是 kill connection + 线程 id，这里 connection 可缺省，表示断开这个线程的连接，当然如果这个线程有语句正在执行，也是要先停止正在执行的语句的。</p><p>不知道你在使用 MySQL 的时候，有没有遇到过这样的现象：使用了 kill 命令，却没能断开这个连接。再执行 show processlist 命令，看到这条语句的 Command 列显示的是 Killed。</p><h2 id="收到-kill-以后，线程做什么？"><a href="#收到-kill-以后，线程做什么？" class="headerlink" title="收到 kill 以后，线程做什么？"></a>收到 kill 以后，线程做什么？</h2><p>实现上，当用户执行 kill query thread_id_B 时，MySQL 里处理 kill 命令的线程做了两件事：</p><p>1.把 session B 的运行状态改成 THD::KILL_QUERY(将变量 killed 赋值为 THD::KILL_QUERY)；</p><p>2.给 session B 的执行线程发一个信号。</p><p>发一个信号的目的，就是让 session B 退出等待，来处理这个 THD::KILL_QUERY 状态。</p><p>1.一个语句执行过程中有多处“埋点”，在这些“埋点”的地方判断线程状态，如果发现线程状态是 THD::KILL_QUERY，才开始进入语句终止逻辑；</p><p>2.如果处于等待状态，必须是一个可以被唤醒的等待，否则根本不会执行到“埋点”处；</p><p>3.语句从开始进入终止逻辑，到终止逻辑完全完成，是有一个过程的。</p><h2 id="kill-无效的情况"><a href="#kill-无效的情况" class="headerlink" title="kill 无效的情况"></a>kill 无效的情况</h2><p>情况一：线程没有执行到判断线程状态的逻辑。跟这种情况相同的，还有由于 IO 压力过大，读写 IO 的函数一直无法返回，导致不能及时判断线程的状态。</p><p>情况二：终止逻辑耗时较长。</p><p>1.超大事务执行期间被 kill。这时候，回滚操作需要对事务执行期间生成的所有新数据版本做回收操作，耗时很长。</p><p>2.大查询回滚。如果查询过程中生成了比较大的临时文件，加上此时文件系统压力大，删除临时文件可能需要等待 IO 资源，导致耗时较长。</p><p>3.DDL 命令执行到最后阶段，如果被 kill，需要删除中间过程的临时文件，也可能受 IO 资源影响耗时较久。</p>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql优化</title>
    <link href="/2022/05/18/mysql/mysql%E4%BC%98%E5%8C%96/"/>
    <url>/2022/05/18/mysql/mysql%E4%BC%98%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="官网访问"><a href="#官网访问" class="headerlink" title="官网访问"></a>官网访问</h1><p>mysql 官网：<a href="https://www.mysql.com/">https://www.mysql.com/</a></p><p>DOCUMENTATION  -&gt; <a href="https://dev.mysql.com/doc/refman/en/">MySQL Reference Manual</a></p><p>优化：<a href="https://dev.mysql.com/doc/refman/8.0/en/optimization.html">Optimization</a></p><p>参数：  <a href="https://dev.mysql.com/doc/refman/5.7/en/server-administration.html">MySQL Server Administration</a> &#x2F; <a href="https://dev.mysql.com/doc/refman/5.7/en/mysqld-server.html">The MySQL Server</a></p><h1 id="什么是mysql优化"><a href="#什么是mysql优化" class="headerlink" title="什么是mysql优化"></a>什么是mysql优化</h1><p>mysql优化在软件开发的整个周期中。</p><p>1.mysql安装前的主机选购(CPU、内存、磁盘、带宽)，mysql安装时的参数配置</p><p>2.使用存储引擎、表、字段</p><p>3.监控、压测(CPU、内存、磁盘、带宽)（sql响应时间）</p><p>​mysql配置参数的优化</p><p>​sql优化</p><h1 id="mysql参数"><a href="#mysql参数" class="headerlink" title="mysql参数"></a>mysql参数</h1><p>show variables like ‘%xxx%’ </p><p>列一些参数，不全</p><p>general</p><table><thead><tr><th>参数名</th><th>说明</th></tr></thead><tbody><tr><td>datadir&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql</td><td>数据文件存放的目录</td></tr><tr><td>socket&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysql.sock</td><td>mysql.socket表示server和client在同一台服务器，并且使用localhost进行连接，就会使用socket进行连接</td></tr><tr><td>pid_file&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysql.pid</td><td>存储mysql的pid</td></tr><tr><td>port&#x3D;3306</td><td>mysql服务的端口号</td></tr><tr><td>default_storage_engine&#x3D;InnoDB</td><td>mysql默认存储引擎</td></tr><tr><td>skip-grant-tables</td><td>当忘记mysql的用户名密码的时候，可以在mysql配置文件中配置该参数，跳过权限表验证，不需要密码即可登录mysql</td></tr></tbody></table><p>character</p><table><thead><tr><th>参数名</th><th>说明</th></tr></thead><tbody><tr><td>character_set_client</td><td>客户端数据的字符集</td></tr><tr><td>character_set_connection</td><td>mysql处理客户端发来的信息时，会把这些数据转换成连接的字符集格式</td></tr><tr><td>character_set_results</td><td>mysql发送给客户端的结果集所用的字符集</td></tr><tr><td>character_set_database</td><td>数据库默认的字符集</td></tr><tr><td>character_set_server</td><td>mysql server的默认字符集</td></tr></tbody></table><p>connection</p><table><thead><tr><th>参数名</th><th>说明</th></tr></thead><tbody><tr><td>max_connections</td><td>mysql的最大连接数，如果数据库的并发连接请求比较大，应该调高该值</td></tr><tr><td>max_user_connections</td><td>限制每个用户的连接个数</td></tr><tr><td>back_log</td><td>mysql能够暂存的连接数量，当mysql的线程在一个很短时间内得到非常多的连接请求时，就会起作用，如果mysql的连接数量达到max_connections时，新的请求会被存储在堆栈中，以等待某一个连接释放资源，如果等待连接的数量超过back_log,则不再接受连接资源</td></tr><tr><td>wait_timeout</td><td>mysql在关闭一个非交互的连接之前需要等待的时长</td></tr><tr><td>interactive_timeout</td><td>关闭一个交互连接之前需要等待的秒数</td></tr></tbody></table><p>log</p><table><thead><tr><th>参数名</th><th>说明</th></tr></thead><tbody><tr><td>log_error</td><td>指定错误日志文件名称，用于记录当mysqld启动和停止时，以及服务器在运行中发生任何严重错误时的相关信息</td></tr><tr><td>log_bin</td><td>指定二进制日志文件名称，用于记录对数据造成更改的所有查询语句</td></tr><tr><td>binlog_do_db</td><td>指定将更新记录到二进制日志的数据库，其他所有没有显式指定的数据库更新将忽略，不记录在日志中</td></tr><tr><td>binlog_ignore_db</td><td>指定不将更新记录到二进制日志的数据库</td></tr><tr><td>sync_binlog</td><td>指定多少次写日志后同步磁盘</td></tr><tr><td>general_log</td><td>是否开启查询日志记录</td></tr><tr><td>general_log_file</td><td>指定查询日志文件名，用于记录所有的查询语句</td></tr><tr><td>slow_query_log</td><td>是否开启慢查询日志记录</td></tr><tr><td>slow_query_log_file</td><td>指定慢查询日志文件名称，用于记录耗时比较长的查询语句</td></tr><tr><td>long_query_time</td><td>设置慢查询的时间，超过这个时间的查询语句才会记录日志</td></tr><tr><td>log_slow_admin_statements</td><td>是否将管理语句写入慢查询日志</td></tr></tbody></table><p>cache</p><table><thead><tr><th>参数名</th><th>说明</th></tr></thead><tbody><tr><td>key_buffer_size</td><td>索引缓存区的大小（只对myisam表起作用）</td></tr><tr><td>query cache</td><td></td></tr><tr><td>query_cache_size</td><td>查询缓存的大小，未来版本被删除</td></tr><tr><td></td><td>show status like ‘%Qcache%’;查看缓存的相关属性</td></tr><tr><td></td><td>Qcache_free_blocks：缓存中相邻内存块的个数，如果值比较大，那么查询缓存中碎片比较多</td></tr><tr><td></td><td>Qcache_free_memory：查询缓存中剩余的内存大小</td></tr><tr><td></td><td>Qcache_hits：表示有多少此命中缓存</td></tr><tr><td></td><td>Qcache_inserts：表示多少次未命中而插入</td></tr><tr><td></td><td>Qcache_lowmen_prunes：多少条query因为内存不足而被移除cache</td></tr><tr><td></td><td>Qcache_queries_in_cache：当前cache中缓存的query数量</td></tr><tr><td></td><td>Qcache_total_blocks：当前cache中block的数量</td></tr><tr><td>query_cache_limit</td><td>超出此大小的查询将不被缓存</td></tr><tr><td>query_cache_min_res_unit</td><td>缓存块最小大小</td></tr><tr><td>query_cache_type</td><td>缓存类型，决定缓存什么样的查询 <br>0表示禁用<br>1表示将缓存所有结果，除非sql语句中使用sql_no_cache禁用查询缓存<br>2表示只缓存select语句中通过sql_cache指定需要缓存的查询</td></tr><tr><td>sort_buffer_size</td><td>每个需要排序的线程分派该大小的缓冲区</td></tr><tr><td>max_allowed_packet&#x3D;32M</td><td>限制server接受的数据包大小</td></tr><tr><td>join_buffer_size&#x3D;2M</td><td>表示关联缓存的大小</td></tr><tr><td>thread_cache_size</td><td>Threads_cached：代表当前此时此刻线程缓存中有多少空闲线程<br>Threads_connected：代表当前已建立连接的数量<br>Threads_created：代表最近一次服务启动，已创建现成的数量，如果该值比较大，那么服务器会一直再创建线程<br>Threads_running：代表当前激活的线程数</td></tr></tbody></table><p>INNODB</p><table><thead><tr><th>参数名</th><th>说明</th></tr></thead><tbody><tr><td>innodb_buffer_pool_size&#x3D;</td><td>该参数指定大小的内存来缓冲数据和索引，最大可以设置为物理内存的80%</td></tr><tr><td>innodb_flush_log_at_trx_commit</td><td>主要控制innodb将log buffer中的数据写入日志文件并flush磁盘的时间点，值分别为0，1，2</td></tr><tr><td>innodb_thread_concurrency</td><td>设置innodb线程的并发数，默认为0表示不受限制，如果要设置建议跟服务器的cpu核心数一致或者是cpu核心数的两倍</td></tr><tr><td>innodb_log_buffer_size</td><td>此参数确定日志文件所用的内存大小，以M为单位</td></tr><tr><td>innodb_log_file_size</td><td>此参数确定数据日志文件的大小，以M为单位</td></tr><tr><td>innodb_log_files_in_group</td><td>以循环方式将日志文件写到多个文件中</td></tr><tr><td>read_buffer_size</td><td>mysql读入缓冲区大小，对表进行顺序扫描的请求将分配到一个读入缓冲区</td></tr><tr><td>read_rnd_buffer_size</td><td>mysql随机读的缓冲区大小</td></tr><tr><td>innodb_file_per_table</td><td>此参数确定为每张表分配一个新的文件</td></tr></tbody></table><h1 id="存储引擎对比"><a href="#存储引擎对比" class="headerlink" title="存储引擎对比"></a>存储引擎对比</h1><p><img src="/.com//%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E5%AF%B9%E6%AF%94.png" alt="存储引擎对比"></p><p>聚簇索引：主键索引节点上有对应的一行数据。</p><p>非聚簇索引：主键索引节点上只有地址。</p><h1 id="字符集的选择"><a href="#字符集的选择" class="headerlink" title="字符集的选择"></a>字符集的选择</h1><p>字符集直接决定了数据在MySQL中的存储编码方式，由于同样的内容使用不同字符集表示所占用的空间大小会有较大的差异，所以通过使用合适的字符集，可以帮助我们尽可能减少数据量，进而减少IO操作次数。</p><p>1.纯拉丁字符能表示的内容，没必要选择 latin1 之外的其他字符编码，因为这会节省大量的存储空间。</p><p>2.如果我们可以确定不需要存放多种语言，就没必要非得使用UTF8或者其他UNICODE字符类型，这回造成大量的存储空间浪费。</p><p>3.MySQL的数据类型可以精确到字段，所以当我们需要大型数据库中存放多字节数据的时候，可以通过对不同表不同字段使用不同的数据类型来较大程度减小数据存储量，进而降低 IO 操作次数并提高缓存命中率。</p><h1 id="主键的选择"><a href="#主键的选择" class="headerlink" title="主键的选择"></a>主键的选择</h1><p>自增主键：</p><p>与业务无关的，无意义的数字序列。</p><p>业务主键：</p><p>事物属性中的自然唯一标识。</p><p>推荐使用自增主键：</p><p>​它们不与业务耦合，因此更容易维护</p><p>​一个大多数表，最好是全部表，通用的键策略能够减少需要编写的源码数量，减少系统的总体拥有成本。(ID生成器)</p><p>​性能：自增主键一般是顺序插入。</p><p>​存储：一般是数字，存储空间小。</p><h1 id="范式与反范式"><a href="#范式与反范式" class="headerlink" title="范式与反范式"></a>范式与反范式</h1><p>第一范式：每个列都不可以再拆分。</p><p>地址：河北省保定市     省：河北省  市：保定市</p><p>第二范式：在第一范式的基础上，非主键列完全依赖于主键，而不能是依赖于主键的一部分。</p><p>确保 表中 的 每列 和 主键 相关。</p><p>学生表：id、学号，姓，名，班级号，学生在班级号中的序号，性别，班主任名称，年龄，是否成年，身份证号。</p><p>这里班主任名称和id无关。</p><p>第三范式：在第二范式的基础上，非主键列只依赖于主键，不依赖于其他非主键。</p><p>学生表：id、学号，姓，名，班级号，学生在班级号中的序号，性别，班主任名称，年龄，是否成年，身份证号。</p><p>这里”是否成年”字段依赖”年龄”字段</p><h2 id="范式"><a href="#范式" class="headerlink" title="范式"></a>范式</h2><p>优点：</p><p>1.范式化的更新通常比反范式要快；</p><p>2.当数据较好的范式化后，很少或者没有重复的数据；</p><p>3.范式化的数据比较小，可以放在内存中，操作比较快；</p><p>缺点：</p><p>通常需要进行关联</p><h2 id="反范式"><a href="#反范式" class="headerlink" title="反范式"></a>反范式</h2><p>优点：</p><p>1.所有的数据都在同一张表中，可以避免关联；</p><p>2.可以设计有效的索引；</p><p>缺点：</p><p>表格内的冗余较多，删除数据时候会造成表有些有用的信息丢失</p><p>在企业中很好能做到严格意义上的范式或者反范式，一般需要混合使用：</p><p>1.在一个网站实例中，这个网站，允许用户发送消息，并且一些用户是付费用户。现在想查看付费用户最近的10条信息。  在user表和message表中都存储用户类型(account_type)而不用完全的反范式化。这避免了完全反范式化的插入和删除问题，因为即使没有消息的时候也绝不会丢失用户的信息。这样也不会把user_message表搞得太大，有利于高效地获取数据。</p><p>2.另一个从父表冗余一些数据到子表的理由是排序的需要。</p><p>3.缓存衍生值也是有用的。如果需要显示每个用户发了多少消息（类似论坛的），可以每次执行一个昂贵的自查询来计算并显示它；也可以在user表中建一个num_messages列，每当用户发新消息时更新这个值。</p><h1 id="适当拆分"><a href="#适当拆分" class="headerlink" title="适当拆分"></a>适当拆分</h1><p>当我们的表中存在类似于 TEXT 或者是很大的 VARCHAR类型的大字段的时候，如果我们大部分访问这张表的时候都不需要这个字段，我们就该义无反顾的将其拆分到另外的独立表中，以减少常用数据所占用的存储空间。这样做的一个明显好处就是每个数据块中可以存储的数据条数可以大大增加，既减少物理 IO 次数，也能大大提高内存中的缓存命中率。</p><p>大表也可以拆成小表。</p><h1 id="适当冗余"><a href="#适当冗余" class="headerlink" title="适当冗余"></a>适当冗余</h1><p>1.被频繁引用且只能通过 Join 2张(或者更多)大表的方式才能得到的独立小字段。</p><p>2.这样的场景由于每次Join仅仅只是为了取得某个小字段的值，Join到的记录又大，会造成大量不必要的 IO，完全可以通过空间换取时间的方式来优化。不过，冗余的同时需要确保数据的一致性不会遭到破坏，确保更新的同时冗余字段也被更新。</p><h1 id="字段类型的选择"><a href="#字段类型的选择" class="headerlink" title="字段类型的选择"></a>字段类型的选择</h1><h2 id="更小的通常更好"><a href="#更小的通常更好" class="headerlink" title="更小的通常更好"></a>更小的通常更好</h2><p>应该尽量使用可以正确存储数据的最小数据类型，更小的数据类型通常更快，因为它们占用更少的磁盘、内存和CPU缓存，并且处理时需要的CPU周期更少，但是要确保没有低估需要存储的值的范围，如果无法确认哪个数据类型，就选择你认为不会超过范围的最小类型。</p><p>测试：<br>设计两张表，设计不同的数据类型，查看表的容量</p><h2 id="简单就好"><a href="#简单就好" class="headerlink" title="简单就好"></a>简单就好</h2><p>简单数据类型的操作通常需要更少的CPU周期，例如，<br>1、整型比字符操作代价更低，因为字符集和校对规则是字符比较比整型比较更复杂，<br>2、使用mysql自建类型而不是字符串来存储日期和时间<br>3、用整型存储IP地址</p><p>​人们经常使用varchar(15)来存储ip地址，然而，它的本质是32位无符号整数不是字符串，可以使用INET_ATON()和INET_NTOA函数在这两种表示方法之间转换<br>​案例：<br>​select inet_aton(‘1.1.1.1’)<br>​select inet_ntoa(16843009)</p><p>测试：<br>创建两张相同的表，改变日期的数据类型，查看SQL语句执行的速度</p><h2 id="尽量避免null"><a href="#尽量避免null" class="headerlink" title="尽量避免null"></a>尽量避免null</h2><p>如果查询中包含可为NULL的列，对mysql来说很难优化，因为可为null的列使得索引、索引统计和值比较都更加复杂，坦白来说，通常情况下null的列改为not null带来的性能提升比较小，所有没有必要将所有的表的schema进行修改，但是应该尽量避免设计成可为null的列</p><h2 id="整数类型"><a href="#整数类型" class="headerlink" title="整数类型"></a>整数类型</h2><p>可以使用的几种整数类型：TINYINT，SMALLINT，MEDIUMINT，INT，BIGINT分别使用8，16，24，32，64位存储空间。<br>尽量使用满足需求的最小数据类型</p><h2 id="字符和字符串类型"><a href="#字符和字符串类型" class="headerlink" title="字符和字符串类型"></a>字符和字符串类型</h2><p>1、char长度固定，即每条数据占用等长字节空间；最大长度是255个字符，适合用在身份证号、手机号等定长字符串<br>2、varchar可变长度，可以设置最大长度；最大空间是65535个字节，适合用在长度可变的属性<br>3、text不设置长度，当不知道属性的最大长度时，适合用text<br>按照查询速度：char&gt;varchar&gt;text</p><h3 id="varchar"><a href="#varchar" class="headerlink" title="varchar"></a>varchar</h3><p>varchar根据实际内容长度保存数据。</p><p>1、使用最小的符合需求的长度。</p><p>2、varchar(n) n小于等于255使用额外一个字节保存长度，n&gt;255使用额外两个字节保存长度。</p><p>3、varchar(5)与varchar(255)保存同样的内容，硬盘存储空间相同，但内存空间占用不同，是指定的大小 。</p><p>4、varchar在mysql5.6之前变更长度，或者从255一下变更到255以上时时，都会导致锁表。</p><p>应用场景：</p><p>1、存储长度波动较大的数据，如：文章，有的会很短有的会很长</p><p>2、字符串很少更新的场景，每次更新后都会重算并使用额外存储空间保存长度</p><p>3、适合保存多字节字符，如：汉字，特殊字符等</p><h3 id="char"><a href="#char" class="headerlink" title="char"></a>char</h3><p>char固定长度的字符串</p><p>1、最大长度：255</p><p>2、会自动删除末尾的空格</p><p>3、检索效率、写效率 会比varchar高，以空间换时间</p><p>应用场景:</p><p>1、存储长度波动不大的数据，如：md5摘要</p><p>2、存储短字符串、经常更新的字符串</p><h3 id="BLOB和TEXT类型"><a href="#BLOB和TEXT类型" class="headerlink" title="BLOB和TEXT类型"></a>BLOB和TEXT类型</h3><p>MySQL 把每个 BLOB 和 TEXT 值当作一个独立的对象处理。<br>两者都是为了存储很大数据而设计的字符串类型，分别采用二进制和字符方式存储。</p><p>不推荐使用。使用时放到单独的表中。</p><h2 id="datetime和timestamp"><a href="#datetime和timestamp" class="headerlink" title="datetime和timestamp"></a>datetime和timestamp</h2><p>1、不要使用字符串类型来存储日期时间数据<br>2、日期时间类型通常比字符串占用的存储空间小<br>3、日期时间类型在进行查找过滤时可以利用日期来进行比对<br>4、日期时间类型还有着丰富的处理函数，可以方便的对时间类型进行日期计算<br>5、使用int存储日期时间不如使用timestamp类型</p><h3 id="datetime"><a href="#datetime" class="headerlink" title="datetime"></a>datetime</h3><p>占用8个字节</p><p>与时区无关，数据库底层时区配置，对datetime无效</p><p>可保存到毫秒</p><p>可保存时间范围大</p><p>不要使用字符串存储日期类型，占用空间大，损失日期类型函数的便捷性</p><h3 id="timestamp"><a href="#timestamp" class="headerlink" title="timestamp"></a>timestamp</h3><p>占用4个字节 如果使用毫秒占用7个字节</p><p>时间范围：1970-01-01到2038-01-19</p><p>精确到秒  可支持毫秒</p><p>采用整形存储</p><p>依赖数据库设置的时区</p><p>自动更新timestamp列的值</p><h3 id="date"><a href="#date" class="headerlink" title="date"></a>date</h3><p>占用的字节数比使用字符串、datetime、int存储要少，使用date类型只需要3个字节</p><p>使用date类型还可以利用日期时间函数进行日期之间的计算</p><p>date类型用于保存1000-01-01到9999-12-31之间的日期</p><p>datetime和timestamp选择：</p><p>时区可以用前端或后端处理</p><p>timestamp如果没有显示的指定时区，timestamp会调用操作系统底层函数__tz_convert()做交互。这个函数每次交互的时候，他会加锁，那么高并发情况下，会有性能抖动问题。</p><p>存储上7个字节与8个字节差别不大。</p><p>选择datetime。</p><h2 id="使用枚举代替字符串类型"><a href="#使用枚举代替字符串类型" class="headerlink" title="使用枚举代替字符串类型"></a>使用枚举代替字符串类型</h2><p>有时可以使用枚举类代替常用的字符串类型，mysql存储枚举类型会非常紧凑，会根据列表值的数据压缩到一个或两个字节中，mysql在内部会将每个值在列表中的位置保存为整数，并且在表的.frm文件中保存“数字-字符串”映射关系的查找表<br> create table enum_test(e enum(‘fish’,’apple’,’dog’) not null);<br> insert into enum_test(e) values(‘fish’),(‘dog’),(‘apple’);<br> select e+0 from enum_test;</p><h1 id="select性能查看"><a href="#select性能查看" class="headerlink" title="select性能查看"></a>select性能查看</h1><h2 id="show-profile"><a href="#show-profile" class="headerlink" title="show profile"></a>show profile</h2><p><a href="https://dev.mysql.com/doc/refman/8.0/en/sql-statements.html">SQL Statements</a></p><p><a href="https://dev.mysql.com/doc/refman/8.0/en/show.html">SHOW Statements</a></p><p><a href="https://dev.mysql.com/doc/refman/8.0/en/show-profile.html">SHOW PROFILE Statement</a></p><p>使用show profile查询剖析工具，可以指定具体的type</p><p>此工具默认是禁用的，可以通过服务器变量在会话级别动态的修改<br><strong>set profiling&#x3D;1;</strong><br>当设置完成之后，在服务器上执行的所有语句，都会测量其耗费的时间和其他一些查询执行状态变更相关的数据。<br><strong>select * from emp;</strong><br>在mysql的命令行模式下只能显示两位小数的时间，可以使用如下命令查看具体的执行时间<br><strong>show profiles;</strong><br>执行如下命令可以查看详细的每个步骤的时间：<br><strong>show profile for query 1;</strong></p><p>type：</p><table><thead><tr><th>type</th><th>语法</th></tr></thead><tbody><tr><td>all：显示所有性能信息</td><td>show profile all for query n</td></tr><tr><td>block io：显示块io操作的次数</td><td>show  profile block io for query n</td></tr><tr><td>context switches：显示上下文切换次数，被动和主动</td><td>show profile context switches for query n</td></tr><tr><td>cpu：显示用户cpu时间、系统cpu时间</td><td>show profile cpu for query n</td></tr><tr><td>IPC：显示发送和接受的消息数量</td><td>show profile ipc for query n</td></tr><tr><td>Memory：暂未实现</td><td></td></tr><tr><td>page faults：显示页错误数量</td><td>show profile page faults for query n</td></tr><tr><td>source：显示源码中的函数名称与位置</td><td>show profile source for query n</td></tr><tr><td>swaps：显示swap的次数</td><td>show profile swaps for query n</td></tr></tbody></table><p>分析信息也可从 <code>INFORMATION_SCHEMA</code> <a href="https://dev.mysql.com/doc/refman/8.0/en/information-schema-profiling-table.html"><code>PROFILING</code></a>表中获得。请参阅 <a href="https://dev.mysql.com/doc/refman/8.0/en/information-schema-profiling-table.html">第 26.3.24 节，“INFORMATION_SCHEMA PROFILING 表”</a>。例如，以下查询是等效的：</p><figure class="highlight sql"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SHOW</span> PROFILE <span class="hljs-keyword">FOR</span> QUERY <span class="hljs-number">2</span>;<br><br><span class="hljs-keyword">SELECT</span> STATE, FORMAT(DURATION, <span class="hljs-number">6</span>) <span class="hljs-keyword">AS</span> DURATION<br><span class="hljs-keyword">FROM</span> INFORMATION_SCHEMA.PROFILING<br><span class="hljs-keyword">WHERE</span> QUERY_ID <span class="hljs-operator">=</span> <span class="hljs-number">2</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> SEQ;<br></code></pre></td></tr></table></figure><h2 id="performance-schema"><a href="#performance-schema" class="headerlink" title="performance schema"></a>performance schema</h2><h3 id="performance-schema的介绍"><a href="#performance-schema的介绍" class="headerlink" title="performance_schema的介绍"></a>performance_schema的介绍</h3><p>​<strong>MySQL的performance schema 用于监控MySQL server在一个较低级别的运行过程中的资源消耗、资源等待等情况</strong>。</p><p>​特点如下：</p><p>​1、提供了一种在数据库运行时实时检查server的内部执行情况的方法。performance_schema 数据库中的表使用performance_schema存储引擎。该数据库主要关注数据库运行过程中的性能相关的数据，与information_schema不同，information_schema主要关注server运行过程中的元数据信息</p><p>​2、performance_schema通过监视server的事件来实现监视server内部运行情况， “事件”就是server内部活动中所做的任何事情以及对应的时间消耗，利用这些信息来判断server中的相关资源消耗在了哪里？一般来说，事件可以是函数调用、操作系统的等待、SQL语句执行的阶段（如sql语句执行过程中的parsing 或 sorting阶段）或者整个SQL语句与SQL语句集合。事件的采集可以方便的提供server中的相关存储引擎对磁盘文件、表I&#x2F;O、表锁等资源的同步调用信息。<br>​3、performance_schema中的事件与写入二进制日志中的事件（描述数据修改的events）、事件计划调度程序（这是一种存储程序）的事件不同。performance_schema中的事件记录的是server执行某些活动对某些资源的消耗、耗时、这些活动执行的次数等情况。<br>​4、performance_schema中的事件只记录在本地server的performance_schema中，其下的这些表中数据发生变化时不会被写入binlog中，也不会通过复制机制被复制到其他server中。<br>​5、 当前活跃事件、历史事件和事件摘要相关的表中记录的信息。能提供某个事件的执行次数、使用时长。进而可用于分析某个特定线程、特定对象（如mutex或file）相关联的活动。<br>​6、PERFORMANCE_SCHEMA存储引擎使用server源代码中的“检测点”来实现事件数据的收集。对于performance_schema实现机制本身的代码没有相关的单独线程来检测，这与其他功能（如复制或事件计划程序）不同<br>​7、收集的事件数据存储在performance_schema数据库的表中。这些表可以使用SELECT语句查询，也可以使用SQL语句更新performance_schema数据库中的表记录（如动态修改performance_schema的setup_*开头的几个配置表，但要注意：配置表的更改会立即生效，这会影响数据收集）<br>​8、performance_schema的表中的数据不会持久化存储在磁盘中，而是保存在内存中，一旦服务器重启，这些数据会丢失（包括配置表在内的整个performance_schema下的所有数据）<br>​9、MySQL支持的所有平台中事件监控功能都可用，但不同平台中用于统计事件时间开销的计时器类型可能会有所差异。</p><h3 id="performance-schema入门"><a href="#performance-schema入门" class="headerlink" title="performance schema入门"></a>performance schema入门</h3><p>​在mysql的5.7版本中，性能模式是默认开启的，如果想要显式的关闭的话需要修改配置文件，不能直接进行修改，会报错Variable ‘performance_schema’ is a read only variable。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--查看performance_schema的属性</span><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SHOW</span> VARIABLES <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;performance_schema&#x27;</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------+-------+</span><br><span class="hljs-operator">|</span> Variable_name      <span class="hljs-operator">|</span> <span class="hljs-keyword">Value</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------+-------+</span><br><span class="hljs-operator">|</span> performance_schema <span class="hljs-operator">|</span> <span class="hljs-keyword">ON</span>    <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------+-------+</span><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.01</span> sec)<br><br><span class="hljs-comment">--在配置文件中修改performance_schema的属性值，on表示开启，off表示关闭</span><br>[mysqld]<br>performance_schema<span class="hljs-operator">=</span><span class="hljs-keyword">ON</span><br><br><span class="hljs-comment">--切换数据库</span><br>use performance_schema;<br><br><span class="hljs-comment">--查看当前数据库下的所有表,会看到有很多表存储着相关的信息</span><br><span class="hljs-keyword">show</span> tables;<br><br><span class="hljs-comment">--可以通过show create table tablename来查看创建表的时候的表结构</span><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> <span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> setup_consumers;<br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------+---------------------------------</span><br><span class="hljs-operator">|</span> <span class="hljs-keyword">Table</span>           <span class="hljs-operator">|</span> <span class="hljs-keyword">Create</span> <span class="hljs-keyword">Table</span>                    <br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------+---------------------------------</span><br><span class="hljs-operator">|</span> setup_consumers <span class="hljs-operator">|</span> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `setup_consumers` (<br>  `NAME` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,                      <br>  `ENABLED` enum(<span class="hljs-string">&#x27;YES&#x27;</span>,<span class="hljs-string">&#x27;NO&#x27;</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>               <br>) ENGINE<span class="hljs-operator">=</span>PERFORMANCE_SCHEMA <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8 <span class="hljs-operator">|</span>  <br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------+---------------------------------</span><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)               <br></code></pre></td></tr></table></figure><p>​想要搞明白后续的内容，同学们需要理解两个基本概念：</p><p>​instruments: 生产者，用于采集mysql中各种各样的操作产生的事件信息，对应配置表中的配置项我们可以称为监控采集配置项。</p><p>​consumers:消费者，对应的消费者表用于存储来自instruments采集的数据，对应配置表中的配置项我们可以称为消费存储配置项。</p><h3 id="performance-schema表的分类"><a href="#performance-schema表的分类" class="headerlink" title="performance_schema表的分类"></a>performance_schema表的分类</h3><p>​performance_schema库下的表可以按照监视不同的纬度就行分组。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--语句事件记录表，这些表记录了语句事件信息，当前语句事件表events_statements_current、历史语句事件表events_statements_history和长语句历史事件表events_statements_history_long、以及聚合后的摘要表summary，其中，summary表还可以根据帐号(account)，主机(host)，程序(program)，线程(thread)，用户(user)和全局(global)再进行细分)</span><br><span class="hljs-keyword">show</span> tables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%statement%&#x27;</span>;<br><br><span class="hljs-comment">--等待事件记录表，与语句事件类型的相关记录表类似：</span><br><span class="hljs-keyword">show</span> tables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%wait%&#x27;</span>;<br><br><span class="hljs-comment">--阶段事件记录表，记录语句执行的阶段事件的表</span><br><span class="hljs-keyword">show</span> tables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%stage%&#x27;</span>;<br><br><span class="hljs-comment">--事务事件记录表，记录事务相关的事件的表</span><br><span class="hljs-keyword">show</span> tables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%transaction%&#x27;</span>;<br><br><span class="hljs-comment">--监控文件系统层调用的表</span><br><span class="hljs-keyword">show</span> tables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%file%&#x27;</span>;<br><br><span class="hljs-comment">--监视内存使用的表</span><br><span class="hljs-keyword">show</span> tables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%memory%&#x27;</span>;<br><br><span class="hljs-comment">--动态对performance_schema进行配置的配置表</span><br><span class="hljs-keyword">show</span> tables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%setup%&#x27;</span>;<br></code></pre></td></tr></table></figure><h3 id="performance-schema的简单配置与使用"><a href="#performance-schema的简单配置与使用" class="headerlink" title="performance_schema的简单配置与使用"></a>performance_schema的简单配置与使用</h3><p>​数据库刚刚初始化并启动时，并非所有instruments(事件采集项，在采集项的配置表中每一项都有一个开关字段，或为YES，或为NO)和consumers(与采集项类似，也有一个对应的事件类型保存表配置项，为YES就表示对应的表保存性能数据，为NO就表示对应的表不保存性能数据)都启用了，所以默认不会收集所有的事件，可能你需要检测的事件并没有打开，需要进行设置，可以使用如下两个语句打开对应的instruments和consumers（行计数可能会因MySQL版本而异)。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--打开等待事件的采集器配置项开关，需要修改setup_instruments配置表中对应的采集器配置项</span><br><span class="hljs-keyword">UPDATE</span> setup_instruments <span class="hljs-keyword">SET</span> ENABLED <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;YES&#x27;</span>, TIMED <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;YES&#x27;</span><span class="hljs-keyword">where</span> name <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;wait%&#x27;</span>;<br><br><span class="hljs-comment">--打开等待事件的保存表配置开关，修改setup_consumers配置表中对应的配置项</span><br><span class="hljs-keyword">UPDATE</span> setup_consumers <span class="hljs-keyword">SET</span> ENABLED <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;YES&#x27;</span><span class="hljs-keyword">where</span> name <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%wait%&#x27;</span>;<br><br><span class="hljs-comment">--当配置完成之后可以查看当前server正在做什么，可以通过查询events_waits_current表来得知，该表中每个线程只包含一行数据，用于显示每个线程的最新监视事件</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> events_waits_current\G<br><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span> <span class="hljs-number">1.</span> <span class="hljs-type">row</span> <span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><br>            THREAD_ID: <span class="hljs-number">11</span><br>             EVENT_ID: <span class="hljs-number">570</span><br>         END_EVENT_ID: <span class="hljs-number">570</span><br>           EVENT_NAME: wait<span class="hljs-operator">/</span>synch<span class="hljs-operator">/</span>mutex<span class="hljs-operator">/</span>innodb<span class="hljs-operator">/</span>buf_dblwr_mutex<br>               SOURCE: <br>          TIMER_START: <span class="hljs-number">4508505105239280</span><br>            TIMER_END: <span class="hljs-number">4508505105270160</span><br>           TIMER_WAIT: <span class="hljs-number">30880</span><br>                SPINS: <span class="hljs-keyword">NULL</span><br>        OBJECT_SCHEMA: <span class="hljs-keyword">NULL</span><br>          OBJECT_NAME: <span class="hljs-keyword">NULL</span><br>           INDEX_NAME: <span class="hljs-keyword">NULL</span><br>          OBJECT_TYPE: <span class="hljs-keyword">NULL</span><br>OBJECT_INSTANCE_BEGIN: <span class="hljs-number">67918392</span><br>     NESTING_EVENT_ID: <span class="hljs-keyword">NULL</span><br>   NESTING_EVENT_TYPE: <span class="hljs-keyword">NULL</span><br>            OPERATION: lock<br>      NUMBER_OF_BYTES: <span class="hljs-keyword">NULL</span><br>                FLAGS: <span class="hljs-keyword">NULL</span><br><span class="hljs-comment">/*该信息表示线程id为11的线程正在等待buf_dblwr_mutex锁，等待事件为30880</span><br><span class="hljs-comment">属性说明：</span><br><span class="hljs-comment">id:事件来自哪个线程，事件编号是多少</span><br><span class="hljs-comment">event_name:表示检测到的具体的内容</span><br><span class="hljs-comment">source:表示这个检测代码在哪个源文件中以及行号</span><br><span class="hljs-comment">timer_start:表示该事件的开始时间</span><br><span class="hljs-comment">timer_end:表示该事件的结束时间</span><br><span class="hljs-comment">timer_wait:表示该事件总的花费时间</span><br><span class="hljs-comment">注意：_current表中每个线程只保留一条记录，一旦线程完成工作，该表中不会再记录该线程的事件信息</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">_history表中记录每个线程应该执行完成的事件信息，但每个线程的事件信息只会记录10条，再多就会被覆盖，*_history_long表中记录所有线程的事件信息，但总记录数量是10000，超过就会被覆盖掉</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">select</span> thread_id,event_id,event_name,timer_wait <span class="hljs-keyword">from</span> events_waits_history <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> thread_id limit <span class="hljs-number">21</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">summary表提供所有事件的汇总信息，该组中的表以不同的方式汇总事件数据（如：按用户，按主机，按线程等等）。例如：要查看哪些instruments占用最多的时间，可以通过对events_waits_summary_global_by_event_name表的COUNT_STAR或SUM_TIMER_WAIT列进行查询（这两列是对事件的记录数执行COUNT（*）、事件记录的TIMER_WAIT列执行SUM（TIMER_WAIT）统计而来）</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">SELECT</span> EVENT_NAME,COUNT_STAR <span class="hljs-keyword">FROM</span> events_waits_summary_global_by_event_name  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> COUNT_STAR <span class="hljs-keyword">DESC</span> LIMIT <span class="hljs-number">10</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">instance表记录了哪些类型的对象会被检测。这些对象在被server使用时，在该表中将会产生一条事件记录，例如，file_instances表列出了文件I/O操作及其关联文件名</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> file_instances limit <span class="hljs-number">20</span>; <br></code></pre></td></tr></table></figure><h3 id="常用配置项的参数说明"><a href="#常用配置项的参数说明" class="headerlink" title="常用配置项的参数说明"></a>常用配置项的参数说明</h3><p>1、启动选项</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs sql">performance_schema_consumer_events_statements_current<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><br>是否在mysql server启动时就开启events_statements_current表的记录功能(该表记录当前的语句事件信息)，启动之后也可以在setup_consumers表中使用<span class="hljs-keyword">UPDATE</span>语句进行动态更新setup_consumers配置表中的events_statements_current配置项，默认值为<span class="hljs-literal">TRUE</span><br><br>performance_schema_consumer_events_statements_history<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><br>与performance_schema_consumer_events_statements_current选项类似，但该选项是用于配置是否记录语句事件短历史信息，默认为<span class="hljs-literal">TRUE</span><br><br>performance_schema_consumer_events_stages_history_long<span class="hljs-operator">=</span><span class="hljs-literal">FALSE</span><br>与performance_schema_consumer_events_statements_current选项类似，但该选项是用于配置是否记录语句事件长历史信息，默认为<span class="hljs-literal">FALSE</span><br><br>除了statement(语句)事件之外，还支持：wait(等待)事件、state(阶段)事件、transaction(事务)事件，他们与statement事件一样都有三个启动项分别进行配置，但这些等待事件默认未启用，如果需要在MySQL Server启动时一同启动，则通常需要写进my.cnf配置文件中<br>performance_schema_consumer_global_instrumentation<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><br>是否在MySQL Server启动时就开启全局表（如：mutex_instances、rwlock_instances、cond_instances、file_instances、users、hostsaccounts、socket_summary_by_event_name、file_summary_by_instance等大部分的全局对象计数统计和事件汇总统计信息表 ）的记录功能，启动之后也可以在setup_consumers表中使用<span class="hljs-keyword">UPDATE</span>语句进行动态更新全局配置项<br>默认值为<span class="hljs-literal">TRUE</span><br><br>performance_schema_consumer_statements_digest<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><br>是否在MySQL Server启动时就开启events_statements_summary_by_digest 表的记录功能，启动之后也可以在setup_consumers表中使用<span class="hljs-keyword">UPDATE</span>语句进行动态更新digest配置项<br>默认值为<span class="hljs-literal">TRUE</span><br><br>performance_schema_consumer_thread_instrumentation<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><br>是否在MySQL Server启动时就开启<br><br>events_xxx_summary_by_yyy_by_event_name表的记录功能，启动之后也可以在setup_consumers表中使用<span class="hljs-keyword">UPDATE</span>语句进行动态更新线程配置项<br>默认值为<span class="hljs-literal">TRUE</span><br><br>performance_schema_instrument[<span class="hljs-operator">=</span>name]<br>是否在MySQL Server启动时就启用某些采集器，由于instruments配置项多达数千个，所以该配置项支持key<span class="hljs-operator">-</span><span class="hljs-keyword">value</span>模式，还支持<span class="hljs-operator">%</span>号进行通配等，如下:<br><br># [<span class="hljs-operator">=</span>name]可以指定为具体的Instruments名称（但是这样如果有多个需要指定的时候，就需要使用该选项多次），也可以使用通配符，可以指定instruments相同的前缀<span class="hljs-operator">+</span>通配符，也可以使用<span class="hljs-operator">%</span>代表所有的instruments<br><br>## 指定开启单个instruments<br><br><span class="hljs-comment">--performance-schema-instrument= &#x27;instrument_name=value&#x27;</span><br><br>## 使用通配符指定开启多个instruments<br><br><span class="hljs-comment">--performance-schema-instrument= &#x27;wait/synch/cond/%=COUNTED&#x27;</span><br><br>## 开关所有的instruments<br><br><span class="hljs-comment">--performance-schema-instrument= &#x27;%=ON&#x27;</span><br><br><span class="hljs-comment">--performance-schema-instrument= &#x27;%=OFF&#x27;</span><br><br>注意，这些启动选项要生效的前提是，需要设置performance_schema<span class="hljs-operator">=</span><span class="hljs-keyword">ON</span>。另外，这些启动选项虽然无法使用<span class="hljs-keyword">show</span> variables语句查看，但我们可以通过setup_instruments和setup_consumers表查询这些选项指定的值。<br></code></pre></td></tr></table></figure><p>2、系统变量</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%performance_schema%&#x27;</span>;<br><span class="hljs-comment">--重要的属性解释</span><br>performance_schema<span class="hljs-operator">=</span><span class="hljs-keyword">ON</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">控制performance_schema功能的开关，要使用MySQL的performance_schema，需要在mysqld启动时启用，以启用事件收集功能</span><br><span class="hljs-comment">该参数在5.7.x之前支持performance_schema的版本中默认关闭，5.7.x版本开始默认开启</span><br><span class="hljs-comment">注意：如果mysqld在初始化performance_schema时发现无法分配任何相关的内部缓冲区，则performance_schema将自动禁用，并将performance_schema设置为OFF</span><br><span class="hljs-comment">*/</span><br><br>performance_schema_digests_size<span class="hljs-operator">=</span><span class="hljs-number">10000</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">控制events_statements_summary_by_digest表中的最大行数。如果产生的语句摘要信息超过此最大值，便无法继续存入该表，此时performance_schema会增加状态变量</span><br><span class="hljs-comment">*/</span><br>performance_schema_events_statements_history_long_size<span class="hljs-operator">=</span><span class="hljs-number">10000</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">控制events_statements_history_long表中的最大行数，该参数控制所有会话在events_statements_history_long表中能够存放的总事件记录数，超过这个限制之后，最早的记录将被覆盖</span><br><span class="hljs-comment">全局变量，只读变量，整型值，5.6.3版本引入 * 5.6.x版本中，5.6.5及其之前的版本默认为10000，5.6.6及其之后的版本默认值为-1，通常情况下，自动计算的值都是10000 * 5.7.x版本中，默认值为-1，通常情况下，自动计算的值都是10000</span><br><span class="hljs-comment">*/</span><br>performance_schema_events_statements_history_size<span class="hljs-operator">=</span><span class="hljs-number">10</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">控制events_statements_history表中单个线程（会话）的最大行数，该参数控制单个会话在events_statements_history表中能够存放的事件记录数，超过这个限制之后，单个会话最早的记录将被覆盖</span><br><span class="hljs-comment">全局变量，只读变量，整型值，5.6.3版本引入 * 5.6.x版本中，5.6.5及其之前的版本默认为10，5.6.6及其之后的版本默认值为-1，通常情况下，自动计算的值都是10 * 5.7.x版本中，默认值为-1，通常情况下，自动计算的值都是10</span><br><span class="hljs-comment">除了statement(语句)事件之外，wait(等待)事件、state(阶段)事件、transaction(事务)事件，他们与statement事件一样都有三个参数分别进行存储限制配置，有兴趣的同学自行研究，这里不再赘述</span><br><span class="hljs-comment">*/</span><br>performance_schema_max_digest_length<span class="hljs-operator">=</span><span class="hljs-number">1024</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">用于控制标准化形式的SQL语句文本在存入performance_schema时的限制长度，该变量与max_digest_length变量相关(max_digest_length变量含义请自行查阅相关资料)</span><br><span class="hljs-comment">全局变量，只读变量，默认值1024字节，整型值，取值范围0~1048576</span><br><span class="hljs-comment">*/</span><br>performance_schema_max_sql_text_length<span class="hljs-operator">=</span><span class="hljs-number">1024</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">控制存入events_statements_current，events_statements_history和events_statements_history_long语句事件表中的SQL_TEXT列的最大SQL长度字节数。 超出系统变量performance_schema_max_sql_text_length的部分将被丢弃，不会记录，一般情况下不需要调整该参数，除非被截断的部分与其他SQL比起来有很大差异</span><br><span class="hljs-comment">全局变量，只读变量，整型值，默认值为1024字节，取值范围为0~1048576，5.7.6版本引入</span><br><span class="hljs-comment">降低系统变量performance_schema_max_sql_text_length值可以减少内存使用，但如果汇总的SQL中，被截断部分有较大差异，会导致没有办法再对这些有较大差异的SQL进行区分。 增加该系统变量值会增加内存使用，但对于汇总SQL来讲可以更精准地区分不同的部分。</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><h3 id="重要配置表的相关说明"><a href="#重要配置表的相关说明" class="headerlink" title="重要配置表的相关说明"></a>重要配置表的相关说明</h3><p>​配置表之间存在相互关联关系，按照配置影响的先后顺序，可添加为</p><p><img src="/.com//performanceschema%E9%85%8D%E7%BD%AE%E8%A1%A8.png" alt="performanceschema配置表"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">/*</span><br><span class="hljs-comment">performance_timers表中记录了server中有哪些可用的事件计时器</span><br><span class="hljs-comment">字段解释：</span><br><span class="hljs-comment">timer_name:表示可用计时器名称，CYCLE是基于CPU周期计数器的定时器</span><br><span class="hljs-comment">timer_frequency:表示每秒钟对应的计时器单位的数量,CYCLE计时器的换算值与CPU的频率相关、</span><br><span class="hljs-comment">timer_resolution:计时器精度值，表示在每个计时器被调用时额外增加的值</span><br><span class="hljs-comment">timer_overhead:表示在使用定时器获取事件时开销的最小周期值</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> performance_timers;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">setup_timers表中记录当前使用的事件计时器信息</span><br><span class="hljs-comment">字段解释：</span><br><span class="hljs-comment">name:计时器类型，对应某个事件类别</span><br><span class="hljs-comment">timer_name:计时器类型名称</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> setup_timers;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">setup_consumers表中列出了consumers可配置列表项</span><br><span class="hljs-comment">字段解释：</span><br><span class="hljs-comment">NAME：consumers配置名称</span><br><span class="hljs-comment">ENABLED：consumers是否启用，有效值为YES或NO，此列可以使用UPDATE语句修改。</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> setup_consumers;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">setup_instruments 表列出了instruments 列表配置项，即代表了哪些事件支持被收集：</span><br><span class="hljs-comment">字段解释：</span><br><span class="hljs-comment">NAME：instruments名称，instruments名称可能具有多个部分并形成层次结构</span><br><span class="hljs-comment">ENABLED：instrumetns是否启用，有效值为YES或NO，此列可以使用UPDATE语句修改。如果设置为NO，则这个instruments不会被执行，不会产生任何的事件信息</span><br><span class="hljs-comment">TIMED：instruments是否收集时间信息，有效值为YES或NO，此列可以使用UPDATE语句修改，如果设置为NO，则这个instruments不会收集时间信息</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> setup_instruments;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">setup_actors表的初始内容是匹配任何用户和主机，因此对于所有前台线程，默认情况下启用监视和历史事件收集功能</span><br><span class="hljs-comment">字段解释：</span><br><span class="hljs-comment">HOST：与grant语句类似的主机名，一个具体的字符串名字，或使用“％”表示“任何主机”</span><br><span class="hljs-comment">USER：一个具体的字符串名称，或使用“％”表示“任何用户”</span><br><span class="hljs-comment">ROLE：当前未使用，MySQL 8.0中才启用角色功能</span><br><span class="hljs-comment">ENABLED：是否启用与HOST，USER，ROLE匹配的前台线程的监控功能，有效值为：YES或NO</span><br><span class="hljs-comment">HISTORY：是否启用与HOST， USER，ROLE匹配的前台线程的历史事件记录功能，有效值为：YES或NO</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> setup_actors;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">setup_objects表控制performance_schema是否监视特定对象。默认情况下，此表的最大行数为100行。</span><br><span class="hljs-comment">字段解释：</span><br><span class="hljs-comment">OBJECT_TYPE：instruments类型，有效值为：“EVENT”（事件调度器事件）、“FUNCTION”（存储函数）、“PROCEDURE”（存储过程）、“TABLE”（基表）、“TRIGGER”（触发器），TABLE对象类型的配置会影响表I/O事件（wait/io/table/sql/handler instrument）和表锁事件（wait/lock/table/sql/handler instrument）的收集</span><br><span class="hljs-comment">OBJECT_SCHEMA：某个监视类型对象涵盖的数据库名称，一个字符串名称，或“％”(表示“任何数据库”)</span><br><span class="hljs-comment">OBJECT_NAME：某个监视类型对象涵盖的表名，一个字符串名称，或“％”(表示“任何数据库内的对象”)</span><br><span class="hljs-comment">ENABLED：是否开启对某个类型对象的监视功能，有效值为：YES或NO。此列可以修改</span><br><span class="hljs-comment">TIMED：是否开启对某个类型对象的时间收集功能，有效值为：YES或NO，此列可以修改</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> setup_objects;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">threads表对于每个server线程生成一行包含线程相关的信息，</span><br><span class="hljs-comment">字段解释：</span><br><span class="hljs-comment">THREAD_ID：线程的唯一标识符（ID）</span><br><span class="hljs-comment">NAME：与server中的线程检测代码相关联的名称(注意，这里不是instruments名称)</span><br><span class="hljs-comment">TYPE：线程类型，有效值为：FOREGROUND、BACKGROUND。分别表示前台线程和后台线程</span><br><span class="hljs-comment">PROCESSLIST_ID：对应INFORMATION_SCHEMA.PROCESSLIST表中的ID列。</span><br><span class="hljs-comment">PROCESSLIST_USER：与前台线程相关联的用户名，对于后台线程为NULL。</span><br><span class="hljs-comment">PROCESSLIST_HOST：与前台线程关联的客户端的主机名，对于后台线程为NULL。</span><br><span class="hljs-comment">PROCESSLIST_DB：线程的默认数据库，如果没有，则为NULL。</span><br><span class="hljs-comment">PROCESSLIST_COMMAND：对于前台线程，该值代表着当前客户端正在执行的command类型，如果是sleep则表示当前会话处于空闲状态</span><br><span class="hljs-comment">PROCESSLIST_TIME：当前线程已处于当前线程状态的持续时间（秒）</span><br><span class="hljs-comment">PROCESSLIST_STATE：表示线程正在做什么事情。</span><br><span class="hljs-comment">PROCESSLIST_INFO：线程正在执行的语句，如果没有执行任何语句，则为NULL。</span><br><span class="hljs-comment">PARENT_THREAD_ID：如果这个线程是一个子线程（由另一个线程生成），那么该字段显示其父线程ID</span><br><span class="hljs-comment">ROLE：暂未使用</span><br><span class="hljs-comment">INSTRUMENTED：线程执行的事件是否被检测。有效值：YES、NO </span><br><span class="hljs-comment">HISTORY：是否记录线程的历史事件。有效值：YES、NO * </span><br><span class="hljs-comment">THREAD_OS_ID：由操作系统层定义的线程或任务标识符（ID）：</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> threads<br></code></pre></td></tr></table></figure><p>注意：在performance_schema库中还包含了很多其他的库和表，能对数据库的性能做完整的监控，大家需要参考官网详细了解。</p><h3 id="performance-schema实践操作"><a href="#performance-schema实践操作" class="headerlink" title="performance_schema实践操作"></a>performance_schema实践操作</h3><p>​基本了解了表的相关信息之后，可以通过这些表进行实际的查询操作来进行实际的分析。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--1、哪类的SQL执行最多？</span><br><span class="hljs-keyword">SELECT</span> DIGEST_TEXT,COUNT_STAR,FIRST_SEEN,LAST_SEEN <span class="hljs-keyword">FROM</span> events_statements_summary_by_digest <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> COUNT_STAR <span class="hljs-keyword">DESC</span><br><span class="hljs-comment">--2、哪类SQL的平均响应时间最多？</span><br><span class="hljs-keyword">SELECT</span> DIGEST_TEXT,AVG_TIMER_WAIT <span class="hljs-keyword">FROM</span> events_statements_summary_by_digest <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> COUNT_STAR <span class="hljs-keyword">DESC</span><br><span class="hljs-comment">--3、哪类SQL排序记录数最多？</span><br><span class="hljs-keyword">SELECT</span> DIGEST_TEXT,SUM_SORT_ROWS <span class="hljs-keyword">FROM</span> events_statements_summary_by_digest <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> COUNT_STAR <span class="hljs-keyword">DESC</span><br><span class="hljs-comment">--4、哪类SQL扫描记录数最多？</span><br><span class="hljs-keyword">SELECT</span> DIGEST_TEXT,SUM_ROWS_EXAMINED <span class="hljs-keyword">FROM</span> events_statements_summary_by_digest <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> COUNT_STAR <span class="hljs-keyword">DESC</span><br><span class="hljs-comment">--5、哪类SQL使用临时表最多？</span><br><span class="hljs-keyword">SELECT</span> DIGEST_TEXT,SUM_CREATED_TMP_TABLES,SUM_CREATED_TMP_DISK_TABLES <span class="hljs-keyword">FROM</span> events_statements_summary_by_digest <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> COUNT_STAR <span class="hljs-keyword">DESC</span><br><span class="hljs-comment">--6、哪类SQL返回结果集最多？</span><br><span class="hljs-keyword">SELECT</span> DIGEST_TEXT,SUM_ROWS_SENT <span class="hljs-keyword">FROM</span> events_statements_summary_by_digest <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> COUNT_STAR <span class="hljs-keyword">DESC</span><br><span class="hljs-comment">--7、哪个表物理IO最多？</span><br><span class="hljs-keyword">SELECT</span> file_name,event_name,SUM_NUMBER_OF_BYTES_READ,SUM_NUMBER_OF_BYTES_WRITE <span class="hljs-keyword">FROM</span> file_summary_by_instance <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> SUM_NUMBER_OF_BYTES_READ <span class="hljs-operator">+</span> SUM_NUMBER_OF_BYTES_WRITE <span class="hljs-keyword">DESC</span><br><span class="hljs-comment">--8、哪个表逻辑IO最多？</span><br><span class="hljs-keyword">SELECT</span> object_name,COUNT_READ,COUNT_WRITE,COUNT_FETCH,SUM_TIMER_WAIT <span class="hljs-keyword">FROM</span> table_io_waits_summary_by_table <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sum_timer_wait <span class="hljs-keyword">DESC</span><br><span class="hljs-comment">--9、哪个索引访问最多？</span><br><span class="hljs-keyword">SELECT</span> OBJECT_NAME,INDEX_NAME,COUNT_FETCH,COUNT_INSERT,COUNT_UPDATE,COUNT_DELETE <span class="hljs-keyword">FROM</span> table_io_waits_summary_by_index_usage <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> SUM_TIMER_WAIT <span class="hljs-keyword">DESC</span><br><span class="hljs-comment">--10、哪个索引从来没有用过？</span><br><span class="hljs-keyword">SELECT</span> OBJECT_SCHEMA,OBJECT_NAME,INDEX_NAME <span class="hljs-keyword">FROM</span> table_io_waits_summary_by_index_usage <span class="hljs-keyword">WHERE</span> INDEX_NAME <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> COUNT_STAR <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">AND</span> OBJECT_SCHEMA <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">&#x27;mysql&#x27;</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> OBJECT_SCHEMA,OBJECT_NAME;<br><span class="hljs-comment">--11、哪个等待事件消耗时间最多？</span><br><span class="hljs-keyword">SELECT</span> EVENT_NAME,COUNT_STAR,SUM_TIMER_WAIT,AVG_TIMER_WAIT <span class="hljs-keyword">FROM</span> events_waits_summary_global_by_event_name <span class="hljs-keyword">WHERE</span> event_name <span class="hljs-operator">!=</span> <span class="hljs-string">&#x27;idle&#x27;</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> SUM_TIMER_WAIT <span class="hljs-keyword">DESC</span><br><span class="hljs-comment">--12-1、剖析某条SQL的执行情况，包括statement信息，stege信息，wait信息</span><br><span class="hljs-keyword">SELECT</span> EVENT_ID,sql_text <span class="hljs-keyword">FROM</span> events_statements_history <span class="hljs-keyword">WHERE</span> sql_text <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%count(*)%&#x27;</span>;<br><span class="hljs-comment">--12-2、查看每个阶段的时间消耗</span><br><span class="hljs-keyword">SELECT</span> event_id,EVENT_NAME,SOURCE,TIMER_END <span class="hljs-operator">-</span> TIMER_START <span class="hljs-keyword">FROM</span> events_stages_history_long <span class="hljs-keyword">WHERE</span> NESTING_EVENT_ID <span class="hljs-operator">=</span> <span class="hljs-number">1553</span>;<br><span class="hljs-comment">--12-3、查看每个阶段的锁等待情况</span><br><span class="hljs-keyword">SELECT</span> event_id,event_name,source,timer_wait,object_name,index_name,operation,nesting_event_id <span class="hljs-keyword">FROM</span> events_waits_history_longWHERE nesting_event_id <span class="hljs-operator">=</span> <span class="hljs-number">1553</span>;<br></code></pre></td></tr></table></figure><h2 id="SHOW-PROCESSLIST"><a href="#SHOW-PROCESSLIST" class="headerlink" title="SHOW PROCESSLIST"></a>SHOW PROCESSLIST</h2><p><a href="https://dev.mysql.com/doc/refman/8.0/en/show-processlist.html"><code>SHOW PROCESSLIST</code></a>从 MySQL 8.0.22 开始，基于 Performance Schema 表 的替代实现 可用<a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema-processlist-table.html"><code>processlist</code></a>，与默认<a href="https://dev.mysql.com/doc/refman/8.0/en/show-processlist.html"><code>SHOW PROCESSLIST</code></a> 实现不同，它不需要互斥体并且具有更好的性能特征。有关详细信息，请参阅 <a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema-processlist-table.html">第 27.12.21.5 节，“进程列表表”</a>。</p><table><thead><tr><th>字段</th><th>字段说明</th></tr></thead><tbody><tr><td>id</td><td>表示session id</td></tr><tr><td>user</td><td>表示操作的用户</td></tr><tr><td>host</td><td>表示操作的主机</td></tr><tr><td>db</td><td>表示操作的数据库</td></tr><tr><td>command</td><td>表示当前状态</td></tr><tr><td></td><td>sleep：线程正在等待客户端发送新的请求</td></tr><tr><td></td><td>query：线程正在执行查询或正在将结果发送给客户端</td></tr><tr><td></td><td>locked：在mysql的服务层，该线程正在等待表锁</td></tr><tr><td></td><td>analyzing and statistics：线程正在收集存储引擎的统计信息，并生成查询的执行计划</td></tr><tr><td></td><td>Copying to tmp table：线程正在执行查询，并且将其结果集都复制到一个临时表中</td></tr><tr><td></td><td>sorting result：线程正在对结果集进行排序</td></tr><tr><td></td><td>sending data：线程可能在多个状态之间传送数据，或者在生成结果集或者向客户端返回数据</td></tr><tr><td>info</td><td>表示详细的sql语句</td></tr><tr><td>time</td><td>表示相应命令执行时间</td></tr><tr><td>state</td><td>表示命令执行状态</td></tr></tbody></table><h1 id="mysql-执行计划"><a href="#mysql-执行计划" class="headerlink" title="mysql 执行计划"></a>mysql 执行计划</h1><p>​       在企业的应用场景中，为了知道优化SQL语句的执行，需要查看SQL语句的具体执行过程，以加快SQL语句的执行效率。</p><p>​       可以使用explain+SQL语句来模拟优化器执行SQL查询语句，从而知道mysql是如何处理sql语句的。</p><p>​   官网地址： <a href="https://dev.mysql.com/doc/refman/5.5/en/explain-output.html">https://dev.mysql.com/doc/refman/5.5/en/explain-output.html</a> </p><h2 id="执行计划中包含的信息"><a href="#执行计划中包含的信息" class="headerlink" title="执行计划中包含的信息"></a>执行计划中包含的信息</h2><table><thead><tr><th align="center">Column</th><th align="center">Meaning</th></tr></thead><tbody><tr><td align="center">id</td><td align="center">The <code>SELECT</code> identifier</td></tr><tr><td align="center">select_type</td><td align="center">The <code>SELECT</code> type</td></tr><tr><td align="center">table</td><td align="center">The table for the output row</td></tr><tr><td align="center">partitions</td><td align="center">The matching partitions</td></tr><tr><td align="center">type</td><td align="center">The join type</td></tr><tr><td align="center">possible_keys</td><td align="center">The possible indexes to choose</td></tr><tr><td align="center">key</td><td align="center">The index actually chosen</td></tr><tr><td align="center">key_len</td><td align="center">The length of the chosen key</td></tr><tr><td align="center">ref</td><td align="center">The columns compared to the index</td></tr><tr><td align="center">rows</td><td align="center">Estimate of rows to be examined</td></tr><tr><td align="center">filtered</td><td align="center">Percentage of rows filtered by table condition</td></tr><tr><td align="center">extra</td><td align="center">Additional information</td></tr></tbody></table><p><strong>id</strong></p><p>select查询的序列号，包含一组数字，表示查询中执行select子句或者操作表的顺序</p><p>id号分为三种情况：</p><p>​1、如果id相同，那么执行顺序从上到下</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp e <span class="hljs-keyword">join</span> dept d <span class="hljs-keyword">on</span> e.deptno <span class="hljs-operator">=</span> d.deptno <span class="hljs-keyword">join</span> salgrade sg <span class="hljs-keyword">on</span> e.sal <span class="hljs-keyword">between</span> sg.losal <span class="hljs-keyword">and</span> sg.hisal;<br></code></pre></td></tr></table></figure><p>​2、如果id不同，如果是子查询，id的序号会递增，id值越大优先级越高，越先被执行</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp e <span class="hljs-keyword">where</span> e.deptno <span class="hljs-keyword">in</span> (<span class="hljs-keyword">select</span> d.deptno <span class="hljs-keyword">from</span> dept d <span class="hljs-keyword">where</span> d.dname <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;SALES&#x27;</span>);<br></code></pre></td></tr></table></figure><p>​3、id相同和不同的，同时存在：相同的可以认为是一组，从上往下顺序执行，在所有组中，id值越大，优先级越高，越先执行</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp e <span class="hljs-keyword">join</span> dept d <span class="hljs-keyword">on</span> e.deptno <span class="hljs-operator">=</span> d.deptno <span class="hljs-keyword">join</span> salgrade sg <span class="hljs-keyword">on</span> e.sal <span class="hljs-keyword">between</span> sg.losal <span class="hljs-keyword">and</span> sg.hisal <span class="hljs-keyword">where</span> e.deptno <span class="hljs-keyword">in</span> (<span class="hljs-keyword">select</span> d.deptno <span class="hljs-keyword">from</span> dept d <span class="hljs-keyword">where</span> d.dname <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;SALES&#x27;</span>);<br></code></pre></td></tr></table></figure><p><strong>select_type</strong></p><p>主要用来分辨查询的类型，是普通查询还是联合查询还是子查询</p><table><thead><tr><th align="center"><code>select_type</code> Value</th><th align="center">Meaning</th></tr></thead><tbody><tr><td align="center">SIMPLE</td><td align="center">Simple SELECT (not using UNION or subqueries)</td></tr><tr><td align="center">PRIMARY</td><td align="center">Outermost SELECT</td></tr><tr><td align="center">UNION</td><td align="center">Second or later SELECT statement in a UNION</td></tr><tr><td align="center">DEPENDENT UNION</td><td align="center">Second or later SELECT statement in a UNION, dependent on outer query</td></tr><tr><td align="center">UNION RESULT</td><td align="center">Result of a UNION.</td></tr><tr><td align="center">SUBQUERY</td><td align="center">First SELECT in subquery</td></tr><tr><td align="center">DEPENDENT SUBQUERY</td><td align="center">First SELECT in subquery, dependent on outer query</td></tr><tr><td align="center">DERIVED</td><td align="center">Derived table</td></tr><tr><td align="center">UNCACHEABLE SUBQUERY</td><td align="center">A subquery for which the result cannot be cached and must be re-evaluated for each row of the outer query</td></tr><tr><td align="center">UNCACHEABLE UNION</td><td align="center">The second or later select in a UNION that belongs to an uncacheable subquery (see UNCACHEABLE SUBQUERY)</td></tr></tbody></table><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--sample:简单的查询，不包含子查询和union</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp;<br><br><span class="hljs-comment">--primary:查询中若包含任何复杂的子查询，最外层查询则被标记为Primary</span><br>explain <span class="hljs-keyword">select</span> staname,ename supname <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> ename staname,mgr <span class="hljs-keyword">from</span> emp) t <span class="hljs-keyword">join</span> emp <span class="hljs-keyword">on</span> t.mgr<span class="hljs-operator">=</span>emp.empno ;<br><br><span class="hljs-comment">--union:若第二个select出现在union之后，则被标记为union</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> deptno <span class="hljs-operator">=</span> <span class="hljs-number">10</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> sal <span class="hljs-operator">&gt;</span><span class="hljs-number">2000</span>;<br><br><span class="hljs-comment">--dependent union:跟union类似，此处的depentent表示union或union all联合而成的结果会受外部表影响</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp e <span class="hljs-keyword">where</span> e.empno  <span class="hljs-keyword">in</span> ( <span class="hljs-keyword">select</span> empno <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> deptno <span class="hljs-operator">=</span> <span class="hljs-number">10</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> empno <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> sal <span class="hljs-operator">&gt;</span><span class="hljs-number">2000</span>)<br><br><span class="hljs-comment">--union result:从union表获取结果的select</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> deptno <span class="hljs-operator">=</span> <span class="hljs-number">10</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> sal <span class="hljs-operator">&gt;</span><span class="hljs-number">2000</span>;<br><br><span class="hljs-comment">--subquery:在select或者where列表中包含子查询</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> sal <span class="hljs-operator">&gt;</span> (<span class="hljs-keyword">select</span> <span class="hljs-built_in">avg</span>(sal) <span class="hljs-keyword">from</span> emp) ;<br><br><span class="hljs-comment">--dependent subquery:subquery的子查询要受到外部表查询的影响</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp e <span class="hljs-keyword">where</span> e.deptno <span class="hljs-keyword">in</span> (<span class="hljs-keyword">select</span> <span class="hljs-keyword">distinct</span> deptno <span class="hljs-keyword">from</span> dept);<br><br><span class="hljs-comment">--DERIVED: from子句中出现的子查询，也叫做派生类，</span><br>explain <span class="hljs-keyword">select</span> staname,ename supname <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> ename staname,mgr <span class="hljs-keyword">from</span> emp) t <span class="hljs-keyword">join</span> emp <span class="hljs-keyword">on</span> t.mgr<span class="hljs-operator">=</span>emp.empno ;<br><br><span class="hljs-comment">--UNCACHEABLE SUBQUERY：表示使用子查询的结果不能被缓存</span><br> explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> empno <span class="hljs-operator">=</span> (<span class="hljs-keyword">select</span> empno <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> deptno<span class="hljs-operator">=</span>@<span class="hljs-variable">@sort</span>_buffer_size);<br> <br><span class="hljs-comment">--uncacheable union:表示union的查询结果不能被缓存：sql语句未验证</span><br></code></pre></td></tr></table></figure><p><strong>table</strong></p><p>对应行正在访问哪一个表，表名或者别名，可能是临时表或者union合并结果集<br>        1、如果是具体的表名，则表明从实际的物理表中获取数据，当然也可以是表的别名</p><p>​2、表名是derivedN的形式，表示使用了id为N的查询产生的衍生表</p><p>​3、当有union result的时候，表名是union n1,n2等的形式，n1,n2表示参与union的id</p><p><strong>type</strong></p><p>type显示的是访问类型，访问类型表示我是以何种方式去访问我们的数据，最容易想的是全表扫描，直接暴力的遍历一张表去寻找需要的数据，效率非常低下，访问的类型有很多，效率从最好到最坏依次是：</p><p>system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; ALL </p><p>一般情况下，得保证查询至少达到range级别，最好能达到ref</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--all:全表扫描，一般情况下出现这样的sql语句而且数据量比较大的话那么就需要进行优化。</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp;<br><br><span class="hljs-comment">--index：全索引扫描这个比all的效率要好，主要有两种情况，一种是当前的查询时覆盖索引，即我们需要的数据在索引中就可以索取，或者是使用了索引进行排序，这样就避免数据的重排序</span><br>explain  <span class="hljs-keyword">select</span> empno <span class="hljs-keyword">from</span> emp;<br><br><span class="hljs-comment">--range：表示利用索引查询的时候限制了范围，在指定范围内进行查询，这样避免了index的全索引扫描，适用的操作符： =, &lt;&gt;, &gt;, &gt;=, &lt;, &lt;=, IS NULL, BETWEEN, LIKE, or IN() </span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> empno <span class="hljs-keyword">between</span> <span class="hljs-number">7000</span> <span class="hljs-keyword">and</span> <span class="hljs-number">7500</span>;<br><br><span class="hljs-comment">--index_subquery：利用索引来关联子查询，不再扫描全表</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> emp.job <span class="hljs-keyword">in</span> (<span class="hljs-keyword">select</span> job <span class="hljs-keyword">from</span> t_job);<br><br><span class="hljs-comment">--unique_subquery:该连接类型类似与index_subquery,使用的是唯一索引</span><br> explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp e <span class="hljs-keyword">where</span> e.deptno <span class="hljs-keyword">in</span> (<span class="hljs-keyword">select</span> <span class="hljs-keyword">distinct</span> deptno <span class="hljs-keyword">from</span> dept);<br> <br><span class="hljs-comment">--index_merge：在查询过程中需要多个索引组合使用，没有模拟出来</span><br><br><span class="hljs-comment">--ref_or_null：对于某个字段即需要关联条件，也需要null值的情况下，查询优化器会选择这种访问方式</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp e <span class="hljs-keyword">where</span>  e.mgr <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">or</span> e.mgr<span class="hljs-operator">=</span><span class="hljs-number">7369</span>;<br><br><span class="hljs-comment">--ref：使用了非唯一性索引进行数据的查找</span><br> <span class="hljs-keyword">create</span> index idx_3 <span class="hljs-keyword">on</span> emp(deptno);<br> explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp e,dept d <span class="hljs-keyword">where</span> e.deptno <span class="hljs-operator">=</span>d.deptno;<br><br><span class="hljs-comment">--eq_ref ：使用唯一性索引进行数据查找</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp,emp2 <span class="hljs-keyword">where</span> emp.empno <span class="hljs-operator">=</span> emp2.empno;<br><br><span class="hljs-comment">--const：这个表至多有一个匹配行，</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> empno <span class="hljs-operator">=</span> <span class="hljs-number">7369</span>;<br> <br><span class="hljs-comment">--system：表只有一行记录（等于系统表），这是const类型的特例，平时不会出现</span><br></code></pre></td></tr></table></figure><p> <strong>possible_keys</strong> </p><p>​        显示可能应用在这张表中的索引，一个或多个，查询涉及到的字段上若存在索引，则该索引将被列出，但不一定被查询实际使用</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp,dept <span class="hljs-keyword">where</span> emp.deptno <span class="hljs-operator">=</span> dept.deptno <span class="hljs-keyword">and</span> emp.deptno <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><p><strong>key</strong></p><p>​实际使用的索引，如果为null，则没有使用索引，查询中若使用了覆盖索引，则该索引和查询的select字段重叠。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp,dept <span class="hljs-keyword">where</span> emp.deptno <span class="hljs-operator">=</span> dept.deptno <span class="hljs-keyword">and</span> emp.deptno <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><p><strong>key_len</strong></p><p>表示索引中使用的字节数，可以通过key_len计算查询中使用的索引长度，在不损失精度的情况下长度越短越好。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp,dept <span class="hljs-keyword">where</span> emp.deptno <span class="hljs-operator">=</span> dept.deptno <span class="hljs-keyword">and</span> emp.deptno <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><p><strong>ref</strong></p><p>显示索引的哪一列被使用了，如果可能的话，是一个常数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp,dept <span class="hljs-keyword">where</span> emp.deptno <span class="hljs-operator">=</span> dept.deptno <span class="hljs-keyword">and</span> emp.deptno <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><p><strong>rows</strong></p><p>根据表的统计信息及索引使用情况，大致估算出找出所需记录需要读取的行数，此参数很重要，直接反应的sql找了多少数据，在完成目的的情况下越少越好</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp;<br></code></pre></td></tr></table></figure><p><strong>extra</strong></p><p>包含额外的信息。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--using filesort:说明mysql无法利用索引进行排序，只能利用排序算法进行排序，会消耗额外的位置</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> sal;<br><br><span class="hljs-comment">--using temporary:建立临时表来保存中间结果，查询完成之后把临时表删除</span><br>explain <span class="hljs-keyword">select</span> ename,<span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> deptno <span class="hljs-operator">=</span> <span class="hljs-number">10</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> ename;<br><br><span class="hljs-comment">--using index:这个表示当前的查询时覆盖索引的，直接从索引中读取数据，而不用访问数据表。如果同时出现using where 表名索引被用来执行索引键值的查找，如果没有，表面索引被用来读取数据，而不是真的查找</span><br>explain <span class="hljs-keyword">select</span> deptno,<span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> deptno limit <span class="hljs-number">10</span>;<br><br><span class="hljs-comment">--using where:使用where进行条件过滤</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t_user <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><br><span class="hljs-comment">--using join buffer:使用连接缓存，情况没有模拟出来</span><br><br><span class="hljs-comment">--impossible where：where语句的结果总是false</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> empno <span class="hljs-operator">=</span> <span class="hljs-number">7469</span>;<br></code></pre></td></tr></table></figure><h1 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h1><h2 id="查询慢的原因"><a href="#查询慢的原因" class="headerlink" title="查询慢的原因"></a>查询慢的原因</h2><p>网络</p><p>CPU</p><p>IO</p><p>上下文切换</p><p>系统调用</p><p>生成统计信息</p><p>锁等待时间</p><h2 id="优化数据访问"><a href="#优化数据访问" class="headerlink" title="优化数据访问"></a>优化数据访问</h2><h3 id="查询性能低下的主要原因是访问的数据太多，某些查询不可避免的需要筛选大量的数据，我们可以通过减少访问数据量的方式进行优化"><a href="#查询性能低下的主要原因是访问的数据太多，某些查询不可避免的需要筛选大量的数据，我们可以通过减少访问数据量的方式进行优化" class="headerlink" title="查询性能低下的主要原因是访问的数据太多，某些查询不可避免的需要筛选大量的数据，我们可以通过减少访问数据量的方式进行优化"></a>查询性能低下的主要原因是访问的数据太多，某些查询不可避免的需要筛选大量的数据，我们可以通过减少访问数据量的方式进行优化</h3><p>1.确认应用程序是否在检索大量超过需要的数据</p><p>2.确认mysql服务器层是否在分析大量超过需要的数据行</p><h3 id="是否向数据库请求了不需要的数据："><a href="#是否向数据库请求了不需要的数据：" class="headerlink" title="是否向数据库请求了不需要的数据："></a>是否向数据库请求了不需要的数据：</h3><h4 id="查询不需要的记录："><a href="#查询不需要的记录：" class="headerlink" title="查询不需要的记录："></a>查询不需要的记录：</h4><p>我们常常会误以为mysql会只返回需要的数据，实际上mysql却是先返回全部结果再进行计算，在日常的开发习惯中，经常是先用select语句查询大量的结果，然后获取前面的N行后关闭结果集。</p><p>优化方式是在查询后面添加limit</p><h4 id="多表关联时返回全部列"><a href="#多表关联时返回全部列" class="headerlink" title="多表关联时返回全部列"></a>多表关联时返回全部列</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> actor <br><span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> film_actor <span class="hljs-keyword">using</span>(actor_id) <br><span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> film <span class="hljs-keyword">using</span>(film_id) <br><span class="hljs-keyword">where</span> film.title<span class="hljs-operator">=</span><span class="hljs-string">&#x27;Academy Dinosaur&#x27;</span>;<br><br><span class="hljs-keyword">select</span> actor.<span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> actor...;<br></code></pre></td></tr></table></figure><h4 id="总是取出全部列"><a href="#总是取出全部列" class="headerlink" title="总是取出全部列"></a>总是取出全部列</h4><p>在公司的企业需求中，禁止使用select *,虽然这种方式能够简化开发，但是会影响查询的性能，所以尽量不要使用</p><h4 id="重复查询相同的数据"><a href="#重复查询相同的数据" class="headerlink" title="重复查询相同的数据"></a>重复查询相同的数据</h4><p>如果需要不断的重复执行相同的查询，且每次返回完全相同的数据，因此，基于这样的应用场景，我们可以将这部分数据缓存起来，这样的话能够提高查询效率</p><h2 id="执行过程的优化"><a href="#执行过程的优化" class="headerlink" title="执行过程的优化"></a>执行过程的优化</h2><h3 id="查询缓存"><a href="#查询缓存" class="headerlink" title="查询缓存"></a>查询缓存</h3><p>在解析一个查询语句之前，如果查询缓存是打开的，那么mysql会优先检查这个查询是否命中查询缓存中的数据，如果查询恰好命中了查询缓存，那么会在返回结果之前会检查用户权限，如果权限没有问题，那么mysql会跳过所有的阶段，就直接从缓存中拿到结果并返回给客户端</p><h3 id="查询优化处理"><a href="#查询优化处理" class="headerlink" title="查询优化处理"></a>查询优化处理</h3><p>mysql查询完缓存之后会经过以下几个步骤：分析器、优化SQL执行计划，这几个步骤出现任何的错误，都可能会终止查询</p><h4 id="分析器"><a href="#分析器" class="headerlink" title="分析器"></a>分析器</h4><p>mysql通过关键字将SQL语句进行解析，并生成一颗解析树，mysql分析器将使用mysql语法规则验证和解析查询，例如验证使用使用了错误的关键字或者顺序是否正确等等，分析器会进一步检查解析树是否合法，例如表名和列名是否存在，是否有歧义，还会验证权限等等</p><h4 id="优化器"><a href="#优化器" class="headerlink" title="优化器"></a>优化器</h4><p>当语法树没有问题之后，相应的要由优化器将其转成执行计划，一条查询语句可以使用非常多的执行方式，最后都可以得到对应的结果，但是不同的执行方式带来的效率是不同的，优化器的最主要目的就是要选择最有效的执行计划</p><p>mysql使用的是基于成本的优化器，在优化的时候会尝试预测一个查询使用某种查询计划时候的成本，并选择其中成本最小的一个。</p><p>select count(*) from film_actor;<br>show status like ‘last_query_cost’;<br>可以看到这条查询语句大概需要做1104个数据页才能找到对应的数据，这是经过一系列的统计信息计算来的</p><p>每个表或者索引的页面个数；</p><p>索引的基数；</p><p>索引和数据行的长度；</p><p>索引的分布情况；</p><h5 id="在很多情况下mysql会选择错误的执行计划，原因如下："><a href="#在很多情况下mysql会选择错误的执行计划，原因如下：" class="headerlink" title="在很多情况下mysql会选择错误的执行计划，原因如下："></a>在很多情况下mysql会选择错误的执行计划，原因如下：</h5><p>1.统计信息不准确：</p><p>InnoDB因为其mvcc的架构，并不能维护一个数据表的行数的精确统计信息</p><p>2.执行计划的成本估算不等同于实际执行的成本：</p><p>有时候某个执行计划虽然需要读取更多的页面，但是他的成本却更小，因为如果这些页面都是顺序读或者这些页面都已经在内存中的话，那么它的访问成本将很小，mysql层面并不知道哪些页面在内存中，哪些在磁盘，所以查询之际执行过程中到底需要多少次IO是无法得知的</p><p>3.mysql的最优可能跟你想的不一样：</p><p>mysql的优化是基于成本模型的优化，但是有可能不是最快的优化。</p><p>4.mysql不考虑其他并发执行的查询：</p><p>5.mysql不会考虑不受其控制的操作成本：</p><p>执行存储过程或者用户自定义函数的成本。</p><h5 id="优化器的优化策略"><a href="#优化器的优化策略" class="headerlink" title="优化器的优化策略"></a>优化器的优化策略</h5><p>静态优化：</p><p>直接对解析树进行分析，并完成优化。</p><p>动态优化：</p><p>动态优化与查询的上下文有关，也可能跟取值、索引对应的行数有关</p><p>mysql对查询的静态优化只需要一次，但对动态优化在每次执行时都需要重新评估</p><h5 id="优化器的优化类型"><a href="#优化器的优化类型" class="headerlink" title="优化器的优化类型"></a>优化器的优化类型</h5><p>1.重新定义关联表的顺序：</p><p>数据表的关联并不总是按照在查询中指定的顺序进行，决定关联顺序时优化器很重要的功能</p><p>2.将外连接转化成内连接，内连接的效率要高于外连接；</p><p>3.使用等价变换规则，mysql可以使用一些等价变化来简化并规划表达式</p><p>4.优化count(),min(),max()</p><p>索引和列是否可以为空通常可以帮助mysql优化这类表达式：例如，要找到某一列的最小值，只需要查询索引的最左端的记录即可，不需要全文扫描比较</p><p>5.预估并转化为常数表达式，当mysql检测到一个表达式可以转化为常数的时候，就会一直把该表达式作为常数进行处理</p><p>explain select film.film_id,film_actor.actor_id from film inner join film_actor using(film_id) where film.film_id &#x3D; 1</p><p>6.索引覆盖扫描，当索引中的列包含所有查询中需要使用的列的时候，可以使用覆盖索引</p><p>7.子查询优化</p><p>mysql在某些情况下可以将子查询转换一种效率更高的形式，从而减少多个查询多次对数据进行访问，例如将经常查询的数据放入到缓存中</p><p>8.等值传播</p><p>如果两个列的值通过等式关联，那么mysql能够把其中一个列的where条件传递到另一个上：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> film.film_id <span class="hljs-keyword">from</span> film <br><span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> film_actor <span class="hljs-keyword">using</span>(film_id) <br><span class="hljs-keyword">where</span> film.film_id <span class="hljs-operator">&gt;</span> <span class="hljs-number">500</span>;<br></code></pre></td></tr></table></figure><p>这里使用film_id字段进行等值关联，film_id这个列不仅适用于film表而且适用于film_actor表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> film.film_id <span class="hljs-keyword">from</span> film <span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> film_actor <span class="hljs-keyword">using</span>(film_id) <span class="hljs-keyword">where</span> film.film_id <span class="hljs-operator">&gt;</span> <span class="hljs-number">500</span> <span class="hljs-keyword">and</span> film_actor.film_id <span class="hljs-operator">&gt;</span> <span class="hljs-number">500</span>;<br></code></pre></td></tr></table></figure><h3 id="关联查询"><a href="#关联查询" class="headerlink" title="关联查询"></a>关联查询</h3><p>join的实现方式原理</p><p>Simple Nested-Loop Join：</p><p><img src="/.com//simpleNestedLoopJoin.png" alt="simpleNestedLoopJoin"></p><p>Index Nested-Loop Join:</p><p><img src="/.com//indexNestedLoopJoin.png" alt="indexNestedLoopJoin"></p><p>Block Nested-Loop Join:</p><p><img src="/.com//blockNestedLoopJoin.png" alt="blockNestedLoopJoin"></p><p>（1）Join Buffer会缓存所有参与查询的列而不是只有Join的列。<br>（2）可以通过调整join_buffer_size缓存大小<br>（3）join_buffer_size的默认值是256K，join_buffer_size的最大值在MySQL 5.1.22版本前是4G-1，而之后的版本才能在64位操作系统下申请大于4G的Join Buffer空间。<br>（4）使用Block Nested-Loop Join算法需要开启优化器管理配置的optimizer_switch的设置block_nested_loop为on，默认为开启。</p><p>show variables like ‘%optimizer_switch%’</p><p>查看不同的顺序执行方式对查询性能的影响：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> film.film_id,film.title,film.release_year,actor.actor_id,actor.first_name,actor.last_name <span class="hljs-keyword">from</span> film <span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> film_actor <span class="hljs-keyword">using</span>(film_id) <span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> actor <span class="hljs-keyword">using</span>(actor_id);<br>查看执行的成本：<br><span class="hljs-keyword">show</span> status <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;last_query_cost&#x27;</span>; <br>按照自己预想的规定顺序执行：<br>explain <span class="hljs-keyword">select</span> straight_join film.film_id,film.title,film.release_year,actor.actor_id,actor.first_name,actor.last_name <span class="hljs-keyword">from</span> film <span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> film_actor <span class="hljs-keyword">using</span>(film_id) <span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> actor <span class="hljs-keyword">using</span>(actor_id);<br>查看执行的成本：<br><span class="hljs-keyword">show</span> status <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;last_query_cost&#x27;</span>; <br></code></pre></td></tr></table></figure><h3 id="排序优化"><a href="#排序优化" class="headerlink" title="排序优化"></a>排序优化</h3><p>无论如何排序都是一个成本很高的操作，所以从性能的角度出发，应该尽可能避免排序或者尽可能避免对大量数据进行排序。<br>推荐使用利用索引进行排序，但是当不能使用索引的时候，mysql就需要自己进行排序，如果数据量小则再内存中进行，如果数据量大就需要使用磁盘，mysql中称之为filesort。<br>如果需要排序的数据量小于排序缓冲区(show variables like ‘%sort_buffer_size%’;),mysql使用内存进行快速排序操作，如果内存不够排序，那么mysql就会先将树分块，对每个独立的块使用快速排序进行排序，并将各个块的排序结果存放再磁盘上，然后将各个排好序的块进行合并，最后返回排序结果。</p><p>排序的算法：</p><ol><li>两次传输排序:</li></ol><p>第一次数据读取是将需要排序的字段读取出来，然后进行排序，第二次是将排好序的结果按照需要去读取数据行。<br>这种方式效率比较低，原因是第二次读取数据的时候因为已经排好序，需要去读取所有记录而此时更多的是随机IO，读取数据成本会比较高<br>两次传输的优势，在排序的时候存储尽可能少的数据，让排序缓冲区可以尽可能多的容纳行数来进行排序操作</p><ol start="2"><li>单次传输排序</li></ol><p>先读取查询所需要的所有列，然后再根据给定列进行排序，最后直接返回排序结果，此方式只需要一次顺序IO读取所有的数据，而无须任何的随机IO，问题在于查询的列特别多的时候，会占用大量的存储空间，无法存储大量的数据</p><p>当需要排序的列的总大小超过max_length_for_sort_data定义的字节，mysql会选择双次排序，反之使用单次排序，当然，用户可以设置此参数的值来选择排序的方式。</p><h3 id="优化特定类型的查询"><a href="#优化特定类型的查询" class="headerlink" title="优化特定类型的查询"></a>优化特定类型的查询</h3><h4 id="优化count-查询"><a href="#优化count-查询" class="headerlink" title="优化count()查询"></a>优化count()查询</h4><p>count()是特殊的函数，有两种不同的作用，一种是某个列值的数量，也可以统计行数。</p><p>1.总有人认为myisam的count函数比较快，这是有前提条件的，只有没有任何where条件的count(*)才是比较快的</p><p>2.使用近似值：</p><p>在某些应用场景中，不需要完全精确的值，可以参考使用近似值来代替，比如可以使用explain来获取近似的值<br>其实在很多OLAP的应用中，需要计算某一个列值的基数，有一个计算近似值的算法叫hyperloglog。</p><p>3.更复杂的优化</p><p>一般情况下，count()需要扫描大量的行才能获取精确的数据，其实很难优化，在实际操作的时候可以考虑使用索引覆盖扫描，或者增加汇总表，或者增加外部缓存系统。</p><p>测试：</p><p>深分页问题</p><p>select id,name from test where create_time &gt;&#x3D; ‘2022-07-09 00:00:00’ limit 0, 10</p><p>select id,name from test where create_time &gt;&#x3D; ‘2022-07-09 00:00:00’ limit 100000, 10</p><ol><li>子查询优化</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> id,name <span class="hljs-keyword">from</span> test <span class="hljs-keyword">where</span> id <span class="hljs-operator">&gt;=</span> <br>(<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> test <span class="hljs-keyword">where</span> create_time <span class="hljs-operator">&gt;=</span> <span class="hljs-string">&#x27;2022-07-09 00:00:00&#x27;</span> limit <span class="hljs-number">1</span>) <br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id<br>limit  <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><ol start="2"><li>偏移法</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> id,name <span class="hljs-keyword">from</span> test <span class="hljs-keyword">where</span> id <span class="hljs-operator">&gt;=</span> <span class="hljs-number">100000</span><br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id<br>limit <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><h4 id="优化关联查询"><a href="#优化关联查询" class="headerlink" title="优化关联查询"></a>优化关联查询</h4><p>1.确保on或者using子句中的列上有索引，在创建索引的时候就要考虑到关联的顺序。</p><p>当表A和表B使用列C关联的时候，如果优化器的关联顺序是B、A，那么就不需要再B表的对应列上建上索引，没有用到的索引只会带来额外的负担，一般情况下来说，只需要在关联顺序中的第二个表的相应列上创建索引</p><p>2.确保任何的groupby和order by中的表达式只涉及到一个表中的列，这样mysql才有可能使用索引来优化这个过程</p><h4 id="优化子查询"><a href="#优化子查询" class="headerlink" title="优化子查询"></a>优化子查询</h4><p>子查询的优化最重要的优化建议是尽可能使用关联查询代替</p><h4 id="优化limit分页"><a href="#优化limit分页" class="headerlink" title="优化limit分页"></a>优化limit分页</h4><p>在很多应用场景中我们需要将数据进行分页，一般会使用limit加上偏移量的方法实现，同时加上合适的orderby 的子句，如果这种方式有索引的帮助，效率通常不错，否则的化需要进行大量的文件排序操作，还有一种情况，当偏移量非常大的时候，前面的大部分数据都会被抛弃，这样的代价太高。<br>要优化这种查询的话，要么是在页面中限制分页的数量，要么优化大偏移量的性能</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> film_id,description <span class="hljs-keyword">from</span> film <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> title limit <span class="hljs-number">50</span>,<span class="hljs-number">5</span><br><br><span class="hljs-comment">-- 查看执行计划查看扫描的行数</span><br>explain <br><span class="hljs-keyword">select</span> film.film_id,film.description <span class="hljs-keyword">from</span> film <br><span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> (<span class="hljs-keyword">select</span> film_id <span class="hljs-keyword">from</span> film <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> title limit <span class="hljs-number">50</span>,<span class="hljs-number">5</span>) <span class="hljs-keyword">as</span> lim <span class="hljs-keyword">using</span>(film_id);<br></code></pre></td></tr></table></figure><h4 id="优化union查询"><a href="#优化union查询" class="headerlink" title="优化union查询"></a>优化union查询</h4><p>除非确实需要服务器消除重复的行，否则一定要使用union all，因此没有all关键字，mysql会在查询的时候给临时表加上distinct的关键字，这个操作的代价很高</p><h4 id="推荐使用用户自定义变量"><a href="#推荐使用用户自定义变量" class="headerlink" title="推荐使用用户自定义变量"></a>推荐使用用户自定义变量</h4><p>用户自定义变量是一个容易被遗忘的mysql特性，但是如果能够用好，在某些场景下可以写出非常高效的查询语句，在查询中混合使用过程化和关系化逻辑的时候，自定义变量会非常有用。<br>用户自定义变量是一个用来存储内容的临时容器，在连接mysql的整个过程中都存在。</p><h5 id="自定义变量的使用"><a href="#自定义变量的使用" class="headerlink" title="自定义变量的使用"></a>自定义变量的使用</h5><p>set @one :&#x3D;1</p><p>set @min_actor :&#x3D;(select min(actor_id) from actor)</p><p>set @last_week :&#x3D;current_date-interval 1 week;</p><h5 id="自定义变量的限制"><a href="#自定义变量的限制" class="headerlink" title="自定义变量的限制"></a>自定义变量的限制</h5><p>1、无法使用查询缓存</p><p>2、不能在使用常量或者标识符的地方使用自定义变量，例如表名、列名或者limit子句</p><p>3、用户自定义变量的生命周期是在一个连接中有效，所以不能用它们来做连接间的通信</p><p>4、不能显式地声明自定义变量地类型</p><p>5、mysql优化器在某些场景下可能会将这些变量优化掉，这可能导致代码不按预想地方式运行</p><p>6、赋值符号：&#x3D;的优先级非常低，所以在使用赋值表达式的时候应该明确的使用括号</p><p>7、使用未定义变量不会产生任何语法错误</p><h5 id="自定义变量的使用案例"><a href="#自定义变量的使用案例" class="headerlink" title="自定义变量的使用案例"></a>自定义变量的使用案例</h5><p>优化排名语句</p><p>1、在给一个变量赋值的同时使用这个变量</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> actor_id,<span class="hljs-variable">@rownum</span>:<span class="hljs-operator">=</span><span class="hljs-variable">@rownum</span><span class="hljs-operator">+</span><span class="hljs-number">1</span> <span class="hljs-keyword">as</span> rownum <span class="hljs-keyword">from</span> actor limit <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><p>2、查询获取演过最多电影的前10名演员，然后根据出演电影次数做一个排名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> actor_id,<span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> cnt <span class="hljs-keyword">from</span> film_actor <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> actor_id <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> cnt <span class="hljs-keyword">desc</span> limit <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><h5 id="避免重新查询刚刚更新的数据"><a href="#避免重新查询刚刚更新的数据" class="headerlink" title="避免重新查询刚刚更新的数据"></a>避免重新查询刚刚更新的数据</h5><p>当需要高效的更新一条记录的时间戳，同时希望查询当前记录中存放的时间戳是什么。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">update</span> t1 <span class="hljs-keyword">set</span>  lastUpdated<span class="hljs-operator">=</span>now() <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br><span class="hljs-keyword">select</span> lastUpdated <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br><br><span class="hljs-keyword">update</span> t1 <span class="hljs-keyword">set</span> lastupdated <span class="hljs-operator">=</span> now() <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-variable">@now</span>:<span class="hljs-operator">=</span>now();<br><span class="hljs-keyword">select</span> <span class="hljs-variable">@now</span>;<br></code></pre></td></tr></table></figure><h5 id="确定取值的顺序"><a href="#确定取值的顺序" class="headerlink" title="确定取值的顺序"></a>确定取值的顺序</h5><p>在赋值和读取变量的时候可能是在查询的不同阶段</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">set</span> <span class="hljs-variable">@rownum</span>:<span class="hljs-operator">=</span><span class="hljs-number">0</span>;<br><span class="hljs-keyword">select</span> actor_id,<span class="hljs-variable">@rownum</span>:<span class="hljs-operator">=</span><span class="hljs-variable">@rownum</span><span class="hljs-operator">+</span><span class="hljs-number">1</span> <span class="hljs-keyword">as</span> cnt <span class="hljs-keyword">from</span> actor <span class="hljs-keyword">where</span> <span class="hljs-variable">@rownum</span><span class="hljs-operator">&lt;=</span><span class="hljs-number">1</span>;<br>因为<span class="hljs-keyword">where</span>和<span class="hljs-keyword">select</span>在查询的不同阶段执行，所以看到查询到两条记录，这不符合预期<br><br><span class="hljs-keyword">set</span> <span class="hljs-variable">@rownum</span>:<span class="hljs-operator">=</span><span class="hljs-number">0</span>;<br><span class="hljs-keyword">select</span> actor_id,<span class="hljs-variable">@rownum</span>:<span class="hljs-operator">=</span><span class="hljs-variable">@rownum</span><span class="hljs-operator">+</span><span class="hljs-number">1</span> <span class="hljs-keyword">as</span> cnt <span class="hljs-keyword">from</span> actor <span class="hljs-keyword">where</span> <span class="hljs-variable">@rownum</span><span class="hljs-operator">&lt;=</span><span class="hljs-number">1</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> first_name<br>当引入了<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span>之后，发现打印出了全部结果，这是因为<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span>引入了文件排序，而<span class="hljs-keyword">where</span>条件是在文件排序操作之前取值的  <br><br>解决这个问题的关键在于让变量的赋值和取值发生在执行查询的同一阶段：<br><span class="hljs-keyword">set</span> <span class="hljs-variable">@rownum</span>:<span class="hljs-operator">=</span><span class="hljs-number">0</span>;<br><span class="hljs-keyword">select</span> actor_id,<span class="hljs-variable">@rownum</span> <span class="hljs-keyword">as</span> cnt <span class="hljs-keyword">from</span> actor <span class="hljs-keyword">where</span> (<span class="hljs-variable">@rownum</span>:<span class="hljs-operator">=</span><span class="hljs-variable">@rownum</span><span class="hljs-operator">+</span><span class="hljs-number">1</span>)<span class="hljs-operator">&lt;=</span><span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><h1 id="通过索引进行优化"><a href="#通过索引进行优化" class="headerlink" title="通过索引进行优化"></a>通过索引进行优化</h1><h2 id="索引基本知识"><a href="#索引基本知识" class="headerlink" title="索引基本知识"></a>索引基本知识</h2><h3 id="索引的优点"><a href="#索引的优点" class="headerlink" title="索引的优点"></a>索引的优点</h3><p>1、大大减少了服务器需要扫描的数据量</p><p>2、帮助服务器避免排序和临时表</p><p>3、将随机io变成顺序io</p><h3 id="索引的用处"><a href="#索引的用处" class="headerlink" title="索引的用处"></a>索引的用处</h3><p>1、快速查找匹配WHERE子句的行</p><p>2、从consideration中消除行,如果可以在多个索引之间进行选择，mysql通常会使用找到最少行的索引</p><p>3、如果表具有多列索引，则优化器可以使用索引的任何最左前缀来查找行</p><p>4、当有表连接的时候，从其他表检索行数据</p><p>5、查找特定索引列的min或max值</p><p>6、如果排序或分组时在可用索引的最左前缀上完成的，则对表进行排序和分组</p><p>7、在某些情况下，可以优化查询以检索值而无需查询数据行</p><h3 id="索引的分类"><a href="#索引的分类" class="headerlink" title="索引的分类"></a>索引的分类</h3><p>主键索引</p><p>唯一索引</p><p>普通索引</p><p>全文索引</p><p>组合索引</p><h3 id="索引特性"><a href="#索引特性" class="headerlink" title="索引特性"></a>索引特性</h3><p>覆盖索引</p><p>最左匹配</p><p>索引下推</p><h3 id="索引采用的数据结构"><a href="#索引采用的数据结构" class="headerlink" title="索引采用的数据结构"></a>索引采用的数据结构</h3><p>哈希表</p><p>B+树</p><h3 id="索引匹配方式"><a href="#索引匹配方式" class="headerlink" title="索引匹配方式"></a>索引匹配方式</h3><p>全值匹配：全值匹配指的是和索引中的所有列进行匹配</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> staffs <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;July&#x27;</span> <span class="hljs-keyword">and</span> age <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;23&#x27;</span> <span class="hljs-keyword">and</span> pos <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;dev&#x27;</span>;<br></code></pre></td></tr></table></figure><p>匹配最左前缀:只匹配前面的几列</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> staffs <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;July&#x27;</span> <span class="hljs-keyword">and</span> age <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;23&#x27;</span>;<br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> staffs <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;July&#x27;</span>;<br></code></pre></td></tr></table></figure><p>匹配列前缀:可以匹配某一列的值的开头部分</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> staffs <span class="hljs-keyword">where</span> name <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;J%&#x27;</span>;<br><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> staffs <span class="hljs-keyword">where</span> name <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%y&#x27;</span>;<br></code></pre></td></tr></table></figure><p>匹配范围值:可以查找某一个范围的数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> staffs <span class="hljs-keyword">where</span> name <span class="hljs-operator">&gt;</span> <span class="hljs-string">&#x27;Mary&#x27;</span>;<br></code></pre></td></tr></table></figure><p>精确匹配某一列并范围匹配另外一列:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 可以查询第一列的全部和第二列的部分</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> staffs <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;July&#x27;</span> <span class="hljs-keyword">and</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">25</span>;<br></code></pre></td></tr></table></figure><p>只访问索引的查询:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 查询的时候只需要访问索引，不需要访问数据行，本质上就是覆盖索引</span><br>explain <span class="hljs-keyword">select</span> name,age,pos <span class="hljs-keyword">from</span> staffs <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;July&#x27;</span> <span class="hljs-keyword">and</span> age <span class="hljs-operator">=</span> <span class="hljs-number">25</span> <span class="hljs-keyword">and</span> pos <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;dev&#x27;</span>;<br></code></pre></td></tr></table></figure><h2 id="哈希索引"><a href="#哈希索引" class="headerlink" title="哈希索引"></a>哈希索引</h2><p>基于哈希表的实现，只有精确匹配索引所有列的查询才有效</p><p>在mysql中，只有memory的存储引擎显式支持哈希索引</p><p>哈希索引自身只需存储对应的hash值，所以索引的结构十分紧凑，这让哈希索引查找的速度非常快</p><h3 id="哈希索引的限制"><a href="#哈希索引的限制" class="headerlink" title="哈希索引的限制"></a>哈希索引的限制</h3><p>1、哈希索引只包含哈希值和行指针，而不存储字段值，索引不能使用索引中的值来避免读取行</p><p>2、哈希索引数据并不是按照索引值顺序存储的，所以无法进行排序</p><p>3、哈希索引不支持部分列匹配查找，哈希索引是使用索引列的全部内容来计算哈希值</p><p>4、哈希索引支持等值比较查询，也不支持任何范围查询</p><p>5、访问哈希索引的数据非常快，除非有很多哈希冲突，当出现哈希冲突的时候，存储引擎必须遍历链表中的所有行指针，逐行进行比较，直到找到所有符合条件的行</p><p>6、哈希冲突比较多的话，维护的代价也会很高</p><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>当需要存储大量的URL，并且根据URL进行搜索查找，如果使用B+树，存储的内容就会很大<br>select id from url where url&#x3D;””<br>也可以利用将url使用CRC32做哈希，可以使用以下查询方式：<br>select id fom url where url&#x3D;”” and url_crc&#x3D;CRC32(“”)<br>此查询性能较高原因是使用体积很小的索引来完成查找</p><h2 id="组合索引"><a href="#组合索引" class="headerlink" title="组合索引"></a>组合索引</h2><p>当包含多个列作为索引，需要注意的是正确的顺序依赖于该索引的查询，同时需要考虑如何更好的满足排序和分组的需要</p><h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p>建立组合索引a,b,c</p><p>不同SQL语句使用索引情况</p><p><img src="/.com//%E7%BB%84%E5%90%88%E7%B4%A2%E5%BC%95%E6%B5%8B%E8%AF%95%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%E6%83%85%E5%86%B5.png" alt="组合索引测试使用索引情况"></p><h2 id="聚簇索引与非聚簇索引"><a href="#聚簇索引与非聚簇索引" class="headerlink" title="聚簇索引与非聚簇索引"></a>聚簇索引与非聚簇索引</h2><h3 id="聚簇索引"><a href="#聚簇索引" class="headerlink" title="聚簇索引"></a>聚簇索引</h3><p>不是单独的索引类型，而是一种数据存储方式，指的是数据行跟相邻的键值紧凑的存储在一起</p><p>优点：</p><p>1、可以把相关数据保存在一起</p><p>2、数据访问更快，因为索引和数据保存在同一个树中</p><p>3、使用覆盖索引扫描的查询可以直接使用页节点中的主键值</p><p>缺点：</p><p>1、聚簇数据最大限度地提高了IO密集型应用的性能，如果数据全部在内存，那么聚簇索引就没有什么优势</p><p>2、插入速度严重依赖于插入顺序，按照主键的顺序插入是最快的方式</p><p>3、更新聚簇索引列的代价很高，因为会强制将每个被更新的行移动到新的位置</p><p>4、基于聚簇索引的表在插入新行，或者主键被更新导致需要移动行的时候，可能面临页分裂的问题</p><p>5、聚簇索引可能导致全表扫描变慢，尤其是行比较稀疏，或者由于页分裂导致数据存储不连续的时候</p><h3 id="非聚簇索引"><a href="#非聚簇索引" class="headerlink" title="非聚簇索引"></a>非聚簇索引</h3><p>数据文件跟索引文件分开存放</p><h2 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h2><h4 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h4><p>1、如果一个索引包含所有需要查询的字段的值，我们称之为覆盖索引</p><p>2、不是所有类型的索引都可以称为覆盖索引，覆盖索引必须要存储索引列的值</p><p>3、不同的存储实现覆盖索引的方式不同，不是所有的引擎都支持覆盖索引，memory不支持覆盖索引</p><h4 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h4><p>1、索引条目通常远小于数据行大小，如果只需要读取索引，那么mysql就会极大的较少数据访问量</p><p>2、因为索引是按照列值顺序存储的，所以对于IO密集型的范围查询会比随机从磁盘读取每一行数据的IO要少的多</p><p>3、一些存储引擎如MYISAM在内存中只缓存索引，数据则依赖于操作系统来缓存，因此要访问数据需要一次系统调用，这可能会导致严重的性能问题</p><p>4、由于INNODB的聚簇索引，覆盖索引对INNODB表特别有用</p><h4 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h4><p>1、当发起一个被索引覆盖的查询时，在explain的extra列可以看到using index的信息，此时就使用了覆盖索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> explain <span class="hljs-keyword">select</span> store_id,film_id <span class="hljs-keyword">from</span> inventory\G<br><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span> <span class="hljs-number">1.</span> <span class="hljs-type">row</span> <span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><br>           id: <span class="hljs-number">1</span><br>  select_type: SIMPLE<br>        <span class="hljs-keyword">table</span>: inventory<br>   partitions: <span class="hljs-keyword">NULL</span><br>         type: index<br>possible_keys: <span class="hljs-keyword">NULL</span><br>          key: idx_store_id_film_id<br>      key_len: <span class="hljs-number">3</span><br>          <span class="hljs-keyword">ref</span>: <span class="hljs-keyword">NULL</span><br>         <span class="hljs-keyword">rows</span>: <span class="hljs-number">4581</span><br>     filtered: <span class="hljs-number">100.00</span><br>        Extra: <span class="hljs-keyword">Using</span> index<br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.01</span> sec)<br><br></code></pre></td></tr></table></figure><p>2、在大多数存储引擎中，覆盖索引只能覆盖那些只访问索引中部分列的查询。不过，可以进一步的进行优化，可以使用innodb的二级索引来覆盖查询。</p><p>例如：actor使用innodb存储引擎，并在last_name字段又二级索引，虽然该索引的列不包括主键actor_id，但也能够用于对actor_id做覆盖查询</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> explain <span class="hljs-keyword">select</span> actor_id,last_name <span class="hljs-keyword">from</span> actor <span class="hljs-keyword">where</span> last_name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;HOPPER&#x27;</span>\G<br><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span> <span class="hljs-number">1.</span> <span class="hljs-type">row</span> <span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><br>           id: <span class="hljs-number">1</span><br>  select_type: SIMPLE<br>        <span class="hljs-keyword">table</span>: actor<br>   partitions: <span class="hljs-keyword">NULL</span><br>         type: <span class="hljs-keyword">ref</span><br>possible_keys: idx_actor_last_name<br>          key: idx_actor_last_name<br>      key_len: <span class="hljs-number">137</span><br>          <span class="hljs-keyword">ref</span>: const<br>         <span class="hljs-keyword">rows</span>: <span class="hljs-number">2</span><br>     filtered: <span class="hljs-number">100.00</span><br>        Extra: <span class="hljs-keyword">Using</span> index<br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.00</span> sec)<br><br></code></pre></td></tr></table></figure><h2 id="优化小细节"><a href="#优化小细节" class="headerlink" title="优化小细节"></a>优化小细节</h2><p>1.当使用索引列进行查询的时候尽量不要使用表达式，把计算放到业务层而不是数据库层</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> actor_id <span class="hljs-keyword">from</span> actor <span class="hljs-keyword">where</span> actor_id<span class="hljs-operator">=</span><span class="hljs-number">4</span>;<br><br><span class="hljs-keyword">select</span> actor_id <span class="hljs-keyword">from</span> actor <span class="hljs-keyword">where</span> actor_id<span class="hljs-operator">+</span><span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">5</span>;<br></code></pre></td></tr></table></figure><p>2.尽量使用主键查询，而不是其他索引，因此主键查询不会触发回表查询</p><p>3.使用前缀索引</p><p>有时候需要索引很长的字符串，这会让索引变的大且慢，通常情况下可以使用某个列开始的部分字符串，这样大大的节约索引空间，从而提高索引效率，但这会降低索引的选择性，索引的选择性是指不重复的索引值和数据表记录总数的比值，范围从1&#x2F;#T到1之间。索引的选择性越高则查询效率越高，因为选择性更高的索引可以让mysql在查找的时候过滤掉更多的行。</p><p>​一般情况下某个列前缀的选择性也是足够高的，足以满足查询的性能，但是对应BLOB,TEXT,VARCHAR类型的列，必须要使用前缀索引，因为mysql不允许索引这些列的完整长度，使用该方法的诀窍在于要选择足够长的前缀以保证较高的选择性，通过又不能太长。</p><p>测试：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--创建数据表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> citydemo(city <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> citydemo(city) <span class="hljs-keyword">select</span> city <span class="hljs-keyword">from</span> city;<br><br><span class="hljs-comment">--重复执行5次下面的sql语句</span><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> citydemo(city) <span class="hljs-keyword">select</span> city <span class="hljs-keyword">from</span> citydemo;<br><br><span class="hljs-comment">--更新城市表的名称</span><br><span class="hljs-keyword">update</span> citydemo <span class="hljs-keyword">set</span> city<span class="hljs-operator">=</span>(<span class="hljs-keyword">select</span> city <span class="hljs-keyword">from</span> city <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> rand() limit <span class="hljs-number">1</span>);<br><br><span class="hljs-comment">--查找最常见的城市列表，发现每个值都出现45-65次，</span><br><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> cnt,city <span class="hljs-keyword">from</span> citydemo <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> city <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> cnt <span class="hljs-keyword">desc</span> limit <span class="hljs-number">10</span>;<br><br><span class="hljs-comment">--查找最频繁出现的城市前缀，先从3个前缀字母开始，发现比原来出现的次数更多，可以分别截取多个字符查看城市出现的次数</span><br><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> cnt,<span class="hljs-keyword">left</span>(city,<span class="hljs-number">3</span>) <span class="hljs-keyword">as</span> pref <span class="hljs-keyword">from</span> citydemo <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> pref <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> cnt <span class="hljs-keyword">desc</span> limit <span class="hljs-number">10</span>;<br><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> cnt,<span class="hljs-keyword">left</span>(city,<span class="hljs-number">7</span>) <span class="hljs-keyword">as</span> pref <span class="hljs-keyword">from</span> citydemo <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> pref <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> cnt <span class="hljs-keyword">desc</span> limit <span class="hljs-number">10</span>;<br><span class="hljs-comment">--此时前缀的选择性接近于完整列的选择性</span><br><br><span class="hljs-comment">--还可以通过另外一种方式来计算完整列的选择性，可以看到当前缀长度到达7之后，再增加前缀长度，选择性提升的幅度已经很小了</span><br><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-keyword">distinct</span> <span class="hljs-keyword">left</span>(city,<span class="hljs-number">3</span>))<span class="hljs-operator">/</span><span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> sel3,<br><span class="hljs-built_in">count</span>(<span class="hljs-keyword">distinct</span> <span class="hljs-keyword">left</span>(city,<span class="hljs-number">4</span>))<span class="hljs-operator">/</span><span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> sel4,<br><span class="hljs-built_in">count</span>(<span class="hljs-keyword">distinct</span> <span class="hljs-keyword">left</span>(city,<span class="hljs-number">5</span>))<span class="hljs-operator">/</span><span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> sel5,<br><span class="hljs-built_in">count</span>(<span class="hljs-keyword">distinct</span> <span class="hljs-keyword">left</span>(city,<span class="hljs-number">6</span>))<span class="hljs-operator">/</span><span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> sel6,<br><span class="hljs-built_in">count</span>(<span class="hljs-keyword">distinct</span> <span class="hljs-keyword">left</span>(city,<span class="hljs-number">7</span>))<span class="hljs-operator">/</span><span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> sel7,<br><span class="hljs-built_in">count</span>(<span class="hljs-keyword">distinct</span> <span class="hljs-keyword">left</span>(city,<span class="hljs-number">8</span>))<span class="hljs-operator">/</span><span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> sel8 <br><span class="hljs-keyword">from</span> citydemo;<br><br><span class="hljs-comment">--计算完成之后可以创建前缀索引</span><br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> citydemo <span class="hljs-keyword">add</span> key(city(<span class="hljs-number">7</span>));<br><br><span class="hljs-comment">--注意：前缀索引是一种能使索引更小更快的有效方法，但是也包含缺点：mysql无法使用前缀索引做order by 和 group by。 </span><br></code></pre></td></tr></table></figure><p>4.使用索引扫描来排序</p><p>ysql有两种方式可以生成有序的结果：通过排序操作或者按索引顺序扫描，如果explain出来的type列的值为index,则说明mysql使用了索引扫描来做排序</p><p>​扫描索引本身是很快的，因为只需要从一条索引记录移动到紧接着的下一条记录。但如果索引不能覆盖查询所需的全部列，那么就不得不每扫描一条索引记录就得回表查询一次对应的行，这基本都是随机IO，因此按索引顺序读取数据的速度通常要比顺序地全表扫描慢</p><p>​mysql可以使用同一个索引即满足排序，又用于查找行，如果可能的话，设计索引时应该尽可能地同时满足这两种任务。</p><p>​只有当索引的列顺序和order by子句的顺序完全一致，并且所有列的排序方式都一样时，mysql才能够使用索引来对结果进行排序，如果查询需要关联多张表，则只有当orderby子句引用的字段全部为第一张表时，才能使用索引做排序。order by子句和查找型查询的限制是一样的，需要满足索引的最左前缀的要求，否则，mysql都需要执行顺序操作，而无法利用索引排序</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--sakila数据库中rental表在rental_date,inventory_id,customer_id上有rental_date的索引</span><br><span class="hljs-comment">--使用rental_date索引为下面的查询做排序</span><br>explain <span class="hljs-keyword">select</span> rental_id,staff_id <span class="hljs-keyword">from</span> rental <span class="hljs-keyword">where</span> rental_date<span class="hljs-operator">=</span><span class="hljs-string">&#x27;2005-05-25&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> inventory_id,customer_id\G<br><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span> <span class="hljs-number">1.</span> <span class="hljs-type">row</span> <span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><br>           id: <span class="hljs-number">1</span><br>  select_type: SIMPLE<br>        <span class="hljs-keyword">table</span>: rental<br>   partitions: <span class="hljs-keyword">NULL</span><br>         type: <span class="hljs-keyword">ref</span><br>possible_keys: rental_date<br>          key: rental_date<br>      key_len: <span class="hljs-number">5</span><br>          <span class="hljs-keyword">ref</span>: const<br>         <span class="hljs-keyword">rows</span>: <span class="hljs-number">1</span><br>     filtered: <span class="hljs-number">100.00</span><br>        Extra: <span class="hljs-keyword">Using</span> index <span class="hljs-keyword">condition</span><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.00</span> sec)<br><span class="hljs-comment">--order by子句不满足索引的最左前缀的要求，也可以用于查询排序，这是因为所以你的第一列被指定为一个常数</span><br><br><span class="hljs-comment">--该查询为索引的第一列提供了常量条件，而使用第二列进行排序，将两个列组合在一起，就形成了索引的最左前缀</span><br>explain <span class="hljs-keyword">select</span> rental_id,staff_id <span class="hljs-keyword">from</span> rental <span class="hljs-keyword">where</span> rental_date<span class="hljs-operator">=</span><span class="hljs-string">&#x27;2005-05-25&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> inventory_id <span class="hljs-keyword">desc</span>\G<br><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span> <span class="hljs-number">1.</span> <span class="hljs-type">row</span> <span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><br>           id: <span class="hljs-number">1</span><br>  select_type: SIMPLE<br>        <span class="hljs-keyword">table</span>: rental<br>   partitions: <span class="hljs-keyword">NULL</span><br>         type: <span class="hljs-keyword">ref</span><br>possible_keys: rental_date<br>          key: rental_date<br>      key_len: <span class="hljs-number">5</span><br>          <span class="hljs-keyword">ref</span>: const<br>         <span class="hljs-keyword">rows</span>: <span class="hljs-number">1</span><br>     filtered: <span class="hljs-number">100.00</span><br>        Extra: <span class="hljs-keyword">Using</span> <span class="hljs-keyword">where</span><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.00</span> sec)<br><br><span class="hljs-comment">--下面的查询不会利用索引</span><br>explain <span class="hljs-keyword">select</span> rental_id,staff_id <span class="hljs-keyword">from</span> rental <span class="hljs-keyword">where</span> rental_date<span class="hljs-operator">&gt;</span><span class="hljs-string">&#x27;2005-05-25&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> rental_date,inventory_id\G<br><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span> <span class="hljs-number">1.</span> <span class="hljs-type">row</span> <span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><br>           id: <span class="hljs-number">1</span><br>  select_type: SIMPLE<br>        <span class="hljs-keyword">table</span>: rental<br>   partitions: <span class="hljs-keyword">NULL</span><br>         type: <span class="hljs-keyword">ALL</span><br>possible_keys: rental_date<br>          key: <span class="hljs-keyword">NULL</span><br>      key_len: <span class="hljs-keyword">NULL</span><br>          <span class="hljs-keyword">ref</span>: <span class="hljs-keyword">NULL</span><br>         <span class="hljs-keyword">rows</span>: <span class="hljs-number">16005</span><br>     filtered: <span class="hljs-number">50.00</span><br>        Extra: <span class="hljs-keyword">Using</span> <span class="hljs-keyword">where</span>; <span class="hljs-keyword">Using</span> filesort<br><br><span class="hljs-comment">--该查询使用了两中不同的排序方向，但是索引列都是正序排序的</span><br>explain <span class="hljs-keyword">select</span> rental_id,staff_id <span class="hljs-keyword">from</span> rental <span class="hljs-keyword">where</span> rental_date<span class="hljs-operator">&gt;</span><span class="hljs-string">&#x27;2005-05-25&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> inventory_id <span class="hljs-keyword">desc</span>,customer_id <span class="hljs-keyword">asc</span>\G<br><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span> <span class="hljs-number">1.</span> <span class="hljs-type">row</span> <span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><br>           id: <span class="hljs-number">1</span><br>  select_type: SIMPLE<br>        <span class="hljs-keyword">table</span>: rental<br>   partitions: <span class="hljs-keyword">NULL</span><br>         type: <span class="hljs-keyword">ALL</span><br>possible_keys: rental_date<br>          key: <span class="hljs-keyword">NULL</span><br>      key_len: <span class="hljs-keyword">NULL</span><br>          <span class="hljs-keyword">ref</span>: <span class="hljs-keyword">NULL</span><br>         <span class="hljs-keyword">rows</span>: <span class="hljs-number">16005</span><br>     filtered: <span class="hljs-number">50.00</span><br>        Extra: <span class="hljs-keyword">Using</span> <span class="hljs-keyword">where</span>; <span class="hljs-keyword">Using</span> filesort<br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.00</span> sec)<br><br><span class="hljs-comment">--该查询中引用了一个不再索引中的列</span><br>explain <span class="hljs-keyword">select</span> rental_id,staff_id <span class="hljs-keyword">from</span> rental <span class="hljs-keyword">where</span> rental_date<span class="hljs-operator">&gt;</span><span class="hljs-string">&#x27;2005-05-25&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> inventory_id,staff_id\G<br><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span> <span class="hljs-number">1.</span> <span class="hljs-type">row</span> <span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><br>           id: <span class="hljs-number">1</span><br>  select_type: SIMPLE<br>        <span class="hljs-keyword">table</span>: rental<br>   partitions: <span class="hljs-keyword">NULL</span><br>         type: <span class="hljs-keyword">ALL</span><br>possible_keys: rental_date<br>          key: <span class="hljs-keyword">NULL</span><br>      key_len: <span class="hljs-keyword">NULL</span><br>          <span class="hljs-keyword">ref</span>: <span class="hljs-keyword">NULL</span><br>         <span class="hljs-keyword">rows</span>: <span class="hljs-number">16005</span><br>     filtered: <span class="hljs-number">50.00</span><br>        Extra: <span class="hljs-keyword">Using</span> <span class="hljs-keyword">where</span>; <span class="hljs-keyword">Using</span> filesort<br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.00</span> sec)<br></code></pre></td></tr></table></figure><p>5.union all,in,or都能够使用索引，但是推荐使用in</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> actor <span class="hljs-keyword">where</span> actor_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> actor <span class="hljs-keyword">where</span> actor_id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> actor <span class="hljs-keyword">where</span> actor_id <span class="hljs-keyword">in</span> (<span class="hljs-number">1</span>,<span class="hljs-number">2</span>);<br><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> actor <span class="hljs-keyword">where</span> actor_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> actor_id <span class="hljs-operator">=</span><span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure><p>6.范围列可以用到索引</p><p>范围条件是：&lt;、&gt;</p><p>范围列可以用到索引，但是范围列后面的列无法用到索引，索引最多用于一个范围列</p><p>7.强制类型转换会全表扫描</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span>(id <span class="hljs-type">int</span>,name <span class="hljs-type">varchar</span>(<span class="hljs-number">10</span>),phone <span class="hljs-type">varchar</span>(<span class="hljs-number">11</span>));<br><br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">add</span> index idx_1(phone);<br><br><span class="hljs-comment">-- 不会触发索引</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">where</span> phone<span class="hljs-operator">=</span><span class="hljs-number">13800001234</span>;<br><br><span class="hljs-comment">-- 触发索引</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">where</span> phone<span class="hljs-operator">=</span><span class="hljs-string">&#x27;13800001234&#x27;</span>;<br></code></pre></td></tr></table></figure><p>8.更新十分频繁，数据区分度不高的字段上不宜建立索引</p><p>更新会变更B+树，更新频繁的字段建议索引会大大降低数据库性能</p><p>类似于性别这类区分不大的属性，建立索引是没有意义的，不能有效的过滤数据，</p><p>一般区分度在80%以上的时候就可以建立索引，区分度可以使用 count(distinct(列名))&#x2F;count(*) 来计算</p><p>9.创建索引的列，不允许为null，可能会得到不符合预期的结果</p><p>10.当需要进行表连接的时候，最好不要超过三张表，因为需要join的字段，数据类型必须一致</p><p>11.能使用limit的时候尽量使用limit</p><p>12.单表索引建议控制在5个以内</p><p>13.单索引字段数不允许超过5个（组合索引）</p><p>14.创建索引的时候应该避免以下错误概念</p><p>索引越多越好</p><p>过早优化，在不了解系统的情况下进行优化</p><h2 id="索引监控"><a href="#索引监控" class="headerlink" title="索引监控"></a>索引监控</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> status <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;Handler_read%&#x27;</span>;<br></code></pre></td></tr></table></figure><p>参数解释:</p><p>Handler_read_first：读取索引第一个条目的次数</p><p>Handler_read_key：通过index获取数据的次数</p><p>Handler_read_last：读取索引最后一个条目的次数</p><p>Handler_read_next：通过索引读取下一条数据的次数</p><p>Handler_read_prev：通过索引读取上一条数据的次数</p><p>Handler_read_rnd：从固定位置读取数据的次数</p><p>Handler_read_rnd_next：从数据节点读取下一条数据的次数</p><h2 id="索引优化测试"><a href="#索引优化测试" class="headerlink" title="索引优化测试"></a>索引优化测试</h2><p>预先准备好数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS<span class="hljs-operator">=</span><span class="hljs-number">0</span>;<br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `itdragon_order_list`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `itdragon_order_list` (<br>  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;主键id，默认自增长&#x27;</span>,<br>  `transaction_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">150</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;交易号&#x27;</span>,<br>  `gross` <span class="hljs-keyword">double</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;毛收入(RMB)&#x27;</span>,<br>  `net` <span class="hljs-keyword">double</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;净收入(RMB)&#x27;</span>,<br>  `stock_id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;发货仓库&#x27;</span>,<br>  `order_status` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单状态&#x27;</span>,<br>  `descript` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;客服备注&#x27;</span>,<br>  `finance_descript` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;财务备注&#x27;</span>,<br>  `create_type` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;创建类型&#x27;</span>,<br>  `order_level` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单级别&#x27;</span>,<br>  `input_user` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;录入人&#x27;</span>,<br>  `input_date` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;录入时间&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">10003</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> itdragon_order_list <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;10000&#x27;</span>, <span class="hljs-string">&#x27;81X97310V32236260E&#x27;</span>, <span class="hljs-string">&#x27;6.6&#x27;</span>, <span class="hljs-string">&#x27;6.13&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;10&#x27;</span>, <span class="hljs-string">&#x27;ok&#x27;</span>, <span class="hljs-string">&#x27;ok&#x27;</span>, <span class="hljs-string">&#x27;auto&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;itdragon&#x27;</span>, <span class="hljs-string">&#x27;2017-08-28 17:01:49&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> itdragon_order_list <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;10001&#x27;</span>, <span class="hljs-string">&#x27;61525478BB371361Q&#x27;</span>, <span class="hljs-string">&#x27;18.88&#x27;</span>, <span class="hljs-string">&#x27;18.79&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;10&#x27;</span>, <span class="hljs-string">&#x27;ok&#x27;</span>, <span class="hljs-string">&#x27;ok&#x27;</span>, <span class="hljs-string">&#x27;auto&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;itdragon&#x27;</span>, <span class="hljs-string">&#x27;2017-08-18 17:01:50&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> itdragon_order_list <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;10002&#x27;</span>, <span class="hljs-string">&#x27;5RT64180WE555861V&#x27;</span>, <span class="hljs-string">&#x27;20.18&#x27;</span>, <span class="hljs-string">&#x27;20.17&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;10&#x27;</span>, <span class="hljs-string">&#x27;ok&#x27;</span>, <span class="hljs-string">&#x27;ok&#x27;</span>, <span class="hljs-string">&#x27;auto&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;itdragon&#x27;</span>, <span class="hljs-string">&#x27;2017-09-08 17:01:49&#x27;</span>);<br><br></code></pre></td></tr></table></figure><p>逐步开始进行优化：</p><p>第一个案例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> itdragon_order_list <span class="hljs-keyword">where</span> transaction_id <span class="hljs-operator">=</span> &quot;81X97310V32236260E&quot;;<br><span class="hljs-comment">--通过查看执行计划发现type=all,需要进行全表扫描</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> itdragon_order_list <span class="hljs-keyword">where</span> transaction_id <span class="hljs-operator">=</span> &quot;81X97310V32236260E&quot;;<br><br><span class="hljs-comment">--优化一、为transaction_id创建唯一索引</span><br> <span class="hljs-keyword">create</span> <span class="hljs-keyword">unique</span> index idx_order_transaID <span class="hljs-keyword">on</span> itdragon_order_list (transaction_id);<br><span class="hljs-comment">--当创建索引之后，唯一索引对应的type是const，通过索引一次就可以找到结果，普通索引对应的type是ref，表示非唯一性索引赛秒，找到值还要进行扫描，直到将索引文件扫描完为止，显而易见，const的性能要高于ref</span><br> explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> itdragon_order_list <span class="hljs-keyword">where</span> transaction_id <span class="hljs-operator">=</span> &quot;81X97310V32236260E&quot;;<br> <br> <span class="hljs-comment">--优化二、使用覆盖索引，查询的结果变成 transaction_id,当extra出现using index,表示使用了覆盖索引</span><br> explain <span class="hljs-keyword">select</span> transaction_id <span class="hljs-keyword">from</span> itdragon_order_list <span class="hljs-keyword">where</span> transaction_id <span class="hljs-operator">=</span> &quot;81X97310V32236260E&quot;;<br></code></pre></td></tr></table></figure><p>第二个案例</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--创建复合索引</span><br><span class="hljs-keyword">create</span> index idx_order_levelDate <span class="hljs-keyword">on</span> itdragon_order_list (order_level,input_date);<br><br><span class="hljs-comment">--创建索引之后发现跟没有创建索引一样，都是全表扫描，都是文件排序</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> itdragon_order_list <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> order_level,input_date;<br><br><span class="hljs-comment">--可以使用force index强制指定索引</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> itdragon_order_list force index(idx_order_levelDate) <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> order_level,input_date;<br><span class="hljs-comment">--其实给订单排序意义不大，给订单级别添加索引意义也不大，因此可以先确定order_level的值，然后再给input_date排序</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> itdragon_order_list <span class="hljs-keyword">where</span> order_level<span class="hljs-operator">=</span><span class="hljs-number">3</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> input_date;<br></code></pre></td></tr></table></figure><h1 id="分区表"><a href="#分区表" class="headerlink" title="分区表"></a>分区表</h1><h2 id="分区表的应用场景"><a href="#分区表的应用场景" class="headerlink" title="分区表的应用场景"></a>分区表的应用场景</h2><p>1.表非常大以至于无法全部都放在内存中，或者只在表的最后部分有热点数据，其他均是历史数据</p><p>2.分区表的数据更容易维护：</p><p>​批量删除大量数据可以使用清除整个分区的方式</p><p>​对一个独立分区进行优化、检查、修复等操作</p><p>3.分区表的数据可以分布在不同的物理设备上，从而高效地利用多个硬件设备</p><p>4.可以使用分区表来避免某些特殊的瓶颈</p><p>​innodb的单个索引的互斥访问</p><p>​ext3文件系统的inode锁竞争</p><p>5.可以备份和恢复独立的分区</p><h2 id="分区表的限制"><a href="#分区表的限制" class="headerlink" title="分区表的限制"></a>分区表的限制</h2><p>一个表最多只能有1024个分区，在5.7版本的时候可以支持8196个分区</p><p>在早期的mysql中，分区表达式必须是整数或者是返回整数的表达式，在mysql5.5中，某些场景可以直接使用列来进行分区</p><p>如果分区字段中有主键或者唯一索引的列，那么所有主键列和唯一索引列都必须包含进来</p><p>分区表无法使用外键约束</p><h2 id="分区表的原理"><a href="#分区表的原理" class="headerlink" title="分区表的原理"></a>分区表的原理</h2><p>​分区表由多个相关的底层表实现，这个底层表也是由句柄对象标识，我们可以直接访问各个分区。存储引擎管理分区的各个底层表和管理普通表一样（所有的底层表都必须使用相同的存储引擎），分区表的索引知识在各个底层表上各自加上一个完全相同的索引。从存储引擎的角度来看，底层表和普通表没有任何不同，存储引擎也无须知道这是一个普通表还是一个分区表的一部分。</p><p>​分区表的操作按照以下的操作逻辑进行：</p><p>​<strong>select查询</strong></p><p>​当查询一个分区表的时候，分区层先打开并锁住所有的底层表，优化器先判断是否可以过滤部分分区，然后再调用对应的存储引擎接口访问各个分区的数据</p><p>​<strong>insert操作</strong></p><p>​当写入一条记录的时候，分区层先打开并锁住所有的底层表，然后确定哪个分区接受这条记录，再将记录写入对应底层表</p><p>​<strong>delete操作</strong></p><p>​当删除一条记录时，分区层先打开并锁住所有的底层表，然后确定数据对应的分区，最后对相应底层表进行删除操作</p><p>​<strong>update操作</strong></p><p>​当更新一条记录时，分区层先打开并锁住所有的底层表，mysql先确定需要更新的记录再哪个分区，然后取出数据并更新，再判断更新后的数据应该再哪个分区，最后对底层表进行写入操作，并对源数据所在的底层表进行删除操作</p><p>​有些操作时支持过滤的，例如，当删除一条记录时，MySQL需要先找到这条记录，如果where条件恰好和分区表达式匹配，就可以将所有不包含这条记录的分区都过滤掉，这对update同样有效。如果是insert操作，则本身就是只命中一个分区，其他分区都会被过滤掉。mysql先确定这条记录属于哪个分区，再将记录写入对应得曾分区表，无须对任何其他分区进行操作</p><p>​虽然每个操作都会“先打开并锁住所有的底层表”，但这并不是说分区表在处理过程中是锁住全表的，如果存储引擎能够自己实现行级锁，例如innodb，则会在分区层释放对应表锁。</p><h2 id="分区表的类型"><a href="#分区表的类型" class="headerlink" title="分区表的类型"></a>分区表的类型</h2><p>范围分区:</p><p>根据列值在给定范围内将行分配给分区</p><p>范围分区表的分区方式是：每个分区都包含行数据且分区的表达式在给定的范围内，分区的范围应该是连续的且不能重叠，可以使用values less than运算符来定义。</p><p>​1、创建普通的表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> employees (<br>    id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    fname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br>    lname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br>    hired <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1970-01-01&#x27;</span>,<br>    separated <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;9999-12-31&#x27;</span>,<br>    job_code <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    store_id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br>);<br></code></pre></td></tr></table></figure><p>​2、创建带分区的表，下面建表的语句是按照store_id来进行分区的，指定了4个分区</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> employees (<br>    id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    fname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br>    lname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br>    hired <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1970-01-01&#x27;</span>,<br>    separated <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;9999-12-31&#x27;</span>,<br>    job_code <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    store_id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br>)<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> (store_id) (<br>    <span class="hljs-keyword">PARTITION</span> p0 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">6</span>),<br>    <span class="hljs-keyword">PARTITION</span> p1 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">11</span>),<br>    <span class="hljs-keyword">PARTITION</span> p2 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">16</span>),<br>    <span class="hljs-keyword">PARTITION</span> p3 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">21</span>)<br>);<br><span class="hljs-comment">--在当前的建表语句中可以看到，store_id的值在1-5的在p0分区，6-10的在p1分区，11-15的在p3分区，16-20的在p4分区，但是如果插入超过20的值就会报错，因为mysql不知道将数据放在哪个分区</span><br></code></pre></td></tr></table></figure><p>​3、可以使用less than maxvalue来避免此种情况</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> employees (<br>    id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    fname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br>    lname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br>    hired <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1970-01-01&#x27;</span>,<br>    separated <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;9999-12-31&#x27;</span>,<br>    job_code <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    store_id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br>)<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> (store_id) (<br>    <span class="hljs-keyword">PARTITION</span> p0 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">6</span>),<br>    <span class="hljs-keyword">PARTITION</span> p1 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">11</span>),<br>    <span class="hljs-keyword">PARTITION</span> p2 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">16</span>),<br>    <span class="hljs-keyword">PARTITION</span> p3 <span class="hljs-keyword">VALUES</span> LESS THAN MAXVALUE<br>);<br><span class="hljs-comment">--maxvalue表示始终大于等于最大可能整数值的整数值</span><br></code></pre></td></tr></table></figure><p>​4、可以使用相同的方式根据员工的职务代码对表进行分区</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> employees (<br>    id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    fname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br>    lname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br>    hired <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1970-01-01&#x27;</span>,<br>    separated <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;9999-12-31&#x27;</span>,<br>    job_code <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    store_id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br>)<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> (job_code) (<br>    <span class="hljs-keyword">PARTITION</span> p0 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">100</span>),<br>    <span class="hljs-keyword">PARTITION</span> p1 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">1000</span>),<br>    <span class="hljs-keyword">PARTITION</span> p2 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">10000</span>)<br>);<br></code></pre></td></tr></table></figure><p>​5、可以使用date类型进行分区：如虚妄根据每个员工离开公司的年份进行划分，如year(separated)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> employees (<br>    id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    fname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br>    lname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br>    hired <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1970-01-01&#x27;</span>,<br>    separated <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;9999-12-31&#x27;</span>,<br>    job_code <span class="hljs-type">INT</span>,<br>    store_id <span class="hljs-type">INT</span><br>)<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> ( <span class="hljs-keyword">YEAR</span>(separated) ) (<br>    <span class="hljs-keyword">PARTITION</span> p0 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">1991</span>),<br>    <span class="hljs-keyword">PARTITION</span> p1 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">1996</span>),<br>    <span class="hljs-keyword">PARTITION</span> p2 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">2001</span>),<br>    <span class="hljs-keyword">PARTITION</span> p3 <span class="hljs-keyword">VALUES</span> LESS THAN MAXVALUE<br>);<br></code></pre></td></tr></table></figure><p>​6、可以使用函数根据range的值来对表进行分区，如timestampunix_timestamp()</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> quarterly_report_status (<br>    report_id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    report_status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    report_updated <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span><br>)<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> ( UNIX_TIMESTAMP(report_updated) ) (<br>    <span class="hljs-keyword">PARTITION</span> p0 <span class="hljs-keyword">VALUES</span> LESS THAN ( UNIX_TIMESTAMP(<span class="hljs-string">&#x27;2008-01-01 00:00:00&#x27;</span>) ),<br>    <span class="hljs-keyword">PARTITION</span> p1 <span class="hljs-keyword">VALUES</span> LESS THAN ( UNIX_TIMESTAMP(<span class="hljs-string">&#x27;2008-04-01 00:00:00&#x27;</span>) ),<br>    <span class="hljs-keyword">PARTITION</span> p2 <span class="hljs-keyword">VALUES</span> LESS THAN ( UNIX_TIMESTAMP(<span class="hljs-string">&#x27;2008-07-01 00:00:00&#x27;</span>) ),<br>    <span class="hljs-keyword">PARTITION</span> p3 <span class="hljs-keyword">VALUES</span> LESS THAN ( UNIX_TIMESTAMP(<span class="hljs-string">&#x27;2008-10-01 00:00:00&#x27;</span>) ),<br>    <span class="hljs-keyword">PARTITION</span> p4 <span class="hljs-keyword">VALUES</span> LESS THAN ( UNIX_TIMESTAMP(<span class="hljs-string">&#x27;2009-01-01 00:00:00&#x27;</span>) ),<br>    <span class="hljs-keyword">PARTITION</span> p5 <span class="hljs-keyword">VALUES</span> LESS THAN ( UNIX_TIMESTAMP(<span class="hljs-string">&#x27;2009-04-01 00:00:00&#x27;</span>) ),<br>    <span class="hljs-keyword">PARTITION</span> p6 <span class="hljs-keyword">VALUES</span> LESS THAN ( UNIX_TIMESTAMP(<span class="hljs-string">&#x27;2009-07-01 00:00:00&#x27;</span>) ),<br>    <span class="hljs-keyword">PARTITION</span> p7 <span class="hljs-keyword">VALUES</span> LESS THAN ( UNIX_TIMESTAMP(<span class="hljs-string">&#x27;2009-10-01 00:00:00&#x27;</span>) ),<br>    <span class="hljs-keyword">PARTITION</span> p8 <span class="hljs-keyword">VALUES</span> LESS THAN ( UNIX_TIMESTAMP(<span class="hljs-string">&#x27;2010-01-01 00:00:00&#x27;</span>) ),<br>    <span class="hljs-keyword">PARTITION</span> p9 <span class="hljs-keyword">VALUES</span> LESS THAN (MAXVALUE)<br>);<br><span class="hljs-comment">--timestamp不允许使用任何其他涉及值的表达式</span><br></code></pre></td></tr></table></figure><p>基于时间间隔的分区方案，在mysql5.7中，可以基于范围或事件间隔实现分区方案，有两种选择</p><p>1、基于范围的分区，对于分区表达式，可以使用操作函数基于date、time、或者datatime列来返回一个整数值</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> members (<br>    firstname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">25</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    lastname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">25</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">35</span>),<br>    joined <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br>)<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span>( <span class="hljs-keyword">YEAR</span>(joined) ) (<br>    <span class="hljs-keyword">PARTITION</span> p0 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">1960</span>),<br>    <span class="hljs-keyword">PARTITION</span> p1 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">1970</span>),<br>    <span class="hljs-keyword">PARTITION</span> p2 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">1980</span>),<br>    <span class="hljs-keyword">PARTITION</span> p3 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">1990</span>),<br>    <span class="hljs-keyword">PARTITION</span> p4 <span class="hljs-keyword">VALUES</span> LESS THAN MAXVALUE<br>);<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> quarterly_report_status (<br>    report_id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    report_status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    report_updated <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span><br>)<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> ( UNIX_TIMESTAMP(report_updated) ) (<br>    <span class="hljs-keyword">PARTITION</span> p0 <span class="hljs-keyword">VALUES</span> LESS THAN ( UNIX_TIMESTAMP(<span class="hljs-string">&#x27;2008-01-01 00:00:00&#x27;</span>) ),<br>    <span class="hljs-keyword">PARTITION</span> p1 <span class="hljs-keyword">VALUES</span> LESS THAN ( UNIX_TIMESTAMP(<span class="hljs-string">&#x27;2008-04-01 00:00:00&#x27;</span>) ),<br>    <span class="hljs-keyword">PARTITION</span> p2 <span class="hljs-keyword">VALUES</span> LESS THAN ( UNIX_TIMESTAMP(<span class="hljs-string">&#x27;2008-07-01 00:00:00&#x27;</span>) ),<br>    <span class="hljs-keyword">PARTITION</span> p3 <span class="hljs-keyword">VALUES</span> LESS THAN ( UNIX_TIMESTAMP(<span class="hljs-string">&#x27;2008-10-01 00:00:00&#x27;</span>) ),<br>    <span class="hljs-keyword">PARTITION</span> p4 <span class="hljs-keyword">VALUES</span> LESS THAN ( UNIX_TIMESTAMP(<span class="hljs-string">&#x27;2009-01-01 00:00:00&#x27;</span>) ),<br>    <span class="hljs-keyword">PARTITION</span> p5 <span class="hljs-keyword">VALUES</span> LESS THAN ( UNIX_TIMESTAMP(<span class="hljs-string">&#x27;2009-04-01 00:00:00&#x27;</span>) ),<br>    <span class="hljs-keyword">PARTITION</span> p6 <span class="hljs-keyword">VALUES</span> LESS THAN ( UNIX_TIMESTAMP(<span class="hljs-string">&#x27;2009-07-01 00:00:00&#x27;</span>) ),<br>    <span class="hljs-keyword">PARTITION</span> p7 <span class="hljs-keyword">VALUES</span> LESS THAN ( UNIX_TIMESTAMP(<span class="hljs-string">&#x27;2009-10-01 00:00:00&#x27;</span>) ),<br>    <span class="hljs-keyword">PARTITION</span> p8 <span class="hljs-keyword">VALUES</span> LESS THAN ( UNIX_TIMESTAMP(<span class="hljs-string">&#x27;2010-01-01 00:00:00&#x27;</span>) ),<br>    <span class="hljs-keyword">PARTITION</span> p9 <span class="hljs-keyword">VALUES</span> LESS THAN (MAXVALUE)<br>);<br></code></pre></td></tr></table></figure><p>2、基于范围列的分区，使用date或者datatime列作为分区列</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> members (<br>    firstname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">25</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    lastname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">25</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">35</span>),<br>    joined <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br>)<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> COLUMNS(joined) (<br>    <span class="hljs-keyword">PARTITION</span> p0 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-string">&#x27;1960-01-01&#x27;</span>),<br>    <span class="hljs-keyword">PARTITION</span> p1 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-string">&#x27;1970-01-01&#x27;</span>),<br>    <span class="hljs-keyword">PARTITION</span> p2 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-string">&#x27;1980-01-01&#x27;</span>),<br>    <span class="hljs-keyword">PARTITION</span> p3 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-string">&#x27;1990-01-01&#x27;</span>),<br>    <span class="hljs-keyword">PARTITION</span> p4 <span class="hljs-keyword">VALUES</span> LESS THAN MAXVALUE<br>);<br></code></pre></td></tr></table></figure><p>真实案例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs sql">#不分区的表<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> no_part_tab<br>(id <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>remark <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>d_date <span class="hljs-type">DATE</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span><br>)ENGINE<span class="hljs-operator">=</span>MYISAM;<br>#分区的表<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> part_tab<br>(id <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>remark <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>d_date <span class="hljs-type">DATE</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span><br>)ENGINE<span class="hljs-operator">=</span>MYISAM<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span>(<span class="hljs-keyword">YEAR</span>(d_date))(<br><span class="hljs-keyword">PARTITION</span> p0 <span class="hljs-keyword">VALUES</span> LESS THAN(<span class="hljs-number">1995</span>),<br><span class="hljs-keyword">PARTITION</span> p1 <span class="hljs-keyword">VALUES</span> LESS THAN(<span class="hljs-number">1996</span>),<br><span class="hljs-keyword">PARTITION</span> p2 <span class="hljs-keyword">VALUES</span> LESS THAN(<span class="hljs-number">1997</span>),<br><span class="hljs-keyword">PARTITION</span> p3 <span class="hljs-keyword">VALUES</span> LESS THAN(<span class="hljs-number">1998</span>),<br><span class="hljs-keyword">PARTITION</span> p4 <span class="hljs-keyword">VALUES</span> LESS THAN(<span class="hljs-number">1999</span>),<br><span class="hljs-keyword">PARTITION</span> p5 <span class="hljs-keyword">VALUES</span> LESS THAN(<span class="hljs-number">2000</span>),<br><span class="hljs-keyword">PARTITION</span> p6 <span class="hljs-keyword">VALUES</span> LESS THAN(<span class="hljs-number">2001</span>),<br><span class="hljs-keyword">PARTITION</span> p7 <span class="hljs-keyword">VALUES</span> LESS THAN(<span class="hljs-number">2002</span>),<br><span class="hljs-keyword">PARTITION</span> p8 <span class="hljs-keyword">VALUES</span> LESS THAN(<span class="hljs-number">2003</span>),<br><span class="hljs-keyword">PARTITION</span> p9 <span class="hljs-keyword">VALUES</span> LESS THAN(<span class="hljs-number">2004</span>),<br><span class="hljs-keyword">PARTITION</span> p10 <span class="hljs-keyword">VALUES</span> LESS THAN maxvalue);<br>#插入未分区表记录<br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">PROCEDURE</span> IF <span class="hljs-keyword">EXISTS</span> no_load_part;<br> <br><br>DELIMITER<span class="hljs-operator">/</span><span class="hljs-operator">/</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> no_load_part()<br><span class="hljs-keyword">BEGIN</span><br>    <span class="hljs-keyword">DECLARE</span> i <span class="hljs-type">INT</span>;<br>    <span class="hljs-keyword">SET</span> i <span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br>    WHILE i<span class="hljs-operator">&lt;</span><span class="hljs-number">80001</span><br>    DO<br>    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> no_part_tab <span class="hljs-keyword">VALUES</span>(i,<span class="hljs-string">&#x27;no&#x27;</span>,ADDDATE(<span class="hljs-string">&#x27;1995-01-01&#x27;</span>,(RAND(i)<span class="hljs-operator">*</span><span class="hljs-number">36520</span>) MOD <span class="hljs-number">3652</span>));<br>    <span class="hljs-keyword">SET</span> i<span class="hljs-operator">=</span>i<span class="hljs-operator">+</span><span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">END</span> WHILE;<br><span class="hljs-keyword">END</span><span class="hljs-operator">/</span><span class="hljs-operator">/</span><br>DELIMITER ;<br> <br><span class="hljs-keyword">CALL</span> no_load_part;<br>#插入分区表记录<br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">PROCEDURE</span> IF <span class="hljs-keyword">EXISTS</span> load_part;<br> <br>DELIMITER<span class="hljs-operator">&amp;&amp;</span> <br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> load_part()<br><span class="hljs-keyword">BEGIN</span><br>    <span class="hljs-keyword">DECLARE</span> i <span class="hljs-type">INT</span>;<br>    <span class="hljs-keyword">SET</span> i<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br>    WHILE i<span class="hljs-operator">&lt;</span><span class="hljs-number">80001</span><br>    DO<br>    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> part_tab <span class="hljs-keyword">VALUES</span>(i,<span class="hljs-string">&#x27;partition&#x27;</span>,ADDDATE(<span class="hljs-string">&#x27;1995-01-01&#x27;</span>,(RAND(i)<span class="hljs-operator">*</span><span class="hljs-number">36520</span>) MOD <span class="hljs-number">3652</span>));<br>    <span class="hljs-keyword">SET</span> i<span class="hljs-operator">=</span>i<span class="hljs-operator">+</span><span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">END</span> WHILE;<br><span class="hljs-keyword">END</span><span class="hljs-operator">&amp;&amp;</span><br>DELIMITER ;<br> <br><span class="hljs-keyword">CALL</span> load_part;<br></code></pre></td></tr></table></figure><p>列表分区:</p><p>类似于按range分区，区别在于list分区是基于列值匹配一个离散值集合中的某个值来进行选择</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> employees (<br> id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br> fname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br> lname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br> hired <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1970-01-01&#x27;</span>,<br> separated <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;9999-12-31&#x27;</span>,<br> job_code <span class="hljs-type">INT</span>,<br> store_id <span class="hljs-type">INT</span><br>)<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> LIST(store_id) (<br> <span class="hljs-keyword">PARTITION</span> pNorth <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">IN</span> (<span class="hljs-number">3</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">9</span>,<span class="hljs-number">17</span>),<br> <span class="hljs-keyword">PARTITION</span> pEast <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">19</span>,<span class="hljs-number">20</span>),<br> <span class="hljs-keyword">PARTITION</span> pWest <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">IN</span> (<span class="hljs-number">4</span>,<span class="hljs-number">12</span>,<span class="hljs-number">13</span>,<span class="hljs-number">14</span>,<span class="hljs-number">18</span>),<br> <span class="hljs-keyword">PARTITION</span> pCentral <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">IN</span> (<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">15</span>,<span class="hljs-number">16</span>)<br>);<br></code></pre></td></tr></table></figure><p>列分区:</p><p>mysql从5.5开始支持column分区，可以认为i是range和list的升级版，在5.5之后，可以使用column分区替代range和list，但是column分区只接受普通列不接受表达式</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `list_c` (<br> `c1` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br> `c2` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span><br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>latin1<br><span class="hljs-comment">/*!50500 PARTITION BY RANGE COLUMNS(c1)</span><br><span class="hljs-comment">(PARTITION p0 VALUES LESS THAN (5) ENGINE = InnoDB,</span><br><span class="hljs-comment"> PARTITION p1 VALUES LESS THAN (10) ENGINE = InnoDB) */</span><br><br> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `list_c` (<br> `c1` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br> `c2` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br> `c3` <span class="hljs-type">char</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span><br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>latin1<br><span class="hljs-comment">/*!50500 PARTITION BY RANGE COLUMNS(c1,c3)</span><br><span class="hljs-comment">(PARTITION p0 VALUES LESS THAN (5,&#x27;aaa&#x27;) ENGINE = InnoDB,</span><br><span class="hljs-comment"> PARTITION p1 VALUES LESS THAN (10,&#x27;bbb&#x27;) ENGINE = InnoDB) */</span><br><br> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `list_c` (<br> `c1` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br> `c2` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br> `c3` <span class="hljs-type">char</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span><br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>latin1<br><span class="hljs-comment">/*!50500 PARTITION BY LIST COLUMNS(c3)</span><br><span class="hljs-comment">(PARTITION p0 VALUES IN (&#x27;aaa&#x27;) ENGINE = InnoDB,</span><br><span class="hljs-comment"> PARTITION p1 VALUES IN (&#x27;bbb&#x27;) ENGINE = InnoDB) */</span><br></code></pre></td></tr></table></figure><p>hash分区:</p><p>基于用户定义的表达式的返回值来进行选择的分区，该表达式使用将要插入到表中的这些行的列值进行计算。这个函数可以包含myql中有效的、产生非负整数值的任何表达式</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> employees (<br>    id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    fname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br>    lname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br>    hired <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1970-01-01&#x27;</span>,<br>    separated <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;9999-12-31&#x27;</span>,<br>    job_code <span class="hljs-type">INT</span>,<br>    store_id <span class="hljs-type">INT</span><br>)<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> HASH(store_id)<br>PARTITIONS <span class="hljs-number">4</span>;<br><br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> employees (<br>    id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    fname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br>    lname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br>    hired <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1970-01-01&#x27;</span>,<br>    separated <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;9999-12-31&#x27;</span>,<br>    job_code <span class="hljs-type">INT</span>,<br>    store_id <span class="hljs-type">INT</span><br>)<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> LINEAR HASH(<span class="hljs-keyword">YEAR</span>(hired))<br>PARTITIONS <span class="hljs-number">4</span>;<br></code></pre></td></tr></table></figure><p>key分区:</p><p>类似于hash分区，区别在于key分区只支持一列或多列，且mysql服务器提供其自身的哈希函数，必须有一列或多列包含整数值</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tk (<br>    col1 <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    col2 <span class="hljs-type">CHAR</span>(<span class="hljs-number">5</span>),<br>    col3 <span class="hljs-type">DATE</span><br>)<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> LINEAR KEY (col1)<br>PARTITIONS <span class="hljs-number">3</span>;<br></code></pre></td></tr></table></figure><p>子分区:</p><p>在分区的基础之上，再进行分区后存储</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t_partition_by_subpart`<br>(<br>  `id` <span class="hljs-type">INT</span> AUTO_INCREMENT,<br>  `sName` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `sAge` <span class="hljs-type">INT</span>(<span class="hljs-number">2</span>) UNSIGNED ZEROFILL <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `sAddr` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `sGrade` <span class="hljs-type">INT</span>(<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `sStuId` <span class="hljs-type">INT</span>(<span class="hljs-number">8</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `sSex` <span class="hljs-type">INT</span>(<span class="hljs-number">1</span>) UNSIGNED <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`, `sGrade`)<br>)  ENGINE <span class="hljs-operator">=</span> INNODB<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span>(id)<br>SUBPARTITION <span class="hljs-keyword">BY</span> HASH(sGrade) SUBPARTITIONS <span class="hljs-number">2</span><br>(<br><span class="hljs-keyword">PARTITION</span> p0 <span class="hljs-keyword">VALUES</span> LESS THAN(<span class="hljs-number">5</span>),<br><span class="hljs-keyword">PARTITION</span> p1 <span class="hljs-keyword">VALUES</span> LESS THAN(<span class="hljs-number">10</span>),<br><span class="hljs-keyword">PARTITION</span> p2 <span class="hljs-keyword">VALUES</span> LESS THAN(<span class="hljs-number">15</span>)<br>);<br></code></pre></td></tr></table></figure><h2 id="如何使用分区表"><a href="#如何使用分区表" class="headerlink" title="如何使用分区表"></a>如何使用分区表</h2><p>如果需要从非常大的表中查询出某一段时间的记录，而这张表中包含很多年的历史数据，数据是按照时间排序的，此时应该如何查询数据呢？<br>因为数据量巨大，肯定不能在每次查询的时候都扫描全表。考虑到索引在空间和维护上的消耗，也不希望使用索引，即使使用索引，会发现会产生大量的碎片，还会产生大量的随机IO，但是当数据量超大的时候，索引也就无法起作用了，此时可以考虑使用分区来进行解决</p><h3 id="全量扫描数据，不要任何索引"><a href="#全量扫描数据，不要任何索引" class="headerlink" title="全量扫描数据，不要任何索引"></a>全量扫描数据，不要任何索引</h3><p>使用简单的分区方式存放表，不要任何索引，根据分区规则大致定位需要的数据为止，通过使用where条件将需要的数据限制在少数分区中，这种策略适用于以正常的方式访问大量数据</p><h3 id="索引数据，并分离热点"><a href="#索引数据，并分离热点" class="headerlink" title="索引数据，并分离热点"></a>索引数据，并分离热点</h3><p>如果数据有明显的热点，而且除了这部分数据，其他数据很少被访问到，那么可以将这部分热点数据单独放在一个分区中，让这个分区的数据能够有机会都缓存在内存中，这样查询就可以只访问一个很小的分区表，能够使用索引，也能够有效的使用缓存</p><h2 id="在使用分区表的时候需要注意的问题"><a href="#在使用分区表的时候需要注意的问题" class="headerlink" title="在使用分区表的时候需要注意的问题"></a>在使用分区表的时候需要注意的问题</h2><p>null值会使分区过滤无效</p><p>分区列和索引列不匹配，会导致查询无法进行分区过滤</p><p>选择分区的成本可能很高</p><p>打开并锁住所有底层表的成本可能很高</p><p>维护分区的成本可能很高</p><h1 id="集群化"><a href="#集群化" class="headerlink" title="集群化"></a>集群化</h1><p>主从复制</p><p>读写分离</p><p>分库分表</p>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>shiro实践</title>
    <link href="/2022/05/18/%E6%9D%83%E9%99%90%E6%A1%86%E6%9E%B6/shiro%E5%AE%9E%E8%B7%B5/"/>
    <url>/2022/05/18/%E6%9D%83%E9%99%90%E6%A1%86%E6%9E%B6/shiro%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h2 id="实践这几张图"><a href="#实践这几张图" class="headerlink" title="实践这几张图"></a>实践这几张图</h2><p>能实现的功能有哪些：</p><p><img src="/.com//ShiroFeatures.png" alt="ShiroFeatures"></p><p>具体的架构图：</p><p><img src="/.com//ShiroBasicArchitecture.png" alt="ShiroBasicArchitecture"></p><p><img src="/.com//ShiroArchitecture.png" alt="ShiroArchitecture"></p><h2 id="官网找例子"><a href="#官网找例子" class="headerlink" title="官网找例子"></a>官网找例子</h2><p><a href="https://shiro.apache.org/">https://shiro.apache.org/</a> </p><p>Integrations  - spring</p><p>页面中有连接是连接到github。</p><p><a href="https://github.com/apache/shiro/tree/main/samples">https://github.com/apache/shiro/tree/main/samples</a></p><p>这是官方提供的例子。</p><h2 id="main方法使用"><a href="#main方法使用" class="headerlink" title="main方法使用"></a>main方法使用</h2><p>参考 <a href="https://github.com/apache/shiro/blob/main/samples/quickstart">https://github.com/apache/shiro/blob/main/samples/quickstart</a></p><p>创建maven项目：</p><p>加入依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>创建shiro.ini</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># =============================================================================</span><br><span class="hljs-comment"># Quickstart INI Realm configuration</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># For those that might not understand the references in this file, the</span><br><span class="hljs-comment"># definitions are all based on the classic Mel Brooks&#x27; film &quot;Spaceballs&quot;. ;)</span><br><span class="hljs-comment"># =============================================================================</span><br><br><span class="hljs-comment"># -----------------------------------------------------------------------------</span><br><span class="hljs-comment"># Users and their assigned roles</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Each line conforms to the format defined in the</span><br><span class="hljs-comment"># org.apache.shiro.realm.text.TextConfigurationRealm#setUserDefinitions JavaDoc</span><br><span class="hljs-comment"># -----------------------------------------------------------------------------</span><br><span class="hljs-section">[users]</span><br><span class="hljs-comment"># user &#x27;root&#x27; with password &#x27;secret&#x27; and the &#x27;admin&#x27; role</span><br><span class="hljs-attr">root</span> = secret, admin<br><span class="hljs-comment"># user &#x27;guest&#x27; with the password &#x27;guest&#x27; and the &#x27;guest&#x27; role</span><br><span class="hljs-attr">guest</span> = guest, guest<br><span class="hljs-comment"># user &#x27;presidentskroob&#x27; with password &#x27;12345&#x27; (&quot;That&#x27;s the same combination on</span><br><span class="hljs-comment"># my luggage!!!&quot; ;)), and role &#x27;president&#x27;</span><br><span class="hljs-attr">presidentskroob</span> = <span class="hljs-number">12345</span>, president<br><span class="hljs-comment"># user &#x27;darkhelmet&#x27; with password &#x27;ludicrousspeed&#x27; and roles &#x27;darklord&#x27; and &#x27;schwartz&#x27;</span><br><span class="hljs-attr">darkhelmet</span> = ludicrousspeed, darklord, schwartz<br><span class="hljs-comment"># user &#x27;lonestarr&#x27; with password &#x27;vespa&#x27; and roles &#x27;goodguy&#x27; and &#x27;schwartz&#x27;</span><br><span class="hljs-attr">lonestarr</span> = vespa, goodguy, schwartz<br><br><span class="hljs-comment"># -----------------------------------------------------------------------------</span><br><span class="hljs-comment"># Roles with assigned permissions</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Each line conforms to the format defined in the</span><br><span class="hljs-comment"># org.apache.shiro.realm.text.TextConfigurationRealm#setRoleDefinitions JavaDoc</span><br><span class="hljs-comment"># -----------------------------------------------------------------------------</span><br><span class="hljs-section">[roles]</span><br><span class="hljs-comment"># &#x27;admin&#x27; role has all permissions, indicated by the wildcard &#x27;*&#x27;</span><br><span class="hljs-attr">admin</span> = *<br><span class="hljs-comment"># The &#x27;schwartz&#x27; role can do anything (*) with any lightsaber:</span><br><span class="hljs-attr">schwartz</span> = lightsaber:*<br><span class="hljs-comment"># The &#x27;goodguy&#x27; role is allowed to &#x27;drive&#x27; (action) the winnebago (type) with</span><br><span class="hljs-comment"># license plate &#x27;eagle5&#x27; (instance specific id)</span><br><span class="hljs-attr">goodguy</span> = winnebago:drive:eagle5<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.shiro.SecurityUtils;<br><span class="hljs-keyword">import</span> org.apache.shiro.authc.*;<br><span class="hljs-keyword">import</span> org.apache.shiro.config.IniSecurityManagerFactory;<br><span class="hljs-keyword">import</span> org.apache.shiro.mgt.SecurityManager;<br><span class="hljs-keyword">import</span> org.apache.shiro.session.Session;<br><span class="hljs-keyword">import</span> org.apache.shiro.subject.Subject;<br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Simple Quickstart application showing how to use Shiro&#x27;s API.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 0.9 RC2</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Quickstart</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">transient</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(Quickstart.class);<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">// The easiest way to create a Shiro SecurityManager with configured</span><br>        <span class="hljs-comment">// realms, users, roles and permissions is to use the simple INI config.</span><br>        <span class="hljs-comment">// We&#x27;ll do that by using a factory that can ingest a .ini file and</span><br>        <span class="hljs-comment">// return a SecurityManager instance:</span><br><br>        <span class="hljs-comment">// Use the shiro.ini file at the root of the classpath</span><br>        <span class="hljs-comment">// (file: and url: prefixes load from files and urls respectively):</span><br>        <span class="hljs-type">IniSecurityManagerFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IniSecurityManagerFactory</span>(<span class="hljs-string">&quot;classpath:shiro.ini&quot;</span>);<br>        <span class="hljs-type">SecurityManager</span> <span class="hljs-variable">securityManager</span> <span class="hljs-operator">=</span> factory.getInstance();<br><br>        <span class="hljs-comment">// for this simple example quickstart, make the SecurityManager</span><br>        <span class="hljs-comment">// accessible as a JVM singleton.  Most applications wouldn&#x27;t do this</span><br>        <span class="hljs-comment">// and instead rely on their container configuration or web.xml for</span><br>        <span class="hljs-comment">// webapps.  That is outside the scope of this simple quickstart, so</span><br>        <span class="hljs-comment">// we&#x27;ll just do the bare minimum so you can continue to get a feel</span><br>        <span class="hljs-comment">// for things.</span><br>        SecurityUtils.setSecurityManager(securityManager);<br><br>        <span class="hljs-comment">// Now that a simple Shiro environment is set up, let&#x27;s see what you can do:</span><br><br>        <span class="hljs-comment">// get the currently executing user:</span><br>        <span class="hljs-type">Subject</span> <span class="hljs-variable">currentUser</span> <span class="hljs-operator">=</span> SecurityUtils.getSubject();<br><br>        <span class="hljs-comment">// Do some stuff with a Session (no need for a web or EJB container!!!)</span><br>        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> currentUser.getSession();<br>        session.setAttribute(<span class="hljs-string">&quot;someKey&quot;</span>, <span class="hljs-string">&quot;aValue&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (String) session.getAttribute(<span class="hljs-string">&quot;someKey&quot;</span>);<br>        <span class="hljs-keyword">if</span> (value.equals(<span class="hljs-string">&quot;aValue&quot;</span>)) &#123;<br>            log.info(<span class="hljs-string">&quot;检测到正确的值! [&quot;</span> + value + <span class="hljs-string">&quot;]&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// let&#x27;s login the current user so we can check against roles and permissions:</span><br>        <span class="hljs-keyword">if</span> (!currentUser.isAuthenticated()) &#123;<br>            <span class="hljs-type">UsernamePasswordToken</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordToken</span>(<span class="hljs-string">&quot;lonestarr&quot;</span>, <span class="hljs-string">&quot;vespa&quot;</span>);<br>            token.setRememberMe(<span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                currentUser.login(token);<br>            &#125; <span class="hljs-keyword">catch</span> (UnknownAccountException uae) &#123;<br>                log.info(<span class="hljs-string">&quot;没有用户名为 &quot;</span> + token.getPrincipal());<br>            &#125; <span class="hljs-keyword">catch</span> (IncorrectCredentialsException ice) &#123;<br>                log.info(<span class="hljs-string">&quot;密码对于账户 &quot;</span> + token.getPrincipal() + <span class="hljs-string">&quot; 不正确!&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (LockedAccountException lae) &#123;<br>                log.info(<span class="hljs-string">&quot;账户 &quot;</span> + token.getPrincipal() + <span class="hljs-string">&quot; 被锁定 &quot;</span> +<br>                        <span class="hljs-string">&quot;请联系管理员解锁.&quot;</span>);<br>            &#125;<br>            <span class="hljs-comment">// ... catch more exceptions here (maybe custom ones specific to your application?</span><br>            <span class="hljs-keyword">catch</span> (AuthenticationException ae) &#123;<br>                <span class="hljs-comment">//unexpected condition?  error?</span><br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//say who they are:</span><br>        <span class="hljs-comment">//print their identifying principal (in this case, a username):</span><br>        log.info(<span class="hljs-string">&quot;User [&quot;</span> + currentUser.getPrincipal() + <span class="hljs-string">&quot;] 登录成功.&quot;</span>);<br><br>        <span class="hljs-comment">//test a role:</span><br>        <span class="hljs-keyword">if</span> (currentUser.hasRole(<span class="hljs-string">&quot;schwartz&quot;</span>)) &#123;<br>            log.info(<span class="hljs-string">&quot;拥有schwartz角色!&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            log.info(<span class="hljs-string">&quot;没有schwartz角色.&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//test a typed permission (not instance-level)</span><br>        <span class="hljs-keyword">if</span> (currentUser.isPermitted(<span class="hljs-string">&quot;lightsaber:wield&quot;</span>)) &#123;<br>            log.info(<span class="hljs-string">&quot;拥有lightsaber:wield权限 .&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            log.info(<span class="hljs-string">&quot;没有lightsaber:wield权限&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//a (very powerful) Instance Level permission:</span><br>        <span class="hljs-keyword">if</span> (currentUser.isPermitted(<span class="hljs-string">&quot;winnebago:drive:eagle5&quot;</span>)) &#123;<br>            log.info(<span class="hljs-string">&quot;拥有winnebago:drive:eagle5权限&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            log.info(<span class="hljs-string">&quot;没有winnebago:drive:eagle5权限&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//all done - log out!</span><br>        currentUser.logout();<br><br>        System.exit(<span class="hljs-number">0</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>currentUser.login(token);  是 Authenticator, 完成认证</p><p>currentUser.isPermitted(“winnebago:drive:eagle5”)  是Authorizer， 是查看是否有权限</p><h2 id="spring-boot-使用shiro-无页面"><a href="#spring-boot-使用shiro-无页面" class="headerlink" title="spring boot 使用shiro(无页面)"></a>spring boot 使用shiro(无页面)</h2><p>加入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.24<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>domain类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 用户</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br><br>    <span class="hljs-keyword">private</span> String username;<br><br>    <span class="hljs-keyword">private</span> String password;<br><br>    <span class="hljs-keyword">private</span> Date createTime;<br><br>    <span class="hljs-keyword">private</span> String salt;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 角色集合</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> List&lt;Role&gt; roleList;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 角色</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Role</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">private</span> String description;<br><br>    <span class="hljs-keyword">private</span> List&lt;Permission&gt; permissionList;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 权限</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Permission</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">private</span> String url;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findAllUserInfoByUsername</span><span class="hljs-params">(String username)</span> &#123;<br><br>        <span class="hljs-comment">//业务方法里面加缓存，也可以</span><br><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>        user.setUsername(<span class="hljs-string">&quot;test1&quot;</span>);<br>        user.setPassword(<span class="hljs-string">&quot;123456&quot;</span>);<br><br>        <span class="hljs-comment">//用户的角色集合</span><br>        List&lt;Role&gt; roleList =  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-type">Role</span> <span class="hljs-variable">role1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Role</span>();<br>        role1.setName(<span class="hljs-string">&quot;role1&quot;</span>);<br>        List&lt;Permission&gt; permissionList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-type">Permission</span> <span class="hljs-variable">permission1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Permission</span>();<br>        permission1.setName(<span class="hljs-string">&quot;permission1&quot;</span>);<br>        permission1.setUrl(<span class="hljs-string">&quot;/add&quot;</span>);<br>        permissionList.add(permission1);<br>        role1.setPermissionList(permissionList);<br>        roleList.add(role1);<br><br>        user.setRoleList(roleList);<br><br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findSimpleUserInfoByUsername</span><span class="hljs-params">(String username)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>        user.setUsername(<span class="hljs-string">&quot;test1&quot;</span>);<br>        user.setPassword(<span class="hljs-string">&quot;123456&quot;</span>);<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>因为自带的realm不好用,所以自定义realm,realm又是一个Authorizer(不能自动创建Authorizer)，所以需要手动创建SecurityManager</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义realm</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomRealm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AuthorizingRealm</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 进行权限校验的时候回调用</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> principals</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> AuthorizationInfo <span class="hljs-title function_">doGetAuthorizationInfo</span><span class="hljs-params">(PrincipalCollection principals)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;授权 doGetAuthorizationInfo&quot;</span>);<br><br>        <span class="hljs-type">User</span> <span class="hljs-variable">newUser</span> <span class="hljs-operator">=</span> (User)principals.getPrimaryPrincipal();<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findAllUserInfoByUsername(newUser.getUsername());<br><br>        List&lt;String&gt; stringRoleList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        List&lt;String&gt; stringPermissionList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br><br>        List&lt;Role&gt; roleList = user.getRoleList();<br><br>        <span class="hljs-keyword">for</span>(Role role : roleList)&#123;<br>            stringRoleList.add(role.getName());<br><br>            List&lt;Permission&gt; permissionList = role.getPermissionList();<br><br>            <span class="hljs-keyword">for</span>(Permission p: permissionList)&#123;<br>                <span class="hljs-keyword">if</span>(p!=<span class="hljs-literal">null</span>)&#123;<br>                    stringPermissionList.add(p.getName());<br>                &#125;<br>            &#125;<br><br>        &#125;<br><br>        <span class="hljs-type">SimpleAuthorizationInfo</span> <span class="hljs-variable">simpleAuthorizationInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleAuthorizationInfo</span>();<br>        simpleAuthorizationInfo.addRoles(stringRoleList);<br>        simpleAuthorizationInfo.addStringPermissions(stringPermissionList);<br><br>        <span class="hljs-keyword">return</span> simpleAuthorizationInfo;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户登录的时候会调用</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> token</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> AuthenticationException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> AuthenticationInfo <span class="hljs-title function_">doGetAuthenticationInfo</span><span class="hljs-params">(AuthenticationToken token)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br><br>        System.out.println(<span class="hljs-string">&quot;认证 doGetAuthenticationInfo&quot;</span>);<br><br>        <span class="hljs-comment">//从token获取用户信息，token代表用户输入</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> (String)token.getPrincipal();<br><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span>  userService.findAllUserInfoByUsername(username);<br><br>        <span class="hljs-comment">//取密码</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">pwd</span> <span class="hljs-operator">=</span> user.getPassword();<br>        <span class="hljs-keyword">if</span>(pwd == <span class="hljs-literal">null</span> || <span class="hljs-string">&quot;&quot;</span>.equals(pwd))&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleAuthenticationInfo</span>(user, user.getPassword(), <span class="hljs-built_in">this</span>.getClass().getName());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShiroConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> CustomRealm <span class="hljs-title function_">customRealm</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomRealm</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DefaultWebSecurityManager <span class="hljs-title function_">getSecurityManager</span><span class="hljs-params">(CustomRealm customRealm)</span>&#123;<br>        <span class="hljs-type">DefaultWebSecurityManager</span> <span class="hljs-variable">securityManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultWebSecurityManager</span>();<br>        securityManager.setRealm(customRealm);<br>        <span class="hljs-keyword">return</span> securityManager;<br>    &#125;<br><br><br>    <span class="hljs-meta">@Bean(name = &quot;shiroFilterFactoryBean&quot;)</span><br>    <span class="hljs-keyword">public</span> ShiroFilterFactoryBean <span class="hljs-title function_">shiroFilter</span><span class="hljs-params">(SecurityManager securityManager)</span>&#123;<br><br>        System.out.println(<span class="hljs-string">&quot;执行 ShiroFilterFactoryBean.shiroFilter()&quot;</span>);<br><br>        <span class="hljs-type">ShiroFilterFactoryBean</span> <span class="hljs-variable">shiroFilterFactoryBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShiroFilterFactoryBean</span>();<br><br>        <span class="hljs-comment">//必须设置securityManager</span><br>        shiroFilterFactoryBean.setSecurityManager(securityManager);<br><br><br>        <span class="hljs-comment">//需要登录的接口，如果访问某个接口，需要登录却没登录，则调用此接口(如果不是前后端分离，则跳转页面)</span><br>        shiroFilterFactoryBean.setLoginUrl(<span class="hljs-string">&quot;/pub/need_login&quot;</span>);<br><br>        <span class="hljs-comment">//登录成功，跳转url，如果前后端分离，则没这个调用</span><br>        shiroFilterFactoryBean.setSuccessUrl(<span class="hljs-string">&quot;/&quot;</span>);<br><br>        <span class="hljs-comment">//没有权限，未授权就会调用此方法， 先验证登录-》再验证是否有权限</span><br>        shiroFilterFactoryBean.setUnauthorizedUrl(<span class="hljs-string">&quot;/pub/not_permit&quot;</span>);<br><br><br>        <span class="hljs-comment">//拦截器路径，坑一，部分路径无法进行拦截，时有时无；因为同学使用的是hashmap, 无序的，应该改为LinkedHashMap</span><br>        Map&lt;String, String&gt; filterChainDefinitionMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();<br><br>        <span class="hljs-comment">//退出过滤器</span><br>        filterChainDefinitionMap.put(<span class="hljs-string">&quot;/logout&quot;</span>,<span class="hljs-string">&quot;logout&quot;</span>);<br><br>        <span class="hljs-comment">//匿名可以访问，也是就游客模式</span><br>        filterChainDefinitionMap.put(<span class="hljs-string">&quot;/pub/**&quot;</span>,<span class="hljs-string">&quot;anon&quot;</span>);<br><br>        <span class="hljs-comment">//登录用户才可以访问</span><br>        filterChainDefinitionMap.put(<span class="hljs-string">&quot;/authc/**&quot;</span>,<span class="hljs-string">&quot;authc&quot;</span>);<br><br>        <span class="hljs-comment">//坑二: 过滤链是顺序执行，从上而下，一般讲/** 放到最下面</span><br><br>        <span class="hljs-comment">//authc : url定义必须通过认证才可以访问</span><br>        <span class="hljs-comment">//anon  : url可以匿名访问</span><br>        filterChainDefinitionMap.put(<span class="hljs-string">&quot;/**&quot;</span>, <span class="hljs-string">&quot;authc&quot;</span>);<br><br>        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);<br><br>        <span class="hljs-keyword">return</span> shiroFilterFactoryBean;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>创建测试controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;pub&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PublicController</span> &#123;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 登录接口</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> user</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping(&quot;login&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user, HttpServletRequest request, HttpServletResponse response)</span>&#123;<br><br>        <span class="hljs-type">Subject</span> <span class="hljs-variable">subject</span> <span class="hljs-operator">=</span> SecurityUtils.getSubject();<br>        Map&lt;String,Object&gt; info = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">UsernamePasswordToken</span> <span class="hljs-variable">usernamePasswordToken</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordToken</span>(user.getUsername(), user.getPassword());<br><br>            subject.login(usernamePasswordToken);<br><br>            info.put(<span class="hljs-string">&quot;msg&quot;</span>,<span class="hljs-string">&quot;登录成功&quot;</span>);<br>            info.put(<span class="hljs-string">&quot;session_id&quot;</span>, subject.getSession().getId());<br><br>            <span class="hljs-keyword">return</span> ResponseEntity.ok(info);<br><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            log.info(<span class="hljs-string">&quot;登录失败&quot;</span>, e);<br>            info.put(<span class="hljs-string">&quot;msg&quot;</span>,<span class="hljs-string">&quot;账号或者密码错误&quot;</span>);<br>            <span class="hljs-keyword">return</span> ResponseEntity.ok(<span class="hljs-string">&quot;账号或者密码错误&quot;</span>);<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;need_login&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title function_">needLogin</span><span class="hljs-params">()</span>&#123;<br>        Map&lt;String,Object&gt; info = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        info.put(<span class="hljs-string">&quot;msg&quot;</span>,<span class="hljs-string">&quot;请登录&quot;</span>);<br>        <span class="hljs-keyword">return</span> ResponseEntity.ok(info);<br>    &#125;<br><br><br>    <span class="hljs-meta">@RequestMapping(&quot;not_permit&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title function_">notPermit</span><span class="hljs-params">()</span>&#123;<br>        Map&lt;String,Object&gt; info = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        info.put(<span class="hljs-string">&quot;msg&quot;</span>,<span class="hljs-string">&quot;没权限&quot;</span>);<br>        <span class="hljs-keyword">return</span> ResponseEntity.ok(info);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;private&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrivateController</span> &#123;<br><br><br>    <span class="hljs-meta">@RequestMapping(&quot;list&quot;)</span><br>    <span class="hljs-meta">@RequiresRoles(&quot;role1&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title function_">list</span><span class="hljs-params">()</span>&#123;<br><br>        List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        list.add(<span class="hljs-string">&quot;list1&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;list2&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;list3&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> ResponseEntity.ok(list);<br><br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;list2&quot;)</span><br>    <span class="hljs-meta">@RequiresPermissions(&quot;permission2&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title function_">list2</span><span class="hljs-params">()</span>&#123;<br><br>        List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        list.add(<span class="hljs-string">&quot;list1&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;list2&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;list3&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> ResponseEntity.ok(list);<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>这时直接访问<a href="http://localhost:8080/private/list%E4%BC%9A%E8%B7%B3%E8%BD%AC%E5%88%B0%E7%99%BB%E5%BD%95%E6%8E%A5%E5%8F%A3%E8%BF%94%E5%9B%9E">http://localhost:8080/private/list会跳转到登录接口返回</a>  请登录</p><p><a href="http://localhost:8080/pub/login">http://localhost:8080/pub/login</a>   </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;test1&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;123456&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>登录 再访问，可以正常返回。</p><p>到这里已经实现了  Authentication、 Authorization </p><p>现在使用的密码还是明文密码要改成密文。使用的SimpleCredentialsMatcher。</p><p>默认 Session Management 是  new DefaultWebSecurityManager()  中的new ServletContainerSessionManager() 这个是使用的tomcat的session。</p><p>new CustomRealm()  时调用父类时，CacheManager cacheManager传的是空，没有启用。</p><h3 id="Credentials-Matcher-凭据匹配器"><a href="#Credentials-Matcher-凭据匹配器" class="headerlink" title="Credentials Matcher  凭据匹配器"></a>Credentials Matcher  凭据匹配器</h3><p>在shrioConfig中添加</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> HashedCredentialsMatcher <span class="hljs-title function_">hashedCredentialsMatcher</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">HashedCredentialsMatcher</span> <span class="hljs-variable">hashedCredentialsMatcher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashedCredentialsMatcher</span>();<br><br>    <span class="hljs-comment">//散列算法，使用MD5算法;</span><br>    hashedCredentialsMatcher.setHashAlgorithmName(<span class="hljs-string">&quot;md5&quot;</span>);<br><br>    <span class="hljs-comment">//散列的次数，比如散列两次，相当于 md5(md5(&quot;xxx&quot;));</span><br>    hashedCredentialsMatcher.setHashIterations(<span class="hljs-number">2</span>);<br><br>    <span class="hljs-keyword">return</span> hashedCredentialsMatcher;<br>&#125;<br></code></pre></td></tr></table></figure><p>修改实例realm的bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> CustomRealm <span class="hljs-title function_">customRealm</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">CustomRealm</span> <span class="hljs-variable">customRealm</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomRealm</span>();<br>    customRealm.setCredentialsMatcher(hashedCredentialsMatcher());<br>    <span class="hljs-keyword">return</span> customRealm;<br>&#125;<br></code></pre></td></tr></table></figure><p>这时再使用123456登录会提示账号或密码错误</p><p>把userService中的密码改为4280d89a5a03f812751f504cc10ee8a5    就可以登录成功。</p><h3 id="redis单机版-CacheManager"><a href="#redis单机版-CacheManager" class="headerlink" title="redis单机版 CacheManager"></a>redis单机版 CacheManager</h3><p>加入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- shiro+redis缓存插件 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.crazycake<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ShiroConfig加入</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 配置redisManager</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> RedisManager <span class="hljs-title function_">getRedisManager</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">RedisManager</span> <span class="hljs-variable">redisManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisManager</span>();<br>    redisManager.setHost(<span class="hljs-string">&quot;localhost&quot;</span>);<br>    redisManager.setPort(<span class="hljs-number">6379</span>);<br>    redisManager.setPassword(<span class="hljs-string">&quot;123456&quot;</span>);<br>    <span class="hljs-keyword">return</span> redisManager;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 配置具体cache实现类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> RedisCacheManager <span class="hljs-title function_">cacheManager</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">RedisCacheManager</span> <span class="hljs-variable">redisCacheManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisCacheManager</span>();<br>    redisCacheManager.setRedisManager(getRedisManager());<br>    <span class="hljs-comment">//设置过期时间，单位是秒，20s,</span><br>    redisCacheManager.setExpire(<span class="hljs-number">20</span>);<br><br>    <span class="hljs-keyword">return</span> redisCacheManager;<br>&#125;<br></code></pre></td></tr></table></figure><p>修改SecurityManager</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br>   <span class="hljs-keyword">public</span> DefaultWebSecurityManager <span class="hljs-title function_">getSecurityManager</span><span class="hljs-params">(CustomRealm customRealm)</span>&#123;<br>       <span class="hljs-type">DefaultWebSecurityManager</span> <span class="hljs-variable">securityManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultWebSecurityManager</span>();<br>       securityManager.setRealm(customRealm);<br>       securityManager.setCacheManager(cacheManager());<br>       <span class="hljs-keyword">return</span> securityManager;<br>   &#125;<br></code></pre></td></tr></table></figure><p>测试doGetAuthorizationInfo 接口就不在走了。</p><h3 id="Redis单机版-SessionManager"><a href="#Redis单机版-SessionManager" class="headerlink" title="Redis单机版 SessionManager"></a>Redis单机版 SessionManager</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义session持久化</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> RedisSessionDAO <span class="hljs-title function_">redisSessionDAO</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">RedisSessionDAO</span> <span class="hljs-variable">redisSessionDAO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisSessionDAO</span>();<br>    redisSessionDAO.setRedisManager(getRedisManager());<br>    <span class="hljs-keyword">return</span> redisSessionDAO;<br>&#125;<br><br><br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> DefaultWebSessionManager <span class="hljs-title function_">sessionManager</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">DefaultWebSessionManager</span> <span class="hljs-variable">defaultWebSessionManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultWebSessionManager</span>();<br>    defaultWebSessionManager.setSessionDAO(redisSessionDAO());<br>    <span class="hljs-keyword">return</span> defaultWebSessionManager;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> DefaultWebSecurityManager <span class="hljs-title function_">getSecurityManager</span><span class="hljs-params">(CustomRealm customRealm)</span>&#123;<br>    <span class="hljs-type">DefaultWebSecurityManager</span> <span class="hljs-variable">securityManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultWebSecurityManager</span>();<br>    securityManager.setSessionManager(sessionManager());<br>    securityManager.setCacheManager(cacheManager());<br>    securityManager.setRealm(customRealm);<br>    <span class="hljs-keyword">return</span> securityManager;<br>&#125;<br></code></pre></td></tr></table></figure><p>这时登录后，去redis里查看就可以看到shiro:session的key，说明使用redis做session管理成功。</p><h3 id="RememberMe-记住我"><a href="#RememberMe-记住我" class="headerlink" title="RememberMe 记住我"></a>RememberMe 记住我</h3><p>其实就是存的更久一点。设置cookies的过期时间长一点。如果有这个cookies就直接放行，表示登录成功。</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-number">1</span>、 Cookie 写到客户端并 保存<br> <span class="hljs-number">2</span>、 通过调用subject.login<span class="hljs-literal">()</span>前，设置 token.set<span class="hljs-constructor">RememberMe(<span class="hljs-params">true</span>)</span>;<br> <span class="hljs-number">3</span>、 关闭浏览器再重新打开;会发现浏览器还是记住你的<br> <span class="hljs-number">4</span>、 注意点：<br>   - subject.is<span class="hljs-constructor">Authenticated()</span> 表示用户进行了身份验证登录的，即<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Subject</span>.</span></span>login 进行了登录<br>   - subject.is<span class="hljs-constructor">Remembered()</span> 表示用户是通过RememberMe登录的<br>   - subject.is<span class="hljs-constructor">Authenticated()</span>==<span class="hljs-literal">true</span>，则 subject.is<span class="hljs-constructor">Remembered()</span>==<span class="hljs-literal">false</span>， 两个互斥<br>   - 总结：特殊页面或者API调用才需要authc进行验证拦截，该拦截器会判断用户是否是通过 subject.login<span class="hljs-literal">()</span>登录，安全性更高，其他非核心接口或者页面则通过user拦截器处理即可<br></code></pre></td></tr></table></figure><h3 id="退出"><a href="#退出" class="headerlink" title="退出"></a>退出</h3><p>方法一：</p><p>在shiro的filter中添加：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">filterChainDefinitionMap.put(<span class="hljs-string">&quot;/logout&quot;</span>,<span class="hljs-string">&quot;logout&quot;</span>);<br></code></pre></td></tr></table></figure><p>方法二：</p><p>添加退出接口</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><br>@RequestMapping(<span class="hljs-string">&quot;/logout&quot;</span>)<br>public ResponseEntity <span class="hljs-function"><span class="hljs-title">findMyPlayRecord</span></span>()&#123;<br><br>    Subject subject = SecurityUtils.getSubject();<br><br>    SecurityUtils.getSubject().<span class="hljs-built_in">logout</span>();<br><br>    <span class="hljs-built_in">return</span> ResponseEntity.ok(<span class="hljs-string">&quot;logout成功&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>shiro</category>
      
    </categories>
    
    
    <tags>
      
      <tag>shiro</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>redis6.0安装</title>
    <link href="/2022/05/17/redis/redis%E5%AE%89%E8%A3%85/"/>
    <url>/2022/05/17/redis/redis%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h2 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">wget http://download.redis.io/releases/redis-6.0.6.tar.gz<br>tar xzf redis-6.0.6.tar.gz<br><span class="hljs-built_in">mv</span> redis-6.0.6 /usr/local/redis<br></code></pre></td></tr></table></figure><p>安装编译时需要的软件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum -y install gcc automake autoconf libtool make<br></code></pre></td></tr></table></figure><p>安装gcc</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 注意不要直接编译，要先升级gcc</span><br><span class="hljs-comment"># 安装scl源</span><br>yum -y install centos-release-scl<br><span class="hljs-comment"># 安装9版本的gcc gcc-c++ gdb工具连接</span><br>yum -y install devtoolset-9-gcc devtoolset-9-gcc-c++ devtoolset-9-binutils<br><br><span class="hljs-comment">#临时有效，退出 shell 或重启会恢复原 gcc 版本</span><br>scl <span class="hljs-built_in">enable</span> devtoolset-9 bash<br><br><span class="hljs-comment">#长期有效</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;source /opt/rh/devtoolset-9/enable&quot;</span> &gt;&gt;/etc/profile<br><span class="hljs-built_in">source</span> /etc/profile<br></code></pre></td></tr></table></figure><p>安装atomic库</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 查看系统中是否有libatomic.so这个类库</span><br>find / -name <span class="hljs-string">&quot;libatomic.so*&quot;</span><br><br><span class="hljs-comment"># 没有就直接用yum安装即可</span><br> yum -y install *atomic* --skip-broken<br></code></pre></td></tr></table></figure><p>编译：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">make<br>make install PREFIX=/usr/local/redis<br></code></pre></td></tr></table></figure><p>前台运行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">./bin/redis-server redis.conf<br></code></pre></td></tr></table></figure><p>后台运行配置：修改redis.conf中daemonize no改为daemonize yes</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">daemonize <span class="hljs-built_in">yes</span><br></code></pre></td></tr></table></figure><p>注释bind 127.0.0.1</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#bind 127.0.0.1</span><br></code></pre></td></tr></table></figure><p>保护模式关闭</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">protected-mode no<br></code></pre></td></tr></table></figure><p>添加linux服务</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 在系统服务里创建redis.service文件</span><br>vi /etc/systemd/system/redis.service<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 在redis.service中写入如下内容</span><br>[Unit]<br>Description=redis-server<br>After=network.target<br><br>[Service]<br>Type=forking<br>ExecStart=/usr/local/redis/bin/redis-server /usr/local/redis/redis.conf<br>PrivateTmp=<span class="hljs-literal">true</span><br><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure><p>命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 重载系统服务</span><br>systemctl daemon-reload<br><br><span class="hljs-comment"># 停止服务</span><br>systemctl stop redis.service<br><br><span class="hljs-comment"># 启动服务</span><br>systemctl start redis.service<br><br><span class="hljs-comment"># 查看状态</span><br>systemctl status redis.service<br><br><span class="hljs-comment"># 重启</span><br>systemctl restart redis.service<br><br><span class="hljs-comment"># 开机自启</span><br>systemctl <span class="hljs-built_in">enable</span> redis.service<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>redis所在服务器被当为肉鸡</title>
    <link href="/2022/05/17/redis/redis%E6%89%80%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A2%AB%E5%BD%93%E4%B8%BA%E8%82%89%E9%B8%A1/"/>
    <url>/2022/05/17/redis/redis%E6%89%80%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A2%AB%E5%BD%93%E4%B8%BA%E8%82%89%E9%B8%A1/</url>
    
    <content type="html"><![CDATA[<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.csdn.net/zjcjava/article/details/78881803">https://blog.csdn.net/zjcjava/article/details/78881803</a></p><p><a href="http://www.junww.com/server/2017/0612/238.html">http://www.junww.com/server/2017/0612/238.html</a></p><p><a href="https://www.cnblogs.com/ylong52/p/5665708.html">https://www.cnblogs.com/ylong52/p/5665708.html</a> </p>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>redis架构及为什么快</title>
    <link href="/2022/05/17/redis/redis%E6%9E%B6%E6%9E%84%E5%8F%8A%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BF%AB/"/>
    <url>/2022/05/17/redis/redis%E6%9E%B6%E6%9E%84%E5%8F%8A%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BF%AB/</url>
    
    <content type="html"><![CDATA[<h1 id="基于内存实现"><a href="#基于内存实现" class="headerlink" title="基于内存实现"></a>基于内存实现</h1><p>Redis的操作都是基于内存的，CPU不是 Redis性能瓶颈,，Redis的瓶颈是机器内存和网络带宽。<br>在计算机的世界中，CPU的速度是远大于内存的速度的，同时内存的速度也是远大于硬盘的速度。redis的操作都是基于内存的，绝大部分请求是纯粹的内存操作，非常迅速。</p><h1 id="单线程操作"><a href="#单线程操作" class="headerlink" title="单线程操作"></a>单线程操作</h1><p>使用单线程可以省去多线程时CPU上下文会切换的时间，也不用去考虑各种锁的问题，不存在加锁释放锁操作，没有死锁问题导致的性能消耗。对于内存系统来说，多次读写都是在一个CPU上，没有上下文切换效率就是最高的！既然单线程容易实现，而且 CPU 不会成为瓶颈，那就顺理成章的采用单线程的方案了<br>Redis 单线程指的是网络请求模块使用了一个线程，即一个线程处理所有网络请求，其他模块该使用多线程，仍会使用了多个线程。</p><h1 id="I-x2F-O-多路复用"><a href="#I-x2F-O-多路复用" class="headerlink" title="I&#x2F;O 多路复用"></a>I&#x2F;O 多路复用</h1><p>redis使用IO多路复用</p><p>Redis服务器是一个事件驱动程序，服务器需要处理以下两类事件：</p><p>文件事件：Redis服务端通过套接字与客户端(或其他Redis服务器)进行连接，而文件事件就是服务器对套接字操作的抽象。服务器与客户端(或者其他服务器)的通信会产生相应的文件事件，而服务器则通过监听并处理这些事件来完成一系列网络通信操作。<br>时间事件：Redis服务器中的一些操作(如serverCron)函数需要在给定的时间点执行，而时间事件就是服务器对这类定时操作的抽象。</p><h2 id="文件事件处理器"><a href="#文件事件处理器" class="headerlink" title="文件事件处理器"></a>文件事件处理器</h2><p>Redis基于 Reactor 模式开发了自己的网络事件处理器：这个处理器被称为文件事件处理器：</p><p>​1.文件事件处理器使用 I&#x2F;O 多路复用程序来同时监听多个套接字，并根据套接字目前执行的任务来为套接字关联不同的事件处理器。<br>​2.当被监听的套接字准备好执行连接应答(accept)、读取(read)、写入(write)、关闭(close)等操作时，与操作相对应的文件事件就会产生，这时文件事件处理器就会调用套接字之前关联好的事件处理器来处理这些事件。</p><p>下图展示了文件事件处理器的四个组成部分：套接字、I&#x2F;O多路复用程序、文件事件分派器(dispatcher)、事件处理器。<br><img src="/.com//redis_reactor.png" alt="redis_reactor"></p><p>文件事件是对套接字操作的抽象，每当一个套接字准备好执行连接应答、写入、读取、关闭等操作时，就会产生一个文件事件。因为一个服务器通常会连接多个套接字，所以多个文件事件有可能会并发地出现。<strong>I&#x2F;O 多路复用程序负责监听多个套接字，并向文件事件分派器传送那些产生了事件的套接字。</strong></p><p>Redis 的 I&#x2F;O多路复用程序总是会将所有产生事件的套接字都放到一个队列里面，然后通过这个队列，以有序、同步、每次一个套接字的方式向文件事件分派器传送套接字。当上一个套接字产生的事件被处理完毕之后，I&#x2F;O 多路复用程序才会继续向文件事件分派器传送下一个套接字。</p><p><img src="/.com//redis_reactor_%E9%98%9F%E5%88%97.png" alt="redis_reactor_队列"></p><p>Redis为文件事件处理器编写了多个处理器，这些事件处理器分别用于实现不同的网络通信需求：</p><p>1.为了对连接服务器的各个客户端进行应答，服务器要为监听套接字关联连接应答处理器；<br>2.为了接受客户端传来的命令请求，服务器要为客户端套接字关联命令请求处理器 ；<br>3.为了向客户端返回命令的执行结果，服务器要为客户端套接字关联命令回复处理器 ；<br>4.当主服务器和从服务器进行复制操作时，主从服务器都需要关联特别为复制功能编写的复制处理器。</p><ul><li><strong>连接应答处理器</strong>：用于处理客户端的连接请求；</li><li><strong>命令请求处理器</strong>：用于执行客户端传递过来的命令，比如常见的set、lpush等；</li><li><strong>命令回复处理器</strong>：用于返回客户端命令的执行结果，比如set、get等命令的结果；</li></ul><p>事件种类：</p><p>AE_READABLE：与两个事件处理器结合使用。<br>    当客户端连接服务器端时，服务器端会将连接应答处理器与socket的AE_READABLE事件关联起来；<br>    当客户端向服务端发送命令的时候，服务器端将命令请求处理器与AE_READABLE事件关联起来；<br>AE_WRITABLE：当服务端有数据需要回传给客户端时，服务端将命令回复处理器与socket的AE_WRITABLE事件关联起来。<br><img src="/.com//redis%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BA%A4%E4%BA%92%E8%BF%87%E7%A8%8B.png" alt="redis客户端与服务器交互过程"></p><h1 id="Redis的自定义协议"><a href="#Redis的自定义协议" class="headerlink" title="Redis的自定义协议"></a>Redis的自定义协议</h1><p>Redis客户端使用RESP（Redis的序列化协议）协议与Redis的服务器端进行通信。 它实现简单，解析快速并且人类可读。</p><p>RESP 支持以下数据类型：简单字符串、错误、整数、批量字符串和数组。</p><p>RESP 在 Redis 中用作请求-响应协议的方式如下：</p><p>客户端将命令作为批量字符串的 RESP 数组发送到 Redis 服务器。<br>服务器根据命令实现以其中一种 RESP 类型进行回复。<br>在 RESP 中，某些数据的类型取决于第一个字节：</p><p>对于简单字符串，回复的第一个字节是“+”<br>对于错误，回复的第一个字节是“-”<br>对于整数，回复的第一个字节是“:”<br>对于批量字符串，回复的第一个字节是“$”<br>对于数组，回复的第一个字节是“*”<br>此外，RESP 能够使用稍后指定的批量字符串或数组的特殊变体来表示 Null 值。在 RESP 中，协议的不同部分总是以“\r\n”（CRLF）终止。</p><h1 id="redis为什么快"><a href="#redis为什么快" class="headerlink" title="redis为什么快"></a>redis为什么快</h1><p>1.基于内存</p><p>2.高效的数据结构</p><p>3.高效的线程模型</p><p>4.redis自定义的协议</p>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>redis简介及使用</title>
    <link href="/2022/05/17/redis/redis%E7%AE%80%E4%BB%8B%E4%B8%8E%E4%BD%BF%E7%94%A8/"/>
    <url>/2022/05/17/redis/redis%E7%AE%80%E4%BB%8B%E4%B8%8E%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="什么是redis"><a href="#什么是redis" class="headerlink" title="什么是redis"></a>什么是redis</h1><p>redis基于键值对的缓存库.</p><p>Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作数据库、缓存和消息中间件。</p><p>它支持多 种类型的数据结构，如 字符串（strings）、散列（hashes）、 列表（lists）、 集合（sets）、 有序集合（sorted sets）与范围查询 ,bitmaps， hyperloglogs 和 地理空间（geospatial） 索引半径查询。 </p><p>Redis 内置了 复制（replication），LUA脚本（Lua scripting）， LRU驱动事件（LRU eviction），事务（transactions） 和不同级别的 磁盘持久化（persistence）， 并通过 Redis哨兵（Sentinel）和自动 分区（Cluster）提供高可用性（high availability）。</p><p><strong>业务端使用Redis降低后端MySQL负载</strong></p><h1 id="help使用"><a href="#help使用" class="headerlink" title="help使用"></a>help使用</h1><p>使用redis-cli命令登录后。</p><p>输入help</p><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">To get <span class="hljs-built_in">help</span> about Redis commands <span class="hljs-built_in">type</span>:<br>      <span class="hljs-string">&quot;help @&lt;group&gt;&quot;</span> to get a list of commands <span class="hljs-keyword">in</span> &lt;group&gt;<br>      <span class="hljs-string">&quot;help &lt;command&gt;&quot;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span> on &lt;<span class="hljs-built_in">command</span>&gt;<br>      <span class="hljs-string">&quot;help &lt;tab&gt;&quot;</span> to get a list of possible <span class="hljs-built_in">help</span> topics<br>      <span class="hljs-string">&quot;quit&quot;</span> to <span class="hljs-built_in">exit</span><br><br>To <span class="hljs-built_in">set</span> redis-cli preferences:<br>      <span class="hljs-string">&quot;:set hints&quot;</span> <span class="hljs-built_in">enable</span> online hints<br>      <span class="hljs-string">&quot;:set nohints&quot;</span> <span class="hljs-built_in">disable</span> online hints<br>Set your preferences <span class="hljs-keyword">in</span> ~/.redisclirc<br></code></pre></td></tr></table></figure><p>官网帮助：<a href="https://redis.io/docs/manual/cli/">https://redis.io/docs/manual/cli/</a></p><p><code>redis-cli</code>使用命令为大多数 Redis<a href="https://redis.io/commands">命令</a>提供在线帮助<code>HELP</code>。该命令可以以两种形式使用：</p><ul><li><div class="code-wrapper"><pre><code class="hljs">HELP @&lt;category&gt;</code></pre></div><p>显示有关给定类别的所有命令。类别是：</p><ul><li><code>@generic</code></li><li><code>@string</code></li><li><code>@list</code></li><li><code>@set</code></li><li><code>@sorted_set</code></li><li><code>@hash</code></li><li><code>@pubsub</code></li><li><code>@transactions</code></li><li><code>@connection</code></li><li><code>@server</code></li><li><code>@scripting</code></li><li><code>@hyperloglog</code></li><li><code>@cluster</code></li><li><code>@geo</code></li><li><code>@stream</code></li></ul></li><li><p><code>HELP &lt;commandname&gt;</code>显示作为参数给出的命令的特定帮助。</p></li></ul><p>help @generic 会显示一些基本的命令。</p><p>help @string 会显示string相关的命令。</p><p>以此类推。</p>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>redis底层数据结构</title>
    <link href="/2022/05/17/redis/redis%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    <url>/2022/05/17/redis/redis%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://blog.csdn.net/Me_xuan/article/details/124260839">https://blog.csdn.net/Me_xuan/article/details/124260839</a></p><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>redis是通过对象来表示存储的数据的，redis 也是键值对存储的方式，那么每存储一条数据，redis至少会生成2个对象，一个是redisObject，用来描述具体数据的类型的，比如用的是那种数据类型，底层用了哪种数据结构，还有一个对象就是具体存储的数据。 这个存储对象数据就是通过redisObject这个对象的指针来指引的。</p><h1 id="Redis为什么要使用2个对象？两个对象的好处"><a href="#Redis为什么要使用2个对象？两个对象的好处" class="headerlink" title="Redis为什么要使用2个对象？两个对象的好处"></a>Redis为什么要使用2个对象？两个对象的好处</h1><p>1.redis在执行命令的时候，就可以通过redisObject 的类型和编码来确定是否可以执行相应的命令，不用等操作具体的数据是才发现不行<br>2.针对不同的场景，可以为对象设置不同的数据结构，从而优化了对象在不同场景下的使用效率<br>3.可以基于redisObject中的refcount 引用计数进行内存回收机制，自动释放对象所占用的内存<br>4.可以让多个数据库来共享一个对象来节省空间<br>5.redis可以根据REDIS_LRU_BITS 记录最后一次访问时间，针对时间较长对象的进行删除</p><h1 id="redisObject对象解析"><a href="#redisObject对象解析" class="headerlink" title="redisObject对象解析"></a>redisObject对象解析</h1><p>redisObject结构</p><figure class="highlight c"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">redisObject</span>&#123;</span><br>    <span class="hljs-comment">//类型</span><br>    <span class="hljs-type">unsigned</span> type:<span class="hljs-number">4</span>;<br> <br>    <span class="hljs-comment">//编码</span><br>    <span class="hljs-type">unsigned</span> encoding:<span class="hljs-number">4</span>;<br> <br>    <span class="hljs-comment">//对象最后一次被访问的时间</span><br>    <span class="hljs-type">unsigned</span> lru:REDIS_LRU_BITS<br> <br>    <span class="hljs-comment">//引用计数</span><br>    <span class="hljs-type">int</span> refcount<br> <br>    <span class="hljs-comment">//指向底层实现数据结构的指针</span><br>    <span class="hljs-type">void</span> *ptr;<br>    ….. <br>&#125; <br></code></pre></td></tr></table></figure><p>ptr指针指向的就是每种数据类型的具体的数据结构</p><p>type 表示的是使用的那种数据结构，常用的有5种，string，hash，list，set，zset。 type就是来存这个的。</p><table><thead><tr><th>编码常量（encoding）</th><th>编码对应的底层数据结构</th></tr></thead><tbody><tr><td>REDIS_ENCODING_INT</td><td>long类型的整数</td></tr><tr><td>REDIS_ENCODING_EMBSTR</td><td>embstr编码的简单动态字符串</td></tr><tr><td>REDIS_ENCODING_RAW</td><td>简单动态字符串</td></tr><tr><td>REDIS_ENCODING_HT</td><td>字典</td></tr><tr><td>REDIS_ENCODING_LINKEDLIST</td><td>双向链表</td></tr><tr><td>REDIS_ENCODING_ZIPLIST</td><td>压缩列表</td></tr><tr><td>REDIS_ENCODING_INTSET</td><td>整数集合</td></tr><tr><td>REDIS_ENCODING_SKIPLIST</td><td>跳跃表和字典</td></tr></tbody></table><p>encoding 标注了这个对象具体的数据结构类型</p><p>![redis_ encoding](img&#x2F;redis_ encoding.png)</p><p>每一种redisObject对象对应底层都会有至少2种数据结构</p><table><thead><tr><th>类型</th><th>编码</th><th>对象</th></tr></thead><tbody><tr><td>String</td><td>int</td><td>整数值实现</td></tr><tr><td>String</td><td>embstr</td><td>sds实现 &lt;&#x3D;39 字节</td></tr><tr><td>String</td><td>raw</td><td>sds实现 &gt; 39字节</td></tr><tr><td>List</td><td>ziplist</td><td>压缩列表实现</td></tr><tr><td>List</td><td>linkedlist</td><td>双端链表实现</td></tr><tr><td>Set</td><td>intset</td><td>整数集合使用</td></tr><tr><td>Set</td><td>hashtable</td><td>字典实现</td></tr><tr><td>Hash</td><td>ziplist</td><td>压缩列表实现</td></tr><tr><td>Hash</td><td>hashtable</td><td>字典使用</td></tr><tr><td>Sorted set</td><td>ziplist</td><td>压缩列表实现</td></tr><tr><td>Sorted set</td><td>skiplist</td><td>跳跃表和字典</td></tr></tbody></table><p>介绍完了redisObject了，下面介绍每一种具体的数据类型及其对应的底层数据结构</p><h1 id="查看redis用什么数据结构存储的"><a href="#查看redis用什么数据结构存储的" class="headerlink" title="查看redis用什么数据结构存储的"></a>查看redis用什么数据结构存储的</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">help</span> object<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">OBJECT subcommand [arguments [arguments ...]]<br>  summary: Inspect the internals of Redis objects<br>  since: 2.2.3<br>  group: generic<br></code></pre></td></tr></table></figure><p>检查Redis对象的内部</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">set</span> key1 1<br>object encoding key1<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-string">&quot;int&quot;</span><br></code></pre></td></tr></table></figure><h1 id="String-类型"><a href="#String-类型" class="headerlink" title="String 类型"></a>String 类型</h1><p>在c语音中，定义的字符串是不可被修改的，因此redis设计了可变的字符串长度对象，接SDS（simple dynamic string），实现原理：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sdshdr</span>&#123;</span><br>    <span class="hljs-comment">//记录buf数组中已存的字节数量，也就是sds保存的字符串长度</span><br>    <span class="hljs-type">int</span> len;<br> <br>    <span class="hljs-comment">// buf数组中剩余可用的字节数量</span><br>    <span class="hljs-type">int</span> <span class="hljs-built_in">free</span>;<br> <br>    <span class="hljs-comment">//字节数组，用来存储字符串的</span><br>    <span class="hljs-type">char</span> buf[];<br>&#125;<br></code></pre></td></tr></table></figure><p>参数解析：</p><ol><li>len ： 保存的字符串长度。获取字符串的长度就是O(1)</li><li>free：剩余可用存储字符串的长度</li><li>buf：保存字符串</li></ol><p>这样设计的优点：</p><p>1.当用户修改字符串时sds api会先检查空间是否满足需求，如果满足，直接执行修改操作，如果不满足，将空间修改至满足需求的大小，然后再执行修改操作<br>2.空间预分配<br>    2.1如果修改后的sds的字符串小于1MB时（也就是len的长度小于1MB），那么程序会分配与len属性相同大小的未使用空间（就是再给未使用空间free也分配与len相同的空间）   例：字符串大小为600k，那么会分配600k给这个字符串使用，再分配600k的free空间在那。<br>    2.2惰性空间释放，当缩短sds的存储内容时，并不会立即使用内存重分配来回收字符串缩短后的空间，而是通过free将空闲的空间记录起来，等待将来使用。真正需要释放内存的时候，通过调用api来释放内存<br>    2.3通过空间预分配操作，redis有效的减少了执行字符串增长所需要的内存分配次数<br>    2.4如果修改后sds大于1MB时（也就是len的长度大于等于1MB），那么程序会分配1MB的未使用空间  例：字符串大小为3MB，那么会分配3MB给这个字符串使用，再分配1MB的free空间在那。</p><p>3.二进制安全</p><p>你已经知道了 Redis 可以存储各种数据类型，那么二进制数据肯定也不例外。但二进制数据并不是规则的字符串格式，可能会包含一些特殊的字符，比如 ‘\0’ 等。</p><p>前面我们提到过，C 中字符串遇到 ‘\0’ 会结束，那 ‘\0’ 之后的数据就读取不上了。但在 SDS 中，是根据 len 长度来判断字符串结束的。</p><p><img src="/.com//sds%E7%A9%BA%E9%97%B4%E9%A2%84%E5%88%86%E9%85%8D.png" alt="sds空间预分配"></p><p>字符串由3种编码实现。</p><h2 id="1、int-整数值实现"><a href="#1、int-整数值实现" class="headerlink" title="1、int 整数值实现"></a>1、int 整数值实现</h2><p>存储的数据是整数时，redis会将键值设置为int类型来进行存储，对应的编码类型是REDIS_ENCODING_INT</p><p><img src="/.com//string_int.png" alt="string_int"></p><h2 id="2、embstr"><a href="#2、embstr" class="headerlink" title="2、embstr"></a>2、embstr</h2><p>由sds实现 ，字节数 &lt;&#x3D; 39</p><p>存储的数据是字符串时，且字节数小于等于39 ，用的是embstr</p><p>优点：</p><p>1、创建字符串对象由两次变成了一次</p><p>2、连续的内存，更好的利用缓存优势</p><p>缺点：</p><p>1、由于是连续的空间，所以适合只读，如果修改的话，就会变成raw</p><p>2、由于是连续的空间，所以值适合小字符串</p><p><img src="/.com//string_embstr.png" alt="string_embstr"></p><h2 id="3、raw"><a href="#3、raw" class="headerlink" title="3、raw"></a>3、raw</h2><p>由sds实现 字节数 &gt; 39</p><p><img src="/.com//string_raw.png" alt="string_raw"></p><h1 id="List-类型"><a href="#List-类型" class="headerlink" title="List 类型"></a>List 类型</h1><p>list是由压缩链表和双向链表实现的</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">listNode</span> &#123;</span><br>    <span class="hljs-comment">// 前置节点</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">listNode</span> *<span class="hljs-title">prev</span>;</span><br> <br>    <span class="hljs-comment">// 后置节点</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">listNode</span> *<span class="hljs-title">next</span>;</span><br> <br>    <span class="hljs-comment">// 存储的数据</span><br>    <span class="hljs-type">void</span> *value;<br>&#125; listNode;<br> <br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list</span> &#123;</span><br>    <span class="hljs-comment">// 链表头节点</span><br>    listNode *head;<br> <br>    <span class="hljs-comment">// 链表尾节点</span><br>    listNode *tail;<br> <br>    <span class="hljs-comment">// 节点值复制函数</span><br>    <span class="hljs-type">void</span> *(*dup)(<span class="hljs-type">void</span> *ptr);<br> <br>    <span class="hljs-comment">// 节点值释放函数</span><br>    <span class="hljs-type">void</span> (*<span class="hljs-built_in">free</span>)(<span class="hljs-type">void</span> *ptr);<br> <br>    <span class="hljs-comment">// 节点值对比函数</span><br>    <span class="hljs-type">int</span> (*match)(<span class="hljs-type">void</span> *ptr, <span class="hljs-type">void</span> *key);<br> <br>    <span class="hljs-comment">// 链表所有节点数量</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len;<br>&#125; <span class="hljs-built_in">list</span>;<br></code></pre></td></tr></table></figure><h2 id="1、压缩链表：ziplist"><a href="#1、压缩链表：ziplist" class="headerlink" title="1、压缩链表：ziplist"></a>1、压缩链表：ziplist</h2><p>适用于长度较小的值，因为他是由连续的空间实现的。</p><p>存取的效率高，内存占用小，但由于内存是连续的，在修改的时候要重新分配内存</p><p>在数据量比较小的时候使用的是ziplist</p><p>当list对象同时满足以下两个条件是，使用的ziplist编码</p><p> 1.list对象保存的所有字符串元素长度都小于64字节</p><p> 2.list对象保存的元素数量小于512个</p><p><img src="/.com//List_ziplist.png" alt="List_ziplist"></p><p>缺点：</p><p>1.极端情况下会出现连锁更新现象。因为我们的previous_entry_length 记录了entry 的长度，如果每个长度都是250 - 253之间，那么如果在头部插一个新的entry节点，第一个节点的长度大于254字节，那么后一个节点的previous_entry_length 值就会从1个字节变为 5字节，那么这个entry的长度就大于了254字节，后面一个节点的previous_entry_length 值也得更新，后面的都得更新，导致整行的列表都得更新。<br>2.只能存储小数据的值</p><h2 id="2、双向链表：linkedlist"><a href="#2、双向链表：linkedlist" class="headerlink" title="2、双向链表：linkedlist"></a>2、双向链表：linkedlist</h2><p>在使用redis的list数据结构时，存储数据较大时，list对象已经不满足上面描述的ziplist条件，则会使用linkedlist</p><p>优点：修改效率高</p><p>缺点：保存前后指针，会占内存。</p><p><img src="/.com//list_linkedlist.png" alt="list_linkedlist"></p><h2 id="3、快速列表：quicklist"><a href="#3、快速列表：quicklist" class="headerlink" title="3、快速列表：quicklist"></a>3、快速列表：quicklist</h2><p>结合了压缩列表和双向链表的优点，也解决了他们的缺点 </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 快速列表节点</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">quicklistNode</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">quicklistNode</span> *<span class="hljs-title">prev</span>;</span> <span class="hljs-comment">//上一个node节点</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">quicklistNode</span> *<span class="hljs-title">next</span>;</span> <span class="hljs-comment">//下一个node</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *zl;            <span class="hljs-comment">//保存的数据 压缩前ziplist 压缩后压缩的数据</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> sz;             <span class="hljs-comment">/* ziplist size in bytes */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> count : <span class="hljs-number">16</span>;     <span class="hljs-comment">/* count of items in ziplist */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> encoding : <span class="hljs-number">2</span>;   <span class="hljs-comment">/* RAW==1 or LZF==2 */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> container : <span class="hljs-number">2</span>;  <span class="hljs-comment">/* NONE==1 or ZIPLIST==2 */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> recompress : <span class="hljs-number">1</span>; <span class="hljs-comment">/* was this node previous compressed? */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> attempted_compress : <span class="hljs-number">1</span>; <span class="hljs-comment">/* node can&#x27;t compress; too small */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> extra : <span class="hljs-number">10</span>; <span class="hljs-comment">/* more bits to steal for future usage */</span><br>&#125; quicklistNode;<br> <br><span class="hljs-comment">// 快速列表</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">quicklist</span> &#123;</span><br>    quicklistNode *head;<br>    quicklistNode *tail;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> count;        <span class="hljs-comment">/* total count of all entries in all ziplists */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len;          <span class="hljs-comment">/* number of quicklistNodes */</span><br>    <span class="hljs-type">int</span> fill : <span class="hljs-number">16</span>;              <span class="hljs-comment">/* fill factor for individual nodes ziplist大小设置 */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> compress : <span class="hljs-number">16</span>; <span class="hljs-comment">/* depth of end nodes not to compress;0=off 节点压缩深度设置*/</span><br>&#125; quicklist;<br> <br><span class="hljs-comment">// 被压缩的列表</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">quicklistLZF</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> sz; <span class="hljs-comment">/* LZF size in bytes*/</span><br>    <span class="hljs-type">char</span> compressed[];<br>&#125; quicklistLZF;<br></code></pre></td></tr></table></figure><p><img src="/.com//list_quicklist.png" alt="list_quicklist"></p><h1 id="Hash-类型"><a href="#Hash-类型" class="headerlink" title="Hash 类型"></a>Hash 类型</h1><p>底层是由ziplist 或hashtable 实现的</p><p>ziplist在上面介绍过了，下面来聊聊hashtable</p><h2 id="Hashtable"><a href="#Hashtable" class="headerlink" title="Hashtable"></a>Hashtable</h2><p> 一个哈希表里面可以有多个哈希节点，而每个哈希节点就保存了字典中的一个键值对。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 字典 数据结构</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dict</span> &#123;</span><span class="hljs-comment">//管理两个dictht，主要用于动态扩容。</span><br>    <span class="hljs-comment">//类型特定函数</span><br>    dictType *type;<br> <br>    <span class="hljs-comment">//私有数据</span><br>    <span class="hljs-type">void</span> *privdata;<br> <br>    <span class="hljs-comment">// 哈希表</span><br>    dictht ht[<span class="hljs-number">2</span>];<br> <br>    <span class="hljs-comment">// rehash索引，当rehash不再进行是，值为 -1</span><br>    <span class="hljs-type">long</span> rehashidx; <span class="hljs-comment">/* 扩容标志rehashing not in progress if rehashidx == -1 */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> iterators; <span class="hljs-comment">/* number of iterators currently running */</span><br>&#125; dict;<br> <br> <br><span class="hljs-comment">/* This is our hash table structure. Every dictionary has two of this as we</span><br><span class="hljs-comment"> * implement incremental rehashing, for the old to the new table. */</span><br><span class="hljs-comment">//定义一个hash桶，用来管理hashtable</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dictht</span> &#123;</span><br>    <span class="hljs-comment">// hash表数组，所谓的桶</span><br>    dictEntry **table;<br> <br>    <span class="hljs-comment">// hash表大小，元素个数</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> size;<br> <br>    <span class="hljs-comment">// hash表大小掩码，用于计算索引值，值总是size -1 </span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> sizemask;<br> <br>    <span class="hljs-comment">// 该hash表已有的节点数量</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> used;<br>&#125; dictht;<br> <br><span class="hljs-comment">//hash节点</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dictEntry</span> &#123;</span><br>    <span class="hljs-comment">//键</span><br>    <span class="hljs-type">void</span> *key;<br> <br>    <span class="hljs-comment">// 值</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span> <br>        <span class="hljs-type">void</span> *val;<br>        <span class="hljs-type">uint64_t</span> u64;<br>        <span class="hljs-type">int64_t</span> s64;<br>        <span class="hljs-type">double</span> d;<br>    &#125; v;<br> <br>    <span class="hljs-comment">// 指向下一个节点，解决碰撞冲突</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dictEntry</span> *<span class="hljs-title">next</span>;</span><br>&#125; dictEntry;<br> <br> <br><span class="hljs-comment">//定义hash需要使用的函数</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dictType</span> &#123;</span><br>    <span class="hljs-comment">// 计算哈希值的函数</span><br>    <span class="hljs-type">uint64_t</span> (*hashFunction)(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *key);<br> <br>    <span class="hljs-comment">//复制键的函数</span><br>    <span class="hljs-type">void</span> *(*keyDup)(<span class="hljs-type">void</span> *privdata, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *key);<br> <br>    <span class="hljs-comment">// 复制值的函数</span><br>    <span class="hljs-type">void</span> *(*valDup)(<span class="hljs-type">void</span> *privdata, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *obj);<br> <br>    <span class="hljs-comment">// 对比键的函数</span><br>    <span class="hljs-type">int</span> (*keyCompare)(<span class="hljs-type">void</span> *privdata, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *key1, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *key2);<br> <br>    <span class="hljs-comment">//销毁键的函数</span><br>    <span class="hljs-type">void</span> (*keyDestructor)(<span class="hljs-type">void</span> *privdata, <span class="hljs-type">void</span> *key);<br> <br>    <span class="hljs-comment">// 销毁值的函数</span><br>    <span class="hljs-type">void</span> (*valDestructor)(<span class="hljs-type">void</span> *privdata, <span class="hljs-type">void</span> *obj);<br>&#125; dictType;<br></code></pre></td></tr></table></figure><p>参数解析：</p><p>dict中</p><p>​type标识dictType类型，privatedata是指向特定数据类型的数组；</p><p>​ht包含了两个哈希表的数组，其中一个ht[0]保存哈希表，ht[1]只会在对ht[0]进行rehash时使用</p><p>dicht中</p><p>​table是一个数组，其中一个数组元素都是一个指向哈希表节点的指针，每一个哈希表节点都保存了一对键值对。</p><p>​size记录了table的大小，也即是哈希表的大小</p><p>​used记录了当前已使用节点的数量</p><p>​sizemask&#x3D;size-1 ,决定了一个键应该放tabl数组的哪个索引上</p><p>dicEntry中</p><p>​key保存键值对中的键，</p><p>​v保存这键值对中的值</p><p>​next为指向另一个哈希表几点的指针，当有hash冲突的时候</p><p><img src="/.com//hash_hashtable.png" alt="hash_hashtable"></p><h3 id="哈希表的扩展和收缩"><a href="#哈希表的扩展和收缩" class="headerlink" title="哈希表的扩展和收缩"></a>哈希表的扩展和收缩</h3><p>当以下条件中的任意一个被满足时，程序会自动开始对哈希表执行扩展操作</p><p>1：服务器目前没有在执行bgsave命令或者bgrewriteaof命令、并且哈希表的负载因子大于等于1</p><p>2：服务器目前正在执行bgsave命令或者bgrewriteaof命令并且哈希表的负载因子大于等于5</p><h3 id="rehash"><a href="#rehash" class="headerlink" title="rehash"></a>rehash</h3><p>rehash 跟Java中的hashmap扩容机制差不多</p><p>随着操作的不断执行，哈希表保存的键值对会逐渐地增多或减少，为了让哈希表的负载因子维持在一个合理的</p><p>范围内当哈希表保存的键值对数量太多或者太少时程序需要对哈希表的大小进行相应的扩展或者收缩</p><p>redis对字典的哈希表执行rehash的步骤如下;</p><p>1、为字典ht[1]哈希表分配空间，这个哈希表的空间大小取决于要执行的操作以及ht[0]当前包含的键值对数量（ht[0].used）</p><p>2、如果执行的是扩展操作，那么ht[1]的大小为第一个大于等于ht[0].used*2的n次幂</p><p>3、如果执行的是收缩操作，那么ht[1]的大小为第一个大于等于ht[0].used的2的n次幂</p><p>4、将保存在ht[0]中的所有键值对rehash到ht[1]上面rehash指的是重新计算键的哈希值和索引值,然后将键值对放置到ht[1]哈希表的指定位置上</p><p>5、当ht[0]包含的所有键值对都迁移到了ht[1]之后释放ht[0]将ht[1]设置为ht[0],并在ht[1]新创键一个空白哈希表为下一次rehash做准备</p><p>为了避免rehash对服务器性能造成影响，服务器不是一次性将ht[0]里面的所有键值对全部rehash到ht[1]而是分多次将ht[0]里面的键值对慢慢地rehash到ht[1]</p><p>在进行渐进式rehash的过程中,字典会同时使用ht[0] ht[1]两个哈希表所以在渐进式rehash进行期间字典的删除 查找 更新等操作会在两个哈希表上进行 新添加到字典的键值对一律会保存到ht[1]里面则ht[0]不再进行任何添加操作</p><h3 id="渐进式hash"><a href="#渐进式hash" class="headerlink" title="渐进式hash"></a>渐进式hash</h3><p>如果哈希表里保存的键值对数量是四百万、四千万甚至四亿个键值对，那么要一次性将这些键值对全部rehash到ht[1]的话，庞大的计算量可能会导致服务器在一段时间内停止服务。因此，为了避免rehash对服务器性能造成影响，服务器不是一次性将 ht[0]里面的所有键值对全部rehash到ht[1]，而是分多次、渐进式地将ht[0]里面的键值对慢慢地rehash到ht[1]。</p><p>以下是哈希表渐进式 rehash 的详细步骤：</p><p>1、为ht[1]分配空间，让字典同时持有ht[0]和ht[1]两个哈希表。</p><p>2、在字典中维持一个索引计数器变量rehashidx，并将它的值设置为0，表示rehash工作正式开始。</p><p>3、在rehash进行期间，<strong>每次对字典执行添加、删除、查找或者更新操作时，程序除了执行指定的操作以外，</strong>还会顺带将ht[0]哈希表在rehashidx索引上的所有键值对</p><p>4、rehash到ht[1]，当rehash工作完成之后，程序将rehashidx+1(表示下次将rehash下一个桶)。</p><p>5、随着字典操作的不断执行，最终在某个时间点上，ht[0]的所有键值对都会被rehash至ht[1]，这时程序将rehashidx属性的值设为-1，表示rehash操作已完成。</p><p>渐进式rehash的好处在于它采取分而治之的方式，将rehash键值对所需的计算工作均摊到对字典的每个添加、删除、查找和更新操作上，从而避免了集中式rehash 而带来的庞大计算量。而memcached通过也需要rehash，但是它是另外单独开一个线程，专门执行rehash操作。这就是区别与Redis的做法，个人任何Redis的作者方法更胜一筹。因为这种分治算法，将全部负载，均摊到了每次的操作过程中，在单个线程中实现。这个就是迁移线程，memcached中的迁移线程。</p><h1 id="Set-类型"><a href="#Set-类型" class="headerlink" title="Set 类型"></a>Set 类型</h1><p>底层使用的是intset 或hashtable 实现的</p><p>hashtable 上面介绍过了，下面介绍intset。</p><h2 id="intset-整数集合"><a href="#intset-整数集合" class="headerlink" title="intset 整数集合"></a>intset 整数集合</h2><p>有序不重复的连续空间，特性如下：</p><p>1、节约内存，但由于是连续空间，修改效率不高</p><p>2、集合中的数都是整数时，且数据量不超过512个时，使用intset</p><p>3、整数集合是集合键的底层实现之一   </p><p>4、 整数集合的底层实现是数组，这个数组以有序、无重复的方式保存集合元素，在有需要的时候，程序会根据新添加元素的类型，改变这个数组的类型。</p><p>5、升级操作为整数集合带来了操作上的灵活性，并且尽可能的节约了内存。</p><p>6、整数集合只支持升级操作，不支持降级操作</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">intset</span> &#123;</span><br>    <span class="hljs-comment">// 编码类型 int16_t、int32_t、int64_t</span><br>    <span class="hljs-type">uint32_t</span> encoding;  <br> <br>    <span class="hljs-comment">// 长度 最大长度:2^32</span><br>    <span class="hljs-type">uint32_t</span> length;  <br> <br>    <span class="hljs-comment">// 用来存储数据的柔性数组  </span><br>    <span class="hljs-type">int8_t</span> contents[];  <br>&#125; intset;<br></code></pre></td></tr></table></figure><p><img src="/.com//set_intset.png" alt="set_intset"></p><h1 id="Zset-类型"><a href="#Zset-类型" class="headerlink" title="Zset 类型"></a>Zset 类型</h1><p>底层是由ziplist 或 skiplist 实现的，ziplist 上面介绍过了，下面介绍skiplist</p><h2 id="skiplist-跳表"><a href="#skiplist-跳表" class="headerlink" title="skiplist 跳表"></a>skiplist 跳表</h2><p>跳表（Skiplist）是一个特殊的链表，相比一般的链表，有更高的查找效率，可比拟二叉查找树，平均期望的查找、插入、删除时间复杂度都是O(logn)。具有层次结构的链表，可支持范围查询</p><p>跳表的第一层是一个双向链表，其他层级的都是单向链表</p><p>它由很多层结构组成，每一层都是一个有序的链表，默认是升序，也可以根据创建映射时所提供的Comparator进行排序，具体取决于使用的构造方法<br>最底层(Level 1)的链表包含所有元素<br>如果一个元素出现在Level i 的链表中，则它在Level i 之下的链表也都会出现<br>每个节点包含两个指针，一个指向同一链表中的下一个元素，一个指向下面一层的元素</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// 跳表节点</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zskiplistNode</span> &#123;</span><br>    <span class="hljs-comment">// 存放至该节点的数据</span><br>    robj *obj;<br> <br>    <span class="hljs-comment">// 数据的分数值，zset根据这个分数值进行升序排序</span><br>    <span class="hljs-type">double</span> score;<br> <br>    <span class="hljs-comment">// 指向链表的上一个节点</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zskiplistNode</span> *<span class="hljs-title">backward</span>;</span><br> <br>    <span class="hljs-comment">// 跳表的层级，每一条数据代表着一层</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zskiplistLevel</span> &#123;</span><br>        <span class="hljs-comment">// 指向下一个节点的指针</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zskiplistNode</span> *<span class="hljs-title">forward</span>;</span><br> <br>        <span class="hljs-comment">// 表示这个指针跳跃了多少个节点</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> span;<br>    &#125; level[];<br>&#125; zskiplistNode;<br> <br><span class="hljs-comment">// 跳表</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zskiplist</span> &#123;</span><br>    <span class="hljs-comment">// 头节点指针，尾节点指针</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zskiplistNode</span> *<span class="hljs-title">header</span>, *<span class="hljs-title">tail</span>;</span><br> <br>    <span class="hljs-comment">// 跳表的长度，不包括头指针</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> length;<br> <br>    <span class="hljs-comment">// 跳表的层数</span><br>    <span class="hljs-type">int</span> level;<br>&#125; zskiplist;<br></code></pre></td></tr></table></figure><p><img src="/.com//zset_zkiplist.png" alt="zset_zkiplist"></p>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis单点到集群</title>
    <link href="/2022/05/17/redis/Redis%E5%8D%95%E7%82%B9%E5%88%B0%E9%9B%86%E7%BE%A4/"/>
    <url>/2022/05/17/redis/Redis%E5%8D%95%E7%82%B9%E5%88%B0%E9%9B%86%E7%BE%A4/</url>
    
    <content type="html"><![CDATA[<h1 id="单机、单节点、单实例有什么问题？"><a href="#单机、单节点、单实例有什么问题？" class="headerlink" title="单机、单节点、单实例有什么问题？"></a>单机、单节点、单实例有什么问题？</h1><ol><li>单点故障</li><li>容量有限</li><li>压力</li></ol><h1 id="redis-sentinel-哨兵"><a href="#redis-sentinel-哨兵" class="headerlink" title="redis sentinel(哨兵)"></a>redis sentinel(哨兵)</h1><p>可以解决：单点故障、压力(连接或读)</p><h2 id="选举"><a href="#选举" class="headerlink" title="选举"></a>选举</h2><p>当redis集群的主节点故障时，Sentinel集群将从剩余的从节点中选举一个新的主节点，有以下步骤：</p><ol><li>故障节点主观下线</li><li>故障节点客观下线</li><li>Sentinel集群选举Leader</li><li>Sentinel Leader决定新主节点</li></ol><h2 id="选举过程"><a href="#选举过程" class="headerlink" title="选举过程"></a>选举过程</h2><h3 id="1、主观下线"><a href="#1、主观下线" class="headerlink" title="1、主观下线"></a>1、主观下线</h3><p>Sentinel集群的每一个Sentinel节点会定时对redis集群的所有节点发心跳包检测节点是否正常。如果一个节点在down-after-milliseconds时间内没有回复Sentinel节点的心跳包，则该redis节点被该Sentinel节点主观下线。</p><h3 id="2、客观下线"><a href="#2、客观下线" class="headerlink" title="2、客观下线"></a>2、客观下线</h3><p>当节点被一个Sentinel节点记为主观下线时，并不意味着该节点肯定故障了，还需要Sentinel集群的其他Sentinel节点共同判断为主观下线才行。</p><p>该Sentinel节点会询问其他Sentinel节点，如果Sentinel集群中超过quorum数量的Sentinel节点认为该redis节点主观下线，则该redis客观下线。</p><p>如果客观下线的redis节点是从节点或者是Sentinel节点，则操作到此为止，没有后续的操作了；如果客观下线的redis节点为主节点，则开始故障转移，从从节点中选举一个节点升级为主节点。</p><h3 id="3、Sentinel集群选举Leader"><a href="#3、Sentinel集群选举Leader" class="headerlink" title="3、Sentinel集群选举Leader"></a>3、Sentinel集群选举Leader</h3><p>如果需要从redis集群选举一个节点为主节点，首先需要从Sentinel集群中选举一个Sentinel节点作为Leader。</p><p>每一个Sentinel节点都可以成为Leader，当一个Sentinel节点确认redis集群的主节点主观下线后，会请求其他Sentinel节点要求将自己选举为Leader。被请求的Sentinel节点如果没有同意过其他Sentinel节点的选举请求，则同意该请求(选举票数+1)，否则不同意。</p><p>如果一个Sentinel节点获得的选举票数达到Leader最低票数(quorum和Sentinel节点数&#x2F;2+1的最大值)，则该Sentinel节点选举为Leader；否则重新进行选举。</p><p><img src="/.com//redis%E6%8A%95%E7%A5%A8%E8%BF%87%E7%A8%8B.png" alt="redis投票过程"></p><h3 id="4、Sentinel-Leader决定新主节点"><a href="#4、Sentinel-Leader决定新主节点" class="headerlink" title="4、Sentinel Leader决定新主节点"></a>4、Sentinel Leader决定新主节点</h3><p>当Sentinel集群选举出Sentinel Leader后，由Sentinel Leader从redis从节点中选择一个redis节点作为主节点：</p><p>过滤故障的节点<br>选择优先级slave-priority最大的从节点作为主节点，如不存在则继续<br>选择复制偏移量（数据写入量的字节，记录写了多少数据。主服务器会把偏移量同步给从服务器，当主从的偏移量一致，则数据是完全同步）最大的从节点作为主节点，如不存在则继续<br>选择runid（redis每次启动的时候生成随机的runid作为redis的标识）最小的从节点作为主节点</p><h2 id="为什么Sentinel集群至少3节点"><a href="#为什么Sentinel集群至少3节点" class="headerlink" title="为什么Sentinel集群至少3节点"></a>为什么Sentinel集群至少3节点</h2><p>一个Sentinel节选举成为Leader的最低票数为<code>quorum</code>和<code>Sentinel节点数/2+1</code>的最大值，如果Sentinel集群只有2个Sentinel节点，则</p><figure class="highlight text"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><pre><code class="hljs text">Sentinel节点数/2 + 1<br>= 2/2 + 1<br>= 2<br></code></pre></td></tr></table></figure><p>即Leader最低票数至少为2，当该Sentinel集群中由一个Sentinel节点故障后，仅剩的一个Sentinel节点是永远无法成为Leader。</p><p>也可以由此公式可以推导出，Sentinel集群允许1个Sentinel节点故障则需要3个节点的集群；允许2个节点故障则需要5个节点集群。</p><h1 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h1><h2 id="如何分片"><a href="#如何分片" class="headerlink" title="如何分片"></a>如何分片</h2><p>方案1.客户端按业务逻辑  不同的redis实例</p><p>方案2. 客户端使用 算法：hash+取模 modula  不同的redis实例</p><p>  增加或删除redis实例不方便</p><p>方案3. 客户端采用 逻辑： 随机 + 队列 先去看我在哪个实例  不同的redis实例</p><p>方案4. 客户端采用 一致性哈希 + 哈希环</p><h2 id="集群方案选型"><a href="#集群方案选型" class="headerlink" title="集群方案选型"></a>集群方案选型</h2><p>集群方案解决：单点故障、容量有限、压务</p><p>代理方式：twemproxy  或者 Predixy</p><p>redis官方的集群：redis cluster</p><p>twemproxy  或者 Predixy 或者 redis cluster都是集群方案。</p><h2 id="集群都支持hash-tag"><a href="#集群都支持hash-tag" class="headerlink" title="集群都支持hash tag"></a>集群都支持hash tag</h2><p>可以把{tag}的key放到一个redis实例。</p><h2 id="redis-cluster"><a href="#redis-cluster" class="headerlink" title="redis cluster"></a>redis cluster</h2><p>redis cluster 使用分片方案4，获取是先算出在哪个槽位，再去哪个库取。</p><h1 id="复制过程"><a href="#复制过程" class="headerlink" title="复制过程"></a>复制过程</h1><p>Redis 的复制功能分为同步( sync )和命令传播( command propagate )两个步骤：</p><ul><li>同步用于将从服务器的数据库状态更新至主服务器当前所处的数据库状态。</li><li>命令传播则用于在主服务器的数据库状态被修改，导致主从服务器的数据库状态出现不一致时，让主从服务器的数据库重新回到一致状态。</li></ul><h2 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h2><p>Redis 使用 psync 命令完成主从数据同步，同步过程分为：全量复制和部分复制。</p><p>全量复制：一般用于初次复制场景，它会把主节点全部数据一次性发送给从节点发送给从节点，当数据量较大时，会对主从节点和网络造成很大的开销。</p><p>部分复制：用于处理在主从复制中因网络闪断等原因造成的网络丢失场景，当从节点再次连接上主节点后，如果条件允许，主节点会补发丢失数据给从节点。因为补发的数据远远小于全量数据，可以有效避免全量复制的过高开销。</p><p>psync 命令运行需要以下组件支持：</p><ul><li>主从节点各自复制偏移量</li><li>主节点复制积压缓冲区</li><li>主节点运行 id</li></ul><p>参与复制的从节点都会维护自身复制偏移量。主节点在处理完写命令后，会把命令的字节长度做累加记录，统计在 info replication 中的 masterreploffset 指标中。 从节点在接收到主节点发送的命令后，也会累加记录自身的偏移量，并且会每秒钟上报自身的复制偏移量给主节点。 通过对比主从节点的复制偏移量，可以判断主从节点数据是否一致。</p><p>复制积压缓冲区是保存在主节点的一个固定长度的队列，默认大小为 1MB，当主节点有连接的从节点时被创建。主节点响应写命令时，不但会把命令发送给从节点，还会写入复制积压缓冲区中。</p><p>复制积压缓冲区大小有限，只能保存最近的复制数据，用于部分复制和复制命令丢失时的数据补救。</p><p>每个 Redis 节点启动后都会动态分配一个 40 位的十六进制字符串作为运行 ID。运行 ID 的主要作用是用来唯一标识 Redis 节点，比如说从节点保存主节点的运行 ID 来识别自己正在复制的时哪个主节点。</p><h3 id="全量同步"><a href="#全量同步" class="headerlink" title="全量同步"></a>全量同步</h3><p><img src="/.com//redis%E5%85%A8%E9%87%8F%E5%90%8C%E6%AD%A5.png" alt="redis全量同步"></p><p>slaveof 命令的执行</p><ol><li><p>从节点发送 psync 命令进行数据同步，由于是第一次进行复制，从节点没有复制偏移量和主节点的运行ID，所以发送的命令时 PSYNC ? -1。</p></li><li><p>主节点根据 PSYNC ? -1 解析出当前为全量复制，回复 + FULLRESYNC 响应。</p></li><li><p>从节点接收主节点的响应数据保存运行 ID 和偏移量 offset。</p></li><li><p>主节点执行 bgsave 保存 RDB 文件到本地，有关 RDB 的知识可以查看<a href="https://mp.weixin.qq.com/s/NpUV-7bvXTD3iu0_2aRssQ">《Redis RDB 持久化详解》</a></p></li><li><p>主节点发送 RDB 文件给从节点，从节点把接收的 RDB 文件保存在本地并直接作为从节点的数据文件，接收完 RDB 后从节点打印相关日志，可以在日志中查看主节点发送的数据量。</p></li></ol><p>需要注意，对于数据量较大的主节点，比如生成的 RDB 文件超过 6GB 以上时要格外小心。如果传输 RDB 的时间超过 repl-timeout 所配置的值，从节点将发起接收 RDB 文件并清理已经下载的临时文件，导致全量复制失败。</p><ol start="6"><li>对于主节点开始保存 RDB 快照到从节点接收完成期间，主节点仍然响应读命令，因此主节点会把这期间写命令保存在复制客户端缓冲区内，当从节点加载完 RDB 文件后，主节点再把缓冲区内的数据发送给从节点，保证主从之间数据一致性。</li></ol><p>如果主节点创建和传输 RDB 的时间过长，可能会出现主节点复制客户端缓冲区溢出。默认配置为 client-output-buffer-limit slave 256MB 64MB 60，如果60s内缓冲区消耗持续大于64MB或者直接超过256MB时，主节点将直接关闭复制客户端连接，造成全量同步失败。</p><ol start="7"><li><p>从节点接收完主节点传送来的全部数据后会清空自身旧数据，该步骤对应如下日志。</p></li><li><p>从节点清空数据后开始加载 RDB 文件，对于加大的 RDB 文件，这一步操作依然比较耗时，可以通过计算日志之间的时间差来判断加载 RDB 的总耗时。</p></li><li><p>收到 SYNC 命令的主服务器执行 BGSAVE 命令，在后台生成一个 RDB 文件，并使用一个缓冲区记录从现在开始执行的所有写命令。</p></li><li><p>当主服务器的 BGSAVE 命令执行完毕时，主服务器会将 GBSAVE 命令生成的 RDB 文件发送给从服务器，从服务器接收并载入这个 RDB 文件，将自己的数据库状态更新至主服务器执行 BGSAVE 命令时的数据库状态。</p></li><li><p>主服务器将记录在缓冲区里边的所有写命令发送给从服务器，从服务器执行这些写命令，将自己的数据库状态更新至主服务器数据库当前所处的状态。</p></li></ol><p>通过分析全量复制的所有流程，读者会发现全量复制是一个非常耗时费力的操作。它时间开销主要包括：</p><ul><li>主节点 bgsave 时间</li><li>RDB 文件网络传输时间</li><li>从节点清空数据时间</li><li>从节点加载 RDB 的时间</li><li>可能的 AOF 重写时间</li></ul><p>全量同步过程中不仅会消耗大量时间，还会进行多次持久化相关操作和网络数据传输，这期间会大量消耗主从节点所在服务器的 CPU、内存和网络资源。所以，除了第一次复制是采用全量同步无法避免，其他场景应该规避全量复制，采取部分同步功能。</p><h3 id="部分同步"><a href="#部分同步" class="headerlink" title="部分同步"></a>部分同步</h3><p>部分复制主要是 Redis 针对全量复制的过高开销做出的一种优化措施，使用 psync {runId} {offset} 命令实现。当从节点正在复制主节点时，如果出现网络闪断或者命令丢失等异常情况时，从节点会向主节点要求补发丢失的命令数据，如果主节点的复制积压缓冲区存在这部分数据则直接发送给从节点，这样就保证了主从节点复制的一致性。补发的这部分数据一般远远小于全量数据，所以开销很小。</p><p><img src="/.com//redis%E9%83%A8%E5%88%86%E5%90%8C%E6%AD%A5.png" alt="redis部分同步"></p><ol><li><p>当主从节点之间网络出现中断时，如果超过了 repl-timeout 时间，主节点会认为从节点故障并中断复制连接。</p></li><li><p>主从连接中断期间主节点依然响应命令，但因复制连接中断命令无法发送给从节点，不过主节点内部存在复制积压缓冲区( repl-backlog-buffer )，依然可以保存最近一段时间的写命令数据，默认最大缓存 1MB。</p></li><li><p>当主从节点网络恢复后，从节点会再次连上主节点。</p></li><li><p>当主从连接恢复后，由于从节点之前保存了自身已复制的偏移量和主节点的运行ID。因此会把它们作为 psync 参数发送给主节点，要求进行补发复制操作。</p></li><li><p>主节点接到 psync 命令后首先核对参数 runId 是否与自身一致，如果一致，说明之前复制的是当前主节点；之后根据参数 offset 在自身复制积压缓冲区查找，如果偏移量之后的数据存在缓冲区中，则对从节点发送 +CONTINUE 响应，表示可以进行部分复制。</p></li><li><p>主节点根据偏移量把复制积压缓冲区里的数据发送给从节点，保证主从复制进入正常状态。</p></li></ol><h2 id="心跳检测"><a href="#心跳检测" class="headerlink" title="心跳检测"></a>心跳检测</h2><p>主从节点在建立复制后，它们之间维护着长连接并彼此发送心跳命令，如下图所示。</p><p>主从心跳判断机制如下所示：</p><ol><li><p>主从节点彼此都有心跳检测机制，各自模拟成对方的客户端进行通信，通过 client list 命令查看复制相关客户端信息，主节点的连接状态为 flags&#x3D;M，从节点连接状态为 flags&#x3D;S。</p></li><li><p>主节点默认每隔 10 秒对从节点发送 ping 命令，判断从节点的存活性和连接状态。可以通过参数 repl-ping-slave-period 控制发送频率。</p></li><li><p>从节点在主线程中每隔 1 秒发送 replconf ack { offset } 命令，给主节点上报自己当前的复制偏移量。</p></li></ol><p>replconf 命令不仅能实时监测主从节点网络状态，还能上报从节点复制偏移量。主节点会根据从节点上传的偏移量检查复制数据是否丢失，如果从节点数据丢失，再从主节点的复制缓存区中拉取丢失的数据发送给该从节点。</p><h2 id="异步复制和命令传播"><a href="#异步复制和命令传播" class="headerlink" title="异步复制和命令传播"></a>异步复制和命令传播</h2><p>主节点不但负责数据读写，还负责把写命令同步给从节点。写命令的发送过程是异步完成，也就是说主节点自身处理完写命令后直接返回给客户端，并不等待从节点复制完成。</p><p><img src="/.com//redis%E5%91%BD%E4%BB%A4%E4%BC%A0%E6%92%AD.png" alt="redis命令传播"></p><p>这个异步过程由命令传播来处理，它不仅会将写命令发送给所有从服务器，还会将写命令入队到复制积压缓冲区里边。</p>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis的过期键的删除策略</title>
    <link href="/2022/05/17/redis/Redis%E7%9A%84%E8%BF%87%E6%9C%9F%E9%94%AE%E7%9A%84%E5%88%A0%E9%99%A4%E7%AD%96%E7%95%A5/"/>
    <url>/2022/05/17/redis/Redis%E7%9A%84%E8%BF%87%E6%9C%9F%E9%94%AE%E7%9A%84%E5%88%A0%E9%99%A4%E7%AD%96%E7%95%A5/</url>
    
    <content type="html"><![CDATA[<h1 id="Redis的过期键的删除策略"><a href="#Redis的过期键的删除策略" class="headerlink" title="Redis的过期键的删除策略"></a>Redis的过期键的删除策略</h1><p>Redis是key-value数据库，我们可以设置Redis中缓存的key的过期时间。</p><p>Redis的过期策略就是指当Redis中缓存的key过期了，Redis如何处理。</p><h1 id="通用的过期策略"><a href="#通用的过期策略" class="headerlink" title="通用的过期策略"></a>通用的过期策略</h1><h2 id="定时过期"><a href="#定时过期" class="headerlink" title="定时过期"></a>定时过期</h2><p>每个设置过期时间的key都需要创建一个定时器，到过期时间就会立即清除。该策略可以立即清除过期的数据，对内存很友好；但是会占用大量的CPU资源去处理过期的数据，从而影响缓存的响应时间和吞吐量。</p><h2 id="惰性过期"><a href="#惰性过期" class="headerlink" title="惰性过期"></a>惰性过期</h2><p>只有当访问一个key时，才会判断该key是否已过期，过期则清除。该策略可以最大化地节省CPU资源，却对内存非常不友好。极端情况可能出现大量的过期key没有再次被访问，从而不会被清除，占用大量内存。</p><h2 id="定期过期"><a href="#定期过期" class="headerlink" title="定期过期"></a>定期过期</h2><p>每隔一定的时间，会扫描一定数量的数据库的expires字典中一定数量的key，并清除其中已过期的key。该策略是前两者的一个折中方案。通过调整定时扫描的时间间隔和每次扫描的限定耗时，可以在不同情况下使得CPU和内存资源达到最优的平衡效果。(expires字典会保存所有设置了过期时间的key的过期时间数据，其中，key是指向键空间中的某个键的指针，value是该键的毫秒精度的UNIX时间戳表示的过期时间。键空间是指该Redis集群中保存的所有键。)</p><h1 id="redis使用策略"><a href="#redis使用策略" class="headerlink" title="redis使用策略"></a>redis使用策略</h1><p>Redis中同时使用了惰性过期和定期过期两种过期策略。</p>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>如何保证数据库与缓存的数据一致性</title>
    <link href="/2022/05/17/redis/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E%E7%BC%93%E5%AD%98%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7/"/>
    <url>/2022/05/17/redis/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E%E7%BC%93%E5%AD%98%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7/</url>
    
    <content type="html"><![CDATA[<h1 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h1><p>Mysql 做数据库   redis做缓存</p><h1 id="如何保证数据库与缓存的数据一致性"><a href="#如何保证数据库与缓存的数据一致性" class="headerlink" title="如何保证数据库与缓存的数据一致性?"></a>如何保证数据库与缓存的数据一致性?</h1><p>cache aside pattern</p><p>1.命中：程序先从缓存中读取数据，如果命中，则直接返回</p><p>2.失效：程序先从缓存中读取数据，如果没有命中，则从数据库中读取，成功之后将数据放到缓存中</p><p>3.更新：程序先更新数据库，在删缓存。</p><h2 id="先更新数据库，再删除缓存-是不是就没有问题？"><a href="#先更新数据库，再删除缓存-是不是就没有问题？" class="headerlink" title="先更新数据库，再删除缓存, 是不是就没有问题？"></a>先更新数据库，再删除缓存, 是不是就没有问题？</h2><p>假设这会有两个请求，一个请求A做查询操作，一个请求B做更新操作，那么会有如下情形产生<br>（1）缓存刚好失效<br>（2）请求A查询数据库，得一个旧值<br>（3）请求B将新值写入数据库<br>（4）请求B删除缓存<br>（5）请求A将查到的旧值写入缓存<br>ok，如果发生上述情况，确实是会发生脏数据。</p><p>发生上述情况有一个先天性条件，就是步骤（3）的写数据库操作比步骤（2）的读数据库操作耗时更短，才有可能使得步骤（4）先于步骤（5）。可是，大家想想，数据库的读操作的速度远快于写操作的（不然做读写分离干嘛，做读写分离的意义就是因为读操作比较快，耗资源少），因此步骤（3）耗时比步骤（2）更短，这一情形很难出现。</p><h3 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h3><p>1.单sql情况下，可做延时删除。 （延时如果出现服务挂了，未删除缓存） (弱一致性)</p><p>2.多sql事务情况下，可使分布式锁，读请求发现缓存没有时要去获取锁。写请求和读请求用一把锁。（加锁了，响应就慢了）（强一致性）</p><p>3.异步删除（在异步这段时间，数据是不一致的）（最终一致性）</p>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis持久化</title>
    <link href="/2022/05/17/redis/Redis%E6%8C%81%E4%B9%85%E5%8C%96/"/>
    <url>/2022/05/17/redis/Redis%E6%8C%81%E4%B9%85%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="redis为什么要持久化"><a href="#redis为什么要持久化" class="headerlink" title="redis为什么要持久化"></a>redis为什么要持久化</h1><p>1.redis做为数据库使用时，数据库必须提供持久化特性；</p><p>2.redis做为缓存使用时，持久化缓存数据：</p><p>​redis崩溃时重新加载持久化的数据；</p><p>​redis迁移</p><h1 id="redis支持的两种持久化方式"><a href="#redis支持的两种持久化方式" class="headerlink" title="redis支持的两种持久化方式"></a>redis支持的两种持久化方式</h1><h2 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h2><p>属于全量数据备份，备份的是数据</p><p>save 这个是阻塞的。一般在关机维护时使用。</p><p>bgsave 这个是由fork()子进程实现的。</p><p>配置文件中给出bgsave的规则： (使用的save这个标识)</p><figure class="highlight text"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><pre><code class="hljs text">save 900 1<br><br>save 300 10<br><br>save 60 10000<br><br>dbfilename dump.rdb<br><br>dir /var/lib/redis/6379 <br></code></pre></td></tr></table></figure><h3 id="rdb-的弊端"><a href="#rdb-的弊端" class="headerlink" title="rdb 的弊端"></a>rdb 的弊端</h3><p>不支持拉链 只有一个dump.rdb</p><p>丢失数据相对多一些 （时点与时点之间窗口数据容易丢失 8得到一个rdb，9刚要落盘一个rdb，挂机了）</p><h3 id="rdb的优点"><a href="#rdb的优点" class="headerlink" title="rdb的优点"></a>rdb的优点</h3><p>类似java中的序列化，恢复的速度相对快</p><h2 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h2><p>append only if,增量持久化备份，备份的是指令</p><p>redis的写操作记录到文件中</p><p>写操作会触发IO</p><p>相关配置：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs text">appendonly yes<br><br>appendfilename &quot;appendonly.aof&quot;<br><br>auto-aof-rewrite-percentage 100<br><br>auto-aof-rewrite-min-size 64mb<br><br>appendfsync always<br><br>appendfsync everysec<br><br>appendfsync no <br></code></pre></td></tr></table></figure><h3 id="AOF优点"><a href="#AOF优点" class="headerlink" title="AOF优点"></a>AOF优点</h3><p>丢失数据少</p><h3 id="AOF弊端"><a href="#AOF弊端" class="headerlink" title="AOF弊端"></a>AOF弊端</h3><p>恢复慢</p><h1 id="fork-创建子进程"><a href="#fork-创建子进程" class="headerlink" title="fork()创建子进程"></a>fork()创建子进程</h1><h2 id="linux父子进程："><a href="#linux父子进程：" class="headerlink" title="linux父子进程："></a>linux父子进程：</h2><p>父进程的数据，子进程可不可以看得到？</p><p>常规思想，进程是数据隔离的！</p><p>进阶思想，父进程其实可以让子进程看到数据！</p><p>linux中</p><p>export的环境变量，子进程的修改不会破坏父进程</p><p>父进程的修改也不会破坏子进程</p><p>fork() </p><p>1，速度：快</p><p>2，空间：小</p><p>fork()使用的是copy on write机制。</p><p><strong>copy on write：内核机制</strong></p><p>写时复制</p><p>创建子进程并不发生复制。</p><p>创建进程变快了。</p><p>根据经验，不可能父子进程把所有数据都改一遍。</p><p>玩的是指针。</p><p>使用 linux fork()出一个子进程，这时主进程还是可以提供服务的。子进程可以看到内存上的数据。如果主进程进行数据的修改，是先由内存创建出一个8的内存空间，主进程a的指向改成8的内存地址。这时子进程中的a的指向还是指向3。所以如果8点开始持久化，就是8点的数据。</p><h1 id="aof-文件大，从而导致恢复更慢，redis的演变"><a href="#aof-文件大，从而导致恢复更慢，redis的演变" class="headerlink" title="aof 文件大，从而导致恢复更慢，redis的演变"></a>aof 文件大，从而导致恢复更慢，redis的演变</h1><p>都是重写。</p><h2 id="4-0以前"><a href="#4-0以前" class="headerlink" title="4.0以前"></a>4.0以前</h2><p>删除抵消的命令（add k1 1 del k1） </p><p>合并重复的命令 (inby k1 1  重复1000)</p><p>最终也是一个纯指令的日志文件</p><h2 id="4-0以后"><a href="#4-0以后" class="headerlink" title="4.0以后"></a>4.0以后</h2><p>将老的数据RDB到aof文件中</p><p>将增量的以指令的方式Append到AOF</p><p>AOF是一个混合体，利用了RDB的快，利用了日志的全量</p><h1 id="redis中，RDB和AOF可以同时开启"><a href="#redis中，RDB和AOF可以同时开启" class="headerlink" title="redis中，RDB和AOF可以同时开启"></a>redis中，RDB和AOF可以同时开启</h1><p>如果开启了AOF，只会用AOF恢复</p><p>4.0以后：AOF中包含RDB全量，增加记录新的写操作(aof文件为一个混合文件)</p>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>redisson简介及分布式锁</title>
    <link href="/2022/05/17/redis/redisson%E7%AE%80%E4%BB%8B%E5%8F%8A%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
    <url>/2022/05/17/redis/redisson%E7%AE%80%E4%BB%8B%E5%8F%8A%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</url>
    
    <content type="html"><![CDATA[<h1 id="redisson"><a href="#redisson" class="headerlink" title="redisson"></a>redisson</h1><p>Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务。其中包括(<code>BitSet</code>, <code>Set</code>, <code>Multimap</code>, <code>SortedSet</code>, <code>Map</code>, <code>List</code>, <code>Queue</code>, <code>BlockingQueue</code>, <code>Deque</code>, <code>BlockingDeque</code>, <code>Semaphore</code>, <code>Lock</code>, <code>AtomicLong</code>, <code>CountDownLatch</code>, <code>Publish / Subscribe</code>, <code>Bloom filter</code>, <code>Remote service</code>, <code>Spring cache</code>, <code>Executor service</code>, <code>Live Object service</code>, <code>Scheduler service</code>) Redisson提供了使用Redis的最简单和最便捷的方法。Redisson的宗旨是促进使用者对Redis的关注分离（Separation of Concern），从而让使用者能够将精力更集中地放在处理业务逻辑上。</p><p>官网：<a href="https://github.com/redisson/redisson">https://github.com/redisson/redisson</a></p><p>Wiki中文：<a href="https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95">https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95</a></p><h1 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h1><p>进入子项止  <strong>redisson-spring-boot-starter</strong></p><p>Readme.md</p><h2 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.17.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="yml配置"><a href="#yml配置" class="headerlink" title="yml配置"></a>yml配置</h2><h3 id="方法1-使用spring-boot的配置"><a href="#方法1-使用spring-boot的配置" class="headerlink" title="方法1:使用spring boot的配置"></a>方法1:使用spring boot的配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">database:</span> <br>    <span class="hljs-attr">host:</span><br>    <span class="hljs-attr">port:</span><br>    <span class="hljs-attr">password:</span><br>    <span class="hljs-attr">ssl:</span> <br>    <span class="hljs-attr">timeout:</span><br>    <span class="hljs-attr">cluster:</span><br>      <span class="hljs-attr">nodes:</span><br>    <span class="hljs-attr">sentinel:</span><br>      <span class="hljs-attr">master:</span><br>      <span class="hljs-attr">nodes:</span><br></code></pre></td></tr></table></figure><h3 id="方法2-使用redisson的配置"><a href="#方法2-使用redisson的配置" class="headerlink" title="方法2: 使用redisson的配置"></a>方法2: 使用redisson的配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>   <span class="hljs-attr">redisson:</span> <br>      <span class="hljs-attr">file:</span> <span class="hljs-string">classpath:redisson.yaml</span><br>      <span class="hljs-attr">config:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        clusterServersConfig:</span><br><span class="hljs-string">          idleConnectionTimeout: 10000</span><br><span class="hljs-string">          connectTimeout: 10000</span><br><span class="hljs-string">          timeout: 3000</span><br><span class="hljs-string">          retryAttempts: 3</span><br><span class="hljs-string">          retryInterval: 1500</span><br><span class="hljs-string">          failedSlaveReconnectionInterval: 3000</span><br><span class="hljs-string">          failedSlaveCheckInterval: 60000</span><br><span class="hljs-string">          password: null</span><br><span class="hljs-string">          subscriptionsPerConnection: 5</span><br><span class="hljs-string">          clientName: null</span><br><span class="hljs-string">          loadBalancer: !&lt;org.redisson.connection.balancer.RoundRobinLoadBalancer&gt; &#123;&#125;</span><br><span class="hljs-string">          subscriptionConnectionMinimumIdleSize: 1</span><br><span class="hljs-string">          subscriptionConnectionPoolSize: 50</span><br><span class="hljs-string">          slaveConnectionMinimumIdleSize: 24</span><br><span class="hljs-string">          slaveConnectionPoolSize: 64</span><br><span class="hljs-string">          masterConnectionMinimumIdleSize: 24</span><br><span class="hljs-string">          masterConnectionPoolSize: 64</span><br><span class="hljs-string">          readMode: &quot;SLAVE&quot;</span><br><span class="hljs-string">          subscriptionMode: &quot;SLAVE&quot;</span><br><span class="hljs-string">          nodeAddresses:</span><br><span class="hljs-string">          - &quot;redis://127.0.0.1:7004&quot;</span><br><span class="hljs-string">          - &quot;redis://127.0.0.1:7001&quot;</span><br><span class="hljs-string">          - &quot;redis://127.0.0.1:7000&quot;</span><br><span class="hljs-string">          scanInterval: 1000</span><br><span class="hljs-string">          pingConnectionInterval: 0</span><br><span class="hljs-string">          keepAlive: false</span><br><span class="hljs-string">          tcpNoDelay: false</span><br><span class="hljs-string">        threads: 16</span><br><span class="hljs-string">        nettyThreads: 32</span><br><span class="hljs-string">        codec: !&lt;org.redisson.codec.MarshallingCodec&gt; &#123;&#125;</span><br><span class="hljs-string">        transportMode: &quot;NIO&quot;</span><br></code></pre></td></tr></table></figure><h2 id="可用的spring-bean"><a href="#可用的spring-bean" class="headerlink" title="可用的spring bean"></a>可用的spring bean</h2><ul><li><code>RedissonClient</code></li><li><code>RedissonRxClient</code></li><li><code>RedissonReactiveClient</code></li><li><code>RedisTemplate</code></li><li><code>ReactiveRedisTemplate</code></li></ul><h2 id="单机配置及使用"><a href="#单机配置及使用" class="headerlink" title="单机配置及使用"></a>单机配置及使用</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">database:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.158</span><span class="hljs-number">.137</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">ssl:</span> <span class="hljs-string">ture</span><br>    <span class="hljs-attr">timeout:</span> <span class="hljs-number">3000</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RedissonClient redissonClient;<br><br>    <span class="hljs-type">RLock</span> <span class="hljs-variable">rLock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">&quot;lock1&quot;</span>);<br>    rLock.lock();<br>    <span class="hljs-comment">// do something</span><br>    rLock.unlock();<br></code></pre></td></tr></table></figure><h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">getLock时使用的是RedissonLock<br>rLock.lock();<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        lock(-<span class="hljs-number">1</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Long</span> <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> tryAcquire(-<span class="hljs-number">1</span>, leaseTime, unit, threadId);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> &lt;T&gt; RFuture&lt;Long&gt; <span class="hljs-title function_">tryAcquireAsync</span><span class="hljs-params">(<span class="hljs-type">long</span> waitTime, <span class="hljs-type">long</span> leaseTime, TimeUnit unit, <span class="hljs-type">long</span> threadId)</span> &#123;<br>    RFuture&lt;Long&gt; ttlRemainingFuture;<br>    <span class="hljs-keyword">if</span> (leaseTime &gt; <span class="hljs-number">0</span>) &#123;<br>        ttlRemainingFuture = tryLockInnerAsync(waitTime, leaseTime, unit, threadId, RedisCommands.EVAL_LONG);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        ttlRemainingFuture = tryLockInnerAsync(waitTime, internalLockLeaseTime,<br>                TimeUnit.MILLISECONDS, threadId, RedisCommands.EVAL_LONG);<br>    &#125;<br>    CompletionStage&lt;Long&gt; f = ttlRemainingFuture.thenApply(ttlRemaining -&gt; &#123;<br>        <span class="hljs-comment">// lock acquired</span><br>        <span class="hljs-keyword">if</span> (ttlRemaining == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (leaseTime &gt; <span class="hljs-number">0</span>) &#123;<br>                internalLockLeaseTime = unit.toMillis(leaseTime);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              <span class="hljs-comment">// 续期操作</span><br>                scheduleExpirationRenewal(threadId);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ttlRemaining;<br>    &#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFutureWrapper</span>&lt;&gt;(f);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleExpirationRenewal</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId)</span> &#123;<br>    <span class="hljs-type">ExpirationEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExpirationEntry</span>();<br>    <span class="hljs-type">ExpirationEntry</span> <span class="hljs-variable">oldEntry</span> <span class="hljs-operator">=</span> EXPIRATION_RENEWAL_MAP.putIfAbsent(getEntryName(), entry);<br>    <span class="hljs-keyword">if</span> (oldEntry != <span class="hljs-literal">null</span>) &#123;<br>        oldEntry.addThreadId(threadId);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        entry.addThreadId(threadId);<br>        <span class="hljs-keyword">try</span> &#123;<br>            renewExpiration();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (Thread.currentThread().isInterrupted()) &#123;<br>                cancelExpirationRenewal(threadId);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">renewExpiration</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ExpirationEntry</span> <span class="hljs-variable">ee</span> <span class="hljs-operator">=</span> EXPIRATION_RENEWAL_MAP.get(getEntryName());<br>        <span class="hljs-keyword">if</span> (ee == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <br>        <span class="hljs-type">Timeout</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> commandExecutor.getConnectionManager().newTimeout(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TimerTask</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">(Timeout timeout)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                <span class="hljs-type">ExpirationEntry</span> <span class="hljs-variable">ent</span> <span class="hljs-operator">=</span> EXPIRATION_RENEWAL_MAP.get(getEntryName());<br>                <span class="hljs-keyword">if</span> (ent == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                <span class="hljs-type">Long</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> ent.getFirstThreadId();<br>                <span class="hljs-keyword">if</span> (threadId == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                <br>                CompletionStage&lt;Boolean&gt; future = renewExpirationAsync(threadId);<br>                future.whenComplete((res, e) -&gt; &#123;<br>                    <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) &#123;<br>                        log.error(<span class="hljs-string">&quot;Can&#x27;t update lock &quot;</span> + getRawName() + <span class="hljs-string">&quot; expiration&quot;</span>, e);<br>                        EXPIRATION_RENEWAL_MAP.remove(getEntryName());<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    <br>                    <span class="hljs-keyword">if</span> (res) &#123;<br>                        <span class="hljs-comment">// reschedule itself</span><br>                        renewExpiration();<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        cancelExpirationRenewal(<span class="hljs-literal">null</span>);<br>                    &#125;<br>                &#125;);<br>            &#125;<br>        &#125;, internalLockLeaseTime / <span class="hljs-number">3</span>, TimeUnit.MILLISECONDS);<br>        <br>        ee.setTimeout(task);<br>    &#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>缓存雪崩与缓存击穿与缓存穿透</title>
    <link href="/2022/05/17/redis/%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%E4%B8%8E%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E4%B8%8E%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F/"/>
    <url>/2022/05/17/redis/%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%E4%B8%8E%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E4%B8%8E%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h1><p>Mysql 做数据库   redis做缓存</p><h1 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h1><h2 id="什么是缓存击穿"><a href="#什么是缓存击穿" class="headerlink" title="什么是缓存击穿"></a>什么是缓存击穿</h2><p>单个key过期，高并发访问这个key, 高并发直接访问数据库。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h3><p>只让一个请求去访问数据库</p><h1 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h1><h2 id="什么是缓存穿透"><a href="#什么是缓存穿透" class="headerlink" title="什么是缓存穿透"></a>什么是缓存穿透</h2><p>简单描述：从业务接收查询的是你系统根本不存在的数据</p><p>复杂描述：缓存穿透是指用户查询数据，在数据库没有，自然在缓存中也不会有。这样就导致用户查询的时候， 在缓存中找不到对应key的value，每次都要去数据库再查询一遍，然后返回空(相当于进行了两次 无用的查询)。这样请求就绕过缓存直接查数据库</p><h2 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="采用布隆过滤器BloomFilter"><a href="#采用布隆过滤器BloomFilter" class="headerlink" title="采用布隆过滤器BloomFilter"></a>采用布隆过滤器BloomFilter</h3><p>将所有可能存在的数据哈希到一个足够大的 bitmap 中，一个一定不存在的数据会被这个 bitmap 拦截掉，从而避免了对底层存储系统的查询压力。</p><p><strong>要提前把数据放到布隆过滤器中。</strong></p><h3 id="缓存空值"><a href="#缓存空值" class="headerlink" title="缓存空值"></a>缓存空值</h3><p>如果一个查询返回的数据为空(不管是数据不存在，还是系统故障)我们仍然把这个空结果进行缓存，但它的过期时间会很短，最长不超过五分钟。 通过这个直接设置的默认值存放到缓存，这样第二次到缓冲中获取就有值了，而不会继续访问数据库。</p><h1 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h1><h2 id="什么是缓存雪崩"><a href="#什么是缓存雪崩" class="headerlink" title="什么是缓存雪崩"></a>什么是缓存雪崩</h2><p>如果缓存集中在一段时间内失效，发生大量的缓存穿透，所有的查询都落在数据库上，造成了缓存雪崩。 由于原有缓存失效，新缓存未到期间所有原本应该访问缓存的请求都去查询数据库了，而对数据库CPU 和内存造成巨大压力，严重的会造成数据库宕机</p><h2 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="分布式锁-1"><a href="#分布式锁-1" class="headerlink" title="分布式锁"></a>分布式锁</h3><p>击穿的解决方案。让一个请求去数据库里查，其他的等待。</p><h3 id="数据预热"><a href="#数据预热" class="headerlink" title="数据预热"></a>数据预热</h3><p>缓存预热就是系统上线后，将相关的缓存数据直接加载到缓存系统。这样就可以避免在用户请求的时候，先查询数据库，然后再将数据缓存的问题。用户直接查询事先被预热的缓存数据。可以通过缓存刷新机制，预先去更新缓存，再即将发生大并发访问前手动触发加载缓存不同的key。</p><h3 id="双层缓存策略"><a href="#双层缓存策略" class="headerlink" title="双层缓存策略"></a>双层缓存策略</h3><p>C1为原始缓存，C2为拷贝缓存，C1失效时，可以访问C2，C1缓存失效时间设置为短期，C2设置为长期。</p><h3 id="定时更新缓存策略"><a href="#定时更新缓存策略" class="headerlink" title="定时更新缓存策略"></a>定时更新缓存策略</h3><p>失效性要求不高的缓存，容器启动初始化加载，采用定时任务更新或移除缓存。</p><h3 id="设置不同的过期时间"><a href="#设置不同的过期时间" class="headerlink" title="设置不同的过期时间"></a>设置不同的过期时间</h3><p>设置不同的过期时间，让缓存失效的时间点尽量均匀</p>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux配置多个ip地址</title>
    <link href="/2022/05/14/linux/linux%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AAip%E5%9C%B0%E5%9D%80/"/>
    <url>/2022/05/14/linux/linux%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AAip%E5%9C%B0%E5%9D%80/</url>
    
    <content type="html"><![CDATA[<h3 id="配置多个ip地址"><a href="#配置多个ip地址" class="headerlink" title="配置多个ip地址"></a>配置多个ip地址</h3><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /etc/sysconfig/network-scripts/<br><span class="hljs-built_in">cp</span> ifcfg-ens160 ifcfg-ens160:1<br></code></pre></td></tr></table></figure><p>编辑：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh">TYPE=Ethernet<br>PROXY_METHOD=none<br>BROWSER_ONLY=no<br>BOOTPROTO=static<br>DEFROUTE=<span class="hljs-built_in">yes</span><br>IPV4_FAILURE_FATAL=no<br>IPV6INIT=<span class="hljs-built_in">yes</span><br>IPV6_AUTOCONF=<span class="hljs-built_in">yes</span><br>IPV6_DEFROUTE=<span class="hljs-built_in">yes</span><br>IPV6_FAILURE_FATAL=no<br>NAME=ens160:1<br>DEVICE=ens160:1<br>ONBOOT=<span class="hljs-built_in">yes</span><br>IPADDR=192.168.158.135<br>PREFIX=24<br>GATEWAY=192.168.158.2<br>DNS1=192.168.158.2<br>IPV6_PRIVACY=no<br></code></pre></td></tr></table></figure><p>主要修改：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#这两个名称和文件名称一样</span><br>NAME=ens160:1<br>DEVICE=ens160:1<br><span class="hljs-comment"># ip 地址</span><br>IPADDR=192.168.158.135<br></code></pre></td></tr></table></figure><p>重启网卡服务：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">systemctl restart network<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java原始命令打jar包及idea打jar包</title>
    <link href="/2022/05/12/java/java%E5%8E%9F%E5%A7%8B%E5%91%BD%E4%BB%A4%E6%89%93jar%E5%8C%85%E5%8F%8Aidea%E6%89%93jar%E5%8C%85/"/>
    <url>/2022/05/12/java/java%E5%8E%9F%E5%A7%8B%E5%91%BD%E4%BB%A4%E6%89%93jar%E5%8C%85%E5%8F%8Aidea%E6%89%93jar%E5%8C%85/</url>
    
    <content type="html"><![CDATA[<h2 id="原始命令打jar包"><a href="#原始命令打jar包" class="headerlink" title="原始命令打jar包"></a>原始命令打jar包</h2><h3 id="简述："><a href="#简述：" class="headerlink" title="简述："></a>简述：</h3><p>jar包（文件）就是 Java Archive File（Java档案[归档]文件），是 Java 的一种文件格式，可将多个文件组合成一个文件。一个JAR文件由一系列采用Zip压缩格式的文件构成，同时还有一张“清单（Manifest）”，对所有这些文件进行了描述。JDK提供的许多类，也是以jar包的形式提供的。<br>jar包用于部署和封装库、组件和插件程序，并可被像编译器和 JVM 这样的工具直接使用。jar文件中有一个特定目录——META-INF，其中包含特殊的文件——MANIFEST.MF，用来定义扩展与档案打包相关数据信息，运行时向JVM提供应用程序的有关数据信息。</p><p>清单（Manifest）文件格式规则：</p><p>1.文件中的内容以键值对的形式出现，键值对之间采用”冒号和空格”进行分隔(注意：冒号后的空格必须有，不然格式有错误).</p><p>2.每行最多72个字符，换行继续必须以空格开头 。</p><p>3.Class-Path指定引用jar包的目录。调用多个jar时，每一个用空格（由一个或多个空格）隔开，不是逗号或分号，一行写不下（超过72个字符），从第二行开始，每行开头要至少一个空格。如：</p><p>Class-Path: lib&#x2F;tools.jar lib&#x2F;guava-r09.jar lib&#x2F;guice-2.0.jar </p><p> lib&#x2F;jakarta.commons.lang-2.2.jar</p><ol start="4"><li>文件的最后必需要空行，而且必须顶格。</li></ol><p>官网说明：<a href="https://docs.oracle.com/en/java/javase/18/docs/specs/jar/jar.html">https://docs.oracle.com/en/java/javase/18/docs/specs/jar/jar.html</a></p><p>jar 命令的一些说明：jar -h</p><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">用法: jar [OPTION...] [ [--release VERSION] [-C <span class="hljs-built_in">dir</span>] files] ...<br>jar 创建类和资源的档案, 并且可以处理档案中的<br>单个类或资源或者从档案中还原单个类或资源。<br><br> 示例:<br> <span class="hljs-comment"># 创建包含两个类文件的名为 classes.jar 的档案:</span><br> jar --create --file classes.jar Foo.class Bar.class<br> <span class="hljs-comment"># 使用现有的清单创建档案, 其中包含 foo/ 中的所有文件:</span><br> jar --create --file classes.jar --manifest mymanifest -C foo/ .<br> <span class="hljs-comment"># 创建模块化 jar 档案, 其中模块描述符位于</span><br> <span class="hljs-comment"># classes/module-info.class:</span><br> jar --create --file foo.jar --main-class com.foo.Main --module-version 1.0<br>     -C foo/ classes resources<br> <span class="hljs-comment"># 将现有的非模块化 jar 更新为模块化 jar:</span><br> jar --update --file foo.jar --main-class com.foo.Main --module-version 1.0<br>     -C foo/ module-info.class<br> <span class="hljs-comment"># 创建包含多个发行版的 jar, 并将一些文件放在 META-INF/versions/9 目录中:</span><br> jar --create --file mr.jar -C foo classes --release 9 -C foo9 classes<br><br>要缩短或简化 jar 命令, 可以在单独的文本文件中指定参数,<br>并使用 @ 符号作为前缀将此文件传递给 jar 命令。<br><br> 示例:<br> <span class="hljs-comment"># 从文件 classes.list 读取附加选项和类文件列表</span><br> jar --create --file my.jar @classes.list<br><br><br> 主操作模式:<br><br>  -c, --create               创建档案<br>  -i, --generate-index=FILE  为指定的 jar 档案生成<br>                             索引信息<br>  -t, --list                 列出档案的目录<br>  -u, --update               更新现有 jar 档案<br>  -x, --extract              从档案中提取指定的 (或全部) 文件<br>  -d, --describe-module      输出模块描述符或自动模块名称<br><br> 在任意模式下有效的操作修饰符:<br><br>  -C DIR                     更改为指定的目录并包含<br>                             以下文件<br>  -f, --file=FILE            档案文件名。省略时, 基于操作<br>                             使用 stdin 或 stdout<br>      --release VERSION      将下面的所有文件都放在<br>                             jar 的版本化目录中 (即 META-INF/versions/VERSION/)<br>  -v, --verbose              在标准输出中生成详细输出<br><br> 在创建和更新模式下有效的操作修饰符:<br><br>  -e, --main-class=CLASSNAME 捆绑到模块化或可执行 <br>                             jar 档案的独立应用程序<br>                             的应用程序入口点<br>  -m, --manifest=FILE        包含指定清单文件中的<br>                             清单信息<br>  -M, --no-manifest          不为条目创建清单文件<br>      --module-version=VERSION    创建模块化 jar 或更新<br>                             非模块化 jar 时的模块版本<br>      --hash-modules=PATTERN 计算和记录模块的散列, <br>                             这些模块按指定模式匹配并直接或<br>                             间接依赖于所创建的模块化 jar 或<br>                             所更新的非模块化 jar<br>  -p, --module-path          模块被依赖对象的位置, 用于生成<br>                             散列<br><br> 只在创建, 更新和生成索引模式下有效的操作修饰符:<br><br>  -0, --no-compress          仅存储; 不使用 ZIP 压缩<br><br> 其他选项:<br><br>  -?, -h, --<span class="hljs-built_in">help</span>[:compat]    提供此帮助，也可以选择性地提供兼容性帮助<br>      --help-extra           提供额外选项的帮助<br>      --version              输出程序版本<br><br> 如果模块描述符 <span class="hljs-string">&#x27;module-info.class&#x27;</span> 位于指定目录的<br> 根目录中, 或者位于 jar 档案本身的根目录中, 则<br> 该档案是一个模块化 jar。以下操作只在创建模块化 jar,<br> 或更新现有的非模块化 jar 时有效: <span class="hljs-string">&#x27;--module-version&#x27;</span>,<br> <span class="hljs-string">&#x27;--hash-modules&#x27;</span> 和 <span class="hljs-string">&#x27;--module-path&#x27;</span>。<br><br> 如果为长选项提供了必需参数或可选参数, 则它们对于<br> 任何对应的短选项也是必需或可选的。<br></code></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>创建文件夹test-jar</p><p>在test-jar下创建lib文件夹并把fastjson-1.2.78.jar放到lib目录下。</p><p>创建User.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    String id;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(String id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(String id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>创建Main.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(JSONObject.toJSONString(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;testUser&quot;</span>)));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>java -c Main.java</p><p>Java -c User.java</p><p>新建一个文件myapplication.mf</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Manifest-Version: <span class="hljs-number">1.0</span><br>Created-By: <span class="hljs-number">11.0</span><span class="hljs-number">.15</span> (Azul Systems, Inc.)<br>Main-Class: Main<br>Class-Path: lib/fastjson-<span class="hljs-number">1.2</span><span class="hljs-number">.78</span>.jar<br></code></pre></td></tr></table></figure><p>新建一个文件夹out,并把Main.class、user.class和lib文件复制到out文件夹下</p><p>打包：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> test-jar/<br>jar --create --verbose --file test-jar.jar --manifest myapplication.mf -C ./out/ .<br></code></pre></td></tr></table></figure><p>执行：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">java -jar test-jar.jar<br></code></pre></td></tr></table></figure><h2 id="使用idea打包"><a href="#使用idea打包" class="headerlink" title="使用idea打包"></a>使用idea打包</h2><p>英文：</p><p>​File  -&gt; Project Structure -&gt; artifacts -&gt; +  -&gt; jar -&gt; from modules -&gt;选主类和第一个单选按钮 -&gt;确定后会生成Manifest文件</p><p>生成：</p><p>​菜单栏build   -&gt; build artifacts -&gt;build</p><p>执行：</p><p>​java -jar test-jar.jar</p><p>中文：</p><p>​文件  -&gt; 项目结构  -&gt;  工件  -&gt; + -&gt; jar - &gt; 来自具有依赖项的模块  -&gt; 主类  +  提取到目标jar  -&gt; 确定后会生成Manifest文件</p><p>生成：</p><p>​构建  -&gt;   构建工件  -&gt; 构建</p><h2 id="使用maven打jar包"><a href="#使用maven打jar包" class="headerlink" title="使用maven打jar包"></a>使用maven打jar包</h2><h3 id="方法1"><a href="#方法1" class="headerlink" title="方法1:"></a>方法1:</h3><p>1.在pom.xml中添加如下配置；</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.5.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">archive</span>&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>EchoServer<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span><br>                      <span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br>                  <span class="hljs-tag">&lt;/<span class="hljs-name">archive</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">descriptorRefs</span>&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">descriptorRef</span>&gt;</span><br>                  <span class="hljs-tag">&lt;/<span class="hljs-name">descriptorRefs</span>&gt;</span><br>              <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><p>2.点击maven project（右边栏）-&gt;选择Plugins-&gt;选择assembly-&gt;点击assembly:assembly</p><p>3.执行 java -jar test-netty-1.0-SNAPSHOT-jar-with-dependencies.jar</p><h3 id="方法2："><a href="#方法2：" class="headerlink" title="方法2："></a>方法2：</h3><p>1.在pom.xml中添加如下配置；</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-shade-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>package<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>shade<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">transformers</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">transformer</span> <span class="hljs-attr">implementation</span>=<span class="hljs-string">&quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>EchoServer<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">transformer</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">transformers</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>maven clean   并且 maven package</li><li>java -jar test-netty-1.0-SNAPSHOT.jar</li></ol>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java获取本机IP地址</title>
    <link href="/2022/05/11/java/java%E8%8E%B7%E5%8F%96%E6%9C%AC%E6%9C%BAIP%E5%9C%B0%E5%9D%80/"/>
    <url>/2022/05/11/java/java%E8%8E%B7%E5%8F%96%E6%9C%AC%E6%9C%BAIP%E5%9C%B0%E5%9D%80/</url>
    
    <content type="html"><![CDATA[<h2 id="规则"><a href="#规则" class="headerlink" title="规则"></a>规则</h2><p>127.xxx.xxx.xxx 属于 “loopback” 地址，即只能你自己的本机可见，就是本机地址，比较常见的有 127.0.0.1<br>192.168.xxx.xxx 属于 private 私有地址 (site local address)，属于本地组织内部访问，只能在本地局域网可见<br>同样 10.xxx.xxx.xxx、从 172.16.xxx.xxx 到172.31.xxx.xxx 都是私有地址，也是属于组织内部访问<br>169.254.xxx.xxx 属于连接本地地址（link local IP），在单独网段可用<br>从 224.xxx.xxx.xxx 到 239.xxx.xxx.xxx 属于组播地址<br>比较特殊的 255.255.255.255 属于广播地址<br>除此之外的地址就是点对点的可用的公开 IPv4 地址</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> org.springframework.util.ObjectUtils;<br><br><span class="hljs-keyword">import</span> java.net.*;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.Enumeration;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Optional;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取本机IP 地址</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 127.xxx.xxx.xxx 属于 “loopback” 地址，即只能你自己的本机可见，就是本机地址，比较常见的有 127.0.0.1</span><br><span class="hljs-comment"> * 192.168.xxx.xxx 属于 private 私有地址 (site local address)，属于本地组织内部访问，只能在本地局域网可见</span><br><span class="hljs-comment"> * 同样 10.xxx.xxx.xxx、从 172.16.xxx.xxx 到172.31.xxx.xxx 都是私有地址，也是属于组织内部访问</span><br><span class="hljs-comment"> * 169.254.xxx.xxx 属于连接本地地址（link local IP），在单独网段可用</span><br><span class="hljs-comment"> * 从 224.xxx.xxx.xxx 到 239.xxx.xxx.xxx 属于组播地址</span><br><span class="hljs-comment"> * 比较特殊的 255.255.255.255 属于广播地址</span><br><span class="hljs-comment"> * 除此之外的地址就是点对点的可用的公开 IPv4 地址</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> dingwen</span><br><span class="hljs-comment"> * 2021.04.28 11:49</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IpUtil</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> SocketException &#123;<br>        System.out.println( IpUtil.getLocalIp4Address().get().toString().replaceAll(<span class="hljs-string">&quot;/&quot;</span>,<span class="hljs-string">&quot;&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 获取本机所有网卡信息   得到所有IP信息</span><br><span class="hljs-comment">     * @return Inet4Address&gt;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;Inet4Address&gt; <span class="hljs-title function_">getLocalIp4AddressFromNetworkInterface</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SocketException &#123;<br>        List&lt;Inet4Address&gt; addresses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-number">1</span>);<br><br>        <span class="hljs-comment">// 所有网络接口信息</span><br>        Enumeration&lt;NetworkInterface&gt; networkInterfaces = NetworkInterface.getNetworkInterfaces();<br>        <span class="hljs-keyword">if</span> (ObjectUtils.isEmpty(networkInterfaces)) &#123;<br>            <span class="hljs-keyword">return</span> addresses;<br>        &#125;<br>        <span class="hljs-keyword">while</span> (networkInterfaces.hasMoreElements()) &#123;<br>            <span class="hljs-type">NetworkInterface</span> <span class="hljs-variable">networkInterface</span> <span class="hljs-operator">=</span> networkInterfaces.nextElement();<br>            <span class="hljs-comment">//滤回环网卡、点对点网卡、非活动网卡、虚拟网卡并要求网卡名字是eth或ens开头</span><br>            <span class="hljs-keyword">if</span> (!isValidInterface(networkInterface)) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// 所有网络接口的IP地址信息</span><br>            Enumeration&lt;InetAddress&gt; inetAddresses = networkInterface.getInetAddresses();<br>            <span class="hljs-keyword">while</span> (inetAddresses.hasMoreElements()) &#123;<br>                <span class="hljs-type">InetAddress</span> <span class="hljs-variable">inetAddress</span> <span class="hljs-operator">=</span> inetAddresses.nextElement();<br>                <span class="hljs-comment">// 判断是否是IPv4，并且内网地址并过滤回环地址.</span><br>                <span class="hljs-keyword">if</span> (isValidAddress(inetAddress)) &#123;<br>                    addresses.add((Inet4Address) inetAddress);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> addresses;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 过滤回环网卡、点对点网卡、非活动网卡、虚拟网卡并要求网卡名字是eth或ens开头</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ni 网卡</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 如果满足要求则true，否则false</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidInterface</span><span class="hljs-params">(NetworkInterface ni)</span> <span class="hljs-keyword">throws</span> SocketException &#123;<br>        <span class="hljs-keyword">return</span> !ni.isLoopback() &amp;&amp; !ni.isPointToPoint() &amp;&amp; ni.isUp() &amp;&amp; !ni.isVirtual()<br>                &amp;&amp; (ni.getName().startsWith(<span class="hljs-string">&quot;eth&quot;</span>) || ni.getName().startsWith(<span class="hljs-string">&quot;en&quot;</span>) || ni.getName().startsWith(<span class="hljs-string">&quot;ens&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 判断是否是IPv4，并且内网地址并过滤回环地址.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidAddress</span><span class="hljs-params">(InetAddress address)</span> &#123;<br>        <span class="hljs-keyword">return</span> address <span class="hljs-keyword">instanceof</span> Inet4Address &amp;&amp; address.isSiteLocalAddress() &amp;&amp; !address.isLoopbackAddress();<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 通过Socket 唯一确定一个IP</span><br><span class="hljs-comment">     * 当有多个网卡的时候，使用这种方式一般都可以得到想要的IP。甚至不要求外网地址8.8.8.8是可连通的</span><br><span class="hljs-comment">     * @return Inet4Address&gt;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Optional&lt;Inet4Address&gt; <span class="hljs-title function_">getIpBySocket</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SocketException &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-keyword">final</span> <span class="hljs-type">DatagramSocket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatagramSocket</span>()) &#123;<br>            socket.connect(InetAddress.getByName(<span class="hljs-string">&quot;8.8.8.8&quot;</span>), <span class="hljs-number">10002</span>);<br>            <span class="hljs-keyword">if</span> (socket.getLocalAddress() <span class="hljs-keyword">instanceof</span> Inet4Address) &#123;<br>                <span class="hljs-keyword">return</span> Optional.of((Inet4Address) socket.getLocalAddress());<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (UnknownHostException networkInterfaces) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(networkInterfaces);<br>        &#125;<br>        <span class="hljs-keyword">return</span> Optional.empty();<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 获取本地IPv4地址</span><br><span class="hljs-comment">     * @return Inet4Address&gt;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Optional&lt;Inet4Address&gt; <span class="hljs-title function_">getLocalIp4Address</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SocketException &#123;<br>        <span class="hljs-keyword">final</span> List&lt;Inet4Address&gt; inet4Addresses = getLocalIp4AddressFromNetworkInterface();<br>        <span class="hljs-keyword">if</span> (inet4Addresses.size() != <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">final</span> Optional&lt;Inet4Address&gt; ipBySocketOpt = getIpBySocket();<br>            <span class="hljs-keyword">if</span> (ipBySocketOpt.isPresent()) &#123;<br>                <span class="hljs-keyword">return</span> ipBySocketOpt;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> inet4Addresses.isEmpty() ? Optional.empty() : Optional.of(inet4Addresses.get(<span class="hljs-number">0</span>));<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> Optional.of(inet4Addresses.get(<span class="hljs-number">0</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nginx功能介绍及配置解析</title>
    <link href="/2022/05/10/linux/nginx%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D%E5%8F%8A%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90/"/>
    <url>/2022/05/10/linux/nginx%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D%E5%8F%8A%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h2><p><a href="http://tengine.taobao.org/book/chapter_02.html">http://tengine.taobao.org/book/chapter_02.html</a> Nginx开发从入门到精通</p><p>服务器上已经有nginx。</p><h2 id="nginx-解决的问题"><a href="#nginx-解决的问题" class="headerlink" title="nginx 解决的问题"></a>nginx 解决的问题</h2><p>高并发</p><p>负载均衡</p><p>高可用</p><p>虚拟主机</p><p>伪静态</p><p>动静分离</p><h2 id="高并发"><a href="#高并发" class="headerlink" title="高并发"></a>高并发</h2><p>具说官方测试单台nginx可达到5万的并发。</p><h3 id="linux操作系统的配置："><a href="#linux操作系统的配置：" class="headerlink" title="linux操作系统的配置："></a>linux操作系统的配置：</h3><h4 id="file-max"><a href="#file-max" class="headerlink" title="file-max"></a>file-max</h4><p>系统总限制： cat &#x2F;proc&#x2F;sys&#x2F;fs&#x2F;file-max</p><p>这表明这台Linux系统最多允许同时打开(即包含所有用户打开文件数总和)65535个文件，是Linux系统级硬限制，所有用户级的打开文件数限制都不会超过这个数值。<br>通常这个系统级硬限制是Linux系统在启动时根据系统硬件资源状况计算出来的最佳的最大同时打开文件数限制。</p><p>当前使用句柄数：cat &#x2F;proc&#x2F;sys&#x2F;fs&#x2F;file-nr</p><p>都是临时修改：</p><p>方法1：</p><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">echo</span>  6553560 &gt; /proc/sys/fs/file-max<br></code></pre></td></tr></table></figure><p>方法2：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sysctl -w <span class="hljs-string">&quot;fs.file-max=34166&quot;</span><br></code></pre></td></tr></table></figure><p>方法3：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;fs.file-max = 6553560&quot;</span> &gt;&gt; /etc/sysctl.conf<br>sysctl -p <br></code></pre></td></tr></table></figure><p>网上都是方法3可以永久修改，我重启后还不是，还是以前的。</p><h4 id="ulimit-n"><a href="#ulimit-n" class="headerlink" title="ulimit -n"></a>ulimit -n</h4><p>Linux系统用户进程最大打开的文件限制</p><p>但是linux的root用户比较特别，一般系统安装软件为了对软件或文件的访问权限会创建用户，测试时也使用新建的用户测试。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">ulimit</span> -n <br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">ulimit</span> -Sn   <span class="hljs-comment">#检查 Linux 中的软限制</span><br><span class="hljs-built_in">ulimit</span> -Hn <span class="hljs-comment">#在 Linux 中检查硬限制</span><br></code></pre></td></tr></table></figure><p>修改(临时生效，当前sessioin(终端))：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">ulimit</span> -SHn 1000<br></code></pre></td></tr></table></figure><p>永久修改：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/security/limits.conf<br><span class="hljs-comment"># 格式如下</span><br><span class="hljs-comment">#&lt;domain&gt;        &lt;type&gt;  &lt;item&gt;  &lt;value&gt;</span><br>用户名 hard nofile 4096<br>用户名 soft nofile 1024<br><br>保存后重启<br></code></pre></td></tr></table></figure><h3 id="Nginx-conf的参数："><a href="#Nginx-conf的参数：" class="headerlink" title="Nginx.conf的参数："></a>Nginx.conf的参数：</h3><p>建议设置为等于CPU总核心数。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">worker_processes  8<br></code></pre></td></tr></table></figure><p>单个worker进程最大打开的连接数</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">events &#123;<br>    worker_connections  1024;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">events<br>&#123;<br>  <span class="hljs-comment">#参考事件模型，use [ kqueue | rtsig | epoll | /dev/poll | select | poll ]; </span><br>  <span class="hljs-comment">#epoll模型是Linux 2.6以上版本内核中的高性能网络I/O模型，如果跑在FreeBSD上面，就用kqueue模型。</span><br>  use epoll;<br>  <span class="hljs-comment">#单个进程最大连接数</span><br>  worker_connections 1024;<br>&#125;<br></code></pre></td></tr></table></figure><p>每个进程的最大文件打开数:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">worker_rlimit_nofile 65535;  <span class="hljs-comment"># 一般等于ulimit -n系统值</span><br></code></pre></td></tr></table></figure><p>并发总数是 worker_processes 和 worker_connections 的乘积，即 max_clients &#x3D; worker_processes * worker_connections。</p><h2 id="七层负载均衡"><a href="#七层负载均衡" class="headerlink" title="七层负载均衡"></a>七层负载均衡</h2><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>在192.168.158.137和192.168.158.138启动tomcat,并开放8080端口。</p><p>在http模块加入</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh">   upstream tomcat &#123;<br>           server 192.168.158.137:8080;<br>           server 192.168.158.138:8080;<br>   &#125;<br><br>  server &#123;<br>         listen       80;<br>         server_name  localhost;<br><br>       location / &#123;<br>         proxy_pass http://tomcat;<span class="hljs-comment">#请求转向taishan定义的服务器列表</span><br>         proxy_set_header Host <span class="hljs-variable">$host</span>;<span class="hljs-comment">#将请求头转发给后端服务器</span><br>         proxy_set_header X-Forward-For <span class="hljs-variable">$remote_addr</span>;<span class="hljs-comment">#后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span><br>       &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>访问<a href="http://192.168.158.136/test/test01">http://192.168.158.136/test/test01</a></p><h4 id="配置解析"><a href="#配置解析" class="headerlink" title="配置解析"></a>配置解析</h4><h5 id="负载均衡算法"><a href="#负载均衡算法" class="headerlink" title="负载均衡算法"></a>负载均衡算法</h5><p>轮询配置：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">upstream tomcat &#123;<br>  server 192.168.158.137:8080;<br>  server 192.168.158.138:8080;<br>&#125;<br></code></pre></td></tr></table></figure><p>访问<a href="http://192.168.158.136/test/test01%EF%BC%8Ctest01%E6%96%B9%E6%B3%95%E8%BF%94%E5%9B%9E%E6%9C%AC%E6%9C%BAIP">http://192.168.158.136/test/test01，test01方法返回本机IP</a></p><p>权重配置：weight和访问比率成正比，用于后端服务器性能不均的情况。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">upstream tomcat &#123;<br>  server 192.168.158.137:8080 weight=1;<br>  server 192.168.158.138:8080 weight=3;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试方法同轮询。</p><p>轮询和权重配置算法：如果后端是tomcat并且使用的是服务器session时，登录信息丢失。</p><p>iphash配置：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">upstream tomcat &#123;<br>ip_hash;<br>  server 192.168.158.137:8080;<br>  server 192.168.158.138:8080;<br>&#125;<br></code></pre></td></tr></table></figure><p>在java的contoller里增加：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;login&quot;)</span><br><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">login</span><span class="hljs-params">(HttpServletRequest request, <span class="hljs-meta">@RequestParam(&quot;userId&quot;)</span> String userId)</span> <span class="hljs-keyword">throws</span> SocketException &#123;<br>    <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> request.getSession();<br>    session.setAttribute(<span class="hljs-string">&quot;userId&quot;</span>, userId);<br>    Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    map.put(<span class="hljs-string">&quot;code&quot;</span>, <span class="hljs-number">200</span>);<br>    map.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;成功&quot;</span>);<br>    <span class="hljs-keyword">return</span> map;<br>&#125;<br><br><span class="hljs-meta">@GetMapping(&quot;test02&quot;)</span><br><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">test02</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> SocketException &#123;<br>    Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    map.put(<span class="hljs-string">&quot;code&quot;</span>, <span class="hljs-number">200</span>);<br>    map.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;成功&quot;</span>);<br>    map.put(<span class="hljs-string">&quot;data&quot;</span>, IpUtil.getLocalIp4Address().get().toString().replaceAll(<span class="hljs-string">&quot;/&quot;</span>,<span class="hljs-string">&quot;&quot;</span>));<br>    map.put(<span class="hljs-string">&quot;userId&quot;</span>, request.getSession().getAttribute(<span class="hljs-string">&quot;userId&quot;</span>));<br>    <span class="hljs-keyword">return</span> map;<br>&#125;<br></code></pre></td></tr></table></figure><p>先访问<a href="http://192.168.158.136/test/login?userId=1">http://192.168.158.136/test/login?userId=1</a></p><p>再访问<a href="http://192.168.158.136/test/test02">http://192.168.158.136/test/test02</a> 一直显示ip为一个，并且可以拿到userId。</p><p>urlhash配置：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">upstream tomcat &#123;<br><span class="hljs-built_in">hash</span> <span class="hljs-variable">$request_uri</span>;<br>  server 192.168.158.137:8080;<br>  server 192.168.158.138:8080;<br>&#125;<br></code></pre></td></tr></table></figure><p>复制contoler方法test01方法  分为两个&#x2F;a&#x2F;  和  &#x2F;b&#x2F;</p><p><a href="http://192.168.158.136/a/">http://192.168.158.136/a/</a></p><p><a href="http://192.168.158.136/b/">http://192.168.158.136/b/</a>  会分配到不同的tomcat上。</p><p>响应时间配置：</p><p>这个是第三方模块提供的：<a href="https://github.com/gnosek/nginx-upstream-fair">https://github.com/gnosek/nginx-upstream-fair</a></p><p>下载zip包 nginx-upstream-fair-master.zip</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">unzip nginx-upstream-fair-master.zip<br></code></pre></td></tr></table></figure><p>因为有编译安装时报错，所以修改代码：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sed -i <span class="hljs-string">&#x27;s/default_port/no_port/g&#x27;</span> ngx_http_upstream_fair_module.c<br></code></pre></td></tr></table></figure><p>nginx添加nginx-upstream-fair模块：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">./configure --prefix=/usr/local/nginx --with-http_ssl_module --add-module=/usr/local/nginx-upstream-fair-master<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">make &amp; make install<br></code></pre></td></tr></table></figure><p>nginx.conf配置：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">upstream tomcat &#123;<br>fair;<br>  server 192.168.158.137:8080;<br>  server 192.168.158.138:8080;<br>&#125;<br></code></pre></td></tr></table></figure><p>不知道 怎么测试，试过java线程的sleep。</p><h5 id="负载均衡的其他参数"><a href="#负载均衡的其他参数" class="headerlink" title="负载均衡的其他参数"></a>负载均衡的其他参数</h5><p>down 表示单前的server暂时不参与负载</p><p>weight 默认为1.    weight越大，负载的权重就越大。</p><p>max_fails：允许请求失败的次数默认为1.</p><p>fail_timeout:   max_fails次失败后，暂停的时间。</p><p>backup： 其它所有的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力 会最轻。</p><p>max_conns 可以根据服务的好坏来设置最大连接数，防止挂掉，比如1000，我们可以设置800</p><p>max_fails&#x3D;3 fail_timeout&#x3D;30s代表在30秒内请求某一应用失败3次，认为该应用宕机，后等待30秒，这期间内不会再把新请求发送到宕机应用，而是直接发到正常的那一台，时间到后再有请求进来继续尝试连接宕机应用且仅尝试1次，如果还是失败，则继续等待30秒…以此循环，直到恢复。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">upstream tomcat &#123;<br>    server 127.0.0.1:8050    weight=1  max_fails=1  fail_timeout=20;<br>    server 127.0.0.1:8060    weight=1;<br>&#125;<br></code></pre></td></tr></table></figure><p>nginx的负载均衡会自动剔除节点。</p><h4 id="默认的健康检查模块"><a href="#默认的健康检查模块" class="headerlink" title="默认的健康检查模块"></a>默认的健康检查模块</h4><p>配置一个status的location</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">location /status &#123;<br>check_status;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">upstream cluster1 &#123;<br>    server 192.168.158.137:8080;<br>    server 192.168.158.138:8080;<br>    check interval=3000 rise=2 fall=5 <span class="hljs-built_in">timeout</span>=1000 <span class="hljs-built_in">type</span>=http;<br>    check_http_send <span class="hljs-string">&quot;HEAD / HTTP/1.0\r\n\r\n&quot;</span>;<br>    check_http_expect_alive http_2xx http_3xx;<br>&#125;<br></code></pre></td></tr></table></figure><p>check 参数解析：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">Syntax: check interval=milliseconds [fall=count] [rise=count] [<span class="hljs-built_in">timeout</span>=milliseconds] [default_down=<span class="hljs-literal">true</span>|<span class="hljs-literal">false</span>] [<span class="hljs-built_in">type</span>=tcp|http|ssl_hello|mysql|ajp] [port=check_port]<br>Default: 如果没有配置参数，默认值是：interval=30000 fall=5 rise=2 <span class="hljs-built_in">timeout</span>=1000 default_down=<span class="hljs-literal">true</span> <span class="hljs-built_in">type</span>=tcp<br></code></pre></td></tr></table></figure><p>interval：向后端发送的健康检查包的间隔。</p><p>fall(fall_count): 如果连续失败次数达到fall_count，服务器就被认为是down。</p><p>rise(rise_count): 如果连续成功次数达到rise_count，服务器就被认为是up。</p><p>timeout: 后端健康请求的超时时间。</p><p>default_down: 设定初始时服务器的状态，如果是true，就说明默认是down的，如果是false，就是up的。默认值是true，也就是一开始服务器认为是不可用，要等健康检查包达到一定成功次数以后才会被认为是健康的。</p><p>type：健康检查包的类型，现在支持以下多种类型</p><p>​tcp：简单的tcp连接，如果连接成功，就说明后端正常。</p><p>​ssl_hello：发送一个初始的SSL hello包并接受服务器的SSL hello包。</p><p>​http：发送HTTP请求，通过后端的回复包的状态来判断后端是否存活。mysql: 向mysql服务器连接，通过接收服务器的greeting包来判断后端是否存活。</p><p>​ajp：向后端发送AJP协议的Cping包，通过接收Cpong包来判断后端是否存活。</p><p>port: 指定后端服务器的检查端口。可以指定不同于真实服务的后端服务器的端口，比如后端提供的是443端口的应用，你可以去检查80端口的状态来判断后端健康状况。默认是0，表示跟后端server提供真实服务的端口一样。</p><p>check_http_send：</p><p>check_http_send 配置http健康检查包发送的请求内容</p><p>为了减少传输数据量，推荐采用”HEAD”方法。当采用长连接进行健康检查时，需在该指令中添加keep-alive请求头，如：”HEAD &#x2F; HTTP&#x2F;1.1\r\nConnection: keep-alive\r\n\r\n”。同时，在采用”GET”方法的情况下，请求uri的size不宜过大，确保可以在1个interval内传输完成，否则会被健康检查模块视为后端服务器或网络异常。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">Syntax: check_http_send http_packet<br>Default: <span class="hljs-string">&quot;GET / HTTP/1.0\r\n\r\n&quot;</span><br></code></pre></td></tr></table></figure><p>check_http_expect_alive：</p><p>check_http_expect_alive 指定主动健康检查时HTTP回复的成功状态：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">Syntax: check_http_expect_alive [ http_2xx | http_3xx | http_4xx | http_5xx ]<br>Default: http_2xx | http_3xx<br></code></pre></td></tr></table></figure><h4 id="阿里的健康检查"><a href="#阿里的健康检查" class="headerlink" title="阿里的健康检查"></a>阿里的健康检查</h4><p>nginx_upstream_check_module模块（淘宝技术团队开发）</p><p><a href="https://github.com/yaoweibin/nginx_upstream_check_module">https://github.com/yaoweibin/nginx_upstream_check_module</a></p><p>nginx自带健康检查的缺陷：</p><p>Nginx只有当有访问时后，才发起对后端节点探测。<br>如果本次请求中，节点正好出现故障，Nginx依然将请求转交给故障的节点,然后再转交给健康的节点处理。所以不会影响到这次请求的正常进行。但是会影响效率,因为多了一次转发<br>自带模块无法做到预警<br>被动健康检查</p><p>使用第三访模块nginx_upstream_check_module：</p><p>区别于nginx自带的非主动式的心跳检测，淘宝开发的tengine自带了一个提供主动式后端服务器心跳检测模块<br>若健康检查包类型为http，在开启健康检查功能后，nginx会根据设置的间隔向指定的后端服务器端口发送健康检查包，并根据期望的HTTP回复状态码来判断服务是否健康。<br>后端真实节点不可用，则请求不会转发到故障节点<br>故障节点恢复后，请求正常转发</p><h3 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h3><p>nginx 可以用keepalived 实现。如果是云服务器如阿里云，是不让你装keepalived的，只能买他的(负载均衡)slb服务。</p><p>如果是nginx后的后台服务，由nginx的健康检查和负载均衡来实现。</p><h3 id="虚拟主机"><a href="#虚拟主机" class="headerlink" title="虚拟主机"></a>虚拟主机</h3><p>虚拟主机，就是把一台物理服务器划分成多个 “虚拟” 的服务器，这样我们的一台物理服务器就可以当做多个服务器来使用，从而可以配置多个网站。Nginx 提供虚拟主机的功能，就是为了让我们不需要安装多个 Nginx，就可以运行多个域名不同的网站。</p><p>Nginx 下，一个 server 标签就是一个虚拟主机。nginx 的虚拟主机就是通过 nginx.conf 中 server 节点指定的，想要设置多个虚拟主机，配置多个server节点即可。<br>通过nginx可以实现虚拟主机的配置，nginx支持三种类型的虚拟主机配置：</p><h4 id="基于ip的虚拟主机"><a href="#基于ip的虚拟主机" class="headerlink" title="基于ip的虚拟主机"></a>基于ip的虚拟主机</h4><p>linux配置多个ip地址</p><p>ip: 192.168.158.135  192.168.158.136</p><p>复制nginx自带的index.html</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cp</span> index.html index135.html<br><span class="hljs-built_in">cp</span> index.html index136.html<br></code></pre></td></tr></table></figure><p>修改html添加标识  135  136</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh">server &#123;<br>        listen       80;<br>        server_name 192.168.158.135;<br>        location / &#123;<br>                root   html;<br>                index  index135.html index.htm;<br>        &#125;<br>                <br>&#125;<br>server &#123;<br>        listen       80;<br>        server_name 192.168.158.136;<br>        location / &#123;<br>                root   html;<br>                index  index136.html index.htm;<br>        &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>重启nginx</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/usr/local/nginx/sbin/nginx -s reload<br></code></pre></td></tr></table></figure><h4 id="基于域名的虚拟主机"><a href="#基于域名的虚拟主机" class="headerlink" title="基于域名的虚拟主机"></a>基于域名的虚拟主机</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh">server &#123;<br>    listen       80;<br>    server_name  www.a.com;<br>    location / &#123;<br>      root   html;<br>      index  index135.html index.htm;<br>    &#125;<br>&#125;<br>server &#123;<br>    listen       80;<br>    server_name  www.b.com;<br>    location / &#123;<br>      root   html;<br>      index  index136.html index.htm;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="基于端口的虚拟主机"><a href="#基于端口的虚拟主机" class="headerlink" title="基于端口的虚拟主机"></a>基于端口的虚拟主机</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh">server &#123;<br>  listen 8080;<br>  server_name 192.168.158.135;<br>  location / &#123;<br>    root   html;<br>    index  index135.html index.htm;<br>  &#125;<br>&#125;<br>server &#123;<br>listen 9090;<br>server_name 192.168.158.135;<br>  location / &#123;<br>    root   html;<br>    index  index136.html index.htm;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="伪静态"><a href="#伪静态" class="headerlink" title="伪静态"></a>伪静态</h2><p>使url看起来更规范，合理。<br>可将动态url地址伪装成静态地址提供服务。<br>网址换新域名后，让旧的访问跳转到新的域名上。</p><p>nginx的伪静态是用ngx_http_rewrite_module模块实现的。</p><p>配置文件的用法在官方：</p><p><a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html">http://nginx.org/en/docs/http/ngx_http_rewrite_module.html</a></p><p>rewrite的命令语法：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">rewrite  正则&lt;regex&gt;   跳转后内容&lt;replacement&gt;   标记&lt;flag&gt;<br></code></pre></td></tr></table></figure><p>Flag:</p><p>last 相当于Apache的[L] 标记，表示完成rewrite</p><p>break 本条规则匹配完成即终止，不再匹配后面的任何规则</p><p>redirect 返回302临时重定向，浏览器地址会显示跳转后的URL地址，爬虫不会更新url</p><p>permanent 返回301永久重定向， 浏览器地址栏会显示跳转后的URL地址，爬虫更新url</p><p>last  一般写在server和if中 </p><p>break 一般使用在location中</p><p>测试：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">server &#123;<br>        listen       80;<br>        server_name 192.168.158.135;<br>        rewrite ^/baidu/a/.*$ http://www.baidu.com?v=a last; <br>&#125;<br></code></pre></td></tr></table></figure><p>访问：<a href="http://192.168.158.135/baidu/a/">http://192.168.158.135/baidu/a/</a>   会跳转 百度网址</p><p>配置：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">location / &#123;<br>rewrite ^/baidu/a$ http://www.baidu.com?v=a <span class="hljs-built_in">break</span>;<br><span class="hljs-built_in">return</span> 403;  <br>&#125;<br></code></pre></td></tr></table></figure><p>访问：<a href="http://192.168.158.136/baidu/a">http://192.168.158.136/baidu/a</a>  会跳转 百度网址</p><h2 id="动静分离-location如何使用"><a href="#动静分离-location如何使用" class="headerlink" title="动静分离(location如何使用)"></a>动静分离(location如何使用)</h2><p>动态请求请求tomcat</p><p>静态请求直接返回磁盘文件</p><p>在nginx里是由location标签实现的</p><p>静态请求：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">location / &#123;<br>  root   /usr/local/nginx/html/dist;<br>  try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /index.html;<br>  index  index.html index.htm;<br>&#125;<br></code></pre></td></tr></table></figure><p>动态请求：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">location /prod-api/&#123;<br>  proxy_set_header Host <span class="hljs-variable">$http_host</span>;<br>  proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>  proxy_set_header REMOTE-HOST <span class="hljs-variable">$remote_addr</span>;<br>  proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>  proxy_pass 负载均衡;<br>&#125;<br></code></pre></td></tr></table></figure><p>location [ &#x3D; | ~ | <del>* | ^</del> ] uri { … }</p><p>location URI {} 对当前路径及子路径下的所有对象都生效；</p><p>location &#x3D; URI {} 注意URL最好为具体路径。  精确匹配指定的路径，不包括子路径，因此，只对当前资源生效；</p><p>location ~ URI {}   location <del>* URI {}   模式匹配URI，此处的URI可使用正则表达式，</del>区分字符大小写，~*不区分字符大小写；</p><p>location ^~ URI {} 禁用正则表达式</p><p><strong>优先级</strong>：&#x3D; &gt; ^~ &gt; <del>|</del>* &gt;  &#x2F;|&#x2F;dir&#x2F;</p><p>location配置规则:</p><p>location 的执行逻辑跟 location 的编辑顺序无关。<br>矫正：这句话不全对，“普通 location ”的匹配规则是“最大前缀”，因此“普通 location ”的确与 location 编辑顺序无关；</p><p>但是“正则 location ”的匹配规则是“顺序匹配，且只要匹配到第一个就停止后面的匹配”；</p><p>“普通location ”与“正则 location ”之间的匹配顺序是？先匹配普通 location ，再“考虑”匹配正则 location 。</p><p>注意这里的“考虑”是“可能”的意思，也就是说匹配完“普通 location ”后，有的时候需要继续匹配“正则 location ”，有的时候则不需要继续匹配“正则 location ”。两种情况下，不需要继续匹配正则 location ：</p><p>​1.当普通 location 前面指定了“ ^~ ”，特别告诉 Nginx 本条普通 location 一旦匹配上，则不需要继续正则匹配；</p><p>​2.当普通location 恰好严格匹配上，不是最大前缀匹配，则不再继续匹配正则</p><h2 id="nginx常用正则"><a href="#nginx常用正则" class="headerlink" title="nginx常用正则"></a>nginx常用正则</h2><table><thead><tr><th>字符</th><th>说明</th></tr></thead><tbody><tr><td>^</td><td>匹配输入字符串的起始位置</td></tr><tr><td>$</td><td>匹配输入字符串的结束位置</td></tr><tr><td>*</td><td>匹配前面的字符零次或多次</td></tr><tr><td>+</td><td>匹配前面的字符一次或多次</td></tr><tr><td>?</td><td>匹配前面的字符零次或一次</td></tr><tr><td>.</td><td>匹配除“\n”之外的任何单个字符</td></tr><tr><td>\</td><td>将后面接着字符标记为一个特殊字符或一个原义字符或一个向后引用</td></tr><tr><td>\d</td><td>匹配纯数字</td></tr><tr><td>{n，}</td><td>重复n次或更多次</td></tr><tr><td>{n }</td><td>重复n次</td></tr><tr><td>[c]</td><td>匹配单个字符c</td></tr><tr><td>[a-z]</td><td>匹配a-z小写字母的任意一个</td></tr><tr><td>[a-zA-Z]</td><td>匹配a-z小写字母或A-Z大写字母的任意一个</td></tr></tbody></table><h2 id="如何看nginx官网"><a href="#如何看nginx官网" class="headerlink" title="如何看nginx官网"></a>如何看nginx官网</h2><p><a href="http://nginx.org/">http://nginx.org/</a> </p><p>点击documentation</p><p>Introduction 下是一些案例，比如如何做一个负载均衡，配置https等</p><p>Modules reference 这是个很重要的部分</p><p>Core functionalit有error_log、worker_processes、worker_connections等配置参数的说明</p><p>ngx_http_core_module中有location、server的配置</p><p>然后用到哪个模块可以去哪个模块看如何使用</p><h2 id="IP访问控制"><a href="#IP访问控制" class="headerlink" title="IP访问控制"></a>IP访问控制</h2><p>使用的是ngx_http_access_module</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">语法:allow address | CIDR | unix: | all;<br>默认:—<br>可以写在哪:http, server, location, limit_except<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">语法:deny address | CIDR | unix: | all;<br>默认:—<br>可以写在哪:http, server, location, limit_except<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh">location / &#123;<br><span class="hljs-comment"># 拒绝单个IP</span><br>    deny  192.168.1.1;<br>    <span class="hljs-comment"># 允许ip段</span><br>    allow 192.168.1.0/24;<br>    <span class="hljs-comment"># 允许ip段</span><br>    allow 10.1.1.0/16;<br>    <span class="hljs-comment"># 允许ipv6段</span><br>    allow 2001:0db8::/32;<br>    <span class="hljs-comment"># 拒绝其余所有ip</span><br>    deny  all;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="用户认证访问"><a href="#用户认证访问" class="headerlink" title="用户认证访问"></a>用户认证访问</h2><p>可以使用ngx_http_auth_basic_module  ngx_http_auth_jwt_module ngx_http_auth_request_module</p><p>这里演示basic:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">Syntax:auth_basic string | off;<br>Default:auth_basic off;<br>Context:http, server, location, limit_except<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">Syntax:auth_basic_user_file file;<br>Default:—<br>Context:http, server, location, limit_except<br></code></pre></td></tr></table></figure><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-keyword">location</span> <span class="hljs-title">/ &#123;</span><br><span class="hljs-title">    auth_basic</span>           <span class="hljs-string">&quot;closed site&quot;</span>;<br>    auth_basic_user_file htpasswd;<br>&#125;<br></code></pre></td></tr></table></figure><p>新建htpasswd 文件放到conf目录</p><p>htpasswd里内容格式为：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># comment</span><br>name1:password1<br>name2:password2:comment<br>name3:password3<br></code></pre></td></tr></table></figure><p>密码是有要求的：看官网文档</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum -y install openssl<br><span class="hljs-comment"># 执行完后会返回加密后的密码</span><br>openssl passwd 123456<br></code></pre></td></tr></table></figure><h2 id="访问状态监控"><a href="#访问状态监控" class="headerlink" title="访问状态监控"></a>访问状态监控</h2><p>使用的ngx_http_stub_status_module</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">Syntax:stub_status;<br>Default:—<br>Context:server, location<br></code></pre></td></tr></table></figure><p>示例：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">location = /basic_status &#123;<br>    stub_status;<br>&#125;<br></code></pre></td></tr></table></figure><p>需要重新编译安装：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 查看以前的配置</span><br>/usr/local/nginx/sbin/nginx -V<br><span class="hljs-built_in">cd</span> 到nginx原码目录<br>./configure  加以前的配置  --with-http_stub_status_module<br>make &amp; make install<br><span class="hljs-comment"># 关闭nginx服务</span><br><span class="hljs-comment"># 启动nginx服务</span><br></code></pre></td></tr></table></figure><p>访问：</p><p><a href="http://192.168.158.135/basic_status">http://192.168.158.135/basic_status</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh">Active connections<br>当前活动客户端连接数，包括Waiting连接数。<br>accepts<br>接受的客户端连接总数。<br>handled<br>处理的连接总数。accepts 通常，除非已达到某些资源限制（例如， worker_connections限制） ，否则该参数值相同。<br>requests<br>客户端请求的总数。<br>Reading<br>nginx 正在读取请求标头的当前连接数。<br>Writing<br>nginx 将响应写回客户端的当前连接数。<br>Waiting<br>当前等待请求的空闲客户端连接数。<br></code></pre></td></tr></table></figure><h2 id="gzip压缩"><a href="#gzip压缩" class="headerlink" title="gzip压缩"></a>gzip压缩</h2><p>使用的ngx_http_gzip_module</p><p>具体详细的说明看官网。</p><p>试例：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">gzip on;<br>gzip_types *;<br></code></pre></td></tr></table></figure><p>准备一个大的html,大于20kb，因为gzip_min_length 默认为20kb.</p><p>在network禁用缓存，浏览器访问，发现请求的返回size为30kb，这是未gzip压缩的情况。</p><p>编辑配置文件，并重新加载配置。</p><p>再访问，再查看，发现只有1kb了，返回的response headers中变为Content-Encoding: gzip。</p><h2 id="https配置"><a href="#https配置" class="headerlink" title="https配置"></a>https配置</h2><h3 id="获取ssl证书"><a href="#获取ssl证书" class="headerlink" title="获取ssl证书"></a>获取ssl证书</h3><p>1.可以去阿里云的数字证书管理服务  申请免费或收费的证书。</p><p>2.linux系统生成ssl证书(浏览器不认)</p><p>生成私钥：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">openssl genrsa -out privkey.pem 2048<br></code></pre></td></tr></table></figure><p>2048 长度是2048</p><p>-out:生成的文件名</p><p>当前目录下会生成privkey.pem的文件</p><p>生成ca证书：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">openssl req -new -x509 -key privkey.pem -out cacert.pem -days 1095<br></code></pre></td></tr></table></figure><p>-key:使用的私钥文件<br>-out：生成的证书文件<br>-days:有效期，单位天</p><p>CountryISO国家代码(两位字母)CN<br>State or ProvineName所在省份 beijing<br>Locality Name所在城市beijing<br>Organization Name公司名称xxx<br>Organization Unit Name部门名称TEST<br>Common Name申请证书域名localhost<br>Email Address电子邮箱(可以不输入)<br>A challenge password加密证书请求密码(可以不输入)123456</p><p>当前目录下会生成cacert.pem的文件</p><h3 id="nignx配置"><a href="#nignx配置" class="headerlink" title="nignx配置"></a>nignx配置</h3><p>Nginx的https是由–with-http_ssl_module模块提供的</p><p>在nginx 的程序目录中添加目录存放证书</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /usr/local/nginx/conf<br><span class="hljs-built_in">mkdir</span> cert<br><span class="hljs-comment">#把证书放进这个目录</span><br></code></pre></td></tr></table></figure><p>nginx配置</p><p>https监听配置</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh">server &#123;<br>    listen 443 ssl;<br>    <span class="hljs-comment">#配置HTTPS的默认访问端口为443。</span><br>    <span class="hljs-comment">#如果未在此处配置HTTPS的默认访问端口，可能会造成Nginx无法启动。</span><br>    <span class="hljs-comment">#如果您使用Nginx 1.15.0及以上版本，请使用listen 443 ssl代替listen 443和ssl on。</span><br>    server_name yourdomain; <span class="hljs-comment">#需要将yourdomain替换成证书绑定的域名。</span><br>    ssl_certificate cert/cert-file-name.pem;  <span class="hljs-comment">#需要将cert-file-name.pem替换成已上传的证书文件的名称。</span><br>    ssl_certificate_key cert/cert-file-name.key; <span class="hljs-comment">#需要将cert-file-name.key替换成已上传的证书私钥文件的名称。</span><br>    ssl_session_timeout 5m;<br>    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;<br>    <span class="hljs-comment">#表示使用的加密套件的类型。</span><br>    ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3; <span class="hljs-comment">#表示使用的TLS协议的类型。</span><br>    ssl_prefer_server_ciphers on;<br>    location / &#123;<br>        root html;  <span class="hljs-comment">#Web网站程序存放目录。</span><br>        index index.html index.htm;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>转发配置：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">erver &#123;<br>    listen 80;<br>    server_name yourdomain; <span class="hljs-comment">#需要将yourdomain替换成证书绑定的域名。</span><br>    rewrite ^(.*)$ https://$host<span class="hljs-variable">$1</span>; <span class="hljs-comment">#将所有HTTP请求通过rewrite指令重定向到HTTPS。</span><br>    location / &#123;<br>        index index.html index.htm;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>启动nginx：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/usr/local/nginx/sbin/nginx<br></code></pre></td></tr></table></figure><p>开放443端口</p><p>这时就可以访问了，如果是自签证书，浏览器不认，需要仍访问网站，可以看到页面。</p><p>也可以浏览器添加信任证书。</p>]]></content>
    
    
    <categories>
      
      <category>nginx</category>
      
    </categories>
    
    
    <tags>
      
      <tag>nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>fastDfs高可用</title>
    <link href="/2022/05/09/fastDFS/fastDfs%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    <url>/2022/05/09/fastDFS/fastDfs%E9%AB%98%E5%8F%AF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>fastdfs高可用</p><p>nginx高可用</p><p>nginx与fastdfs整合这样使下载高可用</p><h2 id="主机规划"><a href="#主机规划" class="headerlink" title="主机规划"></a>主机规划</h2><table><thead><tr><th>主机</th><th>服务</th></tr></thead><tbody><tr><td>192.168.158.128</td><td>nginx keepalived</td></tr><tr><td>192.168.158.129</td><td>nginx keepalived</td></tr><tr><td>192.168.158.130</td><td>Fastdfs-tracker</td></tr><tr><td>192.168.158.131</td><td>Fastdfs-tracker</td></tr><tr><td>192.168.158.132</td><td>Fastdfs-storge nginx(fastdfs-nginx-module)</td></tr><tr><td>192.168.158.133</td><td>Fastdfs-storge nginx(fastdfs-nginx-module)</td></tr></tbody></table><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>tracker的安装是正常的单机版安装</p><p>storage安装时注意配置里：</p><p>tracker_server&#x3D;192.168.150.11:22122 -&gt; tracker_server&#x3D;tracker服务IP:22122</p><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">tracker_server = 192.168.158.130:22122<br>tracker_server = 192.168.158.131:22122<br></code></pre></td></tr></table></figure><p>nginx 和 fastdfs-nginx-module整合时也是同上。</p><h2 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h2><p>tracker开放端口22122：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">firewall-cmd --add-port=22122/tcp --permanent<br>firewall-cmd --reload<br></code></pre></td></tr></table></figure><p>storage开放端口23000：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">firewall-cmd --add-port=23000/tcp --permanent<br>firewall-cmd --add-port=80/tcp --permanent<br>firewall-cmd --reload<br></code></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>在192.168.158.128安装fastdfs-client</p><p>配置</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">tracker_server = 192.168.158.130:22122<br>tracker_server = 192.168.158.131:22122<br></code></pre></td></tr></table></figure><p>使用：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">fdfs_upload_file /etc/fdfs/client.conf /usr/local/fastdfs-6.08.tar.gz<br>fdfs_download_file  /etc/fdfs/client.conf group1/M00/00/00/wKiehGJ5CwiAfS3OAAxZ6KIFrWU.tar.gz<br></code></pre></td></tr></table></figure><p>这时fastdfs的tracker和storage集群已经搭建好了。</p><h2 id="nginx负载均衡配置"><a href="#nginx负载均衡配置" class="headerlink" title="nginx负载均衡配置"></a>nginx负载均衡配置</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh">http &#123;<br>        upstream fdfs_group1 &#123;  <span class="hljs-comment"># 添加上游服务器</span><br>                server 192.168.158.132 weight=1 max_fails=2 fail_timeout=30s;<br>                server 192.168.158.133 weight=1 max_fails=2 fail_timeout=30s;<br>        &#125;<br>        <br>  location /group1/M00 &#123;  <span class="hljs-comment"># 反向代理</span><br>            proxy_pass http://fdfs_group1;<br>            expires 30d;<br>        &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="安装storage机器上的nginx"><a href="#安装storage机器上的nginx" class="headerlink" title="安装storage机器上的nginx"></a>安装storage机器上的nginx</h2><p>192.168.158.128、192.168.158.129上的nginx是主要为了提供 http 访问的反向代理、负载均衡以及缓存服务。</p><p>storage上的nginx + (fastdfs-nginx-module) 是为了storage同步延迟，可以负载均衡到已上传的机器上。</p>]]></content>
    
    
    <categories>
      
      <category>fastDfs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>fastDfs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nginx+keeplive实现高可用</title>
    <link href="/2022/05/09/linux/nginx+keeplive%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    <url>/2022/05/09/linux/nginx+keeplive%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="主机规划"><a href="#主机规划" class="headerlink" title="主机规划"></a>主机规划</h2><table><thead><tr><th>主机</th><th>服务</th></tr></thead><tbody><tr><td>192.168.158.128</td><td>nginx keepalived</td></tr><tr><td>192.168.158.129</td><td>Nginx keepalived</td></tr></tbody></table><p>虚IP :   192.168.158.50</p><h2 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h2><p>服务器上已经有nginx，可以访问80端口。</p><h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p><img src="/.com//image-20220509144709139.png" alt="image-20220509144709139"></p><h2 id="下载及准备"><a href="#下载及准备" class="headerlink" title="下载及准备"></a>下载及准备</h2><p><a href="https://www.keepalived.org/">https://www.keepalived.org/</a></p><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">wget --no-check-certificate https://www.keepalived.org/software/keepalived-1.2.18.tar.gz<br></code></pre></td></tr></table></figure><p>编译并安装</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">tar -xvzf keepalived-1.2.18.tar.gz<br><span class="hljs-built_in">cd</span> /usr/local/keepalived-1.2.18<br>./configure --prefix=/usr/local/keepalived<br>make &amp;&amp; make install<br></code></pre></td></tr></table></figure><p>Keepalived安装成Linux服务</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">mkdir</span> /etc/keepalived<br><span class="hljs-built_in">cp</span> /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/<br><span class="hljs-built_in">cp</span> /usr/local/keepalived/etc/rc.d/init.d/keepalived /etc/init.d/<br><span class="hljs-built_in">cp</span> /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/<br><span class="hljs-built_in">ln</span> -s /usr/local/keepalived/sbin/keepalived /usr/sbin/<br></code></pre></td></tr></table></figure><p>设置开机启动</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">chkconfig keepalived on<br></code></pre></td></tr></table></figure><h3 id="创建nginx状态检查脚本"><a href="#创建nginx状态检查脚本" class="headerlink" title="创建nginx状态检查脚本"></a>创建nginx状态检查脚本</h3><p>脚本描述：如果 nginx 停止运行，尝试启动，如果无法启动则杀死本机的 keepalived 进程</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vi /etc/keepalived/nginx_check.sh<br></code></pre></td></tr></table></figure><p>内容：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash </span><br>counter=$(ps -C nginx --no-heading|<span class="hljs-built_in">wc</span> -l)<br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;counter&#125;</span>&quot;</span> = <span class="hljs-string">&quot;0&quot;</span> ]; <span class="hljs-keyword">then</span><br>    /usr/local/nginx/sbin/nginx<br>    <span class="hljs-built_in">sleep</span> 2<br>    counter=$(ps -C nginx --no-heading|<span class="hljs-built_in">wc</span> -l)<br>    <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;counter&#125;</span>&quot;</span> = <span class="hljs-string">&quot;0&quot;</span> ]; <span class="hljs-keyword">then</span><br>        systemctl stop keepalived<br>    <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><p>权限:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">chmod</span> +x /etc/keepalived/nginx_check.sh<br></code></pre></td></tr></table></figure><h2 id="配置keepalived-conf"><a href="#配置keepalived-conf" class="headerlink" title="配置keepalived.conf"></a>配置keepalived.conf</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /etc/keepalived/<br>vim keepalived.conf<br></code></pre></td></tr></table></figure><p>keepalived.conf解释</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs sh">! Configuration File <span class="hljs-keyword">for</span> keepalived <br> <br>global_defs &#123; <br>   <span class="hljs-comment">## keepalived 自带的邮件提醒需要开启 sendmail 服务。建议用独立的监控或第三方 SMTP </span><br>   router_id TS1  <span class="hljs-comment">## 标识本节点的字条串，通常为 hostname </span><br>&#125; <br><span class="hljs-comment">##  keepalived 会定时执行脚本并对脚本执行的结果进行分析，动态调整 vrrp_instance 的优先级。如果脚本执行结果为 0，并且 weight 配置的值大于 0，则优先级相应的增加。如果脚本执行结果非 0，并且 weight配置的值小于 0，则优先级相应的减少。其他情况，维持原本配置的优先级，即配置文件中 priority 对应的值。 </span><br>vrrp_script chk_nginx &#123; <br>    script <span class="hljs-string">&quot;/etc/keepalived/nginx_check.sh&quot;</span>  <span class="hljs-comment">## 检测 nginx 状态的脚本路径 </span><br>    interval 2  <span class="hljs-comment">## 检测时间间隔 </span><br>    weight -20  <span class="hljs-comment">## 如果条件成立，权重-20  </span><br>&#125; <br><span class="hljs-comment">## 定义虚拟路由，VI_1 为虚拟路由的标示符，自己定义名称 </span><br>vrrp_instance VI_1 &#123; <br>    state MASTER  <span class="hljs-comment">## 主节点为 MASTER，对应的备份节点为 BACKUP </span><br>    interface eth0  <span class="hljs-comment">## 绑定虚拟 IP 的网络接口，与本机 IP 地址所在的网络接口相同，我的是 eth1 </span><br>    virtual_router_id 51  <span class="hljs-comment">## 虚拟路由的 ID 号，两个节点设置必须一样，可选 IP 最后一段使用,  相同的 VRID 为一个组，他将决定多播的 MAC 地址 </span><br>    mcast_src_ip 192.168.150.132  <span class="hljs-comment">## 本机 IP 地址 </span><br>    priority 100  <span class="hljs-comment">## 节点优先级，值范围 0-254，MASTER 要比BACKUP 高 </span><br>    nopreempt <span class="hljs-comment">## 优先级高的设置 nopreempt 解决异常恢复后再次抢占的问题 </span><br>    advert_int 1  <span class="hljs-comment">## 组播信息发送间隔，两个节点设置必须一样，默认 1s </span><br>    <span class="hljs-comment">## 设置验证信息，两个节点必须一致 </span><br><br>    <span class="hljs-comment">## 将 track_script 块加入instance 配置块 </span><br>    track_script &#123; <br>        chk_nginx  <span class="hljs-comment">## 执行 Nginx 监控的服务 </span><br>    &#125; <br>    <span class="hljs-comment">## 虚拟 IP 池, 两个节点设置必须一样 </span><br>    virtual_ipaddress &#123; <br>        192.168.150.138/24   dev  eth0  label  eth0:2<br>    &#125; <br>&#125;<br></code></pre></td></tr></table></figure><p>192.168.158.128 主机配置keepalived.conf：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs sh">! Configuration File <span class="hljs-keyword">for</span> keepalived<br><br>global_defs &#123;<br>   router_id LVS_DEVEL<br>&#125;<br><br>vrrp_script chk_nginx &#123;<br>    script <span class="hljs-string">&quot;/etc/keepalived/nginx_check.sh&quot;</span><br>    interval 2 <br>    weight 20 <br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>    state MASTER<br>    interface ens160<br>    virtual_router_id 51<br>    priority 100<br>    advert_int 1<br>    mcast_src_ip 192.168.158.128<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 1111<br>    &#125;<br>    virtual_ipaddress &#123;<br>        192.168.158.50<br>    &#125;<br>    track_script &#123; <br>        chk_nginx<br>    &#125; <br>&#125;<br></code></pre></td></tr></table></figure><p>192.168.158.129 主机配置keepalived.conf：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs sh">! Configuration File <span class="hljs-keyword">for</span> keepalived<br><br>global_defs &#123;<br>   router_id LVS_DEVEL<br>&#125;<br><br>vrrp_script chk_nginx &#123;<br>    script <span class="hljs-string">&quot;/etc/keepalived/nginx_check.sh&quot;</span><br>    interval 2 <br>    weight 20 <br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>    state BACKUP<br>    interface ens160<br>    virtual_router_id 51<br>    priority 90<br>    advert_int 1<br>    mcast_src_ip 192.168.158.128<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 1111<br>    &#125;<br>    virtual_ipaddress &#123;<br>        192.168.158.50<br>    &#125;<br>    track_script &#123; <br>        chk_nginx<br>    &#125; <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="防火墙设置"><a href="#防火墙设置" class="headerlink" title="防火墙设置"></a>防火墙设置</h2><p>需要vrrp 的组播(多播)</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface ens160 --destination 224.0.0.18 --protocol vrrp -j ACCEPT<br><br>firewall-cmd --reload<br><br>firewall-cmd --direct --get-all-rules<br></code></pre></td></tr></table></figure><p>ens160 为网卡名称。</p><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">service keepalived start<br>service keepalived status<br>service keepalived stop<br>service keepalived restart<br></code></pre></td></tr></table></figure><p>访问<a href="http://192.168.158.50/">http://192.168.158.50/</a></p><p>可以看到nginx的index.html</p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>修改两台nginx的index.html添加IP标识</p>]]></content>
    
    
    <categories>
      
      <category>nginx</category>
      
    </categories>
    
    
    <tags>
      
      <tag>nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ant安装</title>
    <link href="/2022/05/07/maven/ant%E5%AE%89%E8%A3%85/"/>
    <url>/2022/05/07/maven/ant%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><a href="https://ant.apache.org/">https://ant.apache.org/</a></p><p>解压：</p><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">tar -xvzf apache-ant-1.9.16-bin.tar.gz<br></code></pre></td></tr></table></figure><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vi ~/.bash_profile<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> ANT_HOME=/Applications/apache-ant-1.9.16<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$ANT_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br></code></pre></td></tr></table></figure><p>环境变量生效：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> ~/.bash_profile<br></code></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ant -version<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ant</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ant</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>maven安装</title>
    <link href="/2022/05/07/maven/maven%E5%AE%89%E8%A3%85/"/>
    <url>/2022/05/07/maven/maven%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><a href="https://maven.apache.org/">https://maven.apache.org/</a></p><p>解压：</p><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">tar -xvzf apache-maven-3.8.5-bin.tar.gz<br></code></pre></td></tr></table></figure><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vi ~/.bash_profile<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> M2_HOME=/Applications/apache-maven-3.8.5<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$M2_HOME</span>/bin<br></code></pre></td></tr></table></figure><p>环境变量生效：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> ~/.bash_profile<br></code></pre></td></tr></table></figure><p>因为mac终端使用的zsh的shell</p><p>新建文件：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vi ~/.zshrc<br></code></pre></td></tr></table></figure><p>写入：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> ~/.bash_profile<br></code></pre></td></tr></table></figure><p>执行：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> ~/.zshrc<br></code></pre></td></tr></table></figure><p>修改setting.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">localRepository</span>&gt;</span>/Users/qichuanhan/.m2/repository<span class="hljs-tag">&lt;/<span class="hljs-name">localRepository</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">mirror</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>aliyunmaven<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">mirrorOf</span>&gt;</span>*<span class="hljs-tag">&lt;/<span class="hljs-name">mirrorOf</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>阿里云公共仓库<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://maven.aliyun.com/repository/public<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">mirror</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mvn -v<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>maven</category>
      
    </categories>
    
    
    <tags>
      
      <tag>maven</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>centos7的firewall防火墙</title>
    <link href="/2022/05/07/linux/centos7%E7%9A%84firewall%E9%98%B2%E7%81%AB%E5%A2%99/"/>
    <url>/2022/05/07/linux/centos7%E7%9A%84firewall%E9%98%B2%E7%81%AB%E5%A2%99/</url>
    
    <content type="html"><![CDATA[<h2 id="一、firewalld-linux防火墙-的基本使用"><a href="#一、firewalld-linux防火墙-的基本使用" class="headerlink" title="一、firewalld(linux防火墙)的基本使用"></a>一、firewalld(linux防火墙)的基本使用</h2><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">启动： systemctl start firewalld<br>查看状态： systemctl status firewalld<br>停止： systemctl <span class="hljs-built_in">disable</span> firewalld<br>禁用： systemctl stop firewalld<br>查看防火墙允许端口：firewall-cmd --list-all (使用前置条件为：防火墙已开启)<br></code></pre></td></tr></table></figure><h2 id="二、查看服务信息"><a href="#二、查看服务信息" class="headerlink" title="二、查看服务信息"></a>二、查看服务信息</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">启动一个服务：systemctl start firewalld.service<br>关闭一个服务：systemctl stop firewalld.service<br>重启一个服务：systemctl restart firewalld.service<br>显示一个服务的状态：systemctl status firewalld.service<br>在开机时启用一个服务：systemctl <span class="hljs-built_in">enable</span> firewalld.service<br>在开机时禁用一个服务：systemctl <span class="hljs-built_in">disable</span> firewalld.service<br>查看服务是否开机启动：systemctl is-enabled firewalld.service<br>查看已启动的服务列表：systemctl list-unit-files|grep enabled<br>查看启动失败的服务列表：systemctl --failed<br></code></pre></td></tr></table></figure><h2 id="三、firewalld-cmd"><a href="#三、firewalld-cmd" class="headerlink" title="三、firewalld-cmd"></a>三、firewalld-cmd</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh">查看版本： firewall-cmd --version<br>查看帮助： firewall-cmd --<span class="hljs-built_in">help</span><br>显示状态： firewall-cmd --state<br>查看所有打开的端口： firewall-cmd --zone=public --list-ports<br>更新防火墙规则： firewall-cmd --reload<br>查看区域信息: firewall-cmd --get-active-zones<br>查看指定接口所属区域： firewall-cmd --get-zone-of-interface=eth0<br>拒绝所有包：firewall-cmd --panic-on<br>取消拒绝状态： firewall-cmd --panic-off<br>查看是否拒绝： firewall-cmd --query-panic<br></code></pre></td></tr></table></figure><h2 id="四、使用firewalld-cmd"><a href="#四、使用firewalld-cmd" class="headerlink" title="四、使用firewalld-cmd"></a>四、使用firewalld-cmd</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">添加<br>firewall-cmd --add-port=80/tcp --permanent （--permanent永久生效，没有此参数重启后失效。80代表端口号）<br>重新载入<br>firewall-cmd --reload<br>查看<br>firewall-cmd --query-port=80/tcp<br>删除<br>firewall-cmd --remove-port=80/tcp --permanent<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux安装nginx</title>
    <link href="/2022/05/07/linux/linux%E5%AE%89%E8%A3%85nginx/"/>
    <url>/2022/05/07/linux/linux%E5%AE%89%E8%A3%85nginx/</url>
    
    <content type="html"><![CDATA[<h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p><a href="http://nginx.org/">http://nginx.org/</a></p><p>下载：</p><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">wget http://nginx.org/download/nginx-1.20.2.tar.gz<br></code></pre></td></tr></table></figure><p>解压：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">tar -xvzf nginx-1.20.2.tar.gz<br></code></pre></td></tr></table></figure><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>linux系统需要安装的组件：gcc、 openssl-devel、 pcre-devel、 zlib-devel</p><p>可以使用yum查看是否已经安装：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum list installed | grep openssl-devel<br></code></pre></td></tr></table></figure><p>安装组件：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum install gcc openssl-devel pcre-devel zlib-devel<br></code></pre></td></tr></table></figure><p>配置：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> nginx-1.20.2<br>./configure --prefix=/usr/local/nginx/<br></code></pre></td></tr></table></figure><p>显示：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs text">Configuration summary<br>  + using system PCRE library<br>  + OpenSSL library is not used<br>  + using system zlib library<br><br>  nginx path prefix: &quot;/usr/local/nginx/&quot;<br>  nginx binary file: &quot;/usr/local/nginx//sbin/nginx&quot;<br>  nginx modules path: &quot;/usr/local/nginx//modules&quot;<br>  nginx configuration prefix: &quot;/usr/local/nginx//conf&quot;<br>  nginx configuration file: &quot;/usr/local/nginx//conf/nginx.conf&quot;<br>  nginx pid file: &quot;/usr/local/nginx//logs/nginx.pid&quot;<br>  nginx error log file: &quot;/usr/local/nginx//logs/error.log&quot;<br>  nginx http access log file: &quot;/usr/local/nginx//logs/access.log&quot;<br>  nginx http client request body temporary files: &quot;client_body_temp&quot;<br>  nginx http proxy temporary files: &quot;proxy_temp&quot;<br>  nginx http fastcgi temporary files: &quot;fastcgi_temp&quot;<br>  nginx http uwsgi temporary files: &quot;uwsgi_temp&quot;<br>  nginx http scgi temporary files: &quot;scgi_temp&quot;<br></code></pre></td></tr></table></figure><p>编译安装：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">make &amp;&amp; make install<br></code></pre></td></tr></table></figure><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/usr/local/nginx/sbin/nginx -?<br></code></pre></td></tr></table></figure><p>显示：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh">nginx version: nginx/1.20.2<br>Usage: nginx [-?hvVtTq] [-s signal] [-p prefix]<br>             [-e filename] [-c filename] [-g directives]<br><br>Options:<br>  -?,-h         : this <span class="hljs-built_in">help</span><br>  -v            : show version and <span class="hljs-built_in">exit</span><br>  -V            : show version and configure options <span class="hljs-keyword">then</span> <span class="hljs-built_in">exit</span><br>  -t            : <span class="hljs-built_in">test</span> configuration and <span class="hljs-built_in">exit</span><br>  -T            : <span class="hljs-built_in">test</span> configuration, dump it and <span class="hljs-built_in">exit</span><br>  -q            : suppress non-error messages during configuration testing<br>  -s signal     : send signal to a master process: stop, quit, reopen, reload<br>  -p prefix     : <span class="hljs-built_in">set</span> prefix path (default: /usr/local/nginx//)<br>  -e filename   : <span class="hljs-built_in">set</span> error <span class="hljs-built_in">log</span> file (default: logs/error.log)<br>  -c filename   : <span class="hljs-built_in">set</span> configuration file (default: conf/nginx.conf)<br>  -g directives : <span class="hljs-built_in">set</span> global directives out of configuration file<br></code></pre></td></tr></table></figure><p>启动：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/usr/local/nginx/sbin/nginx<br></code></pre></td></tr></table></figure><p>查看进程：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ps -ef | grep nginx<br></code></pre></td></tr></table></figure><p>检查配置文件：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/usr/local/nginx/sbin/nginx -t<br></code></pre></td></tr></table></figure><p>重新加载配置：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/usr/local/nginx/sbin/nginx -s reload<br></code></pre></td></tr></table></figure><p>停止：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/usr/local/nginx/sbin/nginx -s stop<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux查看软件是否安装</title>
    <link href="/2022/05/07/linux/linux%E6%9F%A5%E7%9C%8B%E8%BD%AF%E4%BB%B6%E6%98%AF%E5%90%A6%E5%AE%89%E8%A3%85/"/>
    <url>/2022/05/07/linux/linux%E6%9F%A5%E7%9C%8B%E8%BD%AF%E4%BB%B6%E6%98%AF%E5%90%A6%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<p>linux有多种方式安装软件，查看某个软件是否安装的方法有以下几种：</p><h4 id="以rpm包安装的软件"><a href="#以rpm包安装的软件" class="headerlink" title="以rpm包安装的软件"></a>以rpm包安装的软件</h4><p>使用 rpm -qa | grep “软件或者包的名字”命令查看</p><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">rpm -qa | grep ruby<br></code></pre></td></tr></table></figure><h4 id="以deb包安装的软件"><a href="#以deb包安装的软件" class="headerlink" title="以deb包安装的软件"></a>以deb包安装的软件</h4><p>使用dpkg -l | grep “软件或者包的名字”命令查看</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">dpkg-l |grep ruby<br></code></pre></td></tr></table></figure><h4 id="yum方法安装的软件"><a href="#yum方法安装的软件" class="headerlink" title="yum方法安装的软件"></a>yum方法安装的软件</h4><p>可以用yum list installed | grep “软件名或者包名”命令查看</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum list installed | grep ruby<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>fastDfs与nginx整合</title>
    <link href="/2022/05/06/fastDFS/fastDfs%E4%B8%8Enginx%E6%95%B4%E5%90%88/"/>
    <url>/2022/05/06/fastDFS/fastDfs%E4%B8%8Enginx%E6%95%B4%E5%90%88/</url>
    
    <content type="html"><![CDATA[<h2 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h2><p><a href="https://github.com/happyfish100">https://github.com/happyfish100</a> 作者：余庆（YuQing）</p><p>安装wget:</p><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">yum install wget<br></code></pre></td></tr></table></figure><p>下载：</p><p><a href="https://github.com/happyfish100/fastdfs-nginx-module/archive/refs/tags/V1.22.tar.gz">https://github.com/happyfish100/fastdfs-nginx-module/archive/refs/tags/V1.22.tar.gz</a></p><p>解压：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">tar -zxvf fastdfs-nginx-module-1.22.tar.gz <br></code></pre></td></tr></table></figure><h2 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /usr/local/fastdfs-nginx-module-1.22/src/config<br></code></pre></td></tr></table></figure><p>fastdfs的include在&#x2F;usr&#x2F;include&#x2F;fastdfs &#x2F;usr&#x2F;include&#x2F;fastcommon&#x2F;</p><p>ngx_module_incs&#x3D;”&#x2F;usr&#x2F;local&#x2F;include”   —&gt; ngx_module_incs&#x3D;”&#x2F;usr&#x2F;include” </p><p>CORE_INCS&#x3D;”$CORE_INCS &#x2F;usr&#x2F;local&#x2F;include” —&gt; CORE_INCS&#x3D;”$CORE_INCS &#x2F;usr&#x2F;include”</p><h3 id="nginx-编译安装"><a href="#nginx-编译安装" class="headerlink" title="nginx 编译安装"></a>nginx 编译安装</h3><p>进入nginx源码文件夹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">./configure --prefix=/usr/local/nginx --add-module=/usr/local/fastdfs-nginx-module-1.22/src/<br></code></pre></td></tr></table></figure><p>显示：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh">Configuration summary<br>  + using system PCRE library<br>  + OpenSSL library is not used<br>  + using system zlib library<br><br>  nginx path prefix: <span class="hljs-string">&quot;/usr/local/nginx&quot;</span><br>  nginx binary file: <span class="hljs-string">&quot;/usr/local/nginx/sbin/nginx&quot;</span><br>  nginx modules path: <span class="hljs-string">&quot;/usr/local/nginx/modules&quot;</span><br>  nginx configuration prefix: <span class="hljs-string">&quot;/usr/local/nginx/conf&quot;</span><br>  nginx configuration file: <span class="hljs-string">&quot;/usr/local/nginx/conf/nginx.conf&quot;</span><br>  nginx pid file: <span class="hljs-string">&quot;/usr/local/nginx/logs/nginx.pid&quot;</span><br>  nginx error <span class="hljs-built_in">log</span> file: <span class="hljs-string">&quot;/usr/local/nginx/logs/error.log&quot;</span><br>  nginx http access <span class="hljs-built_in">log</span> file: <span class="hljs-string">&quot;/usr/local/nginx/logs/access.log&quot;</span><br>  nginx http client request body temporary files: <span class="hljs-string">&quot;client_body_temp&quot;</span><br>  nginx http proxy temporary files: <span class="hljs-string">&quot;proxy_temp&quot;</span><br>  nginx http fastcgi temporary files: <span class="hljs-string">&quot;fastcgi_temp&quot;</span><br>  nginx http uwsgi temporary files: <span class="hljs-string">&quot;uwsgi_temp&quot;</span><br>  nginx http scgi temporary files: <span class="hljs-string">&quot;scgi_temp&quot;</span><br></code></pre></td></tr></table></figure><p>编译安装：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">make &amp;&amp; make install<br></code></pre></td></tr></table></figure><h3 id="配置fastdfs-nginx-module"><a href="#配置fastdfs-nginx-module" class="headerlink" title="配置fastdfs-nginx-module"></a>配置fastdfs-nginx-module</h3><p>FastDFS 通过 Tracker 服务器,将文件放在 Storage 服务器存储，但是同组存储服务器之间需要进入文件复制，有同步延迟的问题。假设 Tracker 服务器将文件上传到了 S1，上传成功后文件 ID已经返回给客户端。</p><p>此时 FastDFS 存储集群机制会将这个文件同步到同组存储 S2，在文件还没有复制完成的情况下，客户端如果用这个文件 ID 在 S2 上取文件,就会出现文件无法访问的错误。</p><p>而 fastdfs-nginx-module 可以重定向文件连接到源服务器（S1）取文件,避免客户端由于复制延迟导致的文件无法访问错误。</p><p>拷贝配置文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cp</span> /usr/local/fastdfs-nginx-module-1.22/src/mod_fastdfs.conf /etc/fdfs/<br></code></pre></td></tr></table></figure><p>修改配置文件 mod_fastdfs.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/fdfs/mod_fastdfs.conf<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">tracker_server=192.168.158.128:22122<br>url_have_group_name = <span class="hljs-literal">true</span><br>store_path0=/var/data/fastdfs-storage/store<br></code></pre></td></tr></table></figure><p>拷贝http服务需要的配置(已经有了不用拷贝)</p><p>在fastdfs本体库中 </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cp</span> /usr/local/fastdfs/conf/http.conf /etc/fdfs/<br><span class="hljs-built_in">cp</span> /usr/local/fastdfs/conf/mime.types /etc/fdfs/<br></code></pre></td></tr></table></figure><p>创建网络访问存储服务的软连接</p><p>在上传文件到FastDFS后，FastDFS会返回group1&#x2F;M00&#x2F;00&#x2F;00&#x2F;xxxxxxxxxx.xxx。其中group1是卷名，在mod_fastdfs.conf配置文件中已配置了url_have_group_name，以保证URL解析正确。</p><p>而其中的M00是FastDFS保存数据时使用的虚拟目录，需要将这个虚拟目录定位到真实数据目录上。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">ln -s <span class="hljs-regexp">/var/</span>data<span class="hljs-regexp">/fastdfs-storage/</span>store<span class="hljs-regexp">/data/</span>  <span class="hljs-regexp">/var/</span>data<span class="hljs-regexp">/fastdfs-storage/</span>store<span class="hljs-regexp">/data/</span>M00<br></code></pre></td></tr></table></figure><p>修改nginx配置文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /usr/local/nginx/conf<br>vim nginx.conf<br></code></pre></td></tr></table></figure><p>添加local:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">location ~ /group([0-9])/M00 &#123;<br>add_header Content-Disposition <span class="hljs-string">&quot;attachment;filename=<span class="hljs-variable">$arg_attname</span>&quot;</span>;<br>ngx_fastdfs_module;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>这时必须先把fastdfs启动,不然nginx无法正常使用。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">fdfs_trackerd /etc/fdfs/tracker.conf start<br>fdfs_storaged /etc/fdfs/storage.conf start<br>./nginx<br></code></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>使fastdfs client上传文件得到返回地址：</p><p>group1&#x2F;M00&#x2F;00&#x2F;00&#x2F;wKiegGJ1JGCAdd3kAAxZ6KIFrWU.tar.gz</p><p>使用浏览器访问<a href="http://192.168.158.128/group1/M00/00/00/wKiegGJ1JGCAdd3kAAxZ6KIFrWU.tar.gz">http://192.168.158.128/group1/M00/00/00/wKiegGJ1JGCAdd3kAAxZ6KIFrWU.tar.gz</a></p>]]></content>
    
    
    <categories>
      
      <category>fastDfs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>fastDfs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>fastDfs单机版安装</title>
    <link href="/2022/05/06/fastDFS/fastDfs%E5%8D%95%E6%9C%BA%E7%89%88%E5%AE%89%E8%A3%85/"/>
    <url>/2022/05/06/fastDFS/fastDfs%E5%8D%95%E6%9C%BA%E7%89%88%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h3 id="安装FastDFS依赖"><a href="#安装FastDFS依赖" class="headerlink" title="安装FastDFS依赖"></a>安装FastDFS依赖</h3><p>FastDFS是C语言开发的应用。安装必须使用make、cmake和gcc编译器。</p><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">yum install -y make cmake gcc gcc-c++ perl<br></code></pre></td></tr></table></figure><h2 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h2><p>libfatscommon FastDFS分离出的一些公用函数包</p><p>FastDFS FastDFS本体</p><p><a href="https://github.com/happyfish100">https://github.com/happyfish100</a> 作者：余庆（YuQing）</p><p>安装wget:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum install wget<br></code></pre></td></tr></table></figure><p>下载：</p><p><a href="https://github.com/happyfish100/libfastcommon/archive/refs/tags/V1.0.57.tar.gz">https://github.com/happyfish100/libfastcommon/archive/refs/tags/V1.0.57.tar.gz</a></p><p><a href="https://github.com/happyfish100/fastdfs/archive/refs/tags/V6.08.tar.gz">https://github.com/happyfish100/fastdfs/archive/refs/tags/V6.08.tar.gz</a></p><p>解压：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">tar -zxvf libfastcommon-1.0.57.tar.gz<br><br>tar -zxvf fastdfs-6.08.tar.gz <br></code></pre></td></tr></table></figure><h2 id="libfastmon-安装"><a href="#libfastmon-安装" class="headerlink" title="libfastmon 安装"></a>libfastmon 安装</h2><p>编译：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">./make.sh<br></code></pre></td></tr></table></figure><p>安装：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">./make.sh install<br></code></pre></td></tr></table></figure><h2 id="FastDFS本体安装"><a href="#FastDFS本体安装" class="headerlink" title="FastDFS本体安装"></a>FastDFS本体安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">./make.sh<br>./make.sh install<br></code></pre></td></tr></table></figure><p>如果安装出现错误，按照错误提示安装相应的软件，执行.&#x2F;make.sh clean。</p><p>&#x2F;etc&#x2F;fdfs - 配置文件所在位置。</p><p>&#x2F;usr&#x2F;include&#x2F;fastdfs - 包含的一些插件组所在位置</p><p>在解压目录的init.d文件夹中有程序脚本：<strong>fdfs-storaged</strong>和<strong>fdfs-trackerd</strong></p><p>配置文件在<code>/etc/fdfs/</code>目录中</p><p>​tracker.conf - 跟踪器服务配置文件模板</p><p>​storage.conf- 存储服务器配置文件模板</p><p>​client.conf - FastDFS提供的命令行客户端配置文件模板。可以通过命令行测试FastDFS有效性。</p><h2 id="配置修改及启动"><a href="#配置修改及启动" class="headerlink" title="配置修改及启动"></a>配置修改及启动</h2><h3 id="tracker"><a href="#tracker" class="headerlink" title="tracker"></a>tracker</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/fdfs/tracker.conf<br></code></pre></td></tr></table></figure><p>打开 tracker.conf</p><p>修改 base_path 路径，base_path FastDFSTracker启动后使用的根目录，用来存放Tracker data和logs。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">base_path=/home/yuqing/fastdfs -&gt; base_path=/var/data/fastdfs-tracker（自定义目录）<br></code></pre></td></tr></table></figure><p>配置中的路径需要先创建好才能启动服务</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">mkdir</span> -p /var/data/fastdfs-tracker<br></code></pre></td></tr></table></figure><p>启动：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">fdfs_trackerd /etc/fdfs/tracker.conf start<br></code></pre></td></tr></table></figure><p>查看状态：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">fdfs_trackerd /etc/fdfs/tracker.conf status<br></code></pre></td></tr></table></figure><p>停止：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">fdfs_trackerd /etc/fdfs/tracker.conf stop<br></code></pre></td></tr></table></figure><p>重启：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">fdfs_trackerd /etc/fdfs/tracker.conf restart<br></code></pre></td></tr></table></figure><h3 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/fdfs/storage.conf<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">mkdir</span> -p /var/data/fastdfs-storage/base<br><span class="hljs-built_in">mkdir</span> -p /var/data/fastdfs-storage/store<br></code></pre></td></tr></table></figure><p>修改storage.conf</p><p>base_path&#x3D;&#x2F;home&#x2F;yuqing&#x2F;fastdfs -&gt; base_path&#x3D;&#x2F;var&#x2F;data&#x2F;fastdfs-storage&#x2F;base（自定义目录）</p><p>store_path0&#x3D;&#x2F;home&#x2F;yuqing&#x2F;fastdfs -&gt; store_path0&#x3D;&#x2F;var&#x2F;data&#x2F;fastdfs-storage&#x2F;store（自定义目录）</p><p>tracker_server&#x3D;192.168.150.11:22122 -&gt; tracker_server&#x3D;tracker服务IP:22122</p><p>base_path - 基础路径。用于保存storage server基础数据内容和日志内容的目录。</p><p>store_path0 - 存储路径。是用于保存FastDFS中存储文件的目录，就是要创建256*256个子目录的位置。base_path和store_path0可以使用同一个目录。</p><p>tracker_server - 跟踪服务器位置。就是跟踪服务器的ip和端口。</p><p>启动：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">fdfs_storaged /etc/fdfs/storage.conf start<br></code></pre></td></tr></table></figure><p>启动成功后，配置文件中base_path指向的目录中出现FastDFS服务相关数据目录（data目录、logs目录）</p><p>配置文件中的store_path0指向的目录中同样出现FastDFS存储相关数据录（data目录）</p><p>其中$store_path0&#x2F;data&#x2F;目录中默认创建若干子孙目录（两级目录层级总计256*256个目录），是用于存储具体文件数据的。</p><p>Storage服务器启动比较慢，因为第一次启动的时候，需要创建256*256个目录。</p><p>查看状态：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">fdfs_storaged /etc/fdfs/storage.conf status<br></code></pre></td></tr></table></figure><p>停止：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">fdfs_storaged /etc/fdfs/storage.conf stop<br></code></pre></td></tr></table></figure><p>重启：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">fdfs_storaged /etc/fdfs/storage.conf restart<br></code></pre></td></tr></table></figure><h3 id="client"><a href="#client" class="headerlink" title="client"></a>client</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">mkdir</span> -p /fastdfs/client<br></code></pre></td></tr></table></figure><p>修改 client.conf</p><p>base_path&#x3D;&#x2F;home&#x2F;yuqing&#x2F;fastdfs -&gt; base_path&#x3D;&#x2F;fastdfs&#x2F;client （自定义目录）</p><p>tracker_server&#x3D;192.168.150.11:22122 -&gt; tracker_server&#x3D;tracker服务IP:22122</p><p>base_path - 就是客户端命令行执行过程时临时数据存储位置。</p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>使用客户端上传文件到服务器：</p><p>&#x2F;usr&#x2F;local&#x2F;fastdfs-6.08.tar.gz 为上传文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">fdfs_upload_file /etc/fdfs/client.conf /usr/local/fastdfs-6.08.tar.gz<br>fdfs_download_file  /etc/fdfs/client.conf group1/M00/00/00/wKiehGJ5CwiAfS3OAAxZ6KIFrWU.tar.gz<br></code></pre></td></tr></table></figure><p>上传结束后，返回group1&#x2F;M00&#x2F;00&#x2F;00&#x2F;xxxxxxxxxx.xxx，检查storage服务结点中的$store_path0&#x2F;data&#x2F;00&#x2F;00&#x2F;目录中是否有上传的文件（一般情况上传的文件按顺序保存在$store_path0&#x2F;data&#x2F;00&#x2F;00&#x2F;目录中，不能完全保证）。</p><p>&#x2F;var&#x2F;data&#x2F;fastdfs-storage&#x2F;store&#x2F;data&#x2F;00&#x2F;00</p><p>上传文件结果：group1&#x2F;M00&#x2F;00&#x2F;00&#x2F;wKiegGJ1JDWAVWWhAAxZ6KIFrWU.tar.gz</p><p>组名：<strong>group1</strong>文件上传后所在的storage组名称，在文件上传成功后有storage服务器返回，需要客户端自行保存。</p><p>虚拟磁盘路径：<strong>M00</strong>  storage配置的虚拟路径，与磁盘选项store_path*对应。如果配置了store_path0则是M00，如果配置了store_path1则是M01，以此类推。</p><p>数据两级目录：**&#x2F;00&#x2F;00** storage服务器在每个虚拟磁盘路径下创建的两级目录，用于存储数据文件。</p><p>文件名：<strong>wKiegGJ1JDWAVWWhAAxZ6KIFrWU.tar.gz</strong></p><p>删除文件：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">fdfs_delete_file /etc/fdfs/client.conf group1/M00/00/00/wKiegGJ1JDWAVWWhAAxZ6KIFrWU.tar.gz<br></code></pre></td></tr></table></figure><h2 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h2><p>配置了client.conf后，执行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">fdfs_monitor /etc/fdfs/client.conf<br></code></pre></td></tr></table></figure><p>执行后显示</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">server_count=2<br></code></pre></td></tr></table></figure><p>在storage的服务器，执行：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">fdfs_monitor /etc/fdfs/storage.conf<br></code></pre></td></tr></table></figure><p>执行结果同上。</p>]]></content>
    
    
    <categories>
      
      <category>fastDfs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>fastDfs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java使用fastdfs</title>
    <link href="/2022/05/06/fastDFS/java%E4%BD%BF%E7%94%A8fastDfs/"/>
    <url>/2022/05/06/fastDFS/java%E4%BD%BF%E7%94%A8fastDfs/</url>
    
    <content type="html"><![CDATA[<h3 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h3><p>安装了maven</p><h2 id="使用fastdfs-client-java"><a href="#使用fastdfs-client-java" class="headerlink" title="使用fastdfs-client-java"></a>使用fastdfs-client-java</h2><p><a href="https://github.com/happyfish100/fastdfs-client-java">https://github.com/happyfish100/fastdfs-client-java</a></p><h3 id="在maven项目pom-xml中添加依赖"><a href="#在maven项目pom-xml中添加依赖" class="headerlink" title="在maven项目pom.xml中添加依赖"></a>在maven项目pom.xml中添加依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.csource<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastdfs-client-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.29-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>一般下不下来：</p><p>可以去github: <a href="https://github.com/happyfish100/fastdfs-client-java/archive/refs/tags/V1.28.tar.gz%E4%B8%8B%E8%BD%BD">https://github.com/happyfish100/fastdfs-client-java/archive/refs/tags/V1.28.tar.gz下载</a></p><p>并mvn clean install 安装到本地仓库。</p><h3 id="加载配置"><a href="#加载配置" class="headerlink" title="加载配置"></a>加载配置</h3><p>配置文件两种conf和properties</p><p>把配置文件放到classpath目录中：fdfs_client.conf</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">connect_timeout</span> = <span class="hljs-number">2</span><br><span class="hljs-attr">network_timeout</span> = <span class="hljs-number">30</span><br><span class="hljs-attr">charset</span> = UTF-<span class="hljs-number">8</span><br><span class="hljs-attr">http.tracker_http_port</span> = <span class="hljs-number">80</span><br><span class="hljs-attr">http.anti_steal_token</span> = <span class="hljs-literal">no</span><br><span class="hljs-attr">http.secret_key</span> = FastDFS1234567890<br><br><span class="hljs-attr">tracker_server</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">11.247</span>:<span class="hljs-number">22122</span><br><span class="hljs-attr">tracker_server</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">11.248</span>:<span class="hljs-number">22122</span><br><span class="hljs-attr">tracker_server</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">11.249</span>:<span class="hljs-number">22122</span><br><br><span class="hljs-attr">connection_pool.enabled</span> = <span class="hljs-literal">true</span><br><span class="hljs-attr">connection_pool.max_count_per_entry</span> = <span class="hljs-number">500</span><br><span class="hljs-attr">connection_pool.max_idle_time</span> = <span class="hljs-number">3600</span><br><span class="hljs-attr">connection_pool.max_wait_time_in_ms</span> = <span class="hljs-number">1000</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">加载原 conf 格式文件配置：<br>ClientGlobal.init(<span class="hljs-string">&quot;fdfs_client.conf&quot;</span>);<br></code></pre></td></tr></table></figure><p>也可以是properties : fastdfs-client.properties</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">fastdfs.connect_timeout_in_seconds</span> = <span class="hljs-string">5</span><br><span class="hljs-attr">fastdfs.network_timeout_in_seconds</span> = <span class="hljs-string">30</span><br><span class="hljs-attr">fastdfs.charset</span> = <span class="hljs-string">UTF-8</span><br><span class="hljs-attr">fastdfs.http_anti_steal_token</span> = <span class="hljs-string">false</span><br><span class="hljs-attr">fastdfs.http_secret_key</span> = <span class="hljs-string">FastDFS1234567890</span><br><span class="hljs-attr">fastdfs.http_tracker_http_port</span> = <span class="hljs-string">80</span><br><br><span class="hljs-attr">fastdfs.tracker_servers</span> = <span class="hljs-string">10.0.11.201:22122,10.0.11.202:22122,10.0.11.203:22122</span><br><br><span class="hljs-attr">fastdfs.connection_pool.enabled</span> = <span class="hljs-string">true</span><br><span class="hljs-attr">fastdfs.connection_pool.max_count_per_entry</span> = <span class="hljs-string">500</span><br><span class="hljs-attr">fastdfs.connection_pool.max_idle_time</span> = <span class="hljs-string">3600</span><br><span class="hljs-attr">fastdfs.connection_pool.max_wait_time_in_ms</span> = <span class="hljs-string">1000</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">加载 properties 格式文件配置：<br>ClientGlobal.initByProperties(<span class="hljs-string">&quot;fastdfs-client.properties&quot;</span>);<br></code></pre></td></tr></table></figure><p>检测加载配置：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">System.out.println(<span class="hljs-string">&quot;ClientGlobal.configInfo(): &quot;</span> + ClientGlobal.configInfo());<br></code></pre></td></tr></table></figure><h3 id="上传和下载"><a href="#上传和下载" class="headerlink" title="上传和下载"></a>上传和下载</h3><p><a href="https://github.com/happyfish100/fastdfs-client-java/blob/master/src/test/java/org/csource/fastdfs/FdfsTest.java">FdfsTest.java</a></p><h2 id="使用FastDFS-Client"><a href="#使用FastDFS-Client" class="headerlink" title="使用FastDFS_Client"></a>使用FastDFS_Client</h2><p><a href="https://github.com/tobato/FastDFS_Client">https://github.com/tobato/FastDFS_Client</a></p><p>在spring boot 环境中使用：</p><p>Pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.tobato<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastdfs-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.27.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Application.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">fdfs:</span><br>  <span class="hljs-attr">so-timeout:</span> <span class="hljs-number">1501</span><br>  <span class="hljs-attr">connect-timeout:</span> <span class="hljs-number">601</span><br>  <span class="hljs-attr">thumb-image:</span>             <span class="hljs-comment">#缩略图生成参数</span><br>    <span class="hljs-attr">width:</span> <span class="hljs-number">150</span><br>    <span class="hljs-attr">height:</span> <span class="hljs-number">150</span><br>  <span class="hljs-attr">tracker-list:</span>            <span class="hljs-comment">#TrackerList参数,支持多个</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.158</span><span class="hljs-number">.128</span><span class="hljs-string">:22122</span><br></code></pre></td></tr></table></figure><p>代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java">   <span class="hljs-meta">@GetMapping(&quot;/test&quot;)</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> FileNotFoundException &#123;<br>       apiService.commonmerMerBind();<br>       <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/Users/qichuanhan/Downloads/install.sh&quot;</span>);<br>       <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file);<br>       <span class="hljs-type">StorePath</span> <span class="hljs-variable">storePath</span> <span class="hljs-operator">=</span>  storageClient.uploadFile(<span class="hljs-string">&quot;group1&quot;</span>, inputStream,<br>               file.length(), <span class="hljs-string">&quot;sh&quot;</span>);<br>       log.info(storePath.getFullPath());<br>       <span class="hljs-comment">//    group1/M00/00/00/wKiegGJ2QZuAGO_pAAB0ILgQ4BQ9615.sh</span><br><br>   &#125;<br><br><span class="hljs-meta">@RequestMapping(&quot;/down&quot;)</span><br>   <span class="hljs-meta">@ResponseBody</span><br>   <span class="hljs-keyword">public</span> ResponseEntity&lt;<span class="hljs-type">byte</span>[]&gt; down(HttpServletResponse resp) &#123;<br><br>       <span class="hljs-type">DownloadByteArray</span> <span class="hljs-variable">cb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DownloadByteArray</span>();<br>       <span class="hljs-type">HttpHeaders</span> <span class="hljs-variable">headers</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpHeaders</span>();<br>       headers.setContentType(MediaType.APPLICATION_OCTET_STREAM);<br>       headers.setContentDispositionFormData(<span class="hljs-string">&quot;attachment&quot;</span>, <span class="hljs-string">&quot;install.sh&quot;</span>);<br>       <span class="hljs-type">byte</span>[] bs = storageClient.downloadFile(<span class="hljs-string">&quot;group1&quot;</span>, <span class="hljs-string">&quot;M00/00/00/wKiegGJ2QZuAGO_pAAB0ILgQ4BQ9615.sh&quot;</span>, cb);<br><br>       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseEntity</span>&lt;&gt;(bs,headers, HttpStatus.OK);<br>   &#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>fastDfs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>fastDfs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql记录不存在插入存在修改</title>
    <link href="/2022/05/06/mysql/%E8%AE%B0%E5%BD%95%E4%B8%8D%E5%AD%98%E5%9C%A8%E6%8F%92%E5%85%A5%E5%AD%98%E5%9C%A8%E4%BF%AE%E6%94%B9/"/>
    <url>/2022/05/06/mysql/%E8%AE%B0%E5%BD%95%E4%B8%8D%E5%AD%98%E5%9C%A8%E6%8F%92%E5%85%A5%E5%AD%98%E5%9C%A8%E4%BF%AE%E6%94%B9/</url>
    
    <content type="html"><![CDATA[<h2 id="引发"><a href="#引发" class="headerlink" title="引发"></a>引发</h2><p>因为项目中使用select for update引发的死锁问题。</p><h2 id="select-for-update为什么会出现死锁"><a href="#select-for-update为什么会出现死锁" class="headerlink" title="select for update为什么会出现死锁"></a>select for update为什么会出现死锁</h2><p>select for update语句是当前读。会有加锁操作。</p><p>mysql加锁规则：</p><p>原则 1：加锁的基本单位是 next-key lock。希望你还记得，next-key lock 是前开后闭区间。</p><p>原则 2：查找过程中访问到的对象才会加锁。</p><p>优化 1：索引上的等值查询，给唯一索引加锁的时候，next-key lock 退化为行锁。只有记录存在时才会优化，不存在时会按普通索引处理。</p><p>优化 2：索引上的等值查询，向右遍历时且最后一个值不满足等值条件的时候，next-key lock 退化为间隙锁。</p><p>一个 bug：唯一索引上的范围查询会访问到不满足条件的第一个值为止。</p><p>next-key lock 是 间隙锁（Gap lock） + 行锁(record lock)</p><p>行锁与行锁之间有冲突关系，比如加了id&#x3D;1的行写锁，别一个想加行写锁时就需要阻塞。</p><p>间隙锁之间没有冲突关系，比如加了[x,-supernum] ，别一个也可以加。它们有共同的目标，即：保护这个间隙，不允许插入值。但，它们之间是不冲突的。</p><p>跟间隙锁存在冲突关系的，是“往这个间隙中插入一个记录”这个操作。</p><p>按照以上描述,  程序实现了以下逻辑：</p><figure class="highlight sql"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><pre><code class="hljs sql"><br><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span>N <span class="hljs-keyword">for</span> <span class="hljs-keyword">update</span>;<br><br><span class="hljs-comment">/*如果行不存在*/</span><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t <span class="hljs-keyword">values</span>(N,N,N);<br><span class="hljs-comment">/*如果行存在*/</span><br><span class="hljs-keyword">update</span> t <span class="hljs-keyword">set</span> d<span class="hljs-operator">=</span>N <span class="hljs-keyword">set</span> id<span class="hljs-operator">=</span>N;<br><br><span class="hljs-keyword">commit</span>;<br></code></pre></td></tr></table></figure><p>当where 条件里是 id &#x3D; n 或者 普通索引的d&#x3D;n 记录不存在时，按照优化1 和 优化2都会退化为间隙锁。因为间隙锁特性所以select for update都可以成功，但是insert时就会出现死锁。</p><h2 id="如何解决记录不存在插入存在修改这个逻辑"><a href="#如何解决记录不存在插入存在修改这个逻辑" class="headerlink" title="如何解决记录不存在插入存在修改这个逻辑"></a>如何解决记录不存在插入存在修改这个逻辑</h2><p>两个方向：</p><p>​1.mysql</p><p>​2.程序代码</p><p>Mysql:</p><p>方法1：</p><p>1.试着插入记录</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> sys_a(name, age, code) <br><br><span class="hljs-comment">-- 默认值</span><br><span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;test1&#x27;</span>, <span class="hljs-number">12</span>, <span class="hljs-string">&#x27;m6&#x27;</span><span class="hljs-keyword">from</span> dual <br><span class="hljs-comment">-- 原来的值</span><br><span class="hljs-keyword">where</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">exists</span> (<span class="hljs-keyword">select</span> name, age, code <span class="hljs-keyword">from</span> sys_a <span class="hljs-keyword">where</span> code <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;m6&#x27;</span>);<br></code></pre></td></tr></table></figure><p>2.一直执行修改</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">update</span> sys_a <span class="hljs-keyword">set</span> age <span class="hljs-operator">=</span> age <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">where</span> code <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;m6&#x27;</span><br></code></pre></td></tr></table></figure><p>缺点：</p><p>​要写两条语句。</p><p>​每次都执行两条语句</p><p>方法2：replace into</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">replace <span class="hljs-keyword">into</span> sys_a(name, age, code) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;test1&#x27;</span>, <span class="hljs-number">20</span>, <span class="hljs-string">&#x27;m8&#x27;</span>)<br></code></pre></td></tr></table></figure><p>replace into相当于，先检测该记录是否存在(根据表上的唯一键)，如果存在，先delete，然后再insert。 这个方法有一个很大的问题，如果记录存在，每次执行完，主键自增id就变了（相当于重新insert了一条），对于有复杂关联的业务场景，如果主表的id变了，其它子表没做好同步，会死得很难看。– 不建议使用该方法！</p><p>方法3：on duplicate key</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> sys_a(name, age, code)  <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;test1&#x27;</span>, <span class="hljs-number">12</span>, <span class="hljs-string">&#x27;m6&#x27;</span>) <br><span class="hljs-keyword">on</span> duplicate key <br><span class="hljs-keyword">update</span> age <span class="hljs-operator">=</span> age <span class="hljs-operator">+</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>insert into … on duplicate key update 这个语义的逻辑是，插入一行数据，如果碰到唯一键约束，就执行后面的更新语句。</p><p>注意，如果有多个列违反了唯一性约束，就会按照索引的顺序，修改跟第一个索引冲突的行。</p><p>需要注意的是，执行这条语句的 affected rows 返回的是 2，很容易造成误解。实际上，真正更新的只有一行，只是在代码实现上，insert 和 update 都认为自己成功了，update 计数加了 1， insert 计数也加了 1。</p><p>其中方法2与方法3都需要惟一索引。</p><p>程序代码上：</p><p>使用java的同步锁。</p><p>使用三方法的分布式锁。</p>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mac虚拟机安装linux</title>
    <link href="/2022/05/06/linux/mac%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AE%89%E8%A3%85linux/"/>
    <url>/2022/05/06/linux/mac%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AE%89%E8%A3%85linux/</url>
    
    <content type="html"><![CDATA[<h2 id="安装vmware"><a href="#安装vmware" class="headerlink" title="安装vmware"></a>安装vmware</h2><p>下载安装包，下一步就行了</p><h2 id="下载ISO镜像"><a href="#下载ISO镜像" class="headerlink" title="下载ISO镜像"></a>下载ISO镜像</h2><p>找个网址下载就行了</p><p><a href="https://www.centos.org/download/">https://www.centos.org/download/</a></p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>拖动ISO到vmware</p><p>自定义名称</p><p>选择“处理器和内存”，设置内存为1GB</p><p>选择“磁盘”，设置为24GB</p><p>启动</p><p>选择安装</p><p>选择语言</p><p>选择磁盘</p><p>设置网络 这时记录IP</p><p>设置root密码</p><p>开始安装</p><h2 id="安装-ifconfig"><a href="#安装-ifconfig" class="headerlink" title="安装 ifconfig"></a>安装 ifconfig</h2><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">yun install ifconfig -y<br></code></pre></td></tr></table></figure><p>如果 没有找到安装包：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum search ifconfig<br></code></pre></td></tr></table></figure><p>安装查出来的包</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum install net-tools.aarch64<br></code></pre></td></tr></table></figure><p>执行ifconfig查看ip</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">ifconfig</span><br></code></pre></td></tr></table></figure><h2 id="使用SSH工具连接"><a href="#使用SSH工具连接" class="headerlink" title="使用SSH工具连接"></a>使用SSH工具连接</h2><p>填写ip port username password连接</p><h2 id="设置hostname"><a href="#设置hostname" class="headerlink" title="设置hostname"></a>设置hostname</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">hostnamectl set-hostname hostname01<br></code></pre></td></tr></table></figure><h2 id="如果安装系统时未设置IP-进入系统后配置"><a href="#如果安装系统时未设置IP-进入系统后配置" class="headerlink" title="如果安装系统时未设置IP,进入系统后配置"></a>如果安装系统时未设置IP,进入系统后配置</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /etc/sysconfig/network-scripts<br><span class="hljs-built_in">ls</span> -l<br><span class="hljs-comment"># 这个名称自己找一下  mac enxx  linux ensxx</span><br>vim ifcfg-ens160<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#网络类型为：以太网</span><br>TYPE=Ethernet<br><span class="hljs-comment">#代理方式：为关闭状态</span><br>PROXY_METHOD=none<br><span class="hljs-comment">#只是浏览器：否</span><br>BROWSER_ONLY=no<br><span class="hljs-comment">#网卡的引导协议【static：静态IP  dhcp：动态IP   none：不指定，不指定容易出现各种各样的网络受限】</span><br>BOOTPROTO=none<br><span class="hljs-comment">#默认路由</span><br>DEFROUTE=<span class="hljs-built_in">yes</span><br><span class="hljs-comment">#是否开启IPV4致命错误检测</span><br>IPV4_FAILURE_FATAL=no<br><span class="hljs-comment">#IPV6是否自动初始化：是（现在还未用到IPV6，不会有任何影响）</span><br>IPV6INIT=<span class="hljs-built_in">yes</span><br><span class="hljs-comment">#IPV6是否自动配置：是（现在还未用到IPV6，不会有任何影响）</span><br>IPV6_AUTOCONF=<span class="hljs-built_in">yes</span><br><span class="hljs-comment">#IPV6是否可以为默认路由：是（现在还未用到IPV6，不会有任何影响）</span><br>IPV6_DEFROUTE=<span class="hljs-built_in">yes</span><br><span class="hljs-comment">#是否开启IPV6致命错误检测</span><br>IPV6_FAILURE_FATAL=no<br><span class="hljs-comment">#IPV6地址生成模型</span><br>IPV6_ADDR_GEN_MODE=stable-privacy<br><span class="hljs-comment">#IPV6地址生成模型</span><br>IPV6_PRIVACY=no<br><span class="hljs-comment">#网卡物理设备名称</span><br>NAME=ens160<br><span class="hljs-comment">#通用唯一识别码，每一个网卡都会有，不能重复，否则两台linux机器只有一台可上网</span><br>UUID=68723e72-c00e-4164-ad75-2433e5bcde47<br><span class="hljs-comment">#网卡设备名称，必须和‘NAME’值一样</span><br>DEVICE=ens160<br><span class="hljs-comment">#是否开机启动，要想网卡开机就启动或通过 `systemctl restart network`控制网卡,必须设置为 `yes`</span><br>ONBOOT=<span class="hljs-built_in">yes</span><br><span class="hljs-comment">#iP地址</span><br>IPADDR=192.168.158.136<br><span class="hljs-comment">#和 netmask Genmask  子网掩码 24 代表 255.255.255.0</span><br>PREFIX=24<br><span class="hljs-comment">#网关</span><br>GATEWAY=192.168.158.2<br><span class="hljs-comment">#DNS服务器地址  必须有后面的1，不然不认</span><br>DNS1=192.168.158.2<br></code></pre></td></tr></table></figure><p>配置静态IP只要配置：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#是否开机启动，要想网卡开机就启动或通过 `systemctl restart network`控制网卡,必须设置为 `yes`</span><br>ONBOOT=<span class="hljs-built_in">yes</span><br><span class="hljs-comment">#网卡的引导协议【static：静态IP  dhcp：动态IP   none：不指定，不指定容易出现各种各样的网络受限】</span><br>BOOTPROTO=static<br><span class="hljs-comment">#iP地址</span><br>IPADDR=192.168.158.136<br><span class="hljs-comment">#和 netmask Genmask  子网掩码 24 代表 255.255.255.0</span><br>PREFIX=24<br><span class="hljs-comment">#网关</span><br>GATEWAY=192.168.158.2<br><span class="hljs-comment">#DNS服务器地址  必须有后面的1，不然不认</span><br>DNS1=192.168.158.2<br></code></pre></td></tr></table></figure><p>重启网卡服务</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">systemctl restart network<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>node安装+hexo执行+布署网页</title>
    <link href="/2022/05/06/hexo/node%E5%AE%89%E8%A3%85+hexo%E6%89%A7%E8%A1%8C+%E5%B8%83%E7%BD%B2%E7%BD%91%E9%A1%B5/"/>
    <url>/2022/05/06/hexo/node%E5%AE%89%E8%A3%85+hexo%E6%89%A7%E8%A1%8C+%E5%B8%83%E7%BD%B2%E7%BD%91%E9%A1%B5/</url>
    
    <content type="html"><![CDATA[<h2 id="node安装"><a href="#node安装" class="headerlink" title="node安装"></a>node安装</h2><p>下载：<a href="https://nodejs.org/en/">https://nodejs.org/en/</a></p><p>点击安装</p><p>验证：</p><p>node -v</p><p>npm -v</p><p>创建环境变量:</p><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">vim .bash_profile  <br>PATH=<span class="hljs-variable">$PATH</span>:/usr/local/bin/<br>:wq  <br></code></pre></td></tr></table></figure><p>使环境变量生效:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">echo</span> <span class="hljs-variable">$PATH</span><br></code></pre></td></tr></table></figure><p>npm 下载时有问题，使用cnpm</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">npm get registry<br>npm config <span class="hljs-built_in">set</span> registry http://registry.npm.taobao.org/<br>npm config <span class="hljs-built_in">set</span> registry https://registry.npmjs.org/<br>sudo npm install -g cnpm  //之后输入密码<br>cnpm -v<br></code></pre></td></tr></table></figure><h2 id="安装hexo"><a href="#安装hexo" class="headerlink" title="安装hexo"></a>安装hexo</h2><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">npm install -g hexo-<span class="hljs-keyword">cli</span><br></code></pre></td></tr></table></figure><p>如果报Error: EACCES: permission denied, mkdir ‘&#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;hexo‘</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo <span class="hljs-built_in">chown</span> -R <span class="hljs-variable">$USER</span> /usr/local/lib/node_modules<br></code></pre></td></tr></table></figure><p>将 Hexo 所在的目录下的 <code>node_modules</code> 添加到环境变量之中即可直接使用 <code>hexo &lt;command&gt;</code>：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;PATH=&quot;$PATH:./node_modules/.bin&quot;&#x27;</span> &gt;&gt; ~/.profile<br></code></pre></td></tr></table></figure><p>Init:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">hexo</span> init<span class="hljs-meta"> [folder]</span><br></code></pre></td></tr></table></figure><p>new:</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gauss">hexo <span class="hljs-keyword">new</span> [layout] &lt;<span class="hljs-built_in">title</span>&gt;<br></code></pre></td></tr></table></figure><p>cnpm install</p><p>node-sass报不支持系统（os）如果报错：</p><p>​cnpm install node-sass –dev &#x2F; yarn add node-sass –dev</p><p>Generate:</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs verilog">hexo <span class="hljs-keyword">generate</span><br></code></pre></td></tr></table></figure><p>这里已经有网页了。</p><h2 id="布署网页"><a href="#布署网页" class="headerlink" title="布署网页"></a>布署网页</h2><p>这里不是使用的hexo,使用github+域名来进行布署访问</p><p>新建一个文件夹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">git init<br><br>git remote add origin git@github.com:airingHan/blog.git<br></code></pre></td></tr></table></figure><p>如果换主题要删除再提交，如果不是可以替换。</p>]]></content>
    
    
    <categories>
      
      <category>hexo</category>
      
      <category>node</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hexo</tag>
      
      <tag>node</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql热备份</title>
    <link href="/2022/05/05/mysql/mysql%E7%83%AD%E5%A4%87%E4%BB%BD/"/>
    <url>/2022/05/05/mysql/mysql%E7%83%AD%E5%A4%87%E4%BB%BD/</url>
    
    <content type="html"><![CDATA[<h2 id="理论"><a href="#理论" class="headerlink" title="理论"></a>理论</h2><p>采用数据库已经入库的数据进行备份。对binlog进行备份。</p><h2 id="准备数据库"><a href="#准备数据库" class="headerlink" title="准备数据库"></a>准备数据库</h2><h2 id="mysqldump逻辑备份"><a href="#mysqldump逻辑备份" class="headerlink" title="mysqldump逻辑备份"></a>mysqldump逻辑备份</h2><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">/usr/local/mysql/bin/mysqldump -h127.0.0.1 -P3306 -uroot -p<span class="hljs-string">&#x27;密码&#x27;</span> trans-core-dev --single-transaction --default-character-set=utf8mb4  | gzip &gt; /home/trans/db_backup/sql/trans_core_dev_`<span class="hljs-built_in">date</span> +%Y%m%d`.sql.gz<br></code></pre></td></tr></table></figure><h2 id="mysqlbinlog-对binlog备份"><a href="#mysqlbinlog-对binlog备份" class="headerlink" title="mysqlbinlog 对binlog备份"></a>mysqlbinlog 对binlog备份</h2><p>静态备份：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">./mysqlbinlog -R -h127.0.0.1 -uroot -p密码 --raw --result-file=/home/trans/db_backup/binlog  --to-last-log log-bin.000178<br></code></pre></td></tr></table></figure><p>到最后一个日志文件停止</p><p>动态备份：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">./mysqlbinlog -R -h127.0.0.1 -uroot -p密码 --raw --stop-never --result-file=/home/trans/db_backup/binlog  --to-last-log log-bin.000178 &amp;<br></code></pre></td></tr></table></figure><p>–stop-never 到达最后一个日志文件的末尾后，继续保持与服务器的连接并读取新事件</p>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nginx四层负载</title>
    <link href="/2022/04/22/linux/nginx%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E9%85%8D%E7%BD%AE/"/>
    <url>/2022/04/22/linux/nginx%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E9%85%8D%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<h2 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h2><p>服务器上已经有nginx。</p><h2 id="查看是否有ngx-stream-proxy-module"><a href="#查看是否有ngx-stream-proxy-module" class="headerlink" title="查看是否有ngx_stream_proxy_module"></a>查看是否有ngx_stream_proxy_module</h2><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">./nginx -V<br></code></pre></td></tr></table></figure><p>with后有ngx_stream_proxy_module，说明已安装。</p><p>configure arguments: 为以前的编译时的参数</p><p>安装ngx_stream_proxy_module</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 1 </span><br>./configure --with-stream + 加上原来的模块<br><span class="hljs-comment"># 2</span><br>make&amp;&amp; make install<br></code></pre></td></tr></table></figure><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">stream</span> &#123;<br><span class="hljs-section">upstream</span> pos_netty_cluster &#123;  <span class="hljs-comment"># lb集群</span><br><span class="hljs-attribute">server</span> <span class="hljs-number">172.24.110.190:8006</span>;<br><span class="hljs-attribute">server</span> <span class="hljs-number">172.19.233.16:8006</span>;<br>&#125;<br><br><span class="hljs-section">server</span> &#123;<br><span class="hljs-attribute">listen</span> <span class="hljs-number">8099</span>;<br><span class="hljs-attribute">proxy_pass</span> pos_netty_cluster;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>stream 和 http是同一级别的配置项。</p><p>重启nginx</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">./nginx -s reload<br></code></pre></td></tr></table></figure><p>查看是否有监听端口</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">netstat -tnl</span> <br></code></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>可以使用telnet、jmeter等工具进行测试。</p>]]></content>
    
    
    <categories>
      
      <category>nginx</category>
      
    </categories>
    
    
    <tags>
      
      <tag>nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>20万数据导出</title>
    <link href="/2022/04/19/java/20%E4%B8%87%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%87%BA/"/>
    <url>/2022/04/19/java/20%E4%B8%87%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%87%BA/</url>
    
    <content type="html"><![CDATA[<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.csdn.net/weixin_33719619/article/details/88983710">https://blog.csdn.net/weixin_33719619/article/details/88983710</a></p><p><a href="https://www.csdn.net/tags/MtjacgxsMTM1NC1ibG9n.html">https://www.csdn.net/tags/MtjacgxsMTM1NC1ibG9n.html</a></p><p><a href="https://blog.csdn.net/qq_40127376/article/details/124032521">https://blog.csdn.net/qq_40127376/article/details/124032521</a></p><h2 id="方向"><a href="#方向" class="headerlink" title="方向"></a>方向</h2><p>考虑涉及到的软件及中间件等。</p><p>我这是个小项目。</p><p>浏览器(chrome)   固定超时时间为 5分钟。</p><p>nginx  做为负载均衡(7层)   有保持连接的时间，有跟后端建立连接的超时间，有跟后端连接后等待后端响应的时间，有后端向nginx发送数据的超时时间。</p><p>后端：</p><p>​sql的优化， 使用索引等</p><p>​多线程执行sql，然后合并数据</p><p>​写入xlsx的工具的效率。</p><h2 id="实操"><a href="#实操" class="headerlink" title="实操"></a>实操</h2><p>java后端：</p><p>创建一个callable</p><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProfitTransProfitCallable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Callable</span>&lt;List&lt;TransProfitPo&gt;&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> TransProfitPo transProfitPo;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ProfitTransProfitCallable</span><span class="hljs-params">(TransProfitPo transProfitPo)</span> &#123;<br>        <span class="hljs-built_in">this</span>.transProfitPo = transProfitPo;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;TransProfitPo&gt; <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        logger.info(<span class="hljs-string">&quot;执行&#123;&#125;， &#123;&#125;&quot;</span>, transProfitPo.getBeginTime(), transProfitPo.getEndTime());<br>        <span class="hljs-keyword">return</span> iProfitManaService.getTransProfitPoList(transProfitPo, <span class="hljs-literal">true</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 15天</span><br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">24</span>,<br>                <span class="hljs-number">24</span>,<br>                <span class="hljs-number">30L</span>,<br>                TimeUnit.SECONDS,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">360</span>));<br><br>        <span class="hljs-type">Date</span> <span class="hljs-variable">beginTime</span> <span class="hljs-operator">=</span> transProfitPo.getBeginTime();<br>        <span class="hljs-type">DateTime</span> <span class="hljs-variable">beginDate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(transProfitPo.getBeginTime());<br>        <span class="hljs-type">DateTime</span> <span class="hljs-variable">endDate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(transProfitPo.getEndTime());<br>        List&lt;Callable&lt;List&lt;TransProfitPo&gt;&gt;&gt; tasks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        List&lt;Map&lt;String, Date&gt;&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">while</span> (beginDate.isBefore(endDate)) &#123;<br>            Map&lt;String, Date&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>            map.put(<span class="hljs-string">&quot;startDate&quot;</span>, beginDate.toDate());<br>            beginDate = beginDate.plusHours(<span class="hljs-number">1</span>);<br>            map.put(<span class="hljs-string">&quot;endDate&quot;</span>, beginDate.toDate());<br>            list.add(map);<br><br>            <span class="hljs-keyword">if</span> (list.size() &gt; <span class="hljs-number">360</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(<span class="hljs-string">&quot;查询时间间隔过大&quot;</span>);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (Map&lt;String, Date&gt; item : list) &#123;<br>            <span class="hljs-type">TransProfitPo</span> <span class="hljs-variable">part</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransProfitPo</span>();<br>            BeanUtils.copyProperties(transProfitPo, part);<br>            part.setBeginTime(item.get(<span class="hljs-string">&quot;startDate&quot;</span>));<br>            part.setEndTime(item.get(<span class="hljs-string">&quot;endDate&quot;</span>));<br>            <span class="hljs-type">Callable</span> <span class="hljs-variable">callable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProfitTransProfitCallable</span>(part);<br>            tasks.add(MDCUtil.wrap(callable, MDC.getCopyOfContextMap()));<br>        &#125;<br><br>        List&lt;TransProfitPo&gt; transProfitPoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">try</span> &#123;<br>            List&lt;Future&lt;List&lt;TransProfitPo&gt;&gt;&gt; futures = executorService.invokeAll(tasks);<br>            <span class="hljs-keyword">if</span> (futures != <span class="hljs-literal">null</span> &amp;&amp; futures.size() &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// 迭代结果</span><br>                <span class="hljs-keyword">for</span> (Future&lt;List&lt;TransProfitPo&gt;&gt; future : futures) &#123;<br>                    transProfitPoList.addAll(future.get());<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(<span class="hljs-string">&quot;导出错误&quot;</span>);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">// 关闭线程池</span><br>            executorService.shutdown();<br>        &#125;<br><br>        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        logger.info(<span class="hljs-string">&quot;交易分润列表导出开始&quot;</span>);<br>        ExcelUtil&lt;TransProfitPo&gt; excelUtil = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExcelUtil</span>&lt;&gt;(TransProfitPo.class);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">dateToStr</span> <span class="hljs-operator">=</span> DateUtils.parseDateToStr(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>, beginTime);<br>        <span class="hljs-type">AjaxResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> excelUtil.exportExcel(transProfitPoList,<span class="hljs-string">&quot;交易分润&quot;</span>+dateToStr);<br>        logger.info(<span class="hljs-string">&quot;交易分润列表导出结束&#123;&#125;&quot;</span>, System.currentTimeMillis() - startTime);<br>        <span class="hljs-keyword">return</span> result;<br></code></pre></td></tr></table></figure><p>这里是按时间，一小时一小时的查数据，然后合并数据，生成xslx文件</p><p>nginx配置：</p><p>只设置单个接口，不影响其他接口的响应超时。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> /prod-api/backstage/profit/exportTransProfitPoList &#123;<br><span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$http_host</span>;<br><span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br><span class="hljs-attribute">proxy_set_header</span> REMOTE-HOST <span class="hljs-variable">$remote_addr</span>;<br><span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br><span class="hljs-attribute">proxy_pass</span> http://trans-core/backstage/profit/exportTransProfitPoList;<br><span class="hljs-comment"># 设置连接的超时时间</span><br><span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">300</span>;<br>    <span class="hljs-comment"># 跟后端建立连接的超时时间</span><br><span class="hljs-attribute">proxy_connect_timeout</span> <span class="hljs-number">300</span>;<br>    <span class="hljs-comment"># 等后端响应的超时时间</span><br><span class="hljs-attribute">proxy_read_timeout</span> <span class="hljs-number">300</span>;<br>    <span class="hljs-comment"># 后端数据回传超时时间</span><br><span class="hljs-attribute">proxy_send_timeout</span> <span class="hljs-number">300</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>xlsx</category>
      
    </categories>
    
    
    <tags>
      
      <tag>xlsx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用kettle对数据库类型及表变更的调研</title>
    <link href="/2022/02/14/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E4%BD%BF%E7%94%A8kettle%E5%AF%B9%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B1%BB%E5%9E%8B%E5%8F%8A%E8%A1%A8%E5%8F%98%E6%9B%B4%E7%9A%84%E8%B0%83%E7%A0%94/"/>
    <url>/2022/02/14/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E4%BD%BF%E7%94%A8kettle%E5%AF%B9%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B1%BB%E5%9E%8B%E5%8F%8A%E8%A1%A8%E5%8F%98%E6%9B%B4%E7%9A%84%E8%B0%83%E7%A0%94/</url>
    
    <content type="html"><![CDATA[<h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>MS sql server 到 mysql</p><p>数据表结构的变更，由数据库A为sql server、数据库B为mysql,</p><p>1.A的表test_a 转换为 B的表test_a;</p><p>2.A的表test_a 转换为B的表test_a及test_b</p><p>3.A的表test_a及test_b转换为B的test_a</p><h3 id="kettle的安装"><a href="#kettle的安装" class="headerlink" title="kettle的安装"></a>kettle的安装</h3><p>下载地址：<a href="http://www.kettle.be/">http://www.kettle.be/</a></p><p>配合的mysql的驱动：</p><p>下载地址：<a href="https://downloads.mysql.com/archives/c-j/">https://downloads.mysql.com/archives/c-j/</a></p><p>点击Archives（档案）： 5.1.49  这里的版本号很重要，kettle连接mysql数据库时会报错，（试的，不知道kettle官方的映射在哪）</p><h3 id="kettle-对1的实现"><a href="#kettle-对1的实现" class="headerlink" title="kettle 对1的实现"></a>kettle 对1的实现</h3><p>新建转换-&gt;添加两个数据库连接-》添加输入-》添加输出（表输出或者插入&#x2F;更新）-》输入与输出关连。</p><h3 id="kettle对3的实现"><a href="#kettle对3的实现" class="headerlink" title="kettle对3的实现"></a>kettle对3的实现</h3><p>新建转换-》添加两个数据库连接-》添加输入-》写入多表关联查询的sql-》添加输出表输出-》输入与输出关连-》字段映射关系设置</p><h3 id="kettle对2的实现"><a href="#kettle对2的实现" class="headerlink" title="kettle对2的实现"></a>kettle对2的实现</h3><p>新建转换-》添加两个数据库连接-》添加输入-》查询的sql-》添加输出2个-》输入与输出关连-》右键选择数据发送：选择数据复制发送-》字段映射关系设置</p><h3 id="大记录的表如何转换"><a href="#大记录的表如何转换" class="headerlink" title="大记录的表如何转换"></a>大记录的表如何转换</h3><p>新建转换-》编写获取总条数的sql-&gt;转换成页码 如 </p><p>每页 10000条，这个由右键-》转换设置-》杂项-》记录集合里的记录数   这个值来，看内存大小</p><table><thead><tr><th>1</th></tr></thead><tbody><tr><td>1</td></tr><tr><td>2</td></tr></tbody></table><p>新建具体转换-》数据库A的表输出到数据库B</p><p>右键具体转换中的输出表-》改变开始复制的数量   这里是多线程输出。</p><p>新建作业-》引用页码的转换-》具体转换-》结束</p><p>数据库连接超时，怎么办</p><p>数据库连接的配置可以在表名后加入？autoReconnect&#x3D;true</p>]]></content>
    
    
    <categories>
      
      <category>kettle</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>spring boot配置引用yml</title>
    <link href="/2022/02/09/spring/spring_boot%E9%85%8D%E7%BD%AE%E5%BC%95%E7%94%A8yml/"/>
    <url>/2022/02/09/spring/spring_boot%E9%85%8D%E7%BD%AE%E5%BC%95%E7%94%A8yml/</url>
    
    <content type="html"><![CDATA[<h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3><p>spring boot 项目有以下配置文档：</p><p>application.yml</p><p>application-druid.yml</p><p>application-redis.yml</p><p>当需要在springboot中引用其他的yml文件时，需要在application.yml里配置:</p><figure class="highlight yaml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">include:</span> <span class="hljs-string">druid,redis</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>spring boot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring boot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>动态创建月维度表及sharding-jdbc单库分表实现</title>
    <link href="/2022/02/09/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BA%E6%9C%88%E7%BB%B4%E5%BA%A6%E8%A1%A8%E5%8F%8Asharding-jdbc5.0%E5%8D%95%E5%BA%93%E5%88%86%E8%A1%A8%E5%AE%9E%E7%8E%B0/"/>
    <url>/2022/02/09/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BA%E6%9C%88%E7%BB%B4%E5%BA%A6%E8%A1%A8%E5%8F%8Asharding-jdbc5.0%E5%8D%95%E5%BA%93%E5%88%86%E8%A1%A8%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h3 id="单库分表"><a href="#单库分表" class="headerlink" title="单库分表"></a>单库分表</h3><p>一张表数据达到一定级别后，查询、插入、修改、DDL等效率降低，需要优化。这时可以使用单库分表，进行数据的拆分。</p><p>主要解决单表数据量过大的问题。</p><p>未解决：CPU、内存、带宽等单库的资源限制。</p><h3 id="sharding-jdbc固定actual-data-nodes问题，需要动态生成表，采用定时任务实现"><a href="#sharding-jdbc固定actual-data-nodes问题，需要动态生成表，采用定时任务实现" class="headerlink" title="sharding-jdbc固定actual-data-nodes问题，需要动态生成表，采用定时任务实现"></a>sharding-jdbc固定actual-data-nodes问题，需要动态生成表，采用定时任务实现</h3><p>创建配置文件：application-shardingjdbc.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 分表的表名用于定时创建表</span><br><span class="hljs-attr">sharding-jdbc:</span><br>  <span class="hljs-attr">tableNames:</span> <span class="hljs-string">order_card_consume</span><br></code></pre></td></tr></table></figure><p>application.yml引用</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">include:</span> <span class="hljs-string">shardingjdbc</span><br></code></pre></td></tr></table></figure><p>创建表mapper:CreateTableMapper.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Param;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 创建表映射</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CreateTableMapper</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据旧表创建新表，表结构一样</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> newTableName 新表名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> oldTableName 旧表名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">createTable</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;newTableName&quot;)</span> String newTableName,</span><br><span class="hljs-params">                    <span class="hljs-meta">@Param(&quot;oldTableName&quot;)</span> String oldTableName)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span></span><br><span class="hljs-meta">        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.trans.backbusi.mapper.CreateTableMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;createTable&quot;</span>&gt;</span><br>        CREATE TABLE $&#123;newTableName&#125; like $&#123;oldTableName&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure><p>表sharding_jdbc_real_table创建及mapper、及xml</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `sharding_jdbc_real_table` (<br>  `id` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `logic_table_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;逻辑表名&#x27;</span>,<br>  `real_table_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;逻辑表名&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_0900_ai_ci COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;sharding-jdbc分表真实表名记录&#x27;</span>;<br></code></pre></td></tr></table></figure><p>定时任务：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.trans.backbusi.mapper.CreateTableMapper;<br><span class="hljs-keyword">import</span> com.trans.common.utils.StringUtils;<br><span class="hljs-keyword">import</span> com.trans.common.utils.uuid.UUID;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.api.hint.HintManager;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.core.rule.TableRule;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.shardingjdbc.jdbc.core.datasource.ShardingDataSource;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.underlying.common.rule.DataNode;<br><span class="hljs-keyword">import</span> org.joda.time.DateTime;<br><span class="hljs-keyword">import</span> org.slf4j.MDC;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> javax.annotation.PostConstruct;<br><span class="hljs-keyword">import</span> javax.sql.DataSource;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Modifier;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 定时任务</span><br><span class="hljs-comment"> * shardingJdbc定时创建表</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service(&quot;shardingJDBCCreateTableTask&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShardingJDBCCreateTableTask</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;sharding-jdbc.tableNames&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String[] tableNames;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CreateTableMapper createTableMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DataSource dataSource;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createTable</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(MDC.get(<span class="hljs-string">&quot;traceId&quot;</span>))) &#123;<br>            MDC.put(<span class="hljs-string">&quot;traceId&quot;</span>, UUID.getUUIDString());<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> DateTime.now();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">year</span> <span class="hljs-operator">=</span> dateTime.getYear();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">month</span> <span class="hljs-operator">=</span> dateTime.getMonthOfYear();<br>            <span class="hljs-keyword">if</span> (month == <span class="hljs-number">12</span>) &#123;<br>                year = year + <span class="hljs-number">1</span>;<br>                month = <span class="hljs-number">1</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                month = month + <span class="hljs-number">1</span>;<br>            &#125;<br>            <span class="hljs-keyword">for</span> (String tableName : tableNames) &#123;<br>                <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">newTableName</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>                newTableName.append(tableName);<br>                newTableName.append(<span class="hljs-string">&quot;_&quot;</span>);<br>                newTableName.append(year);<br>                newTableName.append(<span class="hljs-string">&quot;_&quot;</span>);<br>                newTableName.append(month);<br>                <span class="hljs-type">ShardingJdbcRealTable</span> <span class="hljs-variable">shardingJdbcRealTable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShardingJdbcRealTable</span>();<br>                shardingJdbcRealTable.setLogicTableName(tableName);<br>                shardingJdbcRealTable.setRealTableName(newTableName.toString());<br>                List&lt;ShardingJdbcRealTable&gt; list = shardingJdbcRealTableMapper.selectShardingJdbcRealTableList(shardingJdbcRealTable);<br>                <span class="hljs-keyword">if</span> (list.isEmpty()) &#123;<br>                    createTableMapper.createTable(newTableName.toString(), tableName);<br>                    shardingJdbcRealTable = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShardingJdbcRealTable</span>();<br>                    shardingJdbcRealTable.setId(twitterSnowflakeIdWorker.nextId());<br>                    shardingJdbcRealTable.setLogicTableName(tableName);<br>                    shardingJdbcRealTable.setRealTableName(newTableName.toString());<br>                    shardingJdbcRealTableMapper.insertShardingJdbcRealTable(shardingJdbcRealTable);<br>                    actualTablesRefresh();<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            MDC.remove(<span class="hljs-string">&quot;traceId&quot;</span>);<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 初始化sharding-jdbc的真实表节点</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initActualTablesNode</span><span class="hljs-params">()</span> &#123;<br>        actualTablesRefresh();<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 刷新sharding-jdbc的真实表节点</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">actualTablesRefresh</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ShardingSphereDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> (ShardingSphereDataSource) <span class="hljs-built_in">this</span>.dataSource;<br>            <span class="hljs-keyword">if</span> (tableNames == <span class="hljs-literal">null</span> || tableNames.length == <span class="hljs-number">0</span>) &#123;<br>                log.info(<span class="hljs-string">&quot;分表为空&quot;</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            Collection&lt;ShardingSphereRule&gt; rules = dataSource.getContextManager().getMetaDataContexts().getMetaData(<span class="hljs-string">&quot;logic_db&quot;</span>).getRuleMetaData().getRules();<br>            Map&lt;String, TableRule&gt; tableRuleMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>            <span class="hljs-keyword">for</span> (ShardingSphereRule shardingSphereRule : rules) &#123;<br>                <span class="hljs-keyword">if</span> (shardingSphereRule <span class="hljs-keyword">instanceof</span> ShardingRule) &#123;<br>                    tableRuleMap = ((ShardingRule) shardingSphereRule).getTableRules();<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">for</span> (String tableName : tableNames) &#123;<br>                <span class="hljs-type">TableRule</span> <span class="hljs-variable">tableRule</span> <span class="hljs-operator">=</span> tableRuleMap.get(tableName);<br>                <span class="hljs-keyword">if</span> (tableRule == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                List&lt;DataNode&gt; dataNodes = tableRule.getActualDataNodes();<br>                <span class="hljs-type">Field</span> <span class="hljs-variable">actualDataNodesField</span> <span class="hljs-operator">=</span> TableRule.class.getDeclaredField(<span class="hljs-string">&quot;actualDataNodes&quot;</span>);<br>                <span class="hljs-type">Field</span> <span class="hljs-variable">modifiersField</span> <span class="hljs-operator">=</span> Field.class.getDeclaredField(<span class="hljs-string">&quot;modifiers&quot;</span>);<br>                modifiersField.setAccessible(<span class="hljs-literal">true</span>);<br>                modifiersField.setInt(actualDataNodesField, actualDataNodesField.getModifiers() &amp; ~Modifier.FINAL);<br>                actualDataNodesField.setAccessible(<span class="hljs-literal">true</span>);<br>                List&lt;DataNode&gt; newDataNodes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>                <span class="hljs-comment">// 这里是单库，如果多库还要修改</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">dataSourceName</span> <span class="hljs-operator">=</span> dataNodes.get(<span class="hljs-number">0</span>).getDataSourceName();<br>                <span class="hljs-comment">// 强制走主库</span><br>                HintManager.getInstance().setWriteRouteOnly();<br>                <span class="hljs-type">ShardingJdbcRealTable</span> <span class="hljs-variable">shardingJdbcRealTable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShardingJdbcRealTable</span>();<br>                shardingJdbcRealTable.setLogicTableName(tableName);<br>                List&lt;ShardingJdbcRealTable&gt; list = shardingJdbcRealTableMapper.selectShardingJdbcRealTableList(shardingJdbcRealTable);<br>                List&lt;String&gt; actualDataNodes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>                <span class="hljs-type">String</span> <span class="hljs-variable">databaseTableName</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">for</span> (ShardingJdbcRealTable realTable : list) &#123;<br>                    databaseTableName = dataSourceName + <span class="hljs-string">&quot;.&quot;</span> + realTable.getRealTableName();<br>                    <span class="hljs-type">DataNode</span> <span class="hljs-variable">dataNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataNode</span>(databaseTableName);<br>                    newDataNodes.add(dataNode);<br>                    actualDataNodes.add(databaseTableName);<br>                &#125;<br>                <span class="hljs-comment">// 可用数据节点设置</span><br>                <span class="hljs-type">Method</span> <span class="hljs-variable">generateDataNodesMethod</span> <span class="hljs-operator">=</span> TableRule.class.getDeclaredMethod(<span class="hljs-string">&quot;generateDataNodes&quot;</span>, List.class, Collection.class);<br>                generateDataNodesMethod.setAccessible(<span class="hljs-literal">true</span>);<br>                List&lt;String&gt; dataSourceNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>                dataSourceNames.add(dataSourceName);<br>                generateDataNodesMethod.invoke(tableRule, actualDataNodes, dataSourceNames);<br><br>                actualDataNodesField.set(tableRule, newDataNodes);<br><br>                <span class="hljs-type">Method</span> <span class="hljs-variable">cacheActualDatasourcesAndTablesMethod</span> <span class="hljs-operator">=</span> TableRule.class.getDeclaredMethod(<span class="hljs-string">&quot;getActualTables&quot;</span>, <span class="hljs-literal">null</span>);<br>                cacheActualDatasourcesAndTablesMethod.setAccessible(<span class="hljs-literal">true</span>);<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">actualTables</span> <span class="hljs-operator">=</span> cacheActualDatasourcesAndTablesMethod.invoke(tableRule, <span class="hljs-literal">null</span>);<br>                <span class="hljs-type">Field</span> <span class="hljs-variable">actualTablesField</span> <span class="hljs-operator">=</span> TableRule.class.getDeclaredField(<span class="hljs-string">&quot;actualTables&quot;</span>);<br>                <span class="hljs-type">Field</span> <span class="hljs-variable">actualTablesmodifiersField</span> <span class="hljs-operator">=</span> Field.class.getDeclaredField(<span class="hljs-string">&quot;modifiers&quot;</span>);<br>                actualTablesmodifiersField.setAccessible(<span class="hljs-literal">true</span>);<br>                actualTablesmodifiersField.setInt(actualTablesField, actualTablesField.getModifiers() &amp; ~Modifier.FINAL);<br>                actualTablesField.setAccessible(<span class="hljs-literal">true</span>);<br>                actualTablesField.set(tableRule, actualTables);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;动态分表表名添加sharding-jdbc错误&quot;</span>, e);<br>        &#125;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>定时任务每月最后一天执行创建下一月的表</p><p>定时任务corn表达式：0 0 0 L * ?</p><h3 id="添加sharding-jdbc"><a href="#添加sharding-jdbc" class="headerlink" title="添加sharding-jdbc"></a>添加sharding-jdbc</h3><p>trans-core的pom.xml中druid修改</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--&lt;dependency&gt;--&gt;</span><br>    <span class="hljs-comment">&lt;!--&lt;groupId&gt;com.alibaba&lt;/groupId&gt;--&gt;</span><br>    <span class="hljs-comment">&lt;!--&lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;--&gt;</span><br>    <span class="hljs-comment">&lt;!--&lt;version&gt;$&#123;druid.version&#125;&lt;/version&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--&lt;/dependency&gt;--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shardingsphere-jdbc-core-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>trans-framework中pom.xml修改：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>trans-system中pom.xml修改</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shardingsphere-jdbc-core-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>注释掉DruidConfig.java、DataSourceAspect.java、DruidProperties.java</p><p>application-shardingjdbc.yml修改</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 分表的表名用于定时创建表</span><br><span class="hljs-attr">sharding-jdbc:</span><br>  <span class="hljs-attr">tableNames:</span> <span class="hljs-string">order_card_consume</span><br><br><span class="hljs-comment"># sharding-jdbc配置</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">shardingsphere:</span><br>    <span class="hljs-attr">props:</span><br>      <span class="hljs-attr">sql-show:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">datasource:</span><br>      <span class="hljs-attr">names:</span> <span class="hljs-string">master01,slave01</span><br>      <span class="hljs-attr">master01:</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br>        <span class="hljs-attr">driverClassName:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>        <span class="hljs-attr">url:</span> <br>        <span class="hljs-attr">username:</span> <br>        <span class="hljs-attr">password:</span> <br>        <span class="hljs-comment"># 初始连接数</span><br>        <span class="hljs-attr">initialSize:</span> <span class="hljs-number">5</span><br>        <span class="hljs-comment"># 最小连接池数量</span><br>        <span class="hljs-attr">minIdle:</span> <span class="hljs-number">10</span><br>        <span class="hljs-comment"># 最大连接池数量</span><br>        <span class="hljs-attr">maxActive:</span> <span class="hljs-number">20</span><br>        <span class="hljs-comment"># 配置获取连接等待超时的时间</span><br>        <span class="hljs-attr">maxWait:</span> <span class="hljs-number">60000</span><br>        <span class="hljs-comment"># 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒</span><br>        <span class="hljs-attr">timeBetweenEvictionRunsMillis:</span> <span class="hljs-number">60000</span><br>        <span class="hljs-comment"># 配置一个连接在池中最小生存的时间，单位是毫秒</span><br>        <span class="hljs-attr">minEvictableIdleTimeMillis:</span> <span class="hljs-number">300000</span><br>        <span class="hljs-comment"># 配置一个连接在池中最大生存的时间，单位是毫秒</span><br>        <span class="hljs-attr">maxEvictableIdleTimeMillis:</span> <span class="hljs-number">900000</span><br>        <span class="hljs-comment"># 配置检测连接是否有效</span><br>        <span class="hljs-attr">validationQuery:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-string">FROM</span> <span class="hljs-string">DUAL</span><br>        <span class="hljs-attr">testWhileIdle:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">testOnBorrow:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">testOnReturn:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">poolPreparedStatements:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">maxPoolPreparedStatementPerConnectionSize:</span> <span class="hljs-number">20</span><br>        <span class="hljs-attr">filters:</span> <span class="hljs-string">stat,wall,log4j2</span><br>        <span class="hljs-attr">connectionProperties:</span> <span class="hljs-string">druid.stat.mergeSql\=true;druid.stat.slowSqlMillis\=5000</span><br>      <span class="hljs-attr">slave01:</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br>        <span class="hljs-attr">driverClassName:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>        <span class="hljs-attr">url:</span> <br>        <span class="hljs-attr">username:</span> <br>        <span class="hljs-attr">password:</span> <br>        <span class="hljs-comment"># 初始连接数</span><br>        <span class="hljs-attr">initialSize:</span> <span class="hljs-number">5</span><br>        <span class="hljs-comment"># 最小连接池数量</span><br>        <span class="hljs-attr">minIdle:</span> <span class="hljs-number">10</span><br>        <span class="hljs-comment"># 最大连接池数量</span><br>        <span class="hljs-attr">maxActive:</span> <span class="hljs-number">20</span><br>        <span class="hljs-comment"># 配置获取连接等待超时的时间</span><br>        <span class="hljs-attr">maxWait:</span> <span class="hljs-number">60000</span><br>        <span class="hljs-comment"># 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒</span><br>        <span class="hljs-attr">timeBetweenEvictionRunsMillis:</span> <span class="hljs-number">60000</span><br>        <span class="hljs-comment"># 配置一个连接在池中最小生存的时间，单位是毫秒</span><br>        <span class="hljs-attr">minEvictableIdleTimeMillis:</span> <span class="hljs-number">300000</span><br>        <span class="hljs-comment"># 配置一个连接在池中最大生存的时间，单位是毫秒</span><br>        <span class="hljs-attr">maxEvictableIdleTimeMillis:</span> <span class="hljs-number">900000</span><br>        <span class="hljs-comment"># 配置检测连接是否有效</span><br>        <span class="hljs-attr">validationQuery:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-string">FROM</span> <span class="hljs-string">DUAL</span><br>        <span class="hljs-attr">testWhileIdle:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">testOnBorrow:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">testOnReturn:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">poolPreparedStatements:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">maxPoolPreparedStatementPerConnectionSize:</span> <span class="hljs-number">20</span><br>        <span class="hljs-attr">filters:</span> <span class="hljs-string">stat,wall,log4j2</span><br>        <span class="hljs-attr">connectionProperties:</span> <span class="hljs-string">druid.stat.mergeSql\=true;druid.stat.slowSqlMillis\=5000</span><br>    <span class="hljs-attr">rules:</span><br>      <span class="hljs-attr">sharding:</span><br>        <span class="hljs-comment"># 分表配置</span><br>        <span class="hljs-attr">tables:</span><br>          <span class="hljs-attr">order_card_consume:</span><br>            <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">ms0.order_card_consume</span><br>            <span class="hljs-attr">table-strategy:</span><br>              <span class="hljs-attr">standard:</span><br>                <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">trade_time</span><br>                <span class="hljs-comment"># 必须小写不然找不到</span><br>                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">monthtableshardingalgorithm</span><br>        <span class="hljs-attr">sharding-algorithms:</span><br>          <span class="hljs-attr">monthtableshardingalgorithm:</span><br>            <span class="hljs-attr">type:</span> <span class="hljs-string">CLASS_BASED</span><br>            <span class="hljs-attr">props:</span><br>              <span class="hljs-attr">strategy:</span> <span class="hljs-string">STANDARD</span><br>              <span class="hljs-attr">algorithmClassName:</span> <span class="hljs-string">com.trans.framework.shardingjdbc.MonthTableShardingAlgorithm</span><br>      <span class="hljs-attr">readwrite-splitting:</span><br>        <span class="hljs-attr">data-sources:</span><br>          <span class="hljs-attr">ms0:</span><br>            <span class="hljs-attr">loadBalancerName:</span> <span class="hljs-string">my-load</span><br>            <span class="hljs-attr">writeDataSourceName:</span> <span class="hljs-string">master01</span><br>            <span class="hljs-attr">readDataSourceNames:</span> <span class="hljs-string">slave01</span><br>        <span class="hljs-attr">load-balancers:</span><br>          <span class="hljs-attr">my-load:</span><br>            <span class="hljs-attr">type:</span> <span class="hljs-string">ROUND_ROBIN</span><br><br></code></pre></td></tr></table></figure><p>添加分表算法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.google.common.collect.Range;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.sharding.api.sharding.standard.PreciseShardingValue;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.sharding.api.sharding.standard.RangeShardingValue;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.sharding.api.sharding.standard.StandardShardingAlgorithm;<br><span class="hljs-keyword">import</span> org.joda.time.DateTime;<br><br><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 按时间的月份分表算法</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonthTableShardingAlgorithm</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StandardShardingAlgorithm</span>&lt;Date&gt; &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * = in 的获取表名</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">doSharding</span><span class="hljs-params">(Collection&lt;String&gt; collection, PreciseShardingValue&lt;Date&gt; preciseShardingValue)</span> &#123;<br>        <span class="hljs-type">Date</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> preciseShardingValue.getValue();<br>        <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(date);<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">stringBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        stringBuilder.append(preciseShardingValue.getLogicTableName());<br>        stringBuilder.append(<span class="hljs-string">&quot;_&quot;</span>);<br>        stringBuilder.append(dateTime.getYear());<br>        stringBuilder.append(<span class="hljs-string">&quot;_&quot;</span>);<br>        stringBuilder.append(dateTime.getMonthOfYear());<br>        <span class="hljs-keyword">return</span> stringBuilder.toString();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * BETWEEN AND的获取表名</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Collection&lt;String&gt; <span class="hljs-title function_">doSharding</span><span class="hljs-params">(Collection&lt;String&gt; availableTargetNames, RangeShardingValue&lt;Date&gt; rangeShardingValue)</span> &#123;<br>        List&lt;String&gt; tableNameList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        Range&lt;Date&gt; valueRange = rangeShardingValue.getValueRange();<br>        <span class="hljs-type">Date</span> <span class="hljs-variable">lowerDate</span> <span class="hljs-operator">=</span> valueRange.lowerEndpoint();<br>        <span class="hljs-type">Date</span> <span class="hljs-variable">upperDate</span> <span class="hljs-operator">=</span> valueRange.upperEndpoint();<br>        List&lt;DateTime&gt; dateTimes = rangeMonthToList(lowerDate, upperDate);<br>        <span class="hljs-keyword">for</span> (DateTime dateTime : dateTimes) &#123;<br>            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">stringBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>            stringBuilder.append(rangeShardingValue.getLogicTableName());<br>            stringBuilder.append(<span class="hljs-string">&quot;_&quot;</span>);<br>            stringBuilder.append(dateTime.getYear());<br>            stringBuilder.append(<span class="hljs-string">&quot;_&quot;</span>);<br>            stringBuilder.append(dateTime.getMonthOfYear());<br>            tableNameList.add(stringBuilder.toString());<br>        &#125;<br>        Iterator&lt;String&gt; iterator = tableNameList.iterator();<br>        <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> iterator.next();<br>            <span class="hljs-keyword">if</span> (!availableTargetNames.contains(tableName)) &#123;<br>                iterator.remove();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> tableNameList;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 给定月范围返回月份DateTime集合</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> lowerDate 最小时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> upperDate 最大时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;DateTime&gt; <span class="hljs-title function_">rangeMonthToList</span><span class="hljs-params">(Date lowerDate, Date upperDate)</span> &#123;<br>        <span class="hljs-type">DateTime</span> <span class="hljs-variable">lower</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(lowerDate);<br>        <span class="hljs-type">DateTime</span> <span class="hljs-variable">upper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(upperDate);<br>        List&lt;DateTime&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">if</span> (lower.getYear() &gt; upper.getYear()) &#123;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lower.getYear() == upper.getYear()) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">month</span> <span class="hljs-operator">=</span> lower.getMonthOfYear(); month &lt;= upper.getMonthOfYear(); month ++) &#123;<br>                <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(lower.getYear(), month, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>                result.add(dateTime);<br>            &#125;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lower.getYear() &lt; upper.getYear()) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">lowerYear</span> <span class="hljs-operator">=</span> lower.getYear();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">upperYear</span> <span class="hljs-operator">=</span> upper.getYear();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">lowerMonth</span> <span class="hljs-operator">=</span> lower.getMonthOfYear();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">upperMonth</span> <span class="hljs-operator">=</span> upper.getMonthOfYear();<br>            <span class="hljs-comment">// 最小时间的年到年底的月份</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">month</span> <span class="hljs-operator">=</span> lowerMonth; month &lt;= <span class="hljs-number">12</span>; month++) &#123;<br>                <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(lowerYear, month, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>                result.add(dateTime);<br>            &#125;<br>            <span class="hljs-comment">// 年差中的月份</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">year</span> <span class="hljs-operator">=</span> lowerYear + <span class="hljs-number">1</span>; year &lt; upperYear; year++) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">month</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; month &lt;= <span class="hljs-number">12</span>; month++) &#123;<br>                    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(year, month, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>                    result.add(dateTime);<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">// 最后一年的月份</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">month</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; month &lt;= upperMonth; month++) &#123;<br>                <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(upperYear, month, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>                result.add(dateTime);<br>            &#125;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getType</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;MONTH_TABLE_SHARDING_ALGORITHM&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>测试service</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 测试类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">APITestServiceImpl</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MerRegisterRecordMapper merRegisterRecordMapper;<br><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> MerRegisterRecord <span class="hljs-title function_">test1</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> test4(id);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> MerRegisterRecord <span class="hljs-title function_">test4</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-type">MerRegisterRecord</span> <span class="hljs-variable">merRegisterRecord</span> <span class="hljs-operator">=</span> merRegisterRecordMapper.selectMerRegisterRecordById(id);<br>        merRegisterRecord.setUpdateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        merRegisterRecordMapper.updateMerRegisterRecord(merRegisterRecord);<br>        merRegisterRecord = merRegisterRecordMapper.selectMerRegisterRecordById(id);<br>        <span class="hljs-keyword">return</span> merRegisterRecord;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>测试controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Api(tags = &quot;test&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/test&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">APITestController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MerRegisterRecordMapper merRegisterRecordMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderCardConsumeMapper orderCardConsumeMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> APITestServiceImpl apiTestService;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/test1&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;测试主库写后读走主库&quot;)</span><br>    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">test1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> AjaxResult.success(apiTestService.test1(<span class="hljs-number">931548600963096576L</span>));<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/test2&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;测试从库&quot;)</span><br>    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">MerRegisterRecord</span> <span class="hljs-variable">merRegisterRecord</span> <span class="hljs-operator">=</span> merRegisterRecordMapper.selectMerRegisterRecordById(<span class="hljs-number">931548600963096576L</span>);<br>        <span class="hljs-keyword">return</span> AjaxResult.success(merRegisterRecord);<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/test3&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;测试分表&quot;)</span><br>    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">test3</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">OrderCardConsume</span> <span class="hljs-variable">orderCardConsume</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCardConsume</span>();<br>        orderCardConsume.setTradeTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(<span class="hljs-number">2022</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>).toDate());<br>        PageHelper.startPage(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>        List&lt;OrderCardConsume&gt; list = orderCardConsumeMapper.selectOrderCardConsumeList(orderCardConsume);<br>        <span class="hljs-keyword">return</span> AjaxResult.success(list);<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/test4&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;测试主库只有修改走主库&quot;)</span><br>    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">test4</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> AjaxResult.success(apiTestService.test4(<span class="hljs-number">931548600963096576L</span>));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>调用</p>]]></content>
    
    
    <categories>
      
      <category>sharding-jdbc</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>动态创建月维度表及sharding-jdbc单库分表实现</title>
    <link href="/2022/02/09/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BA%E6%9C%88%E7%BB%B4%E5%BA%A6%E8%A1%A8%E5%8F%8Asharding-jdbc%E5%8D%95%E5%BA%93%E5%88%86%E8%A1%A8%E5%AE%9E%E7%8E%B0/"/>
    <url>/2022/02/09/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BA%E6%9C%88%E7%BB%B4%E5%BA%A6%E8%A1%A8%E5%8F%8Asharding-jdbc%E5%8D%95%E5%BA%93%E5%88%86%E8%A1%A8%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h3 id="单库分表"><a href="#单库分表" class="headerlink" title="单库分表"></a>单库分表</h3><p>一张表数据达到一定级别后，查询、插入、修改、DDL等效率降低，需要优化。这时可以使用单库分表，进行数据的拆分。</p><p>主要解决单表数据量过大的问题。</p><p>未解决：CPU、内存、带宽等单库的资源限制。</p><h3 id="sharding-jdbc固定actual-data-nodes问题，需要动态生成表，采用定时任务实现"><a href="#sharding-jdbc固定actual-data-nodes问题，需要动态生成表，采用定时任务实现" class="headerlink" title="sharding-jdbc固定actual-data-nodes问题，需要动态生成表，采用定时任务实现"></a>sharding-jdbc固定actual-data-nodes问题，需要动态生成表，采用定时任务实现</h3><p>创建配置文件：application-shardingjdbc.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 分表的表名用于定时创建表</span><br><span class="hljs-attr">sharding-jdbc:</span><br>  <span class="hljs-attr">tableNames:</span> <span class="hljs-string">order_card_consume</span><br></code></pre></td></tr></table></figure><p>application.yml引用</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">include:</span> <span class="hljs-string">shardingjdbc</span><br></code></pre></td></tr></table></figure><p>创建表mapper:CreateTableMapper.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Param;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 创建表映射</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CreateTableMapper</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取表是否存在</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> tableName</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> tableName</span><br><span class="hljs-comment">     */</span><br>    String <span class="hljs-title function_">getTableName</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;tableName&quot;)</span> String tableName)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据逻辑表名获取所有实际表名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> logicTableName</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 所有实际表名</span><br><span class="hljs-comment">     */</span><br>    List&lt;String&gt; <span class="hljs-title function_">getTableNameForLogicTableName</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;logicTableName&quot;)</span> String logicTableName)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据旧表创建新表，表结构一样</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> newTableName 新表名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> oldTableName 旧表名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">createTable</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;newTableName&quot;)</span> String newTableName,</span><br><span class="hljs-params">                    <span class="hljs-meta">@Param(&quot;oldTableName&quot;)</span> String oldTableName)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span></span><br><span class="hljs-meta">        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.trans.backbusi.mapper.CreateTableMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;getTableName&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span>&gt;</span><br>        SELECT `table_name` FROM information_schema.TABLES WHERE `table_name` = #&#123;tableName&#125;;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;getTableNameForLogicTableName&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span>&gt;</span><br>        SELECT<br>            `table_name`<br>        FROM<br>            information_schema.TABLES<br>        WHERE<br>            `table_name` REGEXP CONCAT(#&#123;logicTableName&#125;,&#x27;_[0-9]&#123;4&#125;_[0-9]&#123;1,2&#125;&#x27;)<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;createTable&quot;</span>&gt;</span><br>        CREATE TABLE $&#123;newTableName&#125; like $&#123;oldTableName&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure><p>定时任务：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.trans.backbusi.mapper.CreateTableMapper;<br><span class="hljs-keyword">import</span> com.trans.common.utils.StringUtils;<br><span class="hljs-keyword">import</span> com.trans.common.utils.uuid.UUID;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.api.hint.HintManager;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.core.rule.TableRule;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.shardingjdbc.jdbc.core.datasource.ShardingDataSource;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.underlying.common.rule.DataNode;<br><span class="hljs-keyword">import</span> org.joda.time.DateTime;<br><span class="hljs-keyword">import</span> org.slf4j.MDC;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> javax.annotation.PostConstruct;<br><span class="hljs-keyword">import</span> javax.sql.DataSource;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Modifier;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 定时任务</span><br><span class="hljs-comment"> * shardingJdbc定时创建表</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service(&quot;shardingJDBCCreateTableTask&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShardingJDBCCreateTableTask</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;sharding-jdbc.tableNames&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String[] tableNames;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CreateTableMapper createTableMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DataSource dataSource;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createTable</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(MDC.get(<span class="hljs-string">&quot;traceId&quot;</span>))) &#123;<br>            MDC.put(<span class="hljs-string">&quot;traceId&quot;</span>, UUID.getUUIDString());<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> DateTime.now();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">year</span> <span class="hljs-operator">=</span> dateTime.getYear();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">month</span> <span class="hljs-operator">=</span> dateTime.getMonthOfYear();<br>            <span class="hljs-keyword">if</span> (month == <span class="hljs-number">12</span>) &#123;<br>                year = year + <span class="hljs-number">1</span>;<br>                month = <span class="hljs-number">1</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                month = month + <span class="hljs-number">1</span>;<br>            &#125;<br>            <span class="hljs-keyword">for</span> (String tableName : tableNames) &#123;<br>                <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">newTableName</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>                newTableName.append(tableName);<br>                newTableName.append(<span class="hljs-string">&quot;_&quot;</span>);<br>                newTableName.append(year);<br>                newTableName.append(<span class="hljs-string">&quot;_&quot;</span>);<br>                newTableName.append(month);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">exsitTableName</span> <span class="hljs-operator">=</span> createTableMapper.getTableName(newTableName.toString());<br>                <span class="hljs-keyword">if</span> (StringUtils.isEmpty(exsitTableName)) &#123;<br>                    createTableMapper.createTable(newTableName.toString(), tableName);<br>                    actualTablesRefresh();<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            MDC.remove(<span class="hljs-string">&quot;traceId&quot;</span>);<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 初始化sharding-jdbc的真实表节点</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initActualTablesNode</span><span class="hljs-params">()</span> &#123;<br>        actualTablesRefresh();<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 刷新sharding-jdbc的真实表节点</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">actualTablesRefresh</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ShardingDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> (ShardingDataSource) <span class="hljs-built_in">this</span>.dataSource;<br>            <span class="hljs-keyword">if</span> (tableNames == <span class="hljs-literal">null</span> || tableNames.length == <span class="hljs-number">0</span>) &#123;<br>                log.info(<span class="hljs-string">&quot;分表为空&quot;</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-keyword">for</span> (String tableName : tableNames) &#123;<br>                <span class="hljs-type">TableRule</span> <span class="hljs-variable">tableRule</span> <span class="hljs-operator">=</span> dataSource.getRuntimeContext().getRule().getTableRule(tableName);<br>                List&lt;DataNode&gt; dataNodes = tableRule.getActualDataNodes();<br>                <span class="hljs-type">Field</span> <span class="hljs-variable">actualDataNodesField</span> <span class="hljs-operator">=</span> TableRule.class.getDeclaredField(<span class="hljs-string">&quot;actualDataNodes&quot;</span>);<br>                <span class="hljs-type">Field</span> <span class="hljs-variable">modifiersField</span> <span class="hljs-operator">=</span> Field.class.getDeclaredField(<span class="hljs-string">&quot;modifiers&quot;</span>);<br>                modifiersField.setAccessible(<span class="hljs-literal">true</span>);<br>                modifiersField.setInt(actualDataNodesField, actualDataNodesField.getModifiers() &amp; ~Modifier.FINAL);<br>                actualDataNodesField.setAccessible(<span class="hljs-literal">true</span>);<br>                List&lt;DataNode&gt; newDataNodes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>                <span class="hljs-comment">// 这里是单库，如果多库还要修改</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">dataSourceName</span> <span class="hljs-operator">=</span> dataNodes.get(<span class="hljs-number">0</span>).getDataSourceName();<br>                <span class="hljs-comment">// 强制走主库</span><br>                HintManager.getInstance().setMasterRouteOnly();<br>                List&lt;String&gt; tableNames = createTableMapper.getTableNameForLogicTableName(tableName);<br>                <span class="hljs-keyword">for</span> (String realTableName : tableNames) &#123;<br>                    <span class="hljs-type">DataNode</span> <span class="hljs-variable">dataNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataNode</span>(dataSourceName + <span class="hljs-string">&quot;.&quot;</span> + realTableName);<br>                    newDataNodes.add(dataNode);<br>                &#125;<br>                actualDataNodesField.set(tableRule, newDataNodes);<br>                <br>                                <span class="hljs-comment">// 可用</span><br>                <span class="hljs-type">Method</span> <span class="hljs-variable">cacheActualDatasourcesAndTablesMethod</span> <span class="hljs-operator">=</span> TableRule.class.getDeclaredMethod(<span class="hljs-string">&quot;cacheActualDatasourcesAndTables&quot;</span>, <span class="hljs-literal">null</span>);<br>                cacheActualDatasourcesAndTablesMethod.setAccessible(<span class="hljs-literal">true</span>);<br>                cacheActualDatasourcesAndTablesMethod.invoke(tableRule, <span class="hljs-literal">null</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;动态分表表名添加sharding-jdbc错误&quot;</span>, e);<br>        &#125;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>定时任务每月最后一天执行创建下一月的表</p><p>定时任务corn表达式：0 0 0 L * ?</p><h3 id="添加sharding-jdbc"><a href="#添加sharding-jdbc" class="headerlink" title="添加sharding-jdbc"></a>添加sharding-jdbc</h3><p>trans-core的pom.xml中druid修改</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml">    <span class="hljs-comment">&lt;!--&lt;dependency&gt;--&gt;</span><br>        <span class="hljs-comment">&lt;!--&lt;groupId&gt;com.alibaba&lt;/groupId&gt;--&gt;</span><br>        <span class="hljs-comment">&lt;!--&lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;--&gt;</span><br>        <span class="hljs-comment">&lt;!--&lt;version&gt;$&#123;druid.version&#125;&lt;/version&gt;--&gt;</span><br>    <span class="hljs-comment">&lt;!--&lt;/dependency&gt;--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>trans-framework中pom.xml修改：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>trans-system中pom.xml修改</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>注释掉DruidConfig.java、DataSourceAspect.java、DruidProperties.java</p><p>application-shardingjdbc.yml修改</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 分表的表名用于定时创建表</span><br><span class="hljs-attr">sharding-jdbc:</span><br>  <span class="hljs-attr">tableNames:</span> <span class="hljs-string">order_card_consume</span><br><br><span class="hljs-comment"># sharding-jdbc配置</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">shardingsphere:</span><br>    <span class="hljs-attr">props:</span><br>      <span class="hljs-attr">sql:</span><br>        <span class="hljs-attr">show:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">datasource:</span><br>      <span class="hljs-attr">names:</span> <span class="hljs-string">master01,slave01</span><br>      <span class="hljs-attr">master01:</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br>        <span class="hljs-attr">driverClassName:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>        <span class="hljs-attr">url:</span> <br>        <span class="hljs-attr">username:</span> <br>        <span class="hljs-attr">password:</span> <br>        <span class="hljs-comment"># 初始连接数</span><br>        <span class="hljs-attr">initialSize:</span> <span class="hljs-number">5</span><br>        <span class="hljs-comment"># 最小连接池数量</span><br>        <span class="hljs-attr">minIdle:</span> <span class="hljs-number">10</span><br>        <span class="hljs-comment"># 最大连接池数量</span><br>        <span class="hljs-attr">maxActive:</span> <span class="hljs-number">20</span><br>        <span class="hljs-comment"># 配置获取连接等待超时的时间</span><br>        <span class="hljs-attr">maxWait:</span> <span class="hljs-number">60000</span><br>        <span class="hljs-comment"># 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒</span><br>        <span class="hljs-attr">timeBetweenEvictionRunsMillis:</span> <span class="hljs-number">60000</span><br>        <span class="hljs-comment"># 配置一个连接在池中最小生存的时间，单位是毫秒</span><br>        <span class="hljs-attr">minEvictableIdleTimeMillis:</span> <span class="hljs-number">300000</span><br>        <span class="hljs-comment"># 配置一个连接在池中最大生存的时间，单位是毫秒</span><br>        <span class="hljs-attr">maxEvictableIdleTimeMillis:</span> <span class="hljs-number">900000</span><br>        <span class="hljs-comment"># 配置检测连接是否有效</span><br>        <span class="hljs-attr">validationQuery:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-string">FROM</span> <span class="hljs-string">DUAL</span><br>        <span class="hljs-attr">testWhileIdle:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">testOnBorrow:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">testOnReturn:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">poolPreparedStatements:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">maxPoolPreparedStatementPerConnectionSize:</span> <span class="hljs-number">20</span><br>        <span class="hljs-attr">filters:</span> <span class="hljs-string">stat,wall,log4j2</span><br>        <span class="hljs-attr">connectionProperties:</span> <span class="hljs-string">druid.stat.mergeSql\=true;druid.stat.slowSqlMillis\=5000</span><br>      <span class="hljs-attr">slave01:</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br>        <span class="hljs-attr">driverClassName:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>        <span class="hljs-attr">url:</span> <br>        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>        <span class="hljs-attr">password:</span> <br>        <span class="hljs-comment"># 初始连接数</span><br>        <span class="hljs-attr">initialSize:</span> <span class="hljs-number">5</span><br>        <span class="hljs-comment"># 最小连接池数量</span><br>        <span class="hljs-attr">minIdle:</span> <span class="hljs-number">10</span><br>        <span class="hljs-comment"># 最大连接池数量</span><br>        <span class="hljs-attr">maxActive:</span> <span class="hljs-number">20</span><br>        <span class="hljs-comment"># 配置获取连接等待超时的时间</span><br>        <span class="hljs-attr">maxWait:</span> <span class="hljs-number">60000</span><br>        <span class="hljs-comment"># 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒</span><br>        <span class="hljs-attr">timeBetweenEvictionRunsMillis:</span> <span class="hljs-number">60000</span><br>        <span class="hljs-comment"># 配置一个连接在池中最小生存的时间，单位是毫秒</span><br>        <span class="hljs-attr">minEvictableIdleTimeMillis:</span> <span class="hljs-number">300000</span><br>        <span class="hljs-comment"># 配置一个连接在池中最大生存的时间，单位是毫秒</span><br>        <span class="hljs-attr">maxEvictableIdleTimeMillis:</span> <span class="hljs-number">900000</span><br>        <span class="hljs-comment"># 配置检测连接是否有效</span><br>        <span class="hljs-attr">validationQuery:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-string">FROM</span> <span class="hljs-string">DUAL</span><br>        <span class="hljs-attr">testWhileIdle:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">testOnBorrow:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">testOnReturn:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">poolPreparedStatements:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">maxPoolPreparedStatementPerConnectionSize:</span> <span class="hljs-number">20</span><br>        <span class="hljs-attr">filters:</span> <span class="hljs-string">stat,wall,log4j2</span><br>        <span class="hljs-attr">connectionProperties:</span> <span class="hljs-string">druid.stat.mergeSql\=true;druid.stat.slowSqlMillis\=5000</span><br>    <span class="hljs-comment"># 默认数据源</span><br>    <span class="hljs-attr">sharding:</span><br>      <span class="hljs-attr">default-data-source-name:</span> <span class="hljs-string">master</span><br>      <span class="hljs-comment"># 读写分离配置</span><br>      <span class="hljs-attr">master-slave-rules:</span><br>        <span class="hljs-attr">ms0:</span><br>          <span class="hljs-attr">load-balance-algorithm-type:</span> <span class="hljs-string">round_robin</span><br>          <span class="hljs-attr">master-data-source-name:</span> <span class="hljs-string">master01</span><br>          <span class="hljs-attr">slave-data-source-names:</span> <span class="hljs-string">slave01</span><br>      <span class="hljs-comment"># 分表配置</span><br>      <span class="hljs-attr">tables:</span><br>        <span class="hljs-attr">order_card_consume:</span><br>          <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">ms0.order_card_consume</span><br>          <span class="hljs-attr">table-strategy:</span><br>            <span class="hljs-attr">standard:</span><br>              <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">trade_time</span><br>              <span class="hljs-attr">precise-algorithm-class-name:</span> <span class="hljs-string">com.trans.framework.shardingjdbc.MonthTableShardingAlgorithm</span><br>              <span class="hljs-attr">range-algorithm-class-name:</span> <span class="hljs-string">com.trans.framework.shardingjdbc.MonthTableShardingAlgorithm</span><br><br></code></pre></td></tr></table></figure><p>添加分表算法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.google.common.collect.Range;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.api.sharding.standard.PreciseShardingAlgorithm;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.api.sharding.standard.PreciseShardingValue;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.api.sharding.standard.RangeShardingAlgorithm;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.api.sharding.standard.RangeShardingValue;<br><span class="hljs-keyword">import</span> org.joda.time.DateTime;<br><br><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 按时间的月份分表算法</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonthTableShardingAlgorithm</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PreciseShardingAlgorithm</span>&lt;Date&gt;, RangeShardingAlgorithm&lt;Date&gt; &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * = in 的获取表名</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">doSharding</span><span class="hljs-params">(Collection&lt;String&gt; collection, PreciseShardingValue&lt;Date&gt; preciseShardingValue)</span> &#123;<br>        <span class="hljs-type">Date</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> preciseShardingValue.getValue();<br>        <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(date);<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">stringBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        stringBuilder.append(preciseShardingValue.getLogicTableName());<br>        stringBuilder.append(<span class="hljs-string">&quot;_&quot;</span>);<br>        stringBuilder.append(dateTime.getYear());<br>        stringBuilder.append(<span class="hljs-string">&quot;_&quot;</span>);<br>        stringBuilder.append(dateTime.getMonthOfYear());<br>        <span class="hljs-keyword">return</span> stringBuilder.toString();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * BETWEEN AND的获取表名</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Collection&lt;String&gt; <span class="hljs-title function_">doSharding</span><span class="hljs-params">(Collection&lt;String&gt; availableTargetNames, RangeShardingValue&lt;Date&gt; rangeShardingValue)</span> &#123;<br>        List&lt;String&gt; tableNameList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        Range&lt;Date&gt; valueRange = rangeShardingValue.getValueRange();<br>        <span class="hljs-type">Date</span> <span class="hljs-variable">lowerDate</span> <span class="hljs-operator">=</span> valueRange.lowerEndpoint();<br>        <span class="hljs-type">Date</span> <span class="hljs-variable">upperDate</span> <span class="hljs-operator">=</span> valueRange.upperEndpoint();<br>        List&lt;DateTime&gt; dateTimes = rangeMonthToList(lowerDate, upperDate);<br>        <span class="hljs-keyword">for</span> (DateTime dateTime : dateTimes) &#123;<br>            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">stringBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>            stringBuilder.append(rangeShardingValue.getLogicTableName());<br>            stringBuilder.append(<span class="hljs-string">&quot;_&quot;</span>);<br>            stringBuilder.append(dateTime.getYear());<br>            stringBuilder.append(<span class="hljs-string">&quot;_&quot;</span>);<br>            stringBuilder.append(dateTime.getMonthOfYear());<br>            tableNameList.add(stringBuilder.toString());<br>        &#125;<br>        Iterator&lt;String&gt; iterator = tableNameList.iterator();<br>        <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> iterator.next();<br>            <span class="hljs-keyword">if</span> (!availableTargetNames.contains(tableName)) &#123;<br>                iterator.remove();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> tableNameList;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 给定月范围返回月份DateTime集合</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> lowerDate 最小时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> upperDate 最大时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;DateTime&gt; <span class="hljs-title function_">rangeMonthToList</span><span class="hljs-params">(Date lowerDate, Date upperDate)</span> &#123;<br>        <span class="hljs-type">DateTime</span> <span class="hljs-variable">lower</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(lowerDate);<br>        <span class="hljs-type">DateTime</span> <span class="hljs-variable">upper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(upperDate);<br>        List&lt;DateTime&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">if</span> (lower.getYear() &gt; upper.getYear()) &#123;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lower.getYear() == upper.getYear()) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">month</span> <span class="hljs-operator">=</span> lower.getMonthOfYear(); month &lt;= upper.getMonthOfYear(); month ++) &#123;<br>                <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(lower.getYear(), month, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>                result.add(dateTime);<br>            &#125;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lower.getYear() &lt; upper.getYear()) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">lowerYear</span> <span class="hljs-operator">=</span> lower.getYear();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">upperYear</span> <span class="hljs-operator">=</span> upper.getYear();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">lowerMonth</span> <span class="hljs-operator">=</span> lower.getMonthOfYear();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">upperMonth</span> <span class="hljs-operator">=</span> upper.getMonthOfYear();<br>            <span class="hljs-comment">// 最小时间的年到年底的月份</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">month</span> <span class="hljs-operator">=</span> lowerMonth; month &lt;= <span class="hljs-number">12</span>; month++) &#123;<br>                <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(lowerYear, month, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>                result.add(dateTime);<br>            &#125;<br>            <span class="hljs-comment">// 年差中的月份</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">year</span> <span class="hljs-operator">=</span> lowerYear + <span class="hljs-number">1</span>; year &lt; upperYear; year++) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">month</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; month &lt;= <span class="hljs-number">12</span>; month++) &#123;<br>                    <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(year, month, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>                    result.add(dateTime);<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">// 最后一年的月份</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">month</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; month &lt;= upperMonth; month++) &#123;<br>                <span class="hljs-type">DateTime</span> <span class="hljs-variable">dateTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(upperYear, month, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>                result.add(dateTime);<br>            &#125;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>测试service</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 测试类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">APITestServiceImpl</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MerRegisterRecordMapper merRegisterRecordMapper;<br><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> MerRegisterRecord <span class="hljs-title function_">test1</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> test4(id);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> MerRegisterRecord <span class="hljs-title function_">test4</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-type">MerRegisterRecord</span> <span class="hljs-variable">merRegisterRecord</span> <span class="hljs-operator">=</span> merRegisterRecordMapper.selectMerRegisterRecordById(id);<br>        merRegisterRecord.setUpdateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        merRegisterRecordMapper.updateMerRegisterRecord(merRegisterRecord);<br>        merRegisterRecord = merRegisterRecordMapper.selectMerRegisterRecordById(id);<br>        <span class="hljs-keyword">return</span> merRegisterRecord;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>测试controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Api(tags = &quot;test&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/test&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">APITestController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MerRegisterRecordMapper merRegisterRecordMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderCardConsumeMapper orderCardConsumeMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> APITestServiceImpl apiTestService;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/test1&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;测试主库写后读走主库&quot;)</span><br>    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">test1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> AjaxResult.success(apiTestService.test1(<span class="hljs-number">931548600963096576L</span>));<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/test2&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;测试从库&quot;)</span><br>    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">MerRegisterRecord</span> <span class="hljs-variable">merRegisterRecord</span> <span class="hljs-operator">=</span> merRegisterRecordMapper.selectMerRegisterRecordById(<span class="hljs-number">931548600963096576L</span>);<br>        <span class="hljs-keyword">return</span> AjaxResult.success(merRegisterRecord);<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/test3&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;测试分表&quot;)</span><br>    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">test3</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">OrderCardConsume</span> <span class="hljs-variable">orderCardConsume</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCardConsume</span>();<br>        orderCardConsume.setTradeTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(<span class="hljs-number">2022</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>).toDate());<br>        PageHelper.startPage(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>        List&lt;OrderCardConsume&gt; list = orderCardConsumeMapper.selectOrderCardConsumeList(orderCardConsume);<br>        <span class="hljs-keyword">return</span> AjaxResult.success(list);<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/test4&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;测试主库只有修改走主库&quot;)</span><br>    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">test4</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> AjaxResult.success(apiTestService.test4(<span class="hljs-number">931548600963096576L</span>));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>调用</p>]]></content>
    
    
    <categories>
      
      <category>sharding-jdbc</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>log的mdc生成traceId</title>
    <link href="/2022/02/08/java/log%E7%9A%84mdc%E7%94%9F%E6%88%90traceId/"/>
    <url>/2022/02/08/java/log%E7%9A%84mdc%E7%94%9F%E6%88%90traceId/</url>
    
    <content type="html"><![CDATA[<h3 id="spring-添加拦截器"><a href="#spring-添加拦截器" class="headerlink" title="spring 添加拦截器"></a>spring 添加拦截器</h3><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * MDC</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 为每个请求添加traceId</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MDCFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OncePerRequestFilter</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TRACEID</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;traceId&quot;</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            MDC.put(TRACEID, UUID.getUUIDString());<br>            filterChain.doFilter(request, response);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            MDC.remove(TRACEID);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>把filter生效</p><p>以前是使用的拦截器，但是方法如果报错后，清除mdc不执行，因为postHandler方法在方法异常时不执行。</p><h3 id="日志格式中添加traceId"><a href="#日志格式中添加traceId" class="headerlink" title="日志格式中添加traceId"></a>日志格式中添加traceId</h3><p>logback.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;log.pattern&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;%d&#123;HH:mm:ss.SSS&#125; -[%X&#123;traceId&#125;]- [%thread] %-5level %logger&#123;20&#125; - [%method,%line] - %msg%n&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><h3 id="统一返回格式中添加traceId"><a href="#统一返回格式中添加traceId" class="headerlink" title="统一返回格式中添加traceId"></a>统一返回格式中添加traceId</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TRACE_ID</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;traceId&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-title function_">AjaxResult</span><span class="hljs-params">(<span class="hljs-type">int</span> code, String msg)</span><br>&#123;<br>    <span class="hljs-built_in">super</span>.put(TRACE_ID, MDC.get(TRACE_ID));<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="子线程传递工具类"><a href="#子线程传递工具类" class="headerlink" title="子线程传递工具类"></a>子线程传递工具类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.slf4j.MDC;<br><span class="hljs-keyword">import</span> org.springframework.util.CollectionUtils;<br><br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 用于mdc传递至子线程</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MDCUtil</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Runnable <span class="hljs-title function_">wrap</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Runnable runnable, <span class="hljs-keyword">final</span> Map&lt;String, String&gt; context)</span> &#123;<br>        <span class="hljs-keyword">return</span> () -&gt; &#123;<br>            <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(context)) &#123;<br>                MDC.clear();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                MDC.setContextMap(context);<br>            &#125;<br>            <span class="hljs-keyword">try</span> &#123;<br>                runnable.run();<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                MDC.clear();<br>            &#125;<br>        &#125;;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>子线程调用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>        <span class="hljs-keyword">private</span> Integer i;<br><br>        <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getI</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> i;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setI</span><span class="hljs-params">(Integer i)</span> &#123;<br>            <span class="hljs-built_in">this</span>.i = i;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            log.info(<span class="hljs-string">&quot;------------------------&quot;</span> + i);<br>            log.info(<span class="hljs-string">&quot;asdfafafafdasfsafdaf&quot;</span>);<br>        &#125;<br>&#125;<br><br><span class="hljs-type">Test</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>();<br>test.setI(<span class="hljs-number">22</span>);<br><span class="hljs-type">Runnable</span> <span class="hljs-variable">runnable</span> <span class="hljs-operator">=</span> MDCUtil.wrap(test, MDC.getCopyOfContextMap());<br><span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(runnable);<br>thread.start();<br></code></pre></td></tr></table></figure><p>线程池同上。</p><h3 id="其他非http请求时使用traceId"><a href="#其他非http请求时使用traceId" class="headerlink" title="其他非http请求时使用traceId"></a>其他非http请求时使用traceId</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (StringUtils.isEmpty(MDC.get(<span class="hljs-string">&quot;traceId&quot;</span>))) &#123;<br>    MDC.put(<span class="hljs-string">&quot;traceId&quot;</span>, UUID.getUUIDString());<br>&#125;<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// 业务操作</span><br>&#125; <span class="hljs-keyword">finally</span> &#123;<br>MDC.remove(<span class="hljs-string">&quot;traceId&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>mdc</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mdc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql主备延迟</title>
    <link href="/2022/02/07/mysql/mysql%E4%B8%BB%E5%A4%87%E5%BB%B6%E8%BF%9F/"/>
    <url>/2022/02/07/mysql/mysql%E4%B8%BB%E5%A4%87%E5%BB%B6%E8%BF%9F/</url>
    
    <content type="html"><![CDATA[<h3 id="什么是主备延迟"><a href="#什么是主备延迟" class="headerlink" title="什么是主备延迟"></a>什么是主备延迟</h3><p>1.主库 A 执行完成一个事务，写入 binlog，我们把这个时刻记为 T1;</p><p>2.之后传给备库 B，我们把备库 B 接收完这个 binlog 的时刻记为 T2;</p><p>3.备库 B 执行完成这个事务，我们把这个时刻记为 T3</p><p>所谓主备延迟，就是同一个事务，在备库执行完成的时间和主库执行完成的时间之间的差值，也就是 T3-T1。</p><h3 id="什么情况会导致主备延迟"><a href="#什么情况会导致主备延迟" class="headerlink" title="什么情况会导致主备延迟"></a>什么情况会导致主备延迟</h3><p>情况一：备库所在机器的性能要比主库所在的机器性能差。</p><p>情况二：备库的压力大。</p><p>​由于主库直接影响业务，大家使用起来会比较克制，反而忽视了备库的压力控制。结果就是，备库上的查询耗费了大量的 CPU 资源，影响了同步速度，造成主备延迟。</p><p>​    备库压力大解决方案：</p><p>​     1.一主多从。除了备库外，可以多接几个从库，让这些从库来分担读的压力。</p><p>​     2.通过 binlog 输出到外部系统，比如 Hadoop 这类系统，让外部系统提供统计类查询的能力。</p><p>情况三：大事务。</p><p>​1.delete多行等操作。</p><p>​2.大表的DDL操作</p><h3 id="注意主备延迟后，还是会有读到过期数据的情况，解决方案。"><a href="#注意主备延迟后，还是会有读到过期数据的情况，解决方案。" class="headerlink" title="注意主备延迟后，还是会有读到过期数据的情况，解决方案。"></a>注意主备延迟后，还是会有读到过期数据的情况，解决方案。</h3><p>强制走主库方案：</p><p> 将查询请求做分类，必须拿到最新数据的走主库，可以读到旧数据的走从库。</p><p>好像sharding-jdbc如果一个事务里先写后读，会从主库读取，不带写操作的事务会走从库。</p><p>sleep 方案：</p><p>​select sleep(1) </p><p>​如果这个查询请求本来 0.5 秒就可以在从库上拿到正确结果，也会等 1 秒；</p><p>​     如果延迟超过 1 秒，还是会出现过期读。</p><p>判断主备无延迟方案：</p><p>​方案1：show slave status 结果里的 seconds_behind_master </p><p>​     方案2：对比位点确保主备无延迟：</p><p>​Master_Log_File 和 Read_Master_Log_Pos，表示的是读到的主库的最新位点；                          Relay_Master_Log_File 和 Exec_Master_Log_Pos，表示的是备库执行的最新位点。</p><p>​     方案3：对比 GTID 集合确保主备无延迟：Auto_Position&#x3D;1 ，表示这对主备关系使用了 GTID 协议。Retrieved_Gtid_Set，是备库收到的所有日志的 GTID 集合；Executed_Gtid_Set，是备库所有已经执行完成的 GTID 集合。</p><p>配合 semi-sync 方案：（一主一备）</p><p>​    事务提交的时候，主库把 binlog 发给从库；</p><p>​     从库收到 binlog 以后，发回给主库一个 ack，表示收到了；</p><p>​     主库收到这个 ack 以后，才能给客户端返回“事务完成”的确认。</p><p>​    当一主多从时：</p><p>​     如果查询是落在这个响应了 ack 的从库上，是能够确保读到最新数据；</p><p>​     但如果是查询落到其他从库上，它们可能还没有收到最新的日志，就会产生过期读的问题。</p><p>等主库位点方案：</p><p>​select master_pos_wait(file, pos[, timeout]);</p><p>​     trx1 事务更新完成后，马上执行 show master status 得到当前主库执行到的 File 和 Position；</p><p>​     选定一个从库执行查询语句；</p><p>​     在从库上执行 select master_pos_wait(File, Position, 1)；</p><p>​     如果返回值是 &gt;&#x3D;0 的正整数，则在这个从库执行查询语句；</p><p>​     否则，到主库执行查询语句。</p><p>等 GTID 方案：</p><p>​    select wait_for_executed_gtid_set(gtid_set, 1);</p><p>​     trx1 事务更新完成后，从返回包直接获取这个事务的 GTID，记为 gtid1；</p><p>​     选定一个从库执行查询语句；</p><p>​     在从库上执行 select wait_for_executed_gtid_set(gtid1, 1)；</p><p>​     如果返回值是 0，则在这个从库执行查询语句；</p><p>​     否则，到主库执行查询语句</p><h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>sharding-jdbc可以使用强制走主库方案。其他方案需要看是否可以自定义实现。</p><p>mycat可以使用判断主备无延迟方案。其他方案需要看是否可以自定义实现。</p>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mycat与sharding-sphere对比</title>
    <link href="/2022/02/07/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/mycat%E4%B8%8Esharding-sphere%E5%AF%B9%E6%AF%94/"/>
    <url>/2022/02/07/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/mycat%E4%B8%8Esharding-sphere%E5%AF%B9%E6%AF%94/</url>
    
    <content type="html"><![CDATA[<p> 参考文档：</p><p><a href="https://dbaplus.cn/news-11-1854-1.html">https://dbaplus.cn/news-11-1854-1.html</a></p><h3 id="1-方案对比"><a href="#1-方案对比" class="headerlink" title="1.方案对比"></a>1.方案对比</h3><p>mycat是db 代理的分库分表解决方案。</p><p>sharding-sphere中sharding-jdbc是对jdbc 代理的分库分表解决方案。</p><p>从解决方案&#x2F;架构来看sharding-jdbc更符合分布式架构的设计，直连数据库，没有中间应用，理论性能是最高的（实际性能需要结合具体的代码实现，理论性能可以理解为上限，通过不断优化代码实现，逐渐接近理论性能）。同时缺点也很明显，由于作为组件存在，需要集成在应用内，意味着作为使用方，必须要集成到代码里，使得开发成本相对较高。</p><p>另一方面，由于需要集成在应用内，使得需要针对不同语言（java、C、PHP……）有不同的实现（事实上sharding-jdbc目前只支持java），这样组件本身的维护成本也会很高。最终将应用场景限定在由java开发的应用这一种场景下。</p><p>DBproxy 高度依赖网络组件，它需要诸如 LVS&#x2F;F5 等 VIP 来实现流量的负载均衡，如果跨 IDC，还依赖诸如 DNS 进行IDC 分发。同时部分 DBproxy 对 Prepare 这类操作支持不友好，所以它的问题概括来说：</p><ul><li>链路过长，每层都会增加响应时间</li><li>网络单点，并且往往是整个公司层面的单点</li><li>部分产品对Prepare 应用不友好，需要绑定 connection 信息</li></ul><p>JDBC Proxy 最大的问题是违背了 DB 透明的原则，它需要对不同的语言编写 Driver，概括来说：</p><ul><li>语言限制，总会遭到一批 RD 同学的吐槽 “世界上最好的语言竟然不支持！”</li><li>接入繁琐</li><li>DB 不透明</li></ul><h3 id="2-项目归属及活跃度"><a href="#2-项目归属及活跃度" class="headerlink" title="2.项目归属及活跃度"></a>2.项目归属及活跃度</h3><p>sharding-sphere是apache的顶级项目。</p><p>mycat未找到拖管方。mycat源码在github上。<a href="https://github.com/MyCATApache">https://github.com/MyCATApache</a>，网上风评对mycat不友好。github上mycat的issue中bug还有71个open。</p><h3 id="3-网上对比"><a href="#3-网上对比" class="headerlink" title="3.网上对比"></a>3.网上对比</h3><p>sharding-jdbc:</p><p>优点：</p><p>1.可适用于任何基于java的ORM框架,如:JPA、Hibernate、Mybatis、Spring JDBC Template,或直接使用JDBC</p><p>2.可基于任何第三方的数据库连接池,如:DBCP、C3P0、Durid等</p><p>3.分片策略灵活,可支持等号、between、in等多维度分片,也可支持多分片键。</p><p>4.SQL解析功能完善,支持聚合、分组、排序、limit、or等查询,并支持Binding Table以及笛卡尔积表查询。</p><p>5.性能高,单库查询QPS为原生JDBC的99.8%,双库查询QPS比单库增加94%。</p><p>缺点：</p><p>1.理论上可支持任意实现JDBC规范的数据库。目前仅支持mysql</p><p>2.维护会比较麻烦，需要逐个项目的修改配置。不能进行跨库连接，代码需要进行改造。</p><p>3.在扩展数据库服务器时需要考虑一致性哈希问题，或者采用分片键局部取模方式，也难免要进行部分的数据迁移。</p><p>mycat:</p><p>优点：</p><p>1.支持Mysql集群，可以作为Proxy使用</p><p>2.支持JDBC连接ORACLE、DB2、SQL Server，将其模拟为MySQL Server使用</p><p>3.自动故障切换，高可用性</p><p>4.支持读写分离，支持Mysql双主多从，以及一主多从的模式 ，支持全局表，数据自动分片到多个节点，用于高效表关联查询</p><p>5.支持独有的基于E-R 关系的分片策略，实现了高效的表关联查询</p><p>6.多平台支持，部署和实施简单(主备切换、库迁移等友好)</p><p>缺点：</p><p>1.mycat不支持二维路由，仅支持单库多表或多库单表 由于自定义连接池，这样就会存在mycat自身维护一个连接池，MySQL也有一个连接池，任何一个连接池上限都会成为性能的瓶。</p><h3 id="4-网上选择"><a href="#4-网上选择" class="headerlink" title="4.网上选择"></a>4.网上选择</h3><p>网友A:</p><p>如果项目比较简单，需要使用的分片策略和算法不复杂，那么可以用Sharding-JDBC；如果项目比较复杂，分片规则比较复杂，而且具有一定的运维能力，那么选择Mycat。</p><p>网友B:</p><p>本着符合业务场景，可靠度高，接入成本低，具有良好的文档，活跃的社区的原则，打算采用shardingJdbc，涉及到分表策略选择使用城市的维度。</p>]]></content>
    
    
    <categories>
      
      <category>分库分表</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分库分表</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>elk安装</title>
    <link href="/2022/01/21/elk/elk%E5%AE%89%E8%A3%85/"/>
    <url>/2022/01/21/elk/elk%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h3 id="1-创建linux用户与组"><a href="#1-创建linux用户与组" class="headerlink" title="1.创建linux用户与组"></a>1.创建linux用户与组</h3><figure class="highlight shell"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><pre><code class="hljs shell">添加工作组<br>groupadd elastic<br>创建elastic用户<br>useradd -g elastic elastic<br>设置密码<br>passwd elastic<br>修改目录权限<br>chown -R elastic:elastic /usr/local/elk<br>切换用户<br>su elastic<br></code></pre></td></tr></table></figure><h3 id="2-安装elasticsearch-7-6"><a href="#2-安装elasticsearch-7-6" class="headerlink" title="2. 安装elasticsearch 7.6"></a>2. 安装elasticsearch 7.6</h3><p>下载解压：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /usr/local/elk<br>wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.6.0-linux-x86_64.tar.gz<br>tar xvf elasticsearch-7.6.0-linux-x86_64.tar.gz<br></code></pre></td></tr></table></figure><p>修改配置文件</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">vim <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/elk/</span>elasticsearch-<span class="hljs-number">7.6</span>.<span class="hljs-number">0</span><span class="hljs-regexp">/bin/</span>elasticsearch-env<br><span class="hljs-comment"># 把java查找改为elasiticSearch自带的jdk</span><br><span class="hljs-comment">#now set the path to java</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;$(uname -s)&quot;</span> = <span class="hljs-string">&quot;Darwin&quot;</span> ]; then<br>  <span class="hljs-comment"># macOS has a different structure</span><br>  JAVA=<span class="hljs-string">&quot;$ES_HOME/jdk.app/Contents/Home/bin/java&quot;</span><br><span class="hljs-keyword">else</span><br>  JAVA=<span class="hljs-string">&quot;$ES_HOME/jdk/bin/java&quot;</span><br>fi<br>JAVA_TYPE=<span class="hljs-string">&quot;bundled jdk&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /usr/local/elk/elasticsearch-7.6.0/config<br>vim jvm.options<br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改内存</span><br>-Xms512m<br>-Xmx512m<br></code></pre></td></tr></table></figure><p>启动：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /usr/local/elk/elasticsearch-7.6.0/bin<br>./elasticsearch -d<br></code></pre></td></tr></table></figure><p>测试安装完成：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl 127.0.0.1:9200<br></code></pre></td></tr></table></figure><h3 id="3-安装kibana-7-6"><a href="#3-安装kibana-7-6" class="headerlink" title="3.安装kibana 7.6"></a>3.安装kibana 7.6</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /usr/local/elk<br>wget https://artifacts.elastic.co/downloads/kibana/kibana-7.6.0-linux-x86_64.tar.gz<br>tar xvf kibana-7.6.0-linux-x86_64.tar.gz<br></code></pre></td></tr></table></figure><p>修改配置，能外网访问，配合为中文</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /usr/local/elk/kibana-7.6.0-linux-x86_64/config<br>vim kibana.yml<br>修改1. 改为外网可访问形式（不建议，最好限制ip）<br>server.host: &quot;0.0.0.0&quot;<br>修改2. 最后一行增加<br> i18n.locale: &quot;zh-CN&quot;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">启动</span><br>cd /usr/local/elk/kibana-7.6.0-linux-x86_64/bin<br>nohup ./kibana &amp;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">查找进程号</span><br>fuser -n tcp 5601<br></code></pre></td></tr></table></figure><h3 id="4-安装logstash"><a href="#4-安装logstash" class="headerlink" title="4.安装logstash"></a>4.安装logstash</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /usr/local/elk<br>wget https://artifacts.elastic.co/downloads/logstash/logstash-7.6.0.tar.gz<br>tar xvf logstash-7.6.0.tar.gz<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /usr/local/elk/logstash-7.6.0/config<br>vim jvm.options<br>修改：<br>-Xms256m  <br>-Xmx256m<br></code></pre></td></tr></table></figure><p>启动并验证</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /usr/local/elk/logstash-7.6.0<br>bin/logstash -e &#x27;input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;&#x27;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">在logstash启动后的命令行输入：</span><br>Hello Logstash<br><span class="hljs-meta prompt_"># </span><span class="language-bash">看到成功响应即为成功</span><br></code></pre></td></tr></table></figure><p>安装插件：logstash-codec-json_lines</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /usr/local/elk/logstash-7.6.0/bin<br>./logstash-plugin install logstash-codec-json_lines<br></code></pre></td></tr></table></figure><h3 id="5-整合"><a href="#5-整合" class="headerlink" title="5.整合"></a>5.整合</h3><p>logstash 相关配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell">cp logstash-sample.conf logstash.conf<br>vim logstash.conf<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 输入</span></span><br>input &#123;<br>    tcp &#123;<br>        host =&gt; &quot;127.0.0.1&quot;<br>        port =&gt; 9250 <br>        mode =&gt; &quot;server&quot;<br>        tags =&gt; [&quot;tags&quot;] <br>        codec =&gt; json_lines<br>    &#125;<br>&#125;<br>output&#123;<br>  elasticsearch &#123; <br>     hosts =&gt; [&quot;localhost:9200&quot;] <br>     index =&gt; &quot;%&#123;[appName]&#125;-%&#123;+YYYY.MM.dd&#125;&quot; #用一个项目名称来做索引<br>  &#125;<br>  stdout &#123; codec =&gt; rubydebug &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>127.0.0.1如果服务器不在一台机器上时，可填写内网地址或公网地址</p><p>5044是logstash接收数据的端口</p><p>codec &#x3D;&gt; json_lines是一个json解析器，接收json的数据。这个要装 <code>logstash-codec-json_lines</code> 插件</p><p>ouput elasticsearch指向我们安装的地址</p><p>stdout会打印收到的消息，调试用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">logstash 后台启动</span><br>cd /usr/local/elk/logstash-7.6.0/bin<br>nohup ./logstash -f ../config/logstash.conf &amp;<br></code></pre></td></tr></table></figure><p>测试logstash 至 elasticsearch</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl http://localhost:9600/<br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看/usr/local/elk/elasticsearch-7.6.0/log/selasticsearch.log</span><br>adding template [logstash] for index patterns [logstash-*]<br></code></pre></td></tr></table></figure><p>spring boot 项目：</p><p>pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>net.logstash.logback<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>logstash-logback-encoder<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>logback.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- logstash --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;stash&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;net.logstash.logback.appender.LogstashTcpSocketAppender&quot;</span>&gt;</span><br>     <span class="hljs-comment">&lt;!-- 如果logstash和应用程序不在一台机器时，填写内网地址或公网地址 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">destination</span>&gt;</span>localhost:9250<span class="hljs-tag">&lt;/<span class="hljs-name">destination</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- encoder必须配置,有多种可选 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;net.logstash.logback.encoder.LogstashEncoder&quot;</span> &gt;</span><br>        <span class="hljs-comment">&lt;!-- &quot;appname&quot;:&quot;trans-core&quot; 的作用是指定创建索引的名字时用，并且在生成的文档中会多了这个字段  --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">customFields</span>&gt;</span>&#123;&quot;appname&quot;:&quot;trans-core&quot;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">customFields</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;info&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;stash&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>elk</category>
      
    </categories>
    
    
    <tags>
      
      <tag>elk</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>javascript初学</title>
    <link href="/2022/01/04/%E5%89%8D%E7%AB%AF/javascript%E5%88%9D%E5%AD%A6/"/>
    <url>/2022/01/04/%E5%89%8D%E7%AB%AF/javascript%E5%88%9D%E5%AD%A6/</url>
    
    <content type="html"><![CDATA[<h3 id="1-目标"><a href="#1-目标" class="headerlink" title="1.目标"></a>1.目标</h3><p>掌握javascript的标准ECMAScript（ES）</p><p>掌握javascript页面交互</p><p>掌握javascript操作DOM（文档对象模型）</p><p>掌握javascript操作BOM（浏览器对象模型）</p><p>掌握javascript常见面试题</p><p>掌握前端与后端的数据交互</p>]]></content>
    
    
    <categories>
      
      <category>javascript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>javascript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jenkins安装</title>
    <link href="/2021/12/17/jenkins/jenkins%E5%AE%89%E8%A3%85/"/>
    <url>/2021/12/17/jenkins/jenkins%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h3 id="1-下载地址"><a href="#1-下载地址" class="headerlink" title="1.下载地址"></a>1.下载地址</h3><p><a href="http://mirrors.jenkins-ci.org/redhat/">http://mirrors.jenkins-ci.org/redhat/</a></p><h3 id="2-安装"><a href="#2-安装" class="headerlink" title="2.安装"></a>2.安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs shell">rpm -ivh jenkins-2.325-1.1.noarch.rpm<br></code></pre></td></tr></table></figure><p>出现错误：</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs subunit">错误：依赖检测失败：<br>        daemonize 被 jenkins<span class="hljs-string">-2</span>.325<span class="hljs-string">-1</span>.1.noarch 需要<br></code></pre></td></tr></table></figure><p>解决错误：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum -y install epel-release<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum -y install daemonize<br></code></pre></td></tr></table></figure><h3 id="3-配置"><a href="#3-配置" class="headerlink" title="3.配置"></a>3.配置</h3><p>vim &#x2F;etc&#x2F;sysconfig&#x2F;jenkins</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#配置端口</span><br><span class="hljs-attr">JENKINS_PORT</span>=<span class="hljs-string">&quot;10000&quot;</span><br><span class="hljs-comment">#配置用户</span><br><span class="hljs-attr">JENKINS_USER</span>=<span class="hljs-string">&quot;root&quot;</span><br></code></pre></td></tr></table></figure><p>修改目录权限</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">chown -R root:root <span class="hljs-regexp">/var/</span>lib/jenkins<br>chown -R root:root <span class="hljs-regexp">/var/</span>cache/jenkins<br>chown -R root:root <span class="hljs-regexp">/var/</span>log/jenkins<br></code></pre></td></tr></table></figure><h3 id="4-启动"><a href="#4-启动" class="headerlink" title="4.启动"></a>4.启动</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">service jenkins <span class="hljs-literal">start</span><br></code></pre></td></tr></table></figure><p>出现：</p><p>Starting jenkins (via systemctl):  Job for jenkins.service failed because the control process exited with error code. See “systemctl status jenkins.service” and “journalctl -xe” for details. [FAILED]</p><p>查看错误详情：</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs fortran">systemctl <span class="hljs-keyword">status</span> jenkins.service<br></code></pre></td></tr></table></figure><p>出现：</p><p>Starting Jenkins File “&#x2F;usr&#x2F;bin&#x2F;java” is not executable.</p><p>解决：</p><p>查看java安装目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">which</span> java<br></code></pre></td></tr></table></figure><p>创建软连接：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">ln -s <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/jdk1.8/</span>bin<span class="hljs-regexp">/java /u</span>sr<span class="hljs-regexp">/bin/</span>java<br></code></pre></td></tr></table></figure><p>启动：service jenkins start</p><p>设置开机启动：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">chkconfig</span> jenkins <span class="hljs-literal">on</span><br></code></pre></td></tr></table></figure><h3 id="5-访问及配置"><a href="#5-访问及配置" class="headerlink" title="5.访问及配置"></a>5.访问及配置</h3><p><a href="http://8.142.19.12:10000/">http://8.142.19.12:10000/</a></p><h4 id="5-1创建第一个管理用户："><a href="#5-1创建第一个管理用户：" class="headerlink" title="5.1创建第一个管理用户："></a>5.1创建第一个管理用户：</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">jenkinsadmin</span><br></code></pre></td></tr></table></figure><h4 id="5-2配置插件更新源"><a href="#5-2配置插件更新源" class="headerlink" title="5.2配置插件更新源"></a>5.2配置插件更新源</h4><p>Dashboard –&gt; Manage Jenkins –&gt; Manage Plugins –&gt; Advances –&gt; Update Site</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//mi</span>rrors.tuna.tsinghua.edu.cn<span class="hljs-regexp">/jenkins/u</span>pdates/update-center.json<br></code></pre></td></tr></table></figure><h4 id="5-3安装权限插件"><a href="#5-3安装权限插件" class="headerlink" title="5.3安装权限插件"></a>5.3安装权限插件</h4><p>Role-based Authorization Strategy   权限的插件（百度一下如何使用）</p><p>git 插件</p><p>Maven Integration</p><h4 id="5-4配置："><a href="#5-4配置：" class="headerlink" title="5.4配置："></a>5.4配置：</h4><p>系统管理-&gt;全局工具配置-&gt;配置jdk、maven、git</p><h4 id="5-5-添加凭证"><a href="#5-5-添加凭证" class="headerlink" title="5.5 添加凭证"></a>5.5 添加凭证</h4><p>系统管理-&gt; manage credentials -&gt;系统-&gt;全局凭证-&gt;添加凭证</p><p>这里可以添加服务器的shell的凭证和git的凭证。</p><h3 id="6-新建任务"><a href="#6-新建任务" class="headerlink" title="6. 新建任务"></a>6. 新建任务</h3><p>点击新建任务-&gt;选择“构建一个maven项目”;</p><p>选择“源码管理”-&gt;设置“git”-&gt;Repository URL 和 Credentials（选择git的凭证）</p><p>可以选择分支。</p><p>构建（build）： Goals and options: clean install -Dmaven.test.skip&#x3D;true</p><p>Post Steps: 选择Run only if build succeeds </p><p>选择“执行shell”:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">cp $&#123;WORKSPACE&#125;/trans-admin/target/trans-admin.jar /usr/local/pro/trans-core/<br>if [$? -ne 0]; then <br>    echo &quot;拷贝jar包失败&quot;<br>else<br>  cd /usr/local/pro/trans-core/<br>  BUILD_ID=dontKillMe<br>  sh ./script.sh restart<br>fi<br></code></pre></td></tr></table></figure><p>必须要加上BUILD_ID&#x3D;dontKillMe，不然后不能启动成功</p>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring boot启动脚本</title>
    <link href="/2021/12/17/shell/springboot%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC/"/>
    <url>/2021/12/17/shell/springboot%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC/</url>
    
    <content type="html"><![CDATA[<h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><figure class="highlight shell"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></div></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">本脚本基本无需改动，注意要点均已用中文说明</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">1. 请将本脚本放到Linux系统的path路径下，最好是/bin目录下</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">2. 请给本脚本设备可执行权限</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">3. 启动示例         sh ./script.sh  start</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">4. 重启示例         sh ./script.sh  restart</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">5. 停止示例         sh ./script.sh  stop</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">6. 查看状态示例     sh ./script.sh  status</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 获取 java 命令的路径</span></span><br>JAVA_CMD=`which java`<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 脚本名称</span></span><br>APP_NAME=&quot;trans-admin.jar&quot;;<br><br>if [ -z &quot;$&#123;JAVA_CMD&#125;&quot; ];then<br>  echo &quot;Please install the Java environment&quot;;<br>  exit 1;<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 输出本命令的使用方法 并退出</span></span><br>usage() &#123;<br>    echo &quot;Usage: sh ./script.sh [start|stop|restart|status]&quot;<br>    exit 1<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 判断是否输入了两个参数</span></span><br>if [ $# -lt 1 ]; then<br>    usage<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 操作</span></span><br>OPERATION=$1;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 判断目标程序是否已经启动</span></span><br>is_running()&#123;<br><span class="hljs-meta prompt_">  #</span><span class="language-bash"><span class="hljs-comment"># 尝试获取已经运行程序的PID</span></span><br>  PID=`ps -ef|grep $&#123;APP_NAME&#125;|grep -v grep|awk &#x27;&#123;print $2&#125;&#x27;`<br>  if [ -z &quot;$&#123;PID&#125;&quot; ]; then<br>    return 0<br>  else<br>    return 1<br>  fi<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 启动程序</span></span><br>start()&#123;<br>  is_running<br>  if [ $? -eq &quot;1&quot; ]; then<br>    echo &quot;$&#123;APP_NAME&#125; is already running. pid is $&#123;PID&#125; .&quot;<br>  else<br>    ## 启动 jar 包<br>    echo &quot;$&#123;APP_NAME&#125; starting ...... &quot;<br>    JVM_PARAMS=&quot;-Xms1280m -Xmx2560m -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -XX:+PrintGCCause -XX:+PrintHeapAtGC -Xloggc:/home/trans/logs/gc.log&quot;<br>    APP_PARAMS=&quot;--spring.profiles.active=dev&quot;<br>    nohup $&#123;JAVA_CMD&#125; $&#123;JVM_PARAMS&#125; -jar $&#123;APP_NAME&#125; $&#123;APP_PARAMS&#125;  &gt; /dev/null 2&gt;&amp;1 &amp;<br>    echo &quot;启动$&#123;APP_NAME&#125;&quot;<br>    sleep 1<br>    echo &quot;$&#123;APP_NAME&#125; started  completed &quot;<br>    echo &quot;&quot;<br>  fi<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 停止程序</span></span><br>stop()&#123;<br>  is_running<br>  if [ $? -eq &quot;1&quot; ]; then<br>echo &quot;execute kill $&#123;PID&#125;&quot;<br>kill $&#123;PID&#125;<br>    sleep 1<br>    echo &quot;$&#123;APP_NAME&#125; stopped completed &quot;<br>  else<br>    echo &quot;$&#123;APP_NAME&#125; is not running&quot;<br>  fi<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 输出程序运行状态</span></span><br>status()&#123;<br>  is_running<br>  if [ $? -eq &quot;1&quot; ]; then<br>    echo &quot;$&#123;APP_NAME&#125; is running. pid is $&#123;PID&#125;&quot;<br>  else<br>    echo &quot;$&#123;APP_NAME&#125; is NOT running.&quot;<br>  fi<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 重启程序</span></span><br>restart()&#123;<br>  stop<br>sleep 15<br>  start<br>&#125;<br><br><br>case &quot;$OPERATION&quot; in<br>  &quot;start&quot;)<br>    start ;;<br>  &quot;stop&quot;)<br>    stop ;;<br>  &quot;status&quot;)<br>    status ;;<br>  &quot;restart&quot;)<br>    restart ;;<br>  *)<br>    usage ;;<br>esac<br>exit 0<br></code></pre></td></tr></table></figure><p>windows创建文件传到Linux需要把回车符转换：</p><p>用notepad++中“编辑”菜单中“文档格式转换”中“转换为UNIX”。</p><h2 id="java-jar"><a href="#java-jar" class="headerlink" title="java -jar"></a>java -jar</h2><p>直接进入服务器或者在本地执行 java -jar显示：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scss">java <span class="hljs-selector-attr">[-options]</span> class <span class="hljs-selector-attr">[args...]</span><br>           (执行类)<br>   或  java <span class="hljs-selector-attr">[-options]</span> -jar jarfile <span class="hljs-selector-attr">[args...]</span><br>           (执行 jar 文件)<br></code></pre></td></tr></table></figure><p>java -jar ,   -jar前是jvm的参数， args是应用的参数。</p>]]></content>
    
    
    <categories>
      
      <category>shell</category>
      
    </categories>
    
    
    <tags>
      
      <tag>shell</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>maven引用的过期的jar包问题</title>
    <link href="/2021/10/12/maven/maven%E5%BC%95%E7%94%A8%E7%9A%84%E8%BF%87%E6%9C%9F%E7%9A%84jar%E5%8C%85%E9%97%AE%E9%A2%98/"/>
    <url>/2021/10/12/maven/maven%E5%BC%95%E7%94%A8%E7%9A%84%E8%BF%87%E6%9C%9F%E7%9A%84jar%E5%8C%85%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h2 id="1-问题"><a href="#1-问题" class="headerlink" title="1.问题"></a>1.问题</h2><p>因为项目里引用了过期的jar包，阿里云仓库及很多仓库都没有了，也就是下载不下来了，私服也没有，但是别人那里有这个包，这时maven打包一直下载不了这包，如何解决？</p><h2 id="2-解决方案"><a href="#2-解决方案" class="headerlink" title="2.解决方案"></a>2.解决方案</h2><p>方案一 把这个jar安装到本地仓库<br>mvn install:install-file -Dfile&#x3D;”D:\artemis-http-client-1.0.0.jar” -DgroupId&#x3D;com.hikvision -DartifactId&#x3D;artemis-http-client -Dversion&#x3D;1.0.0 -Dpackaging&#x3D;jar</p><p>方案二 把这个jar安装到私服</p>]]></content>
    
    
    <categories>
      
      <category>maven</category>
      
    </categories>
    
    
    <tags>
      
      <tag>maven</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>小滴课堂首页版心banner</title>
    <link href="/2021/04/26/%E5%89%8D%E7%AB%AF/%E5%B0%8F%E6%BB%B4%E8%AF%BE%E5%A0%82%E9%A6%96%E9%A1%B5%E7%89%88%E5%BF%83banner/"/>
    <url>/2021/04/26/%E5%89%8D%E7%AB%AF/%E5%B0%8F%E6%BB%B4%E8%AF%BE%E5%A0%82%E9%A6%96%E9%A1%B5%E7%89%88%E5%BF%83banner/</url>
    
    <content type="html"><![CDATA[<h3 id="一-思路及布局"><a href="#一-思路及布局" class="headerlink" title="一.思路及布局"></a>一.思路及布局</h3><p>版心分为：banner区、课程区</p><h3 id="二-编写"><a href="#二-编写" class="headerlink" title="二.编写"></a>二.编写</h3><p>1.html编写</p><figure class="highlight html"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;content&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;banner clearfix&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;l-category fl&quot;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>后端<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>后端<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>后端<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>后端<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>后端<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;r-banner fl&quot;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:void(0)&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;./img/banner.png&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;banner&quot;</span>&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p>2.css编写</p><p>清除header的浮动</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.header</span> &#123;<br>    <span class="hljs-attribute">height</span>: <span class="hljs-number">60px</span>;<br>    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">60px</span>;<br>    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span>;<br>    <span class="hljs-attribute">overflow</span>: hidden;<br>&#125;<br></code></pre></td></tr></table></figure><p>把banner背景色设置为白色，边框变为圆角</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.banner</span> &#123;<br>    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>;<br>    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">20px</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>设置类别的宽高及属性</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.l-category</span> &#123;<br>    <span class="hljs-attribute">width</span>: <span class="hljs-number">220px</span>;<br>    <span class="hljs-attribute">height</span>: <span class="hljs-number">450px</span>;<br>    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span>;<br>    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#0c0c13</span>;<br>    <span class="hljs-attribute">opacity</span>: .<span class="hljs-number">9</span>;<br>    <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.l-category</span> <span class="hljs-selector-tag">li</span> &#123;<br>    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;<br>    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">60px</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>每个类别后面增加&gt;</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.l-category</span> <span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">::after</span> &#123;<br>  <span class="hljs-attribute">content</span>: <span class="hljs-string">&quot;&gt;&quot;</span>;<br>  <span class="hljs-attribute">display</span>: block;<br>  <span class="hljs-attribute">float</span>: right;<br>&#125;<br></code></pre></td></tr></table></figure><p>banner区a标签</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.r-banner</span> <span class="hljs-selector-tag">a</span> &#123;<br>    <span class="hljs-attribute">display</span>: block;<br>    <span class="hljs-attribute">position</span>: relative;<br>&#125;<br><span class="hljs-selector-class">.r-banner</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">::before</span>, <span class="hljs-selector-class">.r-banner</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">::after</span> &#123;<br>  <span class="hljs-attribute">position</span>: absolute;<br>  <span class="hljs-attribute">display</span>: block;<br>  <span class="hljs-attribute">content</span>: <span class="hljs-string">&quot;&quot;</span>;<br>  <span class="hljs-attribute">width</span>: <span class="hljs-number">27px</span>;<br>  <span class="hljs-attribute">height</span>: <span class="hljs-number">44px</span>;<br>  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;<br>  <span class="hljs-attribute">margin-top</span>: -<span class="hljs-number">22px</span>;<br>&#125;<br><span class="hljs-selector-class">.r-banner</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">::before</span> &#123;<br>  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">&#x27;../img/prev.png&#x27;</span>) no-repeat center;<br>  <span class="hljs-attribute">left</span>: <span class="hljs-number">20px</span>;<br>&#125;<br><span class="hljs-selector-class">.r-banner</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">::after</span> &#123;<br>  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">&#x27;../img/next.png&#x27;</span>) no-repeat center;<br>  <span class="hljs-attribute">right</span>: <span class="hljs-number">20px</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>html+css入门</category>
      
    </categories>
    
    
    <tags>
      
      <tag>css</tag>
      
      <tag>html</tag>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>小滴课堂首页尾部</title>
    <link href="/2021/04/23/%E5%89%8D%E7%AB%AF/%E5%B0%8F%E6%BB%B4%E8%AF%BE%E5%A0%82%E9%A6%96%E9%A1%B5%E5%B0%BE%E9%83%A8/"/>
    <url>/2021/04/23/%E5%89%8D%E7%AB%AF/%E5%B0%8F%E6%BB%B4%E8%AF%BE%E5%A0%82%E9%A6%96%E9%A1%B5%E5%B0%BE%E9%83%A8/</url>
    
    <content type="html"><![CDATA[<h3 id="一-思路及布局"><a href="#一-思路及布局" class="headerlink" title="一.思路及布局"></a>一.思路及布局</h3><p>尾部：分为图标区、连接区、备案区</p><h3 id="二-编写"><a href="#二-编写" class="headerlink" title="二.编写"></a>二.编写</h3><p>1.html编写</p><figure class="highlight html"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;_container&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;_social&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:void(0)&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;./img/weibo.png&quot;</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;官方微博&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:void(0)&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;./img/weixin.png&quot;</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;官方公众号&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:void(0)&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;./img/qq.png&quot;</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;客服QQ&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;_link&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>关于我们<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>联系我们<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>帮助中心<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>加入我们<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>讲师合作<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>友情链接<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;_copyright&quot;</span>&gt;</span><br>        Copyright © <br>        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502035713&quot;</span>&gt;</span>京ICP备18028493号<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p>2.css编写</p><p>居中显示</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs css">._container &#123;<br>    <span class="hljs-attribute">width</span>: <span class="hljs-number">432px</span>;<br>    <span class="hljs-attribute">height</span>: <span class="hljs-number">144px</span>;<br>    <span class="hljs-attribute">padding-top</span>: <span class="hljs-number">15px</span>;<br>    <span class="hljs-attribute">margin</span>: auto;<br>&#125;<br></code></pre></td></tr></table></figure><p>图标间隔太近</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css">._social <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">img</span> &#123;<br>    <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>去掉圆点</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css">._link <span class="hljs-selector-tag">li</span> &#123;<br>    <span class="hljs-attribute">list-style-type</span>: none;<br>&#125;<br></code></pre></td></tr></table></figure><p>让li一行显示</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css">._link <span class="hljs-selector-tag">li</span> &#123;<br>    <span class="hljs-attribute">list-style-type</span>: none;<br>  <span class="hljs-attribute">display</span>: inline-block<br>&#125;<br></code></pre></td></tr></table></figure><p>让_link居中</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css">._link &#123;<br>    <span class="hljs-attribute">text-align</span>: center;<br>&#125;<br></code></pre></td></tr></table></figure><p>把li上图标显示改一下</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css">._link <span class="hljs-selector-tag">li</span> &#123;<br>    <span class="hljs-attribute">list-style-type</span>: none;<br>  <span class="hljs-attribute">display</span>: inline-block;<br>  <span class="hljs-attribute">cursor</span>: pointer;<br>&#125;<br></code></pre></td></tr></table></figure><p>把li之间的间隔改一下，字体改一下</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs css">._link <span class="hljs-selector-tag">li</span> &#123;<br>    <span class="hljs-attribute">list-style-type</span>: none;<br>  <span class="hljs-attribute">display</span>: inline-block;<br>  <span class="hljs-attribute">cursor</span>: pointer;<br>  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-number">5px</span>;<br>  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>备案区</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs css">._copyright &#123;<br>    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">10px</span>;<br>    <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">5px</span>;<br>    <span class="hljs-attribute">padding-top</span>: <span class="hljs-number">5px</span>;<br>    <span class="hljs-attribute">border-top</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#000</span>;<br>    <span class="hljs-attribute">text-align</span>: center;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>html+css入门</category>
      
    </categories>
    
    
    <tags>
      
      <tag>css</tag>
      
      <tag>html</tag>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>小滴课堂首页头部</title>
    <link href="/2021/04/22/%E5%89%8D%E7%AB%AF/%E5%B0%8F%E6%BB%B4%E8%AF%BE%E5%A0%82%E9%A6%96%E9%A1%B5%E5%A4%B4%E9%83%A8/"/>
    <url>/2021/04/22/%E5%89%8D%E7%AB%AF/%E5%B0%8F%E6%BB%B4%E8%AF%BE%E5%A0%82%E9%A6%96%E9%A1%B5%E5%A4%B4%E9%83%A8/</url>
    
    <content type="html"><![CDATA[<h3 id="一-思路及布局"><a href="#一-思路及布局" class="headerlink" title="一.思路及布局"></a>一.思路及布局</h3><p>头部分为logo区、横向导航区、搜索区、用户区</p><p>logo区就放图片，然后放在左边</p><p>横向导航区放一个列表，列表左浮动</p><p>搜索区一个搜索输入框，上面有示例方案，有一个搜索图标</p><p>用户区有可点击文案及头像，向右浮动</p><p>header左右设置间隙(padding)</p><figure class="highlight css"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs css"><span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span>;<br></code></pre></td></tr></table></figure><h3 id="二-logo区"><a href="#二-logo区" class="headerlink" title="二.logo区"></a>二.logo区</h3><p>1.html编写</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;logo fl&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;./img/logo.png&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;小滴课堂&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p>2.css编写</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* 左浮动 */</span><br><span class="hljs-selector-class">.fl</span> &#123;<br>  <span class="hljs-attribute">float</span>: left;<br>&#125;<br></code></pre></td></tr></table></figure><p>div 装img图片时，div会被撑大了,使用font-size:0</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.logo</span> &#123;<br>    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="三、横向导航区"><a href="#三、横向导航区" class="headerlink" title="三、横向导航区"></a>三、横向导航区</h3><p>1.html编写</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nav fl&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:void(0)&quot;</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:void(0)&quot;</span>&gt;</span>视频学习<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:void(0)&quot;</span>&gt;</span>超级会员<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:void(0)&quot;</span>&gt;</span>学习路线<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:void(0)&quot;</span>&gt;</span>工具<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br></code></pre></td></tr></table></figure><p>2.css编写</p><p>ul已左浮动，但是ul下的li没有左浮动</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.nav</span> <span class="hljs-selector-tag">li</span> &#123;<br>  <span class="hljs-attribute">float</span>: left;<br>&#125;<br></code></pre></td></tr></table></figure><p>文字在顶部显示，居中显示,给header添加</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-attribute">line-height</span>: <span class="hljs-number">60px</span>;<br></code></pre></td></tr></table></figure><p>文字挤在一起，给li添加盒子与盒子的间隙</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-attribute">margin-right</span>: <span class="hljs-number">20px</span>;<br></code></pre></td></tr></table></figure><p>“首页”与logo区紧挨在一起，给logo区添加盒子与盒子的间隙</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-attribute">margin-right</span>: <span class="hljs-number">30px</span>;<br></code></pre></td></tr></table></figure><p>a标签的默认样式有点丑</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">a</span> &#123;<br>  <span class="hljs-attribute">text-decoration</span>: none;<br>  <span class="hljs-attribute">color</span>: inherit;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="四、搜索区"><a href="#四、搜索区" class="headerlink" title="四、搜索区"></a>四、搜索区</h3><p>1.html编写</p><p>这里使用了阿里云的图标库</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;http://at.alicdn.com/t/font_883438_djybibku2l.css&quot;</span>&gt;</span>    <br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;search fl&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;keyword&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>Java<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>Html<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;iconfont icon-icon-test&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p>2.css编写</p><p>布局：关键字在输入框上，搜索图标在输入框里右边</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.search</span> &#123;<br>  <span class="hljs-attribute">position</span>: relative;<br>&#125;<br><span class="hljs-selector-class">.keyword</span> &#123;<br>  <span class="hljs-attribute">position</span>: absolute;<br>  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;<br>  <span class="hljs-attribute">width</span>: <span class="hljs-number">120px</span>;<br>  <span class="hljs-attribute">margin-left</span>: -<span class="hljs-number">70px</span>;<br>  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">10px</span>;<br>  <span class="hljs-attribute">text-align</span>: center;<br>&#125;<br><span class="hljs-selector-class">.icon-icon-test</span> &#123;<br>  <span class="hljs-attribute">position</span>: absolute;<br>  <span class="hljs-attribute">right</span>: <span class="hljs-number">15px</span>;<br>  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">10px</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>默认输入框有点丑：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">input</span> &#123;<br><span class="hljs-attribute">outline</span>: <span class="hljs-number">0</span>;<br><span class="hljs-attribute">background-color</span>: transparent;<br><span class="hljs-attribute">border-width</span>: <span class="hljs-number">1px</span>;<br><span class="hljs-attribute">box-shadow</span>: none;<br>&#125;<br></code></pre></td></tr></table></figure><p>输入框：去掉边框(border)</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.search</span> <span class="hljs-selector-tag">input</span> &#123;<br>  <span class="hljs-attribute">border</span>: none;<br>  <span class="hljs-attribute">width</span>: <span class="hljs-number">180px</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>输入框：下边框，横线</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#000</span>;<br></code></pre></td></tr></table></figure><p>关键字：设置字体、背景色、内部间隙(padding)、边框设为圆角(border-radius)</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.keyword</span> <span class="hljs-selector-tag">span</span> &#123;<br>  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;<br>  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ccc</span>;<br>  <span class="hljs-attribute">padding</span>: <span class="hljs-number">5px</span> <span class="hljs-number">10px</span>;<br>  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">15px</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>搜索区居中，距离左边太近，不太好看</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.search</span> &#123;<br>  <span class="hljs-attribute">position</span>: relative;<br>  <span class="hljs-attribute">padding-top</span>: <span class="hljs-number">10px</span>;<br>  <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">20px</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="五、用户区"><a href="#五、用户区" class="headerlink" title="五、用户区"></a>五、用户区</h3><p>1.html编写</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;r-btn fr&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>兑换优惠券<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>注册<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>  /<br>  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;./img/avatar.png&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p>2.css编写</p><p>用户区要整体向右浮动</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.fr</span> &#123;<br>  <span class="hljs-attribute">float</span>: right;<br>&#125;<br></code></pre></td></tr></table></figure><p>用户默认头像把用户区撑大了</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.r-btn</span> <span class="hljs-selector-tag">img</span> &#123;<br>    <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>头像居中</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-attribute">vertical-align</span>: middle;<br></code></pre></td></tr></table></figure><p>头像与左边按钮距离太近</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span>;<br></code></pre></td></tr></table></figure><p>按钮设置字体与间距</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.r-btn</span> <span class="hljs-selector-tag">span</span> &#123;<br>  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span>;<br>  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>html+css入门</category>
      
    </categories>
    
    
    <tags>
      
      <tag>css</tag>
      
      <tag>html</tag>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>小滴课堂首页布局</title>
    <link href="/2021/04/21/%E5%89%8D%E7%AB%AF/%E5%B0%8F%E6%BB%B4%E8%AF%BE%E5%A0%82%E9%A6%96%E9%A1%B5%E5%B8%83%E5%B1%80/"/>
    <url>/2021/04/21/%E5%89%8D%E7%AB%AF/%E5%B0%8F%E6%BB%B4%E8%AF%BE%E5%A0%82%E9%A6%96%E9%A1%B5%E5%B8%83%E5%B1%80/</url>
    
    <content type="html"><![CDATA[<p>html在网页中的作用：定义页面结构，定义有什么</p><p>css在网页中的作用：修饰页面结构和样式</p><h3 id="1-html编写"><a href="#1-html编写" class="headerlink" title="1.html编写"></a>1.html编写</h3><p>分为头部、中间内容、底部；中间内容又包含版心</p><figure class="highlight html"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;header&quot;</span>&gt;</span><br>       <br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;main&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;content&quot;</span>&gt;</span><br>            <br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;footer&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="2-css编写"><a href="#2-css编写" class="headerlink" title="2.css编写"></a>2.css编写</h3><p>固定头部高度</p><p>固定底部高度</p><p>中间部分包含版心，版心设置宽度和最小高度</p><p>reset.css重置所有元素都为border-box</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-attribute">box-sizing</span>: border-box;<br></code></pre></td></tr></table></figure><p>index.css</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.header</span> &#123;<br>    <span class="hljs-attribute">height</span>: <span class="hljs-number">60px</span>;<br>    <span class="hljs-attribute">background-color</span>: red;<br>&#125;<br><span class="hljs-selector-class">.main</span> &#123;<br>    <span class="hljs-attribute">background-color</span>: blue;<br>&#125;<br><span class="hljs-selector-class">.content</span> &#123;<br>    <span class="hljs-attribute">width</span>: <span class="hljs-number">1200px</span>;<br>    <span class="hljs-attribute">margin</span>: auto;<br>    <span class="hljs-attribute">background-color</span>: green;<br>    <span class="hljs-attribute">min-height</span>: <span class="hljs-number">600px</span>;<br>&#125;<br><span class="hljs-selector-class">.footer</span> &#123;<br>    <span class="hljs-attribute">height</span>: <span class="hljs-number">144px</span>;<br>    <span class="hljs-attribute">background-color</span>: yellow;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>html+css入门</category>
      
    </categories>
    
    
    <tags>
      
      <tag>css</tag>
      
      <tag>html</tag>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>便利蜂</title>
    <link href="/2021/04/20/%E5%95%86%E4%B8%9A%E6%A8%A1%E5%BC%8F/%E4%BE%BF%E5%88%A9%E8%9C%82/"/>
    <url>/2021/04/20/%E5%95%86%E4%B8%9A%E6%A8%A1%E5%BC%8F/%E4%BE%BF%E5%88%A9%E8%9C%82/</url>
    
    <content type="html"><![CDATA[<h3 id="1-总体"><a href="#1-总体" class="headerlink" title="1.总体"></a>1.总体</h3><p>通过“中央大脑”来数字化运营新零售便利店，通过输入到中央大脑的区域位置、不同时间段的消费者喜好，从而实现千店千面。</p><h3 id="2-对员工的管理"><a href="#2-对员工的管理" class="headerlink" title="2.对员工的管理"></a>2.对员工的管理</h3><p>培训员工成本，普通员工两周，店长45天(两个月)。</p><p>降低员工的决策权，监督员工的服务质量(露齿率”)。</p><h3 id="3-生产、运输、销售的数字化控制"><a href="#3-生产、运输、销售的数字化控制" class="headerlink" title="3.生产、运输、销售的数字化控制"></a>3.生产、运输、销售的数字化控制</h3><p>便利蜂招聘技术人才，将算法驱动模式注入到生产、运输到销售的全流程。</p><p>热餐：</p><p>​配送环节：在冷链运输车上安装了蓝牙温度计和GPS,如果司机为了省油关掉空调，温度出现异常，后台会收到报警，门店将会拒收。</p><p>​门店食品管理：通过鲜度管理系统、食品二维码保持期追踪系统、批次管理系统对到店的食品进行温度和有效期管理。系统都有生产计划，店员按照指示进行制作。</p><p>​保质期计时：制作完成后，系统立即开始计时。过期后，员工需要在摄像头的记录下，把过期的热餐抛弃。</p><p>​搭配决策：每次做几个包子，几个肉的，几个素的。荤素搭配、主菜平衡。</p><p>商品：</p><p>​打折控制（数字化、电子标签）</p><h3 id="4-开店"><a href="#4-开店" class="headerlink" title="4.开店"></a>4.开店</h3><p>基于自动化决策系统进行便利店选址、设计装修、店长培训、选品、订货、定价、员工排班，以及自由商品生产、物流、销售等多个模板，一起推动便利蜂这台机器的高速运转。</p><h3 id="5-需求"><a href="#5-需求" class="headerlink" title="5.需求"></a>5.需求</h3><p>买东西便利</p><h3 id="6-差异化"><a href="#6-差异化" class="headerlink" title="6.差异化"></a>6.差异化</h3><p>通过系统进行决策，千店千面</p><h3 id="7-壁垒"><a href="#7-壁垒" class="headerlink" title="7.壁垒"></a>7.壁垒</h3><p>系统开发成本、实体店开店成本、员工培训成本、品牌推广成本。</p>]]></content>
    
    
    <categories>
      
      <category>商业模式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>商业模式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>中国平安</title>
    <link href="/2021/04/20/%E5%95%86%E4%B8%9A%E6%A8%A1%E5%BC%8F/%E4%B8%AD%E5%9B%BD%E5%B9%B3%E5%AE%89/"/>
    <url>/2021/04/20/%E5%95%86%E4%B8%9A%E6%A8%A1%E5%BC%8F/%E4%B8%AD%E5%9B%BD%E5%B9%B3%E5%AE%89/</url>
    
    <content type="html"><![CDATA[<h3 id="1-企业文化"><a href="#1-企业文化" class="headerlink" title="1.企业文化"></a>1.企业文化</h3><p>愿景：国际领先的科技型个人金融生活服务集团</p><p>使命：对客户负责、对股东负责、对员工负责、对社会负责</p><p>价值观：价值最大化是检验平安经营管理一切工作的标准</p><p>核心理念：专业创造价值</p><p>品牌口号：危机意识、包容、简单</p><p>公司训导：专业领先、诚信服务、创造价值、回馈社会</p><h3 id="2-经营范围"><a href="#2-经营范围" class="headerlink" title="2.经营范围"></a>2.经营范围</h3><p>国内、国际业务</p><p>保险、银行、投资、金融科技、共享</p><h3 id="3-如何挣钱"><a href="#3-如何挣钱" class="headerlink" title="3.如何挣钱"></a>3.如何挣钱</h3><p>盈利&#x3D;（投资收益率-保单成本）*资产规模</p><p>保险公司靠销售能力、投资能力、定价能力来赚钱</p><p>卖保险，卖的越多，钱越多，钱多可以去投资，风控保障</p><p><strong>第一是承保利润(死差)</strong></p><p>说白了就是客户缴费的时候，利润已经加进去了，保险公司就是赚钱的。</p><p>保险是大数法则，保险公司在厘定费率(多大年龄交多少保费)的时候参考生命周期表，拿寿险举例子，某一个年龄，身故的概率是确定的，根据这一概率确定保险保障成本。但是随着人均寿命越来越长，之前预计寿命是按76岁算的，但是每10年，人均寿命会增加2-3岁，所以后面保险公司理赔的时间会推迟。那保险公司用客户的钱的时间也会比预期的长，相当于客户交的保费多了，这就是保险公司的承保利润，也是最基本的利润。</p><p><strong>第二是投资利润(利差)</strong></p><p>刚说了保险公司的融资成本比较低，不论做什么投资都是赚钱的。</p><p>最简单的，保险公司首先必须保证客户资金的安全，所以拿了很大一部分存的是银行大额协议存款，国债，企业债券等风险低，收益不高的投资，还有一部分做证券，地产，大型基础建设项目等。赚到的钱，减去保险公司给客户承诺的收益后，就是保险公司的利润，举例现在很多重疾险，预定利率是3.5%，那么高于3.5%的收益就是保险公司的利润。现在保险公司也都有保单贷款功能，以华夏为例，现金价值贷款，年化利率是5%，融资成本是3.5%，高出的这1.5%是净利润，躺赚的。</p><p><strong>第三是运营利润(费差)</strong></p><p>保险公司在运营中，有一定的预算，比如广告费，内勤工资，场地费，营销员的佣金等。假如营销员离职了，续期佣金不用发了，这样就会省下一大笔钱；还有比如保险公司预算的广告费没有花完，省下来的这个钱就是保险公司的运营利润(也叫费差)。</p>]]></content>
    
    
    <categories>
      
      <category>商业模式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>商业模式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>基金公司</title>
    <link href="/2021/04/20/%E5%95%86%E4%B8%9A%E6%A8%A1%E5%BC%8F/%E5%9F%BA%E9%87%91%E5%85%AC%E5%8F%B8/"/>
    <url>/2021/04/20/%E5%95%86%E4%B8%9A%E6%A8%A1%E5%BC%8F/%E5%9F%BA%E9%87%91%E5%85%AC%E5%8F%B8/</url>
    
    <content type="html"><![CDATA[<h3 id="一-收入来源"><a href="#一-收入来源" class="headerlink" title="一.收入来源"></a>一.收入来源</h3><p>1.运作费：管理费、销售服务费</p><p>2.申购费：前端，买入时收</p><p>3.赎回费：卖出时收</p>]]></content>
    
    
    <categories>
      
      <category>商业模式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>商业模式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>方圆众合</title>
    <link href="/2021/04/20/%E5%95%86%E4%B8%9A%E6%A8%A1%E5%BC%8F/%E6%96%B9%E5%9C%86%E4%BC%97%E5%90%88/"/>
    <url>/2021/04/20/%E5%95%86%E4%B8%9A%E6%A8%A1%E5%BC%8F/%E6%96%B9%E5%9C%86%E4%BC%97%E5%90%88/</url>
    
    <content type="html"><![CDATA[<h3 id="1-总体"><a href="#1-总体" class="headerlink" title="1.总体"></a>1.总体</h3><p>是一家做法考培训、法硕培训、图书发行、法律实务培训的教育公司。</p><p>主要是以法考培训为主，以头部IP导师、开办学校点、销售进行盈利。</p><p>商品分为线上授课、线下授课、直播课(营销)、图书(赠品)</p><p>众合在线app(商城模式)、竹马app(引流、刷题、商城)</p><h3 id="2-主要点"><a href="#2-主要点" class="headerlink" title="2.主要点"></a>2.主要点</h3><p>销售力、营销力</p><p>IP导师影响力</p><p>平台营销能力</p><h3 id="3-需求"><a href="#3-需求" class="headerlink" title="3.需求"></a>3.需求</h3><p>解决了法律工作者考证的需求(通过率)</p><h3 id="4-差异化"><a href="#4-差异化" class="headerlink" title="4.差异化"></a>4.差异化</h3><p>无差异</p><h3 id="5-壁垒"><a href="#5-壁垒" class="headerlink" title="5.壁垒"></a>5.壁垒</h3><p>app排名、头部IP导师+、品牌推广成本</p>]]></content>
    
    
    <categories>
      
      <category>商业模式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>商业模式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>证券公司</title>
    <link href="/2021/04/20/%E5%95%86%E4%B8%9A%E6%A8%A1%E5%BC%8F/%E8%AF%81%E5%88%B8%E5%85%AC%E5%8F%B8/"/>
    <url>/2021/04/20/%E5%95%86%E4%B8%9A%E6%A8%A1%E5%BC%8F/%E8%AF%81%E5%88%B8%E5%85%AC%E5%8F%B8/</url>
    
    <content type="html"><![CDATA[<h3 id="1-收入来源"><a href="#1-收入来源" class="headerlink" title="1.收入来源"></a>1.收入来源</h3><p>佣金收入：客户每一笔买卖股票都需要抽成—券商以前最大的收入来源，这两年佣金从千三下滑到万2.5，收入占比逐年下滑；</p><p>息差收入：借钱给客户去买卖股票（融资融券）或者做其他事情（股权质押），证券公司赚利息—这块收入占比逐年提升</p><p>代销金融产品收入：客户在券商这里买卖各种金融理财产品，券商都有代销费收入；</p><p>投资咨询收入：券商给你提供推荐股票、投资理财等各方面建议后收取的费用。这块很低，可以忽略不计，国人还不能接受支付这种无形服务，或者说券商因为受到严格监管，反而不能提供让客户满意的服务，所以客户不愿意买单。</p>]]></content>
    
    
    <categories>
      
      <category>商业模式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>商业模式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>银行</title>
    <link href="/2021/04/20/%E5%95%86%E4%B8%9A%E6%A8%A1%E5%BC%8F/%E9%93%B6%E8%A1%8C/"/>
    <url>/2021/04/20/%E5%95%86%E4%B8%9A%E6%A8%A1%E5%BC%8F/%E9%93%B6%E8%A1%8C/</url>
    
    <content type="html"><![CDATA[<h3 id="1-银行挣钱？"><a href="#1-银行挣钱？" class="headerlink" title="1.银行挣钱？"></a>1.银行挣钱？</h3><p>1.赚取利息差：</p><p>贷款利息-存款利息</p><p>2.手续费及佣金</p><p>转账手续费</p><p>3.其他费用</p><p>代理费、咨询费、担保费、年费、卡费、管理费、支票手续费。</p><p>4.上存款准备金</p><p>给中央银行，中央银行给银行的利息</p><h3 id="2-银行风险"><a href="#2-银行风险" class="headerlink" title="2.银行风险"></a>2.银行风险</h3><p>坏账、呆账</p>]]></content>
    
    
    <categories>
      
      <category>商业模式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>商业模式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>sprin boot集成druid</title>
    <link href="/2021/03/12/spring/spring_boot%E9%9B%86%E6%88%90druid/"/>
    <url>/2021/03/12/spring/spring_boot%E9%9B%86%E6%88%90druid/</url>
    
    <content type="html"><![CDATA[<h3 id="一、maven依赖"><a href="#一、maven依赖" class="headerlink" title="一、maven依赖"></a>一、maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="二、配置文件"><a href="#二、配置文件" class="headerlink" title="二、配置文件"></a>二、配置文件</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.datasource.druid.url</span>=<span class="hljs-string">jdbc:mysql://127.0.0.1:3306/crm?useSSL=true\</span><br><span class="hljs-string">  &amp;useUnicode=true\</span><br><span class="hljs-string">  &amp;characterEncoding=UTF-8\</span><br><span class="hljs-string">  &amp;useServerPrepStmts=true\</span><br><span class="hljs-string">  &amp;serverTimezone=Asia/Shanghai\</span><br><span class="hljs-string">  &amp;zeroDateTimeBehavior=CONVERT_TO_NULL</span><br><span class="hljs-attr">spring.datasource.druid.username</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">spring.datasource.druid.password</span>=<span class="hljs-string">root123456</span><br><span class="hljs-attr">spring.datasource.driver-class-name</span>=<span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br><br><span class="hljs-attr">spring.datasource.druid.web-stat-filter.enabled</span>=<span class="hljs-string">true</span><br><span class="hljs-attr">spring.datasource.druid.filter.stat.log-slow-sql</span>=<span class="hljs-string">true</span><br><br><span class="hljs-attr">spring.datasource.druid.stat-view-servlet.enabled</span>=<span class="hljs-string">true</span><br><span class="hljs-attr">spring.datasource.druid.stat-view-servlet.login-username</span>=<span class="hljs-string">admin</span><br><span class="hljs-attr">spring.datasource.druid.stat-view-servlet.login-password</span>=<span class="hljs-string">123456</span><br></code></pre></td></tr></table></figure><h3 id="三、使用"><a href="#三、使用" class="headerlink" title="三、使用"></a>三、使用</h3><p><a href="http://localhost:8080/druid/login.html">http://localhost:8080/druid/login.html</a></p>]]></content>
    
    
    <categories>
      
      <category>spring boot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring boot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring boot集成hikariCP</title>
    <link href="/2021/03/12/spring/spring_boot%E9%9B%86%E6%88%90hikariCP/"/>
    <url>/2021/03/12/spring/spring_boot%E9%9B%86%E6%88%90hikariCP/</url>
    
    <content type="html"><![CDATA[<h3 id="一、spring-boot版本使用的数据库连接池"><a href="#一、spring-boot版本使用的数据库连接池" class="headerlink" title="一、spring boot版本使用的数据库连接池"></a>一、spring boot版本使用的数据库连接池</h3><ul><li>Spring Boot 1.x 默认使用的是 Tomcat 连接池，需要移除 <code>tomcat-jdbc</code>，配置 <code>spring.datasource.type=com.zaxxer.hikari.hIkari.HikariDatasource</code></li><li>Spring Boot 2.x 默认使用 HikariCP</li></ul><h3 id="二、spring-boot-2-x使用"><a href="#二、spring-boot-2-x使用" class="headerlink" title="二、spring boot 2.x使用"></a>二、spring boot 2.x使用</h3><figure class="highlight properties"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.datasource.url</span>=<span class="hljs-string">jdbc:mysql://127.0.0.1:3306/crm?useSSL=true\</span><br><span class="hljs-string">  &amp;useUnicode=true\</span><br><span class="hljs-string">  &amp;characterEncoding=UTF-8\</span><br><span class="hljs-string">  &amp;useServerPrepStmts=true\</span><br><span class="hljs-string">  &amp;serverTimezone=Asia/Shanghai\</span><br><span class="hljs-string">  &amp;zeroDateTimeBehavior=CONVERT_TO_NULL</span><br><span class="hljs-attr">spring.datasource.username</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">spring.datasource.password</span>=<span class="hljs-string">你的密码</span><br><span class="hljs-attr">spring.datasource.driver-class-name</span>=<span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br></code></pre></td></tr></table></figure><p>其他的就是一些配置了，用时在说吧</p>]]></content>
    
    
    <categories>
      
      <category>spring boot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring</tag>
      
      <tag>spring boot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring data mongo的子对象id问题</title>
    <link href="/2021/03/09/spring/spring%20data%20mongo%E7%9A%84%E5%AD%90%E5%AF%B9%E8%B1%A1id%E9%97%AE%E9%A2%98/"/>
    <url>/2021/03/09/spring/spring%20data%20mongo%E7%9A%84%E5%AD%90%E5%AF%B9%E8%B1%A1id%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h2 id="1-子对象ID没有值"><a href="#1-子对象ID没有值" class="headerlink" title="1.子对象ID没有值"></a>1.子对象ID没有值</h2><p>Java中对应2个类来表示此结构</p><p>A对象</p><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;  <br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-keyword">private</span> String id;<br>    <span class="hljs-keyword">private</span> List&lt;B&gt; list;<br>&#125;<br></code></pre></td></tr></table></figure><p>B对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> &#123;<br>   <span class="hljs-keyword">private</span> String id;<br>&#125;<br></code></pre></td></tr></table></figure><p>这时使用spring data mongodb 获取A对象，A对象里的B对象的ID为空</p><h2 id="2-在java-class中增加一个id属性，它会自动映射成”-id”"><a href="#2-在java-class中增加一个id属性，它会自动映射成”-id”" class="headerlink" title="2.在java class中增加一个id属性，它会自动映射成”_id”"></a>2.在java class中增加一个id属性，它会自动映射成”_id”</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> &#123;<br>   <span class="hljs-meta">@Field(&quot;id&quot;)</span><br>   <span class="hljs-keyword">private</span> String id;<br>&#125;<br></code></pre></td></tr></table></figure><p>成功获取</p>]]></content>
    
    
    <categories>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring boot源码及流程</title>
    <link href="/2021/03/09/spring/spring%20boot%E6%BA%90%E7%A0%81%E5%8F%8A%E6%B5%81%E7%A8%8B/"/>
    <url>/2021/03/09/spring/spring%20boot%E6%BA%90%E7%A0%81%E5%8F%8A%E6%B5%81%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="为什么用springboot"><a href="#为什么用springboot" class="headerlink" title="为什么用springboot?"></a>为什么用springboot?</h1><p>springboot是一个脚手架项目，提供了自动装配的功能，不用像以前一样自己去找少哪个包，配置复杂问题，现在只要引入对应的starter，修改yml就可以添加对应的功能。</p><h1 id="SpringBoot自动配置原理："><a href="#SpringBoot自动配置原理：" class="headerlink" title="SpringBoot自动配置原理："></a>SpringBoot自动配置原理：</h1><p>1、@EnableAutoConfiguration这个注解会”猜”你将如何配置spring，前提是你已经添加了jar依赖项，如果spring-boot-starter-web已经添加Tomcat和SpringMVC，这个注释就会自动假设您在开发一个web应用程序并添加相应的spring配置，会自动去maven中读取每个starter中的spring.factories文件，该文件里配置了所有需要被创建spring容器中bean<br>2、在main方法中加上@SpringBootApplication和@EnableAutoConfiguration<br>SpringBoot starter工作原理：<br>1、SpringBoot在启动时扫描项目依赖的jar包，寻找包含spring.factories文件的jar<br>2、根据spring.factories配置加载AutoConfigure<br>3、根据@Conditional注解的条件，进行自动配置并将bean注入到Spring Context</p><h1 id="如何找到spring-factories文件并初始化其中的类"><a href="#如何找到spring-factories文件并初始化其中的类" class="headerlink" title="如何找到spring.factories文件并初始化其中的类"></a>如何找到spring.factories文件并初始化其中的类</h1><figure class="highlight mel"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><pre><code class="hljs mel">getSpringFactoriesInstances方法<br>SpringFactoriesLoader.loadFactoryNames方法从<span class="hljs-keyword">spring</span>.factories文件中获取全路径名<br>createSpringFactoriesInstances 实例化这些类<br>AnnotationAwareOrderComparator.<span class="hljs-keyword">sort</span> 排序<br></code></pre></td></tr></table></figure><h1 id="spring-boot-启动流程（带devtools）："><a href="#spring-boot-启动流程（带devtools）：" class="headerlink" title="spring boot 启动流程（带devtools）："></a>spring boot 启动流程（带devtools）：</h1><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-number">1.</span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SpringApplication</span>.</span></span>run(xx.<span class="hljs-keyword">class</span>, args);<br><span class="hljs-number">2.</span>加载listener,这个listener中包含了RestartApplicationListener（devtools包的spring.factories）<br>set<span class="hljs-constructor">Listeners((Collection)</span> get<span class="hljs-constructor">SpringFactoriesInstances(ApplicationListener.<span class="hljs-params">class</span>)</span>);<br><span class="hljs-number">3.</span>监听器执行，发送应该开始启动事件<br>listener.starting<span class="hljs-literal">()</span>;<br><span class="hljs-number">4.</span>RestartApplicationListener的方法就可以收到事件。<br>public void on<span class="hljs-constructor">ApplicationEvent(ApplicationEvent <span class="hljs-params">event</span>)</span><br><span class="hljs-number">5.</span>Restarter的初始化（单例的）<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Restarter</span>.</span></span>initialize(args, <span class="hljs-literal">false</span>, <span class="hljs-keyword">initializer</span>, restartOnInitialize);<br><br><span class="hljs-number">6.</span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Restarter</span>.</span></span>initialize(restartOnInitialize)的执行<br><br><span class="hljs-number">7.</span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Restarter</span>.</span></span>immediate<span class="hljs-constructor">Restart()</span>的执行<br><span class="hljs-number">8.</span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LeakSafeThread</span>.</span></span>call<span class="hljs-constructor">AndWait()</span>，这里是个线程，打断点需要用线程断点，启动线程并让主线程等待.这里入参是个匿名类<br><span class="hljs-number">9.</span>执行<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Restarter</span>.</span></span><span class="hljs-keyword">do</span><span class="hljs-constructor">Start()</span>至<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Restarter</span>.</span></span>relaunch<span class="hljs-literal">()</span>方法<br><span class="hljs-number">10.</span>创建RestartLauncher，这是个线程，看run方法，里面是执行的xx.<span class="hljs-keyword">class</span>的run方法<br><span class="hljs-number">11.</span>重复以上步骤，执行至Restarter的初始化，这时localInstance是空，所以不会死循环<br><span class="hljs-number">12.</span>这时候就扫行到<br>ApplicationArguments applicationArguments = <span class="hljs-keyword">new</span> <span class="hljs-constructor">DefaultApplicationArguments(<span class="hljs-params">args</span>)</span>;<br><span class="hljs-number">13.</span>根据webApplicationType=SERVLET实例化<br>org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext<br><span class="hljs-number">14.</span>因为main方法中传入了启动类，<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SpringApplication</span>.</span></span>get<span class="hljs-constructor">AllSources()</span>方法，相当于配置文件xml<br><span class="hljs-number">15.</span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SpringApplication</span>.</span></span>load(ApplicationContext context, Object<span class="hljs-literal">[]</span> sources)<br><span class="hljs-number">16.</span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SpringApplication</span>.</span></span>get<span class="hljs-constructor">BeanDefinitionRegistry(ApplicationContext <span class="hljs-params">context</span>)</span><br><span class="hljs-number">17.</span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">BeanDefinitionLoader</span>.</span></span>load<span class="hljs-literal">()</span>方法 加载启动类到容器<br><span class="hljs-number">18.</span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">BeanDefinitionLoader</span>.</span></span>isComponent方法，判断这个资源是否带有component注解<br><span class="hljs-number">19.</span>一路下来最终会调用refresh<span class="hljs-literal">()</span>方法<br><span class="hljs-number">20.</span>调用invoke<span class="hljs-constructor">BeanFactoryPostProcessors()</span>执行BenFactoryPostProcessors<br><span class="hljs-number">21.</span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConfigurationClassParser</span>.</span></span>process<span class="hljs-constructor">ConfigurationClass()</span><br><span class="hljs-number">22.</span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConfigurationClassParser</span>.</span></span><span class="hljs-keyword">do</span><span class="hljs-constructor">ProcessConfigurationClass()</span>方法，根据启动类查找所有bean，<br>如果这些类里还有配置类，则会递归一直找全所有的bean,这里会转成bean的对象beanDefinition<br><span class="hljs-number">23.</span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConfigurationClassParser</span>.</span></span>collect<span class="hljs-constructor">Imports()</span>递归获取注解import,注解上标有两个类<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AutoConfigurationImportSelector</span>.</span></span><span class="hljs-keyword">class</span>、<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AutoConfigurationPackages</span>.</span><span class="hljs-module"><span class="hljs-identifier">Registrar</span>.</span></span><span class="hljs-keyword">class</span><br>AutoConfigurationImportSelector为自动装配的处理类<br><br><br><span class="hljs-number">24.</span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConfigurationClassParser</span>.</span></span>get<span class="hljs-constructor">Imports()</span><br><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DeferredImportSelectorGroupingHandler</span>.</span></span>process<span class="hljs-constructor">GroupImports()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DeferredImportSelectorGrouping</span>.</span></span>get<span class="hljs-constructor">Imports()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AutoConfigurationImportSelector</span>.</span></span>process<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AutoConfigurationImportSelector</span>.</span></span>get<span class="hljs-constructor">AutoConfigurationMetadata()</span>  <br>这里获取到<br> <br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AutoConfigurationImportSelector</span>.</span></span>get<span class="hljs-constructor">AutoConfigurationEntry()</span>  <br>这里获取到所有<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">EnableAutoConfiguration</span>.</span></span><span class="hljs-keyword">class</span>的AutoConfiguration类<br> <br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AutoConfigurationImportSelector</span>.</span></span>get<span class="hljs-constructor">SpringFactoriesLoaderFactoryClass()</span><br>得到<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">EnableAutoConfiguration</span>.</span></span><span class="hljs-keyword">class</span><br> <br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AutoConfigurationImportSelector</span>.</span></span>filter<span class="hljs-literal">()</span>方法会过滤不存在的自动装配类<br></code></pre></td></tr></table></figure><h1 id="spring-boot-自动装配"><a href="#spring-boot-自动装配" class="headerlink" title="spring boot 自动装配"></a>spring boot 自动装配</h1><p>1.load启动类（run方法传入的class）<br>2.根据启动类找到启动类上的注解import的AutoConfigurationImportSelector<br>3.获取到所有的自动装配类</p><h1 id="spring-boot-mvc模块自动装配"><a href="#spring-boot-mvc模块自动装配" class="headerlink" title="spring boot mvc模块自动装配"></a>spring boot mvc模块自动装配</h1><p>1.DispatcherServletAutoConfiguration 自动装配类加载<br>2.初始化DispatcherServlet<br>3.客户端发送请求后，httpServlet中init方法，直到 dispatcherServlet中initStrategies</p>]]></content>
    
    
    <categories>
      
      <category>spring boot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring boot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring mvc源码流程</title>
    <link href="/2021/03/09/spring/spring%20mvc%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B/"/>
    <url>/2021/03/09/spring/spring%20mvc%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="spring-mvc扫行流程"><a href="#spring-mvc扫行流程" class="headerlink" title="spring mvc扫行流程"></a>spring mvc扫行流程</h1><p>1.客户端请求调用dispatcherServlet的doService-&gt;doDispatch方法</p><p>2.从handlerMapping中获取处理请求的handler</p><p>3.根据handler获取handlerAdapter(这个adapter会根据不同类型和实现执行handler方法)</p><p>4.handlerAdapter执行后会返回ModelAndView对象</p><p>5.根据modelAndView获取具体的ViewResolver(视图解析器)</p><p>6.根据viewResolver和model来渲染view</p><p>7.dispatcherServlet把渲染结果返回给客户端</p>]]></content>
    
    
    <categories>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>viscual studio code使用</title>
    <link href="/2021/03/08/%E5%89%8D%E7%AB%AF/visual%20studio%20code%E4%BD%BF%E7%94%A8/"/>
    <url>/2021/03/08/%E5%89%8D%E7%AB%AF/visual%20studio%20code%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="1-安装viscual-studio-code及插件"><a href="#1-安装viscual-studio-code及插件" class="headerlink" title="1.安装viscual studio code及插件"></a>1.安装viscual studio code及插件</h2><p>插件：Chinese (Simplified) Language Pack for Visual Studio Code</p><p>插件：open in browser  (alt + B 可以在默认浏览器打开你写的页面)</p><h2 id="2-快捷键"><a href="#2-快捷键" class="headerlink" title="2.快捷键"></a>2.快捷键</h2><p>向下复制当前行：shift + Alt + ↓</p><p>撤回：ctrl+Z</p><p>取消撤回：ctrl+shift+Z</p><h2 id="3-快捷操作"><a href="#3-快捷操作" class="headerlink" title="3.快捷操作"></a>3.快捷操作</h2><p>lorem (乱数假文) (Emment Lorem插件)  ： lorem生成数量  例如 lorem5生成5个假文</p><p>$代表变量   {} 代表内容     h$*6{$标题}   生成h1~h6,并填充内容</p>]]></content>
    
    
    <categories>
      
      <category>编辑器</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>编辑器</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>html+css练习</title>
    <link href="/2021/03/07/%E5%89%8D%E7%AB%AF/html+css%E7%BB%83%E4%B9%A0/"/>
    <url>/2021/03/07/%E5%89%8D%E7%AB%AF/html+css%E7%BB%83%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h2 id="1-采购单练习-table-css"><a href="#1-采购单练习-table-css" class="headerlink" title="1.采购单练习(table + css)"></a>1.采购单练习(table + css)</h2><h2 id="2-分析页面的基本构造及缩写代码的基本思路"><a href="#2-分析页面的基本构造及缩写代码的基本思路" class="headerlink" title="2.分析页面的基本构造及缩写代码的基本思路"></a>2.分析页面的基本构造及缩写代码的基本思路</h2><p>真实项目开发</p><p>​借助UI框架快速开发</p><p>勿忘初心</p><p>​不要丧失了书写原生的css和html的能力</p><p>页面分成3个部分</p><p>​头部</p><p>​页面主体部分(版心)</p><p>​底部</p><h2 id="3-首页布局实现及图标库的使用"><a href="#3-首页布局实现及图标库的使用" class="headerlink" title="3.首页布局实现及图标库的使用"></a>3.首页布局实现及图标库的使用</h2><p>iconfont 图标库的使用</p><p>​注册账号</p><p>​搜索喜欢的图标</p><p>​加入购物车-》加入项目</p><p>​在图标管理里选择我的项目</p><p>​生成在线链接</p><p>​引入对应的css</p><p>​复制图标的代码</p><p>​添加iconfont和复制的类名</p><figure class="highlight html"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><pre><code class="hljs html">iconfont 必须要写 icon-icon-test1是你复制的图标的代码 <br><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;iconfont icon-icon-test1&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><br></code></pre></td></tr></table></figure><p>布局：</p><p>​头部</p><p>​中间部分-》主体部分</p><p>​底部</p><h2 id="4-导航栏-公共"><a href="#4-导航栏-公共" class="headerlink" title="4.导航栏(公共)"></a>4.导航栏(公共)</h2><p>logo + 横向菜单 + 搜索框 + 用户注册&#x2F;登录</p><h2 id="5-轮播图"><a href="#5-轮播图" class="headerlink" title="5.轮播图"></a>5.轮播图</h2><h2 id="6-课程列表"><a href="#6-课程列表" class="headerlink" title="6.课程列表"></a>6.课程列表</h2><h2 id="7-底部-公共"><a href="#7-底部-公共" class="headerlink" title="7.底部(公共)"></a>7.底部(公共)</h2><h2 id="8-学习规划"><a href="#8-学习规划" class="headerlink" title="8.学习规划"></a>8.学习规划</h2><p>项目开发过程</p><p>​先分析一个布局，分块细一点</p><p>​写对应的注释</p><p>​考虑周全一点</p><p>项目遇到的问题</p><p>​布局乱了怎么办</p><p>​检查其他盒子的高度是否影响了</p><p>​块级元素里包了张图片的时候会有一个间距</p><p>​font-size: 0</p><p>​换着思路实现问题，比如我们的伪类来实现布局</p><p>学会iconfont使用</p><p>未来规划</p><p>​1.html + css (最基本的)</p><p>​2.js(跟网页交互使用的)</p><p>​vue.js</p><p>​react.js</p><p>​3.项目的构建</p><p>​git(代码管理工具)</p><p>​webpack(打包工具，打包资源代码)</p><p>​4.后端</p><p>​node.js(多了操作数据库的api)</p><p>​5.学习技巧</p><p>​只有当你的实际练习(写代码)大大于你的理论学习时间，你才会有进步</p><p>​锻炼下自已独立学习能力(必须学会看懂编辑器的提示，学会翻译)</p><p>​多多看mdn文档，博文只能参考</p>]]></content>
    
    
    <categories>
      
      <category>html+css入门</category>
      
    </categories>
    
    
    <tags>
      
      <tag>css</tag>
      
      <tag>html</tag>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>html初学</title>
    <link href="/2021/03/07/%E5%89%8D%E7%AB%AF/html%E5%88%9D%E5%AD%A6/"/>
    <url>/2021/03/07/%E5%89%8D%E7%AB%AF/html%E5%88%9D%E5%AD%A6/</url>
    
    <content type="html"><![CDATA[<h2 id="1-目标"><a href="#1-目标" class="headerlink" title="1.目标"></a>1.目标</h2><p>分析网页的基本组成</p><p>独立开发一个静态网页</p><h2 id="2-html和css在网页中扮演的角色"><a href="#2-html和css在网页中扮演的角色" class="headerlink" title="2. html和css在网页中扮演的角色"></a>2. html和css在网页中扮演的角色</h2><p>网页的基本构成：html + css + javaScript</p><p>html在网页中的作用：定义页面结构，定义有什么</p><p>css在网页中的作用：修饰页面结构和样式</p><p>javaScript在网页中的作用：定义一些网页中的交互</p><p>怎么执行html和css的代码：浏览器执行</p><p>浏览器：外壳 +内核</p><p>有独立内核的浏览器：IE(trident)、chrome(webkit&#x2F;blink)、sarari(webkit)、firefox(gecko)、opera(presto&#x2F;blink)</p><h2 id="3-开发环境"><a href="#3-开发环境" class="headerlink" title="3.开发环境"></a>3.开发环境</h2><p>vscode</p><h2 id="4-术语"><a href="#4-术语" class="headerlink" title="4.术语"></a>4.术语</h2><p>web:互联网，用户看到的页面</p><p>w3c:万维网联盟(非营利性组织)、制定web技术领域标准的组织</p><p>MDN：mozilla development network (开发者社区)</p><h2 id="5-html语法"><a href="#5-html语法" class="headerlink" title="5.html语法"></a>5.html语法</h2><p>html中的最小单位：element(元素、标签)</p><p>元素由哪几部分组成：起始标签(begin tag) + 元素内容(可选) + 元素属性(可选部分) + 结束标签(end tag)</p><p>元素属性：全局属性 + 局部属性(某个元素特有的属性)</p><p>注释：描述你的代码的作用</p><h2 id="6-html中的语义化"><a href="#6-html中的语义化" class="headerlink" title="6.html中的语义化"></a>6.html中的语义化</h2><p>什么是语义化：每个html元素都有其具体的含义(标题、段落、超链接、图片)</p><p>为什么需要语义化：</p><p>​利于seo(搜索引擎优化)(每隔一段时间，搜索引擎会在互联网中抓取页面的源代码)</p><p>​方便浏览器去理解网页的结构(解释)</p><h2 id="7-html中的文本元素"><a href="#7-html中的文本元素" class="headerlink" title="7.html中的文本元素"></a>7.html中的文本元素</h2><p>标题元素: h1~ h6</p><p>段落元素：p</p><p>span元素：没有任何语义；仅作为设置样式使用</p><p>pre元素(预格式化文本元素)：空白折叠(源代码中连续的空白字符(空格、换行、制表(tab缩进)))会被折叠成一个空格</p><h2 id="8-a元素常见的使用方式"><a href="#8-a元素常见的使用方式" class="headerlink" title="8.a元素常见的使用方式"></a>8.a元素常见的使用方式</h2><p>作用：</p><p>​超链接：从这个页面跳转到另一个页面的路径</p><p>​锚点：用于跳转到页面的指定位置</p><h2 id="9-如何书写一个正确的路径"><a href="#9-如何书写一个正确的路径" class="headerlink" title="9.如何书写一个正确的路径"></a>9.如何书写一个正确的路径</h2><p>路径：</p><p>​根据资源的类型判断，一般站外资源用绝对路径，站内资源用相对路径</p><p>绝对路径：</p><p>​书写格式：协议名:&#x2F;&#x2F;主机名:端口&#x2F;路径</p><p>​中文会被编码成unicode格式</p><p>​协议：http、https、file</p><p>​主机名：域名、IP地址</p><p>​端口：http会省略80、https会省略443</p><p>​<a href="https://www.baidu.com/">https://www.baidu.com</a></p><p>​file:&#x2F;&#x2F;Users&#x2F;aa&#x2F;Documents&#x2F;\u4f60\u597d\u4e16\u754c.html</p><p>相对路径：</p><p>​.&#x2F; 代表当前目录</p><p>​..&#x2F;代表上一级目录</p><h2 id="10-img标签及常见属性"><a href="#10-img标签及常见属性" class="headerlink" title="10.img标签及常见属性"></a>10.img标签及常见属性</h2><p>常用属性</p><p>​src : 图片路径</p><p>​alt: 图片加载失败或加载时显示的文字</p><p>​title: 悬浮在图片上面显示的文字</p><p>图片的来源：</p><p>​本地图片：稳定</p><p>​线上图片：图片容易丢失</p><p>​base64图片：</p><p>​优点：小图片占用内存小，不请求服务器，降低服务器资源与访问</p><p>​缺点：大图片增大了数据库服务器的压力。</p><p>点击图片跳转</p><p>​通过嵌套a标签</p><h2 id="11-html中的列表元素"><a href="#11-html中的列表元素" class="headerlink" title="11. html中的列表元素"></a>11. html中的列表元素</h2><p>列表：</p><p>​有序列表(order list)</p><figure class="highlight html"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span>  <br></code></pre></td></tr></table></figure><p>​无序列表(unorder list)</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br></code></pre></td></tr></table></figure><p>​定义列表(defined list)</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">dl</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dt</span>&gt;</span>人<span class="hljs-tag">&lt;/<span class="hljs-name">dt</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span>一种动物<span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dl</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="12-html中用于布局的元素"><a href="#12-html中用于布局的元素" class="headerlink" title="12.html中用于布局的元素"></a>12.html中用于布局的元素</h2><p>没有任何语义，纯粹是用于布局的元素</p><p>html 4 : div</p><p>html 5: header footer article …</p><h2 id="13-html表格元素"><a href="#13-html表格元素" class="headerlink" title="13.html表格元素"></a>13.html表格元素</h2><p>表格的基本结构</p><p>​由一行或者多行的单元格数据组成</p><p>在html中怎么表示：</p><p>​table表示表格元素</p><p>​tr表示一行行的数据</p><p>​th表示数据中的表头部分</p><p>​td表示的正常的数据</p><p>对表格数据进行分组</p><p>​thead元素包着表头部分</p><p>​tbody包着表格数据部分</p><p>​tfoot包着表格尾部部分</p><p>table元素里常用的属性</p><p>​border(边框)</p><p>​cellspacing(单元格间距)</p><p>​cellpadding(单元格)</p><p>​colspan(用于合并列)</p><p>​rowspan(用于合并行)</p><h2 id="14-表单元素"><a href="#14-表单元素" class="headerlink" title="14.表单元素"></a>14.表单元素</h2><p>使用场景：</p><p>​需要提交一些信息到服务端的时候(前后端联调过程中)</p><p>核心元素：</p><p>​input(核心元素)</p><p>​label(提高交互体验的)</p><p>​select(下拉框)</p><p>​textarea(文本域)</p><p>​button(按钮)</p><p>​form</p>]]></content>
    
    
    <categories>
      
      <category>html入门</category>
      
    </categories>
    
    
    <tags>
      
      <tag>html</tag>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>css初学</title>
    <link href="/2021/03/07/%E5%89%8D%E7%AB%AF/css%E5%88%9D%E5%AD%A6/"/>
    <url>/2021/03/07/%E5%89%8D%E7%AB%AF/css%E5%88%9D%E5%AD%A6/</url>
    
    <content type="html"><![CDATA[<h2 id="1-css-基本规则"><a href="#1-css-基本规则" class="headerlink" title="1.css 基本规则"></a>1.css 基本规则</h2><p>css全称：层叠样式表(Cascading Style Sheets)</p><p>选择器：告诉浏览器要设置样式的html元素</p><p>声明块：用于设置样式</p><p>viewport：移动设备上的viewport就是设备的屏幕上能用来显示我们的网页的那一块区域，开发移动端页面时一定要加上</p><h2 id="2-css的几种写法及推荐写法"><a href="#2-css的几种写法及推荐写法" class="headerlink" title="2.css的几种写法及推荐写法"></a>2.css的几种写法及推荐写法</h2><p>写法：</p><p>​内部样式表：写在style标签里面的</p><p>​内联样式表：写在元素的style属性里面的</p><p>​外部样式表：link标签将css资源引入</p><p>推荐外部样式表：</p><p>​解决页面当中样式重复的问题</p><p>​代码分离，利于代码维护和阅读</p><p>​浏览器会缓存起来，提高页面响应速度(不用重新去服务器获取)</p><h2 id="3-常见的选择器及使用场景"><a href="#3-常见的选择器及使用场景" class="headerlink" title="3.常见的选择器及使用场景"></a>3.常见的选择器及使用场景</h2><p>必须掌握的选择器</p><p>​元素(标签)选择器 h1{color:red;}</p><p>​类选择器 className {color:red;}</p><p>​id选择器(javaScript)   idName {color:red;}</p><p>开发过程中常用的选择器</p><p>​通配符选择器 *</p><p>​派生选择器：</p><p>​根据文档dom结构来选择html元素</p><p>​后代选择器  h1 p {color:red;}</p><p>​子元素选择器(mdn搜索)div&gt;span{font-size:900}</p><p>​相邻选择器 h1+p{backgroud-color:pink;}</p><h2 id="4-特殊的选择器"><a href="#4-特殊的选择器" class="headerlink" title="4.特殊的选择器"></a>4.特殊的选择器</h2><p>特殊的选择器</p><p>​伪类选择器</p><p>​选中一些元素的特殊效果</p><p>​在某些场景选中有关系元素</p><figure class="highlight css"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><pre><code class="hljs css"> <span class="hljs-comment">/* 需要注意顺序 */</span><br><span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:link</span> &#123;<span class="hljs-attribute">color</span>:<span class="hljs-number">#FF0000</span>;&#125; <span class="hljs-comment">/* 未访问的链接 */</span> <br><span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:visited</span> &#123;<span class="hljs-attribute">color</span>:<span class="hljs-number">#00FF00</span>;&#125; <span class="hljs-comment">/* 已访问的链接 */</span> <br><span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:hover</span> &#123;<span class="hljs-attribute">color</span>:<span class="hljs-number">#FF00FF</span>;&#125; <span class="hljs-comment">/* ⿏鼠标悬浮后的链接 */</span> <br><span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:active</span> &#123;<span class="hljs-attribute">color</span>:<span class="hljs-number">#0000FF</span>;&#125; <span class="hljs-comment">/* 已选中的链接 */</span><br><br><span class="hljs-comment">/* 某些情况下好⽤用的伪类选择器器 */</span> <br>元素<span class="hljs-selector-pseudo">:first</span>-child &#123;&#125; <br>元素<span class="hljs-selector-pseudo">:last-child</span> &#123;&#125; <br>元素<span class="hljs-selector-pseudo">:nth-child</span>(n) &#123;&#125;<br></code></pre></td></tr></table></figure><h2 id="5-css盒子模型"><a href="#5-css盒子模型" class="headerlink" title="5.css盒子模型"></a>5.css盒子模型</h2><p>什么是盒子模型</p><p>在css里面，所有的html元素你都可以看成是一个盒子</p><p>具体可以分成如图：</p><p><img src="data:image/png;base64,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" alt="css盒子模型"></p><p>由以下部分组成</p><p>​盒子和盒子之间的间隙(margin)</p><p>​盒子的边框(border)</p><p>​盒子的内部间隙(padding)</p><p>​盒子的内容(content)</p><p>盒子怪异模型</p><p>​w3c标准的盒子模型(标准盒模型)</p><p>​boxWidth&#x3D;contentWidth</p><p>​ie标准的盒子模型(怪异盒模型)</p><p>​box-sizing:border-box &#x2F;&#x2F; 声明</p><p>​boxWidth&#x3D;contentWidth+border+padding</p><p>外边距折叠：</p><p>​上下两个兄弟盒子的margin都为正取大，都为负取小，一正一负相加</p><p>​父子元素盒子的margin（假设没有内边距或边框把外边距分隔开），也会合并;只有普通文档流中块框的垂直外边距才会发生外边距合并。行内框、浮动框或绝对定位之间的外边距不会合并</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs css">解决父子边距合并：<br>父元素&#123;<br>  <span class="hljs-attribute">overflow</span>:auto;<br>&#125;<br><br>父元素<span class="hljs-selector-pseudo">::before</span>&#123;<br>  <span class="hljs-attribute">display</span>: table;<br>  <span class="hljs-attribute">content</span>: <span class="hljs-string">&quot;&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="6-css的常用属性"><a href="#6-css的常用属性" class="headerlink" title="6.css的常用属性"></a>6.css的常用属性</h2><p>常用属性</p><p>​盒子的位置和大小</p><p>​尺寸：</p><p>​宽度：width:长度 | 百分比 | auto</p><p>​高度：height</p><p>​边界：margin padding  上右下左  || 上下  左右</p><p>​布局：</p><p>​浮动：float </p><p>​定位: position</p><p>​弹性布局：flex</p><p>​盒子内容超出部分： overflow : hidden || scroll || auto</p><p>​外观，风格：</p><p>​background: 背景颜色  || 背景图像 || 背景重复 || 背景不要固定 || 背景位置</p><p>​background-color</p><p>​文字属性</p><p>​字体大小： font-size</p><p>​是否加粗： font-weight</p><p>​是不是斜体：font-style</p><p>​字体是什么：font-family</p><p>​合并成一个属性：font</p><h2 id="7-特性：层叠"><a href="#7-特性：层叠" class="headerlink" title="7.特性：层叠"></a>7.特性：层叠</h2><p>层叠是一个基本特征</p><p>​一个css属性被多次声明的时候，会根据优先级或者声明顺序来计算采用哪个样式</p><p>优先级是怎么计算</p><p>​!important &gt; 行内样式 &gt; id &gt; class &gt; tag &gt; 通配符</p><p>​标签选择器 1</p><p>​类选择器 10</p><p>​id 选择器 100</p><p>​通配符选择器和表示关系的选择器，对优先级没有影响</p><p>例外规则</p><p>​!important</p><p>​注意的：</p><p>​不利于代码的维护</p><p>​建议不要在自己的局部代码(公用代码)里使用important</p><p>​可以在引入外部css,覆盖他本身的代码时，就可以用</p><h2 id="8-css中什么是继承及常见的可继承的属性"><a href="#8-css中什么是继承及常见的可继承的属性" class="headerlink" title="8.css中什么是继承及常见的可继承的属性"></a>8.css中什么是继承及常见的可继承的属性</h2><p>什么是继承</p><p>​当前的元素你不设置某些属性的时候，展示出来的样子(继承了父元素的某些属性)</p><p>默认设置继承的属性</p><p>​记住一句话：</p><p>​颜色、文字、字体间距行高、对齐方式、列表的样式</p><h2 id="9-css中元素的分类和布局前置知识"><a href="#9-css中元素的分类和布局前置知识" class="headerlink" title="9.css中元素的分类和布局前置知识"></a>9.css中元素的分类和布局前置知识</h2><p>元素的分类</p><p>​块级元素 </p><h1>, <p>, <ul>, <table>,<div></div></table></ul></p><p>​自已点满一行，就算宽度变小，也是独立成行</p><p>​可修改宽高属性</p><p>​行内元素： <b>, <td>, <a>, <img>,<span></span></a></td></b></p><p>​写在块级元素里面</p><p>​可跟其他行内元素并行显示</p><p>​不能修改宽高</p><p>正常元素怎么布局</p><p>​默认：一个块级元素的内容宽度就是其父元素的100%,他的高度和其内容高度一致</p><p>​行内元素它的宽度和高度都是根据内容决定的(无法设置行内元素的宽高)：</p><p>​可设置display属性，定义元素的类型(css3定义布局)</p><p>元素之间又是如何相互影响的呢：</p><p>​正常的文档布局流：</p><p>​每个块级元素会在上个元素下面另起一行</p><p>​行内元素不会另起一行</p><h2 id="10-CSS-浮动"><a href="#10-CSS-浮动" class="headerlink" title="10.CSS 浮动"></a>10.CSS 浮动</h2><p>什么是浮动</p><p>​一种布局方式，最初是为了文字能够围绕在图片周围而引入</p><p>为什么引入</p><p>​常规的布局过于死板，引入float属性来实现更丰富的布局</p><p>万物皆可浮动</p><p>​浮动的元素会并行显示</p><p>​浮动的元素脱离正常的文档布局流</p><p>​文本会围绕在它身边</p><p>使用</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-attribute">float</span>: none; //默认值，元素不浮动<br><span class="hljs-attribute">float</span>: left; //元素向左浮动<br><span class="hljs-attribute">float</span>: right; //元素向右浮动<br></code></pre></td></tr></table></figure><p>特点：</p><p>​浮动元素会脱离文档流，不再占据文档流空间</p><p>​浮动元素彼此之间是从左往右排列，宽度超过一行自动换行</p><p>​在浮动元素前面元素不浮动时，浮动元素无法上移</p><p>​块级元素和行内元素浮动之后都变成行内块级元素</p><p>​浮动元素不会盖住文字，可以设置文字环绕效果</p><p>浮动带来的问题</p><p>​影响其他元素的布局</p><p>如何解决：</p><p>​清除浮动：</p><p>​利用clear属性</p><p>​在最后一个浮动元素后加入一个带有clear:both属性的空元素</p><p>​通过伪类选择器，利用:after伪元素在元素末尾添加一个内容并带有clear:both属性来实现的（伪元素可以想成是元素的子级，before就是第一个子元素，after是最后一个）</p><p>​生成BFC(块级上下文)</p><p>​将浮动元素的父级的高度固定</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-attribute">clear</span>:both;<br><span class="hljs-attribute">content</span>:<span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-attribute">display</span>:block;<br></code></pre></td></tr></table></figure><h2 id="10-flex布局"><a href="#10-flex布局" class="headerlink" title="10.flex布局"></a>10.flex布局</h2><p>flex布局(弹性布局)  css3</p><p>父元素容器的属性：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/*设为flex布局以后，子元素的float、clear和vertical-align属性将失效。*/</span><br><span class="hljs-attribute">display</span>:flex;<br><span class="hljs-comment">/*决定主轴的方向(即项目的排列方向)*/</span><br><span class="hljs-attribute">flex-direction</span>: row | row-reverse | cloumn | cloumn-reverse;<br><span class="hljs-comment">/* 是否换行 */</span><br><span class="hljs-attribute">flex-wrap</span>: nowrap | wrap | wrap-reverse<br><span class="hljs-comment">/* 定义水平方向对齐方式 */</span><br>justify-content: flex-start | flex-end | center | space-between | space-around;<br><span class="hljs-comment">/* 定义垂直方向对齐方式 */</span><br><span class="hljs-attribute">align-items</span>: flex-start | flex-end | center | baseline | stretch;<br><span class="hljs-comment">/* 定义多个轴线(多行/多列)对齐方式 */</span><br><span class="hljs-attribute">align-content</span>: flex-start | flex-end | center | space-between | space-around | stretch;<br><br></code></pre></td></tr></table></figure><p>子元素容器的属性：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* 定义子元素的排列顺序，默认为0 */</span><br><span class="hljs-attribute">order</span>: -<span class="hljs-number">10</span> | -<span class="hljs-number">1</span> | <span class="hljs-number">0</span> | <span class="hljs-number">1</span> | <span class="hljs-number">10</span>;<br><span class="hljs-comment">/* 定义子元素的放大比例，默认为0 */</span><br><span class="hljs-attribute">flex-grow</span>: <span class="hljs-number">0</span> | <span class="hljs-number">1</span> | <span class="hljs-number">2</span> | <span class="hljs-number">3</span>;<br><span class="hljs-comment">/* 定义子元素的缩小比例，默认为1 */</span><br><span class="hljs-attribute">flex-shrink</span>: <span class="hljs-number">0</span> | <span class="hljs-number">1</span>;<br><span class="hljs-comment">/* 定义了在分配多余空间之前，项目占据的主轴空间*/</span><br><span class="hljs-attribute">flex-basis</span>: &lt;length&gt; | auto;<br><span class="hljs-comment">/* flex-grow, flex-shrink 和 flex-basis的简写 */</span><br><span class="hljs-attribute">flex</span>: <span class="hljs-number">0</span> <span class="hljs-number">1</span> auto;<br></code></pre></td></tr></table></figure><p>兼容性：浏览器ie9及以上</p><p>推荐是使用flex布局：flex布局易用，布局全面</p><h2 id="11-定位"><a href="#11-定位" class="headerlink" title="11.定位"></a>11.定位</h2><p>也是为布局引入的属性</p><p>position常用的几个值</p><p>​子绝父相</p><p>​static(静态定位)</p><p>​relative(相对绝对)</p><p>​absolute(绝对定位)</p><p>​fixed(固定定位)</p><p>​sticky(粘性定位)</p><p>相关的属性：</p><p>​z-index:</p><p>​使用场景：当定位的盒子重叠在一起</p><h2 id="12-三栏布局如何实现"><a href="#12-三栏布局如何实现" class="headerlink" title="12.三栏布局如何实现"></a>12.三栏布局如何实现</h2><p>问题：高度固定，左右两侧的盒子宽度为200px,中间自适应</p><p>答案：</p><p>​浮动实现</p><p>​定位实现</p><p>​flex实现</p><h2 id="13-水平垂直居中"><a href="#13-水平垂直居中" class="headerlink" title="13.水平垂直居中"></a>13.水平垂直居中</h2><p>如何使用css实现水平垂直居中</p><p>​行内元素：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-number">1</span>. <span class="hljs-attribute">line-height</span><br><span class="hljs-attribute">text-align</span>: center;<br><span class="hljs-number">2</span>. <span class="hljs-attribute">display</span>: flex;<br><span class="hljs-attribute">justify-content</span>: center;<br><span class="hljs-attribute">align-items</span>: center;<br></code></pre></td></tr></table></figure><p>​块级元素：</p><p>​定位：</p><p>​知道宽高(margin + 自身元素具体宽高&#x2F;2) + top</p><p>​知道宽高(margin + 自身元素具体宽高&#x2F;2) + left 50%</p><p>​不知道宽高借助css3的translate属性</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-number">1</span>. <span class="hljs-attribute">position</span> + <span class="hljs-attribute">margin</span> 清楚子元素的宽高<br><span class="hljs-number">2</span>. <span class="hljs-attribute">position</span> + <span class="hljs-attribute">transform</span> 不清楚子元素的宽高<br><span class="hljs-number">3</span>. <span class="hljs-attribute">flex</span><br><span class="hljs-number">4</span>. <span class="hljs-selector-tag">table</span>-cell 兼容性较差<br></code></pre></td></tr></table></figure><h2 id="14-BFC"><a href="#14-BFC" class="headerlink" title="14.BFC"></a>14.BFC</h2><p>MDN解释：</p><p>​块格式化上下文(block formatting context, BFC) 是web页面的可视化css渲染的一部分，是块盒子的布局过程发生的区域，也是浮动元素与其他元素的区域</p><p>通俗的解释：</p><p>​形成一块封闭的区域，能检测到区域内脱离文档流的元素。</p><p>特点：</p><p>​css中隐含的属性，开启后不会被浮动元素覆盖</p><p>​bfc元素可以包含浮动元素</p><p>​bfc元素的子元素和父元素外边距不重叠</p><p>开启(都会有副作用)：</p><p>​设置元素浮动 float: left</p><p>​设置为行内块元素： display: inline-block</p><p>​overflow: hidden (推荐)</p><p>作用：</p><p>​清除浮动带来的影响</p><p>​解决边距塌陷问题(外边距折叠(margin collapsing)也只会发生在属于同一BFC的块级元素之间)</p><h2 id="15-reset-css"><a href="#15-reset-css" class="headerlink" title="15.reset.css"></a>15.reset.css</h2><p><a href="https://meyerweb.com/eric/tools/css/reset/">https://meyerweb.com/eric/tools/css/reset/</a></p><h2 id="16-css3常用属性"><a href="#16-css3常用属性" class="headerlink" title="16.css3常用属性"></a>16.css3常用属性</h2><p>css3边框：</p><p>圆角：border-radius</p><p>盒阴影：box-shadow</p><p>边界图片：border-image</p><p>css3渐变：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* 从上到下（默认情况下）*/</span><br><span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">#e66465</span>, <span class="hljs-number">#9198e5</span>);<br><span class="hljs-comment">/* 从左到右 */</span><br><span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">linear-gradient</span>(to right, red , yellow);<br><span class="hljs-comment">/* 对角 */</span><br><span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">linear-gradient</span>(to bottom right, red, yellow);<br><br><span class="hljs-comment">/*使用角度*/</span><br><span class="hljs-comment">/* 从上到下 */</span><br><span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">180deg</span>, red, yellow); <br><span class="hljs-comment">/* 从左到右 */</span><br><span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">90deg</span>, red, yellow);<br><br><span class="hljs-comment">/*多个颜色*/</span><br><span class="hljs-comment">/* 从上到下 */</span><br><span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">linear-gradient</span>(red, yellow, green);<br><span class="hljs-comment">/* 从左到右 */</span><br><span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">linear-gradient</span>(to right, red, orange, yellow);<br><br><span class="hljs-comment">/* 透明度 */</span><br><span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>), <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>));<br><span class="hljs-comment">/* 重复 */</span><br><span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">repeating-linear-gradient</span>(red, yellow <span class="hljs-number">10%</span>, green <span class="hljs-number">20%</span>);<br></code></pre></td></tr></table></figure><p>css3文本效果：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs css">文本阴影<br><span class="hljs-attribute">text-shadow</span>: <span class="hljs-number">5px</span> <span class="hljs-number">5px</span> <span class="hljs-number">5px</span> <span class="hljs-number">#FF0000</span>;<br><br>文本溢出<br><span class="hljs-comment">/* 超过1行省略/裁剪 */</span><br><span class="hljs-attribute">overflow</span>: hidden;<br><span class="hljs-attribute">white-space</span>: nowrap;<br><span class="hljs-attribute">text-overflow</span>: ellipsis | clip; <br><br><span class="hljs-comment">/* 超过2行省略/裁剪 */</span><br><span class="hljs-attribute">overflow</span>: hidden;<br><span class="hljs-attribute">text-overflow</span>: ellipsis;<br><span class="hljs-attribute">display</span>: -webkit-box;<br>-webkit-box-orient: vertical;<br>-webkit-line-clamp: <span class="hljs-number">2</span>;<br><br>文本换行<br>长文本换行<br><span class="hljs-attribute">word-wrap</span>:break-word;<br>单词拆分换行<br><span class="hljs-attribute">word-break</span>: break-all;<br></code></pre></td></tr></table></figure><h2 id="17-网络布局-grid"><a href="#17-网络布局-grid" class="headerlink" title="17.网络布局(grid)"></a>17.网络布局(grid)</h2><p>应用场景：flex布局、float布局应用于一维布局，网格布局应用于二维布局</p><p>父元素属性</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* 使用 */</span><br><span class="hljs-attribute">display</span>: grid;<br><span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">10px</span> <span class="hljs-number">10px</span> <span class="hljs-number">10px</span>;<br><span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-number">10px</span> <span class="hljs-number">10px</span> <span class="hljs-number">10px</span>;<br><br><span class="hljs-comment">/* 百分比使用 */</span><br><span class="hljs-attribute">display</span>: grid;<br><span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">33.33%</span> <span class="hljs-number">33.33%</span> <span class="hljs-number">33.33%</span>;<br><span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-number">33.33%</span> <span class="hljs-number">33.33%</span> <span class="hljs-number">33.33%</span>;<br><br><span class="hljs-comment">/* repeat()函数简化 */</span><br><span class="hljs-attribute">display</span>: grid;<br><span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">33.33%</span>);<br><span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">33.33%</span>);<br></code></pre></td></tr></table></figure><p>布局文章：</p><p><a href="http://www.woshipm.com/pd/644262.html">http://www.woshipm.com/pd/644262.html</a>  从产品角度看web布局</p><p><a href="https://blog.csdn.net/lyyo_cd/article/details/73329068">https://blog.csdn.net/lyyo_cd/article/details/73329068</a> web布局的几种方式</p><h2 id="18-开发流程"><a href="#18-开发流程" class="headerlink" title="18.开发流程"></a>18.开发流程</h2><p>需求评审-&gt;与ui对接设计图-&gt;开发页面-&gt;与后端程序员协调接口协议-&gt;接入接口数据联调-&gt;开发完成，提交测试环境，自测完成然后提测-&gt;解决bug-&gt;提交预发环境-&gt;产品，测试确认，与后端一起提交上线。</p></h1>]]></content>
    
    
    <categories>
      
      <category>css入门</category>
      
    </categories>
    
    
    <tags>
      
      <tag>css</tag>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>编译openjdk</title>
    <link href="/2021/02/08/java/%E7%BC%96%E8%AF%91openjdk/"/>
    <url>/2021/02/08/java/%E7%BC%96%E8%AF%91openjdk/</url>
    
    <content type="html"><![CDATA[<p><a href="http://blog.csdn.net/rongyongfeikai2/article/details/51137533">http://blog.csdn.net/rongyongfeikai2/article/details/51137533</a> CentOS7手动编译OpenJDK</p><p><a href="https://www.cnblogs.com/mr-long/p/5841604.html">https://www.cnblogs.com/mr-long/p/5841604.html</a></p><p><a href="https://www.cnblogs.com/ACFLOOD/p/5528035.html">https://www.cnblogs.com/ACFLOOD/p/5528035.html</a> openjdk安装</p><p><a href="http://blog.csdn.net/hl_java/article/details/76691321">http://blog.csdn.net/hl_java/article/details/76691321</a>  老司机手把手教你自己编译jdk</p><p><a href="http://blog.51cto.com/13266852/1962186">http://blog.51cto.com/13266852/1962186</a> 问题答案</p><p><a href="http://blog.csdn.net/u010349169/article/category/2620885">http://blog.csdn.net/u010349169/article/category/2620885</a> Java虚拟机原理图解</p><p><strong>环境：</strong></p><p>操作系统：CentOS Linux release 7.4.1708 (Core)</p><p>计划编译的jdk: openjdk7 jdk7u</p><p>Bootstrap JDK: java version “1.7.0_80”</p><p><strong>编译需要的软件：</strong></p><p>yum install -y mercurial<br>yum install -y libX11* libX*<br>yum install -y libXi-devel libXtst-devel libXt-devel freetype*<br>yum install -y alsa-lib-devel cups-devel<br>yum install -y gcc gcc-c++</p><p>yum install libstdc++-static  或者   yum install glibc-static libstdc++-static</p><p>安装ant 1.7.1以上</p><p>安装jdk1.7.0_80</p><p><strong>获取编译的源(openjdk7)</strong></p><p>hg clone <a href="http://hg.openjdk.java.net/jdk7u/jdk7u">http://hg.openjdk.java.net/jdk7u/jdk7u</a><br>cd jdk7u<br>chmod 755 get_source.sh<br>.&#x2F;get_source.sh</p><p>**配置环境变量<br>**</p><p>vi ~&#x2F;.bashrc</p><p>export LANG&#x3D;C<br>export ALT_BOOTDIR&#x3D;&#x2F;usr&#x2F;java&#x2F;jdk1.7.0_80&#x2F;<br>export ALLOW_DOWNLOADS&#x3D;true</p><p>export HOTSPOT_BUILD_JOBS&#x3D;4<br>export ALT_PATALLER_COMPILE_JOBS&#x3D;4</p><p>export SKIP_COMPARE_IMAGES&#x3D;true<br>export USE_PRECOMPILED_HEADER&#x3D;true<br>export BUILD_LANGTOOLS&#x3D;true<br>export BUILD_HOTSPOT&#x3D;true<br>export BUILD_JDK&#x3D;true</p><p>export BUILD_JAXP&#x3D;true<br>export BUILD_JAXWS&#x3D;true<br>export BUILD_CORBA&#x3D;true</p><p>#export SKIP_DEBUG_BUILD&#x3D;false<br>#export SKIP_FASTDEBUG_BUILD&#x3D;true</p><p>BUILD_DEPLOY&#x3D;false<br>BUILD_INSTALL&#x3D;false</p><p>export ALT_OUTPUTDIR&#x3D;&#x2F;root&#x2F;temp&#x2F;jdk7u</p><p>#export CORBA_DIST&#x3D;$ALT_OUTPUTDIR&#x2F;corba&#x2F;dist<br>#export JAXP_DIST&#x3D;$ALT_OUTPUTDIR&#x2F;jaxp&#x2F;dist<br>#export JAXWS_DIST&#x3D;$ALT_OUTPUTDIR&#x2F;jaxws&#x2F;dist</p><p>export ANT_HOME&#x3D;&#x2F;root&#x2F;apache-ant-1.8.0<br>export ALT_FREETYPE_HEADERS_PATH&#x3D;&#x2F;usr&#x2F;include&#x2F;freetype2<br>export ALT_FREETYPE_LIB_PATH&#x3D;&#x2F;usr&#x2F;lib64</p><p>unset JAVA_HOME<br>unset CLASSPATH<br>unset JAVA_OPTS</p><p>保存并source ~&#x2F;.bashrc</p><p><strong>编译前检查：</strong></p><p>make sanity</p><p><strong>编译：</strong></p><p>make</p><p><strong>测试编译的JDK:</strong></p><p>进入编译的目录(export ALT_OUTPUTDIR&#x3D;&#x2F;root&#x2F;temp&#x2F;jdk7u)的bin目录，.&#x2F;java -version</p><p>显示下面内容说明编译成功：</p><p>openjdk version “1.7.0-internal”<br>OpenJDK Runtime Environment (build 1.7.0-internal-root_2017_08_04_17_21-b00)<br>OpenJDK 64-Bit Server VM (build 24.80-b07, mixed mode)</p><p><strong>在eclipse上调试HotSpot虚拟机源码:</strong></p><p><a href="https://blog.csdn.net/tjiyu/article/details/53725247">https://blog.csdn.net/tjiyu/article/details/53725247</a></p><p><a href="https://www.cnblogs.com/endv/p/6427169.html">https://www.cnblogs.com/endv/p/6427169.html</a> vncserver</p>]]></content>
    
    
    <categories>
      
      <category>jdk</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jdk</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>git stash</title>
    <link href="/2020/08/19/git/git%20stash%20%E4%B8%8D%E6%80%95%E6%89%93%E6%89%B0%EF%BC%8C%E4%B8%B4%E6%97%B6%E4%BF%AE%E6%94%B9bug/"/>
    <url>/2020/08/19/git/git%20stash%20%E4%B8%8D%E6%80%95%E6%89%93%E6%89%B0%EF%BC%8C%E4%B8%B4%E6%97%B6%E4%BF%AE%E6%94%B9bug/</url>
    
    <content type="html"><![CDATA[<h2 id="1-你在开发时，本地代码有修改，但是不能提交，有个紧急任务，怎么办"><a href="#1-你在开发时，本地代码有修改，但是不能提交，有个紧急任务，怎么办" class="headerlink" title="1.你在开发时，本地代码有修改，但是不能提交，有个紧急任务，怎么办"></a>1.你在开发时，本地代码有修改，但是不能提交，有个紧急任务，怎么办</h2><p>git stash</p><h2 id="2-git-stash"><a href="#2-git-stash" class="headerlink" title="2.git stash"></a>2.git stash</h2><p>保存当前工作进度，将工作区和暂存区恢复到修改之前。</p><h2 id="3-git-stash-save-message"><a href="#3-git-stash-save-message" class="headerlink" title="3.git stash save message"></a>3.git stash save message</h2><p>作用同上，message为此次进度保存的说明。</p><h2 id="4-git-stash-list"><a href="#4-git-stash-list" class="headerlink" title="4.git stash list"></a>4.git stash list</h2><p>显示保存的工作进度列表，编号越小代表保存进度的时间越近。</p><h2 id="5-git-stash-pop-stash-num"><a href="#5-git-stash-pop-stash-num" class="headerlink" title="5.git stash pop stash@{num}"></a>5.git stash pop stash@{num}</h2><p>恢复工作进度到工作区，此命令的stash@{num}是可选项，在多个工作进度中可以选择恢复，不带此项则默认恢复最近的一次进度相当于<code>git stash pop stash@&#123;0&#125;</code></p><h2 id="6-git-stash-apply-stash-num"><a href="#6-git-stash-apply-stash-num" class="headerlink" title="6.git stash apply stash@{num}"></a>6.git stash apply stash@{num}</h2><p>恢复工作进度到工作区且该工作进度可重复恢复，此命令的stash@{num}是可选项，在多个工作进度中可以选择恢复，不带此项则默认恢复最近的一次进度相当于<code>git stash apply stash@&#123;0&#125;</code></p><h2 id="7-git-stash-drop-stash-num"><a href="#7-git-stash-drop-stash-num" class="headerlink" title="7.git stash drop stash@{num}"></a>7.git stash drop stash@{num}</h2><p>删除一条保存的工作进度，此命令的stash@{num}是可选项，在多个工作进度中可以选择删除，不带此项则默认删除最近的一次进度相当于<code>git stash drop stash@&#123;0&#125;</code></p><h2 id="8-git-stash-clear"><a href="#8-git-stash-clear" class="headerlink" title="8.git stash clear"></a>8.git stash clear</h2><p>删除所有保存的工作进度。</p>]]></content>
    
    
    <categories>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring_cloud_eureka下线与上线</title>
    <link href="/2020/07/15/spring_cloud/spring_cloud_eureka%E4%B8%8B%E7%BA%BF%E4%B8%8E%E4%B8%8A%E7%BA%BF/"/>
    <url>/2020/07/15/spring_cloud/spring_cloud_eureka%E4%B8%8B%E7%BA%BF%E4%B8%8E%E4%B8%8A%E7%BA%BF/</url>
    
    <content type="html"><![CDATA[<h2 id="手动删除spring-cloud-eureka的服务节点"><a href="#手动删除spring-cloud-eureka的服务节点" class="headerlink" title="手动删除spring_cloud_eureka的服务节点"></a>手动删除spring_cloud_eureka的服务节点</h2><h3 id="1-强制下线"><a href="#1-强制下线" class="headerlink" title="1.强制下线"></a>1.强制下线</h3><p>可以通过调用stateUpdate接口，更改实例的状态为OUT_OF_SERVICE 。</p><p>调用接口：&#x2F;eureka&#x2F;apps&#x2F;appID&#x2F;instanceID&#x2F;status?value&#x3D;OUT_OF_SERVICE</p><p>调用方式：PUT</p><h3 id="2-手动上线"><a href="#2-手动上线" class="headerlink" title="2.手动上线"></a>2.手动上线</h3><p>请求接口：&#x2F;eureka&#x2F;apps&#x2F;appID&#x2F;instanceID&#x2F;status?value&#x3D;UP</p><p>调用方式：PUT</p>]]></content>
    
    
    <categories>
      
      <category>spring_cloud</category>
      
      <category>spring_cloud_eureka</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring_cloud</tag>
      
      <tag>spring_cloud_eureka</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql常用sql</title>
    <link href="/2020/06/08/mysql/mysql%E5%B8%B8%E7%94%A8sql/"/>
    <url>/2020/06/08/mysql/mysql%E5%B8%B8%E7%94%A8sql/</url>
    
    <content type="html"><![CDATA[<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><p>登录命令</p><figure class="highlight sql"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sql">mysql <span class="hljs-operator">-</span>h$ip <span class="hljs-operator">-</span>P$port <span class="hljs-operator">-</span>u$<span class="hljs-keyword">user</span> <span class="hljs-operator">-</span>p<br></code></pre></td></tr></table></figure><p>查看mysql版本号</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> version(); <br></code></pre></td></tr></table></figure><p>按客户端 IP 分组，看哪个客户端的链接数最多</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span><br>client_ip,<br><span class="hljs-built_in">count</span>(client_ip) <span class="hljs-keyword">AS</span> client_num<br><span class="hljs-keyword">FROM</span><br>(<br><span class="hljs-keyword">SELECT</span><br>substring_index(HOST, <span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> client_ip<br><span class="hljs-keyword">FROM</span><br>information_schema. PROCESSLIST<br>) <span class="hljs-keyword">AS</span> connect_info<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span><br>client_ip<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><br>client_num <span class="hljs-keyword">DESC</span>;<br></code></pre></td></tr></table></figure><p>查看正在执行的线程，并按 Time 倒排序，看看有没有执行时间特别长的线程</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span><br><span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span><br>information_schema. PROCESSLIST<br><span class="hljs-keyword">WHERE</span><br>Command <span class="hljs-operator">!=</span> <span class="hljs-string">&#x27;Sleep&#x27;</span><br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><br><span class="hljs-type">Time</span> <span class="hljs-keyword">DESC</span>;<br></code></pre></td></tr></table></figure><p>找出所有执行时间超过 5 分钟的线程，拼凑出 kill 语句，方便后面查杀 （此处 5分钟 可根据自己的需要调整SQL）</p><p>可复制查询结果到控制台，直接执行，杀死堵塞进程</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><br><br><span class="hljs-keyword">SELECT</span><br>concat(<span class="hljs-string">&#x27;kill &#x27;</span>, id, <span class="hljs-string">&#x27;;&#x27;</span>)<br><span class="hljs-keyword">FROM</span><br>information_schema. PROCESSLIST<br><span class="hljs-keyword">WHERE</span><br>Command <span class="hljs-operator">!=</span> <span class="hljs-string">&#x27;Sleep&#x27;</span><br><span class="hljs-keyword">AND</span> <span class="hljs-type">Time</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">300</span><br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><br><span class="hljs-type">Time</span> <span class="hljs-keyword">DESC</span>;<br></code></pre></td></tr></table></figure><p>查看mysql隔离级别</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> VARIABLES <span class="hljs-keyword">like</span> &quot;%ISOLATION&quot;;<br></code></pre></td></tr></table></figure><p>查看msyql redo log的刷新</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> VARIABLES <span class="hljs-keyword">like</span> &quot;innodb_flush_log_at_trx_commit&quot;;<br></code></pre></td></tr></table></figure><p>查看msyql bin log的刷新</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> VARIABLES <span class="hljs-keyword">like</span> &quot;sync_binlog&quot;;<br></code></pre></td></tr></table></figure><p>查看持续时间超过60S的事务</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span><br><span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span><br>information_schema.INNODB_TRX<br><span class="hljs-keyword">WHERE</span><br>TIME_TO_SEC(<br>TIMEDIFF(now(), trx_started)<br>) <span class="hljs-operator">&gt;</span> <span class="hljs-number">60</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
      <category>sql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
      <tag>sql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux的chown命令</title>
    <link href="/2020/05/12/linux/linux%E7%9A%84chown/"/>
    <url>/2020/05/12/linux/linux%E7%9A%84chown/</url>
    
    <content type="html"><![CDATA[<p>##1.名称</p><p>chown</p><p>意思：改变文件属主; 改变属主; 命令; 更改文件拥有者; 改变文件所有权</p><h2 id="2-语法"><a href="#2-语法" class="headerlink" title="2.语法"></a>2.语法</h2><p>chown [选项]… [所有者] [:[组]] 文件…</p><p>chown [选项]… –reference&#x3D;参考文件 文件…</p><h2 id="3-描述"><a href="#3-描述" class="headerlink" title="3.描述"></a>3.描述</h2><p>改变文件属主</p><h2 id="4-参数"><a href="#4-参数" class="headerlink" title="4.参数"></a>4.参数</h2><h3 id="4-1-c"><a href="#4-1-c" class="headerlink" title="4.1 -c"></a>4.1 -c</h3><p>类似于verbose，但只有在进行更改时才报告</p><h3 id="4-2-f"><a href="#4-2-f" class="headerlink" title="4.2 -f"></a>4.2 -f</h3><p>忽略错误信息</p><h3 id="4-3-R"><a href="#4-3-R" class="headerlink" title="4.3 -R"></a>4.3 -R</h3><p>-R, –recursive<br>递归地操作文件和目录</p><h3 id="4-4-H"><a href="#4-4-H" class="headerlink" title="4.4 -H"></a>4.4 -H</h3><p>如果命令行参数是指向目录的符号链接，则遍历它</p><h3 id="4-5-L"><a href="#4-5-L" class="headerlink" title="4.5 -L"></a>4.5 -L</h3><p>遍历遇到的每个符号链接到一个目录</p><h3 id="4-6-P"><a href="#4-6-P" class="headerlink" title="4.6  -P"></a>4.6  -P</h3><p>不遍历任何符号链接(默认)</p><h3 id="4-7-v"><a href="#4-7-v" class="headerlink" title="4.7 -v"></a>4.7 -v</h3><p>-v, –verbose</p><p>为处理的每个文件输出一个诊断</p><h3 id="4-8-–help"><a href="#4-8-–help" class="headerlink" title="4.8 –help"></a>4.8 –help</h3><p>显示这个帮助并退出</p><h3 id="4-9-–version"><a href="#4-9-–version" class="headerlink" title="4.9 –version"></a>4.9 –version</h3><p>输出版本信息并退出</p><h3 id="4-10-查看完整文档"><a href="#4-10-查看完整文档" class="headerlink" title="4.10 查看完整文档"></a>4.10 查看完整文档</h3><p>info coreutils ‘chown invocation’</p><h2 id="5-例子"><a href="#5-例子" class="headerlink" title="5.例子"></a>5.例子</h2><h3 id="5-1-修改目录及目录下的文件给用户组a的a1"><a href="#5-1-修改目录及目录下的文件给用户组a的a1" class="headerlink" title="5.1 修改目录及目录下的文件给用户组a的a1"></a>5.1 修改目录及目录下的文件给用户组a的a1</h3><p>chown -R a1:a2 &#x2F;目录</p>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>chown</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring_cloud_eureka删除无效服务</title>
    <link href="/2020/05/12/spring_cloud/spring_cloud_eureka%E5%88%A0%E9%99%A4%E6%97%A0%E6%95%88%E6%9C%8D%E5%8A%A1/"/>
    <url>/2020/05/12/spring_cloud/spring_cloud_eureka%E5%88%A0%E9%99%A4%E6%97%A0%E6%95%88%E6%9C%8D%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<h2 id="手动删除spring-cloud-eureka的服务节点"><a href="#手动删除spring-cloud-eureka的服务节点" class="headerlink" title="手动删除spring_cloud_eureka的服务节点"></a>手动删除spring_cloud_eureka的服务节点</h2><h3 id="1-查看spring-cloud-eureka的管理页面"><a href="#1-查看spring-cloud-eureka的管理页面" class="headerlink" title="1.查看spring_cloud_eureka的管理页面"></a>1.查看spring_cloud_eureka的管理页面</h3><p>http:&#x2F;&#x2F;用户名:密码@ip:port</p><h3 id="2-删除服务节点"><a href="#2-删除服务节点" class="headerlink" title="2.删除服务节点"></a>2.删除服务节点</h3><p>Request Method &#x3D; DELETE<br>http:&#x2F;&#x2F;用户名:密码@ip:port&#x2F;eureka&#x2F;apps&#x2F;服务名&#x2F;注册名</p>]]></content>
    
    
    <categories>
      
      <category>spring_cloud</category>
      
      <category>spring_cloud_eureka</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring_cloud</tag>
      
      <tag>spring_cloud_eureka</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>git commit</title>
    <link href="/2020/04/07/git/git%20commit/"/>
    <url>/2020/04/07/git/git%20commit/</url>
    
    <content type="html"><![CDATA[<h2 id="1-怎么修改最新commit的message"><a href="#1-怎么修改最新commit的message" class="headerlink" title="1. 怎么修改最新commit的message?"></a>1. 怎么修改最新commit的message?</h2><p>git commit –amend</p><p>修改message并保存</p>]]></content>
    
    
    <categories>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>git rebase</title>
    <link href="/2020/04/07/git/git%20rebase/"/>
    <url>/2020/04/07/git/git%20rebase/</url>
    
    <content type="html"><![CDATA[<p>git rebase会修改commitId</p><h2 id="1-怎么修改老旧commit的message"><a href="#1-怎么修改老旧commit的message" class="headerlink" title="1. 怎么修改老旧commit的message?"></a>1. 怎么修改老旧commit的message?</h2><p>git rebase -i  [基于哪个commitId]</p><p>reword 使用这个commit,但是修改message</p><h2 id="2-怎么把连续的多个commit整理成1个？"><a href="#2-怎么把连续的多个commit整理成1个？" class="headerlink" title="2.怎么把连续的多个commit整理成1个？"></a>2.怎么把连续的多个commit整理成1个？</h2><p>git rebase -i [基于哪个commitId]</p><p>squash 使用这个commit,但是合到上一个commit上</p><h2 id="3-怎么把间隔的几个commit整理成1个？"><a href="#3-怎么把间隔的几个commit整理成1个？" class="headerlink" title="3.怎么把间隔的几个commit整理成1个？"></a>3.怎么把间隔的几个commit整理成1个？</h2><p>git rebase -i [基于哪个commitId]</p><p>编辑commit的顺序，使用squash</p>]]></content>
    
    
    <categories>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>git团队开发禁用内容</title>
    <link href="/2020/04/07/git/git%E5%9B%A2%E9%98%9F%E5%BC%80%E5%8F%91%E7%A6%81%E7%94%A8%E5%86%85%E5%AE%B9/"/>
    <url>/2020/04/07/git/git%E5%9B%A2%E9%98%9F%E5%BC%80%E5%8F%91%E7%A6%81%E7%94%A8%E5%86%85%E5%AE%B9/</url>
    
    <content type="html"><![CDATA[<h2 id="1-禁止向集成分支执行push-f操作"><a href="#1-禁止向集成分支执行push-f操作" class="headerlink" title="1. 禁止向集成分支执行push -f操作"></a>1. 禁止向集成分支执行push -f操作</h2><p>push -f 是强制提交</p><p>如果本地与远程分支不一致或有冲突时，使用push -f 操作会以当前本地分支的代码提交到远程，这时是会丢失代码。</p><p>1.多人分发时，你bug fix并已经提交到远程分支，测试验证了这个bug,但是过一会儿，测试又反应这个bug又出现了，你pull代码后，发现你本地这个bug fix commit 未提交到本地，就要注意是不是有人使用了push -f.</p><p>2.gitlab禁用向远程分支 push -f</p><h2 id="2-禁止向集成分支执行变理历史的操作"><a href="#2-禁止向集成分支执行变理历史的操作" class="headerlink" title="2.禁止向集成分支执行变理历史的操作"></a>2.禁止向集成分支执行变理历史的操作</h2><p>git rebase  会修改commit的id,多人开发时，你执行git rebase,其他人还是在原来的commit 上进行fastforward,这时就会出现代码布署问题。</p>]]></content>
    
    
    <categories>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>暂存区与工作区与head</title>
    <link href="/2020/04/07/git/%E6%9A%82%E5%AD%98%E5%8C%BA%E4%B8%8E%E5%B7%A5%E4%BD%9C%E5%8C%BA%E4%B8%8Ehead/"/>
    <url>/2020/04/07/git/%E6%9A%82%E5%AD%98%E5%8C%BA%E4%B8%8E%E5%B7%A5%E4%BD%9C%E5%8C%BA%E4%B8%8Ehead/</url>
    
    <content type="html"><![CDATA[<h2 id="1-如何让暂存区恢复成和head的一样"><a href="#1-如何让暂存区恢复成和head的一样" class="headerlink" title="1. 如何让暂存区恢复成和head的一样"></a>1. 如何让暂存区恢复成和head的一样</h2><p>git reset HEAD</p><h2 id="2-如何让工作区的文件恢复为和暂存区一样"><a href="#2-如何让工作区的文件恢复为和暂存区一样" class="headerlink" title="2.如何让工作区的文件恢复为和暂存区一样"></a>2.如何让工作区的文件恢复为和暂存区一样</h2><p>git checkout – 文件名</p><h2 id="3-怎样取消暂存区部分文件的更改"><a href="#3-怎样取消暂存区部分文件的更改" class="headerlink" title="3.怎样取消暂存区部分文件的更改"></a>3.怎样取消暂存区部分文件的更改</h2><p>git reset HEAD– 文件名[多文件]</p><h2 id="4-消除最近的几次提交"><a href="#4-消除最近的几次提交" class="headerlink" title="4.消除最近的几次提交"></a>4.消除最近的几次提交</h2><p>git reset –hard 想要变到的commitId</p><h2 id="5-开发中临时加塞了紧急的任务怎么处理？"><a href="#5-开发中临时加塞了紧急的任务怎么处理？" class="headerlink" title="5.开发中临时加塞了紧急的任务怎么处理？"></a>5.开发中临时加塞了紧急的任务怎么处理？</h2><p>git stash </p><p>git status</p><p>git stash apply     stash还在</p><p>git stash pop</p>]]></content>
    
    
    <categories>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>git入门</title>
    <link href="/2020/03/30/git/git%E5%85%A5%E9%97%A8/"/>
    <url>/2020/03/30/git/git%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h2><p><a href="https://git-scm.com/">https://git-scm.com</a> 官网</p><p><a href="https://git-scm.com/book/zh/v2">https://git-scm.com/book/zh/v2</a>  proGit 书</p><h2 id="1-安装git"><a href="#1-安装git" class="headerlink" title="1. 安装git"></a>1. 安装git</h2><p><a href="https://git-scm.com/book/zh/v2/%E8%B5%B7%E6%AD%A5-%E5%AE%89%E8%A3%85-Git">https://git-scm.com/book/zh/v2/%E8%B5%B7%E6%AD%A5-%E5%AE%89%E8%A3%85-Git</a></p><h2 id="2-使用git之前-需要做的最小配置"><a href="#2-使用git之前-需要做的最小配置" class="headerlink" title="2.使用git之前 需要做的最小配置"></a>2.使用git之前 需要做的最小配置</h2><p>进入命令行模式，打开git bash</p><p>git config   git 的config 命令帮助</p><p>git config –list 查看当前文件夹下，git 的配置</p><p>–global 使用的全局配置参数</p><p>–system 使用的用户的配置参数</p><p>–local 使用的仓库的配置参数</p><p>git 为什么这考虑呢？因为你可以有自已的demo项目(学习技术，github),你的电脑是个公有产品</p><p>设置提交时的名字与邮箱</p><p>git config –local user.name ‘xxx’<br>git config –local user.email ‘<a href="mailto:&#x78;&#120;&#x78;&#x40;&#x31;&#54;&#51;&#46;&#x63;&#x6f;&#x6d;">&#x78;&#120;&#x78;&#x40;&#x31;&#54;&#51;&#46;&#x63;&#x6f;&#x6d;</a>‘</p><h2 id="3-暂存区与工作目录"><a href="#3-暂存区与工作目录" class="headerlink" title="3. 暂存区与工作目录"></a>3. 暂存区与工作目录</h2><p>tracked  ： 已跟踪<br>untracked ： 未跟踪<br><a href="https://git-scm.com/book/zh/v2/Git-%E5%9F%BA%E7%A1%80-%E8%AE%B0%E5%BD%95%E6%AF%8F%E6%AC%A1%E6%9B%B4%E6%96%B0%E5%88%B0%E4%BB%93%E5%BA%93">https://git-scm.com/book/zh/v2/Git-%E5%9F%BA%E7%A1%80-%E8%AE%B0%E5%BD%95%E6%AF%8F%E6%AC%A1%E6%9B%B4%E6%96%B0%E5%88%B0%E4%BB%93%E5%BA%93</a></p><p>git add<br>git rm<br>git mv</p><h2 id="4-查看历史提交"><a href="#4-查看历史提交" class="headerlink" title="4.查看历史提交"></a>4.查看历史提交</h2><p><a href="https://git-scm.com/book/zh/v2/Git-%E5%9F%BA%E7%A1%80-%E6%9F%A5%E7%9C%8B%E6%8F%90%E4%BA%A4%E5%8E%86%E5%8F%B2">https://git-scm.com/book/zh/v2/Git-%E5%9F%BA%E7%A1%80-%E6%9F%A5%E7%9C%8B%E6%8F%90%E4%BA%A4%E5%8E%86%E5%8F%B2</a></p><p>git log<br>git log -p 查看具体修改了什么(-是删除行，+是新增行)<br>git log -2 限制只输出最后两次提交<br>git log –pretty&#x3D;oneline 更改原本输出格式为一行显示<br>git log –pretty&#x3D;format:”%h - %an, %ar : %s”   更改原本输出格式为</p>]]></content>
    
    
    <categories>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>git初始化并关联远程仓库</title>
    <link href="/2020/03/30/git/git%E5%88%9D%E5%A7%8B%E5%8C%96%E5%B9%B6%E5%85%B3%E8%81%94%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93/"/>
    <url>/2020/03/30/git/git%E5%88%9D%E5%A7%8B%E5%8C%96%E5%B9%B6%E5%85%B3%E8%81%94%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93/</url>
    
    <content type="html"><![CDATA[<h2 id="本地项目关联码云项目"><a href="#本地项目关联码云项目" class="headerlink" title="本地项目关联码云项目"></a>本地项目关联码云项目</h2><p>git init</p><p>git remote add origin <a href="https://gitee.com/doufengle/HowTomcatWorks.git">https://gitee.com/doufengle/HowTomcatWorks.git</a></p><p>git push -u origin master</p><p>本地有提交，远程也有提交</p><p>git pull origin master –allow-unrelated-histories</p><p>git branch –set-upstream-to&#x3D;origin&#x2F;master master</p><figure class="highlight armasm"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">cd</span> existing_folder<br><span class="hljs-symbol">git</span> init<br><span class="hljs-symbol">git</span> remote <span class="hljs-keyword">add</span> origin http:<span class="hljs-comment">//git.hopson.io:9999/butler/backend-server/easylife-marketing.git</span><br><span class="hljs-symbol">git</span> <span class="hljs-keyword">add</span> .<br><span class="hljs-symbol">git</span> commit -m <span class="hljs-string">&quot;Initial commit&quot;</span><br><span class="hljs-symbol">git</span> <span class="hljs-keyword">push</span> -u origin master<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>git 查看commit在哪个分支存在和分支之间比较</title>
    <link href="/2019/10/11/git/git%20%E6%9F%A5%E7%9C%8Bcommit%E5%9C%A8%E5%93%AA%E4%B8%AA%E5%88%86%E6%94%AF%E5%AD%98%E5%9C%A8%E5%92%8C%E5%88%86%E6%94%AF%E4%B9%8B%E9%97%B4%E6%AF%94%E8%BE%83/"/>
    <url>/2019/10/11/git/git%20%E6%9F%A5%E7%9C%8Bcommit%E5%9C%A8%E5%93%AA%E4%B8%AA%E5%88%86%E6%94%AF%E5%AD%98%E5%9C%A8%E5%92%8C%E5%88%86%E6%94%AF%E4%B9%8B%E9%97%B4%E6%AF%94%E8%BE%83/</url>
    
    <content type="html"><![CDATA[<h2 id="1-问题描述"><a href="#1-问题描述" class="headerlink" title="1.问题描述"></a>1.问题描述</h2><p>现有分支：develop、develop2.0+develop、develop2.0、release-20190930<br>来了一个需求：我们在develop开发<br>来了一个2.0需求：我们新增develop2.0分支<br>测试需求：小组A要测试develop,小组B要测试develop2.0<br>开发布署：新增develop2.0+develop分支<br>20190930上线：develop<br>上线完毕归档：从develop分支新建分支release-20190930<br>重新回归develop: 合并develop2.0+develop至develop分支<br>这时线上发现bug,但此bug在测试环境已经修复。<br>这时已经知道具体的代码在哪，具体到哪个文件，具体到哪个commit。<br>发现develop有这个代码、develop2.0+develop也有、release-20190930没有。<br>最初怀疑未能正确归档分支，继续排查，看以上流程，猜测是开发人员在develop2.0+develop分支进行开发，并不是在develop分支开发并合并至develop2.0+develop分支。<br>如何验证猜测？</p><p>##2.查看commit在哪个分支存在</p><p>查看commit在哪个分支存在<br>命令如下：</p><figure class="highlight ada"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs ada">git branch <span class="hljs-comment">--contains commitId</span><br></code></pre></td></tr></table></figure><p>##3.对比两个分支差异</p><p>命令如下：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">git <span class="hljs-keyword">log</span> <span class="hljs-keyword">release</span><span class="hljs-number">-20190930</span> ^develop<br>git <span class="hljs-keyword">log</span> <span class="hljs-keyword">release</span><span class="hljs-number">-20190930</span> ^develop2<span class="hljs-number">.0</span>+develop<br></code></pre></td></tr></table></figure><p>##4.结果<br>这时发现提交记录在develop2.0+develop与develop中有，在release-20190930没有，所以线上版本也是没有的，并不是归档错分支。</p>]]></content>
    
    
    <categories>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>maven的_remote.repositories</title>
    <link href="/2019/09/29/maven/maven%E7%9A%84remote.propertes/"/>
    <url>/2019/09/29/maven/maven%E7%9A%84remote.propertes/</url>
    
    <content type="html"><![CDATA[<h2 id="1-情况描述"><a href="#1-情况描述" class="headerlink" title="1.情况描述"></a>1.情况描述</h2><p>这个包在镜像服务器没有了，已经过时。<br>本地仓库有这个jar包</p><h2 id="2-报错"><a href="#2-报错" class="headerlink" title="2.报错"></a>2.报错</h2><p>[ERROR] Failed to execute goal on project easylife-cms: Could not resolve dependencies for project xxx: Failed to collect dependencies at com.json:json:jar:1.0: Failed to read artifact descriptor for com.json:json:jar:1.0: Could not transfer artifact com.json:json:pom:1.0 from&#x2F;to alimaven (<a href="http://maven.aliyun.com/nexus/content/groups/public/">http://maven.aliyun.com/nexus/content/groups/public/</a>): sun.security.validator.ValidatorException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target -&gt; [Help 1]<br>[ERROR]<br>[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.<br>[ERROR] Re-run Maven using the -X switch to enable full debug logging.<br>[ERROR]<br>[ERROR] For more information about the errors and possible solutions, please read the following articles:</p><h2 id="3-排查"><a href="#3-排查" class="headerlink" title="3.排查"></a>3.排查</h2><p>删除本地仓库中的jar<br>使用mvn命令安装json.jar<br>这时就可以用了。<br>观察原先的_remote.repositories与现在的_remote.repositories发现不同，我把maven的setting中的本地仓库、私服仓库、中心仓库的名称改了一下。<br>_remote.repositories中：<br>xx文件&gt;私服ID名称<br>如果修改私服ID名称时，发现没有这个仓库了，会去中心仓库去下载，中心仓库还没有。</p>]]></content>
    
    
    <categories>
      
      <category>maven</category>
      
    </categories>
    
    
    <tags>
      
      <tag>maven</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>arthas启动help</title>
    <link href="/2019/09/27/arthas/arthas%E5%90%AF%E5%8A%A8help/"/>
    <url>/2019/09/27/arthas/arthas%E5%90%AF%E5%8A%A8help/</url>
    
    <content type="html"><![CDATA[<h2 id="1-获取启动参数"><a href="#1-获取启动参数" class="headerlink" title="1.获取启动参数"></a>1.获取启动参数</h2><p>java -jar arthas-boot.jar -h</p><h2 id="2-都是啥意思"><a href="#2-都是啥意思" class="headerlink" title="2.都是啥意思"></a>2.都是啥意思</h2><p>语法为：</p><figure class="highlight css"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><pre><code class="hljs css">arthas-boot <br><span class="hljs-selector-attr">[--telnet-port &lt;value&gt;]</span> <br><span class="hljs-selector-attr">[--http-port &lt;value&gt;]</span><br><span class="hljs-selector-attr">[--session-timeout &lt;value&gt;]</span> <br><span class="hljs-selector-attr">[--arthas-home &lt;value&gt;]</span> <br><span class="hljs-selector-attr">[--use-version &lt;value&gt;]</span> <br><span class="hljs-selector-attr">[--repo-mirror &lt;value&gt;]</span> <br><span class="hljs-selector-attr">[--versions]</span> <span class="hljs-selector-attr">[--use-http]</span><br><span class="hljs-selector-attr">[--attach-only]</span> <br><span class="hljs-selector-attr">[-c &lt;value&gt;]</span> <br><span class="hljs-selector-attr">[-f &lt;value&gt;]</span> <br><span class="hljs-selector-attr">[--height &lt;value&gt;]</span> <br><span class="hljs-selector-attr">[--width &lt;value&gt;]</span> <span class="hljs-selector-attr">[-v]</span> <span class="hljs-selector-attr">[-h]</span> <span class="hljs-selector-attr">[--target-ip &lt;value&gt;]</span> <span class="hljs-selector-attr">[pid]</span><br></code></pre></td></tr></table></figure><p>–telnet-port <value> 目标jvm监听telnet端口,默认3658<br>–http-port <value> 目标jvm监听http端口，默认8563<br>–session-timeout <value> session超时秒数，默认1800秒(30分钟)<br>–arthas-home <value> the arthas home<br>–use-version <value>       使用指定版本的arthas<br>–repo-mirror <value>使用指定的maven库镜像，例子:center&#x2F;aliyun或者http的资源地址<br>–versions 列出本地和远程arthas版本<br>–use-http执行使用http下载，默认https<br>–attach-only               Attach target process only, do not connect<br>-c,–command <value>命令行执行，多个命令由;分隔<br>-f,–batch-file <value>  执行脚本文件<br>–height <value>            arthas-client 终端高<br>–width <value>             arthas-client 终端宽<br>-v,–verbose 详细的，打印调试信息<br>-h,–help打印帮助信息<br>–target-ip <value>        目标虚拟机IP, 默认127.0.0.1<br><pid>     目标进程ID</pid></value></value></value></value></value></value></value></value></value></value></value></p>]]></content>
    
    
    <categories>
      
      <category>arthas</category>
      
    </categories>
    
    
    <tags>
      
      <tag>arthas</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>arthas</title>
    <link href="/2019/09/27/arthas/arthas%E5%85%A5%E9%97%A8/"/>
    <url>/2019/09/27/arthas/arthas%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="1-下载安装"><a href="#1-下载安装" class="headerlink" title="1.下载安装"></a>1.下载安装</h2><figure class="highlight awk"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//</span>alibaba.github.io<span class="hljs-regexp">/arthas/</span>arthas-boot.jar<br>java -jar arthas-boot.jar<br></code></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">wget https:<span class="hljs-comment">//arthas.gitee.io/arthas-boot.jar</span><br>java -jar arthas-boot<span class="hljs-selector-class">.jar</span> <span class="hljs-attr">--repo-mirror</span> aliyun <span class="hljs-attr">--use-http</span><br></code></pre></td></tr></table></figure><p>更多下载安装去官网查看。</p><h2 id="2-什么是arthas"><a href="#2-什么是arthas" class="headerlink" title="2.什么是arthas"></a>2.什么是arthas</h2><p><code>Arthas</code> 是Alibaba开源的Java诊断工具。</p><h2 id="3-arthas能干啥"><a href="#3-arthas能干啥" class="headerlink" title="3.arthas能干啥"></a>3.arthas能干啥</h2><p>1.这个类从哪个 jar 包加载的？为什么会报各种类相关的 Exception？</p><p>2.我改的代码为什么没有执行到？难道是我没 commit？分支搞错了？</p><p>3.遇到问题无法在线上 debug，难道只能通过加日志再重新发布吗？</p><p>4.线上遇到某个用户的数据处理有问题，但线上同样无法 debug，线下无法重现！</p><p>5.是否有一个全局视角来查看系统的运行状况？</p><p>6.有什么办法可以监控到JVM的实时运行状态？</p><h2 id="4-这个类从哪个jar包加载的？"><a href="#4-这个类从哪个jar包加载的？" class="headerlink" title="4.这个类从哪个jar包加载的？"></a>4.这个类从哪个jar包加载的？</h2><p>sc 查看JVM已加载的类信息<br>Search-Class” 的简写，这个命令能搜索出所有已经加载到 JVM 中的 Class 信息。<br>sc *StringUtils</p><p>sc -d org.springframework.util.StringUtils<br>-d 输出当前类的详细信息，包括这个类所加载的原始文件来源、类的声明、加载的ClassLoader等详细信息。<br>如果一个类被多个ClassLoader所加载，则会出现多次<br>其中code-source就包含jar包信息</p><h2 id="5-排查函数调用异常"><a href="#5-排查函数调用异常" class="headerlink" title="5.排查函数调用异常"></a>5.排查函数调用异常</h2><p>官网案例：<br>curl <a href="http://localhost/user/0">http://localhost/user/0</a><br>{“timestamp”:1550223186170,”status”:500,”error”:”Internal Server Error”,”exception”:”java.lang.IllegalArgumentException”,”message”:”id &lt; 1”,”path”:”&#x2F;user&#x2F;0”}<br>问题1：请求的具体参数，异常栈是什么呢<br>watch com.example.demo.arthas.user.UserController * ‘{params, throwExp}’</p><p>watch 方法执行数据观测<br>第一个参数是类名，对持通配，com.example.demo.arthas.user.UserController<br>第二个参数是函数名，支持通配，*<br>第三个参数是观察表达式，’{params, throwExp}’<br>    params 本次调用参数列表，这是一个数组，如果方法是无参方法则为空数组<br>    throwExp 本次调用抛出的异常。当且仅当 isThrow&#x3D;&#x3D;true 成立时有效，表明方法调用是以抛出异常的方式结束。<br>再次访问curl <a href="http://localhost/user/0">http://localhost/user/0</a><br>watch命令会打印调用的参数和异常<br>这样可以在不打印日志的时候，观察到调用参数和异常栈。</p><p>-x<br>指定输出结果的属性遍历深度，默认为 1</p><h2 id="6-我改的代码为什么没有执行到？难道是我没-commit？分支搞错了？"><a href="#6-我改的代码为什么没有执行到？难道是我没-commit？分支搞错了？" class="headerlink" title="6.我改的代码为什么没有执行到？难道是我没 commit？分支搞错了？"></a>6.我改的代码为什么没有执行到？难道是我没 commit？分支搞错了？</h2><p>jad<br>反编译指定已加载类的源码<br>jad –source-only org.springframework.util.StringUtils</p><h2 id="7-遇到问题无法在线上-debug，难道只能通过加日志再重新发布吗？"><a href="#7-遇到问题无法在线上-debug，难道只能通过加日志再重新发布吗？" class="headerlink" title="7.遇到问题无法在线上 debug，难道只能通过加日志再重新发布吗？"></a>7.遇到问题无法在线上 debug，难道只能通过加日志再重新发布吗？</h2><p>用watch命令<br>使用jad反编译出源码，修改源码，编译源码(mc), 加载编译源码(redefine).(arthas在线教程进阶版)<br>如果是有打印日志，线上关闭了debug、info、warn级别,可以动态改变logger level(arthas在线教程进阶版)</p><h2 id="8-是否有一个全局视角来查看系统的运行状况？"><a href="#8-是否有一个全局视角来查看系统的运行状况？" class="headerlink" title="8.是否有一个全局视角来查看系统的运行状况？"></a>8.是否有一个全局视角来查看系统的运行状况？</h2><p>dashboard  当前系统的实时数据面板<br>thread、memory、gc、runtime</p><h2 id="9-有什么办法可以监控到JVM的实时运行状态？"><a href="#9-有什么办法可以监控到JVM的实时运行状态？" class="headerlink" title="9.有什么办法可以监控到JVM的实时运行状态？"></a>9.有什么办法可以监控到JVM的实时运行状态？</h2><p>jvm 查看当前JVM信息</p>]]></content>
    
    
    <categories>
      
      <category>arthas</category>
      
    </categories>
    
    
    <tags>
      
      <tag>arthas</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux创建虚拟内存swap</title>
    <link href="/2019/09/23/linux/linux%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98swap/"/>
    <url>/2019/09/23/linux/linux%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98swap/</url>
    
    <content type="html"><![CDATA[<p>##1.创建一个swapfile用于虚拟内存：<br>内存大小为物理内存的2倍左右<br>DD是Linux&#x2F;UNIX 下的一个非常有用的命令，作用是用指定大小的块拷贝一个文件，并在拷贝的同时进行指定的转换。dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;&#x2F;root&#x2F;swapfile bs&#x3D;16M count&#x3D;1000</p><p>一般是物理内存的2倍，这里是16G</p><p>##2.把swapfile改为swap<br>mkswap &#x2F;root&#x2F;swapfile</p><p>##3.开启或关闭swap<br>swapon &#x2F;root&#x2F;swapfile<br>swapoff &#x2F;root&#x2F;swapfile</p><p>##4.设置开机启动<br>vi &#x2F;etc&#x2F;fstab</p><p>&#x2F;root&#x2F;swapfile       swap               swap           defaults              0            0</p>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>swap</tag>
      
      <tag>linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>负载均衡</title>
    <link href="/2019/09/10/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    <url>/2019/09/10/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/</url>
    
    <content type="html"><![CDATA[<h2 id="1-什么是负载均衡"><a href="#1-什么是负载均衡" class="headerlink" title="1.什么是负载均衡"></a>1.什么是负载均衡</h2><p>负载均衡建立在现有网络结构之上，它提供了一种廉价有效透明的方法扩展网络设备和服务器的带宽、增加吞吐量、加强网络数据处理能力、提高网络的灵活性和可用性。</p><p>负载均衡<em>（Load Balance）</em>其意思就是分摊到多个操作单元上进行执行，例如Web服务器、FTP服务器、企业关键应用服务器和其它关键任务服务器等，从而共同完成工作任务。</p><h2 id="2-负载均衡分层"><a href="#2-负载均衡分层" class="headerlink" title="2.负载均衡分层"></a>2.负载均衡分层</h2><p>地域上的负载均衡：DNS（轮询、多个公网IP）</p><p>硬件层面的负载均衡： F5    （作用：集群和集群之间的负载均衡）</p><p>软件层面的负载均衡：lvs | nginx (作用：主机和主机之间的负载均衡)</p><h2 id="3-四层负载均衡、七层负载均衡"><a href="#3-四层负载均衡、七层负载均衡" class="headerlink" title="3.四层负载均衡、七层负载均衡"></a>3.四层负载均衡、七层负载均衡</h2><p>二层负载均衡会通过一个虚拟MAC地址接收请求，然后再分配到真实的MAC地址；</p><p>三层负载均衡会通过一个虚拟IP地址接收请求，然后再分配到真实的IP地址；</p><p>四层通过虚拟IP+端口接收请求，然后再分配到真实的服务器；</p><p>七层通过虚拟的URL或主机名接收请求，然后再分配到真实的服务器。</p><p>所谓的四到七层负载均衡，就是在对后台的服务器进行负载均衡时，依据四层的信息或七层的信息来决定怎么样转发流量。</p><p>比如：192.168.0.1 80 端口是官网的访问地址</p><p>​192.168.0.2 80 端口是文件服务器的地址</p><p>四层负载均衡就会分配的真实的服务器去。</p><p>比如:你的WEB服务器分成两组，一组是中文语言，一组是英文语言。</p><p><a href="http://hanqichuan.com/zh/">http://hanqichuan.com/zh/</a></p><p><a href="http://hanqichuan.com/en/">http://hanqichuan.com/en/</a></p><p>七层负载均衡就可以当用户来访问的域名时，自动辨别用户语言，然后选择对应的语言服务器组进行负载均衡处理。</p><p>四层负载：LVS、F5</p><p>七层负载：haproxy、mysql proxy</p><p>四层负载：客户端与负载均衡器与服务器建立一个TCP连接，负载均衡器会修改报文头目标地址、修改源地址(根据需求)</p><p>七层负载：负载均衡器与客户端与服务器分别建立一个TCP连接。</p><p>七层负载均衡明显的对负载均衡设备的要求更高，处理七层的能力也必然会低于四层模式的部署方式。</p>]]></content>
    
    
    <categories>
      
      <category>负载均衡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>负载均衡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mvnw</title>
    <link href="/2019/09/04/maven/mvnw/"/>
    <url>/2019/09/04/maven/mvnw/</url>
    
    <content type="html"><![CDATA[<h2 id="1-什么是mvnw"><a href="#1-什么是mvnw" class="headerlink" title="1.什么是mvnw?"></a>1.什么是mvnw?</h2><p>mvnw是maven warpper，它的原理是在maven-wrapper.properties文件中记录你要使用的maven版本，当用户执行mvnw clean命令时，发现当前用户的maven版本和期望的版本不一致，那么就下载期望的版本。</p><h2 id="2-怎么配置mvnw？"><a href="#2-怎么配置mvnw？" class="headerlink" title="2.怎么配置mvnw？"></a>2.怎么配置mvnw？</h2><p>1.在pom.xml中添加plugin声明</p><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.rimerosolutions.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>wrapper-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br></code></pre></td></tr></table></figure><p>执行 mvn wrapper:wrapper ，会帮生成mvnw.bat, mvnw, maven&#x2F;maven-wrapper.jar, maven&#x2F;maven-wrapper.properties。</p><p>我们就可以用mvnw代替mvn命令执行所有的maven命令。</p><p>2.直接执行goal</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">#表示我们期望使用的maven的版本为<span class="hljs-number">3.3</span><span class="hljs-number">.3</span><br>mvn -N io.takari:maven:<span class="hljs-keyword">wrapper</span> -Dmaven=<span class="hljs-number">3.3</span><span class="hljs-number">.3</span><br></code></pre></td></tr></table></figure><p>产生的内容和第一种方式是一样的，只是目录结构不一样，maven-wrapper.jar和maven-wrapper.properties在.mvn&#x2F;wrapper目录下。</p>]]></content>
    
    
    <categories>
      
      <category>maven</category>
      
    </categories>
    
    
    <tags>
      
      <tag>maven</tag>
      
      <tag>mvnw</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring IOC</title>
    <link href="/2019/09/03/spring/spring%20IOC/"/>
    <url>/2019/09/03/spring/spring%20IOC/</url>
    
    <content type="html"><![CDATA[<h1 id="1-为什么使用IOC-什么是IOC-什么是DI"><a href="#1-为什么使用IOC-什么是IOC-什么是DI" class="headerlink" title="1.为什么使用IOC?什么是IOC?什么是DI?"></a>1.为什么使用IOC?什么是IOC?什么是DI?</h1><p>IOC 中文为控制反转。</p><p>IOC是一种设计、设计模式。DI是注入的一种方式。</p><p>一般依赖使用：</p><p><img src="/.com//%E4%B8%80%E8%88%AC%E4%BE%9D%E8%B5%96%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95.jpg" alt="一般依赖使用方法"></p><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br><span class="hljs-type">Score</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Score</span>();<br>student.setScore(score);<br></code></pre></td></tr></table></figure><p><img src="/.com//IOC%E5%AE%B9%E5%99%A8%E7%AE%80%E5%8D%95%E8%AF%B4%E6%98%8E.jpg" alt="IOC容器简单说明"></p><p>降低了程序里对象与对象之间的耦合性。</p><h1 id="2-spring-ioc-的源码分析及实现"><a href="#2-spring-ioc-的源码分析及实现" class="headerlink" title="2.spring ioc 的源码分析及实现"></a>2.spring ioc 的源码分析及实现</h1><h2 id="首先先明确几个概念："><a href="#首先先明确几个概念：" class="headerlink" title="首先先明确几个概念："></a>首先先明确几个概念：</h2><p>Environment 环境，用于获取系统环境及系统配置的对象</p><p>post processor 称后置处理器或增强器，就是对类进制扩展，用反射，beanFactoryPostProcessor是对bean工厂进行增强，beanPostProcessor是对bean进行增强。</p><p>aware 意识、察觉 继承aware后可以获取对应的aware的属性值，spring 初始化时会调用设置。</p><p>BeanDefinitionReader 根据xml 或 注解解析成 beanDefinition的抽象接口</p><p>beanDefinition是xml 或 注解 里定义的bean结构的对象</p><p>listener 监听器 </p><p>envent 事件</p><p>Multicast 多播器</p><h2 id="spring-ioc创建对象流程（对象生命周期）"><a href="#spring-ioc创建对象流程（对象生命周期）" class="headerlink" title="spring ioc创建对象流程（对象生命周期）"></a>spring ioc创建对象流程（对象生命周期）</h2><p>1.创建项目时会指定使用啥方式配置spring, 比如 xml 或 注解</p><p>2.加载配置文件</p><p>3.生成beanDefinition并注册到容器</p><p>4.BeanFactoryPostProcessor的执行</p><p>5.根据反射实例化bean对象</p><p>6.初始化bean对象</p><p>  6.1填充属性</p><p>  6.2执行aware接口需要实现的方法</p><p>  6.3执行before的beanPostProcessor</p><p>  6.4执行bean指定的init-method</p><p>  6.5执行after的beanPostProcessor</p><p>  这时bean对象是完整的</p><p>7.点击 程序停止 -&gt; 容器销毁 -&gt; 执行destory-method</p><h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException, IllegalStateException &#123;<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.startupShutdownMonitor) &#123;<br><span class="hljs-comment">// Prepare this context for refreshing.</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 做容器刷新前的准备工作</span><br><span class="hljs-comment"> * 1、设置容器的启动时间</span><br><span class="hljs-comment"> * 2、设置活跃状态为true</span><br><span class="hljs-comment"> * 3、设置关闭状态为false</span><br><span class="hljs-comment"> * 4、获取Environment对象，并加载当前系统的属性值到Environment对象中</span><br><span class="hljs-comment"> * 5、准备监听器和事件的集合对象，默认为空的集合</span><br><span class="hljs-comment"> */</span><br><br>prepareRefresh();<br><br><span class="hljs-comment">// Tell the subclass to refresh the internal bean factory.</span><br><span class="hljs-comment">// 创建容器对象：DefaultListableBeanFactory</span><br><span class="hljs-comment">// 加载xml配置文件的属性值到当前工厂中，最重要的就是BeanDefinition</span><br><span class="hljs-type">ConfigurableListableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> obtainFreshBeanFactory();<br><br><span class="hljs-comment">// Prepare the bean factory for use in this context.</span><br><span class="hljs-comment">// beanFactory的准备工作，对各种属性进行填充</span><br>prepareBeanFactory(beanFactory);<br><br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// Allows post-processing of the bean factory in context subclasses.</span><br><span class="hljs-comment">// 子类覆盖方法做额外的处理，此处我们自己一般不做任何扩展工作，但是可以查看web中的代码，是有具体实现的</span><br>postProcessBeanFactory(beanFactory);<br><br><span class="hljs-comment">// Invoke factory processors registered as beans in the context.</span><br><span class="hljs-comment">// 调用各种beanFactory处理器</span><br>invokeBeanFactoryPostProcessors(beanFactory);<br><br><span class="hljs-comment">// Register bean processors that intercept bean creation.</span><br><span class="hljs-comment">// 注册bean处理器，这里只是注册功能，真正调用的是getBean方法</span><br>registerBeanPostProcessors(beanFactory);<br><br><span class="hljs-comment">// Initialize message source for this context.</span><br><span class="hljs-comment">// 为上下文初始化message源，即不同语言的消息体，国际化处理,在springmvc的时候通过国际化的代码重点讲</span><br>initMessageSource();<br><br><span class="hljs-comment">// Initialize event multicaster for this context.</span><br><span class="hljs-comment">// 初始化事件监听多路广播器</span><br>initApplicationEventMulticaster();<br><br><span class="hljs-comment">// Initialize other special beans in specific context subclasses.</span><br><span class="hljs-comment">// 留给子类来初始化其他的bean</span><br>onRefresh();<br><br><span class="hljs-comment">// Check for listener beans and register them.</span><br><span class="hljs-comment">// 在所有注册的bean中查找listener bean,注册到消息广播器中</span><br>registerListeners();<br><br><span class="hljs-comment">// Instantiate all remaining (non-lazy-init) singletons.</span><br><span class="hljs-comment">// 初始化剩下的单实例（非懒加载的）</span><br>finishBeanFactoryInitialization(beanFactory);<br><br><span class="hljs-comment">// Last step: publish corresponding event.</span><br><span class="hljs-comment">// 完成刷新过程，通知生命周期处理器lifecycleProcessor刷新过程，同时发出ContextRefreshEvent通知别人</span><br>finishRefresh();<br>&#125;<br><br><span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br><span class="hljs-keyword">if</span> (logger.isWarnEnabled()) &#123;<br>logger.warn(<span class="hljs-string">&quot;Exception encountered during context initialization - &quot;</span> +<br><span class="hljs-string">&quot;cancelling refresh attempt: &quot;</span> + ex);<br>&#125;<br><br><span class="hljs-comment">// Destroy already created singletons to avoid dangling resources.</span><br><span class="hljs-comment">// 为防止bean资源占用，在异常处理中，销毁已经在前面过程中生成的单件bean</span><br>destroyBeans();<br><br><span class="hljs-comment">// Reset &#x27;active&#x27; flag.</span><br><span class="hljs-comment">// 重置active标志</span><br>cancelRefresh(ex);<br><br><span class="hljs-comment">// Propagate exception to caller.</span><br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br><br><span class="hljs-keyword">finally</span> &#123;<br><span class="hljs-comment">// Reset common introspection caches in Spring&#x27;s core, since we</span><br><span class="hljs-comment">// might not ever need metadata for singleton beans anymore...</span><br>resetCommonCaches();<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finishBeanFactoryInitialization</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;<br><span class="hljs-comment">// Initialize conversion service for this context.</span><br><span class="hljs-comment">// 为上下文初始化类型转换器</span><br><span class="hljs-keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;<br>beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;<br>beanFactory.setConversionService(<br>beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));<br>&#125;<br><br><span class="hljs-comment">// Register a default embedded value resolver if no bean post-processor</span><br><span class="hljs-comment">// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span><br><span class="hljs-comment">// at this point, primarily for resolution in annotation attribute values.</span><br><span class="hljs-comment">// 如果beanFactory之前没有注册嵌入值解析器，则注册默认的嵌入值解析器，主要用于注解属性值的解析</span><br><span class="hljs-keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;<br>beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));<br>&#125;<br><br><span class="hljs-comment">// Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span><br><span class="hljs-comment">// 尽早初始化loadTimeWeaverAware bean,以便尽早注册它们的转换器</span><br>String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;<br>getBean(weaverAwareName);<br>&#125;<br><br><span class="hljs-comment">// Stop using the temporary ClassLoader for type matching.</span><br><span class="hljs-comment">// 禁止使用临时类加载器进行类型匹配</span><br>beanFactory.setTempClassLoader(<span class="hljs-literal">null</span>);<br><br><span class="hljs-comment">// Allow for caching all bean definition metadata, not expecting further changes.</span><br><span class="hljs-comment">// 冻结所有的bean定义，说明注册的bean定义将不被修改或任何进一步的处理</span><br>beanFactory.freezeConfiguration();<br><br><span class="hljs-comment">// Instantiate all remaining (non-lazy-init) singletons.</span><br><span class="hljs-comment">// 实例化剩下的单例对象</span><br>beanFactory.preInstantiateSingletons();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">preInstantiateSingletons</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Pre-instantiating singletons in &quot;</span> + <span class="hljs-built_in">this</span>);<br>&#125;<br><br><span class="hljs-comment">// Iterate over a copy to allow for init methods which in turn register new bean definitions.</span><br><span class="hljs-comment">// While this may not be part of the regular factory bootstrap, it does otherwise work fine.</span><br>List&lt;String&gt; beanNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-built_in">this</span>.beanDefinitionNames);<br><br><span class="hljs-comment">// Trigger initialization of all non-lazy singleton beans...</span><br><span class="hljs-keyword">for</span> (String beanName : beanNames) &#123;<br><span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> getMergedLocalBeanDefinition(beanName);<br><span class="hljs-keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;<br><span class="hljs-keyword">if</span> (isFactoryBean(beanName)) &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> getBean(FACTORY_BEAN_PREFIX + beanName);<br><span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> FactoryBean) &#123;<br>FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) bean;<br><span class="hljs-type">boolean</span> isEagerInit;<br><span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span> &amp;&amp; factory <span class="hljs-keyword">instanceof</span> SmartFactoryBean) &#123;<br>isEagerInit = AccessController.doPrivileged(<br>(PrivilegedAction&lt;Boolean&gt;) ((SmartFactoryBean&lt;?&gt;) factory)::isEagerInit,<br>getAccessControlContext());<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>isEagerInit = (factory <span class="hljs-keyword">instanceof</span> SmartFactoryBean &amp;&amp;<br>((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());<br>&#125;<br><span class="hljs-keyword">if</span> (isEagerInit) &#123;<br>getBean(beanName);<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>getBean(beanName);<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Trigger post-initialization callback for all applicable beans...</span><br><span class="hljs-keyword">for</span> (String beanName : beanNames) &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">singletonInstance</span> <span class="hljs-operator">=</span> getSingleton(beanName);<br><span class="hljs-keyword">if</span> (singletonInstance <span class="hljs-keyword">instanceof</span> SmartInitializingSingleton) &#123;<br><span class="hljs-type">SmartInitializingSingleton</span> <span class="hljs-variable">smartSingleton</span> <span class="hljs-operator">=</span> (SmartInitializingSingleton) singletonInstance;<br><span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span>) &#123;<br>AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;<br>smartSingleton.afterSingletonsInstantiated();<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;, getAccessControlContext());<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>smartSingleton.afterSingletonsInstantiated();<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="hljs-keyword">protected</span> &lt;T&gt; T <span class="hljs-title function_">doGetBean</span><span class="hljs-params">(</span><br><span class="hljs-params">String name, <span class="hljs-meta">@Nullable</span> Class&lt;T&gt; requiredType, <span class="hljs-meta">@Nullable</span> Object[] args, <span class="hljs-type">boolean</span> typeCheckOnly)</span><br><span class="hljs-keyword">throws</span> BeansException &#123;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 提取对应的beanName，很多同学可能会认为此处直接使用即可，为什么还要进行转换呢，原因在于当bean对象实现FactoryBean接口之后就会变成&amp;beanName，同时如果存在别名，也需要把别名进行转换*/</span><br><span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> transformedBeanName(name);<br>Object bean;<br><br><span class="hljs-comment">// Eagerly check singleton cache for manually registered singletons.</span><br><span class="hljs-comment">/**提前检查单例缓存中是否有手动注册的单例对象，跟循环依赖有关联*/</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">sharedInstance</span> <span class="hljs-operator">=</span> getSingleton(beanName);<br><span class="hljs-comment">// 如果bean的单例对象找到了，且没有创建bean实例时要使用的参数</span><br><span class="hljs-keyword">if</span> (sharedInstance != <span class="hljs-literal">null</span> &amp;&amp; args == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br><span class="hljs-keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;<br>logger.trace(<span class="hljs-string">&quot;Returning eagerly cached instance of singleton bean &#x27;&quot;</span> + beanName +<br><span class="hljs-string">&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>logger.trace(<span class="hljs-string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br>&#125;<br><span class="hljs-comment">// 返回对象的实例，很多同学会理解不了这句话存在的意义，当你实现了FactoryBean接口的对象，需要获取具体的对象的时候就需要此方法来进行获取了</span><br>bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="hljs-literal">null</span>);<br>&#125;<br><br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// Fail if we&#x27;re already creating this bean instance:</span><br><span class="hljs-comment">// We&#x27;re assumably within a circular reference.</span><br><span class="hljs-comment">// 当对象都是单例的时候会尝试解决循环依赖的问题，但是原型模式下如果存在循环依赖的情况，那么直接抛出异常</span><br><span class="hljs-keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCurrentlyInCreationException</span>(beanName);<br>&#125;<br><br><span class="hljs-comment">// Check if bean definition exists in this factory.</span><br><span class="hljs-comment">// 如果bean定义不存在，就检查父工厂是否有</span><br><span class="hljs-type">BeanFactory</span> <span class="hljs-variable">parentBeanFactory</span> <span class="hljs-operator">=</span> getParentBeanFactory();<br><span class="hljs-comment">// 如果beanDefinitionMap中也就是在所有已经加载的类中不包含beanName，那么就尝试从父容器中获取</span><br><span class="hljs-keyword">if</span> (parentBeanFactory != <span class="hljs-literal">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;<br><span class="hljs-comment">// Not found -&gt; check parent.</span><br><span class="hljs-comment">// 获取name对应的规范名称【全类名】，如果name前面有&#x27;&amp;&#x27;，则会返回&#x27;&amp;&#x27;+规范名称【全类名】</span><br><span class="hljs-type">String</span> <span class="hljs-variable">nameToLookup</span> <span class="hljs-operator">=</span> originalBeanName(name);<br><span class="hljs-comment">// 如果父工厂是AbstractBeanFactory的实例</span><br><span class="hljs-keyword">if</span> (parentBeanFactory <span class="hljs-keyword">instanceof</span> AbstractBeanFactory) &#123;<br><span class="hljs-comment">// 调用父工厂的doGetBean方法，就是该方法。【递归】</span><br><span class="hljs-keyword">return</span> ((AbstractBeanFactory) parentBeanFactory).doGetBean(<br>nameToLookup, requiredType, args, typeCheckOnly);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// Delegation to parent with explicit args.</span><br><span class="hljs-comment">// 如果有创建bean实例时要使用的参数</span><br><span class="hljs-comment">// Delegation to parent with explicit args. 使用显示参数委派给父工厂</span><br><span class="hljs-comment">// 使用父工厂获取该bean对象,通bean全类名和创建bean实例时要使用的参数</span><br><span class="hljs-keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// No args -&gt; delegate to standard getBean method.</span><br><span class="hljs-comment">// 没有创建bean实例时要使用的参数 -&gt; 委托给标准的getBean方法。</span><br><span class="hljs-comment">// 使用父工厂获取该bean对象,通bean全类名和所需的bean类型</span><br><span class="hljs-keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// 使用父工厂获取bean，通过bean全类名</span><br><span class="hljs-keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup);<br>&#125;<br>&#125;<br><span class="hljs-comment">// 如果不是做类型检查，那么表示要创建bean，此处在集合中做一个记录</span><br><span class="hljs-keyword">if</span> (!typeCheckOnly) &#123;<br><span class="hljs-comment">// 为beanName标记为已经创建（或将要创建）</span><br>markBeanAsCreated(beanName);<br>&#125;<br><br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// 此处做了BeanDefinition对象的转换，当我们从xml文件中加载beandefinition对象的时候，封装的对象是GenericBeanDefinition,</span><br><span class="hljs-comment">// 此处要做类型转换，如果是子类bean的话，会合并父类的相关属性</span><br><span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">mbd</span> <span class="hljs-operator">=</span> getMergedLocalBeanDefinition(beanName);<br><span class="hljs-comment">// 检查mbd的合法性，不合格会引发验证异常</span><br>checkMergedBeanDefinition(mbd, beanName, args);<br><br><span class="hljs-comment">// Guarantee initialization of beans that the current bean depends on.</span><br><span class="hljs-comment">// 如果存在依赖的bean的话，那么则优先实例化依赖的bean</span><br>String[] dependsOn = mbd.getDependsOn();<br><span class="hljs-keyword">if</span> (dependsOn != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// 如果存在依赖，则需要递归实例化依赖的bean</span><br><span class="hljs-keyword">for</span> (String dep : dependsOn) &#123;<br><span class="hljs-comment">// 如果beanName已注册依赖于dependentBeanName的关系</span><br><span class="hljs-keyword">if</span> (isDependent(beanName, dep)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br><span class="hljs-string">&quot;Circular depends-on relationship between &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; and &#x27;&quot;</span> + dep + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br><span class="hljs-comment">// 注册各个bean的依赖关系，方便进行销毁</span><br>registerDependentBean(dep, beanName);<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// 递归优先实例化被依赖的Bean</span><br>getBean(dep);<br>&#125;<br><span class="hljs-comment">// 捕捉为找到BeanDefinition异常：&#x27;beanName&#x27;依赖于缺少的bean&#x27;dep&#x27;</span><br><span class="hljs-keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br><span class="hljs-string">&quot;&#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; depends on missing bean &#x27;&quot;</span> + dep + <span class="hljs-string">&quot;&#x27;&quot;</span>, ex);<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Create bean instance.</span><br><span class="hljs-comment">// 创建bean的实例对象</span><br><span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br><span class="hljs-comment">// 返回以beanName的(原始)单例对象，如果尚未注册，则使用singletonFactory创建并注册一个对象:</span><br>sharedInstance = getSingleton(beanName, () -&gt; &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// 为给定的合并后BeanDefinition(和参数)创建一个bean实例</span><br><span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>&#125;<br><span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br><span class="hljs-comment">// Explicitly remove instance from singleton cache: It might have been put there</span><br><span class="hljs-comment">// eagerly by the creation process, to allow for circular reference resolution.</span><br><span class="hljs-comment">// Also remove any beans that received a temporary reference to the bean.</span><br><span class="hljs-comment">// 显示地从单例缓存中删除实例：它可能是由创建过程急切地放在那里，以允许循环引用解析。还要删除</span><br><span class="hljs-comment">// 接收到该Bean临时引用的任何Bean</span><br><span class="hljs-comment">// 销毁给定的bean。如果找到相应的一次性Bean实例，则委托给destoryBean</span><br>destroySingleton(beanName);<br><span class="hljs-comment">// 重新抛出ex</span><br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br>&#125;);<br><span class="hljs-comment">// 从beanInstance中获取公开的Bean对象，主要处理beanInstance是FactoryBean对象的情况，如果不是</span><br><span class="hljs-comment">// FactoryBean会直接返回beanInstance实例</span><br>bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>&#125;<br><span class="hljs-comment">// 原型模式的bean对象创建</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mbd.isPrototype()) &#123;<br><span class="hljs-comment">// It&#x27;s a prototype -&gt; create a new instance.</span><br><span class="hljs-comment">// 它是一个原型 -&gt; 创建一个新实例</span><br><span class="hljs-comment">// 定义prototype实例</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">prototypeInstance</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// 创建Prototype对象前的准备工作，默认实现将beanName添加到prototypesCurrentlyInCreation中</span><br>beforePrototypeCreation(beanName);<br><span class="hljs-comment">// 为mbd(和参数)创建一个bean实例</span><br>prototypeInstance = createBean(beanName, mbd, args);<br>&#125;<br><span class="hljs-keyword">finally</span> &#123;<br><span class="hljs-comment">// 创建完prototype实例后的回调，默认是将beanName从prototypesCurrentlyInCreation移除</span><br>afterPrototypeCreation(beanName);<br>&#125;<br><span class="hljs-comment">// 从beanInstance中获取公开的Bean对象，主要处理beanInstance是FactoryBean对象的情况，如果不是</span><br><span class="hljs-comment">// FactoryBean会直接返回beanInstance实例</span><br>bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);<br>&#125;<br><br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// 指定的scope上实例化bean</span><br><span class="hljs-type">String</span> <span class="hljs-variable">scopeName</span> <span class="hljs-operator">=</span> mbd.getScope();<br><span class="hljs-keyword">if</span> (!StringUtils.hasLength(scopeName)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;No scope name defined for bean ´&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br><span class="hljs-comment">// 从scopes中获取scopeName对于的Scope对象</span><br><span class="hljs-type">Scope</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.scopes.get(scopeName);<br><span class="hljs-comment">// 如果scope为null</span><br><span class="hljs-keyword">if</span> (scope == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// 抛出非法状态异常：没有名为&#x27;scopeName&#x27;的scope注册</span><br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;No Scope registered for scope name &#x27;&quot;</span> + scopeName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// 从scope中获取beanName对应的实例对象</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">scopedInstance</span> <span class="hljs-operator">=</span> scope.get(beanName, () -&gt; &#123;<br><span class="hljs-comment">// 创建Prototype对象前的准备工作，默认实现 将beanName添加到prototypesCurrentlyInCreation中</span><br>beforePrototypeCreation(beanName);<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// 为mbd(和参数)创建一个bean实例</span><br><span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>&#125;<br><span class="hljs-keyword">finally</span> &#123;<br><span class="hljs-comment">// 创建完prototype实例后的回调，默认是将beanName从prototypesCurrentlyInCreation移除</span><br>afterPrototypeCreation(beanName);<br>&#125;<br>&#125;);<br><span class="hljs-comment">// 从beanInstance中获取公开的Bean对象，主要处理beanInstance是FactoryBean对象的情况，如果不是</span><br><span class="hljs-comment">// FactoryBean会直接返回beanInstance实例</span><br>bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);<br>&#125;<br><span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;<br><span class="hljs-comment">// 捕捉非法状态异常</span><br><span class="hljs-comment">// 抛出Bean创建异常：作用域 &#x27;scopeName&#x27; 对于当前线程是不活动的；如果您打算从单个实例引用它，请考虑为此</span><br><span class="hljs-comment">// beanDefinition一个作用域代理</span><br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName,<br><span class="hljs-string">&quot;Scope &#x27;&quot;</span> + scopeName + <span class="hljs-string">&quot;&#x27; is not active for the current thread; consider &quot;</span> +<br><span class="hljs-string">&quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;</span>,<br>ex);<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br><span class="hljs-comment">// 捕捉获取Bean对象抛出的Bean异常</span><br><span class="hljs-comment">// 在Bean创建失败后，对缓存的元数据执行适当的清理</span><br>cleanupAfterBeanCreationFailure(beanName);<br><span class="hljs-comment">// 重新抛出ex</span><br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Check if required type matches the type of the actual bean instance.</span><br><span class="hljs-comment">// 检查requiredType是否与实际Bean实例的类型匹配</span><br><span class="hljs-comment">// 如果requiredType不为null&amp;&amp;bean不是requiredType的实例</span><br><span class="hljs-keyword">if</span> (requiredType != <span class="hljs-literal">null</span> &amp;&amp; !requiredType.isInstance(bean)) &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// 获取此BeanFactory使用的类型转换器，将bean转换为requiredType</span><br><span class="hljs-type">T</span> <span class="hljs-variable">convertedBean</span> <span class="hljs-operator">=</span> getTypeConverter().convertIfNecessary(bean, requiredType);<br><span class="hljs-comment">// 如果convertedBean为null</span><br><span class="hljs-keyword">if</span> (convertedBean == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// 抛出Bean不是必要类型的异常</span><br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanNotOfRequiredTypeException</span>(name, requiredType, bean.getClass());<br>&#125;<br><span class="hljs-comment">// 返回convertedBean</span><br><span class="hljs-keyword">return</span> convertedBean;<br>&#125;<br><span class="hljs-keyword">catch</span> (TypeMismatchException ex) &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Failed to convert bean &#x27;&quot;</span> + name + <span class="hljs-string">&quot;&#x27; to required type &#x27;&quot;</span> +<br>ClassUtils.getQualifiedName(requiredType) + <span class="hljs-string">&quot;&#x27;&quot;</span>, ex);<br>&#125;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanNotOfRequiredTypeException</span>(name, requiredType, bean.getClass());<br>&#125;<br>&#125;<br><span class="hljs-comment">// 将bean返回出去</span><br><span class="hljs-keyword">return</span> (T) bean;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">getSingleton</span><span class="hljs-params">(String beanName, <span class="hljs-type">boolean</span> allowEarlyReference)</span> &#123;<br><span class="hljs-comment">// Quick check for existing instance without full singleton lock</span><br><span class="hljs-comment">// 从单例对象缓存中获取beanName对应的单例对象</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">singletonObject</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.singletonObjects.get(beanName);<br><span class="hljs-comment">// 如果单例对象缓存中没有，并且该beanName对应的单例bean正在创建中</span><br><span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;<br><span class="hljs-comment">//从早期单例对象缓存中获取单例对象（之所称成为早期单例对象，是因为earlySingletonObjects里</span><br><span class="hljs-comment">// 的对象的都是通过提前曝光的ObjectFactory创建出来的，还未进行属性填充等操作）</span><br>singletonObject = <span class="hljs-built_in">this</span>.earlySingletonObjects.get(beanName);<br><span class="hljs-comment">// 如果在早期单例对象缓存中也没有，并且允许创建早期单例对象引用</span><br><span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span> &amp;&amp; allowEarlyReference) &#123;<br><span class="hljs-comment">// 如果为空，则锁定全局变量并进行处理</span><br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.singletonObjects) &#123;<br><span class="hljs-comment">// Consistent creation of early reference within full singleton lock</span><br>singletonObject = <span class="hljs-built_in">this</span>.singletonObjects.get(beanName);<br><span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span>) &#123;<br>singletonObject = <span class="hljs-built_in">this</span>.earlySingletonObjects.get(beanName);<br><span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// 当某些方法需要提前初始化的时候则会调用addSingletonFactory方法将对应的ObjectFactory初始化策略存储在singletonFactories</span><br>ObjectFactory&lt;?&gt; singletonFactory = <span class="hljs-built_in">this</span>.singletonFactories.get(beanName);<br><span class="hljs-keyword">if</span> (singletonFactory != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// 如果存在单例对象工厂，则通过工厂创建一个单例对象</span><br>singletonObject = singletonFactory.getObject();<br><span class="hljs-comment">// 记录在缓存中，二级缓存和三级缓存的对象不能同时存在</span><br><span class="hljs-built_in">this</span>.earlySingletonObjects.put(beanName, singletonObject);<br><span class="hljs-comment">// 从三级缓存中移除</span><br><span class="hljs-built_in">this</span>.singletonFactories.remove(beanName);<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> singletonObject;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="循环依赖"><a href="#循环依赖" class="headerlink" title="循环依赖"></a>循环依赖</h2><p>三级缓存 </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/** Cache of singleton objects: bean name to bean instance. */</span><br><span class="hljs-comment">/** 单例对象的缓存：bean 名称到 bean 实例。 */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">256</span>);<br><br><span class="hljs-comment">/** Cache of singleton factories: bean name to ObjectFactory. */</span><br><span class="hljs-comment">/** 单例工厂的缓存：对象工厂的 bean 名称。 */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">16</span>);<br><br><span class="hljs-comment">/** Cache of early singleton objects: bean name to bean instance. */</span><br><span class="hljs-comment">/** 早期单例对象的缓存：bean 名称到 bean 实例。 */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">16</span>);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">0</span> = &#123;ApplicationContextAwareProcessor@<span class="hljs-number">8586</span>&#125; <br><span class="hljs-number">1</span> = &#123;WebApplicationContextServletContextAwareProcessor@<span class="hljs-number">8593</span>&#125; <br><span class="hljs-number">2</span> = &#123;ConfigurationClassPostProcessor$ImportAwareBeanPostProcessor@<span class="hljs-number">8600</span>&#125; <br><span class="hljs-number">3</span> = &#123;PostProcessorRegistrationDelegate$BeanPostProcessorChecker@<span class="hljs-number">8613</span>&#125; <br><span class="hljs-number">4</span> = &#123;ConfigurationPropertiesBindingPostProcessor@<span class="hljs-number">8757</span>&#125; <br><span class="hljs-number">5</span> = &#123;RabbitConnectionFactoryMetricsPostProcessor@<span class="hljs-number">8764</span>&#125; <br><span class="hljs-number">6</span> = &#123;AnnotationAwareAspectJAutoProxyCreator@<span class="hljs-number">8771</span>&#125; <span class="hljs-string">&quot;proxyTargetClass=true; optimize=false; opaque=false; exposeProxy=false; frozen=false&quot;</span><br><span class="hljs-number">7</span> = &#123;MethodValidationPostProcessor@<span class="hljs-number">8796</span>&#125; <span class="hljs-string">&quot;proxyTargetClass=true; optimize=false; opaque=false; exposeProxy=false; frozen=false&quot;</span><br><span class="hljs-number">8</span> = &#123;RabbitListenerAnnotationBeanPostProcessor@<span class="hljs-number">8803</span>&#125; <br><span class="hljs-number">9</span> = &#123;PersistenceExceptionTranslationPostProcessor@<span class="hljs-number">8810</span>&#125; <span class="hljs-string">&quot;proxyTargetClass=true; optimize=false; opaque=false; exposeProxy=false; frozen=false&quot;</span><br><span class="hljs-number">10</span> = &#123;WebServerFactoryCustomizerBeanPostProcessor@<span class="hljs-number">8817</span>&#125; <br><span class="hljs-number">11</span> = &#123;ErrorPageRegistrarBeanPostProcessor@<span class="hljs-number">8824</span>&#125; <br><span class="hljs-number">12</span> = &#123;HealthEndpointConfiguration$HealthEndpointGroupsBeanPostProcessor@<span class="hljs-number">8832</span>&#125; <br><span class="hljs-number">13</span> = &#123;MessagingAnnotationPostProcessor@<span class="hljs-number">8839</span>&#125; <br><span class="hljs-number">14</span> = &#123;StreamListenerAnnotationBeanPostProcessor@<span class="hljs-number">8847</span>&#125; <br><span class="hljs-number">15</span> = &#123;MeterRegistryPostProcessor@<span class="hljs-number">8854</span>&#125; <br><span class="hljs-number">16</span> = &#123;IntegrationManagementConfigurer@<span class="hljs-number">8861</span>&#125; <br><span class="hljs-number">17</span> = &#123;ConfigurationPropertiesBeans@<span class="hljs-number">8868</span>&#125; <br><span class="hljs-number">18</span> = &#123;TraceRestTemplateBeanPostProcessor@<span class="hljs-number">8875</span>&#125; <br><span class="hljs-number">19</span> = &#123;FeignContextBeanPostProcessor@<span class="hljs-number">8882</span>&#125; <br><span class="hljs-number">20</span> = &#123;ExecutorBeanPostProcessor@<span class="hljs-number">8889</span>&#125; <br><span class="hljs-number">21</span> = &#123;SleuthRabbitBeanPostProcessor@<span class="hljs-number">8896</span>&#125; <br><span class="hljs-number">22</span> = &#123;IntegrationFlowBeanPostProcessor@<span class="hljs-number">8903</span>&#125; <br><span class="hljs-number">23</span> = &#123;BaseIntegrationFlowDefinition$ReplyProducerCleaner@<span class="hljs-number">8910</span>&#125; <br><span class="hljs-number">24</span> = &#123;GlobalChannelInterceptorProcessor@<span class="hljs-number">8917</span>&#125; <br><span class="hljs-number">25</span> = &#123;CommonAnnotationBeanPostProcessor@<span class="hljs-number">8924</span>&#125; <br><span class="hljs-number">26</span> = &#123;AutowiredAnnotationBeanPostProcessor@<span class="hljs-number">8946</span>&#125; <br><span class="hljs-number">27</span> = &#123;ApplicationListenerDetector@<span class="hljs-number">8966</span>&#125; <br></code></pre></td></tr></table></figure><p>AutowiredAnnotationBeanPostProcessor</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> PropertyValues <span class="hljs-title function_">postProcessProperties</span><span class="hljs-params">(PropertyValues pvs, Object bean, String beanName)</span> &#123;<br><span class="hljs-type">InjectionMetadata</span> <span class="hljs-variable">metadata</span> <span class="hljs-operator">=</span> findAutowiringMetadata(beanName, bean.getClass(), pvs);<br><span class="hljs-keyword">try</span> &#123;<br>metadata.inject(bean, beanName, pvs);<br>&#125;<br><span class="hljs-keyword">catch</span> (BeanCreationException ex) &#123;<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName, <span class="hljs-string">&quot;Injection of autowired dependencies failed&quot;</span>, ex);<br>&#125;<br><span class="hljs-keyword">return</span> pvs;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inject</span><span class="hljs-params">(Object bean, <span class="hljs-meta">@Nullable</span> String beanName, <span class="hljs-meta">@Nullable</span> PropertyValues pvs)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br><span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> (Field) <span class="hljs-built_in">this</span>.member;<br>Object value;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.cached) &#123;<br>value = resolvedCachedArgument(beanName, <span class="hljs-built_in">this</span>.cachedFieldValue);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-type">DependencyDescriptor</span> <span class="hljs-variable">desc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DependencyDescriptor</span>(field, <span class="hljs-built_in">this</span>.required);<br>desc.setContainingClass(bean.getClass());<br>Set&lt;String&gt; autowiredBeanNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;(<span class="hljs-number">1</span>);<br>Assert.state(beanFactory != <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;No BeanFactory available&quot;</span>);<br><span class="hljs-type">TypeConverter</span> <span class="hljs-variable">typeConverter</span> <span class="hljs-operator">=</span> beanFactory.getTypeConverter();<br><span class="hljs-keyword">try</span> &#123;<br>value = beanFactory.resolveDependency(desc, beanName, autowiredBeanNames, typeConverter);<br>&#125;<br><span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsatisfiedDependencyException</span>(<span class="hljs-literal">null</span>, beanName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">InjectionPoint</span>(field), ex);<br>&#125;<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.cached) &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">cachedFieldValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span> || <span class="hljs-built_in">this</span>.required) &#123;<br>cachedFieldValue = desc;<br>registerDependentBeans(beanName, autowiredBeanNames);<br><span class="hljs-keyword">if</span> (autowiredBeanNames.size() == <span class="hljs-number">1</span>) &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">autowiredBeanName</span> <span class="hljs-operator">=</span> autowiredBeanNames.iterator().next();<br><span class="hljs-keyword">if</span> (beanFactory.containsBean(autowiredBeanName) &amp;&amp;<br>beanFactory.isTypeMatch(autowiredBeanName, field.getType())) &#123;<br>cachedFieldValue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShortcutDependencyDescriptor</span>(<br>desc, autowiredBeanName, field.getType());<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-built_in">this</span>.cachedFieldValue = cachedFieldValue;<br><span class="hljs-built_in">this</span>.cached = <span class="hljs-literal">true</span>;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>ReflectionUtils.makeAccessible(field);<br>field.set(bean, value);<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">resolveDependency</span><span class="hljs-params">(DependencyDescriptor descriptor, <span class="hljs-meta">@Nullable</span> String requestingBeanName,</span><br><span class="hljs-params"><span class="hljs-meta">@Nullable</span> Set&lt;String&gt; autowiredBeanNames, <span class="hljs-meta">@Nullable</span> TypeConverter typeConverter)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><br>descriptor.initParameterNameDiscovery(getParameterNameDiscoverer());<br><span class="hljs-keyword">if</span> (Optional.class == descriptor.getDependencyType()) &#123;<br><span class="hljs-keyword">return</span> createOptionalDependency(descriptor, requestingBeanName);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ObjectFactory.class == descriptor.getDependencyType() ||<br>ObjectProvider.class == descriptor.getDependencyType()) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DependencyObjectProvider</span>(descriptor, requestingBeanName);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (javaxInjectProviderClass == descriptor.getDependencyType()) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jsr330Factory</span>().createDependencyProvider(descriptor, requestingBeanName);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> getAutowireCandidateResolver().getLazyResolutionProxyIfNecessary(<br>descriptor, requestingBeanName);<br><span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) &#123;<br>result = doResolveDependency(descriptor, requestingBeanName, autowiredBeanNames, typeConverter);<br>&#125;<br><span class="hljs-keyword">return</span> result;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">doResolveDependency</span><span class="hljs-params">(DependencyDescriptor descriptor, <span class="hljs-meta">@Nullable</span> String beanName,</span><br><span class="hljs-params"><span class="hljs-meta">@Nullable</span> Set&lt;String&gt; autowiredBeanNames, <span class="hljs-meta">@Nullable</span> TypeConverter typeConverter)</span> <span class="hljs-keyword">throws</span> BeansException <br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">instanceCandidate = descriptor.resolveCandidate(autowiredBeanName, type, <span class="hljs-built_in">this</span>);<br></code></pre></td></tr></table></figure><p>这里会调用beanFactory.getBean(“Bservice”)，创建Bservice的bean,中间还会调依赖注入Aservice，这时二级缓存（早期的缓存中）中会有Aservice，当Bservice创建完后，Bservice是完整的，回到Aservice的创建过程，Aservice从二级缓存中删除，放入一级缓存中。</p><p>不能解决循环依赖：</p><p>1.通过构造器注入的不能解决</p><p>2.非单例的不能解决</p><p><img src="/.com//%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96.jpg" alt="循环依赖"></p><h2 id="三级缓存有啥用"><a href="#三级缓存有啥用" class="headerlink" title="三级缓存有啥用"></a>三级缓存有啥用</h2><p>三级缓存是用来存储代理Bean,当目标对象需要代理工作创建时，放入三级缓存中，最终赋值好的Bean放入一级缓存中。</p>]]></content>
    
    
    <categories>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring boot项目搭建</title>
    <link href="/2019/09/03/spring/spring_boot%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA/"/>
    <url>/2019/09/03/spring/spring_boot%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<h3 id="一、开发环境的安装"><a href="#一、开发环境的安装" class="headerlink" title="一、开发环境的安装"></a>一、开发环境的安装</h3><p>JDK maven IDEA</p><p>idea 安装 lombok、free mybatis plugin插件</p><h3 id="二、IDEA创建spring-boot项目"><a href="#二、IDEA创建spring-boot项目" class="headerlink" title="二、IDEA创建spring boot项目"></a>二、IDEA创建spring boot项目</h3><p>File-&gt;new-&gt;project</p><p>选择spring initializr -&gt;next</p><p>spring initializr project settings -&gt;修改你要修改的-&gt;next</p><p>选择依赖:</p><p>spring boot devtools</p><p>lombok</p><p>spring configuration processor</p><p>spring web</p><p>mysql driver</p><p>mybatis framework</p><p>选择完依赖后next</p><p>选择项目存储目录，然后点击完成</p><h3 id="三、添加druid连接池"><a href="#三、添加druid连接池" class="headerlink" title="三、添加druid连接池"></a>三、添加druid连接池</h3><p>pom.xml添加至dependencies</p><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>版本号<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>application.properties 添加数据库配置</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.datasource.druid.url</span>=<span class="hljs-string">jdbc:mysql://127.0.0.1:3306/crm?useSSL=true\</span><br><span class="hljs-string">  &amp;useUnicode=true\</span><br><span class="hljs-string">  &amp;characterEncoding=UTF-8\</span><br><span class="hljs-string">  &amp;useServerPrepStmts=true\</span><br><span class="hljs-string">  &amp;serverTimezone=Asia/Shanghai\</span><br><span class="hljs-string">  &amp;zeroDateTimeBehavior=CONVERT_TO_NULL</span><br><span class="hljs-attr">spring.datasource.druid.username</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">spring.datasource.druid.password</span>=<span class="hljs-string">你的数据库密码</span><br><span class="hljs-attr">spring.datasource.driver-class-name</span>=<span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br><br><span class="hljs-attr">mybatis.type-aliases-package</span>=<span class="hljs-string">com.example.demo.dao</span><br><span class="hljs-attr">mybatis.mapper-locations</span>=<span class="hljs-string">classpath:mapper/*.xml</span><br></code></pre></td></tr></table></figure><p>在启动类添加</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@MapperScan(&quot;com.example.demo.dao&quot;)</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(DemoApplication.class, args);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="四、编写model、dao、mapper、service、controller"><a href="#四、编写model、dao、mapper、service、controller" class="headerlink" title="四、编写model、dao、mapper、service、controller"></a>四、编写model、dao、mapper、service、controller</h3><p>创建database，连接并生成代码 model、dao、mapper</p><p>model</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * crm_student</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> </span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CrmStudent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> Integer id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 姓名</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 性别</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String gender;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>mapper</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.example.demo.dao.CrmStudentDao&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;BaseResultMap&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;com.example.demo.model.CrmStudent&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;INTEGER&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;VARCHAR&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;name&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;gender&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;VARCHAR&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;gender&quot;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span><br>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insert&quot;</span> <span class="hljs-attr">keyColumn</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">keyProperty</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;com.example.demo.model.CrmStudent&quot;</span> <span class="hljs-attr">useGeneratedKeys</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>    insert into crm_student (`name`, gender)<br>    values (#&#123;name,jdbcType=VARCHAR&#125;, #&#123;gender,jdbcType=VARCHAR&#125;)<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure><p>dao</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CrmStudentDao</span> &#123;<br>  <br>    <span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(CrmStudent record)</span>;<br>  <br>&#125;<br></code></pre></td></tr></table></figure><p>service</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CrmStudentService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CrmStudentDao crmStudentDao;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(CrmStudent crmStudent)</span> &#123;<br>        crmStudentDao.insert(crmStudent);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/crmstudent&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CrmStudentController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CrmStudentService crmStudentService;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/save&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> CrmStudent crmStudent)</span> &#123;<br>        crmStudentService.save(crmStudent);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="五、启动并测试"><a href="#五、启动并测试" class="headerlink" title="五、启动并测试"></a>五、启动并测试</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">8080</span><span class="hljs-regexp">/crmstudent/</span>save<br>POST<br>Content-Type : application/json<br>&#123;<br><span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;abc&quot;</span>,<br><span class="hljs-string">&quot;gender&quot;</span> : <span class="hljs-string">&quot;男&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>spring boot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring boot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring AOP</title>
    <link href="/2019/09/03/spring/spring%20AOP/"/>
    <url>/2019/09/03/spring/spring%20AOP/</url>
    
    <content type="html"><![CDATA[<h1 id="AOP面向切面编程"><a href="#AOP面向切面编程" class="headerlink" title="AOP面向切面编程"></a>AOP面向切面编程</h1><p>面向切面编程是将程序抽象成各个切面。</p><p>AOP 要达到的效果是，保证开发者不修改源代码的前提下，去为系统中的业务组件添加某种通用功能。</p><p>用在哪里：日志、事务</p><p>AOP实现分类：</p><ul><li>静态 AOP 实现， AOP 框架在编译阶段对程序源代码进行修改，生成了静态的 AOP 代理类（生成的 *.class 文件已经被改掉了，需要使用特定的编译器），比如 AspectJ。</li><li>动态 AOP 实现， AOP 框架在运行阶段对动态生成代理对象（在内存中以 JDK 动态代理，或 CGlib 动态地生成 AOP 代理类），如 SpringAOP。</li></ul><p>AOP术语</p><ul><li>通知（Advice）: AOP 框架中的增强处理。通知描述了切面何时执行以及如何执行增强处理。</li><li>连接点（join point）: 连接点表示应用执行过程中能够插入切面的一个点，这个点可以是方法的调用、异常的抛出。在 Spring AOP 中，连接点总是方法的调用。</li><li>切点（PointCut）: 可以插入增强处理的连接点。</li><li>切面（Aspect）: 切面是通知和切点的结合。</li><li>引入（Introduction）：引入允许我们向现有的类添加新的方法或者属性。</li><li>织入（Weaving）: 将增强处理添加到目标对象中，并创建一个被增强的对象，这个过程就是织入。</li></ul><h1 id="Spring中有哪些不同的通知类型"><a href="#Spring中有哪些不同的通知类型" class="headerlink" title="Spring中有哪些不同的通知类型"></a>Spring中有哪些不同的通知类型</h1><ol><li>前置通知(Before Advice): 在连接点之前执行的Advice，不过除非它抛出异常，否则没有能力中断执行流。使用 <code>@Before</code> 注解使用这个Advice。</li><li>返回之后通知(After Retuning Advice): 在连接点正常结束之后执行的Advice。例如，如果一个方法没有抛出异常正常返回。通过 <code>@AfterReturning</code> 关注使用它。</li><li>抛出（异常）后执行通知(After Throwing Advice): 如果一个方法通过抛出异常来退出的话，这个Advice就会被执行。通用 <code>@AfterThrowing</code> 注解来使用。</li><li>后置通知(After Advice): 无论连接点是通过什么方式退出的(正常返回或者抛出异常)都会执行在结束后执行这些Advice。通过 <code>@After</code> 注解使用。</li><li>围绕通知(Around Advice): 围绕连接点执行的Advice，就你一个方法调用。这是最强大的Advice。通过 <code>@Around</code>注解使用。</li></ol><h1 id="spring的单例的bean有线程安全的问题吗？"><a href="#spring的单例的bean有线程安全的问题吗？" class="headerlink" title="spring的单例的bean有线程安全的问题吗？"></a>spring的单例的bean有线程安全的问题吗？</h1><p>默认bean是无状态的，但是破坏了无状态就会有线程安全问题。</p><h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><h2 id="bean的代理（事务）"><a href="#bean的代理（事务）" class="headerlink" title="bean的代理（事务）"></a>bean的代理（事务）</h2><p>从IOC那里已经跟了一些源码了，AOP是在IOC创建bean时做的工作。</p><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">doCreateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span><br><span class="hljs-keyword">throws</span> BeanCreationException <br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">populateBean(beanName, mbd, instanceWrapper);<br><span class="hljs-comment">// 在填弃Bean后 初始化bean中</span><br>exposedObject = initializeBean(beanName, exposedObject, mbd);<br></code></pre></td></tr></table></figure><p>initializeBean方法中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 调用postProcessors的后置处理器</span><br>wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">applyBeanPostProcessorsAfterInitialization</span><span class="hljs-params">(Object existingBean, String beanName)</span><br><span class="hljs-keyword">throws</span> BeansException &#123;<br><br><span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> existingBean;<br><span class="hljs-keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> processor.postProcessAfterInitialization(result, beanName);<br><span class="hljs-keyword">if</span> (current == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span> result;<br>&#125;<br>result = current;<br>&#125;<br><span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">AnnotationAwareAspectJAutoProxyCreator类时<br>  <span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessAfterInitialization</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object bean, String beanName)</span> &#123;<br><span class="hljs-keyword">if</span> (bean != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> getCacheKey(bean.getClass(), beanName);<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.earlyProxyReferences.remove(cacheKey) != bean) &#123;<br><span class="hljs-keyword">return</span> wrapIfNecessary(bean, beanName, cacheKey);<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> bean;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">wrapIfNecessary</span><span class="hljs-params">(Object bean, String beanName, Object cacheKey)</span> &#123;<br><span class="hljs-keyword">if</span> (StringUtils.hasLength(beanName) &amp;&amp; <span class="hljs-built_in">this</span>.targetSourcedBeans.contains(beanName)) &#123;<br><span class="hljs-keyword">return</span> bean;<br>&#125;<br><span class="hljs-keyword">if</span> (Boolean.FALSE.equals(<span class="hljs-built_in">this</span>.advisedBeans.get(cacheKey))) &#123;<br><span class="hljs-keyword">return</span> bean;<br>&#125;<br><span class="hljs-keyword">if</span> (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;<br><span class="hljs-built_in">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);<br><span class="hljs-keyword">return</span> bean;<br>&#125;<br><br><span class="hljs-comment">// Create proxy if we have advice.</span><br>  <span class="hljs-comment">// 这里就获取到 事务的TransactionInterceptor</span><br>Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, <span class="hljs-literal">null</span>);<br><span class="hljs-keyword">if</span> (specificInterceptors != DO_NOT_PROXY) &#123;<br><span class="hljs-built_in">this</span>.advisedBeans.put(cacheKey, Boolean.TRUE);<br><span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> createProxy(<br>bean.getClass(), beanName, specificInterceptors, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SingletonTargetSource</span>(bean));<br><span class="hljs-built_in">this</span>.proxyTypes.put(cacheKey, proxy.getClass());<br><span class="hljs-keyword">return</span> proxy;<br>&#125;<br><br><span class="hljs-built_in">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);<br><span class="hljs-keyword">return</span> bean;<br>&#125;<br></code></pre></td></tr></table></figure><p>org.springframework.transaction.interceptor.BeanFactoryTransactionAttributeSourceAdvisor: advice org.springframework.transaction.interceptor.TransactionInterceptor@24b3f778</p><p>到这里返回的bean就是AOP代理的AService了。</p><h2 id="调用带有事务的方法"><a href="#调用带有事务的方法" class="headerlink" title="调用带有事务的方法"></a>调用带有事务的方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">CglibAopProxy<br>DynamicAdvisedInterceptor<br>intercept 方法<br>  <span class="hljs-comment">// 获取所有拦截器及动态拦截器通知</span><br>  <span class="hljs-comment">// 就返回了TransactionInterceptor</span><br>  List&lt;Object&gt; chain = <span class="hljs-built_in">this</span>.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">proceed</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br><span class="hljs-comment">// We start with an index of -1 and increment early.</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.currentInterceptorIndex == <span class="hljs-built_in">this</span>.interceptorsAndDynamicMethodMatchers.size() - <span class="hljs-number">1</span>) &#123;<br><span class="hljs-keyword">return</span> invokeJoinpoint();<br>&#125;<br><br><span class="hljs-type">Object</span> <span class="hljs-variable">interceptorOrInterceptionAdvice</span> <span class="hljs-operator">=</span><br><span class="hljs-built_in">this</span>.interceptorsAndDynamicMethodMatchers.get(++<span class="hljs-built_in">this</span>.currentInterceptorIndex);<br><span class="hljs-keyword">if</span> (interceptorOrInterceptionAdvice <span class="hljs-keyword">instanceof</span> InterceptorAndDynamicMethodMatcher) &#123;<br><span class="hljs-comment">// Evaluate dynamic method matcher here: static part will already have</span><br><span class="hljs-comment">// been evaluated and found to match.</span><br><span class="hljs-type">InterceptorAndDynamicMethodMatcher</span> <span class="hljs-variable">dm</span> <span class="hljs-operator">=</span><br>(InterceptorAndDynamicMethodMatcher) interceptorOrInterceptionAdvice;<br>Class&lt;?&gt; targetClass = (<span class="hljs-built_in">this</span>.targetClass != <span class="hljs-literal">null</span> ? <span class="hljs-built_in">this</span>.targetClass : <span class="hljs-built_in">this</span>.method.getDeclaringClass());<br><span class="hljs-keyword">if</span> (dm.methodMatcher.matches(<span class="hljs-built_in">this</span>.method, targetClass, <span class="hljs-built_in">this</span>.arguments)) &#123;<br><span class="hljs-keyword">return</span> dm.interceptor.invoke(<span class="hljs-built_in">this</span>);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// Dynamic matching failed.</span><br><span class="hljs-comment">// Skip this interceptor and invoke the next in the chain.</span><br><span class="hljs-keyword">return</span> proceed();<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// It&#x27;s an interceptor, so we just invoke it: The pointcut will have</span><br><span class="hljs-comment">// been evaluated statically before this object was constructed.</span><br>      <span class="hljs-comment">// 这里会调用TransactionInterceptor的invoke方法</span><br><span class="hljs-keyword">return</span> ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(<span class="hljs-built_in">this</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(MethodInvocation invocation)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br><span class="hljs-comment">// Work out the target class: may be &#123;@code null&#125;.</span><br><span class="hljs-comment">// The TransactionAttributeSource should be passed the target class</span><br><span class="hljs-comment">// as well as the method, which may be from an interface.</span><br>Class&lt;?&gt; targetClass = (invocation.getThis() != <span class="hljs-literal">null</span> ? AopUtils.getTargetClass(invocation.getThis()) : <span class="hljs-literal">null</span>);<br><br><span class="hljs-comment">// Adapt to TransactionAspectSupport&#x27;s invokeWithinTransaction...</span><br><span class="hljs-keyword">return</span> invokeWithinTransaction(invocation.getMethod(), targetClass, invocation::proceed);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">invokeWithinTransaction</span><span class="hljs-params">(Method method, <span class="hljs-meta">@Nullable</span> Class&lt;?&gt; targetClass,</span><br><span class="hljs-params"><span class="hljs-keyword">final</span> InvocationCallback invocation)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br><br><span class="hljs-comment">// If the transaction attribute is null, the method is non-transactional.</span><br><span class="hljs-type">TransactionAttributeSource</span> <span class="hljs-variable">tas</span> <span class="hljs-operator">=</span> getTransactionAttributeSource();<br><span class="hljs-keyword">final</span> <span class="hljs-type">TransactionAttribute</span> <span class="hljs-variable">txAttr</span> <span class="hljs-operator">=</span> (tas != <span class="hljs-literal">null</span> ? tas.getTransactionAttribute(method, targetClass) : <span class="hljs-literal">null</span>);<br><span class="hljs-comment">// 获取事务管理器</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">TransactionManager</span> <span class="hljs-variable">tm</span> <span class="hljs-operator">=</span> determineTransactionManager(txAttr);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.reactiveAdapterRegistry != <span class="hljs-literal">null</span> &amp;&amp; tm <span class="hljs-keyword">instanceof</span> ReactiveTransactionManager) &#123;<br><span class="hljs-type">ReactiveTransactionSupport</span> <span class="hljs-variable">txSupport</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.transactionSupportCache.computeIfAbsent(method, key -&gt; &#123;<br><span class="hljs-keyword">if</span> (KotlinDetector.isKotlinType(method.getDeclaringClass()) &amp;&amp; KotlinDelegate.isSuspend(method)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionUsageException</span>(<br><span class="hljs-string">&quot;Unsupported annotated transaction on suspending function detected: &quot;</span> + method +<br><span class="hljs-string">&quot;. Use TransactionalOperator.transactional extensions instead.&quot;</span>);<br>&#125;<br><span class="hljs-type">ReactiveAdapter</span> <span class="hljs-variable">adapter</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.reactiveAdapterRegistry.getAdapter(method.getReturnType());<br><span class="hljs-keyword">if</span> (adapter == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Cannot apply reactive transaction to non-reactive return type: &quot;</span> +<br>method.getReturnType());<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReactiveTransactionSupport</span>(adapter);<br>&#125;);<br><span class="hljs-keyword">return</span> txSupport.invokeWithinTransaction(<br>method, targetClass, invocation, txAttr, (ReactiveTransactionManager) tm);<br>&#125;<br><br><span class="hljs-type">PlatformTransactionManager</span> <span class="hljs-variable">ptm</span> <span class="hljs-operator">=</span> asPlatformTransactionManager(tm);<br><span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">joinpointIdentification</span> <span class="hljs-operator">=</span> methodIdentification(method, targetClass, txAttr);<br><br><span class="hljs-keyword">if</span> (txAttr == <span class="hljs-literal">null</span> || !(ptm <span class="hljs-keyword">instanceof</span> CallbackPreferringPlatformTransactionManager)) &#123;<br><span class="hljs-comment">// Standard transaction demarcation with getTransaction and commit/rollback calls.</span><br><span class="hljs-type">TransactionInfo</span> <span class="hljs-variable">txInfo</span> <span class="hljs-operator">=</span> createTransactionIfNecessary(ptm, txAttr, joinpointIdentification);<br><br>Object retVal;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// This is an around advice: Invoke the next interceptor in the chain.</span><br><span class="hljs-comment">// This will normally result in a target object being invoked.</span><br>retVal = invocation.proceedWithInvocation();<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-comment">// target invocation exception</span><br>completeTransactionAfterThrowing(txInfo, ex);<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br><span class="hljs-keyword">finally</span> &#123;<br>cleanupTransactionInfo(txInfo);<br>&#125;<br><br><span class="hljs-keyword">if</span> (retVal != <span class="hljs-literal">null</span> &amp;&amp; vavrPresent &amp;&amp; VavrDelegate.isVavrTry(retVal)) &#123;<br><span class="hljs-comment">// Set rollback-only in case of Vavr failure matching our rollback rules...</span><br><span class="hljs-type">TransactionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> txInfo.getTransactionStatus();<br><span class="hljs-keyword">if</span> (status != <span class="hljs-literal">null</span> &amp;&amp; txAttr != <span class="hljs-literal">null</span>) &#123;<br>retVal = VavrDelegate.evaluateTryFailure(retVal, txAttr, status);<br>&#125;<br>&#125;<br><br>commitTransactionAfterReturning(txInfo);<br><span class="hljs-keyword">return</span> retVal;<br>&#125;<br><br><span class="hljs-keyword">else</span> &#123;<br>Object result;<br><span class="hljs-keyword">final</span> <span class="hljs-type">ThrowableHolder</span> <span class="hljs-variable">throwableHolder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThrowableHolder</span>();<br><br><span class="hljs-comment">// It&#x27;s a CallbackPreferringPlatformTransactionManager: pass a TransactionCallback in.</span><br><span class="hljs-keyword">try</span> &#123;<br>result = ((CallbackPreferringPlatformTransactionManager) ptm).execute(txAttr, status -&gt; &#123;<br><span class="hljs-type">TransactionInfo</span> <span class="hljs-variable">txInfo</span> <span class="hljs-operator">=</span> prepareTransactionInfo(ptm, txAttr, joinpointIdentification, status);<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">retVal</span> <span class="hljs-operator">=</span> invocation.proceedWithInvocation();<br><span class="hljs-keyword">if</span> (retVal != <span class="hljs-literal">null</span> &amp;&amp; vavrPresent &amp;&amp; VavrDelegate.isVavrTry(retVal)) &#123;<br><span class="hljs-comment">// Set rollback-only in case of Vavr failure matching our rollback rules...</span><br>retVal = VavrDelegate.evaluateTryFailure(retVal, txAttr, status);<br>&#125;<br><span class="hljs-keyword">return</span> retVal;<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">if</span> (txAttr.rollbackOn(ex)) &#123;<br><span class="hljs-comment">// A RuntimeException: will lead to a rollback.</span><br><span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> RuntimeException) &#123;<br><span class="hljs-keyword">throw</span> (RuntimeException) ex;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThrowableHolderException</span>(ex);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// A normal return value: will lead to a commit.</span><br>throwableHolder.throwable = ex;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br>&#125;<br><span class="hljs-keyword">finally</span> &#123;<br>cleanupTransactionInfo(txInfo);<br>&#125;<br>&#125;);<br>&#125;<br><span class="hljs-keyword">catch</span> (ThrowableHolderException ex) &#123;<br><span class="hljs-keyword">throw</span> ex.getCause();<br>&#125;<br><span class="hljs-keyword">catch</span> (TransactionSystemException ex2) &#123;<br><span class="hljs-keyword">if</span> (throwableHolder.throwable != <span class="hljs-literal">null</span>) &#123;<br>logger.error(<span class="hljs-string">&quot;Application exception overridden by commit exception&quot;</span>, throwableHolder.throwable);<br>ex2.initApplicationException(throwableHolder.throwable);<br>&#125;<br><span class="hljs-keyword">throw</span> ex2;<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex2) &#123;<br><span class="hljs-keyword">if</span> (throwableHolder.throwable != <span class="hljs-literal">null</span>) &#123;<br>logger.error(<span class="hljs-string">&quot;Application exception overridden by commit exception&quot;</span>, throwableHolder.throwable);<br>&#125;<br><span class="hljs-keyword">throw</span> ex2;<br>&#125;<br><br><span class="hljs-comment">// Check result state: It might indicate a Throwable to rethrow.</span><br><span class="hljs-keyword">if</span> (throwableHolder.throwable != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> throwableHolder.throwable;<br>&#125;<br><span class="hljs-keyword">return</span> result;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>JDBC事务写法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> openConnection();<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// 关闭自动提交:</span><br>    conn.setAutoCommit(<span class="hljs-literal">false</span>);<br>    <span class="hljs-comment">// 执行多条SQL语句:</span><br>    insert(); update(); delete();<br>    <span class="hljs-comment">// 提交事务:</span><br>    conn.commit();<br>&#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>    <span class="hljs-comment">// 回滚事务:</span><br>    conn.rollback();<br>&#125; <span class="hljs-keyword">finally</span> &#123;<br>    conn.setAutoCommit(<span class="hljs-literal">true</span>);<br>    conn.close();<br>&#125;<br></code></pre></td></tr></table></figure><p>同样上面的invokeWithinTransaction也相当于同样的代码。</p>]]></content>
    
    
    <categories>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring_bean的装配方式</title>
    <link href="/2019/09/03/spring/spring_bean%E7%9A%84%E8%A3%85%E9%85%8D%E6%96%B9%E5%BC%8F/"/>
    <url>/2019/09/03/spring/spring_bean%E7%9A%84%E8%A3%85%E9%85%8D%E6%96%B9%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="什么是spring-bean装配"><a href="#什么是spring-bean装配" class="headerlink" title="什么是spring bean装配"></a>什么是spring bean装配</h1><p>Bean的装配可以理解为依赖关系注入，Bean的装配方式即Bean依赖注入的方式。</p><h1 id="spring-容器加载bean定义方式"><a href="#spring-容器加载bean定义方式" class="headerlink" title="spring 容器加载bean定义方式"></a>spring 容器加载bean定义方式</h1><p>1.xml</p><p>2.注解</p><h1 id="bean装配方式"><a href="#bean装配方式" class="headerlink" title="bean装配方式"></a>bean装配方式</h1><h2 id="xml"><a href="#xml" class="headerlink" title="xml"></a>xml</h2><p>标签中定义了autowite属性</p><p>No  缺省情况下，自动配置是通过“ref”属性手动设定，在项目中最常用。</p><p>byName  根据属性名称自动装配。如果一个bean的名称和其他的bean属性的名称是一样的，将会装配它。</p><p>byType 按类型自动装配，如果bean的数据类型是用其它bean属性的数据类型，兼容并自动装配它。</p><p>Constructor 在构造函数参数的byType方式。</p><p>autodetect 如果找到默认的构造函数，使用“自动装配用构造”；否则，使用“按类型自动装配”</p><h2 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h2><h3 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h3><figure class="highlight xml"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">spring-framework.version</span>&gt;</span>5.2.12.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring-framework.version</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="关注点"><a href="#关注点" class="headerlink" title="关注点"></a>关注点</h3><p>@Resource @Autowired</p><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">SpringApplication.run(ServiceBApplication.class, args);<br>refreshContext(context);<br>refresh((ApplicationContext) context);<br>AbstractApplicationContext.refresh();<br>finishBeanFactoryInitialization(beanFactory);<br>beanFactory.preInstantiateSingletons();<br>doGetBean();<br>createBean();<br>populateBean(beanName, mbd, instanceWrapper);<br><span class="hljs-type">PropertyValues</span> <span class="hljs-variable">pvsToUse</span> <span class="hljs-operator">=</span> ibp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName);<br></code></pre></td></tr></table></figure><p>@Resource 对应着  CommonAnnotationBeanPostProcessor</p><p>@Autowired 对应着 AutowiredAnnotationBeanPostProcessor</p><h4 id="resource"><a href="#resource" class="headerlink" title="@resource"></a>@resource</h4><p>CommonAnnotationBeanPostProcessor    postProcessProperties方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">InjectionMetadata</span> <span class="hljs-variable">metadata</span> <span class="hljs-operator">=</span> findResourceMetadata(beanName, bean.getClass(), pvs);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> InjectionMetadata <span class="hljs-title function_">findResourceMetadata</span><span class="hljs-params">(String beanName, <span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-meta">@Nullable</span> PropertyValues pvs)</span> &#123;<br><span class="hljs-comment">// Fall back to class name as cache key, for backwards compatibility with custom callers.</span><br><span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> (StringUtils.hasLength(beanName) ? beanName : clazz.getName());<br><span class="hljs-comment">// Quick check on the concurrent map first, with minimal locking.</span><br><span class="hljs-type">InjectionMetadata</span> <span class="hljs-variable">metadata</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.injectionMetadataCache.get(cacheKey);<br><span class="hljs-keyword">if</span> (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.injectionMetadataCache) &#123;<br>metadata = <span class="hljs-built_in">this</span>.injectionMetadataCache.get(cacheKey);<br><span class="hljs-keyword">if</span> (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;<br><span class="hljs-keyword">if</span> (metadata != <span class="hljs-literal">null</span>) &#123;<br>metadata.clear(pvs);<br>&#125;<br>metadata = buildResourceMetadata(clazz);<br><span class="hljs-built_in">this</span>.injectionMetadataCache.put(cacheKey, metadata);<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> metadata;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> InjectionMetadata <span class="hljs-title function_">buildResourceMetadata</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz)</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (field.isAnnotationPresent(Resource.class)) &#123;<br><span class="hljs-keyword">if</span> (Modifier.isStatic(field.getModifiers())) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;@Resource annotation is not supported on static fields&quot;</span>);<br>&#125;<br><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.ignoredResourceTypes.contains(field.getType().getName())) &#123;<br>currElements.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceElement</span>(field, field, <span class="hljs-literal">null</span>));<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>看到这里发现ResourceElement。关注类中name和lookupType</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ResourceElement</span><span class="hljs-params">(Member member, AnnotatedElement ae, <span class="hljs-meta">@Nullable</span> PropertyDescriptor pd)</span> &#123;<br><span class="hljs-built_in">super</span>(member, pd);<br><span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> ae.getAnnotation(Resource.class);<br><span class="hljs-type">String</span> <span class="hljs-variable">resourceName</span> <span class="hljs-operator">=</span> resource.name();<br>Class&lt;?&gt; resourceType = resource.type();<br><span class="hljs-built_in">this</span>.isDefaultName = !StringUtils.hasLength(resourceName);<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isDefaultName) &#123;<br>resourceName = <span class="hljs-built_in">this</span>.member.getName();<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.member <span class="hljs-keyword">instanceof</span> Method &amp;&amp; resourceName.startsWith(<span class="hljs-string">&quot;set&quot;</span>) &amp;&amp; resourceName.length() &gt; <span class="hljs-number">3</span>) &#123;<br>resourceName = Introspector.decapitalize(resourceName.substring(<span class="hljs-number">3</span>));<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (embeddedValueResolver != <span class="hljs-literal">null</span>) &#123;<br>resourceName = embeddedValueResolver.resolveStringValue(resourceName);<br>&#125;<br><span class="hljs-keyword">if</span> (Object.class != resourceType) &#123;<br>checkResourceType(resourceType);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// No resource type specified... check field/method.</span><br>resourceType = getResourceType();<br>&#125;<br><span class="hljs-built_in">this</span>.name = (resourceName != <span class="hljs-literal">null</span> ? resourceName : <span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-built_in">this</span>.lookupType = resourceType;<br><span class="hljs-type">String</span> <span class="hljs-variable">lookupValue</span> <span class="hljs-operator">=</span> resource.lookup();<br><span class="hljs-built_in">this</span>.mappedName = (StringUtils.hasLength(lookupValue) ? lookupValue : resource.mappedName());<br><span class="hljs-type">Lazy</span> <span class="hljs-variable">lazy</span> <span class="hljs-operator">=</span> ae.getAnnotation(Lazy.class);<br><span class="hljs-built_in">this</span>.lazyLookup = (lazy != <span class="hljs-literal">null</span> &amp;&amp; lazy.value());<br>&#125;<br></code></pre></td></tr></table></figure><p>找到InjectionMetadata后：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">metadata.inject(bean, beanName, pvs);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inject</span><span class="hljs-params">(Object target, <span class="hljs-meta">@Nullable</span> String beanName, <span class="hljs-meta">@Nullable</span> PropertyValues pvs)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>Collection&lt;InjectedElement&gt; checkedElements = <span class="hljs-built_in">this</span>.checkedElements;<br>Collection&lt;InjectedElement&gt; elementsToIterate =<br>(checkedElements != <span class="hljs-literal">null</span> ? checkedElements : <span class="hljs-built_in">this</span>.injectedElements);<br><span class="hljs-keyword">if</span> (!elementsToIterate.isEmpty()) &#123;<br><span class="hljs-keyword">for</span> (InjectedElement element : elementsToIterate) &#123;<br>element.inject(target, beanName, pvs);<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>会调用ResourceElement的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inject</span><span class="hljs-params">(Object target, <span class="hljs-meta">@Nullable</span> String requestingBeanName, <span class="hljs-meta">@Nullable</span> PropertyValues pvs)</span><br><span class="hljs-keyword">throws</span> Throwable &#123;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isField) &#123;<br><span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> (Field) <span class="hljs-built_in">this</span>.member;<br>ReflectionUtils.makeAccessible(field);<br>field.set(target, getResourceToInject(target, requestingBeanName));<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (checkPropertySkipping(pvs)) &#123;<br><span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> (Method) <span class="hljs-built_in">this</span>.member;<br>ReflectionUtils.makeAccessible(method);<br>method.invoke(target, getResourceToInject(target, requestingBeanName));<br>&#125;<br><span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;<br><span class="hljs-keyword">throw</span> ex.getTargetException();<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">getResourceToInject</span><span class="hljs-params">(Object target, <span class="hljs-meta">@Nullable</span> String requestingBeanName)</span> &#123;<br><span class="hljs-keyword">return</span> (<span class="hljs-built_in">this</span>.lazyLookup ? buildLazyResourceProxy(<span class="hljs-built_in">this</span>, requestingBeanName) :<br>getResource(<span class="hljs-built_in">this</span>, requestingBeanName));<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">getResource</span><span class="hljs-params">(LookupElement element, <span class="hljs-meta">@Nullable</span> String requestingBeanName)</span><br><span class="hljs-keyword">throws</span> NoSuchBeanDefinitionException &#123;<br><br><span class="hljs-keyword">if</span> (StringUtils.hasLength(element.mappedName)) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.jndiFactory.getBean(element.mappedName, element.lookupType);<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.alwaysUseJndiLookup) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.jndiFactory.getBean(element.name, element.lookupType);<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.resourceFactory == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchBeanDefinitionException</span>(element.lookupType,<br><span class="hljs-string">&quot;No resource factory configured - specify the &#x27;resourceFactory&#x27; property&quot;</span>);<br>&#125;<br><span class="hljs-keyword">return</span> autowireResource(<span class="hljs-built_in">this</span>.resourceFactory, element, requestingBeanName);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">autowireResource</span><span class="hljs-params">(BeanFactory factory, LookupElement element, <span class="hljs-meta">@Nullable</span> String requestingBeanName)</span><br><span class="hljs-keyword">throws</span> NoSuchBeanDefinitionException &#123;<br><br>Object resource;<br>Set&lt;String&gt; autowiredBeanNames;<br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> element.name;<br><br><span class="hljs-keyword">if</span> (factory <span class="hljs-keyword">instanceof</span> AutowireCapableBeanFactory) &#123;<br><span class="hljs-type">AutowireCapableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> (AutowireCapableBeanFactory) factory;<br><span class="hljs-type">DependencyDescriptor</span> <span class="hljs-variable">descriptor</span> <span class="hljs-operator">=</span> element.getDependencyDescriptor();<br><span class="hljs-comment">// @Resoure 没有指定 name(name 是默认值)，并且容器中不存在这个默认 name 对应的 bean，那么就使用 byType 方式进行注入</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.fallbackToDefaultTypeMatch &amp;&amp; element.isDefaultName &amp;&amp; !factory.containsBean(name)) &#123;<br>autowiredBeanNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;();<br>        <span class="hljs-comment">// 按 byType 方式解析依赖进行注入</span><br>resource = beanFactory.resolveDependency(descriptor, requestingBeanName, autowiredBeanNames, <span class="hljs-literal">null</span>);<br><span class="hljs-keyword">if</span> (resource == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchBeanDefinitionException</span>(element.getLookupType(), <span class="hljs-string">&quot;No resolvable resource object&quot;</span>);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 满足如下条件，则按 byName 的方式解析依赖进行注入：  </span><br>            <span class="hljs-comment">// 1. 如果 @Resource 指定了 name，则按指定 name 解析依赖进行注入  </span><br>            <span class="hljs-comment">// 2. 如果容器中存在 name 对应的 bean，则按 byName 方式进行注入  </span><br>resource = beanFactory.resolveBeanByName(name, descriptor);<br>autowiredBeanNames = Collections.singleton(name);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>resource = factory.getBean(name, element.lookupType);<br>autowiredBeanNames = Collections.singleton(name);<br>&#125;<br><br><span class="hljs-keyword">if</span> (factory <span class="hljs-keyword">instanceof</span> ConfigurableBeanFactory) &#123;<br><span class="hljs-type">ConfigurableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> (ConfigurableBeanFactory) factory;<br><span class="hljs-keyword">for</span> (String autowiredBeanName : autowiredBeanNames) &#123;<br><span class="hljs-keyword">if</span> (requestingBeanName != <span class="hljs-literal">null</span> &amp;&amp; beanFactory.containsBean(autowiredBeanName)) &#123;<br>beanFactory.registerDependentBean(autowiredBeanName, requestingBeanName);<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> resource;<br>&#125;<br></code></pre></td></tr></table></figure><p>@Resource 在不指定 name 的情况下，默认是按 field 的 name 来注入的；如果按默认的 name 找不到 bean，则会按 type 注入</p><h4 id="Autowired"><a href="#Autowired" class="headerlink" title="@Autowired"></a>@Autowired</h4><p>AutowiredAnnotationBeanPostProcessor </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Deprecated</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> PropertyValues <span class="hljs-title function_">postProcessPropertyValues</span><span class="hljs-params">(</span><br><span class="hljs-params">PropertyValues pvs, PropertyDescriptor[] pds, Object bean, String beanName)</span> &#123;<br><br><span class="hljs-keyword">return</span> postProcessProperties(pvs, bean, beanName);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> PropertyValues <span class="hljs-title function_">postProcessProperties</span><span class="hljs-params">(PropertyValues pvs, Object bean, String beanName)</span> &#123;<br><span class="hljs-type">InjectionMetadata</span> <span class="hljs-variable">metadata</span> <span class="hljs-operator">=</span> findAutowiringMetadata(beanName, bean.getClass(), pvs);<br><span class="hljs-keyword">try</span> &#123;<br>metadata.inject(bean, beanName, pvs);<br>&#125;<br><span class="hljs-keyword">catch</span> (BeanCreationException ex) &#123;<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName, <span class="hljs-string">&quot;Injection of autowired dependencies failed&quot;</span>, ex);<br>&#125;<br><span class="hljs-keyword">return</span> pvs;<br>&#125;<br></code></pre></td></tr></table></figure><p>找到 AutowiredFieldElement  AutowiredMethodElement</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inject</span><span class="hljs-params">(Object bean, <span class="hljs-meta">@Nullable</span> String beanName, <span class="hljs-meta">@Nullable</span> PropertyValues pvs)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br><span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> (Field) <span class="hljs-built_in">this</span>.member;<br>Object value;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.cached) &#123;<br>value = resolvedCachedArgument(beanName, <span class="hljs-built_in">this</span>.cachedFieldValue);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-type">DependencyDescriptor</span> <span class="hljs-variable">desc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DependencyDescriptor</span>(field, <span class="hljs-built_in">this</span>.required);<br>desc.setContainingClass(bean.getClass());<br>Set&lt;String&gt; autowiredBeanNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;(<span class="hljs-number">1</span>);<br>Assert.state(beanFactory != <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;No BeanFactory available&quot;</span>);<br><span class="hljs-type">TypeConverter</span> <span class="hljs-variable">typeConverter</span> <span class="hljs-operator">=</span> beanFactory.getTypeConverter();<br><span class="hljs-keyword">try</span> &#123;<br>value = beanFactory.resolveDependency(desc, beanName, autowiredBeanNames, typeConverter);<br>&#125;<br><span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsatisfiedDependencyException</span>(<span class="hljs-literal">null</span>, beanName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">InjectionPoint</span>(field), ex);<br>&#125;<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.cached) &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">cachedFieldValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span> || <span class="hljs-built_in">this</span>.required) &#123;<br>cachedFieldValue = desc;<br>registerDependentBeans(beanName, autowiredBeanNames);<br><span class="hljs-keyword">if</span> (autowiredBeanNames.size() == <span class="hljs-number">1</span>) &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">autowiredBeanName</span> <span class="hljs-operator">=</span> autowiredBeanNames.iterator().next();<br><span class="hljs-keyword">if</span> (beanFactory.containsBean(autowiredBeanName) &amp;&amp;<br>beanFactory.isTypeMatch(autowiredBeanName, field.getType())) &#123;<br>cachedFieldValue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShortcutDependencyDescriptor</span>(<br>desc, autowiredBeanName, field.getType());<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-built_in">this</span>.cachedFieldValue = cachedFieldValue;<br><span class="hljs-built_in">this</span>.cached = <span class="hljs-literal">true</span>;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>ReflectionUtils.makeAccessible(field);<br>field.set(bean, value);<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">value = beanFactory.resolveDependency(desc, beanName, autowiredBeanNames, typeConverter);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">resolveDependency</span><span class="hljs-params">(DependencyDescriptor descriptor, <span class="hljs-meta">@Nullable</span> String requestingBeanName,</span><br><span class="hljs-params"><span class="hljs-meta">@Nullable</span> Set&lt;String&gt; autowiredBeanNames, <span class="hljs-meta">@Nullable</span> TypeConverter typeConverter)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><br>descriptor.initParameterNameDiscovery(getParameterNameDiscoverer());<br><span class="hljs-keyword">if</span> (Optional.class == descriptor.getDependencyType()) &#123;<br><span class="hljs-keyword">return</span> createOptionalDependency(descriptor, requestingBeanName);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ObjectFactory.class == descriptor.getDependencyType() ||<br>ObjectProvider.class == descriptor.getDependencyType()) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DependencyObjectProvider</span>(descriptor, requestingBeanName);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (javaxInjectProviderClass == descriptor.getDependencyType()) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jsr330Factory</span>().createDependencyProvider(descriptor, requestingBeanName);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> getAutowireCandidateResolver().getLazyResolutionProxyIfNecessary(<br>descriptor, requestingBeanName);<br><span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) &#123;<br>result = doResolveDependency(descriptor, requestingBeanName, autowiredBeanNames, typeConverter);<br>&#125;<br><span class="hljs-keyword">return</span> result;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">doResolveDependency</span><span class="hljs-params">(DependencyDescriptor descriptor, <span class="hljs-meta">@Nullable</span> String beanName,</span><br><span class="hljs-params"><span class="hljs-meta">@Nullable</span> Set&lt;String&gt; autowiredBeanNames, <span class="hljs-meta">@Nullable</span> TypeConverter typeConverter)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><br><span class="hljs-type">InjectionPoint</span> <span class="hljs-variable">previousInjectionPoint</span> <span class="hljs-operator">=</span> ConstructorResolver.setCurrentInjectionPoint(descriptor);<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">shortcut</span> <span class="hljs-operator">=</span> descriptor.resolveShortcut(<span class="hljs-built_in">this</span>);<br><span class="hljs-keyword">if</span> (shortcut != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span> shortcut;<br>&#125;<br><br>Class&lt;?&gt; type = descriptor.getDependencyType();<br><span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> getAutowireCandidateResolver().getSuggestedValue(descriptor);<br><span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> String) &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">strVal</span> <span class="hljs-operator">=</span> resolveEmbeddedValue((String) value);<br><span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> (beanName != <span class="hljs-literal">null</span> &amp;&amp; containsBean(beanName) ?<br>getMergedBeanDefinition(beanName) : <span class="hljs-literal">null</span>);<br>value = evaluateBeanDefinitionString(strVal, bd);<br>&#125;<br><span class="hljs-type">TypeConverter</span> <span class="hljs-variable">converter</span> <span class="hljs-operator">=</span> (typeConverter != <span class="hljs-literal">null</span> ? typeConverter : getTypeConverter());<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">return</span> converter.convertIfNecessary(value, type, descriptor.getTypeDescriptor());<br>&#125;<br><span class="hljs-keyword">catch</span> (UnsupportedOperationException ex) &#123;<br><span class="hljs-comment">// A custom TypeConverter which does not support TypeDescriptor resolution...</span><br><span class="hljs-keyword">return</span> (descriptor.getField() != <span class="hljs-literal">null</span> ?<br>converter.convertIfNecessary(value, type, descriptor.getField()) :<br>converter.convertIfNecessary(value, type, descriptor.getMethodParameter()));<br>&#125;<br>&#125;<br><br><span class="hljs-type">Object</span> <span class="hljs-variable">multipleBeans</span> <span class="hljs-operator">=</span> resolveMultipleBeans(descriptor, beanName, autowiredBeanNames, typeConverter);<br><span class="hljs-keyword">if</span> (multipleBeans != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span> multipleBeans;<br>&#125;<br><span class="hljs-comment">// 先按类型查找bean</span><br>Map&lt;String, Object&gt; matchingBeans = findAutowireCandidates(beanName, type, descriptor);<br><span class="hljs-keyword">if</span> (matchingBeans.isEmpty()) &#123;<br><span class="hljs-keyword">if</span> (isRequired(descriptor)) &#123;<br>raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor);<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><br>String autowiredBeanName;<br>Object instanceCandidate;<br><br><span class="hljs-keyword">if</span> (matchingBeans.size() &gt; <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-comment">// 如果按类型找到多个，则再按name进行匹配</span><br>autowiredBeanName = determineAutowireCandidate(matchingBeans, descriptor);<br><span class="hljs-keyword">if</span> (autowiredBeanName == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (isRequired(descriptor) || !indicatesMultipleBeans(type)) &#123;<br><span class="hljs-keyword">return</span> descriptor.resolveNotUnique(descriptor.getResolvableType(), matchingBeans);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// In case of an optional Collection/Map, silently ignore a non-unique case:</span><br><span class="hljs-comment">// possibly it was meant to be an empty collection of multiple regular beans</span><br><span class="hljs-comment">// (before 4.3 in particular when we didn&#x27;t even look for collection beans).</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br>&#125;<br>instanceCandidate = matchingBeans.get(autowiredBeanName);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// We have exactly one match.</span><br>        <span class="hljs-comment">// 如果按类型找到1个，则注入完成</span><br>Map.Entry&lt;String, Object&gt; entry = matchingBeans.entrySet().iterator().next();<br>autowiredBeanName = entry.getKey();<br>instanceCandidate = entry.getValue();<br>&#125;<br><br><span class="hljs-keyword">if</span> (autowiredBeanNames != <span class="hljs-literal">null</span>) &#123;<br>autowiredBeanNames.add(autowiredBeanName);<br>&#125;<br><span class="hljs-keyword">if</span> (instanceCandidate <span class="hljs-keyword">instanceof</span> Class) &#123;<br>instanceCandidate = descriptor.resolveCandidate(autowiredBeanName, type, <span class="hljs-built_in">this</span>);<br>&#125;<br><span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> instanceCandidate;<br><span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> NullBean) &#123;<br><span class="hljs-keyword">if</span> (isRequired(descriptor)) &#123;<br>raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor);<br>&#125;<br>result = <span class="hljs-literal">null</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (!ClassUtils.isAssignableValue(type, result)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanNotOfRequiredTypeException</span>(autowiredBeanName, type, instanceCandidate.getClass());<br>&#125;<br><span class="hljs-keyword">return</span> result;<br>&#125;<br><span class="hljs-keyword">finally</span> &#123;<br>ConstructorResolver.setCurrentInjectionPoint(previousInjectionPoint);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>@Autowired 的装配顺序：</p><p>1.按 type 在上下文中查找匹配的 bean<br>2.如果有多个bean，则按 name 进行匹配<br>    2.1 如果有 @Qualifier 注解，则按照 @Qualifier 指定的name进行匹配<br>    2.2 如果没有，则按照 field 的 name 进行匹配<br>3. 匹配不到，则报错。<br>    如果设置 @Autowired(required&#x3D;false)，则注入失败时不会抛出异常</p>]]></content>
    
    
    <categories>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux的cat命令</title>
    <link href="/2019/07/31/linux/linux%E7%9A%84cat%E5%91%BD%E4%BB%A4/"/>
    <url>/2019/07/31/linux/linux%E7%9A%84cat%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h2 id="1-名称"><a href="#1-名称" class="headerlink" title="1.名称"></a>1.名称</h2><p>连接文件并在标准输出上打印</p><h2 id="2-语法"><a href="#2-语法" class="headerlink" title="2.语法"></a>2.语法</h2><p>cat [OPTION]… [FILE]…</p><h2 id="3-描述"><a href="#3-描述" class="headerlink" title="3.描述"></a>3.描述</h2><p>连接文件或标准输入，在标准输出打印。</p><p>当没有文件或文件是-，读标准输入。</p><h2 id="4-参数"><a href="#4-参数" class="headerlink" title="4.参数"></a>4.参数</h2><h3 id="4-1-A"><a href="#4-1-A" class="headerlink" title="4.1 -A"></a>4.1 -A</h3><p>-A, –show-all</p><p>相当于 -vET</p><h3 id="4-2-b"><a href="#4-2-b" class="headerlink" title="4.2 -b"></a>4.2 -b</h3><p>-b, –number-nonblank</p><p>由1开始对非空行编号</p><h3 id="4-3-e"><a href="#4-3-e" class="headerlink" title="4.3 -e"></a>4.3 -e</h3><p>相当于 -vE</p><h3 id="4-4-E"><a href="#4-4-E" class="headerlink" title="4.4 -E"></a>4.4 -E</h3><p>-E, –show-ends</p><p>在每行末尾显示$</p><h3 id="4-5-n"><a href="#4-5-n" class="headerlink" title="4.5 -n"></a>4.5 -n</h3><p>-n, –number</p><p>由1开始对所有行编号</p><h3 id="4-6-s"><a href="#4-6-s" class="headerlink" title="4.6 -s"></a>4.6 -s</h3><p>-s, –squeeze-blank</p><p>抑制重复的空输出行 (两个空行只显示一个空行)</p><h3 id="4-7-t"><a href="#4-7-t" class="headerlink" title="4.7 -t"></a>4.7 -t</h3><p>相当于 -vT</p><h3 id="4-8-T"><a href="#4-8-T" class="headerlink" title="4.8 -T"></a>4.8 -T</h3><p>-T, –show-tabs</p><p>显示TAB字符为^I</p><h3 id="4-9-v"><a href="#4-9-v" class="headerlink" title="4.9 -v"></a>4.9 -v</h3><p>-v, –show-nonprinting</p><p>使用 ^ 和 M- 符号，除了 LFD 和 TAB 之外。</p><h3 id="4-10-–help"><a href="#4-10-–help" class="headerlink" title="4.10 –help"></a>4.10 –help</h3><p>显示这个帮助并退出</p><h3 id="4-11-–version"><a href="#4-11-–version" class="headerlink" title="4.11 –version"></a>4.11 –version</h3><p>输出版本信息并退出</p><h2 id="5-例子"><a href="#5-例子" class="headerlink" title="5.例子"></a>5.例子</h2><p>cat f - g</p><p>输出f的内容，然后是标准输入，然后是g的内容</p><p>cat</p><p>用标准输入到标准输出</p><h2 id="6-查看详情"><a href="#6-查看详情" class="headerlink" title="6.查看详情"></a>6.查看详情</h2><p>info coreutils ‘cat invocation’</p>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>cat</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux的tail命令</title>
    <link href="/2019/07/31/linux/linux%E7%9A%84tail%E5%91%BD%E4%BB%A4/"/>
    <url>/2019/07/31/linux/linux%E7%9A%84tail%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<p>##1.名称</p><p>tail </p><p>名词：尾巴</p><p>形容词：尾部的</p><p>意思：输出文件的最后一部分</p><h2 id="2-语法"><a href="#2-语法" class="headerlink" title="2.语法"></a>2.语法</h2><p>tail [OPTION]… [FILE]…</p><h2 id="3-描述"><a href="#3-描述" class="headerlink" title="3.描述"></a>3.描述</h2><p>打印指定文件的最后10行到标准输出。</p><p>给大于1个文件时，输出会给每个文件一个头。</p><p>如何没有文件，或者当文件为-时，读取标准输入。</p><h2 id="4-参数"><a href="#4-参数" class="headerlink" title="4.参数"></a>4.参数</h2><h3 id="4-1-C"><a href="#4-1-C" class="headerlink" title="4.1 -C"></a>4.1 -C</h3><p>-c, –bytes&#x3D;K</p><p>输出最后k bytes;或者用-c +k到从第k bytes开始的内容</p><p>tail -c 100 package.json</p><p>tail -c +10 package.json</p><p>tail –bytes&#x3D;10 package.json</p><p>tail –bytes&#x3D;+10 package.json</p><h3 id="4-2-f"><a href="#4-2-f" class="headerlink" title="4.2 -f"></a>4.2 -f</h3><p>-f, –follow[&#x3D;{name|descriptor}]</p><p>随着文件的增长，输出附加数据;</p><p>–follow&#x3D;descriptor (默认)，根据文件描述符进行追踪，当文件改名或被删除，追踪停止。</p><p><strong>–follow</strong>&#x3D;name ， 根据文件名进行追踪，其是否被删除或被其他程序重新创建  </p><h3 id="4-3-F"><a href="#4-3-F" class="headerlink" title="4.3 -F"></a>4.3 -F</h3><p>等同于 –follow&#x3D;name –retry</p><h3 id="4-4-n"><a href="#4-4-n" class="headerlink" title="4.4 -n"></a>4.4 -n</h3><p>-n, –lines&#x3D;K</p><p>输出最后k行，而不是最后10行。</p><p>或者用-n +k,从第k行开始输出。</p><p>tail -n 20 xxx.log</p><p>tail -n +20 xxx.log</p><h3 id="4-5-–max-unchanged-stats-x3D-N"><a href="#4-5-–max-unchanged-stats-x3D-N" class="headerlink" title="4.5 –max-unchanged-stats&#x3D;N"></a>4.5 –max-unchanged-stats&#x3D;N</h3><p>–max-unchanged-stats&#x3D;N</p><p>使用–follow&#x3D;name,重新打开一个没有打开的文件。</p><p>在N次迭代(默认为5次)之后更改大小，查看是否已断开链接或重命名(这是旋转日志文件的常见情况);对于支持文件更改通(inotify)，这个选项很少用</p><h3 id="4-6-–pid"><a href="#4-6-–pid" class="headerlink" title="4.6 –pid"></a>4.6 –pid</h3><p>–pid&#x3D;PID</p><p>与-f合用，PID表示进程ID,PID死掉之后结束</p><p>tail -f xxx.log –pid&#x3D;xxx</p><h3 id="4-7-q"><a href="#4-7-q" class="headerlink" title="4.7  -q"></a>4.7  -q</h3><p>-q, –quiet, –silent</p><p>永远不要输出标题给出文件名</p><p>tail -f -q x1.log x2.log</p><h3 id="4-8-–retry"><a href="#4-8-–retry" class="headerlink" title="4.8 –retry"></a>4.8 –retry</h3><p>如果无法访问文件，请继续尝试打开该文件</p><p>tail -f –retry xx.log</p><h3 id="4-9-s"><a href="#4-9-s" class="headerlink" title="4.9 -s"></a>4.9 -s</h3><p>-s, –sleep-interval&#x3D;N</p><p>与-f合用，在迭代之间休眠大约N秒(默认1);使用inotify和–pid&#x3D;pid,至少每N秒检查进程pid一次</p><h3 id="4-10-v"><a href="#4-10-v" class="headerlink" title="4.10 -v"></a>4.10 -v</h3><p>-v, –verbose</p><p>总是输出头给出文件名</p><h3 id="4-11-–help"><a href="#4-11-–help" class="headerlink" title="4.11 –help"></a>4.11 –help</h3><p>显示这个帮助并退出</p><h3 id="4-12-–version"><a href="#4-12-–version" class="headerlink" title="4.12 –version"></a>4.12 –version</h3><p>输出版本信息并退出</p><h3 id="4-13-k-单位后缀"><a href="#4-13-k-单位后缀" class="headerlink" title="4.13 k 单位后缀"></a>4.13 k 单位后缀</h3><p>b 512， KB 1000, K 1024, MB 1000 * 1000, M 1024 * 1024, GB 1000 * 1000 * 1000， G 1024 * 1024 * 1024</p><p>以此类推 T, P, E, Z, Y</p><h3 id="4-14-查看完整文档"><a href="#4-14-查看完整文档" class="headerlink" title="4.14 查看完整文档"></a>4.14 查看完整文档</h3><p>info coreutils ‘tail invocation’</p>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>tail</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>markdown文件使用图片</title>
    <link href="/2019/07/23/markdown%E6%96%87%E4%BB%B6%E4%BD%BF%E7%94%A8%E5%9B%BE%E7%89%87/"/>
    <url>/2019/07/23/markdown%E6%96%87%E4%BB%B6%E4%BD%BF%E7%94%A8%E5%9B%BE%E7%89%87/</url>
    
    <content type="html"><![CDATA[<h2 id="1-markdown添加图片的基础格式"><a href="#1-markdown添加图片的基础格式" class="headerlink" title="1.markdown添加图片的基础格式"></a>1.markdown添加图片的基础格式</h2><figure class="highlight applescript"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs applescript">![Alt <span class="hljs-built_in">text</span>](图片链接 <span class="hljs-string">&quot;optional title&quot;</span>)<br></code></pre></td></tr></table></figure><p>Alt text：图片的Alt标签，用来描述图片的关键词，可以不写。最初的本意是当图片因为某种原因不能被显示时而出现的替代文字，后来又被用于SEO，可以方便搜索引擎根据Alt text里面的关键词搜索到图片。 </p><p>图片链接：可以是图片的本地地址或者是网址。</p><p>“optional title”：鼠标悬置于图片上会出现的标题文字，可以不写。</p><p>使用：</p><p>本地图片</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">![avatar](<span class="hljs-regexp">/home/</span>picture/<span class="hljs-number">1.</span>png)<br></code></pre></td></tr></table></figure><p>网络图片</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">![avatar](http:<span class="hljs-regexp">//</span>baidu.com<span class="hljs-regexp">/pic/</span>doge.png)<br></code></pre></td></tr></table></figure><h2 id="2-把图片存入markdown文件"><a href="#2-把图片存入markdown文件" class="headerlink" title="2.把图片存入markdown文件"></a>2.把图片存入markdown文件</h2><p>用base64转码工具把图片转成一段字符串，然后把字符串填到基础格式中链接的那个位置。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">![avatar](data:image/png;<span class="hljs-built_in">base64</span>,iVBORw0......)<br></code></pre></td></tr></table></figure><p>把base64的图片放到文章末尾：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css">!<span class="hljs-selector-attr">[avatar]</span><span class="hljs-selector-attr">[base64str]</span><br><span class="hljs-selector-attr">[base64str]</span>:data:image/png;base64,iVBORw0......<br></code></pre></td></tr></table></figure><h2 id="3-typora图片设置"><a href="#3-typora图片设置" class="headerlink" title="3.typora图片设置"></a>3.typora图片设置</h2><p>mac 系统</p><p>偏好设置</p><p>图像</p><p>选择复制到assets文件夹</p>]]></content>
    
    
    <categories>
      
      <category>markdown</category>
      
    </categories>
    
    
    <tags>
      
      <tag>markdown</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>遇到过的问题</title>
    <link href="/2019/07/23/%E9%81%87%E5%88%B0%E8%BF%87%E7%9A%84%E9%97%AE%E9%A2%98/"/>
    <url>/2019/07/23/%E9%81%87%E5%88%B0%E8%BF%87%E7%9A%84%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h2 id="mysql-jdbc版本已知问题"><a href="#mysql-jdbc版本已知问题" class="headerlink" title="mysql jdbc版本已知问题"></a>mysql jdbc版本已知问题</h2><p>在mysql jdbc 使版本号为 6.0.6时，使用text&#x2F;longtext字段时，会报错，那个错误跟类型错误是一个错误信息，所以很难排查，去官网搜索，在官方文档<a href="https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-usagenotes-known-issues-limitations.html">Known Issues and Limitations</a>(已知错误和局限性)里发现，6.0.6版本就会出这个问题。这时候我明白软件上线并不是完美。</p><h3 id="多个类加器加载的类静态类与对象都不是同一个对象"><a href="#多个类加器加载的类静态类与对象都不是同一个对象" class="headerlink" title="多个类加器加载的类静态类与对象都不是同一个对象"></a>多个类加器加载的类静态类与对象都不是同一个对象</h3><p>我们要做一个拦截error日志的钉钉报警，使用的框架为springboot+log4j2,想要使用自定义Appender（SyncCallbackAppender），</p><p>钉钉service需要读取配置文件，发送钉钉消息，这时钉钉service不能注入进SyncCallbackAppender；使用生产者消费者需要一个容器，消费者一直无法获取这个容器，发现不是同一个对象。SyncCallbackAppender 与 钉钉service不是同一个类加载器加载的。</p><p>发现是使用的spring dev tools ，这时类加载器为restartClassLoader类，去掉dev tools包即可。</p><h3 id="第三方服务出现问题引发系统不可用"><a href="#第三方服务出现问题引发系统不可用" class="headerlink" title="第三方服务出现问题引发系统不可用"></a>第三方服务出现问题引发系统不可用</h3><p>情况介绍：客户端   —》   我们服务器(netty)   -&gt;  第三方服务器</p><p>客户端与我们服务器使用socket连接，请求完后关闭。</p><p>我们服务器使用netty接收请求。服务器使用的阿里云服务器。</p><p>我们服务器跟第三方服务器使用socket通信。</p><p>首先出现客户端连接不上服务器情况。接收到反馈后排查。跟运维或负责人要服务器的监控情况。发现CPU、内存、带宽、磁盘等都无异常。</p><p>因为是连接问题，去服务器看，tcp的连接情况。出现大量的socket的close_wait。以为是客户端为关闭socket造成。但是http请求没问题。进一步排查。使用jstack命下载当时的堆栈。使用在线工具fastThread分析，发现RUNNABLE threads 的线程为netty线程。并且都是同一方法，因为netty默认开启的接收和处理的线程数都是可用核心*2。说明这些线程都被占用了。定位到程序里跟第三方服务器使用socket通信时未使超时时间，使socket无线等待。</p><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>();<br>socket.connect(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(ipAddress, port), <span class="hljs-number">1000</span>);<span class="hljs-comment">//设置连接请求超时时间1 s</span><br>socket.setSoTimeout(<span class="hljs-number">30000</span>);<span class="hljs-comment">//设置读操作超时时间30 s</span><br></code></pre></td></tr></table></figure><h2 id="使netty未正确关闭连接造成客户端连不上服务器"><a href="#使netty未正确关闭连接造成客户端连不上服务器" class="headerlink" title="使netty未正确关闭连接造成客户端连不上服务器"></a>使netty未正确关闭连接造成客户端连不上服务器</h2><p>因为netty中所有涉及到IO操作的都是异步的。netty提供回调函数来给使用者通知或操作。</p><h2 id="redis未设置密码，被当为肉鸡"><a href="#redis未设置密码，被当为肉鸡" class="headerlink" title="redis未设置密码，被当为肉鸡"></a>redis未设置密码，被当为肉鸡</h2><p>参考redis所在服务器被作为肉鸡。</p>]]></content>
    
    
    <categories>
      
      <category>问题</category>
      
    </categories>
    
    
    <tags>
      
      <tag>问题</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>git 撤销本地修改与回退版本</title>
    <link href="/2019/07/23/git/git%20%E6%92%A4%E9%94%80%E6%9C%AC%E5%9C%B0%E4%BF%AE%E6%94%B9%E4%B8%8E%E5%9B%9E%E9%80%80%E7%89%88%E6%9C%AC/"/>
    <url>/2019/07/23/git/git%20%E6%92%A4%E9%94%80%E6%9C%AC%E5%9C%B0%E4%BF%AE%E6%94%B9%E4%B8%8E%E5%9B%9E%E9%80%80%E7%89%88%E6%9C%AC/</url>
    
    <content type="html"><![CDATA[<h2 id="1-使用-git-checkout-撤销本地修改"><a href="#1-使用-git-checkout-撤销本地修改" class="headerlink" title="1. 使用 git checkout 撤销本地修改"></a>1. 使用 <code>git checkout</code> 撤销本地修改</h2><p>即放弃对本地已修改但尚未提交的文件的修改，还原其到未修改前的状态。<br>注意： 已 add&#x2F; commit 的文件不适用个方法，应该用本文提到的第二种方法。</p><p>命令如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><pre><code class="hljs nginx"><br><span class="hljs-attribute">git</span> checkout .      <span class="hljs-comment"># 撤销对所有已修改但未提交的文件的修改，但不包括新增的文件</span><br>git checkout [filename]     <span class="hljs-comment"># 撤销对指定文件的修改，[filename]为文件名</span><br><br></code></pre></td></tr></table></figure><h2 id="2-使用-git-reset-回退项目版本"><a href="#2-使用-git-reset-回退项目版本" class="headerlink" title="2.使用 git reset 回退项目版本"></a>2.使用 git reset 回退项目版本</h2><p>可以回退到任意已经提交过的版本。已 add &#x2F; commit 但未 push 的文件也适用。</p><p>命令如下：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">git reset <span class="hljs-attr">--hard</span> <span class="hljs-selector-attr">[commit-hashcode]</span><br></code></pre></td></tr></table></figure><p>commit-hashcode是某个 commit 的哈希值，可以用 git log 查看。<br>因此一般用法是先用 Git log 查看具体commit的哈希值，然后 reset 到那个版本。</p><p>说明：<br>这两个命令都不会对新增文件起作用。因为新增的文件是还未加到 git 的记录里面的，即属于未被 tracked 的状态，所以撤销修改和回退均对其不影响。我们直接手动删除文件就行了。</p>]]></content>
    
    
    <categories>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hexo使用图片</title>
    <link href="/2019/07/23/hexo/hexo%E4%BD%BF%E7%94%A8%E5%9B%BE%E7%89%87/"/>
    <url>/2019/07/23/hexo/hexo%E4%BD%BF%E7%94%A8%E5%9B%BE%E7%89%87/</url>
    
    <content type="html"><![CDATA[<h2 id="1-直接使用，参见markdown使用图片"><a href="#1-直接使用，参见markdown使用图片" class="headerlink" title="1.直接使用，参见markdown使用图片"></a>1.直接使用，参见markdown使用图片</h2><p>##2.使用hexo-asset-image插件</p><p><a href="https://github.com/xcodebuild/hexo-asset-image">https://github.com/xcodebuild/hexo-asset-image</a></p><p>npm install hexo-asset-image –save</p><p>修改_config.yml中post_asset_folder 字段为true</p><p>生成图片目录位于你markdown文件处例如：</p><p>MacGesture2-Publish<br>├── apppicker.jpg<br>├── logo.jpg<br>└── rules.jpg<br>MacGesture2-Publish.md</p><p>会出现这个bug<br><a href="https://github.com/xcodebuild/hexo-asset-image/issues/47">https://github.com/xcodebuild/hexo-asset-image/issues/47</a></p><p>最新的应该就没问题了，把git上index.js文件覆盖你本地文件，再使用hexo生成就可以了。</p>]]></content>
    
    
    <categories>
      
      <category>hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>程序员穿衣</title>
    <link href="/2019/07/23/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%A9%BF%E8%A1%A3/"/>
    <url>/2019/07/23/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%A9%BF%E8%A1%A3/</url>
    
    <content type="html"><![CDATA[<h2 id="着装第一要义：合身"><a href="#着装第一要义：合身" class="headerlink" title="着装第一要义：合身"></a>着装第一要义：合身</h2><h2 id="上身：四层理论"><a href="#上身：四层理论" class="headerlink" title="上身：四层理论"></a>上身：四层理论</h2><p>一个简单的方法告诉你不同季节该穿几件衣服：</p><p>夏天穿一层，春天穿两层，秋天穿三层，冬天穿四层。</p><p>也就是说：</p><p>一件衬衫&#x2F;T恤&#x3D;夏天</p><p>T恤+衬衫&#x2F;夹克&#x3D;春天</p><p>T恤+衬衫+夹克&#x2F;毛衣&#x3D;秋天</p><p>T恤+衬衫+毛衣+夹克&#x3D;冬天</p><p>1、纯血T恤</p><p>2、衬衫：不买格子衬衫。合身最重要。白色永远百搭，浅蓝看着舒服，牛仔十分有型。</p><p>3、品质外套：大部分时候穿夹克、卫衣就足够了。黑色太过正式、白色不耐脏，灰色外套是个不错的选择。</p><h2 id="下身："><a href="#下身：" class="headerlink" title="下身："></a>下身：</h2><p>下身的搭配原则是简洁至上。</p><p>1.裤子：</p><p>长度选择：长裤、九分裤、五分裤，请一定拒绝七分裤！</p><p>2.鞋袜：</p><p>拒绝凉鞋！</p><p>请在穿短裤低帮鞋的时候，千万不要空长袜！</p>]]></content>
    
    
    <categories>
      
      <category>生活</category>
      
    </categories>
    
    
    <tags>
      
      <tag>生活</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>荣誉</title>
    <link href="/2019/07/23/%E8%8D%A3%E8%AA%89/"/>
    <url>/2019/07/23/%E8%8D%A3%E8%AA%89/</url>
    
    <content type="html"><![CDATA[<h2 id="公司中"><a href="#公司中" class="headerlink" title="公司中"></a>公司中</h2><p>颁奖为优秀员工，码农先锋。</p><h2 id="团队中"><a href="#团队中" class="headerlink" title="团队中"></a>团队中</h2><p>提出使用arthas进行线上问题的排查与修复。</p>]]></content>
    
    
    <categories>
      
      <category>荣誉</category>
      
    </categories>
    
    
    <tags>
      
      <tag>荣誉</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jmeter参考</title>
    <link href="/2019/07/23/jmeter/jmeter%E5%8F%82%E8%80%83/"/>
    <url>/2019/07/23/jmeter/jmeter%E5%8F%82%E8%80%83/</url>
    
    <content type="html"><![CDATA[<p><a href="https://blog.csdn.net/github_27109687/article/details/71968662">https://blog.csdn.net/github_27109687/article/details/71968662</a> jmeter</p><p><a href="https://blog.csdn.net/zouxiongqqq/article/details/72843500">https://blog.csdn.net/zouxiongqqq/article/details/72843500</a> jmeter</p><p><a href="https://blog.csdn.net/zjq001x/article/details/53107159">https://blog.csdn.net/zjq001x/article/details/53107159</a> jmeter集合点</p><p><a href="http://www.cnblogs.com/TankXiao/p/4045439.html">http://www.cnblogs.com/TankXiao/p/4045439.html</a> jmeter工具运用</p>]]></content>
    
    
    <categories>
      
      <category>jmeter</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jmeter</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>https参考</title>
    <link href="/2019/07/23/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/https%E5%8F%82%E8%80%83/"/>
    <url>/2019/07/23/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/https%E5%8F%82%E8%80%83/</url>
    
    <content type="html"><![CDATA[<p><a href="http://url.cn/4C5CtFx">http://url.cn/4C5CtFx</a> 一个故事讲完https</p><p><a href="https://baijiahao.baidu.com/s?id=1570143475599137&amp;wfr=spider&amp;for=pc">https://baijiahao.baidu.com/s?id=1570143475599137&amp;wfr=spider&amp;for=pc</a> 【HTTP】HTTPS 原理详解</p>]]></content>
    
    
    <categories>
      
      <category>https</category>
      
    </categories>
    
    
    <tags>
      
      <tag>https</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jvm对象创建</title>
    <link href="/2019/07/23/jvm/jvm%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA/"/>
    <url>/2019/07/23/jvm/jvm%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="对象创建流程"><a href="#对象创建流程" class="headerlink" title="对象创建流程"></a>对象创建流程</h1><ul><li><p>虚拟机遇到一条new指令时，首先检查这个对应的类能否在常量池中定位到一个类的符号引用</p></li><li><p>判断这个类是否已被加载、解析和初始化</p></li><li><p>为这个新生对象在Java堆中分配内存空间，其中Java堆分配内存空间的方式主要有以下两种</p><ul><li>指针碰撞<ul><li>分配内存空间包括开辟一块内存和移动指针两个步骤</li><li>非原子步骤可能出现并发问题，Java虚拟机采用CAS配上失败重试的方式保证更新操作的原子性</li></ul></li><li>空闲列表<ul><li>分配内存空间包括开辟一块内存和修改空闲列表两个步骤</li><li>非原子步骤可能出现并发问题，Java虚拟机采用CAS配上失败重试的方式保证更新操作的原子性</li></ul></li></ul></li><li><p>将分配到的内存空间都初始化为零值</p></li><li><p>设置对象头相关数据</p><ul><li>GC分代年龄</li><li>对象的哈希码 hashCode</li><li>元数据信息</li></ul></li><li><p>执行对象<init>方法</init></p></li></ul><h1 id="对象结构"><a href="#对象结构" class="headerlink" title="对象结构"></a>对象结构</h1><ul><li>对象头用于存储对象的元数据信息：<ul><li>Mark Word 部分数据的长度在32位和64位虚拟机（未开启压缩指针）中分别为32bit和64bit，存储对象自身的运行时数据如哈希值等。Mark Word一般被设计为非固定的数据结构，以便存储更多的数据信息和复用自己的存储空间。</li><li>类型指针 指向它的类元数据的指针，用于判断对象属于哪个类的实例。</li></ul></li><li>实例数据存储的是真正有效数据，如各种字段内容，各字段的分配策略为longs&#x2F;doubles、ints、shorts&#x2F;chars、bytes&#x2F;boolean、oops(ordinary object pointers)，相同宽度的字段总是被分配到一起，便于之后取数据。父类定义的变量会出现在子类定义的变量的前面。</li><li>对齐填充部分仅仅起到占位符的作用</li></ul><h1 id="访问对象"><a href="#访问对象" class="headerlink" title="访问对象"></a>访问对象</h1><p>当我们在堆上创建一个对象实例后，就要通过虚拟机栈中的reference类型数据来操作堆上的对象。现在主流的访问方式有两种（HotSpot虚拟机采用的是第二种）：</p><ol><li>使用句柄访问对象。即reference中存储的是对象句柄的地址，而句柄中包含了对象实例数据与类型数据的具体地址信息，相当于二级指针。</li><li>直接指针访问对象。即reference中存储的就是对象地址，相当于一级指针。</li></ol><p>对比：</p><p>垃圾回收分析：</p><p>​方式一当垃圾回收移动对象时，reference中存储的地址是稳定的地址，不需要修改，仅需要修改对象句柄的地址；</p><p>​方式二垃圾回收时需要修改reference中存储的地址。</p><p>访问效率分析：</p><p>​方式二优于方式一，因为方式二只进行了一次指针定位，节省了时间开销，而这也是HotSpot采用的实现方式。</p><h1 id="内存分配"><a href="#内存分配" class="headerlink" title="内存分配"></a>内存分配</h1><p>对象分配的规则有哪些</p><ul><li>对象主要分配在新生代的 Eden 区上</li><li>如果启动了本地线程分配缓冲，将按线程优先在 TLAB 上分配</li><li>少数情况下也可能会直接分配在老年代中</li></ul><h2 id="TLAB"><a href="#TLAB" class="headerlink" title="TLAB"></a>TLAB</h2><p>TLAB （Thread Local Allocation Buffer，线程本地分配缓冲区）是 Java 中内存分配的一个概念，它是在 Java 堆中划分出来的针对每个线程的内存区域，专门在该区域为该线程创建的对象分配内存。它的主要目的是在多线程并发环境下需要进行内存分配的时候，减少线程之间对于内存分配区域的竞争，加速内存分配的速度。TLAB 本质上还是在 Java 堆中的，因此在 TLAB 区域的对象，也可以被其他线程访问。</p><p>如果没有启用 TLAB，多个并发执行的线程需要创建对象、申请分配内存的时候，有可能在 Java 堆的同一个位置申请，这时就需要对拟分配的内存区域进行加锁或者采用 CAS 等操作，保证这个区域只能分配给一个线程。</p><p>启用了 TLAB 之后(-XX:+UseTLAB, 默认是开启的)，JVM 会针对每一个线程在 Java 堆中预留一个内存区域，在预留这个动作发生的时候，需要进行加锁或者采用 CAS 等操作进行保护，避免多个线程预留同一个区域。一旦某个区域确定划分给某个线程，之后该线程需要分配内存的时候，会优先在这片区域中申请。这个区域针对分配内存这个动作而言是该线程私有的，因此在分配的时候不用进行加锁等保护性的操作。</p><h2 id="大对象："><a href="#大对象：" class="headerlink" title="大对象："></a>大对象：</h2><p>所谓的大对象是指，需要大量连续内存空间的 Java 对象，最典型的大对象就是那种很长的字符串以及数组</p><p>虚拟机提供了一个-XX: PretenureSizeThreshold 参数，令大于这个设置值的对象直接在老年代分配。这样做的目的是避免在 Eden 区及两个 Survivor 区之间发生大量的内存复制</p><p>实战代码演练大对象配置</p><ul><li><p>-verbose:gc -XX:+PrintGCDetails  开启GC日志打印</p></li><li><p>-Xms20 M  设置JVM初始内存为20M</p></li><li><p>-Xmx20 M  设置JVM最大内存为20M</p></li><li><p>-Xmn10 M 设置年轻代内存大小为10M</p><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">-verbose:gc -XX:+PrintGCDetails -XX:+UseSerialGC -Xms20M -Xmx20M -Xmn10M -XX:PretenureSizeThreshold=3145728<br></code></pre></td></tr></table></figure></li></ul><h2 id="栈上分配"><a href="#栈上分配" class="headerlink" title="栈上分配"></a>栈上分配</h2><h3 id="逃逸分析"><a href="#逃逸分析" class="headerlink" title="逃逸分析"></a>逃逸分析</h3><p>JVM中高深的优化技术，如同类继承关系分析，该技术并非直接去优化代码，而是一种为其他优化措施提供依据的分析技术。</p><p>分析对象的动态作用域，当某对象在方法里被定义后，它可能</p><p>方法逃逸</p><p>​被外部方法引用，例如作为参数传递给其他方法</p><p>线程逃逸</p><p>​被外部线程访问，例如赋值给可以在其他线程中访问的实例变量</p><p>所以 Java 对象由低到高的逃逸程度即为：</p><p>不逃逸 &#x3D;》</p><p>方法逃逸 &#x3D;》</p><p>线程逃逸</p><p>若能确定一个对象，不会逃逸到方法或线程外（即其它方法、线程无法访问到该对象），或逃逸程度较低（只逃逸出方法而不逃逸出线程），则可为该对象实例采取不同程度的优化方案。</p><h3 id="开启逃逸分析后的优化"><a href="#开启逃逸分析后的优化" class="headerlink" title="开启逃逸分析后的优化"></a>开启逃逸分析后的优化</h3><p>栈上分配就是把方法中的变量和对象分配到栈上，方法执行完后自动销毁，而不需要垃圾回收的介入，从而提高系统性能</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">若有需要或确认对程序有益，可使用参数：<br>-XX：+DoEscapeAnalysis 手动开启逃逸分析<br><br>开启后可通过参数：<br>-XX：+PrintEscapeAnalysis 查看分析结果<br><br>有逃逸分析支持后，用户可使用如下参数：<br>-XX：+EliminateAllocations 开启标量替换<br>+XX：+EliminateLocks 开启同步消除<br>-XX：+PrintEliminateAllocations 查看标量的替换情况<br></code></pre></td></tr></table></figure><h4 id="栈上分配-1"><a href="#栈上分配-1" class="headerlink" title="栈上分配"></a>栈上分配</h4><p>栈上分配可支持方法逃逸，但不能支持线程逃逸。</p><h4 id="标量替换"><a href="#标量替换" class="headerlink" title="标量替换"></a>标量替换</h4><p>标量 ：若一个数据已经无法再分解成更小数据，JVM中的原始数据类型（如 int、long 等数值类型及 reference 类型）都不能再进一步分解，这些数据即为标量。</p><p>聚合量：若一个数据可继续分解，则称为聚合量（Aggregate），比如 Java 对象就是聚合量。</p><p>标量替换：</p><p>把一个Java对象拆散，根据程序访问情况，将其用到的成员变量恢复为原始类型来访问。</p><p>假如逃逸分析能证明一个对象不会被方法外部访问，并且该对象可被分解，那么程序真正执行时将可能不去创建该对象，而改为直接创建它的若干个被这方法使用的成员变量。<br>将对象拆分后：</p><p>​可让对象的成员变量在栈上 （栈上存储的数据，很大概率会被JVM分配至物理机器的高速寄存器中存储）分配和读写。</p><p>​为后续进步优化创建条件。</p><p>适用场景：标量替换可视为栈上分配一种特例，实现更简单（不用考虑对象完整结构的分配），但对逃逸程度的要求更高，它不允许对象逃逸出方法范围内。</p><h4 id="同步消除"><a href="#同步消除" class="headerlink" title="同步消除"></a>同步消除</h4><p>线程同步是个相对耗时的过程，若逃逸分析能确定一个变量不会逃逸出线程，即不会被其他线程访问，则该变量的读写肯定不会有线程竞争， 也可安全消除对该变量实施的同步措施。</p><h3 id="代码实战验证"><a href="#代码实战验证" class="headerlink" title="代码实战验证"></a>代码实战验证</h3><p>全无优化的代码 </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">test</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123; <br>  <span class="hljs-type">int</span> <span class="hljs-variable">xx</span> <span class="hljs-operator">=</span> x + <span class="hljs-number">2</span>; <br>  <span class="hljs-type">Point</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>(xx, <span class="hljs-number">42</span>); <br>  <span class="hljs-keyword">return</span> p.getX(); <br>&#125;<br></code></pre></td></tr></table></figure><p>优化step1：内联构造器和getX()方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">test</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123; <br>  <span class="hljs-type">int</span> <span class="hljs-variable">xx</span> <span class="hljs-operator">=</span> x + <span class="hljs-number">2</span>;<br>  <span class="hljs-comment">// 在堆中分配P对象 </span><br>  <span class="hljs-type">Point</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> point_memory_alloc();<br>  <span class="hljs-comment">// Point构造器被内联后  </span><br>  p.x = xx; <br>  p.y = <span class="hljs-number">42</span>;<br>  <span class="hljs-comment">// Point::getX()被内联后 </span><br>  <span class="hljs-keyword">return</span> p.x;<br>&#125;<br></code></pre></td></tr></table></figure><p>优化step2：标量替换</p><p>逃逸分析后，发现在整个test()方法的范围内Point对象实例不会发生任何程度逃逸， 便可对它进行标量替换：把其内部的x和y直接置换出来，分解为test()方法内的局部变量，从而避免了Point对象实例的创建</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">test</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123; <br>   <span class="hljs-type">int</span> <span class="hljs-variable">xx</span> <span class="hljs-operator">=</span> x + <span class="hljs-number">2</span>; <br>   <span class="hljs-type">int</span> <span class="hljs-variable">px</span> <span class="hljs-operator">=</span> xx; <br>   <span class="hljs-type">int</span> <span class="hljs-variable">py</span> <span class="hljs-operator">=</span> <span class="hljs-number">42</span> <br>   <span class="hljs-keyword">return</span> px; <br>&#125;<br></code></pre></td></tr></table></figure><p>优化step3：无效代码消除</p><p>数据流分析，发现py的值其实对方法不会造成任何影响，那就可以放心地去做无效代码消除得到最终优化结果，如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">test</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123; <br>  <span class="hljs-keyword">return</span> x + <span class="hljs-number">2</span>; <br>&#125;<br></code></pre></td></tr></table></figure><p>观察测试结果，实施逃逸分析后的程序在MicroBenchmarks中往往能得到不错的成绩，但在实际应用程序中，尤其是大型程序中反而发现实施逃逸分析可能出现效果不稳定，或分析过程耗时但却无法有效判别出非逃逸对象而导致性能（即时编译的收益）下降，所以曾经在很长的一段时间，即使是服务端编译器，也默认不开启逃逸分析（从JDK 6 Update 23开始，服务端编译器中开始才默认开启逃逸分析。），甚至在某些版本（如JDK 6 Update 18）中还曾完全禁止这项优化，一直到JDK 7时这项优化才成为服务端编译器默认开启的选项。</p>]]></content>
    
    
    <categories>
      
      <category>jvm</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jvm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jvm运行时数据区域</title>
    <link href="/2019/07/23/jvm/jvm%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA%E5%9F%9F/"/>
    <url>/2019/07/23/jvm/jvm%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA%E5%9F%9F/</url>
    
    <content type="html"><![CDATA[<h1 id="JAVA程序启动"><a href="#JAVA程序启动" class="headerlink" title="JAVA程序启动"></a>JAVA程序启动</h1><p>安装JRE或JDK后，只是把程序安装到硬盘上。</p><p>Java -jar 运行时，启动了一个进程。</p><p>JRE中包含JVM虚拟机程序，java -jar 启动时相当于JVM运行，JVM运行时，会为JVM单独划出一块内存区域，而这块内存区域又可以再次划分出一块运行时数据区。</p><h1 id="运行时数据区域"><a href="#运行时数据区域" class="headerlink" title="运行时数据区域"></a>运行时数据区域</h1><p><img src="/.com//jvm%E7%BB%93%E6%9E%84%E5%9B%BE.jpg" alt="jvm结构图"></p><p><img src="/.com//jvm%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA%E5%9F%9F.jpg" alt="jvm运行时数据区域"></p><p>JVM 内存区域主要分为线程私有区域【程序计数器、虚拟机栈、本地方法区】、线程共享区域【JAVA 堆、方法区】、直接内存。 </p><p>线程私有数据区域生命周期与线程相同, 依赖用户线程的启动&#x2F;结束 而 创建&#x2F;销毁(在 Hotspot VM 内, 每个线程都与操作系统的本地线程直接映射, 因此这部分内存区域的存&#x2F;否跟随本地线程的生&#x2F;死对应)。 </p><p>线程共享区域随虚拟机的启动&#x2F;关闭而创建&#x2F;销毁。 </p><p>直接内存并不是 JVM 运行时数据区的一部分, 但也会被频繁的使用: 在 JDK 1.4 引入的 NIO 提供了基于 Channel 与 Buffer 的 IO 方式, 它可以使用 Native 函数库直接分配堆外内存, 然后使用 DirectByteBuffer 对象作为这块内存的引用进行操作(详见:Java I&#x2F;O 扩展, 这样就避免了在 Java 堆和 Native 堆中来回复制数据, 因此在一些场景中可以显著提高性能。</p><h2 id="程序计数器"><a href="#程序计数器" class="headerlink" title="程序计数器"></a>程序计数器</h2><p>一块较小的内存空间, 是当前线程所执行的字节码的行号指示器，每条线程都要有一个独立的程序计数器，这类内存也称为“线程私有”的内存。 </p><p>正在执行 java 方法的话，计数器记录的是虚拟机字节码指令的地址（当前指令的地址）。如果还是 Native 方法，则为空。 </p><p>这个内存区域是唯一一个在虚拟机中没有规定任何 OutOfMemoryError 情况的区域。</p><h2 id="虚拟机栈"><a href="#虚拟机栈" class="headerlink" title="虚拟机栈"></a>虚拟机栈</h2><p>是描述java方法执行的内存模型，每个方法在执行的同时都会创建一个栈帧（Stack Frame）用于存储局部变量表、操作数栈、动态链接、方法出口等信息。每一个方法从调用直至执行完成的过程，就对应着一个栈帧在虚拟机栈中入栈到出栈的过程。 </p><p>栈帧（ Frame）是用来存储数据和部分过程结果的数据结构，同时也被用来处理动态链接</p><p>(Dynamic Linking)、 方法返回值和异常分派（ Dispatch Exception）。栈帧随着方法调用而创建，随着方法结束而销毁——无论方法是正常完成还是异常完成（抛出了在方法内未被捕获的异常）都算作方法结束。</p><h2 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h2><p>本地方法栈和 Java Stack 作用类似, 区别是虚拟机栈为执行 Java 方法服务, 而本地方法栈则为 Native 方法服务, 如果一个 VM 实现使用 C-linkage 模型来支持 Native 调用, 那么该栈将会是一个C 栈，但 HotSpot VM 直接就把本地方法栈和虚拟机栈合二为一。</p><h2 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h2><p>是被线程共享的一块内存区域，创建的对象和数组都保存在 Java 堆内存中，也是垃圾收集器进行垃圾收集的最重要的内存区域。由于现代 VM 采用<strong>分代收集算法</strong>, 因此 Java 堆从 GC 的角度还可以细分为: <strong>新生代</strong>(Eden区、From Survivor区和To Survivor区)和<strong>老年代。</strong> </p><h2 id="方法区-x2F-永久代"><a href="#方法区-x2F-永久代" class="headerlink" title="方法区&#x2F;永久代"></a>方法区&#x2F;永久代</h2><p>即我们常说的<strong>永久代(Permanent Generation)</strong>, 用于存储<strong>被 JVM 加载的类信息</strong>、<strong>常量</strong>、<strong>静态变量</strong>、<strong>即时编译器编译后的代码</strong>等数据. HotSpot VM把GC分代收集扩展至方法区, 即<strong>使用Java 堆的永久代来实现方法区</strong>, 这样 HotSpot 的垃圾收集器就可以像管理 Java 堆一样管理这部分内存, 而不必为方法区开发专门的内存管理器(永久带的内存回收的主要目标是针对<strong>常量池的回收</strong>和<strong>类型的卸载</strong>, 因此收益一般很小)。 </p><p>运行时常量池（Runtime Constant Pool）是方法区的一部分。Class 文件中除了有类的版本、字段、方法、接口等描述等信息外，还有一项信息是常量池（Constant Pool Table），用于存放编译期生成的各种字面量和符号引用，这部分内容将在类加载后存放到方法区的运行时常量池中。 Java 虚拟机对 Class 文件的每一部分（自然也包括常量池）的格式都有严格的规定，每一个字节用于存储哪种数据都必须符合规范上的要求，这样才会被虚拟机认可、装载和执行。</p><h2 id="堆细分"><a href="#堆细分" class="headerlink" title="堆细分"></a>堆细分</h2><p>Java 堆从 GC 的角度还可以细分为: <strong>新生代</strong>(Eden区、From Survivor区和To Survivor区)和<strong>老年代。</strong> </p><h3 id="新生代"><a href="#新生代" class="headerlink" title="新生代"></a><strong>新生代</strong></h3><p>是用来存放新生的对象。一般占据堆的1&#x2F;3空间。由于频繁创建对象，所以新生代会频繁触发</p><p>MinorGC 进行垃圾回收。新生代又分为 Eden 区、ServivorFrom、ServivorTo 三个区。 </p><p><strong>1. Eden 区</strong></p><p>Java新对象的出生地（如果新创建的对象占用内存很大，则直接分配到老年代）。当Eden区内存不够的时候就会触发MinorGC，对新生代区进行一次垃圾回收。</p><p><strong>2. ServivorFrom</strong></p><p>上一次 GC 的幸存者，作为这一次 GC 的被扫描者。 </p><p><strong>3. ServivorTo</strong> </p><p>保留了一次 MinorGC 过程中的幸存者。 </p><p><strong>4. MinorGC</strong> <strong>的过程（复制-&gt;清空-&gt;互换）</strong> </p><p>MinorGC 采用复制算法。 </p><p>1：eden、servicorFrom 复制到<strong>ServicorTo</strong>，年龄+1 </p><p>首先，把Eden和ServivorFrom区域中存活的对象复制到ServicorTo区域（如果有对象的年龄以及达到了老年的标准，则赋值到老年代区），同时把这些对象的年龄+1（如果 ServicorTo 不够位置了就放到老年区）； </p><p>2：清空eden、servicorFrom</p><p>然后，清空 Eden 和 ServicorFrom 中的对象； </p><p>3：ServicorTo 和ServicorFrom 互换 </p><p>最后，ServicorTo 和 ServicorFrom 互换，原 ServicorTo 成为下一次 GC 时的 ServicorFrom 区。 </p><h3 id="老年代"><a href="#老年代" class="headerlink" title="老年代"></a><strong>老年代</strong></h3><p>主要存放应用程序中生命周期长的内存对象。 </p><p>  老年代的对象比较稳定，所以 MajorGC 不会频繁执行。在进行 MajorGC 前一般都先进行了一次 MinorGC，使得有新生代的对象晋身入老年代，导致空间不够用时才触发。当无法找到足够大的连续空间分配给新创建的较大对象时也会提前触发一次 MajorGC 进行垃圾回收腾出空间。 </p><p>  MajorGC 采用标记清除算法：首先扫描一次所有老年代，标记出存活的对象，然后回收没有标记的对象。MajorGC 的耗时比较长，因为要扫描再回收。MajorGC 会产生内存碎片，为了减少内存损耗，我们一般需要进行合并或者标记出来方便下次直接分配。当老年代也满了装不下的时候，就会抛出 OOM（Out of Memory）异常。 </p><h3 id="永久代"><a href="#永久代" class="headerlink" title="永久代"></a><strong>永久代</strong></h3><p>指内存的永久保存区域，主要存放 Class 和 Meta（元数据）的信息,Class 在被加载的时候被放入永久区域，它和和存放实例的区域不同,GC 不会在主程序运行期对永久区域进行清理。所以这也导致了永久代的区域会随着加载的 Class 的增多而胀满，最终抛出 OOM 异常。 </p><h3 id="JAVA8与元数据"><a href="#JAVA8与元数据" class="headerlink" title="JAVA8与元数据"></a><strong>JAVA8与元数据</strong></h3><p>在Java8中，永久代已经被移除，被一个称为“元数据区”（元空间）的区域所取代。元空间的本质和永久代类似，元空间与永久代之间最大的区别在于：元空间并不在虚拟机中，而是使用本地内存。因此，默认情况下，元空间的大小仅受本地内存限制。类的元数据放入 native memory, 字符串池和类的静态变量放入 java 堆中，这样可以加载多少类的元数据就不再由MaxPermSize 控制, 而由系统的实际可用空间来控制。 </p><h1 id="直接内存"><a href="#直接内存" class="headerlink" title="直接内存"></a>直接内存</h1><p>直接内存（Direct Memory）并不是虚拟机运行时数据区的一部分，也不是 Java 虚拟机规范中定义的内存区域。</p><p>在 JDK 1.4 中新加入了 NIO，引入了一种基于通道（Channel）与缓冲区（Buffer）的 I&#x2F;O 方式，它可以使用 Native 函数库直接分配堆外内存，然后通过一个存储在 Java 堆中的 DirectByteBuffer 对象作为这块内存的引用进行操作。这样能在一些场景中显著提高性能，因为避免了在 Java 堆和 Native 堆中来回复制数据。</p><p>显然，本机直接内存的分配不会受到 Java 堆大小的限制，但是，既然是内存，肯定还是会受到本机总内存（包括 RAM 以及 SWAP 区或者分页文件）大小以及处理器寻址空间的限制。服务器管理员在配置虚拟机参数时，会根据实际内存设置 -Xmx 等参数信息，但经常忽略直接内存，使得各个内存区域总和大于物理内存限制（包括物理的和操作系统级的限制），从而导致动态扩展时出现 OutOfMemoryError 异常。</p>]]></content>
    
    
    <categories>
      
      <category>jvm</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jvm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jvm类加载过程</title>
    <link href="/2019/07/23/jvm/jvm%E7%B1%BB%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B/"/>
    <url>/2019/07/23/jvm/jvm%E7%B1%BB%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="类加载过程"><a href="#类加载过程" class="headerlink" title="类加载过程"></a>类加载过程</h1><p>如果 JVM 想要执行这个 .class 文件，我们需要将其装进一个类加载器 中，它就像一个搬运工一样，会把所有的 .class 文件全部搬进JVM里面来。</p><p><img src="/.com//JVM%E7%B1%BB%E5%8A%A0%E8%BD%BD%E4%B8%80.jpeg" alt="JVM类加载一"></p><p><img src="/.com//JVM%E7%B1%BB%E5%8A%A0%E8%BD%BD%E4%BA%8C.jpeg" alt="JVM类加载二"></p><h1 id="类加载流程"><a href="#类加载流程" class="headerlink" title="类加载流程"></a>类加载流程</h1><p>JVM 类加载机制分为五个部分：加载，验证，准备，解析，初始化。</p><p>在这五个阶段中，加载、验证、准备和初始化这四个阶段发生的顺序是确定的，而解析阶段则不一定，它在某些情况下可以在初始化阶段之后开始，这是为了支持Java语言的运行时绑定（也成为动态绑定或晚期绑定）。另外注意这里的几个阶段是按顺序开始，而不是按顺序进行或完成，因为这些阶段通常都是互相交叉地混合进行的，通常在一个阶段执行的过程中调用或激活另一个阶段。</p><p><img src="/.com//JVM%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6%E7%9A%84%E4%BA%94%E4%B8%AA%E9%83%A8%E5%88%86.png" alt="JVM类加载机制的五个部分"></p><h2 id="加载"><a href="#加载" class="headerlink" title="加载"></a>加载</h2><p>查找并加载类的二进制数据加载时类加载过程的第一个阶段，在加载阶段，虚拟机需要完成以下三件事情：</p><ul><li>通过一个类的全限定名来获取其定义的二进制字节流。</li><li>将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。</li><li>在Java堆中生成一个代表这个类的 java.lang.Class对象，作为对方法区中这些数据的访问入口。</li></ul><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>确保被加载的类的正确性。</p><p>验证是连接阶段的第一步，这一阶段的目的是为了确保Class文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。验证阶段大致会完成4个阶段的检验动作：</p><ul><li>文件格式验证：验证字节流是否符合Class文件格式的规范；例如：是否以 0xCAFEBABE开头、主次版本号是否在当前虚拟机的处理范围之内、常量池中的常量是否有不被支持的类型。</li><li>元数据验证：对字节码描述的信息进行语义分析（注意：对比javac编译阶段的语义分析），以保证其描述的信息符合Java语言规范的要求；例如：这个类是否有父类，除了 java.lang.Object之外。</li><li>字节码验证：通过数据流和控制流分析，确定程序语义是合法的、符合逻辑的。</li><li>符号引用验证：确保解析动作能正确执行。</li></ul><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><blockquote><p>为类的静态变量分配内存，并将其初始化为默认值</p></blockquote><p>准备阶段是正式为类变量分配内存并设置类变量初始值的阶段，这些内存都将在方法区中分配。对于该阶段有以下几点需要注意：</p><ul><li>这时候进行内存分配的仅包括类变量（static），而不包括实例变量，实例变量会在对象实例化时随着对象一块分配在Java堆中。</li><li>这里所设置的初始值通常情况下是数据类型默认的零值（如0、0L、null、false等），而不是被在Java代码中被显式地赋予的值。</li><li>如果类字段的字段属性表中存在 ConstantValue属性，即同时被final和static修饰，那么在准备阶段变量value就会被初始化为ConstValue属性所指定的值。</li></ul><blockquote><p>假设一个类变量的定义为：publicstaticintvalue&#x3D;3，那么变量value在准备阶段过后的初始值为0，而不是3，因为这时候尚未开始执行任何Java方法，value赋值为3的动作将在初始化阶段才会执行。</p></blockquote><h2 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h2><blockquote><p>把类中的符号引用转换为直接引用</p></blockquote><p>解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程，解析动作主要针对类或接口、字段、类方法、接口方法、方法类型、方法句柄和调用点限定符7类符号引用进行。符号引用就是一组符号来描述目标，可以是任何字面量。直接引用就是直接指向目标的指针、相对偏移量或一个间接定位到目标的句柄。</p><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><p>初始化其实就是一个赋值的操作，它会执行一个类构造器的方法。由编译器自动收集类中所有变量的赋值动作，此时准备阶段时的那个static int a &#x3D; 3 的例子，在这个时候就正式赋值为3</p><h2 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a><strong>卸载</strong></h2><p>GC将无用对象从内存中卸载，Java虚拟机将结束生命周期：</p><ul><li>执行了 System.exit()方法</li><li>程序正常执行结束</li><li>程序在执行过程中遇到了异常或错误而异常终止</li><li>由于操作系统出现错误而导致Java虚拟机进程终止</li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>除了在加载阶段可以自定义类加载器以外，其它操作都由 JVM 主导。</p><h1 id="类加载器"><a href="#类加载器" class="headerlink" title="类加载器"></a>类加载器</h1><p>加载一个Class类的顺序也是有优先级的，类加载器从最底层开始往上的顺序是这样的：</p><ul><li>BootStrap ClassLoader：rt.jar</li><li>Extention ClassLoader: 加载扩展的jar包</li><li>App ClassLoader：指定的classpath下面的jar包</li><li>Custom ClassLoader：自定义的类加载器</li></ul><h2 id="双亲委派机制"><a href="#双亲委派机制" class="headerlink" title="双亲委派机制"></a>双亲委派机制</h2><p>双亲委派模型的工作流程是：如果一个类加载器收到了类加载的请求，它首先不会自己去尝试加载这个类，而是把请求委托给父加载器去完成，依次向上，因此，所有的类加载请求最终都应该被传递到顶层的启动类加载器中，只有当父加载器在它的搜索范围中没有找到所需的类时，即无法完成该加载，子加载器才会尝试自己去加载该类。</p><p>双亲委派机制：</p><ul><li>当 AppClassLoader加载一个class时，它首先不会自己去尝试加载这个类，而是把类加载请求委派给父类加载器ExtClassLoader去完成。</li><li>当 ExtClassLoader加载一个class时，它首先也不会自己去尝试加载这个类，而是把类加载请求委派给BootStrapClassLoader去完成。</li><li>如果 BootStrapClassLoader加载失败（例如在 $JAVA_HOME&#x2F;jre&#x2F;lib里未查找到该class），会使用 ExtClassLoader来尝试加载；</li><li>若ExtClassLoader也加载失败，则会使用 AppClassLoader来加载，如果 AppClassLoader也加载失败，则会报出异常 ClassNotFoundException。</li></ul><h2 id="开放服务网关协议"><a href="#开放服务网关协议" class="headerlink" title="开放服务网关协议"></a>开放服务网关协议</h2><p>OSGi(Open Service Gateway Initiative)，是面向 Java 的动态模型系统，是 Java 动态化模块化系统的一系列规范。 </p><p>OSGi 服务平台提供在多种网络设备上无需重启的动态改变构造的功能。为了最小化耦合度和促使这些耦合度可管理，OSGi 技术提供一种面向服务的架构，它能使这些组件动态地发现对方。 </p><p>模块化编程与热插拔</p><p>OSGi 旨在为实现 Java 程序的模块化编程提供基础条件，基于 OSGi 的程序很可能可以实现模块级的热插拔功能，当程序升级更新时，可以只停用、重新安装然后启动程序的其中一部分，这对企业级程序开发来说是非常具有诱惑力的特性。 </p><p>OSGi 描绘了一个很美好的模块化开发目标，而且定义了实现这个目标的所需要服务与架构，同时也有成熟的框架进行实现支持。但并非所有的应用都适合采用 OSGi 作为基础架构，它在提供强大功能同时，也引入了额外的复杂度，因为它不遵守了类加载的双亲委托模型。 </p>]]></content>
    
    
    <categories>
      
      <category>jvm</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jvm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>计算java对象所占内存大小</title>
    <link href="/2019/07/23/jvm/%E8%AE%A1%E7%AE%97java%E5%AF%B9%E8%B1%A1%E6%89%80%E5%8D%A0%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F/"/>
    <url>/2019/07/23/jvm/%E8%AE%A1%E7%AE%97java%E5%AF%B9%E8%B1%A1%E6%89%80%E5%8D%A0%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F/</url>
    
    <content type="html"><![CDATA[<p>转载自：<a href="https://bbs.huaweicloud.com/blogs/345655?utm_source=cnblog&amp;utm_medium=bbs-ex&amp;utm_campaign=other&amp;utm_content=content">https://bbs.huaweicloud.com/blogs/345655?utm_source=cnblog&amp;utm_medium=bbs-ex&amp;utm_campaign=other&amp;utm_content=content</a></p><h1 id="计算java对象所占内存大小"><a href="#计算java对象所占内存大小" class="headerlink" title="计算java对象所占内存大小"></a>计算java对象所占内存大小</h1><h2 id="1-使用jdk8自带API"><a href="#1-使用jdk8自带API" class="headerlink" title="1.使用jdk8自带API"></a>1.使用jdk8自带API</h2><p>使用这种jdk8方式时，Open JDK 不是天然支持的，需要set一下环境变量</p><figure class="highlight javascript"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">System</span>.<span class="hljs-title function_">setProperty</span>(<span class="hljs-string">&quot;java.vm.name&quot;</span>,<span class="hljs-string">&quot;Java HotSpot(TM) &quot;</span>);<br><span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-title class_">ObjectSizeCalculator</span>.<span class="hljs-title function_">getObjectSize</span>(3L));<br></code></pre></td></tr></table></figure><p>结果如下：<br><img src="https://bbs-img.huaweicloud.com/blogs/img/20220411/1649661077252994863.png" alt="结果如下"></p><h2 id="2-借助org-apache-lucene工具类"><a href="#2-借助org-apache-lucene工具类" class="headerlink" title="2. 借助org.apache.lucene工具类"></a>2. 借助org.apache.lucene工具类</h2><p>当一个对象有多个属性，需要计算整个对象的大小时，可以借助org.apache.lucene工具类<br>先引入maven坐标</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&lt;dependency&gt;<br>          <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.lucene<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br>          <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lucene-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br>          <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br>      &lt;/dependency&gt;<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang3<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.12.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p>测试代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>      <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;map init value is &quot;</span> + <span class="hljs-title class_">RamUsageEstimator</span>.<span class="hljs-title function_">sizeOf</span>(map));<br>      <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br>          <span class="hljs-title class_">RandomStringUtils</span>.<span class="hljs-title function_">randomAlphanumeric</span>(<span class="hljs-number">100</span>);<br>          map.<span class="hljs-title function_">put</span>(<span class="hljs-title class_">RandomStringUtils</span>.<span class="hljs-title function_">randomAlphanumeric</span>(<span class="hljs-number">10</span>), <span class="hljs-title class_">RandomStringUtils</span>.<span class="hljs-title function_">randomAlphanumeric</span>(<span class="hljs-number">10</span>));<br>      &#125;<br>      <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;map size 100, value is &quot;</span> + <span class="hljs-title class_">RamUsageEstimator</span>.<span class="hljs-title function_">sizeOf</span>(map));<br>      <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;map size 100, value is &quot;</span> + <span class="hljs-title class_">RamUsageEstimator</span>.<span class="hljs-title function_">humanSizeOf</span>(map));<br></code></pre></td></tr></table></figure><p>结果如下：<br><img src="https://bbs-img.huaweicloud.com/blogs/img/20220411/1649662974945589459.png" alt="image-20220411152738070.png"></p><h2 id="3-借助jol工具类"><a href="#3-借助jol工具类" class="headerlink" title="3. 借助jol工具类"></a>3. 借助jol工具类</h2><p>如果需要查看某个对象的详细内存分布，可以借助jol工具类，不过这种当对象中内嵌其他对象时，只能计算ClassLayout方法中这个object对象所占内存的大小</p><p>先导入maven坐标</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&lt;dependency&gt;<br>          <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.openjdk.jol<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br>          <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jol-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br>          <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br>      &lt;/dependency&gt;<br></code></pre></td></tr></table></figure><p>测试代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-title class_">ClassLayout</span>.<span class="hljs-title function_">parseInstance</span>(23L).<span class="hljs-title function_">toPrintable</span>());<br></code></pre></td></tr></table></figure><p>结果如下：</p><p><img src="https://bbs-img.huaweicloud.com/blogs/img/20220411/1649662942093472910.png" alt="image-20220411153512165.png"></p><h2 id="4-java对象内存分布"><a href="#4-java对象内存分布" class="headerlink" title="4. java对象内存分布"></a>4. java对象内存分布</h2><p>最后，计算一个对象占用多大内存，需要提前了解java对象的布局，可以参考这篇<a href="https://blog.csdn.net/belongtocode/article/details/103377187">博客</a></p>]]></content>
    
    
    <categories>
      
      <category>jvm</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jvm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jvm垃圾回收</title>
    <link href="/2019/07/23/jvm/jvm%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/"/>
    <url>/2019/07/23/jvm/jvm%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.cnblogs.com/czwbig/p/11127124.html">https://www.cnblogs.com/czwbig/p/11127124.html</a> JVM  JMM</p><p><a href="https://zhuanlan.zhihu.com/p/402225242">https://zhuanlan.zhihu.com/p/402225242</a> </p><p><a href="http://blog.csdn.net/java2000_wl/article/details/8042010">http://blog.csdn.net/java2000_wl/article/details/8042010</a>  jvm参数</p><p><a href="http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html">http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html</a> jvm参数</p><h1 id="如何确定对象是垃圾"><a href="#如何确定对象是垃圾" class="headerlink" title="如何确定对象是垃圾"></a>如何确定对象是垃圾</h1><h2 id="引用计数法："><a href="#引用计数法：" class="headerlink" title="引用计数法："></a>引用计数法：</h2><p>堆中每个对象实例都有⼀个引⽤用计数。当⼀个对象被创建时，且将该对象实例分配给⼀个变量，该变量计数设置为1。当任何其它变量被赋值为这个对象的引⽤用时，计数加1（a &#x3D; b,则b引⽤的对象实例的计数器+1），但当一个对象实例的某个引⽤超过了生命周期或者被设置为一个新值时，对象实例的引用计数器减1。任何引用计数器为0的对象实例可以被当作垃圾收集。当一个对象实例被垃圾收集时，它引用的任何对象实例的引⽤计数器减1。</p><h3 id="缺点："><a href="#缺点：" class="headerlink" title="缺点："></a>缺点：</h3><p>无法处理循环引用。</p><h2 id="可达性分析算法："><a href="#可达性分析算法：" class="headerlink" title="可达性分析算法："></a>可达性分析算法：</h2><p>根搜索算法是从离散数学中的图论引入的，程序把所有的引用关系看作一张图，从一个节点GC ROOT开始，寻找对应的引用节点，找到这个节点以后，继续寻找这个节点的引⽤用节点，当所有的引用节点寻找完毕之后，剩余的节点则被认为是没有被引用到的节点，即无用的节点（垃圾）。</p><p>可以做为GC ROOT的节点有：</p><ul><li>Java虚拟机栈中被引用的对象，各个线程调用的参数、局部变量、临时变量等。</li><li>方法区中类静态属性引用的对象，比如引用类型的静态变量。</li><li>方法区中常量引用的对象。</li><li>本地方法栈中所引用的对象。</li><li>Java虚拟机内部的引用，基本数据类型对应的Class对象，一些常驻的异常对象。</li><li>被同步锁（synchronized）持有的对象。</li></ul><h3 id="三色标记算法"><a href="#三色标记算法" class="headerlink" title="三色标记算法"></a>三色标记算法</h3><p>不可达对象不等价于可回收对象，不可达对象变为可回收对象至少要经过两次标记过程。两次标记后仍然是可回收对象，则将面临回收。</p><p>分为三个颜色：白色、灰色和黑色：</p><p>白色：这个对象尚示被垃圾收集器访问过，在初始阶段，所有对象都是白色，如果在可达性分析结束后，仍然是白色的对象，即代表不可达。<br>灰色：这个对象已经被垃圾收集器访问过，但是这个对象上至少存在一个直接引用还没有被扫描过。<br>黑色：对象和它所直接引用的所有对象都被访问过。这里只要访问过就行，比如A只引用了B，B引用了C、D，那么只要A和B都被访问过，A就是黑色，即使B所引用的C或D还没有被访问到，此时B就是灰色。</p><p>根据这些定义，我们可以得出：</p><p>在可达性分析的初始阶段，所有对象都是白色，一旦访问了这个对象，那么就变成灰色，一旦这个对象所有直接引用的对象都访问过（或者没有引用其它对象），那么就变成黑色。</p><p>初始标记之后(标记GC Roots 能直接关联的对象)，GC Root节点变为黑色（GC Root不会是垃圾），GC Root直接引用的对象变为灰色。</p><p>正常情况下，一个对象如果是黑色，那么其直接引用的对象要么是黑色，要么是灰色，不可能是白色（如果出现了黑色对象直接引用白色对象的情况，就说明漏标了，就会导致对象误删，后面会介绍如何解决），这个特性也可以说是三色标记算法正确性保障的前提条件。</p><h4 id="并发标记带来的问题"><a href="#并发标记带来的问题" class="headerlink" title="并发标记带来的问题"></a>并发标记带来的问题</h4><p>如果整个标记过程是STW的，那么没有任何问题，但是并发标记的过程中，用户线程也在运行，那么对象引用关系就可能发生改变，进而导致两个问题出现。</p><p>2.1 浮动垃圾:<br>—–把垃圾也标黑了</p><p><img src="/.com//%E4%B8%89%E8%89%B2%E6%A0%87%E8%AE%B0%E6%B5%AE%E5%8A%A8%E5%9E%83%E5%9C%BE.jpg" alt="三色标记浮动垃圾"></p><p>浮动垃圾你觉得没啥所谓，即使本次不清理，下一次GC也会被清理，而且并发清理阶段也会产生所谓的浮动垃圾，影响不大。</p><p>2.2 非垃圾变成了垃圾</p><p>在1994年Wilson在理论上证明了，当且仅当以下两个条件<strong>同时满足</strong>时，会产生“对象消失”的问题，即：应该是黑色的对象被误标记为白色。</p><ul><li><strong>赋值器插入了一条或多条从黑色对象到白色对象的新引用</strong></li><li><strong>赋值器删除了全部从灰色对象到该白色对象的直接或间接引用</strong></li></ul><p><img src="/.com//%E4%B8%89%E8%89%B2%E6%A0%87%E8%AE%B0%E9%9D%9E%E5%9E%83%E5%9C%BE%E6%A0%87%E8%AE%B0%E4%B8%BA%E5%9E%83%E5%9C%BE.jpg" alt="三色标记非垃圾标记为垃圾"></p><h4 id="解决非垃圾标记为垃圾"><a href="#解决非垃圾标记为垃圾" class="headerlink" title="解决非垃圾标记为垃圾"></a>解决非垃圾标记为垃圾</h4><p>出现这个问题的主要原因是，一个对象从被B引用，变更为了被A引用。那么对于A来说就是多了一个直接引用，对于B来说就是少了一个直接引用。</p><p>CMS  <strong>增量更新</strong>（Incremental Update）</p><p><strong>增量更新是站在新增引用的对象（也就是例子中的A对象）的角度来解决问题。所谓增量更新，就是在赋值操作之前添加一个写屏障，在写屏障中记录新增的引用</strong>。</p><p>比如，用户线程要执行：A.f &#x3D; F；那么在写屏障中将新增的这个引用关系记录下来。</p><p>标准的描述就是，当黑色对象新增一个白色对象的引用时，就通过写屏障将这个引用关系记录下来。然后<strong>在重新标记阶段，再以这些引用关系中的黑色对象为根，再扫描一次，以此保证不会漏标</strong>。</p><p>要实现也很简单，在重新标记阶段直接把A对象（和其它有相同情况发生的对象）变为灰色，放入队列中，再来一次枚举过程。要注意，在重新标记阶段如果用户线程还是继续执行，那么这个GC永远可能也做不完了，所以重新标记需要STW，但是这个时间消耗不会太夸张。</p><p>G1  <strong>原始快照(SATB, Snapshot At The Beginning)</strong></p><p><strong>原始快照是站在减少引用的对象（也就是例子中的B对象）的角度来解决问题。所谓原始快照，简单的讲，就是在赋值操作（这里是置空）执行之前添加一个写屏障，在写屏障中记录被置空的对象引用</strong>。</p><p>比如，用户线程要执行：B.f&#x3D;null；那么在写屏障中，首先会把B.f记录下来，然后再进行置空操作。记录下来的这个对象就可以称为原始快照。</p><p>那么记录下来之后呢？很简单，之后直接把它变为黑色。意思就是默认认为它不是垃圾，不需要将其清理。当然，这样处理有两种情况，一种情况是，F的确不是垃圾，直到清理的那一刻，都仍然有至少一个引用链能访问到它，这没有什么问题；另一种情况就是F又变成了垃圾。在上述的例子中，就是A到F的引用链也断了，或者直接A都成垃圾了，那F对象就成了浮动垃圾。对于浮动垃圾，前面不止一次就提到了，直接不用理会，如果到下一次GC时它仍然是垃圾，自然会被清理掉。</p><p><strong>方案抉择</strong></p><p>从增量更新和原始快照的实现（理论上）就可以发现，原始快照相比于增量更新来说效率会更高，因为不用在重新标记阶段再去做枚举遍历，但是也就可能会导致有更多的浮动垃圾。G1使用的就是原始快照，CMS使用的是增量更新。<br>  既然原始快照可能会有更严重的浮动垃圾问题，那么为什么不使用增量更新呢？原因可能很简单，就是因为简单。想象一下，G1虽然也是基于年轻代和老年代的分代收集算法，但是年轻代和老年代被弱化为了逻辑上，其所管理的内存被划分为了很多region，对象跨代引用带来的问题在G1中要比传统的分代收集器更加突出，虽然有Remember Set方案缓解，但是相对来说在重新标记阶段进行再次遍历枚举的代价会大很多。最重要的是，重新标记（最终标记）阶段是会STW的，如果这个阶段花费太多的时间去做可达性分析，那么就违背了G1低延时的理念。</p><h1 id="垃圾回收算法"><a href="#垃圾回收算法" class="headerlink" title="垃圾回收算法"></a>垃圾回收算法</h1><h2 id="标记清除算法"><a href="#标记清除算法" class="headerlink" title="标记清除算法"></a>标记清除算法</h2><p>算法分为标记和清除两个阶段。首先标记出所有需要回收的对象，在标记完成后统一回收所有被标记的对象。</p><h3 id="不足"><a href="#不足" class="headerlink" title="不足"></a>不足</h3><p>1.效率问题，标记和清除两个过程的效率都不高;</p><p>2.另一个是空间问题，标记清除之后会产生大量不连续的内存碎片，内存碎片太多可能会导致以后在程序运行过程中需要分配大对象时 ，无法找到足够的连续内存而不得不提前触发别一次垃圾收集动作。</p><h2 id="复制算法"><a href="#复制算法" class="headerlink" title="复制算法"></a>复制算法</h2><p>拥有两块大小相等的内存，每次只使用其中的一块，当这一块的内存用完了，就将还存活着的对象复制到另外一块上面，然后再把已使用过的内存空间一次清理掉。这样使得每次都是对整个半区进行内存回收，内存分配时也就不用考虑内存碎片问题，只要移动堆指针，按顺序分配内存即可，实现简单，运行高效。</p><p>复制算法一般用在回收新生代。研究表明，新生代中的对象98%是朝生夕死的，所以并不需要按照1：1的比例来划分内存空间，而是将内存分为一块较大的Eden区和两块较小的survivor区，每次使用eden和其中一块survivor。survivor from 和 survivor to,内存默认比例8：1：1。默认会浪费10%的内存空间，当survivor空间不够用时，需要依赖其他内存（这里指老年代）进行分配担保。</p><h2 id="标记整理算法"><a href="#标记整理算法" class="headerlink" title="标记整理算法"></a>标记整理算法</h2><p>对象存活率较高时复制操作耗时，有可能还需要分配担保，一般老年代不使复制算法。老年代使用标记整理算法。</p><p>首先标记出所有需要回收的对象，让所有存活对象都向一端移动，然后直接清理掉端边界以外的内存。</p><h1 id="GC-分代收集算法-VS-分区收集算法"><a href="#GC-分代收集算法-VS-分区收集算法" class="headerlink" title="GC 分代收集算法 VS 分区收集算法"></a>GC 分代收集算法 VS 分区收集算法</h1><h2 id="分代收集算法"><a href="#分代收集算法" class="headerlink" title="分代收集算法"></a>分代收集算法</h2><p>当前主流 VM 垃圾收集都采用”分代收集”(Generational Collection)算法, 这种算法会根据对象存活周期的不同将内存划分为几块, 如 JVM 中的 新生代、老年代、永久代，这样就可以根据各年代特点分别采用最适当的 GC 算法 </p><h3 id="在新生代"><a href="#在新生代" class="headerlink" title="在新生代"></a>在新生代</h3><p> 每次垃圾收集都能发现大批对象已死, 只有少量存活. 因此选用复制算法, 只需要付出少量存活对象的复制成本就可以完成收集. </p><h3 id="在老年代"><a href="#在老年代" class="headerlink" title="在老年代"></a>在老年代</h3><p> 因为对象存活率高、没有额外空间对它进行分配担保, 就必须采用“标记-清理”或“标记-整理”算法来进行回收, 不必进行内存复制, 且直接腾出空闲内存. </p><h2 id="分区收集算法"><a href="#分区收集算法" class="headerlink" title="分区收集算法"></a>分区收集算法</h2><p>分区算法则将整个堆空间划分为连续的不同小区间, 每个小区间独立使用, 独立回收. 这样做的好处是可以控制一次回收多少个小区间 , 根据目标停顿时间, 每次合理地回收若干个小区间(而不是整个堆), 从而减少一次 GC 所产生的停顿。 </p><h1 id="串行、并发、并行"><a href="#串行、并发、并行" class="headerlink" title="串行、并发、并行"></a>串行、并发、并行</h1><p>你吃饭吃到一半，电话来了，你一直到吃完了以后才去接，这就说明你不支持并发也不支持并行。<br>你吃饭吃到一半，电话来了，你停了下来接了电话，接完后继续吃饭，这说明你支持并发。<br>你吃饭吃到一半，电话来了，你一边打电话一边吃饭，这说明你支持并行。</p><p>并发的关键是你有处理多个任务的能力，不一定要同时。</p><p>并行的关键是你有同时处理多个任务的能力。</p><p>所以我认为它们最关键的点就是：是否是『同时』。</p><h1 id="垃圾回收器"><a href="#垃圾回收器" class="headerlink" title="垃圾回收器"></a>垃圾回收器</h1><table><thead><tr><th>收集器</th><th>收集线程和stop the world</th><th>新生代、老年代</th><th>算法</th><th>目标</th><th>适用场景</th></tr></thead><tbody><tr><td>Serial</td><td>单线程收集线程，整个收集过程stop the world</td><td>新生代</td><td>复制算法</td><td>响应速度优先</td><td>单CPU环境下的client模式</td></tr><tr><td>parNew</td><td>多线程收集线程，整个收集过程stop the world</td><td>新生代</td><td>复制算法</td><td>响应速度优先</td><td>多CPU环境时在server模式下与CMS配合</td></tr><tr><td>Parallel scanvenge</td><td>多线程收集线程，整个收集过程stop the world</td><td>新生代</td><td>复制算法</td><td>吞吐量优先</td><td>在后台运算而不需要太多交互的任务</td></tr><tr><td>Serial old</td><td>单线程收集线程，整个收集过程stop the world</td><td>老年代</td><td>标记整理</td><td>响应速度优先</td><td>单CPU环境下的client模式、CMS的后备方案</td></tr><tr><td>Parallel old</td><td>多线程收集线程，整个收集过程stop the world</td><td>老年代</td><td>标记整理</td><td>吞吐量优先</td><td>在后台运算而不需要太多交互的任务</td></tr><tr><td>CMS</td><td>分段，多线程，初始标记、重新标记时stop the world</td><td>老年代</td><td>标记清除</td><td>响应速度优先</td><td>集中在网站或B&#x2F;S系统服务端上的应用</td></tr><tr><td>G1</td><td>分段，多线程，初始标记时stop the world,其他阶段可设置</td><td>逻辑分代，分区</td><td>标记整理 + 复制</td><td>响应速度优先</td><td>面向服务端应用，大内存时使用</td></tr></tbody></table><h2 id="ParNew-垃圾收集器"><a href="#ParNew-垃圾收集器" class="headerlink" title="ParNew 垃圾收集器"></a>ParNew 垃圾收集器</h2><p>ParNew 收集器默认开启和 CPU 数目相同的线程数，可以通过-XX:ParallelGCThreads 参数来限制垃圾收集器的线程数。</p><h2 id="parallel-scavenge收集器"><a href="#parallel-scavenge收集器" class="headerlink" title="parallel scavenge收集器"></a>parallel scavenge收集器</h2><p>可以通过指定垃圾收集器最大停顿时间（-XX:MaxGCPauseMillis），来达到我们预期设定的吞吐量大小（-XX:GCTimeRatio）。</p><p>吞吐量 &#x3D; 执行用户代码时间 &#x2F; （执行用户代码时间 + 垃圾回收占用时间）</p><p>吞吐量即CPU用于运行用户代码的时间与CPU消耗的总时间的比值。</p><h2 id="CMS-收集器"><a href="#CMS-收集器" class="headerlink" title="CMS 收集器"></a>CMS 收集器</h2><p>Concurrent mark sweep(CMS)收集器是一种年老代垃圾收集器，其最主要目标是获取最短垃圾回收停顿时间，和其他年老代使用标记-整理算法不同，它使用多线程的标记-清除算法。 </p><p>最短的垃圾收集停顿时间可以为交互比较高的程序提高用户体验。 </p><p>CMS 工作机制相比其他的垃圾收集器来说更复杂，整个过程分为以下 4 个阶段： </p><ol><li><strong>初始标记</strong></li></ol><p>只是标记一下 GC Roots 能直接关联的对象，速度很快，仍然需要暂停所有的工作线程。</p><ol start="2"><li><strong>并发标记</strong></li></ol><p>进行 GC Roots 跟踪的过程，和用户线程一起工作，不需要暂停工作线程。</p><ol start="3"><li><strong>重新标记</strong></li></ol><p>为了修正在并发标记期间，因用户程序继续运行而导致标记产生变动的那一部分对象的标记记录，仍然需要暂停所有的工作线程。</p><ol start="4"><li><strong>并发清除</strong></li></ol><p>清除 GC Roots 不可达对象，和用户线程一起工作，不需要暂停工作线程。由于耗时最长的并发标记和并发清除过程中，垃圾收集线程可以和用户现在一起并发工作，所以总体上来看</p><p>CMS 收集器的内存回收和用户线程是一起并发地执行。 </p><p>CMS 收集器工作过程： </p><p><img src="/.com//CMS%E6%94%B6%E9%9B%86%E5%99%A8%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B.png" alt="CMS收集器工作过程"></p><h2 id="G1收集器（Garbage-First）"><a href="#G1收集器（Garbage-First）" class="headerlink" title="G1收集器（Garbage First）"></a>G1收集器（Garbage First）</h2><p>在G1收集器出现之前的所有其他收集器，包括CMS在内，垃圾收集的目标范围要么为整个新生代（Minor GC），要么就是整个老年代（Major GC），再要么就是整个Java堆（Full GC）。而G1垃圾收集器使用Mixed GC模式可以面向堆内存任何部分来组成回收集（Collection Set，一般简称为Cset）进行回收，衡量标准不再是它属于哪个年代，而是哪块内存中存放的垃圾数最多，回收收益最大。</p><p>G1基于Region的堆布局时它能够实现这个目标的关键。虽然G1仍是遵循分代收集理论设计的，但其堆内存的布局与其他收集器有非常明显的差异：G1不再坚持固定大小以及固定数量的分代区域划分，而是把连续的Java堆划分为大小相等的独立区域（Region），且每一个Region都可以根据需要扮演新生代的Eden空间，Survivor空间或者老年代空间。收集器能够对扮演不同角色的Region采用不同的策略去处理，这样无论是新创建的对象还是已经存活一段时间，熬过多次收集的旧对象都能获取很好的收集效果。</p><p>Region中还有一类特殊的Humongous区域，专门用来存储大对象。G1认为只要大小超过了一个Region容量一半的对象即可判定为大对象。每个Region的大小可以通过参数-XX：G1HeapRegionSize设定，取值范围为1MB~32MB，且为2的N次幂。而对于那些超过整个Region容量的超级大对象，将会被存放N个连续的Humongous Region中，G1的大多数行为都把HumonGous Region作为老年代的一部分来进行看待。</p><p>虽然G1仍然保留新生代和老年代的概念，但新生代和老年代不再是固定的了，它们都是一系列无序连续区域的动态集合。G1收集器之所以能建立可预测的停顿时间模型，是因为它将Region作为单词回收的最小单元，即每次收集到的内存空间都是Region大小的整数倍，这样可以有计划地避免在整个Java堆中进行全区域的垃圾收集。</p><p>更具体的思路为让G1收集器去跟踪各个Region中的垃圾堆积的”价值”大小，价值即回收所获得的空间大小以及回收所需时间的经验值，然后再后台维护一个有限级列表，每次根据用户设定的收集停顿时间（通过-XX：MaxGCPauseMillis指定，默认值为200毫秒），优先处理回收价值收益最大的Region，这也是”Garbage First”名字的由来。这种使用Region划分内存空间，以及具有优先级的区域回收方式保证了G1收集器在有限的时间内获取尽可能高的收集效率。</p><p>工作步骤：</p><ol><li>初始标记（Initial Marking）：仅仅只是标记一下GC Roots能直接关联到的对象，并且修改TAMS指针的值，让下一个阶段用户线程并发运行时，能正确地在可用的Region中分配新对象。这个阶段需要停顿线程，但耗时比较短，而且是借用进行Minor GC的时候同步完成的，所以G1收集器在这个阶段实际并没有额外的停顿。</li><li>并发标记（Concurrent Marking）：从GC Roots开始对堆中对象进行可达性分析，递归扫描整个堆里的对象图，找出要回收的对象，这阶段耗时比较长，但可与用户程序并发执行。当对象图扫描完成以后，还要重新处理SATB记录下的在并发时有引用变动的对象。</li><li>最终标记（Final Marking）：对用户线程做另一个短暂的暂停，用于处理并发阶段结束后仍遗留下来的最后那少量的SATB记录。</li><li>筛选回收（Live Data Counting and Evacuation）: 负责更新Region的统计数据，对各个Region的回收价值和成本进行排序，根据用户所期望的停顿时间来制定回收计划，可以自由选择任意多个Region构成回收集，然后把决定回收的那一部分Region的存活对象复制到空的Region中，再清理掉整个旧Region的全部空间。这里的操作涉及存活对象的移动，是必须暂停用户线程，由多条收集器线程并行完成的。</li></ol><p><img src="/.com//g1%E6%94%B6%E9%9B%86%E5%99%A8%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B.png" alt="g1收集器工作过程"></p><h1 id="GC类型"><a href="#GC类型" class="headerlink" title="GC类型"></a>GC类型</h1><ul><li>Minor GC&#x2F;Young GC：针对新生代的垃圾收集；（耗时较短、发生频率高）</li><li>Major GC&#x2F;Old GC：针对老年代的垃圾收集。（耗时较长、发生频率低）</li><li>Full GC：针对整个Java堆以及方法区的垃圾收集。</li></ul><h2 id="Minor-GC工作原理"><a href="#Minor-GC工作原理" class="headerlink" title="Minor GC工作原理"></a>Minor GC工作原理</h2><p>通常情况下，初次被创建的对象存放在新生代的Eden区，当第一次触发Minor GC，Eden区存活的对象被转移到Survivor区的某一块区域。以后再次触发Minor GC的时候，Eden区的对象连同一块Survivor区的对象一起，被转移到了另一块Survivor区。可以看到，这两块Survivor区我们每一次只使用其中的一块，这样也仅仅是浪费了一块Survivor区。</p><p>需要注意的2点：</p><ul><li>每经历过一次垃圾回收的对象，它的分代年龄就加1，当分代年龄达到15以后，就直接被存放到老年代中。</li><li>给大对象分配内存的时候，大对象就会直接进入老年代。</li></ul><h2 id="Full-GC工作原理"><a href="#Full-GC工作原理" class="headerlink" title="Full GC工作原理"></a>Full GC工作原理</h2><p>老年代是存储长期存活的对象的，占满时就会触发我们最常听说的Full GC，期间会停止所有线程等待GC的完成。所以对于响应要求高的应用应该尽量去减少发生Full GC从而避免响应超时的问题。</p><p>需要注意的几点：</p><ul><li>Full GC耗时较长，发生次数远没有Minor GC频繁，太频繁意味着性能出现问题。</li><li>标记-清除算法会产生大量内存碎片，以后如果需要为大对象分配内存空间时，若无法找到足够的连续的内存空间，就会提前触发一次GC回收操作。</li></ul><blockquote><p>无论是Minor GC，还是Full GC，都会产生停顿现象，即Stop-The-World。Minor GC停顿时间较短，而Full GC耗时较长将导致长时间停顿、系统无响应，极大影响系统的性能。因此，Full GC日志的监控和性能分析在性能优化中极为重要。</p></blockquote><p>FullGC触发条件</p><ul><li><p>调用 System.gc()<br>此方法的调用是建议 JVM 进行 Full GC，虽然只是建议而非一定，但很多情况下它会触发 Full GC。因此强烈建议能不使用此方法就不要使用，让虚拟机自己去管理它的内存。可通过 -XX:+ DisableExplicitGC 来禁止 RMI 调用 System.gc()</p></li><li><p>老年代空间不足<br>老年代空间不足的常见场景为前文所讲的大对象直接进入老年代、长期存活的对象进入老年代等，当执行 Full GC 后空间仍然不足，则抛出 Java.lang.OutOfMemoryError。为避免以上原因引起的 Full GC，调优时应尽量做到让对象在 Minor GC 阶段被回收、让对象在新生代多存活一段时间以及不要创建过大的对象及数组</p></li><li><p>空间分配担保失败<br>使用复制算法的 Minor GC 需要老年代的内存空间作担保，如果出现了 HandlePromotionFailure 担保失败，则会触发 Full GC</p></li></ul><h1 id="GC日志"><a href="#GC日志" class="headerlink" title="GC日志"></a>GC日志</h1><h2 id="开启GC日志"><a href="#开启GC日志" class="headerlink" title="开启GC日志"></a>开启GC日志</h2><p>使用-verbose:gc或-XX:+PrintGC这两个标志中的任意一个能创建基本的GC日志。 默认为关闭。</p><p>使用-XX:+PrintGCDetails标志会创建更详细的GC日志</p><p>使用-XX:+PrintGCTimeStamps或者-XX:+PrintGCDateStamps 便于我们更精确地判断几次GC操作之间的时间。</p><p>默认情况下GC日志直接输出到标准输出，不过使用-Xloggc:filename标志也能修改输出到某个文件。</p><p>通过-XX:+UseGCLogfileRotation -XX:NumberOfGCLogfiles&#x3D;N -XX:GCLogfileSize&#x3D;N标志可以控制日志文件的循环。</p><p>默认情况下，UseGCLogfileRotation标志是关闭的。它负责打开或关闭GC日志滚动记录功能的。要求必须设置 -Xloggc参数<br>开启UseGCLogfileRotation标志后，默认的文件数目是0（意味着不作任何限制），默认的日志文件大小是0（同样也是不作任何限制）。</p><figure class="highlight sh"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><pre><code class="hljs sh">-XX:+PrintGCDetails  -XX:+PrintGCDateStamps  <br>-Xloggc:/var/log/gc-regionserver-test.log   <br>-XX:+UseGCLogFileRotation  <br>-XX:NumberOfGCLogFiles=10  -XX:GCLogFileSize=512k<br></code></pre></td></tr></table></figure><h2 id="日志详解"><a href="#日志详解" class="headerlink" title="日志详解"></a>日志详解</h2><p><img src="/.com//minorGC%E6%97%A5%E5%BF%97%E8%AF%A6%E8%A7%A3.jpeg" alt="minorGC日志详解"></p><p><img src="/.com//FullGC%E6%97%A5%E5%BF%97%E8%AF%A6%E8%A7%A3.jpeg" alt="FullGC日志详解"></p><h1 id="JDK提供的工具"><a href="#JDK提供的工具" class="headerlink" title="JDK提供的工具"></a>JDK提供的工具</h1><h2 id="jps"><a href="#jps" class="headerlink" title="jps"></a>jps</h2><p>JVM Process Status Tool，显示指定系统内所有的HotSpot虚拟机进程。</p><p>命令格式：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">jps [options] [<span class="hljs-built_in">hostid</span>]<br></code></pre></td></tr></table></figure><p>option参数：</p><ul><li>-l : 输出主类全名或jar路径</li><li>-q : 只输出LVMID</li><li>-m : 输出JVM启动时传递给main()的参数</li><li>-v : 输出JVM启动时显示指定的JVM参数</li></ul><h2 id="jstat"><a href="#jstat" class="headerlink" title="jstat"></a>jstat</h2><p>jstat(JVM statistics Monitoring)是用于监视虚拟机运行时状态信息的命令，它可以显示出虚拟机进程中的类装载、内存、垃圾收集、JIT编译等运行数据。</p><p><a href="https://docs.oracle.com/javase/7/docs/technotes/tools/share/jstat.html#gcnew_option">https://docs.oracle.com/javase/7/docs/technotes/tools/share/jstat.html#gcnew_option</a></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">jstat命令命令格式：<br>jstat [Options] vmid [interval] [count]<br></code></pre></td></tr></table></figure><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs text">命令参数说明：<br>Options，一般使用 -gcutil 或  -gc 查看gc 情况<br>pid，当前运行的 java进程号 <br>interval，间隔时间，单位为秒或者毫秒 <br>count，打印次数，如果缺省则打印无数次<br> <br>Options 参数如下：<br>-gc：统计 jdk gc时 heap信息，以使用空间字节数表示<br>-gcutil：统计 gc时， heap情况，以使用空间的百分比表示<br>-class：统计 class loader行为信息<br>-compile：统计编译行为信息<br>-gccapacity：统计不同 generations（新生代，老年代，持久代）的 heap容量情况<br>-gccause：统计引起 gc的事件<br>-gcnew：统计 gc时，新生代的情况<br>-gcnewcapacity：统计 gc时，新生代 heap容量<br>-gcold：统计 gc时，老年代的情况<br>-gcoldcapacity：统计 gc时，老年代 heap容量<br>-gcpermcapacity：统计 gc时， permanent区 heap容量<br></code></pre></td></tr></table></figure><p>示例 1：jstat -gc 15 5000 5</p><p>每5秒一次显示进程号为15的java进程的GC情况，每5S生成异常，一共生成5次。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs text">S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   <br>307200.0 307200.0 24333.5  0.0   2457600.0 945456.5 5120000.0  3462367.2  241360.0 209218.1 26120.0 20538.3   6642  531.164  20      6.874  538.038<br>307200.0 307200.0 24333.5  0.0   2457600.0 945513.4 5120000.0  3462367.2  241360.0 209218.1 26120.0 20538.3   6642  531.164  20      6.874  538.038<br>307200.0 307200.0 24333.5  0.0   2457600.0 968130.4 5120000.0  3462367.2  241360.0 209218.1 26120.0 20538.3   6642  531.164  20      6.874  538.038<br>307200.0 307200.0 24333.5  0.0   2457600.0 1394418.3 5120000.0  3462367.2  241360.0 209218.1 26120.0 20538.3   6642  531.164  20      6.874  538.038<br>307200.0 307200.0 24333.5  0.0   2457600.0 1867238.5 5120000.0  3462367.2  241360.0 209218.1 26120.0 20538.3   6642  531.164  20      6.874  538.038<br><br>S0C：第一个幸存区的大小<br>S1C：第二个幸存区的大小<br>S0U：第一个幸存区的使用大小<br>S1U：第二个幸存区的使用大小<br>EC：伊甸园区的大小<br>EU：伊甸园区的使用大小<br>OC：老年代大小<br>OU：老年代使用大小<br>MC：方法区大小<br>MU：方法区使用大小<br>CCSC:压缩类空间大小<br>CCSU:压缩类空间使用大小<br>YGC：年轻代垃圾回收次数<br>YGCT：年轻代垃圾回收消耗时间<br>FGC：老年代垃圾回收次数<br>FGCT：老年代垃圾回收消耗时间<br>GCT：垃圾回收消耗总时间<br>单位：KB<br></code></pre></td></tr></table></figure><p>jstat -gccapacity 15</p><p>同-gc，不过还会输出Java堆各区域使用到的最大、最小空间</p><p>jstat -gcutil 15</p><p>同-gc，不过输出的是已使用空间占总空间的百分比</p><p>jstat -gccause 15</p><p>垃圾收集统计概述（同-gcutil），附加最近两次垃圾回收事件的原因</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">LGCC：最近垃圾回收的原因<br>GCC：当前垃圾回收的原因<br></code></pre></td></tr></table></figure><p>jstat -gcnew 15</p><p>统计新生代的行为</p><p>jstat -gcold 15</p><p>统计老年代的行为</p><p>jstat -class 15</p><p>监视类装载、卸载数量、总空间以及耗费的时间。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">Loaded  Bytes  Unloaded  Bytes     Time   <br> 39163 74053.8    11505 17286.0      46.52<br><br>Loaded : 加载class的数量<br>Bytes : class字节大小<br>Unloaded : 未加载class的数量<br>Bytes : 未加载class的字节大小<br>Time : 加载时间<br></code></pre></td></tr></table></figure><p>jstat -compiler 15</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs text">输出JIT编译过的方法数量耗时等。<br><br>Compiled Failed Invalid   Time   FailedType FailedMethod<br>   53393      4       0   575.86          1 com/mysql/jdbc/AbandonedConnectionCleanupThread run<br><br>Compiled : 编译数量<br>Failed : 编译失败数量<br>Invalid : 无效数量<br>Time : 编译耗时<br>FailedType : 失败类型<br>FailedMethod : 失败方法的全限定名<br></code></pre></td></tr></table></figure><h2 id="jinfo"><a href="#jinfo" class="headerlink" title="jinfo"></a>jinfo</h2><p>jinfo (Configuration Info for Java）的作用是实时地查看和调整虚拟机各项参数。使用 jps 命令的-v 参数可以查看虚拟机启动时显式指定的参数列表，但如果想知道未被显式指定的参数的系统默认值，除了去找资料外，就只能使用 info 的-flag 选项进行查询了</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">jinfo -flag CMSInititingOccupancyFraction 1444<br></code></pre></td></tr></table></figure><h2 id="jmap"><a href="#jmap" class="headerlink" title="jmap"></a>jmap</h2><p>Jmap  (Memory Map for Java）命令用于生成堆转储快照。如果不使用 jmap 命令，要想获取 Java 堆转储快照，还有一些比较“暴力”的手段：-XX: +HeapDumpOnOutOfMemoryError 参数，可以让虚拟机在 OOM 异常出现之后自动生成 dump 文件，用于系统复盘环节</p><p>和 info 命令一样，jmap 有不少功能在 Windows 平台下都是受限的，除了生成 dump 文件的- dump 选项和用于查看每个类的实例、空间占用统计的-histo选项在所有操作系统都提供之外，其余选项都只能在Linux&#x2F;Solaris 下使用。</p><p>jmap常用命令</p><p>-dump</p><p>生成 Java 堆转储快照。格式为：-dump:  format&#x3D;b, file&#x3D; <filename></filename></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell">windows： jmap <span class="hljs-literal">-dump</span>:format=b,file=d:\a.bin <span class="hljs-number">1234</span><br>mac:      jmap <span class="hljs-literal">-dump</span>:format=b,file=/Users/daniel/deskTop<br></code></pre></td></tr></table></figure><p>-histo   more分页去查看</p><p>显示堆中对象统计信息，包括类、实例数量、合计容量</p><p>B ：byte</p><p>C :  char</p><p>I ：Int</p><p>jmap -finalizerinfo 15</p><p>打印等待回收对象的信息</p><p>jmap -heap 15</p><p>打印heap的概要信息，GC使用的算法，heap的配置及wise heap的使用情况,可以用此来判断内存目前的使用情况以及垃圾回收情况，感觉这个非常使用！</p><p>jmap -histo:live 15 | more</p><p>打印堆的对象统计，包括对象数、内存大小等等 （因为在dump:live前会进行full gc，如果带上live则只统计活对象，因此不加live的堆大小要大于加live堆的大小 ），仅打印前15行。</p><h2 id="jhat"><a href="#jhat" class="headerlink" title="jhat"></a>jhat</h2><p>jhat(JVM Heap Analysis Tool)命令是与jmap搭配使用，用来分析jmap生成的dump，jhat内置了一个微型的HTTP&#x2F;HTML服务器，生成dump的分析结果后，可以在浏览器中查看。在此要注意，一般不会直接在服务器上进行分析，因为jhat是一个耗时并且耗费硬件资源的过程，一般把服务器生成的dump文件复制到本地或其他机器上进行分析。</p><p>示例：jhat dump.hprof</p><p>当执行完毕后：</p><p>可以通过Http:&#x2F;&#x2F;localhost:7000访问：</p><p>具体排查时需要结合代码，观察是否大量应该被回收的对象在一直被引用或者是否有占用内存特别大的对象无法被回收。一般情况，会down到客户端用工具来分析。</p><h2 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h2><p>stack用于生成java虚拟机当前时刻的线程快照。线程快照是当前java虚拟机内每一条线程正在执行的方法堆栈的集合，生成线程快照的主要目的是定位线程出现长时间停顿的原因，如线程间死锁、死循环、请求外部资源导致的长时间等待等。 线程出现停顿的时候通过jstack来查看各个线程的调用堆栈，就可以知道没有响应的线程到底在后台做什么事情，或者等待什么资源。</p><p>如果java程序崩溃生成core文件，jstack工具可以用来获得core文件的java stack和native stack的信息，从而可以轻松地知道java程序是如何崩溃和在程序何处发生问题。</p><p>另外，jstack工具还可以附属到正在运行的java程序中，看到当时运行的java程序的java stack和native stack的信息, 如果现在运行的java程序呈现hung的状态，jstack是非常有用的。</p><p>命令格式：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">jstack [option] LVMID<br></code></pre></td></tr></table></figure><p>option参数:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">-F : 当正常输出请求不被响应时，强制输出线程堆栈<br>-l : 除堆栈外，显示关于锁的附加信息<br>-m : 如果调用到本地方法的话，可以显示C/C++的堆栈<br></code></pre></td></tr></table></figure><h1 id="图形化工具"><a href="#图形化工具" class="headerlink" title="图形化工具"></a>图形化工具</h1><h2 id="JConsole"><a href="#JConsole" class="headerlink" title="JConsole"></a>JConsole</h2><p>JConsole  (Java Monitoring and Management Console）是一种基于 JMX 的可视化监视、管理工具，它管理部分的功能是针对 JMXMBean 进行管理，由于 MBean 可以使用代码、中间件服务器的管理控制台或者所有符合 JMX 规范的软件进行访问。</p><p>通过JDK&#x2F;bin目录下的“jconsole.exe”启动JConsole 后，将自动搜索出本机运行的所有虚拟机进程，不需要用户自己再使用 jps 来查询了</p><p>开启远程连接</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">nohup</span> java -Xms800m -Xmx800m -XX:PermSize=256m -XX:MaxPermSize=512m -XX:MaxNewSize=512m -Dcom.sun.management.jmxremote.port=9999 <br>-Djava.rmi.server.hostname=172.16.244.151 <br>-Dcom.sun.management.jmxremote.ssl=<span class="hljs-literal">false</span> <br>-Dcom.sun.management.jmxremote.authenticate=<span class="hljs-literal">false</span> -jar /Users/daniel/Desktop/jvm-demo-0.0.1-SNAPSHOT.jar &amp;<br></code></pre></td></tr></table></figure><h2 id="VisualVM"><a href="#VisualVM" class="headerlink" title="VisualVM"></a>VisualVM</h2><p>VisualVM是一个集成命令行JDK工具和轻量级分析功能的可视化工具</p><p>在IDEA安装VisualVM插件，File-&gt; Setting-&gt; Plugins -&gt; Browers Repositrories 搜索VisualVM Launcher安装并重启IDEA</p><h2 id="arthas"><a href="#arthas" class="headerlink" title="arthas"></a>arthas</h2><p>查看arthas相关的文章</p><h2 id="其他三方工具"><a href="#其他三方工具" class="headerlink" title="其他三方工具"></a>其他三方工具</h2><ul><li>MAT：Java 堆内存分析工具。</li><li>GChisto：GC 日志分析工具。</li><li>GCViewer：GC 日志分析工具。</li><li>JProfiler：商用的性能分析利器。</li><li>async：Java 应用性能分析工具，开源、火焰图、跨平台。</li></ul><h1 id="JVM参数"><a href="#JVM参数" class="headerlink" title="JVM参数"></a>JVM参数</h1><p>JVM的命令行参数参考：<a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html</a></p><p>HotSpot参数分类</p><blockquote><p>标准： - 开头，所有的HotSpot都支持</p><p>非标准：-X 开头，特定版本HotSpot支持特定命令</p><p>不稳定：-XX 开头，下个版本可能取消</p></blockquote><p>Java -version 标准参数</p><p>java -Xloggc: var&#x2F;log&#x2F;xx.log    非标准</p><p>-XX:+PrintGCDetails  不稳定</p><h2 id="GC常用参数"><a href="#GC常用参数" class="headerlink" title="GC常用参数"></a>GC常用参数</h2><ul><li><p>-Xmn -Xms -Xmx -Xss<br>年轻代 最小堆 最大堆 栈空间</p></li><li><p>-XX:+UseTLAB<br>使用TLAB，默认打开</p></li><li><p>-XX:+PrintTLAB<br>打印TLAB的使用情况</p></li><li><p>-XX:TLABSize<br>设置TLAB大小</p></li><li><p>-XX:+DisableExplictGC<br>System.gc()不管用 ，FGC</p></li><li><p>-XX:+PrintGC</p></li><li><p>-XX:+PrintGCDetails</p></li><li><p>-XX:+PrintHeapAtGC</p></li><li><p>-XX:+PrintGCTimeStamps</p></li><li><p>-XX:+PrintGCApplicationConcurrentTime (低)<br>打印应用程序时间</p></li><li><p>-XX:+PrintGCApplicationStoppedTime （低）<br>打印暂停时长</p></li><li><p>-XX:+PrintReferenceGC （重要性低）<br>记录回收了多少种不同引用类型的引用</p></li><li><p>-verbose:class<br>类加载详细过程</p></li><li><p>-XX:+PrintVMOptions</p></li><li><p>XX:+PrintFlagsInitial 是打印所有的默认参数设置<br>-XX:+PrintFlagsFinal 是打印最终值，如果某个默认值被新值覆盖，显示新值<br>-XX:+PrintCommandLineFlags 是打印那些被新值覆盖的项</p></li><li><p>必须会用</p></li><li><p>-Xloggc:opt&#x2F;log&#x2F;gc.log</p></li><li><p>-XX:MaxTenuringThreshold<br>升代年龄，最大值15</p></li><li><p>锁自旋次数 -XX:PreBlockSpin 热点代码检测参数-XX:CompileThreshold 逃逸分析 标量替换 …<br>这些不建议设置</p></li><li><p>-XX:PermSize<br>指非堆区初始化内存分配大小。（非堆区配置）</p><p>-XX:MaxPermSize<br>指对非堆区分配内存的最大上限。（非堆区配置）</p></li></ul><h2 id="Parallel常用参数"><a href="#Parallel常用参数" class="headerlink" title="Parallel常用参数"></a>Parallel常用参数</h2><ul><li>-XX:SurvivorRatio</li><li>-XX:PreTenureSizeThreshold<br>大对象到底多大</li><li>-XX:MaxTenuringThreshold</li><li>-XX:+ParallelGCThreads<br>并行收集器的线程数，同样适用于CMS，一般设为和CPU核数相同</li><li>-XX:+UseAdaptiveSizePolicy<br>自动选择各区大小比例</li></ul><h2 id="CMS常用参数"><a href="#CMS常用参数" class="headerlink" title="CMS常用参数"></a>CMS常用参数</h2><ul><li>-XX:+UseConcMarkSweepGC</li><li>-XX:ParallelCMSThreads<br>CMS线程数量</li><li>-XX:CMSInitiatingOccupancyFraction<br>使用多少比例的老年代后开始CMS收集，默认是68%(近似值)，如果频繁发生SerialOld卡顿，应该调小，（频繁CMS回收）</li><li>-XX:+UseCMSCompactAtFullCollection<br>在FGC时进行压缩</li><li>-XX:CMSFullGCsBeforeCompaction<br>多少次FGC之后进行压缩</li><li>-XX:+CMSClassUnloadingEnabled</li><li>-XX:CMSInitiatingPermOccupancyFraction<br>达到什么比例时进行Perm回收</li><li>GCTimeRatio<br>设置GC时间占用程序运行时间的百分比</li><li>-XX:MaxGCPauseMillis<br>停顿时间，是一个建议时间，GC会尝试用各种手段达到这个时间，比如减小年轻代</li></ul><h2 id="G1常用参数"><a href="#G1常用参数" class="headerlink" title="G1常用参数"></a>G1常用参数</h2><ul><li>-XX:+UseG1GC</li><li>-XX:MaxGCPauseMillis<br>建议值，G1会尝试调整Young区的块数来达到这个值</li><li>-XX:GCPauseIntervalMillis<br>？GC的间隔时间</li><li>-XX:+G1HeapRegionSize<br>分区大小，建议逐渐增大该值，1 2 4 8 16 32。<br>随着size增加，垃圾的存活时间更长，GC间隔更长，但每次GC的时间也会更长<br>ZGC做了改进（动态区块大小）</li><li>G1NewSizePercent<br>新生代最小比例，默认为5%</li><li>G1MaxNewSizePercent<br>新生代最大比例，默认为60%</li><li>GCTimeRatio<br>GC时间建议比例，G1会根据这个值调整堆空间</li><li>ConcGCThreads<br>线程数量</li><li>InitiatingHeapOccupancyPercent<br>启动G1的堆空间占用比例</li></ul><h2 id="CMS-调优最佳参数"><a href="#CMS-调优最佳参数" class="headerlink" title="CMS 调优最佳参数"></a>CMS 调优最佳参数</h2><p>-server</p><p>-Xms6144m  指定应用程序可用的最小堆大小。</p><p>-Xmx6144m指定应用程序可用的最大堆大小。  最好和最小一样，扩容会产生内存抖动，服务停顿。</p><p>-XX:NewSize&#x3D;2048m新生代初始化内存的大小（该值需要小于-Xms的值）</p><p>-XX:MaxNewSize&#x3D;2048m  新生代可被分配的内存的最大上限（该值需要小于-Xmx的值）</p><p>-XX:MetaspaceSize&#x3D;350m设置元空间初始大小</p><p>-XX:MaxMetaspaceSize&#x3D;512m  设置元空间最大可分配大小。</p><p>-Xss256k设置栈内存的大小，设置栈的大小决定了函数调用的最大深度。</p><p>-XX:+unlockExperimentalVMOptions解锁实验参数</p><p>-XX:+UseParNewGC新生代用parNew收集器</p><p>-XX:ParallelGCThreads&#x3D;4这个参数是指定并行GC线程的数量，一般最好和CPU核心数量相当。同时这个参数只要是并行GC都可以使用。</p><p>-XX:+UseConcMarkSweepGC  使用CMS收集器。</p><p>-XX:CMSInitiatingOccupancyFraction&#x3D;75指定回收阈值</p><p>-XX:+UseCMSInitiatingOccupancyOnly开启回收阈值</p><p>-XX:MaxTenuringThreshold&#x3D;6设置对象进入老年代的年龄  最大15</p><p>-XX:+ExplicitGCInvokesConcurrentSystem.gc()是正常Full GC, 会STW。打开此参数后，在做system.gc()时会做background模式CMS GC，即并行FUll GC,可提高full GC效率。</p><p>-XX:+CMSParallelRemarkEnabled通过CMSScavengeBeforeRemark参数可以强制在重新标记阶段之前强制进行一次Young GC,通过设置 CMSParallelRemarkEnabled参数可以开启并行的Remark,加快remark的速度。</p><p>-XX:+UseCMSCompactAtFullCollection  配置在进行了Full GC时，对老年代进行压缩整理，处理掉内存碎片。</p><p>-XX:CMSFullGCsBeforeCompaction&#x3D;1配置进行了多少次 full GC之后执行一次内存压缩。</p><p>-XX:-OmitStackTraceInFastThrow关闭省略异常栈信息从而快速抛出（开启时如果一个地方多次抛出异常将清空异常堆栈信息，快速抛出）</p><h1 id="调优"><a href="#调优" class="headerlink" title="调优"></a>调优</h1><p>JVM调优应该是Java性能优化的最后一颗子弹。JVM调优不是常规手段，性能问题一般第一选择是优化程序，最后的选择才是进行JVM调优。</p><h2 id="什么是调优？"><a href="#什么是调优？" class="headerlink" title="什么是调优？"></a>什么是调优？</h2><ol><li>根据需求进行JVM规划和预调优</li><li>优化运行JVM运行环境（慢，卡顿）</li><li>解决JVM运行过程中出现的各种问题</li></ol><h2 id="调优前环境"><a href="#调优前环境" class="headerlink" title="调优前环境"></a>调优前环境</h2><p>1.如果是规划</p><p>这时要了解业务，选择合适的垃圾收集器</p><p>2.如果是压测</p><p>这时是出现响应慢还是直接OOM等问题。</p><p>3.线上监控</p><p>线上有监控发现达到阈值，或出现错误</p><h2 id="调优步骤"><a href="#调优步骤" class="headerlink" title="调优步骤"></a>调优步骤</h2><h3 id="购买主机，CPU、内存的选择"><a href="#购买主机，CPU、内存的选择" class="headerlink" title="购买主机，CPU、内存的选择"></a>购买主机，CPU、内存的选择</h3><p>CPU 核数，与多线程的垃圾收集器</p><p>内存大小，如果内存太大，应使用G1</p><h3 id="选择合适的垃圾回收器"><a href="#选择合适的垃圾回收器" class="headerlink" title="选择合适的垃圾回收器"></a>选择合适的垃圾回收器</h3><ul><li>CPU单核，那么毫无疑问Serial 垃圾收集器是你唯一的选择。</li><li>CPU多核，关注吞吐量 ，那么选择PS+PO组合。</li><li>CPU多核，关注用户停顿时间，JDK版本1.6或者1.7，那么选择CMS。</li><li>CPU多核，关注用户停顿时间，JDK1.8及以上，JVM可用内存6G以上，那么选择G1。</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs text">//设置Serial垃圾收集器（新生代）<br>开启：-XX:+UseSerialGC<br><br>//设置PS+PO,新生代使用功能Parallel Scavenge 老年代将会使用Parallel Old收集器<br>开启 -XX:+UseParallelOldGC<br><br>//CMS垃圾收集器（老年代）<br>开启 -XX:+UseConcMarkSweepGC<br><br>//设置G1垃圾收集器<br>开启 -XX:+UseG1GC<br></code></pre></td></tr></table></figure><h4 id="如何查看默认的垃圾回收器"><a href="#如何查看默认的垃圾回收器" class="headerlink" title="如何查看默认的垃圾回收器"></a>如何查看默认的垃圾回收器</h4><p>查看：</p><p>方法一：java -XX:+PrintCommandLineFlags -version</p><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>UseSerialGC</td><td>虚拟机运行在Client模式下的默认值，打开此开关后，使用serial + serial old的收集器组合进行内存回收</td></tr><tr><td>UseParNewGC</td><td>打开此开关后，使用ParNew + Serial Old 的收集器组合进行内存回收</td></tr><tr><td>UseConcMarkSweepGC</td><td>打开此开关后，使用ParNew + CMS + Serial Old 的收集器组合进行内存回收。Serial Old收集器将作为CMS收集器出现 concurrent mode failure 失败后的后备收集器使用</td></tr><tr><td>UseParallelGC</td><td>虚拟机运行在Server模式下默认值，打开此开关后，使用Parallel scavenge  + serial Old (PS markSweep) 的收集器组合进行内存回收</td></tr><tr><td>UseParallelOldGC</td><td>打开此开关后，使用Parallel Scavenge + parallel old 的收集器组合进行内存回收</td></tr><tr><td>UseG1GC</td><td>打开此开关后，使用G1收集器</td></tr></tbody></table><p>方法二：</p><p>打开GC日志，通过打印的GC日志的新生代、老年代名称判断</p><h3 id="调整内存大小"><a href="#调整内存大小" class="headerlink" title="调整内存大小"></a>调整内存大小</h3><p>现象：垃圾收集频率非常频繁。</p><p>原因：如果内存太小，就会导致频繁的需要进行垃圾收集才能释放出足够的空间来创建新的对象，所以增加堆内存大小的效果是非常显而易见的。</p><p>注意：如果垃圾收集次数非常频繁，但是每次能回收的对象非常少，那么这个时候并非内存太小，而可能是内存泄露导致对象无法回收，从而造成频繁GC。</p><p>参数配置：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs text">//设置堆初始值<br>指令1：-Xms2g<br>指令2：-XX:InitialHeapSize=2048m<br><br>//设置堆区最大值<br>指令1：-Xmx2g<br>指令2：-XX:MaxHeapSize=2048m<br><br>//新生代内存配置<br>指令1：-Xmn512m<br>指令2：-XX:MaxNewSize=512m<br></code></pre></td></tr></table></figure><h3 id="设置符合预期的停顿时间"><a href="#设置符合预期的停顿时间" class="headerlink" title="设置符合预期的停顿时间"></a>设置符合预期的停顿时间</h3><p>现象：程序间接性的卡顿</p><p>原因：如果没有确切的停顿时间设定，垃圾收集器以吞吐量为主，那么垃圾收集时间就会不稳定。</p><p>注意：不要设置不切实际的停顿时间，单次时间越短也意味着需要更多的GC次数才能回收完原有数量的垃圾.</p><p>参数配置：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">//GC停顿时间，垃圾收集器会尝试用各种手段达到这个时间<br>-XX:MaxGCPauseMillis=1000<br></code></pre></td></tr></table></figure><h3 id="调整内存区域大小比率"><a href="#调整内存区域大小比率" class="headerlink" title="调整内存区域大小比率"></a>调整内存区域大小比率</h3><p>现象：某一个区域的GC频繁，其他都正常。</p><p>原因：如果对应区域空间不足，导致需要频繁GC来释放空间，在JVM堆内存无法增加的情况下，可以调整对应区域的大小比率。</p><p>注意：也许并非空间不足，而是因为内存泄造成内存无法回收。从而导致GC频繁。</p><p>参数配置：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">//survivor区和Eden区大小比率<br>指令：-XX:SurvivorRatio=6  //S区和Eden区占新生代比率为1:6,两个S区2:6<br><br>//新生代和老年代的占比<br>-XX:NewRatio=4  //表示新生代:老年代 = 1:4 即老年代占整个堆的4/5；默认值=2<br></code></pre></td></tr></table></figure><h3 id="调整对象升老年代的年龄"><a href="#调整对象升老年代的年龄" class="headerlink" title="调整对象升老年代的年龄"></a>调整对象升老年代的年龄</h3><p>现象：老年代频繁GC，每次回收的对象很多。</p><p>原因：如果升代年龄小，新生代的对象很快就进入老年代了，导致老年代对象变多，而这些对象其实在随后的很短时间内就可以回收，这时候可以调整对象的升级代年龄，让对象不那么容易进入老年代解决老年代空间不足频繁GC问题。</p><p>注意：增加了年龄之后，这些对象在新生代的时间会变长可能导致新生代的GC频率增加，并且频繁复制这些对象新生的GC时间也可能变长。</p><p>配置参数：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">//进入老年代最小的GC年龄,年轻代对象转换为老年代对象最小年龄值，默认值7<br> -XX:InitialTenuringThreshol=7 <br></code></pre></td></tr></table></figure><h3 id="调整大对象的标准"><a href="#调整大对象的标准" class="headerlink" title="调整大对象的标准"></a>调整大对象的标准</h3><p>现象：老年代频繁GC，每次回收的对象很多,而且单个对象的体积都比较大。</p><p>原因：如果大量的大对象直接分配到老年代，导致老年代容易被填满而造成频繁GC，可设置对象直接进入老年代的标准。</p><p>注意：这些大对象进入新生代后可能会使新生代的GC频率和时间增加。</p><p>配置参数：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">//新生代可容纳的最大对象,大于则直接会分配到老年代，0代表没有限制。<br> -XX:PretenureSizeThreshold=1000000 <br></code></pre></td></tr></table></figure><h3 id="调整GC的触发时机"><a href="#调整GC的触发时机" class="headerlink" title="调整GC的触发时机"></a>调整GC的触发时机</h3><p>现象：CMS，G1 经常 Full GC，程序卡顿严重。</p><p>原因：G1和CMS 部分GC阶段是并发进行的，业务线程和垃圾收集线程一起工作，也就说明垃圾收集的过程中业务线程会生成新的对象，所以在GC的时候需要预留一部分内存空间来容纳新产生的对象，如果这个时候内存空间不足以容纳新产生的对象，那么JVM就会停止并发收集暂停所有业务线程（STW）来保证垃圾收集的正常运行。这个时候可以调整GC触发的时机（比如在老年代占用60%就触发GC），这样就可以预留足够的空间来让业务线程创建的对象有足够的空间分配。</p><p>注意：提早触发GC会增加老年代GC的频率。</p><p>配置参数：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">//使用多少比例的老年代后开始CMS收集，默认是68%，如果频繁发生SerialOld卡顿，应该调小<br>-XX:CMSInitiatingOccupancyFraction<br><br>//G1混合垃圾回收周期中要包括的旧区域设置占用率阈值。默认占用率为 65%<br>-XX:G1MixedGCLiveThresholdPercent=65 <br></code></pre></td></tr></table></figure><h3 id="调整-JVM本地内存大小"><a href="#调整-JVM本地内存大小" class="headerlink" title="调整 JVM本地内存大小"></a>调整 JVM本地内存大小</h3><p>现象：GC的次数、时间和回收的对象都正常，堆内存空间充足，但是报OOM</p><p>原因： JVM除了堆内存之外还有一块堆外内存，这片内存也叫本地内存，可是这块内存区域不足了并不会主动触发GC，只有在堆内存区域触发的时候顺带会把本地内存回收了，而一旦本地内存分配不足就会直接报OOM异常。</p><p>注意： 本地内存异常的时候除了上面的现象之外，异常信息可能是OutOfMemoryError：Direct buffer memory。 解决方式除了调整本地内存大小之外，也可以在出现此异常时进行捕获，手动触发GC（System.gc()）。</p><p>配置参数：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">XX:MaxDirectMemorySize<br></code></pre></td></tr></table></figure><h3 id="打开GC日志并观察"><a href="#打开GC日志并观察" class="headerlink" title="打开GC日志并观察"></a>打开GC日志并观察</h3><ol><li><p>-Xloggc:&#x2F;opt&#x2F;xxx&#x2F;logs&#x2F;xxx-xxx-gc-%t.log -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles&#x3D;5 -XX:GCLogFileSize&#x3D;20M -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCCause</p></li><li><p>或者每天产生一个日志文件</p></li></ol><p>3.观察日志</p><h2 id="调优案例"><a href="#调优案例" class="headerlink" title="调优案例"></a>调优案例</h2><h3 id="案例一：升级内存后，更慢"><a href="#案例一：升级内存后，更慢" class="headerlink" title="案例一：升级内存后，更慢"></a>案例一：升级内存后，更慢</h3><p>原服务器32位，1.5G的堆，用户反馈网站比较缓慢，因此公司决定升级，新的服务器为64位，16G的堆内存，结果用户反馈卡顿十分严重，反而比以前效率更低了。</p><p>响应慢为什么？</p><p>1.请求多，这时会造成，minor gc  和 full gc。</p><p>2.内存变大后，GC的时间也相应的变长</p><p>解决方案：</p><p>1.使用合适的垃圾回收器（cms 、 G1）</p><p>2.使用集群提供服务</p><h3 id="案例二：-网站流量浏览量暴增后，网站反应页面响很慢"><a href="#案例二：-网站流量浏览量暴增后，网站反应页面响很慢" class="headerlink" title="案例二： 网站流量浏览量暴增后，网站反应页面响很慢"></a>案例二： 网站流量浏览量暴增后，网站反应页面响很慢</h3><p>1、问题推测：在测试环境测速度比较快，但是一到生产就变慢，所以推测可能是因为垃圾收集导致的业务线程停顿。</p><p>2、定位：为了确认推测的正确性，在线上通过jstat -gc 指令 看到JVM进行GC 次数频率非常高，GC所占用的时间非常长，所以基本推断就是因为GC频率非常高，所以导致业务线程经常停顿，从而造成网页反应很慢。</p><p>3、解决方案：因为网页访问量很高，所以对象创建速度非常快，导致堆内存容易填满从而频繁GC，所以这里问题在于新生代内存太小，所以这里可以增加JVM内存就行了，所以初步从原来的2G内存增加到16G内存。</p><p>4、第二个问题：增加内存后的确平常的请求比较快了，但是又出现了另外一个问题，就是不定期的会间断性的卡顿，而且单次卡顿的时间要比之前要长很多。</p><p>5、问题推测：练习到是之前的优化加大了内存，所以推测可能是因为内存加大了，从而导致单次GC的时间变长从而导致间接性的卡顿。</p><p>6、定位：还是通过jstat -gc 指令 查看到 的确FGC次数并不是很高，但是花费在FGC上的时间是非常高的,根据GC日志 查看到单次FGC的时间有达到几十秒的。</p><p>7、解决方案： 因为JVM默认使用的是PS+PO的组合，PS+PO垃圾标记和收集阶段都是STW，所以内存加大了之后，需要进行垃圾回收的时间就变长了，所以这里要想避免单次GC时间过长，所以需要更换并发类的收集器，因为当前的JDK版本为1.7，所以最后选择CMS垃圾收集器，根据之前垃圾收集情况设置了一个预期的停顿的时间，上线后网站再也没有了卡顿问题。</p><h3 id="案例三：后台导出数据引发的OOM-或其他接口响应速度变慢"><a href="#案例三：后台导出数据引发的OOM-或其他接口响应速度变慢" class="headerlink" title="案例三：后台导出数据引发的OOM 或其他接口响应速度变慢"></a>案例三：后台导出数据引发的OOM 或其他接口响应速度变慢</h3><p>查找问题点：</p><p>1.从堆内存信息下手，通过开启了-XX:+HeapDumpOnOutOfMemoryError参数 获得堆内存的dump文件。</p><p>2.VisualVM 对 堆dump文件进行分析，通过VisualVM查看到占用内存最大的对象是String对象，本来想跟踪着String对象找到其引用的地方，但dump文件太大，跟踪进去的时候总是卡死，而String对象占用比较多也比较正常，最开始也没有认定就是这里的问题。</p><p>3.从线程信息里面找突破点。通过线程进行分析，先找到了几个正在运行的业务线程，然后逐一跟进业务线程看了下代码，发现有个引起我注意的方法，导出订单信息。</p><p>4.因为订单信息导出这个方法可能会有几万的数据量，首先要从数据库里面查询出来订单信息，然后把订单信息生成excel，这个过程会产生大量的String对象。</p><p>问题可能出现点：</p><p>1.无重复提交限制</p><p>2.功能使用频繁，数据量大，生成大对象，直接进入老年代，从而触发full gc</p><p>解决方案：</p><p>1.重复提交限制</p><p>2.业务代码获取数据 循环获取，转成小对象，配合JVM的大对象进入老年代参数</p><h3 id="案例四：单个缓存数据过大导致的系统CPU飚高"><a href="#案例四：单个缓存数据过大导致的系统CPU飚高" class="headerlink" title="案例四：单个缓存数据过大导致的系统CPU飚高"></a>案例四：单个缓存数据过大导致的系统CPU飚高</h3><p>同导出。从redis 获取一个大对象，这个大对象到 java堆中，有可能是个大对象，直接进入老年代。</p><p>解决方案：</p><p>把大对象变小。业务调整。</p><h3 id="案例五：数据分析平台系统频繁-Full-GC"><a href="#案例五：数据分析平台系统频繁-Full-GC" class="headerlink" title="案例五：数据分析平台系统频繁 Full GC"></a>案例五：数据分析平台系统频繁 Full GC</h3><p>平台主要对用户在 App 中行为进行定时分析统计，并支持报表导出，使用 CMS GC 算法。</p><p>数据分析师在使用中发现系统页面打开经常卡顿，通过 jstat 命令发现系统每次 Young GC 后大约有 10% 的存活对象进入老年代。</p><p>原来是因为 Survivor 区空间设置过小，每次 Young GC 后存活对象在 Survivor 区域放不下，提前进入老年代。</p><p>通过调大 Survivor 区，使得 Survivor 区可以容纳 Young GC 后存活对象，对象在 Survivor 区经历多次 Young GC 达到年龄阈值才进入老年代。</p><p>调整之后每次 Young GC 后进入老年代的存活对象稳定运行时仅几百 Kb，Full GC 频率大大降低。</p><h3 id="案例六：业务对接网关-OOM"><a href="#案例六：业务对接网关-OOM" class="headerlink" title="案例六：业务对接网关 OOM"></a>案例六：业务对接网关 OOM</h3><p>网关主要消费 Kafka 数据，进行数据处理计算然后转发到另外的 Kafka 队列，系统运行几个小时候出现 OOM，重启系统几个小时之后又 OOM。</p><p>通过 jmap 导出堆内存，在 eclipse MAT 工具分析才找出原因：代码中将某个业务 Kafka 的 topic 数据进行日志异步打印，该业务数据量较大，大量对象堆积在内存中等待被打印，导致 OOM。</p><h3 id="案例七：鉴权系统频繁长时间-Full-GC"><a href="#案例七：鉴权系统频繁长时间-Full-GC" class="headerlink" title="案例七：鉴权系统频繁长时间 Full GC"></a>案例七：鉴权系统频繁长时间 Full GC</h3><p>系统对外提供各种账号鉴权服务，使用时发现系统经常服务不可用，通过 Zabbix 的监控平台监控发现系统频繁发生长时间 Full GC，且触发时老年代的堆内存通常并没有占满，发现原来是业务代码中调用了 System.gc()。</p><h3 id="案例八：内存泄露"><a href="#案例八：内存泄露" class="headerlink" title="案例八：内存泄露"></a>案例八：内存泄露</h3><p>堆内存泄漏问题：</p><p>现象：出现OOM或者Full GC，heap使用率明显上升，经常达到Xmx</p><p>Full GC出现的正常频率是大概一天一到两次</p><p>看内存飚高问题定位</p><p>堆外内存泄漏：</p><p>现象：heap使用率很低，但是出现了OOM或者Full GC</p><p>解决方案： 可以用btrace跟踪DirectByteBuffer的构造函数来定位</p><h3 id="案例九：-因为对事务理解不足，造成死循环，导致CPU高"><a href="#案例九：-因为对事务理解不足，造成死循环，导致CPU高" class="headerlink" title="案例九： 因为对事务理解不足，造成死循环，导致CPU高"></a>案例九： 因为对事务理解不足，造成死循环，导致CPU高</h3><p>用户量不多，并发不多</p><p>使用可重复读事务级别</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">select value from test <span class="hljs-type">where</span> <span class="hljs-variable">flag</span>  <span class="hljs-operator">=</span> 可用 limit <span class="hljs-number">1</span><br>  <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">while</span>(count &gt; <span class="hljs-number">0</span>) &#123;<br>   count = update test <span class="hljs-type">set</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;已用&quot;</span><br>  &#125;<br></code></pre></td></tr></table></figure><p>用户请求后，一直死循环，造成服务所在CPU高，造成mysql查询变慢。</p><h2 id="CPU经常100-问题定位"><a href="#CPU经常100-问题定位" class="headerlink" title="CPU经常100% 问题定位"></a>CPU经常100% 问题定位</h2><p>问题分析：CPU高一定是某个程序长期占用了CPU资源。</p><p>1、所以先需要找出那个进行占用CPU高。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">top  列出系统各个进程的资源占用情况。<br></code></pre></td></tr></table></figure><p>2、然后根据找到对应进行里哪个线程占用CPU高。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">top -Hp 进程ID   列出对应进程里面的线程占用资源情况<br></code></pre></td></tr></table></figure><p>3、找到对应线程ID后，再打印出对应线程的堆栈信息</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">printf &quot;%x\n&quot;  PID    把线程ID转换为16进制。<br>jstack PID 打印出进程的所有线程信息，从打印出来的线程信息中找到上一步转换为16进制的线程ID对应的线程信息。<br></code></pre></td></tr></table></figure><p>4、最后根据线程的堆栈信息定位到具体业务方法,从代码逻辑中找到问题所在。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">查看是否有线程长时间的watting 或blocked<br>如果线程长期处于watting状态下， 关注watting on xxxxxx，说明线程在等待这把锁，然后根据锁的地址找到持有锁的线程。<br></code></pre></td></tr></table></figure><h2 id="内存飚高问题定位"><a href="#内存飚高问题定位" class="headerlink" title="内存飚高问题定位"></a>内存飚高问题定位</h2><p>分析： 内存飚高如果是发生在java进程上，一般是因为创建了大量对象所导致，持续飚高说明垃圾回收跟不上对象创建的速度，或者内存泄露导致对象无法回收。</p><p>1、先观察垃圾回收的情况</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">jstat -gc PID 1000 查看GC次数，时间等信息，每隔一秒打印一次。<br>jmap -histo PID | head -20   查看堆内存占用空间最大的前20个对象类型,可初步查看是哪个对象占用了内存。<br></code></pre></td></tr></table></figure><p>如果每次GC次数频繁，而且每次回收的内存空间也正常，那说明是因为对象创建速度快导致内存一直占用很高；如果每次回收的内存非常少，那么很可能是因为内存泄露导致内存一直无法被回收。</p><p>2、导出堆内存文件快照</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">jmap -dump:live,format=b,file=/home/myheapdump.hprof PID  dump堆内存信息到文件。<br></code></pre></td></tr></table></figure><p>3、使用visualVM对dump文件进行离线分析,找到占用内存高的对象，再找到创建该对象的业务代码位置，从代码和业务场景中定位具体问题。</p>]]></content>
    
    
    <categories>
      
      <category>jvm</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jvm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jvm内存模型</title>
    <link href="/2019/07/23/jvm/jvm%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/"/>
    <url>/2019/07/23/jvm/jvm%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="JAVA内存模型"><a href="#JAVA内存模型" class="headerlink" title="JAVA内存模型"></a>JAVA内存模型</h1><p>Java内存模型是共享内存的并发模型，线程之间主要通过读-写共享变量（堆内存中的实例域，静态域和数组元素）来完成隐式通信。</p><p>Java 内存模型（JMM）控制 Java 线程之间的通信，决定一个线程对共享变量的写入何时对另一个线程可见。</p><h1 id="计算机高速缓存和缓存一致性协议"><a href="#计算机高速缓存和缓存一致性协议" class="headerlink" title="计算机高速缓存和缓存一致性协议"></a>计算机高速缓存和缓存一致性协议</h1><p>如需了解JAVA内存模型，需要了解一下物理计算机是如何做的，因为常说JVM可以看成一台虚拟计算机。</p><p>计算机在高速的 CPU 和相对低速的存储设备之间使用高速缓存，作为内存和处理器之间的缓冲。将运算需要使用到的数据复制到缓存中，让运算能快速运行，当运算结束后再从缓存同步回内存之中。</p><p>在多处理器的系统中(或者单处理器多核的系统)，每个处理器内核都有自己的高速缓存，它们有共享同一主内存(Main Memory)。</p><p>当多个处理器的运算任务都涉及同一块主内存区域时，将可能导致各自的缓存数据不一致。</p><p>为此，需要各个处理器访问缓存时都遵循一些协议，在读写时要根据协议进行操作，来维护缓存的一致性。</p><p>解决缓存一致性方案有两种：</p><ol><li>通过在总线加LOCK#锁的方式</li><li>通过缓存一致性协议</li></ol><h1 id="JVM主内存与工作内存"><a href="#JVM主内存与工作内存" class="headerlink" title="JVM主内存与工作内存"></a>JVM主内存与工作内存</h1><p>Java 内存模型的主要目标是定义程序中各个变量的访问规则，即在虚拟机中将变量（线程共享的变量）存储到内存和从内存中取出变量这样底层细节。</p><p>Java内存模型中规定了所有的变量都存储在主内存中，每条线程还有自己的工作内存，线程对变量的所有操作都必须在工作内存中进行，而不能直接读写主内存中的变量。</p><p>这里的工作内存是 JMM 的一个抽象概念，也叫本地内存，其存储了该线程以读 &#x2F; 写共享变量的副本。</p><p><strong>就像每个处理器内核拥有私有的高速缓存，JMM 中每个线程拥有私有的本地内存。</strong></p><p>不同线程之间无法直接访问对方工作内存中的变量，线程间的通信一般有两种方式进行，一是通过消息传递，二是共享内存。Java 线程间的通信采用的是共享内存方式，线程、主内存和工作内存的交互关系如下图所示：</p><p><img src="/.com//JVM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.png" alt="JVM内存模型"></p><p>这里所讲的主内存、工作内存与 JVM运行时内存区域中的 Java 堆、栈、方法区等并不是同一个层次的内存划分，这两者基本上是没有关系的，如果两者一定要勉强对应起来，那从变量、主内存、工作内存的定义来看，主内存主要对应于Java堆中的对象实例数据部分，而工作内存则对应于虚拟机栈中的部分区域。</p><h1 id="重排序和happens-before规则"><a href="#重排序和happens-before规则" class="headerlink" title="重排序和happens-before规则"></a>重排序和happens-before规则</h1><p>在执行程序时为了提高性能，编译器和处理器常常会对指令做重排序。重排序分三种类型：</p><ol><li>编译器优化的重排序。编译器在不改变单线程程序语义的前提下，可以重新安排语句的执行顺序。</li><li>指令级并行的重排序。现代处理器采用了指令级并行技术（Instruction-Level Parallelism， ILP）来将多条指令重叠执行。如果不存在数据依赖性，处理器可以改变语句对应机器指令的执行顺序。</li><li>内存系统的重排序。由于处理器使用缓存和读 &#x2F; 写缓冲区，这使得加载和存储操作看上去可能是在乱序执行。</li></ol><p>从 java 源代码到最终实际执行的指令序列，会分别经历下面三种重排序：</p><p><img src="/.com//java%E6%BA%90%E7%A0%81%E5%88%B0%E6%89%A7%E8%A1%8C%E7%BB%8F%E5%8E%86%E7%9A%84%E9%87%8D%E6%8E%92%E5%BA%8F.png" alt="java源码到执行经历的重排序"></p><p>JMM 属于语言级的内存模型，它确保在不同的编译器和不同的处理器平台之上，通过禁止特定类型的编译器重排序和处理器重排序，为程序员提供一致的内存可见性保证。</p><p>java 编译器禁止处理器重排序是通过在生成指令序列的适当位置会插入内存屏障（重排序时不能把后面的指令重排序到内存屏障之前的位置）指令来实现的。</p><p><img src="/.com//JMM%E9%87%8D%E6%8E%92%E5%BA%8F%E7%A4%BA%E6%84%8F%E5%9B%BE.png" alt="JMM重排序示意图"></p><h2 id="内存指令"><a href="#内存指令" class="headerlink" title="内存指令"></a>内存指令</h2><p>java内存间的交互操作<br>（1）lock(锁定)：作用于主内存的变量，把一个变量标记为一条线程独占状态<br>（2）unlock(解锁)：作用于主内存的变量，把一个处于锁定状态的变量释放出来，释放后的变量才可以被其他线程锁定<br>（3）read(读取)：作用于主内存的变量，把一个变量值从主内存传输到线程的工作内存中，以便随后的load动作使用<br>（4）load(载入)：作用于工作内存的变量，它把read操作从主内存中得到的变量值放入工作内存的变量副本中<br>（5）use(使用)：作用于工作内存的变量，把工作内存中的一个变量值传递给执行引擎<br>（6）assign(赋值)：作用于工作内存的变量，它把一个从执行引擎接收到的值赋给工作内存的变量<br>（7）store(存储)：作用于工作内存的变量，把工作内存中的一个变量的值传送到主内存中，以便随后的write的操作<br>（8）write(写入)：作用于主内存的变量，它把store操作从工作内存中的一个变量的值传送到主内存的变量中</p><p>上面8中操作必须满足以下规则<br>1、不允许read和load、store和write操作之一单独出现，即不允许一个变量从主内存读取了但工作内存不接受，或者从工作内存发起回写了但主内存不接受的情况出现。<br>2、不允许一个线程丢弃它的最近的assign操作，即变量在工作内存中改变了之后必须把该变化同步回主内存。<br>3、不允许一个线程无原因地（没有发生过任何assign操作）把数据从线程的工作内存同步回主内存。<br>4、一个新的变量只能在主内存中“诞生”，不允许在工作内存中直接使用一个未被初始化（load或assign）的变量，换句话说，就是对一个变量实施use、store操作之前，必须先执行过了assign和load操作。<br>5、一个变量在同一时刻只允许一条线程对其进行lock操作，但lock操作可以被同一条线程重复执行多次，多次执行lock后，只有执行相同次数的unlock操作，变量才会被解锁。<br>6、如果对一个变量执行lock操作，那将会清空工作内存中此变量的值，在执行引擎使用这个变量前，需要重新执行load或assign操作初始化变量的值。<br>7、如果一个变量事先没有被lock操作锁定，那就不允许对它执行unlock操作，也不允许去unlock一个被其他线程锁定住的变量。<br>8、对一个变量执行unlock操作之前，必须先把此变量同步回主内存中（执行store、write操作）。</p><h2 id="先行发生原则-happens-before"><a href="#先行发生原则-happens-before" class="headerlink" title="先行发生原则 happens-before"></a>先行发生原则 happens-before</h2><p>从 JDK5 开始，java 内存模型提出了 happens-before 的概念，通过这个概念来阐述操作之间的内存可见性。</p><p>如果一个操作执行的结果需要对另一个操作可见，那么这两个操作之间必须存在 happens-before 关系。这里提到的两个操作既可以是在一个线程之内，也可以是在不同线程之间。</p><p><strong>这里的“可见性”是指当一条线程修改了这个变量的值，新值对于其他线程来说是可以立即得知的。</strong></p><p>如果 A happens-before B，那么 Java 内存模型将向程序员保证—— A 操作的结果将对 B 可见，且 A 的执行顺序排在 B 之前。</p><p>重要的 happens-before 规则如下：</p><figure class="highlight markdown"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><pre><code class="hljs markdown">判断数据是有有竞争、线程是否安全的主要依据<br><span class="hljs-bullet">1.</span> 程序次序规则：同一个线程内，按照代码出现的顺序，前面的代码先行于后面的代码，准确的说是控制流顺序，因为要考虑到分支和循环结构。<br><span class="hljs-bullet">2.</span> 管程锁定规则：一个unlock操作先行发生于后面（时间上）对同一个锁的lock操作。<br><span class="hljs-bullet">3.</span> volatile变量规则：对一个volatile变量的写操作先行发生于后面（时间上）对这个变量的读操作。<br><span class="hljs-bullet">4.</span> 线程启动规则：Thread的start( )方法先行发生于这个线程的每一个操作。<br><span class="hljs-bullet">5.</span> 线程终止规则：线程的所有操作都先行于此线程的终止检测。可以通过Thread.join( )方法结束、Thread.isAlive( )的返回值等手段检测线程的终止。 <br><span class="hljs-bullet">6.</span> 线程中断规则：对线程interrupt( )方法的调用先行发生于被中断线程的代码检测到中断事件的发生，可以通过Thread.interrupt( )方法检测线程是否中断<br><span class="hljs-bullet">7.</span> 对象终结规则：一个对象的初始化完成先行于发生它的finalize（）方法的开始。<br><span class="hljs-bullet">8.</span> 传递性：如果操作A先行于操作B，操作B先行于操作C，那么操作A先行于操作C。<br></code></pre></td></tr></table></figure><p>下图是 happens-before 与 JMM 的关系</p><p><img src="/.com//happensBefor%E4%B8%8EJMM%E7%9A%84%E5%85%B3%E7%B3%BB.png" alt="happensBefor与JMM的关系"></p><h2 id="volatile关键字"><a href="#volatile关键字" class="headerlink" title="volatile关键字"></a>volatile关键字</h2><p>volatile 可以说是 JVM 提供的最轻量级的同步机制，当一个变量定义为volatile之后，它将具备两种特性：</p><p><strong>保证此变量对所有线程的可见性。</strong>而普通变量不能做到这一点，普通变量的值在线程间传递均需要通过主内存来完成。</p><p>注意，volatile 虽然保证了可见性，但是 Java 里面的运算并非原子操作，导致 volatile 变量的运算在并发下一样是不安全的。而 synchronized 关键字则是由“一个变量在同一个时刻只允许一条线程对其进行 lock 操作”这条规则获得线程安全的。</p><p><strong>禁止指令重排序优化。</strong>普通的变量仅仅会保证在该方法的执行过程中所有依赖赋值结果的地方都能获取到正确的结果，而不能保证变量赋值操作的顺序与程序代码中的执行顺序一致。</p><p>Atomicity，原子性</p><p>Visibility，可见性</p><p>Ordering，有序性</p><p>Volatile 保证 可见性 和  有序性。</p>]]></content>
    
    
    <categories>
      
      <category>jvm</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jvm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>shiro入门理解</title>
    <link href="/2019/07/23/%E6%9D%83%E9%99%90%E6%A1%86%E6%9E%B6/shiro%E5%85%A5%E9%97%A8%E7%90%86%E8%A7%A3/"/>
    <url>/2019/07/23/%E6%9D%83%E9%99%90%E6%A1%86%E6%9E%B6/shiro%E5%85%A5%E9%97%A8%E7%90%86%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h2 id="1-shiro架构简介查找"><a href="#1-shiro架构简介查找" class="headerlink" title="1.shiro架构简介查找"></a>1.shiro架构简介查找</h2><p>进入shiro官网<a href="http://shiro.apache.org/">http://shiro.apache.org/</a></p><p>点击 Get Started</p><p>点击Architecture</p><h2 id="2-什么是Apache-Shiro"><a href="#2-什么是Apache-Shiro" class="headerlink" title="2.什么是Apache Shiro"></a>2.什么是Apache Shiro</h2><p>Apache Shiro是一个功能强大且灵活的开源安全框架，可以清晰地处理身份验证，授权，企业会话管理和加密。</p><p>Apache Shiro的首要目标是易于使用和理解。安全有时可能非常复杂，甚至是痛苦的，但事实并非如此。框架应尽可能掩盖复杂性，并提供简洁直观的API，以简化开发人员确保其应用程序安全的工作。</p><p>以下是Apache Shiro可以做的一些事情：</p><ul><li>验证用户以验证其身份</li><li>为用户执行访问控制，例如：<ul><li>确定是否为用户分配了某个安全角色</li><li>确定是否允许用户执行某些操作</li></ul></li><li>在任何环境中使用Session API，即使没有Web容器或EJB容器也是如此。</li><li>在身份验证，访问控制或会话生命周期内对事件做出反应。</li><li>聚合用户安全数据的1个或多个数据源，并将其全部显示为单个复合用户“视图”。</li><li>启用单点登录（SSO）功能</li><li>无需登录即可为用户关联启用“记住我”服务<br>……<br>以及更多 - 全部集成到一个易于使用的内聚API中。</li></ul><p>Shiro尝试为所有应用程序环境实现这些目标 - 从最简单的命令行应用程序到最大的企业应用程序，而不会强制依赖其他第三方框架，容器或应用程序服务器。当然，该项目旨在尽可能地融入这些环境，但它可以在任何环境中开箱即用。</p><h2 id="3-Apache-Shiro功能"><a href="#3-Apache-Shiro功能" class="headerlink" title="3.Apache Shiro功能"></a>3.Apache Shiro功能</h2><p>Apache Shiro是一个具有许多功能的综合应用程序安全框架。下图显示了Shiro关注其能量的位置，此参考手册将以类似方式组织：</p><p><img src="/.com//ShiroFeatures.png" alt="ShiroFeatures"></p><p>Shiro针对Shiro开发团队所称的“应用程序安全的四大基石” - 身份验证，授权，会话管理和加密：</p><ul><li><strong>身份验证：</strong>有时称为“登录”，这是证明用户是他们所说的人的行为。</li><li><strong>授权：</strong>访问控制的过程，即确定“谁”可以访问“什么”。</li><li><strong>会话管理：</strong>即使在非Web或EJB应用程序中，也可以管理特定于用户的会话。</li><li><strong>密码学：</strong>使用加密算法保持数据安全，同时仍然易于使用。</li></ul><p>还有其他功能可以在不同的应用程序环境中支持和强化这些问题，尤其是：</p><ul><li>Web支持：Shiro的Web支持API可帮助轻松保护Web应用程序。</li><li>缓存：缓存是Apache Shiro API中的第一层公民，可确保安全操作保持快速高效。</li><li>并发：Apache Shiro支持具有并发功能的多线程应用程序。</li><li>测试：存在测试支持以帮助您编写单元和集成测试，并确保您的代码按预期受到保护。</li><li>“运行方式”：允许用户假定其他用户的身份（如果允许）的功能，有时在管理方案中很有用。</li><li>“记住我”：记住用户在会话中的身份，因此他们只需要在必要时登录。</li></ul><h2 id="4-Apache-Shiro架构简述"><a href="#4-Apache-Shiro架构简述" class="headerlink" title="4.Apache Shiro架构简述"></a>4.Apache Shiro架构简述</h2><p>Apache Shiro的设计目标是通过直观和易用来简化应用程序安全性。Shiro的核心设计模拟了大多数人对应用程序安全性的看法 - 在某人（或某事）与应用程序交互的环境中。</p><p>软件应用程序通常基于用户故事设计。也就是说，您通常会根据用户（或应该）与软件交互的方式设计用户界面或服务API。例如，您可能会说，“如果用户与我的应用程序交互，则会向他们显示一个按钮，他们可以单击该按钮查看其帐户信息。如果他们没有登录，我会显示一个注册按钮。“</p><p>此示例语句指示应用程序主要是为满足用户要求和需求而编写的。即使“用户”是另一个软件系统而不是人类，您仍然会编写代码以反映基于当前与您的软件交互的人（或什么）的行为。</p><p>Shiro在自己的设计中反映了这些概念。通过匹配软件开发人员已经很直观的内容，Apache Shiro在几乎任何应用程序中都保持直观且易于使用。</p><h2 id="5-Apache-Shiro架构高级概述"><a href="#5-Apache-Shiro架构高级概述" class="headerlink" title="5.Apache Shiro架构高级概述"></a>5.Apache Shiro架构高级概述</h2><p>在最高概念层面，Shiro的架构有3个主要概念：和<code>Subject</code>，<code>SecurityManager</code>和<code>Realms</code>。下图是这些组件如何交互的高级概述，我们将在下面介绍每个概念：</p><p><img src="/.com//ShiroBasicArchitecture.png" alt="ShiroBasicArchitecture"></p><ul><li><p><strong>主题</strong>：正如我们在<a href="http://shiro.apache.org/tutorial.html">教程中</a>提到的，<code>Subject</code>它本质上是当前正在执行的用户的特定于安全性的“视图”。虽然“用户”这个词通常意味着一个<code>Subject</code>人，但是它可以是一个人，但它也可以代表第三方服务，守护进程帐户，cron作业或任何类似的东西 - 基本上是当前与软件交互的任何东西。</p><p><code>Subject</code>实例都被绑定（并要求）a <code>SecurityManager</code>。当您与a进行交互时<code>Subject</code>，这些交互会转换为特定于主题的交互<code>SecurityManager</code>。</p></li><li><p><strong>SecurityManager</strong>：它<code>SecurityManager</code>是Shiro架构的核心，充当一种“伞形”对象，协调其内部安全组件，共同形成一个对象图。但是，一旦为应用程序配置了SecurityManager及其内部对象图，通常会将其保留，应用程序开发人员几乎将所有时间花在<code>Subject</code>API上。</p><p>我们稍后将<code>SecurityManager</code>详细讨论，但重要的是要意识到，当您与a进行交互时<code>Subject</code>，实际上是<code>SecurityManager</code>幕后操作可以完成所有<code>Subject</code>安全操作。这反映在上面的基本流程图中。</p></li><li><p><strong>领域</strong>：领域充当Shiro与应用程序安全数据之间的“桥梁”或“连接器”。当实际与安全相关数据（如用户帐户）进行交互以执行身份验证（登录）和授权（访问控制）时，Shiro会从为应用程序配置的一个或多个领域中查找许多这些内容。</p><p>从这个意义上讲，Realm本质上是一个特定于安全性的<a href="https://en.wikipedia.org/wiki/Data_access_object">DAO</a>：它封装了数据源的连接细节，并根据需要使相关数据可用于Shiro。配置Shiro时，必须至少指定一个Realm用于身份验证和&#x2F;或授权。所述<code>SecurityManager</code>可与多个境界被配置，但至少有一个是必需的。</p><p>Shiro提供了开箱即用的Realms，可以连接到许多安全数据源（也称为目录），如LDAP，关系数据库（JDBC），文本配置源（如INI和属性文件等）。如果默认域不符合您的需要，您可以插入自己的Realm实现来表示自定义数据源。</p><p>与其他内部组件一样，Shiro <code>SecurityManager</code>管理如何使用Realms获取要表示为<code>Subject</code>实例的安全性和身份数据。</p></li></ul><h2 id="6-Apache-Shiro的详细的架构"><a href="#6-Apache-Shiro的详细的架构" class="headerlink" title="6.Apache Shiro的详细的架构"></a>6.Apache Shiro的详细的架构</h2><p>下图显示了Shiro的核心架构概念，后面是每个概述的简短摘要：</p><p><img src="/.com//ShiroArchitecture.png" alt="ShiroArchitecture"></p><ul><li><strong>Subject</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/subject/Subject.html"><code>org.apache.shiro.subject.Subject</code></a>）<br>当前与软件交互的实体（用户，第三方服务，cron作业等）的特定于安全性的“视图”。</li><li><strong>SecurityManager</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/mgt/SecurityManager.html">org.apache.shiro.mgt.SecurityManager</a>）<br>如上所述，这<code>SecurityManager</code>是Shiro建筑的核心。它主要是一个“伞形”对象，协调其托管组件，以确保它们一起平稳运行。它还管理Shiro对每个应用程序用户的视图，因此它知道如何对每个用户执行安全操作。</li><li><strong>认证器</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/authc/Authenticator.html">org.apache.shiro.authc.Authenticator</a>）<br>的<code>Authenticator</code>是，负责执行和反应以验证（注册）用户企图的组件。当用户尝试登录时，该逻辑由执行<code>Authenticator</code>。该<code>Authenticator</code>知道如何与一个或多个协调<code>Realms</code>存储有关用户&#x2F;帐户信息。从这些数据中获取的数据<code>Realms</code>用于验证用户的身份，以保证用户确实是他们所说的人。<ul><li><strong>身份验证策略</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/authc/pam/AuthenticationStrategy.html">org.apache.shiro.authc.pam.AuthenticationStrategy</a>）<br>如果<code>Realm</code>配置了多个，<code>AuthenticationStrategy</code>则将协调领域以确定身份验证尝试成功或失败的条件（例如，如果一个领域成功但其他领域失败尝试是否成功？必须所有领域成功吗？只有第一个？）。</li></ul></li><li><strong>授权器</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/authz/Authorizer.html">org.apache.shiro.authz.Authorizer</a>）<br>的<code>Authorizer</code>是部件负责确定用户在该应用程序的访问控制。这种机制最终会说明是否允许用户做某事。与此类似<code>Authenticator</code>，它<code>Authorizer</code>也知道如何协调多个后端数据源以访问角色和权限信息。在<code>Authorizer</code>使用该信息来确定到底是否允许用户执行特定的操作。</li><li><strong>SessionManager</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/session/mgt/SessionManager.html">org.apache.shiro.session.mgt.SessionManager</a>）<br>将<code>SessionManager</code>知道如何创建和管理用户<code>Session</code>生命周期，提供在所有环境中的用户强大的会话体验。这是安全框架领域的一项独特功能 - 即使没有可用的Web &#x2F; Servlet或EJB容器，Shiro也能够在任何环境中本地管理用户Sessions。默认情况下，Shiro将使用现有的会话机制（例如Servlet容器），但如果没有，例如在独立应用程序或非Web环境中，它将使用其内置的企业会话管理提供相同的编程经验。的<code>SessionDAO</code>存在允许任何数据源被用来坚持的会议。<ul><li><strong>SessionDAO</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/session/mgt/eis/SessionDAO.html">org.apache.shiro.session.mgt.eis.SessionDAO</a>）<br>的<code>SessionDAO</code>执行<code>Session</code>代表的持久性（CRUD）操作<code>SessionManager</code>。这允许将任何数据存储插入会话管理基础结构。</li></ul></li><li><strong>CacheManager的</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/cache/CacheManager.html">org.apache.shiro.cache.CacheManager</a>）<br>的<code>CacheManager</code>创建和管理<code>Cache</code>其他四郎组件使用实例的生命周期。由于Shiro可以访问许多后端数据源以进行身份​​验证，授权和会话管理，因此缓存一直是框架中的一流架构功能，可在使用这些数据源时提高性能。任何现代开源和&#x2F;或企业缓存产品都可以插入Shiro，以提供快速有效的用户体验。</li><li><strong>密码学</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/crypto/package-summary.html">org.apache.shiro.crypto。*</a>）<br>密码学是企业安全框架的自然补充。Shiro的<code>crypto</code>软件包包含易于使用和理解的密码密码，哈希（aka摘要）和不同编解码器实现的表示。该软件包中的所有类都经过精心设计，易于使用且易于理解。使用Java本机加密支持的任何人都知道它可能是一个具有挑战性的驯服动物。Shiro的加密API简化了复杂的Java机制，使密码学易于用于普通的凡人。</li><li><strong>领域</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/realm/Realm.html">org.apache.shiro.realm.Realm</a>）<br>如上所述，Realms充当Shiro与应用程序安全数据之间的“桥接”或“连接器”。当实际与安全相关数据（如用户帐户）进行交互以执行身份验证（登录）和授权（访问控制）时，Shiro会从为应用程序配置的一个或多个领域中查找许多这些内容。您可以根据<code>Realms</code>需要配置任意数量（通常每个数据源一个），Shiro将根据需要进行身份验证和授权协调。</li></ul><h2 id="7-Apache-Shiro的SecurityManager"><a href="#7-Apache-Shiro的SecurityManager" class="headerlink" title="7.Apache Shiro的SecurityManager"></a>7.Apache Shiro的SecurityManager</h2><p>因为Shiro的API鼓励采用一种<code>Subject</code>中心编程方法，所以大多数应用程序开发人员很少（如果有的话）<code>SecurityManager</code>直接与之交互（框架开发人员有时可能会发现它很有用）。即便如此，了解<code>SecurityManager</code>功能仍然很重要，尤其是在为应用程序配置功能时。</p><p>SecurityManager的设计:</p><p>如前所述，应用程序<code>SecurityManager</code>执行安全操作并管理<em>所有</em>应用程序用户的状态。在Shiro的默认<code>SecurityManager</code>实现中，这包括：</p><ul><li>认证</li><li>授权</li><li>会话管理</li><li>缓存管理</li><li><a href="http://shiro.apache.org/realm.html">域</a>协调</li><li>事件传播</li><li>“记住我”服务</li><li>主题创作</li><li>退出等等。</li></ul><p>但是，这是尝试在单个组件中管理的许多功能。而且，如果将所有内容集中到单个实现类中，那么使这些内容变得灵活且可自定义将非常困难。</p><p>为了简化配置并实现灵活的配置&#x2F;可插拔性，Shiro的实现都是高度模块化的设计 - 实际上是模块化的，SecurityManager实现（及其类层次结构）根本不起作用。相反，这些<code>SecurityManager</code>实现主要充当轻量级“容器”组件，几乎将所有行为委托给嵌套&#x2F;包装组件。这种“包装”设计反映在上面的详细架构图中。</p><p>当组件实际执行逻辑时，<code>SecurityManager</code>实现知道如何以及何时协调组件以获得正确的行为。</p><p>的<code>SecurityManager</code>实现方式和组件也JavaBeans的兼容，它允许（或配置机构）能够容易地通过标准的JavaBeans存取&#x2F; mutator方法定制可插组件（获取* &#x2F;组*）。这意味着Shiro的架构模块化可以转化为非常容易的自定义行为配置。</p>]]></content>
    
    
    <categories>
      
      <category>shiro</category>
      
    </categories>
    
    
    <tags>
      
      <tag>shiro</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用cmder替换cmd</title>
    <link href="/2019/07/18/%E4%BD%BF%E7%94%A8cmder%E6%9B%BF%E6%8D%A2cmd/"/>
    <url>/2019/07/18/%E4%BD%BF%E7%94%A8cmder%E6%9B%BF%E6%8D%A2cmd/</url>
    
    <content type="html"><![CDATA[<h2 id="1-下载安装"><a href="#1-下载安装" class="headerlink" title="1.下载安装"></a>1.下载安装</h2><h2 id="2-配置环境变量"><a href="#2-配置环境变量" class="headerlink" title="2.配置环境变量"></a>2.配置环境变量</h2><p>把安装目录cmder.exe所在文件路径添加至path里</p><h2 id="3-配置右键快捷启动"><a href="#3-配置右键快捷启动" class="headerlink" title="3.配置右键快捷启动"></a>3.配置右键快捷启动</h2><p>在cmd中执行</p><figure class="highlight arcade"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-comment">// 设置任意地方鼠标右键启动Cmder</span><br>Cmder.exe /REGISTER <span class="hljs-built_in">ALL</span><br></code></pre></td></tr></table></figure><p>##4.常用快捷键</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs dos">Tab       自动路径补全<br>Ctrl+T    建立新页签<br>Ctrl+W    关闭页签<br>Ctrl+Tab  切换页签<br>Alt+F4    关闭所有页签<br>Alt+<span class="hljs-built_in">Shift</span>+<span class="hljs-number">1</span> 开启<span class="hljs-built_in">cmd</span>.exe<br>Alt+<span class="hljs-built_in">Shift</span>+<span class="hljs-number">2</span> 开启powershell.exe<br>Alt+<span class="hljs-built_in">Shift</span>+<span class="hljs-number">3</span> 开启powershell.exe (系统管理员权限)<br>Ctrl+<span class="hljs-number">1</span>      快速切换到第<span class="hljs-number">1</span>个页签<br>Ctrl+n      快速切换到第n个页签( n值无上限)<br>Alt + enter 切换到全屏状态<br>Ctr+r       历史命令搜索<br>Win+Alt+P   开启工具选项视窗<br>Ctrl + `： 来自任务栏的全局召唤(直接切换)<br>Win + Alt + p ：首选项（或右键单击标题栏）<br>Ctrl + Alt + u ：未知见官网<br><span class="hljs-built_in">Shift</span> + mouse ：从缓冲区中选择并复制文本<br>Right click / Ctrl + <span class="hljs-built_in">Shift</span> + v ：粘贴文本<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>cmder</category>
      
    </categories>
    
    
    <tags>
      
      <tag>命令行</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CAS compare and swap</title>
    <link href="/2019/07/18/java/CAS%20compare%20and%20swap/"/>
    <url>/2019/07/18/java/CAS%20compare%20and%20swap/</url>
    
    <content type="html"><![CDATA[<p>what why how<br>简历：<br><a href="https://www.jianshu.com/p/21be831e851e">https://www.jianshu.com/p/21be831e851e</a></p><h2 id="1-what"><a href="#1-what" class="headerlink" title="1.what"></a>1.what</h2><p>compare and swap<br>从内存上取值V,和预期值A进行比较，如果内存值V和预期值A的结果相等，那么我们就把新值B更新到内存，如果不相等，那么就重复上述操作直到成功为止。<br>cas 硬件指令 （引申MutexLock）</p><h2 id="2-why"><a href="#2-why" class="headerlink" title="2.why"></a>2.why</h2><p>多线程共享资源，并发修改，保证正确</p><h2 id="3-how"><a href="#3-how" class="headerlink" title="3.how"></a>3.how</h2><p>在原子类变量中，如java.util.concurrent.atomic中的AtomicXXX,都有大量的使用</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CAS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java的SQL注入-PreparedStatement</title>
    <link href="/2019/07/18/java/java%E7%9A%84SQL%E6%B3%A8%E5%85%A5-PreparedStatement/"/>
    <url>/2019/07/18/java/java%E7%9A%84SQL%E6%B3%A8%E5%85%A5-PreparedStatement/</url>
    
    <content type="html"><![CDATA[<h3 id="1-SQL注入"><a href="#1-SQL注入" class="headerlink" title="1.SQL注入"></a>1.SQL注入</h3><figure class="highlight sql"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">from</span> a <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;name输入值&#x27;</span> <span class="hljs-keyword">and</span> mobile <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;mobile输入值&#x27;</span><br></code></pre></td></tr></table></figure><p>原本软件必须要两个输入项都匹配才能命中数据，返回。</p><p>这时恶意的人，只输入name输入值为 ‘or 1&#x3D; 1 –  时</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">from</span> crm_admin <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-keyword">or</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-comment">-- &#x27; and mobile = &#x27;mobile输入值&#x27;</span><br></code></pre></td></tr></table></figure><p>这时就会返回值</p><h3 id="2-PreparedStatement-准备好的Statement"><a href="#2-PreparedStatement-准备好的Statement" class="headerlink" title="2.PreparedStatement(准备好的Statement)"></a>2.PreparedStatement(准备好的Statement)</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">from</span> a <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;name输入值&#x27;</span> <span class="hljs-keyword">and</span> mobile <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;mobile输入值&#x27;</span><br></code></pre></td></tr></table></figure><p>语句会变为</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">from</span> a <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> ？ <span class="hljs-keyword">and</span> mobile <span class="hljs-operator">=</span> ？<br></code></pre></td></tr></table></figure><p>输入参数会做为一个字符串传进去，不再进行sql的解析与准备</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">from</span> crm_admin <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;\&#x27;</span><span class="hljs-keyword">or</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-comment">--&#x27; and mobile = &#x27;1580000001&#x27;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CAS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>数据权限</title>
    <link href="/2019/07/18/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/"/>
    <url>/2019/07/18/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/</url>
    
    <content type="html"><![CDATA[<h3 id="1-什么是数据权限"><a href="#1-什么是数据权限" class="headerlink" title="1.什么是数据权限"></a>1.什么是数据权限</h3><p>对于系统来说，分为菜单按钮接口权限和数据权限。</p><p>菜单按钮接口权限是针对用户是否可以看到使用菜单、按钮的权限及接口访问权限。</p><p>数据权限是针对用户，存在于公司的系统架构内，不同部门、不同人数据是否可见、是否可操作的权限。</p><h3 id="2-实现方式rouyi项目的方式"><a href="#2-实现方式rouyi项目的方式" class="headerlink" title="2.实现方式rouyi项目的方式"></a>2.实现方式rouyi项目的方式</h3><p>步骤一：</p><p>添加请求实体类的公共类</p><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseEntity</span> &#123;<br>    <span class="hljs-comment">/** 请求参数 */</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; params;<br>&#125;<br></code></pre></td></tr></table></figure><p>步骤二：</p><p>添加请求controller注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 数据权限过滤注解</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Target(ElementType.METHOD)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> DataScope<br>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 部门表的别名</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deptAlias</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户表的别名</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">userAlias</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>步骤三：</p><p>添加AOP处理类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 数据过滤处理</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> ruoyi</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataScopeAspect</span><br>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 全部数据权限</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DATA_SCOPE_ALL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;1&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 自定数据权限</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DATA_SCOPE_CUSTOM</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;2&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 部门数据权限</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DATA_SCOPE_DEPT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;3&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 部门及以下数据权限</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DATA_SCOPE_DEPT_AND_CHILD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;4&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 仅本人数据权限</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DATA_SCOPE_SELF</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;5&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 数据权限过滤关键字</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DATA_SCOPE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dataScope&quot;</span>;<br><br>    <span class="hljs-meta">@Before(&quot;@annotation(controllerDataScope)&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doBefore</span><span class="hljs-params">(JoinPoint point, DataScope controllerDataScope)</span> <span class="hljs-keyword">throws</span> Throwable<br>    &#123;<br>        clearDataScope(point);<br>        handleDataScope(point, controllerDataScope);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDataScope</span><span class="hljs-params">(<span class="hljs-keyword">final</span> JoinPoint joinPoint, DataScope controllerDataScope)</span><br>    &#123;<br>        <span class="hljs-comment">// 获取当前的用户</span><br>        <span class="hljs-type">LoginUser</span> <span class="hljs-variable">loginUser</span> <span class="hljs-operator">=</span> SecurityUtils.getLoginUser();<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotNull(loginUser))<br>        &#123;<br>            <span class="hljs-type">SysUser</span> <span class="hljs-variable">currentUser</span> <span class="hljs-operator">=</span> loginUser.getUser();<br>            <span class="hljs-comment">// 如果是超级管理员，则不过滤数据</span><br>            <span class="hljs-keyword">if</span> (StringUtils.isNotNull(currentUser) &amp;&amp; !currentUser.isAdmin())<br>            &#123;<br>                dataScopeFilter(joinPoint, currentUser, controllerDataScope.deptAlias(),<br>                        controllerDataScope.userAlias());<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 数据范围过滤</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> joinPoint 切点</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> user 用户</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userAlias 别名</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dataScopeFilter</span><span class="hljs-params">(JoinPoint joinPoint, SysUser user, String deptAlias, String userAlias)</span><br>    &#123;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sqlString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><br>        <span class="hljs-keyword">for</span> (SysRole role : user.getRoles())<br>        &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">dataScope</span> <span class="hljs-operator">=</span> role.getDataScope();<br>            <span class="hljs-keyword">if</span> (DATA_SCOPE_ALL.equals(dataScope))<br>            &#123;<br>                sqlString = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (DATA_SCOPE_CUSTOM.equals(dataScope))<br>            &#123;<br>                sqlString.append(StringUtils.format(<br>                        <span class="hljs-string">&quot; OR &#123;&#125;.dept_id IN ( SELECT dept_id FROM sys_role_dept WHERE role_id = &#123;&#125; ) &quot;</span>, deptAlias,<br>                        role.getRoleId()));<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (DATA_SCOPE_DEPT.equals(dataScope))<br>            &#123;<br>                sqlString.append(StringUtils.format(<span class="hljs-string">&quot; OR &#123;&#125;.dept_id = &#123;&#125; &quot;</span>, deptAlias, user.getDeptId()));<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (DATA_SCOPE_DEPT_AND_CHILD.equals(dataScope))<br>            &#123;<br>                sqlString.append(StringUtils.format(<br>                        <span class="hljs-string">&quot; OR &#123;&#125;.dept_id IN ( SELECT dept_id FROM sys_dept WHERE dept_id = &#123;&#125; or find_in_set( &#123;&#125; , ancestors ) )&quot;</span>,<br>                        deptAlias, user.getDeptId(), user.getDeptId()));<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (DATA_SCOPE_SELF.equals(dataScope))<br>            &#123;<br>                <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(userAlias))<br>                &#123;<br>                    sqlString.append(StringUtils.format(<span class="hljs-string">&quot; OR &#123;&#125;.user_id = &#123;&#125; &quot;</span>, userAlias, user.getUserId()));<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    <span class="hljs-comment">// 数据权限为仅本人且没有userAlias别名不查询任何数据</span><br>                    sqlString.append(<span class="hljs-string">&quot; OR 1=0 &quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(sqlString.toString()))<br>        &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> joinPoint.getArgs()[<span class="hljs-number">0</span>];<br>            <span class="hljs-keyword">if</span> (StringUtils.isNotNull(params) &amp;&amp; params <span class="hljs-keyword">instanceof</span> BaseEntity)<br>            &#123;<br>                <span class="hljs-type">BaseEntity</span> <span class="hljs-variable">baseEntity</span> <span class="hljs-operator">=</span> (BaseEntity) params;<br>                baseEntity.getParams().put(DATA_SCOPE, <span class="hljs-string">&quot; AND (&quot;</span> + sqlString.substring(<span class="hljs-number">4</span>) + <span class="hljs-string">&quot;)&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 拼接权限sql前先清空params.dataScope参数防止注入</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearDataScope</span><span class="hljs-params">(<span class="hljs-keyword">final</span> JoinPoint joinPoint)</span><br>    &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> joinPoint.getArgs()[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotNull(params) &amp;&amp; params <span class="hljs-keyword">instanceof</span> BaseEntity)<br>        &#123;<br>            <span class="hljs-type">BaseEntity</span> <span class="hljs-variable">baseEntity</span> <span class="hljs-operator">=</span> (BaseEntity) params;<br>            baseEntity.getParams().put(DATA_SCOPE, <span class="hljs-string">&quot;&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>步骤四：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DataScope(deptAlias = &quot;d&quot;)</span><br><span class="hljs-keyword">public</span> List&lt;SysDept&gt; <span class="hljs-title function_">selectDeptList</span><span class="hljs-params">(SysDept dept)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> deptMapper.selectDeptList(dept);<br>&#125;<br></code></pre></td></tr></table></figure><p>步骤五：</p><p>mybatis的xml文件中使用</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml">select d.dept_id, d.parent_id, d.ancestors, d.dept_name, d.order_num, d.leader, d.phone, d.email, d.status, d.del_flag, d.create_by, d.create_time <br>from sys_dept d<br>$&#123;params.dataScope&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>系统设计</category>
      
    </categories>
    
    
    <tags>
      
      <tag>系统设计</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>String与StringBuffer与StringBuilder的区别</title>
    <link href="/2019/07/18/java/String%E4%B8%8EStringBuffer%E4%B8%8EStringBuilder%E7%9A%84%E5%8C%BA%E5%88%AB/"/>
    <url>/2019/07/18/java/String%E4%B8%8EStringBuffer%E4%B8%8EStringBuilder%E7%9A%84%E5%8C%BA%E5%88%AB/</url>
    
    <content type="html"><![CDATA[<h1 id="String与StringBuffer与StringBuilder的区别"><a href="#String与StringBuffer与StringBuilder的区别" class="headerlink" title="String与StringBuffer与StringBuilder的区别"></a>String与StringBuffer与StringBuilder的区别</h1><p>1.可变性</p><p>String内部的value值是final修饰的，所以它是一个不可变的类，每一次修改String的值的时候，都会产生一个新的对象。</p><p>StringBuffer和StringBuilder是一个可变类，字符串的变更不会产生新的对象。</p><p>2.线程安全性</p><p>String是一个不可变的类，是线程安全的。</p><p>StringBuffer也是线程安全的，因为它的每个操作方法里面都用了Synchronized同步关键字。</p><p>StringBuilder它不是线程安全的。</p><p>所以在多线程环境下，对字符串进行操作，我应该使用StringBuffer。</p><p>3.性能方面</p><p>String是性能最低的，因为不可变，意味着做字符串拼接或者修改的时候，我们需要重新去创建新的对象以及分配内存。</p><p>StringBuffer要比String的性能更高一点，因为它的可变性，意味关字符串可以直接被修改。</p><p>StringBuilder性能最高，因为无锁。</p><p>4.存储方面</p><p>String存储在字符串常量池中。StringBuilder和StringBuffer存储在堆内存空间。</p><p>StringBuilder和StringBuffer都是AbstractStringBuilder抽象类的实现类。</p><h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><h2 id="String"><a href="#String" class="headerlink" title="String"></a>String</h2><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;a&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">strTmp</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str3</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;a&quot;</span> + strTmp;<br>        System.out.println(str1.equals(str2));<br>        System.out.println(str1.equals(str3));<br>        System.out.println(str1 == str2);<br>        System.out.println(str1 == str3);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">char</span> value[];<br><span class="hljs-keyword">public</span> <span class="hljs-title function_">String</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-built_in">this</span>.value = <span class="hljs-string">&quot;&quot;</span>.value;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">String</span><span class="hljs-params">(String original)</span> &#123;<br>      <span class="hljs-built_in">this</span>.value = original.value;<br>      <span class="hljs-built_in">this</span>.hash = original.hash;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">String</span><span class="hljs-params">(<span class="hljs-type">char</span> value[])</span> &#123;<br>      <span class="hljs-built_in">this</span>.value = Arrays.copyOf(value, value.length);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">String</span><span class="hljs-params">(<span class="hljs-type">char</span> value[], <span class="hljs-type">int</span> offset, <span class="hljs-type">int</span> count)</span> &#123;<br>      <span class="hljs-keyword">if</span> (offset &lt; <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringIndexOutOfBoundsException</span>(offset);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (count &lt;= <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">0</span>) &#123;<br>              <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringIndexOutOfBoundsException</span>(count);<br>          &#125;<br>          <span class="hljs-keyword">if</span> (offset &lt;= value.length) &#123;<br>              <span class="hljs-built_in">this</span>.value = <span class="hljs-string">&quot;&quot;</span>.value;<br>              <span class="hljs-keyword">return</span>;<br>          &#125;<br>      &#125;<br>      <span class="hljs-comment">// Note: offset or count might be near -1&gt;&gt;&gt;1.</span><br>      <span class="hljs-keyword">if</span> (offset &gt; value.length - count) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringIndexOutOfBoundsException</span>(offset + count);<br>      &#125;<br>      <span class="hljs-built_in">this</span>.value = Arrays.copyOfRange(value, offset, offset+count);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">String</span><span class="hljs-params">(<span class="hljs-type">int</span>[] codePoints, <span class="hljs-type">int</span> offset, <span class="hljs-type">int</span> count)</span> &#123;<br>      <span class="hljs-keyword">if</span> (offset &lt; <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringIndexOutOfBoundsException</span>(offset);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (count &lt;= <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">0</span>) &#123;<br>              <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringIndexOutOfBoundsException</span>(count);<br>          &#125;<br>          <span class="hljs-keyword">if</span> (offset &lt;= codePoints.length) &#123;<br>              <span class="hljs-built_in">this</span>.value = <span class="hljs-string">&quot;&quot;</span>.value;<br>              <span class="hljs-keyword">return</span>;<br>          &#125;<br>      &#125;<br>      <span class="hljs-comment">// Note: offset or count might be near -1&gt;&gt;&gt;1.</span><br>      <span class="hljs-keyword">if</span> (offset &gt; codePoints.length - count) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringIndexOutOfBoundsException</span>(offset + count);<br>      &#125;<br><br>      <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> offset + count;<br><br>      <span class="hljs-comment">// Pass 1: Compute precise size of char[]</span><br>      <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> count;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> offset; i &lt; end; i++) &#123;<br>          <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> codePoints[i];<br>          <span class="hljs-keyword">if</span> (Character.isBmpCodePoint(c))<br>              <span class="hljs-keyword">continue</span>;<br>          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Character.isValidCodePoint(c))<br>              n++;<br>          <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(Integer.toString(c));<br>      &#125;<br><br>      <span class="hljs-comment">// Pass 2: Allocate and fill in char[]</span><br>      <span class="hljs-keyword">final</span> <span class="hljs-type">char</span>[] v = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[n];<br><br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> offset, j = <span class="hljs-number">0</span>; i &lt; end; i++, j++) &#123;<br>          <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> codePoints[i];<br>          <span class="hljs-keyword">if</span> (Character.isBmpCodePoint(c))<br>              v[j] = (<span class="hljs-type">char</span>)c;<br>          <span class="hljs-keyword">else</span><br>              Character.toSurrogates(c, v, j++);<br>      &#125;<br><br>      <span class="hljs-built_in">this</span>.value = v;<br>  &#125;<br></code></pre></td></tr></table></figure><p>可以看到内部变量value使用的是final修饰的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-built_in">this</span>.value = Arrays.copyOf(value, value.length);<br><br><span class="hljs-built_in">this</span>.value = Arrays.copyOfRange(value, offset, offset+count);<br></code></pre></td></tr></table></figure><p>内部同样有</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">char</span>[] v = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[n];<br></code></pre></td></tr></table></figure><p>相当于新申请了一块内存空间。</p><h2 id="StringBuilder"><a href="#StringBuilder" class="headerlink" title="StringBuilder"></a>StringBuilder</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">StringBuilder</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">super</span>(<span class="hljs-number">16</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">AbstractStringBuilder(<span class="hljs-type">int</span> capacity) &#123;<br>    value = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[capacity];<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> StringBuilder <span class="hljs-title function_">append</span><span class="hljs-params">(String str)</span> &#123;<br>    <span class="hljs-built_in">super</span>.append(str);<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> AbstractStringBuilder <span class="hljs-title function_">append</span><span class="hljs-params">(String str)</span> &#123;<br>    <span class="hljs-keyword">if</span> (str == <span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">return</span> appendNull();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> str.length();<br>    ensureCapacityInternal(count + len);<br>    str.getChars(<span class="hljs-number">0</span>, len, value, count);<br>    count += len;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getChars</span><span class="hljs-params">(<span class="hljs-type">int</span> srcBegin, <span class="hljs-type">int</span> srcEnd, <span class="hljs-type">char</span> dst[], <span class="hljs-type">int</span> dstBegin)</span> &#123;<br>    <span class="hljs-keyword">if</span> (srcBegin &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringIndexOutOfBoundsException</span>(srcBegin);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (srcEnd &gt; value.length) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringIndexOutOfBoundsException</span>(srcEnd);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (srcBegin &gt; srcEnd) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringIndexOutOfBoundsException</span>(srcEnd - srcBegin);<br>    &#125;<br>    System.arraycopy(value, srcBegin, dst, dstBegin, srcEnd - srcBegin);<br>&#125;<br></code></pre></td></tr></table></figure><p>发现这里没有使用新的char数组</p><h2 id="StringBuffer"><a href="#StringBuffer" class="headerlink" title="StringBuffer"></a>StringBuffer</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> StringBuffer <span class="hljs-title function_">append</span><span class="hljs-params">(String str)</span> &#123;<br>    toStringCache = <span class="hljs-literal">null</span>;<br>    <span class="hljs-built_in">super</span>.append(str);<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>只是在方法上加了synchronized关键字。</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>接口幂等性设计</title>
    <link href="/2019/07/18/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E6%8E%A5%E5%8F%A3%E5%B9%82%E7%AD%89%E6%80%A7%E8%AE%BE%E8%AE%A1/"/>
    <url>/2019/07/18/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E6%8E%A5%E5%8F%A3%E5%B9%82%E7%AD%89%E6%80%A7%E8%AE%BE%E8%AE%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="什么是接口幂等性"><a href="#什么是接口幂等性" class="headerlink" title="什么是接口幂等性"></a>什么是接口幂等性</h1><p>幂等是一个数学概念。在接口中表示一个接口多次调用没有副作用。</p><h1 id="什么情况会出现接口幂等性问题"><a href="#什么情况会出现接口幂等性问题" class="headerlink" title="什么情况会出现接口幂等性问题"></a>什么情况会出现接口幂等性问题</h1><p>查询请求不会修改数据，所以不会出现幂等性问题。</p><p>添加、修改、删除会出现幂等性问题。</p><h2 id="什么场景会出现"><a href="#什么场景会出现" class="headerlink" title="什么场景会出现"></a>什么场景会出现</h2><p>用户重复操作</p><p>代码重试</p><p>消息重复消费</p><h1 id="如何实现接口幂等性"><a href="#如何实现接口幂等性" class="headerlink" title="如何实现接口幂等性"></a>如何实现接口幂等性</h1><p>1.唯一索引去重</p><p>2.token + redis</p><p>3.状态机</p><p>4.乐观锁</p><p>5.悲观锁（分布式锁）</p><h1 id="rouyi实现"><a href="#rouyi实现" class="headerlink" title="rouyi实现"></a>rouyi实现</h1><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义注解防止表单重复提交</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> ruoyi</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Inherited</span><br><span class="hljs-meta">@Target(ElementType.METHOD)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> RepeatSubmit<br>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 间隔时间(ms)，小于此时间视为重复提交</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">interval</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">5000</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 提示消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">message</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;不允许重复提交，请稍后再试&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 防止重复提交拦截器</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> ruoyi</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RepeatSubmitInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HandlerInterceptorAdapter</span><br>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> HandlerMethod)<br>        &#123;<br>            <span class="hljs-type">HandlerMethod</span> <span class="hljs-variable">handlerMethod</span> <span class="hljs-operator">=</span> (HandlerMethod) handler;<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> handlerMethod.getMethod();<br>            <span class="hljs-type">RepeatSubmit</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> method.getAnnotation(RepeatSubmit.class);<br>            <span class="hljs-keyword">if</span> (annotation != <span class="hljs-literal">null</span>)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isRepeatSubmit(request, annotation))<br>                &#123;<br>                    <span class="hljs-type">AjaxResult</span> <span class="hljs-variable">ajaxResult</span> <span class="hljs-operator">=</span> AjaxResult.error(annotation.message());<br>                    ServletUtils.renderString(response, JSONObject.toJSONString(ajaxResult));<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.preHandle(request, response, handler);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 验证是否重复提交由子类实现具体的防重复提交的规则</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isRepeatSubmit</span><span class="hljs-params">(HttpServletRequest request, RepeatSubmit annotation)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 判断请求url和数据是否和上一次相同，</span><br><span class="hljs-comment"> * 如果和上次相同，则是重复提交表单。 有效时间为10秒内。</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> ruoyi</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SameUrlDataInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RepeatSubmitInterceptor</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">REPEAT_PARAMS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;repeatParams&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">REPEAT_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;repeatTime&quot;</span>;<br><br>    <span class="hljs-comment">// 令牌自定义标识</span><br>    <span class="hljs-meta">@Value(&quot;$&#123;token.header&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String header;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisCache redisCache;<br><br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isRepeatSubmit</span><span class="hljs-params">(HttpServletRequest request, RepeatSubmit annotation)</span><br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">nowParams</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">if</span> (request <span class="hljs-keyword">instanceof</span> RepeatedlyRequestWrapper)<br>        &#123;<br>            <span class="hljs-type">RepeatedlyRequestWrapper</span> <span class="hljs-variable">repeatedlyRequest</span> <span class="hljs-operator">=</span> (RepeatedlyRequestWrapper) request;<br>            nowParams = HttpHelper.getBodyString(repeatedlyRequest);<br>        &#125;<br><br>        <span class="hljs-comment">// body参数为空，获取Parameter的数据</span><br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(nowParams))<br>        &#123;<br>            nowParams = JSONObject.toJSONString(request.getParameterMap());<br>        &#125;<br>        Map&lt;String, Object&gt; nowDataMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>        nowDataMap.put(REPEAT_PARAMS, nowParams);<br>        nowDataMap.put(REPEAT_TIME, System.currentTimeMillis());<br><br>        <span class="hljs-comment">// 请求地址（作为存放cache的key值）</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> request.getRequestURI();<br><br>        <span class="hljs-comment">// 唯一值（没有消息头则使用请求地址）</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">submitKey</span> <span class="hljs-operator">=</span> request.getHeader(header);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(submitKey))<br>        &#123;<br>            submitKey = url;<br>        &#125;<br><br>        <span class="hljs-comment">// 唯一标识（指定key + 消息头）</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">cacheRepeatKey</span> <span class="hljs-operator">=</span> Constants.REPEAT_SUBMIT_KEY + submitKey;<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">sessionObj</span> <span class="hljs-operator">=</span> redisCache.getCacheObject(cacheRepeatKey);<br>        <span class="hljs-keyword">if</span> (sessionObj != <span class="hljs-literal">null</span>)<br>        &#123;<br>            Map&lt;String, Object&gt; sessionMap = (Map&lt;String, Object&gt;) sessionObj;<br>            <span class="hljs-keyword">if</span> (sessionMap.containsKey(url))<br>            &#123;<br>                Map&lt;String, Object&gt; preDataMap = (Map&lt;String, Object&gt;) sessionMap.get(url);<br>                <span class="hljs-keyword">if</span> (compareParams(nowDataMap, preDataMap) &amp;&amp; compareTime(nowDataMap, preDataMap, annotation.interval()))<br>                &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        Map&lt;String, Object&gt; cacheMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>        cacheMap.put(url, nowDataMap);<br>        redisCache.setCacheObject(cacheRepeatKey, cacheMap, annotation.interval(), TimeUnit.MILLISECONDS);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 判断参数是否相同</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">compareParams</span><span class="hljs-params">(Map&lt;String, Object&gt; nowMap, Map&lt;String, Object&gt; preMap)</span><br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">nowParams</span> <span class="hljs-operator">=</span> (String) nowMap.get(REPEAT_PARAMS);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">preParams</span> <span class="hljs-operator">=</span> (String) preMap.get(REPEAT_PARAMS);<br>        <span class="hljs-keyword">return</span> nowParams.equals(preParams);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 判断两次间隔时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">compareTime</span><span class="hljs-params">(Map&lt;String, Object&gt; nowMap, Map&lt;String, Object&gt; preMap, <span class="hljs-type">int</span> interval)</span><br>    &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">time1</span> <span class="hljs-operator">=</span> (Long) nowMap.get(REPEAT_TIME);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">time2</span> <span class="hljs-operator">=</span> (Long) preMap.get(REPEAT_TIME);<br>        <span class="hljs-keyword">if</span> ((time1 - time2) &lt; interval)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="网关实现"><a href="#网关实现" class="headerlink" title="网关实现"></a>网关实现</h1><p>要求客户端 请求时生成 requestId（每天不重或一小时不重）</p><p>在网关层验证是否请求是否有requestId，如果没有返回错误，如果有，使用setNx放入 redis中，以固定的格式  xxx + requestId, 设置过期时间。如果设置成功，可以请求后端服务器，如果设置不成功，说明重复请求。</p><p>可以在网关层判断：get请求不验证，put post delete验证</p>]]></content>
    
    
    <categories>
      
      <category>系统设计</category>
      
    </categories>
    
    
    <tags>
      
      <tag>系统设计</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>String创建了几个对象</title>
    <link href="/2019/07/18/java/String%E5%88%9B%E5%BB%BA%E4%BA%86%E5%87%A0%E4%B8%AA%E5%AF%B9%E8%B1%A1/"/>
    <url>/2019/07/18/java/String%E5%88%9B%E5%BB%BA%E4%BA%86%E5%87%A0%E4%B8%AA%E5%AF%B9%E8%B1%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>1、String str &#x3D; “hello”;<br>创建了一个对象<br>jvm在编译阶段会判断常量池中是否有“hello”这个常量对象，如果有，str就直接指向这个常量的引用，如果没有就会在常量池中创建这个对象。<br>2、String str &#x3D; new String（“hello”）；<br>创建了两个对象<br>jvm编译阶段会判断常量池中是否有“hello”这个常量对象，进而判断是否创建常量对象，然后运行阶段通过new关键字在java 堆上开辟一块儿空间来创建String 对象。<br>3、String str &#x3D; “hello” + “world”；<br>创建了一个对象<br>jvm编译阶段通过编译器优化后，会把字符串常量直接合并成“helloworld”，所以在常量池中只创建了一个对象。<br>4、String str &#x3D; new String(“he”) + new String（“llo”）；<br>创建了六个对象<br>在字符串常量池通过字面量创建”he” 和 “llo”字符串对象，并保存其对象引用，以及在堆中创建”he” 和 “llo”字符串对象，另外底层是通过new StringBuilder().append(“he”).append(“llo”).toString()进行拼接。其中StringBuilder的toString()会生成一个新的字符串对象new String(“hello”)，但由于这个代码是运行期动态生成的，所以不会在字符串常量池中创建字符串对象”hello”，但会在堆中创建字符串对象”hello”。</p><h1 id="为什么要先在字符串常量池中创建对象"><a href="#为什么要先在字符串常量池中创建对象" class="headerlink" title="为什么要先在字符串常量池中创建对象"></a>为什么要先在字符串常量池中创建对象</h1><p>由于字符串的使用频率实在是太高了，所以 Java 虚拟机为了提高性能和减少内存开销，在创建字符串对象的时候进行了一些优化，特意为字符串开辟了一个字符串常量池。</p><h1 id="intern方法"><a href="#intern方法" class="headerlink" title="intern方法"></a>intern方法</h1><p>这个方法会随着JVM源码的变化而变化。还是要看源码的注释。</p><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Returns a canonical representation for the string object.</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * A pool of strings, initially empty, is maintained privately by the</span><br><span class="hljs-comment"> * class &#123;<span class="hljs-doctag">@code</span> String&#125;.</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * When the intern method is invoked, if the pool already contains a</span><br><span class="hljs-comment"> * string equal to this &#123;<span class="hljs-doctag">@code</span> String&#125; object as determined by</span><br><span class="hljs-comment"> * the &#123;<span class="hljs-doctag">@link</span> #equals(Object)&#125; method, then the string from the pool is</span><br><span class="hljs-comment"> * returned. Otherwise, this &#123;<span class="hljs-doctag">@code</span> String&#125; object is added to the</span><br><span class="hljs-comment"> * pool and a reference to this &#123;<span class="hljs-doctag">@code</span> String&#125; object is returned.</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * It follows that for any two strings &#123;<span class="hljs-doctag">@code</span> s&#125; and &#123;<span class="hljs-doctag">@code</span> t&#125;,</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> s.intern() == t.intern()&#125; is &#123;<span class="hljs-doctag">@code</span> true&#125;</span><br><span class="hljs-comment"> * if and only if &#123;<span class="hljs-doctag">@code</span> s.equals(t)&#125; is &#123;<span class="hljs-doctag">@code</span> true&#125;.</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * All literal strings and string-valued constant expressions are</span><br><span class="hljs-comment"> * interned. String literals are defined in section 3.10.5 of the</span><br><span class="hljs-comment"> * &lt;cite&gt;The Java&amp;trade; Language Specification&lt;/cite&gt;.</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> 返回字符串对象的规范表示。一个字符串池，最初是空的，由 String 类私下维护。当调用 intern 方法时，如果池中已经包含一个等于该 String 对象的字符串，由 equals(Object) 方法确定，则返回池中的字符串。否则，将此 String 对象添加到池中并返回对该 String 对象的引用。由此可见，对于任何两个字符串 s 和 t，当且仅当 s.equals(t) 为真时，s.intern() == t.intern() 才为真。所有文字字符串和字符串值的常量表达式都是实习的。字符串文字在 Java™ 语言规范的第 3.10.5 节中定义。</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span>  a string that has the same contents as this string, but is</span><br><span class="hljs-comment"> *          guaranteed to be from a pool of unique strings.</span><br><span class="hljs-comment"> 与此字符串具有相同内容的字符串，但保证来自唯一字符串池。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">intern</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure><p>根据注释，发现如果常量池中没有对象时，会创建一个常量池对象。</p><p>注释上同时说明对于任何两个字符串 s 和 t，当且仅当 s.equals(t) 为真时，s.intern() &#x3D;&#x3D; t.intern() 才为真。</p><p>如果直接判断  s   &#x3D;&#x3D;  t.intern()   这时不一定为真。如果使用intern方法尽量两边都使用。</p><p>Intern()方法一直返回的是字符串常量池中的对象，所以&#x3D;&#x3D;判断时要先区分字符串不是来自常量池。</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>什么是受检异常和非受检异常</title>
    <link href="/2019/07/18/java/%E4%BB%80%E4%B9%88%E6%98%AF%E5%8F%97%E6%A3%80%E5%BC%82%E5%B8%B8%E5%92%8C%E9%9D%9E%E5%8F%97%E6%A3%80%E5%BC%82%E5%B8%B8/"/>
    <url>/2019/07/18/java/%E4%BB%80%E4%B9%88%E6%98%AF%E5%8F%97%E6%A3%80%E5%BC%82%E5%B8%B8%E5%92%8C%E9%9D%9E%E5%8F%97%E6%A3%80%E5%BC%82%E5%B8%B8/</url>
    
    <content type="html"><![CDATA[<h1 id="异常的关系"><a href="#异常的关系" class="headerlink" title="异常的关系"></a>异常的关系</h1><p>java中的异常都是继承自Throwable这个类中，分别Error和Exception。</p><p>Error系统收到无法处理的错误信息，它和程序本身无关。</p><p>Exception是指程序运行时抛出需要处理的异常信息如果不主动捕获，则会被JVM处理。</p><p>受检异常和非受检异常来自Exception。</p><h1 id="受检异常和非受检异常的定义"><a href="#受检异常和非受检异常的定义" class="headerlink" title="受检异常和非受检异常的定义"></a>受检异常和非受检异常的定义</h1><p>受检异常的定义是程序在编译阶段必须要主动捕获的异常，遇到该异常有两个处理方法</p><p>1.通过try&#x2F;catch捕获该异常</p><p>2.通过throw把异常抛出去</p><p>非受检异常的定义是程序不需要主动捕获该异常，一般发生在程序运行期间，比如NullPointException</p><h1 id="受检异常和非受检异常的优缺点"><a href="#受检异常和非受检异常的优缺点" class="headerlink" title="受检异常和非受检异常的优缺点"></a>受检异常和非受检异常的优缺点</h1><h2 id="受检异常"><a href="#受检异常" class="headerlink" title="受检异常"></a>受检异常</h2><p>优点：</p><p>1.它可以响应一个明确的错误机制，这些错误在写代码的时候可以随时捕获并且能很好的提高代码的健壮性。</p><p>2.在一些连接操作中，它能很好的提醒我们关注异常信息，并做好预防工作。</p><p>缺点：</p><p>抛出受检异常的时候需要加上声明，而这个做法会直接破坏方法签名导致版本不兼容。这个缺点会导致我们会经常使用RuntimeException包装。</p><h2 id="非受检异常"><a href="#非受检异常" class="headerlink" title="非受检异常"></a>非受检异常</h2><p>优点：</p><p>不需要加额外的异常处理代码。</p><p>缺点：</p><p>开发人员可能忽略某些应该处理的异常，导致带来一些隐藏很深的Bug。比如流忘记关闭？连接忘记释放等。</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>死锁</title>
    <link href="/2019/07/18/java/%E6%AD%BB%E9%94%81/"/>
    <url>/2019/07/18/java/%E6%AD%BB%E9%94%81/</url>
    
    <content type="html"><![CDATA[<h1 id="什么是死锁"><a href="#什么是死锁" class="headerlink" title="什么是死锁"></a>什么是死锁</h1><p>是一组互相竞争资源的线程，因互相等待，导致“永久”阻塞的现象。</p><h1 id="发生死锁的原因"><a href="#发生死锁的原因" class="headerlink" title="发生死锁的原因"></a>发生死锁的原因</h1><p>1.互斥条件，共享资源X和Y只能被一个线程占用</p><p>2.占有且等待，线程T1已经获取得共享资源X在等待共享资源Y的时候，不释放共享资源X</p><p>3.不可抢占，其他线程不能强行抢占线程T1占有的资源</p><p>4.循环等待，线程T1等待线程T2占有的资源，线程T2等待线程T1占有的资源</p><h1 id="如何避免死锁"><a href="#如何避免死锁" class="headerlink" title="如何避免死锁"></a>如何避免死锁</h1><p>打破死锁的四个原因。</p><p>第一个互斥条件是无法被破环的，因为锁本身就是通过互斥来解决线程安全问题的。</p><p>第二个占有且等待，打破方式是，一次性申请所有的资源，这样就不用等待了。</p><p>第三个不可抢占，占用资源的线程，进一步申请其他资源时，如果申请不到，可以主动释放它占有的资源，这样打破了。</p><p>第四个循环等待，可以靠按序申请资源来进行预防，所以按序申请是指资源是有线性顺序的，申请的时候可以先申请资源序号小的，再申请资源序号大的，这样线性化后自然就不存在循环等待了。</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux设置nginx开机自启动</title>
    <link href="/2019/07/16/linux/linux%E8%AE%BE%E7%BD%AEnginx%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E5%8A%A8/"/>
    <url>/2019/07/16/linux/linux%E8%AE%BE%E7%BD%AEnginx%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E5%8A%A8/</url>
    
    <content type="html"><![CDATA[<p>1.进入&#x2F;etc&#x2F;rc.d&#x2F;init.d目录</p><p>2.修改rc.local权限</p><p>chmod 755 rc.local</p><p>3.添加启动sh脚本</p><p>增加一行 <code>/usr/local/nginx/sbin/nginx</code></p><p>4.重启测试一下</p>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux安装与卸载jdk</title>
    <link href="/2018/12/21/linux/linux%E5%AE%89%E8%A3%85%E4%B8%8E%E5%8D%B8%E8%BD%BDjdk/"/>
    <url>/2018/12/21/linux/linux%E5%AE%89%E8%A3%85%E4%B8%8E%E5%8D%B8%E8%BD%BDjdk/</url>
    
    <content type="html"><![CDATA[<h1 id="1、卸载JDK"><a href="#1、卸载JDK" class="headerlink" title="1、卸载JDK"></a>1、卸载JDK</h1><h2 id="1-1、查看已安装的JDK"><a href="#1-1、查看已安装的JDK" class="headerlink" title="1.1、查看已安装的JDK"></a>1.1、查看已安装的JDK</h2><p>rpm -qa|grep jdk<br>返回值：</p><figure class="highlight autoit"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@izbp17drmb0m8oy3dd1zx7z</span> ~]<span class="hljs-meta"># rpm -qa | grep jdk</span><br>jdk1<span class="hljs-number">.8</span><span class="hljs-number">-1.8</span><span class="hljs-number">.0</span>_191-fcs.x86_64<br></code></pre></td></tr></table></figure><h2 id="1-2、删除环境变量"><a href="#1-2、删除环境变量" class="headerlink" title="1.2、删除环境变量"></a>1.2、删除环境变量</h2><p>vim &#x2F;etc&#x2F;profile<br>删除JAVA_HOME环境变量</p><h2 id="1-3、卸载JDK"><a href="#1-3、卸载JDK" class="headerlink" title="1.3、卸载JDK"></a>1.3、卸载JDK</h2><p>rpm -e –nodeps jdk1.8-1.8.0_191-fcs.x86_64</p><h1 id="2、安装JDK"><a href="#2、安装JDK" class="headerlink" title="2、安装JDK"></a>2、安装JDK</h1><h2 id="2-1、下载jdk安装包rpm类型"><a href="#2-1、下载jdk安装包rpm类型" class="headerlink" title="2.1、下载jdk安装包rpm类型"></a>2.1、下载jdk安装包rpm类型</h2><p><a href="https://www.oracle.com/technetwork/java/javase/downloads/index.html">https://www.oracle.com/technetwork/java/javase/downloads/index.html</a></p><h2 id="2-2、安装rpm包"><a href="#2-2、安装rpm包" class="headerlink" title="2.2、安装rpm包"></a>2.2、安装rpm包</h2><p>rpm -ivh jdk-8u191-linux-x64.rpm<br>使用1.1查看是否已经安装成功</p><h2 id="2-3、配置环境变量"><a href="#2-3、配置环境变量" class="headerlink" title="2.3、配置环境变量"></a>2.3、配置环境变量</h2><h3 id="2-3-1、打开配置文件"><a href="#2-3-1、打开配置文件" class="headerlink" title="2.3.1、打开配置文件"></a>2.3.1、打开配置文件</h3><p>vim &#x2F;etc&#x2F;profile</p><h3 id="2-3-2、添加配置信息"><a href="#2-3-2、添加配置信息" class="headerlink" title="2.3.2、添加配置信息"></a>2.3.2、添加配置信息</h3><p>export JAVA_HOME&#x3D;&#x2F;usr&#x2F;java&#x2F;jdk1.8.0_191-amd64<br>export JRE_HOME&#x3D;${JAVA_HOME}&#x2F;jre<br>export CLASSPATH&#x3D;.:${JAVA_HOME}&#x2F;lib:${JRE_HOME}&#x2F;lib<br>export PATH&#x3D;${JAVA_HOME}&#x2F;bin:$PATH</p><h3 id="2-3-3、立即生效配置文件"><a href="#2-3-3、立即生效配置文件" class="headerlink" title="2.3.3、立即生效配置文件"></a>2.3.3、立即生效配置文件</h3><p>source &#x2F;etc&#x2F;profile</p><h3 id="2-3-4、验证配置信息"><a href="#2-3-4、验证配置信息" class="headerlink" title="2.3.4、验证配置信息"></a>2.3.4、验证配置信息</h3><p>echo $JAVA_HOME<br>echo $PATH<br>echo $CLASSPATH</p><h1 id="3、查看JDK安装路径"><a href="#3、查看JDK安装路径" class="headerlink" title="3、查看JDK安装路径"></a>3、查看JDK安装路径</h1><h2 id="3-1、echo-JAVA-HOME"><a href="#3-1、echo-JAVA-HOME" class="headerlink" title="3.1、echo $JAVA_HOME"></a>3.1、echo $JAVA_HOME</h2><p>直接命令行输入echo $JAVA_HOME<br>如果是按照上一步配置了环境变量</p><h2 id="3-2、上一步未找到安装路径"><a href="#3-2、上一步未找到安装路径" class="headerlink" title="3.2、上一步未找到安装路径"></a>3.2、上一步未找到安装路径</h2><h3 id="3-2-1、which-java"><a href="#3-2-1、which-java" class="headerlink" title="3.2.1、which java"></a>3.2.1、which java</h3><p>定位到执行路径</p><h3 id="3-2-2、whereis-java"><a href="#3-2-2、whereis-java" class="headerlink" title="3.2.2、whereis java"></a>3.2.2、whereis java</h3><p>定位文件</p><h3 id="3-2-3、直接硬猜"><a href="#3-2-3、直接硬猜" class="headerlink" title="3.2.3、直接硬猜"></a>3.2.3、直接硬猜</h3><p>默认安装路径在&#x2F;usr&#x2F;java</p>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>jdk</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hexo生成静态博客</title>
    <link href="/2018/05/07/hexo/hexo%E7%94%9F%E6%88%90%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2/"/>
    <url>/2018/05/07/hexo/hexo%E7%94%9F%E6%88%90%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2/</url>
    
    <content type="html"><![CDATA[<p><a href="https://hexo.io/zh-cn/">https://hexo.io/zh-cn/</a>  hexo官网</p><p><a href="https://github.com/A-limon/pacman">https://github.com/A-limon/pacman</a> hexo主题<br><a href="https://www.haomwei.com/technology/maupassant-hexo.html">https://www.haomwei.com/technology/maupassant-hexo.html</a></p><p><a href="https://github.com/bubkoo/hexo-filter-flowchart">https://github.com/bubkoo/hexo-filter-flowchart</a> hexo支持流程图</p><p><a href="https://github.com/bubkoo/hexo-filter-sequence">https://github.com/bubkoo/hexo-filter-sequence</a> hexo支持时序图</p><p>不能直接显示流程图bug解决：</p><p><a href="https://github.com/bubkoo/hexo-filter-sequence/issues/5">https://github.com/bubkoo/hexo-filter-sequence/issues/5</a> </p><ul><li>在<code>renderer.js</code>文件里字符串拼接第一行加上<br><code>data.content += &#39;&lt;script src=&quot;&#39; + config.raphael + &#39;&quot;&gt;&lt;/script&gt;&#39;;</code></li><li>在<code>index.js</code>文件里加上<br><code>raphael: &#39;https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js&#39;,</code></li></ul><p>centos系统显示乱码：</p><p>1.检查系统是否已经设置为中文(zh_CN.UTF-8);</p><p>2.检查连接工具是否已经为相同编码（utf-8),ssh sftp;</p><p>在网站增加备案号：</p><p><a href="https://www.cnblogs.com/liuxianan/p/beian.html">https://www.cnblogs.com/liuxianan/p/beian.html</a></p><p>在&#x2F;themes&#x2F;xxx主题&#x2F;layout&#x2F;_partial footer.ejs中加入<a href="http://www.miitbeian.gov.cn/">粤ICP备xxxx号</a>  </p>]]></content>
    
    
    <categories>
      
      <category>hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>maven</title>
    <link href="/2018/03/23/maven/Maven%20%E7%B4%A2%E5%BC%95/"/>
    <url>/2018/03/23/maven/Maven%20%E7%B4%A2%E5%BC%95/</url>
    
    <content type="html"><![CDATA[<h1 id="Maven-索引"><a href="#Maven-索引" class="headerlink" title="Maven 索引"></a>Maven 索引</h1><p>maven是apache公司开源项目，是项目构建的工具。用来依赖管理</p><h2 id="maven的好处"><a href="#maven的好处" class="headerlink" title="maven的好处"></a>maven的好处</h2><p>jar包的管理，用户只关心自己的代码，不用再去提交第三方的jar包到自已的版本控制器。</p><p><strong>项目构建；项目依赖管理；软件项目持续集成；版本管理；项目的站点描述信息管理；</strong></p><h2 id="maven的好处如何实现"><a href="#maven的好处如何实现" class="headerlink" title="maven的好处如何实现"></a>maven的好处如何实现</h2><p>maven的两大核心：</p><p>依赖管理：对jar包管理过程</p><p>项目构建：项目在编码完成后，对项目进行编译、测试、打包、部署一系列的操作都通过命令来实现</p><p>通过maven命令将web项目发布到tomcat:</p><span id="more"></span><h2 id="maven的重点"><a href="#maven的重点" class="headerlink" title="maven的重点"></a>maven的重点</h2><p>生命周期是重点</p><p>依赖范围与依赖传递是重点</p><p>依赖冲突解决是重点</p><p>排除依赖是重点</p><p>maven的概念模型是重点</p><table><thead><tr><th>依赖范围</th><th>对于编译classpath有效</th><th>对于测试classpath有效</th><th>对于运行时classpath有效</th><th>例子</th></tr></thead><tbody><tr><td>compile</td><td>Y</td><td>Y</td><td>Y</td><td>spring-core</td></tr><tr><td>test</td><td>-</td><td>Y</td><td>-</td><td>junit</td></tr><tr><td>provided</td><td>Y</td><td>Y</td><td>-</td><td>servlet-api</td></tr><tr><td>runtime</td><td>-</td><td>Y</td><td>Y</td><td>jdbc驱动</td></tr><tr><td>system</td><td>Y</td><td>Y</td><td>-</td><td>本地的，maven仓库之外的类库</td></tr></tbody></table><p>##maven传递依赖冲突解决<br>传递依赖：A(项目)依赖B,B依赖C(1.1版本)，B是A的直接依赖，C就是A的传递依赖，导入依赖D,D依赖C(1.2版本)</p><p>###1.1 maven自己调解原则</p><p>####1.1.1 第一声明者优先原则</p><p>谁先定义的就用谁的传递依赖。</p><h4 id="1-1-2路径近者优先原则"><a href="#1-1-2路径近者优先原则" class="headerlink" title="1.1.2路径近者优先原则"></a>1.1.2路径近者优先原则</h4><p>直接依赖级别高于传递依赖。</p><h3 id="1-2排除依赖"><a href="#1-2排除依赖" class="headerlink" title="1.2排除依赖"></a>1.2排除依赖</h3><p>###1.3版本锁定(推荐使用)</p><p>##maven对项目进行拆分、聚合(重点)</p><p>对现在已有maven ssh项目进行拆分，拆分思路：将dao层的代码已经配置文件全体提取出来到一个表现上独立的工程中。同样service、action拆分。</p><p>ssh-parent：父工程</p><p>ssh-dao（子模块）、ssh-service、ssh-web</p><p>拆分完成对拆分后的项目进行聚合，提出概念父工程</p><h3 id="1-1创建父工程"><a href="#1-1创建父工程" class="headerlink" title="1.1创建父工程"></a>1.1创建父工程</h3><h3 id="1-2将创建父工程发布到本地仓库"><a href="#1-2将创建父工程发布到本地仓库" class="headerlink" title="1.2将创建父工程发布到本地仓库"></a>1.2将创建父工程发布到本地仓库</h3><h3 id="1-3创建子模块ssh-dao"><a href="#1-3创建子模块ssh-dao" class="headerlink" title="1.3创建子模块ssh-dao"></a>1.3创建子模块ssh-dao</h3><p>ssh-dao负责数据访问层：包含dao相关代码&amp;配置文件</p><h3 id="1-4创建子模块ssh-service"><a href="#1-4创建子模块ssh-service" class="headerlink" title="1.4创建子模块ssh-service"></a>1.4创建子模块ssh-service</h3><h3 id="1-5创建子模块ssh-web"><a href="#1-5创建子模块ssh-web" class="headerlink" title="1.5创建子模块ssh-web"></a>1.5创建子模块ssh-web</h3><h3 id="1-6运行方式"><a href="#1-6运行方式" class="headerlink" title="1.6运行方式"></a>1.6运行方式</h3><h2 id="maven私服安装"><a href="#maven私服安装" class="headerlink" title="maven私服安装"></a>maven私服安装</h2><p>maven项目–》本地仓库–》私服–》中央仓库</p><h3 id="1-私服安装"><a href="#1-私服安装" class="headerlink" title="1.私服安装"></a>1.私服安装</h3><h3 id="2-私服仓库类型"><a href="#2-私服仓库类型" class="headerlink" title="2.私服仓库类型"></a>2.私服仓库类型</h3><p>hosted:宿主仓库;存放本公司开发的jar包（正式版本、测试版本、第三方：存在版本问题-oracle）</p><p>proxy:代理仓库;代理中央仓库、apache下测试版本的jar包</p><p>group:组仓库;将来连接组仓库。包含hosted、proxy</p><h3 id="3-上传jar包到私服上"><a href="#3-上传jar包到私服上" class="headerlink" title="3.上传jar包到私服上"></a>3.上传jar包到私服上</h3><h3 id="4-下载jar包到本地仓库-应用"><a href="#4-下载jar包到本地仓库-应用" class="headerlink" title="4.下载jar包到本地仓库(应用)"></a>4.下载jar包到本地仓库(应用)</h3>]]></content>
    
    
    <categories>
      
      <category>maven</category>
      
    </categories>
    
    
    <tags>
      
      <tag>maven</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
